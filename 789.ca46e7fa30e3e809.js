(self.webpackChunkfrontend=self.webpackChunkfrontend||[]).push([[789],{1247:function(Im){Im.exports=function(){"use strict";var mc,us,Cd;function vt(o,er){if(mc)if(us){var jr="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+mc+")(sharedChunk); ("+us+")(sharedChunk); self.onerror = null;",Qi={};mc(Qi),Cd=er(Qi),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(Cd.workerUrl=window.URL.createObjectURL(new Blob([jr],{type:"text/javascript"})))}else us=er;else mc=er}return vt(0,function(o){function er(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var jr,Qi={},Sr={};function Xn(){if(jr)return Sr;jr=1,Object.defineProperty(Sr,"__esModule",{value:!0}),Sr.setMatrixArrayType=function(h){Sr.ARRAY_TYPE=e=h},Sr.toRadian=function(h){return h*s},Sr.equals=function(h,a){return Math.abs(h-a)<=r*Math.max(1,Math.abs(h),Math.abs(a))},Sr.RANDOM=Sr.ARRAY_TYPE=Sr.EPSILON=void 0;var r=1e-6;Sr.EPSILON=r;var e=typeof Float32Array<"u"?Float32Array:Array;Sr.ARRAY_TYPE=e;var i=Math.random;Sr.RANDOM=i;var s=Math.PI/180;return Math.hypot||(Math.hypot=function(){for(var h=0,a=arguments.length;a--;)h+=arguments[a]*arguments[a];return Math.sqrt(h)}),Sr}var yr,Oi={};function qi(){if(yr)return Oi;function r(a){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(u){return typeof u}:function(u){return u&&"function"==typeof Symbol&&u.constructor===Symbol&&u!==Symbol.prototype?"symbol":typeof u})(a)}yr=1,Object.defineProperty(Oi,"__esModule",{value:!0}),Oi.create=function(){var a=new e.ARRAY_TYPE(4);return e.ARRAY_TYPE!=Float32Array&&(a[1]=0,a[2]=0),a[0]=1,a[3]=1,a},Oi.clone=function(a){var u=new e.ARRAY_TYPE(4);return u[0]=a[0],u[1]=a[1],u[2]=a[2],u[3]=a[3],u},Oi.copy=function(a,u){return a[0]=u[0],a[1]=u[1],a[2]=u[2],a[3]=u[3],a},Oi.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},Oi.fromValues=function(a,u,x,T){var C=new e.ARRAY_TYPE(4);return C[0]=a,C[1]=u,C[2]=x,C[3]=T,C},Oi.set=function(a,u,x,T,C){return a[0]=u,a[1]=x,a[2]=T,a[3]=C,a},Oi.transpose=function(a,u){if(a===u){var x=u[1];a[1]=u[2],a[2]=x}else a[0]=u[0],a[1]=u[2],a[2]=u[1],a[3]=u[3];return a},Oi.invert=function(a,u){var x=u[0],T=u[1],C=u[2],g=u[3],S=x*g-C*T;return S?(a[0]=g*(S=1/S),a[1]=-T*S,a[2]=-C*S,a[3]=x*S,a):null},Oi.adjoint=function(a,u){var x=u[0];return a[0]=u[3],a[1]=-u[1],a[2]=-u[2],a[3]=x,a},Oi.determinant=function(a){return a[0]*a[3]-a[2]*a[1]},Oi.multiply=s,Oi.rotate=function(a,u,x){var T=u[0],C=u[1],g=u[2],S=u[3],A=Math.sin(x),w=Math.cos(x);return a[0]=T*w+g*A,a[1]=C*w+S*A,a[2]=T*-A+g*w,a[3]=C*-A+S*w,a},Oi.scale=function(a,u,x){var T=u[1],C=u[2],g=u[3],S=x[0],A=x[1];return a[0]=u[0]*S,a[1]=T*S,a[2]=C*A,a[3]=g*A,a},Oi.fromRotation=function(a,u){var x=Math.sin(u),T=Math.cos(u);return a[0]=T,a[1]=x,a[2]=-x,a[3]=T,a},Oi.fromScaling=function(a,u){return a[0]=u[0],a[1]=0,a[2]=0,a[3]=u[1],a},Oi.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},Oi.frob=function(a){return Math.hypot(a[0],a[1],a[2],a[3])},Oi.LDU=function(a,u,x,T){return a[2]=T[2]/T[0],x[0]=T[0],x[1]=T[1],x[3]=T[3]-a[2]*x[1],[a,u,x]},Oi.add=function(a,u,x){return a[0]=u[0]+x[0],a[1]=u[1]+x[1],a[2]=u[2]+x[2],a[3]=u[3]+x[3],a},Oi.subtract=h,Oi.exactEquals=function(a,u){return a[0]===u[0]&&a[1]===u[1]&&a[2]===u[2]&&a[3]===u[3]},Oi.equals=function(a,u){var x=a[0],T=a[1],C=a[2],g=a[3],S=u[0],A=u[1],w=u[2],M=u[3];return Math.abs(x-S)<=e.EPSILON*Math.max(1,Math.abs(x),Math.abs(S))&&Math.abs(T-A)<=e.EPSILON*Math.max(1,Math.abs(T),Math.abs(A))&&Math.abs(C-w)<=e.EPSILON*Math.max(1,Math.abs(C),Math.abs(w))&&Math.abs(g-M)<=e.EPSILON*Math.max(1,Math.abs(g),Math.abs(M))},Oi.multiplyScalar=function(a,u,x){return a[0]=u[0]*x,a[1]=u[1]*x,a[2]=u[2]*x,a[3]=u[3]*x,a},Oi.multiplyScalarAndAdd=function(a,u,x,T){return a[0]=u[0]+x[0]*T,a[1]=u[1]+x[1]*T,a[2]=u[2]+x[2]*T,a[3]=u[3]+x[3]*T,a},Oi.sub=Oi.mul=void 0;var e=function(a){if(a&&a.__esModule)return a;if(null===a||"object"!==r(a)&&"function"!=typeof a)return{default:a};var x=i(void 0);if(x&&x.has(a))return x.get(a);var T={},C=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var g in a)if("default"!==g&&Object.prototype.hasOwnProperty.call(a,g)){var S=C?Object.getOwnPropertyDescriptor(a,g):null;S&&(S.get||S.set)?Object.defineProperty(T,g,S):T[g]=a[g]}return T.default=a,x&&x.set(a,T),T}(Xn());function i(a){if("function"!=typeof WeakMap)return null;var u=new WeakMap,x=new WeakMap;return(i=function(T){return T?x:u})(a)}function s(a,u,x){var T=u[0],C=u[1],g=u[2],S=u[3],A=x[0],w=x[1],M=x[2],P=x[3];return a[0]=T*A+g*w,a[1]=C*A+S*w,a[2]=T*M+g*P,a[3]=C*M+S*P,a}function h(a,u,x){return a[0]=u[0]-x[0],a[1]=u[1]-x[1],a[2]=u[2]-x[2],a[3]=u[3]-x[3],a}return Oi.mul=s,Oi.sub=h,Oi}var Yn,Si={};function uo(){if(Yn)return Si;function r(a){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(u){return typeof u}:function(u){return u&&"function"==typeof Symbol&&u.constructor===Symbol&&u!==Symbol.prototype?"symbol":typeof u})(a)}Yn=1,Object.defineProperty(Si,"__esModule",{value:!0}),Si.create=function(){var a=new e.ARRAY_TYPE(6);return e.ARRAY_TYPE!=Float32Array&&(a[1]=0,a[2]=0,a[4]=0,a[5]=0),a[0]=1,a[3]=1,a},Si.clone=function(a){var u=new e.ARRAY_TYPE(6);return u[0]=a[0],u[1]=a[1],u[2]=a[2],u[3]=a[3],u[4]=a[4],u[5]=a[5],u},Si.copy=function(a,u){return a[0]=u[0],a[1]=u[1],a[2]=u[2],a[3]=u[3],a[4]=u[4],a[5]=u[5],a},Si.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},Si.fromValues=function(a,u,x,T,C,g){var S=new e.ARRAY_TYPE(6);return S[0]=a,S[1]=u,S[2]=x,S[3]=T,S[4]=C,S[5]=g,S},Si.set=function(a,u,x,T,C,g,S){return a[0]=u,a[1]=x,a[2]=T,a[3]=C,a[4]=g,a[5]=S,a},Si.invert=function(a,u){var x=u[0],T=u[1],C=u[2],g=u[3],S=u[4],A=u[5],w=x*g-T*C;return w?(a[0]=g*(w=1/w),a[1]=-T*w,a[2]=-C*w,a[3]=x*w,a[4]=(C*A-g*S)*w,a[5]=(T*S-x*A)*w,a):null},Si.determinant=function(a){return a[0]*a[3]-a[1]*a[2]},Si.multiply=s,Si.rotate=function(a,u,x){var T=u[0],C=u[1],g=u[2],S=u[3],A=u[4],w=u[5],M=Math.sin(x),P=Math.cos(x);return a[0]=T*P+g*M,a[1]=C*P+S*M,a[2]=T*-M+g*P,a[3]=C*-M+S*P,a[4]=A,a[5]=w,a},Si.scale=function(a,u,x){var T=u[1],C=u[2],g=u[3],S=u[4],A=u[5],w=x[0],M=x[1];return a[0]=u[0]*w,a[1]=T*w,a[2]=C*M,a[3]=g*M,a[4]=S,a[5]=A,a},Si.translate=function(a,u,x){var T=u[0],C=u[1],g=u[2],S=u[3],A=u[4],w=u[5],M=x[0],P=x[1];return a[0]=T,a[1]=C,a[2]=g,a[3]=S,a[4]=T*M+g*P+A,a[5]=C*M+S*P+w,a},Si.fromRotation=function(a,u){var x=Math.sin(u),T=Math.cos(u);return a[0]=T,a[1]=x,a[2]=-x,a[3]=T,a[4]=0,a[5]=0,a},Si.fromScaling=function(a,u){return a[0]=u[0],a[1]=0,a[2]=0,a[3]=u[1],a[4]=0,a[5]=0,a},Si.fromTranslation=function(a,u){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=u[0],a[5]=u[1],a},Si.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"},Si.frob=function(a){return Math.hypot(a[0],a[1],a[2],a[3],a[4],a[5],1)},Si.add=function(a,u,x){return a[0]=u[0]+x[0],a[1]=u[1]+x[1],a[2]=u[2]+x[2],a[3]=u[3]+x[3],a[4]=u[4]+x[4],a[5]=u[5]+x[5],a},Si.subtract=h,Si.multiplyScalar=function(a,u,x){return a[0]=u[0]*x,a[1]=u[1]*x,a[2]=u[2]*x,a[3]=u[3]*x,a[4]=u[4]*x,a[5]=u[5]*x,a},Si.multiplyScalarAndAdd=function(a,u,x,T){return a[0]=u[0]+x[0]*T,a[1]=u[1]+x[1]*T,a[2]=u[2]+x[2]*T,a[3]=u[3]+x[3]*T,a[4]=u[4]+x[4]*T,a[5]=u[5]+x[5]*T,a},Si.exactEquals=function(a,u){return a[0]===u[0]&&a[1]===u[1]&&a[2]===u[2]&&a[3]===u[3]&&a[4]===u[4]&&a[5]===u[5]},Si.equals=function(a,u){var x=a[0],T=a[1],C=a[2],g=a[3],S=a[4],A=a[5],w=u[0],M=u[1],P=u[2],O=u[3],B=u[4],G=u[5];return Math.abs(x-w)<=e.EPSILON*Math.max(1,Math.abs(x),Math.abs(w))&&Math.abs(T-M)<=e.EPSILON*Math.max(1,Math.abs(T),Math.abs(M))&&Math.abs(C-P)<=e.EPSILON*Math.max(1,Math.abs(C),Math.abs(P))&&Math.abs(g-O)<=e.EPSILON*Math.max(1,Math.abs(g),Math.abs(O))&&Math.abs(S-B)<=e.EPSILON*Math.max(1,Math.abs(S),Math.abs(B))&&Math.abs(A-G)<=e.EPSILON*Math.max(1,Math.abs(A),Math.abs(G))},Si.sub=Si.mul=void 0;var e=function(a){if(a&&a.__esModule)return a;if(null===a||"object"!==r(a)&&"function"!=typeof a)return{default:a};var x=i(void 0);if(x&&x.has(a))return x.get(a);var T={},C=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var g in a)if("default"!==g&&Object.prototype.hasOwnProperty.call(a,g)){var S=C?Object.getOwnPropertyDescriptor(a,g):null;S&&(S.get||S.set)?Object.defineProperty(T,g,S):T[g]=a[g]}return T.default=a,x&&x.set(a,T),T}(Xn());function i(a){if("function"!=typeof WeakMap)return null;var u=new WeakMap,x=new WeakMap;return(i=function(T){return T?x:u})(a)}function s(a,u,x){var T=u[0],C=u[1],g=u[2],S=u[3],A=u[4],w=u[5],M=x[0],P=x[1],O=x[2],B=x[3],G=x[4],q=x[5];return a[0]=T*M+g*P,a[1]=C*M+S*P,a[2]=T*O+g*B,a[3]=C*O+S*B,a[4]=T*G+g*q+A,a[5]=C*G+S*q+w,a}function h(a,u,x){return a[0]=u[0]-x[0],a[1]=u[1]-x[1],a[2]=u[2]-x[2],a[3]=u[3]-x[3],a[4]=u[4]-x[4],a[5]=u[5]-x[5],a}return Si.mul=s,Si.sub=h,Si}var xr,gi={};function $o(){if(xr)return gi;function r(a){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(u){return typeof u}:function(u){return u&&"function"==typeof Symbol&&u.constructor===Symbol&&u!==Symbol.prototype?"symbol":typeof u})(a)}xr=1,Object.defineProperty(gi,"__esModule",{value:!0}),gi.create=function(){var a=new e.ARRAY_TYPE(9);return e.ARRAY_TYPE!=Float32Array&&(a[1]=0,a[2]=0,a[3]=0,a[5]=0,a[6]=0,a[7]=0),a[0]=1,a[4]=1,a[8]=1,a},gi.fromMat4=function(a,u){return a[0]=u[0],a[1]=u[1],a[2]=u[2],a[3]=u[4],a[4]=u[5],a[5]=u[6],a[6]=u[8],a[7]=u[9],a[8]=u[10],a},gi.clone=function(a){var u=new e.ARRAY_TYPE(9);return u[0]=a[0],u[1]=a[1],u[2]=a[2],u[3]=a[3],u[4]=a[4],u[5]=a[5],u[6]=a[6],u[7]=a[7],u[8]=a[8],u},gi.copy=function(a,u){return a[0]=u[0],a[1]=u[1],a[2]=u[2],a[3]=u[3],a[4]=u[4],a[5]=u[5],a[6]=u[6],a[7]=u[7],a[8]=u[8],a},gi.fromValues=function(a,u,x,T,C,g,S,A,w){var M=new e.ARRAY_TYPE(9);return M[0]=a,M[1]=u,M[2]=x,M[3]=T,M[4]=C,M[5]=g,M[6]=S,M[7]=A,M[8]=w,M},gi.set=function(a,u,x,T,C,g,S,A,w,M){return a[0]=u,a[1]=x,a[2]=T,a[3]=C,a[4]=g,a[5]=S,a[6]=A,a[7]=w,a[8]=M,a},gi.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},gi.transpose=function(a,u){if(a===u){var x=u[1],T=u[2],C=u[5];a[1]=u[3],a[2]=u[6],a[3]=x,a[5]=u[7],a[6]=T,a[7]=C}else a[0]=u[0],a[1]=u[3],a[2]=u[6],a[3]=u[1],a[4]=u[4],a[5]=u[7],a[6]=u[2],a[7]=u[5],a[8]=u[8];return a},gi.invert=function(a,u){var x=u[0],T=u[1],C=u[2],g=u[3],S=u[4],A=u[5],w=u[6],M=u[7],P=u[8],O=P*S-A*M,B=-P*g+A*w,G=M*g-S*w,q=x*O+T*B+C*G;return q?(a[0]=O*(q=1/q),a[1]=(-P*T+C*M)*q,a[2]=(A*T-C*S)*q,a[3]=B*q,a[4]=(P*x-C*w)*q,a[5]=(-A*x+C*g)*q,a[6]=G*q,a[7]=(-M*x+T*w)*q,a[8]=(S*x-T*g)*q,a):null},gi.adjoint=function(a,u){var x=u[0],T=u[1],C=u[2],g=u[3],S=u[4],A=u[5],w=u[6],M=u[7],P=u[8];return a[0]=S*P-A*M,a[1]=C*M-T*P,a[2]=T*A-C*S,a[3]=A*w-g*P,a[4]=x*P-C*w,a[5]=C*g-x*A,a[6]=g*M-S*w,a[7]=T*w-x*M,a[8]=x*S-T*g,a},gi.determinant=function(a){var u=a[3],x=a[4],T=a[5],C=a[6],g=a[7],S=a[8];return a[0]*(S*x-T*g)+a[1]*(-S*u+T*C)+a[2]*(g*u-x*C)},gi.multiply=s,gi.translate=function(a,u,x){var T=u[0],C=u[1],g=u[2],S=u[3],A=u[4],w=u[5],M=u[6],P=u[7],O=u[8],B=x[0],G=x[1];return a[0]=T,a[1]=C,a[2]=g,a[3]=S,a[4]=A,a[5]=w,a[6]=B*T+G*S+M,a[7]=B*C+G*A+P,a[8]=B*g+G*w+O,a},gi.rotate=function(a,u,x){var T=u[0],C=u[1],g=u[2],S=u[3],A=u[4],w=u[5],M=u[6],P=u[7],O=u[8],B=Math.sin(x),G=Math.cos(x);return a[0]=G*T+B*S,a[1]=G*C+B*A,a[2]=G*g+B*w,a[3]=G*S-B*T,a[4]=G*A-B*C,a[5]=G*w-B*g,a[6]=M,a[7]=P,a[8]=O,a},gi.scale=function(a,u,x){var T=x[0],C=x[1];return a[0]=T*u[0],a[1]=T*u[1],a[2]=T*u[2],a[3]=C*u[3],a[4]=C*u[4],a[5]=C*u[5],a[6]=u[6],a[7]=u[7],a[8]=u[8],a},gi.fromTranslation=function(a,u){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=u[0],a[7]=u[1],a[8]=1,a},gi.fromRotation=function(a,u){var x=Math.sin(u),T=Math.cos(u);return a[0]=T,a[1]=x,a[2]=0,a[3]=-x,a[4]=T,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},gi.fromScaling=function(a,u){return a[0]=u[0],a[1]=0,a[2]=0,a[3]=0,a[4]=u[1],a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},gi.fromMat2d=function(a,u){return a[0]=u[0],a[1]=u[1],a[2]=0,a[3]=u[2],a[4]=u[3],a[5]=0,a[6]=u[4],a[7]=u[5],a[8]=1,a},gi.fromQuat=function(a,u){var x=u[0],T=u[1],C=u[2],g=u[3],S=x+x,A=T+T,w=C+C,M=x*S,P=T*S,O=T*A,B=C*S,G=C*A,q=C*w,U=g*S,W=g*A,X=g*w;return a[0]=1-O-q,a[3]=P-X,a[6]=B+W,a[1]=P+X,a[4]=1-M-q,a[7]=G-U,a[2]=B-W,a[5]=G+U,a[8]=1-M-O,a},gi.normalFromMat4=function(a,u){var x=u[0],T=u[1],C=u[2],g=u[3],S=u[4],A=u[5],w=u[6],M=u[7],P=u[8],O=u[9],B=u[10],G=u[11],q=u[12],U=u[13],W=u[14],X=u[15],ee=x*A-T*S,ae=x*w-C*S,oe=x*M-g*S,se=T*w-C*A,ye=T*M-g*A,le=C*M-g*w,ve=P*U-O*q,Se=P*W-B*q,we=P*X-G*q,Ae=O*W-B*U,Pe=O*X-G*U,ke=B*X-G*W,Ce=ee*ke-ae*Pe+oe*Ae+se*we-ye*Se+le*ve;return Ce?(a[0]=(A*ke-w*Pe+M*Ae)*(Ce=1/Ce),a[1]=(w*we-S*ke-M*Se)*Ce,a[2]=(S*Pe-A*we+M*ve)*Ce,a[3]=(C*Pe-T*ke-g*Ae)*Ce,a[4]=(x*ke-C*we+g*Se)*Ce,a[5]=(T*we-x*Pe-g*ve)*Ce,a[6]=(U*le-W*ye+X*se)*Ce,a[7]=(W*oe-q*le-X*ae)*Ce,a[8]=(q*ye-U*oe+X*ee)*Ce,a):null},gi.projection=function(a,u,x){return a[0]=2/u,a[1]=0,a[2]=0,a[3]=0,a[4]=-2/x,a[5]=0,a[6]=-1,a[7]=1,a[8]=1,a},gi.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"},gi.frob=function(a){return Math.hypot(a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8])},gi.add=function(a,u,x){return a[0]=u[0]+x[0],a[1]=u[1]+x[1],a[2]=u[2]+x[2],a[3]=u[3]+x[3],a[4]=u[4]+x[4],a[5]=u[5]+x[5],a[6]=u[6]+x[6],a[7]=u[7]+x[7],a[8]=u[8]+x[8],a},gi.subtract=h,gi.multiplyScalar=function(a,u,x){return a[0]=u[0]*x,a[1]=u[1]*x,a[2]=u[2]*x,a[3]=u[3]*x,a[4]=u[4]*x,a[5]=u[5]*x,a[6]=u[6]*x,a[7]=u[7]*x,a[8]=u[8]*x,a},gi.multiplyScalarAndAdd=function(a,u,x,T){return a[0]=u[0]+x[0]*T,a[1]=u[1]+x[1]*T,a[2]=u[2]+x[2]*T,a[3]=u[3]+x[3]*T,a[4]=u[4]+x[4]*T,a[5]=u[5]+x[5]*T,a[6]=u[6]+x[6]*T,a[7]=u[7]+x[7]*T,a[8]=u[8]+x[8]*T,a},gi.exactEquals=function(a,u){return a[0]===u[0]&&a[1]===u[1]&&a[2]===u[2]&&a[3]===u[3]&&a[4]===u[4]&&a[5]===u[5]&&a[6]===u[6]&&a[7]===u[7]&&a[8]===u[8]},gi.equals=function(a,u){var x=a[0],T=a[1],C=a[2],g=a[3],S=a[4],A=a[5],w=a[6],M=a[7],P=a[8],O=u[0],B=u[1],G=u[2],q=u[3],U=u[4],W=u[5],X=u[6],ee=u[7],ae=u[8];return Math.abs(x-O)<=e.EPSILON*Math.max(1,Math.abs(x),Math.abs(O))&&Math.abs(T-B)<=e.EPSILON*Math.max(1,Math.abs(T),Math.abs(B))&&Math.abs(C-G)<=e.EPSILON*Math.max(1,Math.abs(C),Math.abs(G))&&Math.abs(g-q)<=e.EPSILON*Math.max(1,Math.abs(g),Math.abs(q))&&Math.abs(S-U)<=e.EPSILON*Math.max(1,Math.abs(S),Math.abs(U))&&Math.abs(A-W)<=e.EPSILON*Math.max(1,Math.abs(A),Math.abs(W))&&Math.abs(w-X)<=e.EPSILON*Math.max(1,Math.abs(w),Math.abs(X))&&Math.abs(M-ee)<=e.EPSILON*Math.max(1,Math.abs(M),Math.abs(ee))&&Math.abs(P-ae)<=e.EPSILON*Math.max(1,Math.abs(P),Math.abs(ae))},gi.sub=gi.mul=void 0;var e=function(a){if(a&&a.__esModule)return a;if(null===a||"object"!==r(a)&&"function"!=typeof a)return{default:a};var x=i(void 0);if(x&&x.has(a))return x.get(a);var T={},C=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var g in a)if("default"!==g&&Object.prototype.hasOwnProperty.call(a,g)){var S=C?Object.getOwnPropertyDescriptor(a,g):null;S&&(S.get||S.set)?Object.defineProperty(T,g,S):T[g]=a[g]}return T.default=a,x&&x.set(a,T),T}(Xn());function i(a){if("function"!=typeof WeakMap)return null;var u=new WeakMap,x=new WeakMap;return(i=function(T){return T?x:u})(a)}function s(a,u,x){var T=u[0],C=u[1],g=u[2],S=u[3],A=u[4],w=u[5],M=u[6],P=u[7],O=u[8],B=x[0],G=x[1],q=x[2],U=x[3],W=x[4],X=x[5],ee=x[6],ae=x[7],oe=x[8];return a[0]=B*T+G*S+q*M,a[1]=B*C+G*A+q*P,a[2]=B*g+G*w+q*O,a[3]=U*T+W*S+X*M,a[4]=U*C+W*A+X*P,a[5]=U*g+W*w+X*O,a[6]=ee*T+ae*S+oe*M,a[7]=ee*C+ae*A+oe*P,a[8]=ee*g+ae*w+oe*O,a}function h(a,u,x){return a[0]=u[0]-x[0],a[1]=u[1]-x[1],a[2]=u[2]-x[2],a[3]=u[3]-x[3],a[4]=u[4]-x[4],a[5]=u[5]-x[5],a[6]=u[6]-x[6],a[7]=u[7]-x[7],a[8]=u[8]-x[8],a}return gi.mul=s,gi.sub=h,gi}var Da,Xt={};function Ms(){if(Da)return Xt;function r(g){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(S){return typeof S}:function(S){return S&&"function"==typeof Symbol&&S.constructor===Symbol&&S!==Symbol.prototype?"symbol":typeof S})(g)}Da=1,Object.defineProperty(Xt,"__esModule",{value:!0}),Xt.create=function(){var g=new e.ARRAY_TYPE(16);return e.ARRAY_TYPE!=Float32Array&&(g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=0,g[12]=0,g[13]=0,g[14]=0),g[0]=1,g[5]=1,g[10]=1,g[15]=1,g},Xt.clone=function(g){var S=new e.ARRAY_TYPE(16);return S[0]=g[0],S[1]=g[1],S[2]=g[2],S[3]=g[3],S[4]=g[4],S[5]=g[5],S[6]=g[6],S[7]=g[7],S[8]=g[8],S[9]=g[9],S[10]=g[10],S[11]=g[11],S[12]=g[12],S[13]=g[13],S[14]=g[14],S[15]=g[15],S},Xt.copy=function(g,S){return g[0]=S[0],g[1]=S[1],g[2]=S[2],g[3]=S[3],g[4]=S[4],g[5]=S[5],g[6]=S[6],g[7]=S[7],g[8]=S[8],g[9]=S[9],g[10]=S[10],g[11]=S[11],g[12]=S[12],g[13]=S[13],g[14]=S[14],g[15]=S[15],g},Xt.fromValues=function(g,S,A,w,M,P,O,B,G,q,U,W,X,ee,ae,oe){var se=new e.ARRAY_TYPE(16);return se[0]=g,se[1]=S,se[2]=A,se[3]=w,se[4]=M,se[5]=P,se[6]=O,se[7]=B,se[8]=G,se[9]=q,se[10]=U,se[11]=W,se[12]=X,se[13]=ee,se[14]=ae,se[15]=oe,se},Xt.set=function(g,S,A,w,M,P,O,B,G,q,U,W,X,ee,ae,oe,se){return g[0]=S,g[1]=A,g[2]=w,g[3]=M,g[4]=P,g[5]=O,g[6]=B,g[7]=G,g[8]=q,g[9]=U,g[10]=W,g[11]=X,g[12]=ee,g[13]=ae,g[14]=oe,g[15]=se,g},Xt.identity=s,Xt.transpose=function(g,S){if(g===S){var A=S[1],w=S[2],M=S[3],P=S[6],O=S[7],B=S[11];g[1]=S[4],g[2]=S[8],g[3]=S[12],g[4]=A,g[6]=S[9],g[7]=S[13],g[8]=w,g[9]=P,g[11]=S[14],g[12]=M,g[13]=O,g[14]=B}else g[0]=S[0],g[1]=S[4],g[2]=S[8],g[3]=S[12],g[4]=S[1],g[5]=S[5],g[6]=S[9],g[7]=S[13],g[8]=S[2],g[9]=S[6],g[10]=S[10],g[11]=S[14],g[12]=S[3],g[13]=S[7],g[14]=S[11],g[15]=S[15];return g},Xt.invert=function(g,S){var A=S[0],w=S[1],M=S[2],P=S[3],O=S[4],B=S[5],G=S[6],q=S[7],U=S[8],W=S[9],X=S[10],ee=S[11],ae=S[12],oe=S[13],se=S[14],ye=S[15],le=A*B-w*O,ve=A*G-M*O,Se=A*q-P*O,we=w*G-M*B,Ae=w*q-P*B,Pe=M*q-P*G,ke=U*oe-W*ae,Ce=U*se-X*ae,Ze=U*ye-ee*ae,tt=W*se-X*oe,$e=W*ye-ee*oe,gt=X*ye-ee*se,mt=le*gt-ve*$e+Se*tt+we*Ze-Ae*Ce+Pe*ke;return mt?(g[0]=(B*gt-G*$e+q*tt)*(mt=1/mt),g[1]=(M*$e-w*gt-P*tt)*mt,g[2]=(oe*Pe-se*Ae+ye*we)*mt,g[3]=(X*Ae-W*Pe-ee*we)*mt,g[4]=(G*Ze-O*gt-q*Ce)*mt,g[5]=(A*gt-M*Ze+P*Ce)*mt,g[6]=(se*Se-ae*Pe-ye*ve)*mt,g[7]=(U*Pe-X*Se+ee*ve)*mt,g[8]=(O*$e-B*Ze+q*ke)*mt,g[9]=(w*Ze-A*$e-P*ke)*mt,g[10]=(ae*Ae-oe*Se+ye*le)*mt,g[11]=(W*Se-U*Ae-ee*le)*mt,g[12]=(B*Ce-O*tt-G*ke)*mt,g[13]=(A*tt-w*Ce+M*ke)*mt,g[14]=(oe*ve-ae*we-se*le)*mt,g[15]=(U*we-W*ve+X*le)*mt,g):null},Xt.adjoint=function(g,S){var A=S[0],w=S[1],M=S[2],P=S[3],O=S[4],B=S[5],G=S[6],q=S[7],U=S[8],W=S[9],X=S[10],ee=S[11],ae=S[12],oe=S[13],se=S[14],ye=S[15];return g[0]=B*(X*ye-ee*se)-W*(G*ye-q*se)+oe*(G*ee-q*X),g[1]=-(w*(X*ye-ee*se)-W*(M*ye-P*se)+oe*(M*ee-P*X)),g[2]=w*(G*ye-q*se)-B*(M*ye-P*se)+oe*(M*q-P*G),g[3]=-(w*(G*ee-q*X)-B*(M*ee-P*X)+W*(M*q-P*G)),g[4]=-(O*(X*ye-ee*se)-U*(G*ye-q*se)+ae*(G*ee-q*X)),g[5]=A*(X*ye-ee*se)-U*(M*ye-P*se)+ae*(M*ee-P*X),g[6]=-(A*(G*ye-q*se)-O*(M*ye-P*se)+ae*(M*q-P*G)),g[7]=A*(G*ee-q*X)-O*(M*ee-P*X)+U*(M*q-P*G),g[8]=O*(W*ye-ee*oe)-U*(B*ye-q*oe)+ae*(B*ee-q*W),g[9]=-(A*(W*ye-ee*oe)-U*(w*ye-P*oe)+ae*(w*ee-P*W)),g[10]=A*(B*ye-q*oe)-O*(w*ye-P*oe)+ae*(w*q-P*B),g[11]=-(A*(B*ee-q*W)-O*(w*ee-P*W)+U*(w*q-P*B)),g[12]=-(O*(W*se-X*oe)-U*(B*se-G*oe)+ae*(B*X-G*W)),g[13]=A*(W*se-X*oe)-U*(w*se-M*oe)+ae*(w*X-M*W),g[14]=-(A*(B*se-G*oe)-O*(w*se-M*oe)+ae*(w*G-M*B)),g[15]=A*(B*X-G*W)-O*(w*X-M*W)+U*(w*G-M*B),g},Xt.determinant=function(g){var S=g[0],A=g[1],w=g[2],M=g[3],P=g[4],O=g[5],B=g[6],G=g[7],q=g[8],U=g[9],W=g[10],X=g[11],ee=g[12],ae=g[13],oe=g[14],se=g[15];return(S*O-A*P)*(W*se-X*oe)-(S*B-w*P)*(U*se-X*ae)+(S*G-M*P)*(U*oe-W*ae)+(A*B-w*O)*(q*se-X*ee)-(A*G-M*O)*(q*oe-W*ee)+(w*G-M*B)*(q*ae-U*ee)},Xt.multiply=h,Xt.translate=function(g,S,A){var w,M,P,O,B,G,q,U,W,X,ee,ae,oe=A[0],se=A[1],ye=A[2];return S===g?(g[12]=S[0]*oe+S[4]*se+S[8]*ye+S[12],g[13]=S[1]*oe+S[5]*se+S[9]*ye+S[13],g[14]=S[2]*oe+S[6]*se+S[10]*ye+S[14],g[15]=S[3]*oe+S[7]*se+S[11]*ye+S[15]):(M=S[1],P=S[2],O=S[3],B=S[4],G=S[5],q=S[6],U=S[7],W=S[8],X=S[9],ee=S[10],ae=S[11],g[0]=w=S[0],g[1]=M,g[2]=P,g[3]=O,g[4]=B,g[5]=G,g[6]=q,g[7]=U,g[8]=W,g[9]=X,g[10]=ee,g[11]=ae,g[12]=w*oe+B*se+W*ye+S[12],g[13]=M*oe+G*se+X*ye+S[13],g[14]=P*oe+q*se+ee*ye+S[14],g[15]=O*oe+U*se+ae*ye+S[15]),g},Xt.scale=function(g,S,A){var w=A[0],M=A[1],P=A[2];return g[0]=S[0]*w,g[1]=S[1]*w,g[2]=S[2]*w,g[3]=S[3]*w,g[4]=S[4]*M,g[5]=S[5]*M,g[6]=S[6]*M,g[7]=S[7]*M,g[8]=S[8]*P,g[9]=S[9]*P,g[10]=S[10]*P,g[11]=S[11]*P,g[12]=S[12],g[13]=S[13],g[14]=S[14],g[15]=S[15],g},Xt.rotate=function(g,S,A,w){var M,P,O,B,G,q,U,W,X,ee,ae,oe,se,ye,le,ve,Se,we,Ae,Pe,ke,Ce,Ze,tt,$e=w[0],gt=w[1],mt=w[2],st=Math.hypot($e,gt,mt);return st<e.EPSILON?null:($e*=st=1/st,gt*=st,mt*=st,M=Math.sin(A),P=Math.cos(A),G=S[1],q=S[2],U=S[3],X=S[5],ee=S[6],ae=S[7],se=S[9],ye=S[10],le=S[11],ve=$e*$e*(O=1-P)+P,Ae=$e*gt*O-mt*M,Pe=gt*gt*O+P,ke=mt*gt*O+$e*M,Ce=$e*mt*O+gt*M,Ze=gt*mt*O-$e*M,tt=mt*mt*O+P,g[0]=(B=S[0])*ve+(W=S[4])*(Se=gt*$e*O+mt*M)+(oe=S[8])*(we=mt*$e*O-gt*M),g[1]=G*ve+X*Se+se*we,g[2]=q*ve+ee*Se+ye*we,g[3]=U*ve+ae*Se+le*we,g[4]=B*Ae+W*Pe+oe*ke,g[5]=G*Ae+X*Pe+se*ke,g[6]=q*Ae+ee*Pe+ye*ke,g[7]=U*Ae+ae*Pe+le*ke,g[8]=B*Ce+W*Ze+oe*tt,g[9]=G*Ce+X*Ze+se*tt,g[10]=q*Ce+ee*Ze+ye*tt,g[11]=U*Ce+ae*Ze+le*tt,S!==g&&(g[12]=S[12],g[13]=S[13],g[14]=S[14],g[15]=S[15]),g)},Xt.rotateX=function(g,S,A){var w=Math.sin(A),M=Math.cos(A),P=S[4],O=S[5],B=S[6],G=S[7],q=S[8],U=S[9],W=S[10],X=S[11];return S!==g&&(g[0]=S[0],g[1]=S[1],g[2]=S[2],g[3]=S[3],g[12]=S[12],g[13]=S[13],g[14]=S[14],g[15]=S[15]),g[4]=P*M+q*w,g[5]=O*M+U*w,g[6]=B*M+W*w,g[7]=G*M+X*w,g[8]=q*M-P*w,g[9]=U*M-O*w,g[10]=W*M-B*w,g[11]=X*M-G*w,g},Xt.rotateY=function(g,S,A){var w=Math.sin(A),M=Math.cos(A),P=S[0],O=S[1],B=S[2],G=S[3],q=S[8],U=S[9],W=S[10],X=S[11];return S!==g&&(g[4]=S[4],g[5]=S[5],g[6]=S[6],g[7]=S[7],g[12]=S[12],g[13]=S[13],g[14]=S[14],g[15]=S[15]),g[0]=P*M-q*w,g[1]=O*M-U*w,g[2]=B*M-W*w,g[3]=G*M-X*w,g[8]=P*w+q*M,g[9]=O*w+U*M,g[10]=B*w+W*M,g[11]=G*w+X*M,g},Xt.rotateZ=function(g,S,A){var w=Math.sin(A),M=Math.cos(A),P=S[0],O=S[1],B=S[2],G=S[3],q=S[4],U=S[5],W=S[6],X=S[7];return S!==g&&(g[8]=S[8],g[9]=S[9],g[10]=S[10],g[11]=S[11],g[12]=S[12],g[13]=S[13],g[14]=S[14],g[15]=S[15]),g[0]=P*M+q*w,g[1]=O*M+U*w,g[2]=B*M+W*w,g[3]=G*M+X*w,g[4]=q*M-P*w,g[5]=U*M-O*w,g[6]=W*M-B*w,g[7]=X*M-G*w,g},Xt.fromTranslation=function(g,S){return g[0]=1,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=1,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=1,g[11]=0,g[12]=S[0],g[13]=S[1],g[14]=S[2],g[15]=1,g},Xt.fromScaling=function(g,S){return g[0]=S[0],g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=S[1],g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=S[2],g[11]=0,g[12]=0,g[13]=0,g[14]=0,g[15]=1,g},Xt.fromRotation=function(g,S,A){var w,M,P,O=A[0],B=A[1],G=A[2],q=Math.hypot(O,B,G);return q<e.EPSILON?null:(O*=q=1/q,B*=q,G*=q,w=Math.sin(S),M=Math.cos(S),g[0]=O*O*(P=1-M)+M,g[1]=B*O*P+G*w,g[2]=G*O*P-B*w,g[3]=0,g[4]=O*B*P-G*w,g[5]=B*B*P+M,g[6]=G*B*P+O*w,g[7]=0,g[8]=O*G*P+B*w,g[9]=B*G*P-O*w,g[10]=G*G*P+M,g[11]=0,g[12]=0,g[13]=0,g[14]=0,g[15]=1,g)},Xt.fromXRotation=function(g,S){var A=Math.sin(S),w=Math.cos(S);return g[0]=1,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=w,g[6]=A,g[7]=0,g[8]=0,g[9]=-A,g[10]=w,g[11]=0,g[12]=0,g[13]=0,g[14]=0,g[15]=1,g},Xt.fromYRotation=function(g,S){var A=Math.sin(S),w=Math.cos(S);return g[0]=w,g[1]=0,g[2]=-A,g[3]=0,g[4]=0,g[5]=1,g[6]=0,g[7]=0,g[8]=A,g[9]=0,g[10]=w,g[11]=0,g[12]=0,g[13]=0,g[14]=0,g[15]=1,g},Xt.fromZRotation=function(g,S){var A=Math.sin(S),w=Math.cos(S);return g[0]=w,g[1]=A,g[2]=0,g[3]=0,g[4]=-A,g[5]=w,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=1,g[11]=0,g[12]=0,g[13]=0,g[14]=0,g[15]=1,g},Xt.fromRotationTranslation=a,Xt.fromQuat2=function(g,S){var A=new e.ARRAY_TYPE(3),w=-S[0],M=-S[1],P=-S[2],O=S[3],B=S[4],G=S[5],q=S[6],U=S[7],W=w*w+M*M+P*P+O*O;return W>0?(A[0]=2*(B*O+U*w+G*P-q*M)/W,A[1]=2*(G*O+U*M+q*w-B*P)/W,A[2]=2*(q*O+U*P+B*M-G*w)/W):(A[0]=2*(B*O+U*w+G*P-q*M),A[1]=2*(G*O+U*M+q*w-B*P),A[2]=2*(q*O+U*P+B*M-G*w)),a(g,S,A),g},Xt.getTranslation=function(g,S){return g[0]=S[12],g[1]=S[13],g[2]=S[14],g},Xt.getScaling=u,Xt.getRotation=function(g,S){var A=new e.ARRAY_TYPE(3);u(A,S);var w=1/A[0],M=1/A[1],P=1/A[2],O=S[0]*w,B=S[1]*M,G=S[2]*P,q=S[4]*w,U=S[5]*M,W=S[6]*P,X=S[8]*w,ee=S[9]*M,ae=S[10]*P,oe=O+U+ae,se=0;return oe>0?(se=2*Math.sqrt(oe+1),g[3]=.25*se,g[0]=(W-ee)/se,g[1]=(X-G)/se,g[2]=(B-q)/se):O>U&&O>ae?(se=2*Math.sqrt(1+O-U-ae),g[3]=(W-ee)/se,g[0]=.25*se,g[1]=(B+q)/se,g[2]=(X+G)/se):U>ae?(se=2*Math.sqrt(1+U-O-ae),g[3]=(X-G)/se,g[0]=(B+q)/se,g[1]=.25*se,g[2]=(W+ee)/se):(se=2*Math.sqrt(1+ae-O-U),g[3]=(B-q)/se,g[0]=(X+G)/se,g[1]=(W+ee)/se,g[2]=.25*se),g},Xt.fromRotationTranslationScale=function(g,S,A,w){var M=S[0],P=S[1],O=S[2],B=S[3],G=M+M,q=P+P,U=O+O,W=M*G,X=M*q,ee=M*U,ae=P*q,oe=P*U,se=O*U,ye=B*G,le=B*q,ve=B*U,Se=w[0],we=w[1],Ae=w[2];return g[0]=(1-(ae+se))*Se,g[1]=(X+ve)*Se,g[2]=(ee-le)*Se,g[3]=0,g[4]=(X-ve)*we,g[5]=(1-(W+se))*we,g[6]=(oe+ye)*we,g[7]=0,g[8]=(ee+le)*Ae,g[9]=(oe-ye)*Ae,g[10]=(1-(W+ae))*Ae,g[11]=0,g[12]=A[0],g[13]=A[1],g[14]=A[2],g[15]=1,g},Xt.fromRotationTranslationScaleOrigin=function(g,S,A,w,M){var P=S[0],O=S[1],B=S[2],G=S[3],q=P+P,U=O+O,W=B+B,X=P*q,ee=P*U,ae=P*W,oe=O*U,se=O*W,ye=B*W,le=G*q,ve=G*U,Se=G*W,we=w[0],Ae=w[1],Pe=w[2],ke=M[0],Ce=M[1],Ze=M[2],tt=(1-(oe+ye))*we,$e=(ee+Se)*we,gt=(ae-ve)*we,mt=(ee-Se)*Ae,st=(1-(X+ye))*Ae,nt=(se+le)*Ae,It=(ae+ve)*Pe,yt=(se-le)*Pe,wt=(1-(X+oe))*Pe;return g[0]=tt,g[1]=$e,g[2]=gt,g[3]=0,g[4]=mt,g[5]=st,g[6]=nt,g[7]=0,g[8]=It,g[9]=yt,g[10]=wt,g[11]=0,g[12]=A[0]+ke-(tt*ke+mt*Ce+It*Ze),g[13]=A[1]+Ce-($e*ke+st*Ce+yt*Ze),g[14]=A[2]+Ze-(gt*ke+nt*Ce+wt*Ze),g[15]=1,g},Xt.fromQuat=function(g,S){var A=S[0],w=S[1],M=S[2],P=S[3],O=A+A,B=w+w,G=M+M,q=A*O,U=w*O,W=w*B,X=M*O,ee=M*B,ae=M*G,oe=P*O,se=P*B,ye=P*G;return g[0]=1-W-ae,g[1]=U+ye,g[2]=X-se,g[3]=0,g[4]=U-ye,g[5]=1-q-ae,g[6]=ee+oe,g[7]=0,g[8]=X+se,g[9]=ee-oe,g[10]=1-q-W,g[11]=0,g[12]=0,g[13]=0,g[14]=0,g[15]=1,g},Xt.frustum=function(g,S,A,w,M,P,O){var B=1/(A-S),G=1/(M-w),q=1/(P-O);return g[0]=2*P*B,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2*P*G,g[6]=0,g[7]=0,g[8]=(A+S)*B,g[9]=(M+w)*G,g[10]=(O+P)*q,g[11]=-1,g[12]=0,g[13]=0,g[14]=O*P*2*q,g[15]=0,g},Xt.perspectiveNO=x,Xt.perspectiveZO=function(g,S,A,w,M){var P,O=1/Math.tan(S/2);return g[0]=O/A,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=O,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,null!=M&&M!==1/0?(g[10]=M*(P=1/(w-M)),g[14]=M*w*P):(g[10]=-1,g[14]=-w),g},Xt.perspectiveFromFieldOfView=function(g,S,A,w){var M=Math.tan(S.upDegrees*Math.PI/180),P=Math.tan(S.downDegrees*Math.PI/180),O=Math.tan(S.leftDegrees*Math.PI/180),B=Math.tan(S.rightDegrees*Math.PI/180),G=2/(O+B),q=2/(M+P);return g[0]=G,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=q,g[6]=0,g[7]=0,g[8]=-(O-B)*G*.5,g[9]=(M-P)*q*.5,g[10]=w/(A-w),g[11]=-1,g[12]=0,g[13]=0,g[14]=w*A/(A-w),g[15]=0,g},Xt.orthoNO=T,Xt.orthoZO=function(g,S,A,w,M,P,O){var B=1/(S-A),G=1/(w-M),q=1/(P-O);return g[0]=-2*B,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=-2*G,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=q,g[11]=0,g[12]=(S+A)*B,g[13]=(M+w)*G,g[14]=P*q,g[15]=1,g},Xt.lookAt=function(g,S,A,w){var M,P,O,B,G,q,U,W,X,ee,ae=S[0],oe=S[1],se=S[2],ye=w[0],le=w[1],ve=w[2],Se=A[0],we=A[1],Ae=A[2];return Math.abs(ae-Se)<e.EPSILON&&Math.abs(oe-we)<e.EPSILON&&Math.abs(se-Ae)<e.EPSILON?s(g):(U=ae-Se,W=oe-we,X=se-Ae,M=le*(X*=ee=1/Math.hypot(U,W,X))-ve*(W*=ee),P=ve*(U*=ee)-ye*X,O=ye*W-le*U,(ee=Math.hypot(M,P,O))?(M*=ee=1/ee,P*=ee,O*=ee):(M=0,P=0,O=0),B=W*O-X*P,G=X*M-U*O,q=U*P-W*M,(ee=Math.hypot(B,G,q))?(B*=ee=1/ee,G*=ee,q*=ee):(B=0,G=0,q=0),g[0]=M,g[1]=B,g[2]=U,g[3]=0,g[4]=P,g[5]=G,g[6]=W,g[7]=0,g[8]=O,g[9]=q,g[10]=X,g[11]=0,g[12]=-(M*ae+P*oe+O*se),g[13]=-(B*ae+G*oe+q*se),g[14]=-(U*ae+W*oe+X*se),g[15]=1,g)},Xt.targetTo=function(g,S,A,w){var M=S[0],P=S[1],O=S[2],B=w[0],G=w[1],q=w[2],U=M-A[0],W=P-A[1],X=O-A[2],ee=U*U+W*W+X*X;ee>0&&(U*=ee=1/Math.sqrt(ee),W*=ee,X*=ee);var ae=G*X-q*W,oe=q*U-B*X,se=B*W-G*U;return(ee=ae*ae+oe*oe+se*se)>0&&(ae*=ee=1/Math.sqrt(ee),oe*=ee,se*=ee),g[0]=ae,g[1]=oe,g[2]=se,g[3]=0,g[4]=W*se-X*oe,g[5]=X*ae-U*se,g[6]=U*oe-W*ae,g[7]=0,g[8]=U,g[9]=W,g[10]=X,g[11]=0,g[12]=M,g[13]=P,g[14]=O,g[15]=1,g},Xt.str=function(g){return"mat4("+g[0]+", "+g[1]+", "+g[2]+", "+g[3]+", "+g[4]+", "+g[5]+", "+g[6]+", "+g[7]+", "+g[8]+", "+g[9]+", "+g[10]+", "+g[11]+", "+g[12]+", "+g[13]+", "+g[14]+", "+g[15]+")"},Xt.frob=function(g){return Math.hypot(g[0],g[1],g[2],g[3],g[4],g[5],g[6],g[7],g[8],g[9],g[10],g[11],g[12],g[13],g[14],g[15])},Xt.add=function(g,S,A){return g[0]=S[0]+A[0],g[1]=S[1]+A[1],g[2]=S[2]+A[2],g[3]=S[3]+A[3],g[4]=S[4]+A[4],g[5]=S[5]+A[5],g[6]=S[6]+A[6],g[7]=S[7]+A[7],g[8]=S[8]+A[8],g[9]=S[9]+A[9],g[10]=S[10]+A[10],g[11]=S[11]+A[11],g[12]=S[12]+A[12],g[13]=S[13]+A[13],g[14]=S[14]+A[14],g[15]=S[15]+A[15],g},Xt.subtract=C,Xt.multiplyScalar=function(g,S,A){return g[0]=S[0]*A,g[1]=S[1]*A,g[2]=S[2]*A,g[3]=S[3]*A,g[4]=S[4]*A,g[5]=S[5]*A,g[6]=S[6]*A,g[7]=S[7]*A,g[8]=S[8]*A,g[9]=S[9]*A,g[10]=S[10]*A,g[11]=S[11]*A,g[12]=S[12]*A,g[13]=S[13]*A,g[14]=S[14]*A,g[15]=S[15]*A,g},Xt.multiplyScalarAndAdd=function(g,S,A,w){return g[0]=S[0]+A[0]*w,g[1]=S[1]+A[1]*w,g[2]=S[2]+A[2]*w,g[3]=S[3]+A[3]*w,g[4]=S[4]+A[4]*w,g[5]=S[5]+A[5]*w,g[6]=S[6]+A[6]*w,g[7]=S[7]+A[7]*w,g[8]=S[8]+A[8]*w,g[9]=S[9]+A[9]*w,g[10]=S[10]+A[10]*w,g[11]=S[11]+A[11]*w,g[12]=S[12]+A[12]*w,g[13]=S[13]+A[13]*w,g[14]=S[14]+A[14]*w,g[15]=S[15]+A[15]*w,g},Xt.exactEquals=function(g,S){return g[0]===S[0]&&g[1]===S[1]&&g[2]===S[2]&&g[3]===S[3]&&g[4]===S[4]&&g[5]===S[5]&&g[6]===S[6]&&g[7]===S[7]&&g[8]===S[8]&&g[9]===S[9]&&g[10]===S[10]&&g[11]===S[11]&&g[12]===S[12]&&g[13]===S[13]&&g[14]===S[14]&&g[15]===S[15]},Xt.equals=function(g,S){var A=g[0],w=g[1],M=g[2],P=g[3],O=g[4],B=g[5],G=g[6],q=g[7],U=g[8],W=g[9],X=g[10],ee=g[11],ae=g[12],oe=g[13],se=g[14],ye=g[15],le=S[0],ve=S[1],Se=S[2],we=S[3],Ae=S[4],Pe=S[5],ke=S[6],Ce=S[7],Ze=S[8],tt=S[9],$e=S[10],gt=S[11],mt=S[12],st=S[13],nt=S[14],It=S[15];return Math.abs(A-le)<=e.EPSILON*Math.max(1,Math.abs(A),Math.abs(le))&&Math.abs(w-ve)<=e.EPSILON*Math.max(1,Math.abs(w),Math.abs(ve))&&Math.abs(M-Se)<=e.EPSILON*Math.max(1,Math.abs(M),Math.abs(Se))&&Math.abs(P-we)<=e.EPSILON*Math.max(1,Math.abs(P),Math.abs(we))&&Math.abs(O-Ae)<=e.EPSILON*Math.max(1,Math.abs(O),Math.abs(Ae))&&Math.abs(B-Pe)<=e.EPSILON*Math.max(1,Math.abs(B),Math.abs(Pe))&&Math.abs(G-ke)<=e.EPSILON*Math.max(1,Math.abs(G),Math.abs(ke))&&Math.abs(q-Ce)<=e.EPSILON*Math.max(1,Math.abs(q),Math.abs(Ce))&&Math.abs(U-Ze)<=e.EPSILON*Math.max(1,Math.abs(U),Math.abs(Ze))&&Math.abs(W-tt)<=e.EPSILON*Math.max(1,Math.abs(W),Math.abs(tt))&&Math.abs(X-$e)<=e.EPSILON*Math.max(1,Math.abs(X),Math.abs($e))&&Math.abs(ee-gt)<=e.EPSILON*Math.max(1,Math.abs(ee),Math.abs(gt))&&Math.abs(ae-mt)<=e.EPSILON*Math.max(1,Math.abs(ae),Math.abs(mt))&&Math.abs(oe-st)<=e.EPSILON*Math.max(1,Math.abs(oe),Math.abs(st))&&Math.abs(se-nt)<=e.EPSILON*Math.max(1,Math.abs(se),Math.abs(nt))&&Math.abs(ye-It)<=e.EPSILON*Math.max(1,Math.abs(ye),Math.abs(It))},Xt.sub=Xt.mul=Xt.ortho=Xt.perspective=void 0;var e=function(g){if(g&&g.__esModule)return g;if(null===g||"object"!==r(g)&&"function"!=typeof g)return{default:g};var A=i(void 0);if(A&&A.has(g))return A.get(g);var w={},M=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var P in g)if("default"!==P&&Object.prototype.hasOwnProperty.call(g,P)){var O=M?Object.getOwnPropertyDescriptor(g,P):null;O&&(O.get||O.set)?Object.defineProperty(w,P,O):w[P]=g[P]}return w.default=g,A&&A.set(g,w),w}(Xn());function i(g){if("function"!=typeof WeakMap)return null;var S=new WeakMap,A=new WeakMap;return(i=function(w){return w?A:S})(g)}function s(g){return g[0]=1,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=1,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=1,g[11]=0,g[12]=0,g[13]=0,g[14]=0,g[15]=1,g}function h(g,S,A){var w=S[0],M=S[1],P=S[2],O=S[3],B=S[4],G=S[5],q=S[6],U=S[7],W=S[8],X=S[9],ee=S[10],ae=S[11],oe=S[12],se=S[13],ye=S[14],le=S[15],ve=A[0],Se=A[1],we=A[2],Ae=A[3];return g[0]=ve*w+Se*B+we*W+Ae*oe,g[1]=ve*M+Se*G+we*X+Ae*se,g[2]=ve*P+Se*q+we*ee+Ae*ye,g[3]=ve*O+Se*U+we*ae+Ae*le,g[4]=(ve=A[4])*w+(Se=A[5])*B+(we=A[6])*W+(Ae=A[7])*oe,g[5]=ve*M+Se*G+we*X+Ae*se,g[6]=ve*P+Se*q+we*ee+Ae*ye,g[7]=ve*O+Se*U+we*ae+Ae*le,g[8]=(ve=A[8])*w+(Se=A[9])*B+(we=A[10])*W+(Ae=A[11])*oe,g[9]=ve*M+Se*G+we*X+Ae*se,g[10]=ve*P+Se*q+we*ee+Ae*ye,g[11]=ve*O+Se*U+we*ae+Ae*le,g[12]=(ve=A[12])*w+(Se=A[13])*B+(we=A[14])*W+(Ae=A[15])*oe,g[13]=ve*M+Se*G+we*X+Ae*se,g[14]=ve*P+Se*q+we*ee+Ae*ye,g[15]=ve*O+Se*U+we*ae+Ae*le,g}function a(g,S,A){var w=S[0],M=S[1],P=S[2],O=S[3],B=w+w,G=M+M,q=P+P,U=w*B,W=w*G,X=w*q,ee=M*G,ae=M*q,oe=P*q,se=O*B,ye=O*G,le=O*q;return g[0]=1-(ee+oe),g[1]=W+le,g[2]=X-ye,g[3]=0,g[4]=W-le,g[5]=1-(U+oe),g[6]=ae+se,g[7]=0,g[8]=X+ye,g[9]=ae-se,g[10]=1-(U+ee),g[11]=0,g[12]=A[0],g[13]=A[1],g[14]=A[2],g[15]=1,g}function u(g,S){var A=S[4],w=S[5],M=S[6],P=S[8],O=S[9],B=S[10];return g[0]=Math.hypot(S[0],S[1],S[2]),g[1]=Math.hypot(A,w,M),g[2]=Math.hypot(P,O,B),g}function x(g,S,A,w,M){var P,O=1/Math.tan(S/2);return g[0]=O/A,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=O,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[11]=-1,g[12]=0,g[13]=0,g[15]=0,null!=M&&M!==1/0?(g[10]=(M+w)*(P=1/(w-M)),g[14]=2*M*w*P):(g[10]=-1,g[14]=-2*w),g}function T(g,S,A,w,M,P,O){var B=1/(S-A),G=1/(w-M),q=1/(P-O);return g[0]=-2*B,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=-2*G,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=2*q,g[11]=0,g[12]=(S+A)*B,g[13]=(M+w)*G,g[14]=(O+P)*q,g[15]=1,g}function C(g,S,A){return g[0]=S[0]-A[0],g[1]=S[1]-A[1],g[2]=S[2]-A[2],g[3]=S[3]-A[3],g[4]=S[4]-A[4],g[5]=S[5]-A[5],g[6]=S[6]-A[6],g[7]=S[7]-A[7],g[8]=S[8]-A[8],g[9]=S[9]-A[9],g[10]=S[10]-A[10],g[11]=S[11]-A[11],g[12]=S[12]-A[12],g[13]=S[13]-A[13],g[14]=S[14]-A[14],g[15]=S[15]-A[15],g}return Xt.perspective=x,Xt.ortho=T,Xt.mul=h,Xt.sub=C,Xt}var Gs,Yt={},Qt={};function za(){if(Gs)return Qt;function r(M){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(P){return typeof P}:function(P){return P&&"function"==typeof Symbol&&P.constructor===Symbol&&P!==Symbol.prototype?"symbol":typeof P})(M)}Gs=1,Object.defineProperty(Qt,"__esModule",{value:!0}),Qt.create=s,Qt.clone=function(M){var P=new e.ARRAY_TYPE(3);return P[0]=M[0],P[1]=M[1],P[2]=M[2],P},Qt.length=h,Qt.fromValues=function(M,P,O){var B=new e.ARRAY_TYPE(3);return B[0]=M,B[1]=P,B[2]=O,B},Qt.copy=function(M,P){return M[0]=P[0],M[1]=P[1],M[2]=P[2],M},Qt.set=function(M,P,O,B){return M[0]=P,M[1]=O,M[2]=B,M},Qt.add=function(M,P,O){return M[0]=P[0]+O[0],M[1]=P[1]+O[1],M[2]=P[2]+O[2],M},Qt.subtract=a,Qt.multiply=u,Qt.divide=x,Qt.ceil=function(M,P){return M[0]=Math.ceil(P[0]),M[1]=Math.ceil(P[1]),M[2]=Math.ceil(P[2]),M},Qt.floor=function(M,P){return M[0]=Math.floor(P[0]),M[1]=Math.floor(P[1]),M[2]=Math.floor(P[2]),M},Qt.min=function(M,P,O){return M[0]=Math.min(P[0],O[0]),M[1]=Math.min(P[1],O[1]),M[2]=Math.min(P[2],O[2]),M},Qt.max=function(M,P,O){return M[0]=Math.max(P[0],O[0]),M[1]=Math.max(P[1],O[1]),M[2]=Math.max(P[2],O[2]),M},Qt.round=function(M,P){return M[0]=Math.round(P[0]),M[1]=Math.round(P[1]),M[2]=Math.round(P[2]),M},Qt.scale=function(M,P,O){return M[0]=P[0]*O,M[1]=P[1]*O,M[2]=P[2]*O,M},Qt.scaleAndAdd=function(M,P,O,B){return M[0]=P[0]+O[0]*B,M[1]=P[1]+O[1]*B,M[2]=P[2]+O[2]*B,M},Qt.distance=T,Qt.squaredDistance=C,Qt.squaredLength=g,Qt.negate=function(M,P){return M[0]=-P[0],M[1]=-P[1],M[2]=-P[2],M},Qt.inverse=function(M,P){return M[0]=1/P[0],M[1]=1/P[1],M[2]=1/P[2],M},Qt.normalize=function(M,P){var O=P[0],B=P[1],G=P[2],q=O*O+B*B+G*G;return q>0&&(q=1/Math.sqrt(q)),M[0]=P[0]*q,M[1]=P[1]*q,M[2]=P[2]*q,M},Qt.dot=S,Qt.cross=function(M,P,O){var B=P[0],G=P[1],q=P[2],U=O[0],W=O[1],X=O[2];return M[0]=G*X-q*W,M[1]=q*U-B*X,M[2]=B*W-G*U,M},Qt.lerp=function(M,P,O,B){var G=P[0],q=P[1],U=P[2];return M[0]=G+B*(O[0]-G),M[1]=q+B*(O[1]-q),M[2]=U+B*(O[2]-U),M},Qt.hermite=function(M,P,O,B,G,q){var U=q*q,W=U*(2*q-3)+1,X=U*(q-2)+q,ee=U*(q-1),ae=U*(3-2*q);return M[0]=P[0]*W+O[0]*X+B[0]*ee+G[0]*ae,M[1]=P[1]*W+O[1]*X+B[1]*ee+G[1]*ae,M[2]=P[2]*W+O[2]*X+B[2]*ee+G[2]*ae,M},Qt.bezier=function(M,P,O,B,G,q){var U=1-q,W=U*U,X=q*q,ee=W*U,ae=3*q*W,oe=3*X*U,se=X*q;return M[0]=P[0]*ee+O[0]*ae+B[0]*oe+G[0]*se,M[1]=P[1]*ee+O[1]*ae+B[1]*oe+G[1]*se,M[2]=P[2]*ee+O[2]*ae+B[2]*oe+G[2]*se,M},Qt.random=function(M,P){P=P||1;var O=2*e.RANDOM()*Math.PI,B=2*e.RANDOM()-1,G=Math.sqrt(1-B*B)*P;return M[0]=Math.cos(O)*G,M[1]=Math.sin(O)*G,M[2]=B*P,M},Qt.transformMat4=function(M,P,O){var B=P[0],G=P[1],q=P[2],U=O[3]*B+O[7]*G+O[11]*q+O[15];return M[0]=(O[0]*B+O[4]*G+O[8]*q+O[12])/(U=U||1),M[1]=(O[1]*B+O[5]*G+O[9]*q+O[13])/U,M[2]=(O[2]*B+O[6]*G+O[10]*q+O[14])/U,M},Qt.transformMat3=function(M,P,O){var B=P[0],G=P[1],q=P[2];return M[0]=B*O[0]+G*O[3]+q*O[6],M[1]=B*O[1]+G*O[4]+q*O[7],M[2]=B*O[2]+G*O[5]+q*O[8],M},Qt.transformQuat=function(M,P,O){var B=O[0],G=O[1],q=O[2],U=P[0],W=P[1],X=P[2],ee=G*X-q*W,ae=q*U-B*X,oe=B*W-G*U,se=G*oe-q*ae,ye=q*ee-B*oe,le=B*ae-G*ee,ve=2*O[3];return ae*=ve,oe*=ve,ye*=2,le*=2,M[0]=U+(ee*=ve)+(se*=2),M[1]=W+ae+ye,M[2]=X+oe+le,M},Qt.rotateX=function(M,P,O,B){var G=[],q=[];return G[0]=P[0]-O[0],G[1]=P[1]-O[1],G[2]=P[2]-O[2],q[0]=G[0],q[1]=G[1]*Math.cos(B)-G[2]*Math.sin(B),q[2]=G[1]*Math.sin(B)+G[2]*Math.cos(B),M[0]=q[0]+O[0],M[1]=q[1]+O[1],M[2]=q[2]+O[2],M},Qt.rotateY=function(M,P,O,B){var G=[],q=[];return G[0]=P[0]-O[0],G[1]=P[1]-O[1],G[2]=P[2]-O[2],q[0]=G[2]*Math.sin(B)+G[0]*Math.cos(B),q[1]=G[1],q[2]=G[2]*Math.cos(B)-G[0]*Math.sin(B),M[0]=q[0]+O[0],M[1]=q[1]+O[1],M[2]=q[2]+O[2],M},Qt.rotateZ=function(M,P,O,B){var G=[],q=[];return G[0]=P[0]-O[0],G[1]=P[1]-O[1],G[2]=P[2]-O[2],q[0]=G[0]*Math.cos(B)-G[1]*Math.sin(B),q[1]=G[0]*Math.sin(B)+G[1]*Math.cos(B),q[2]=G[2],M[0]=q[0]+O[0],M[1]=q[1]+O[1],M[2]=q[2]+O[2],M},Qt.angle=function(M,P){var O=M[0],B=M[1],G=M[2],q=P[0],U=P[1],W=P[2],X=Math.sqrt(O*O+B*B+G*G)*Math.sqrt(q*q+U*U+W*W),ee=X&&S(M,P)/X;return Math.acos(Math.min(Math.max(ee,-1),1))},Qt.zero=function(M){return M[0]=0,M[1]=0,M[2]=0,M},Qt.str=function(M){return"vec3("+M[0]+", "+M[1]+", "+M[2]+")"},Qt.exactEquals=function(M,P){return M[0]===P[0]&&M[1]===P[1]&&M[2]===P[2]},Qt.equals=function(M,P){var O=M[0],B=M[1],G=M[2],q=P[0],U=P[1],W=P[2];return Math.abs(O-q)<=e.EPSILON*Math.max(1,Math.abs(O),Math.abs(q))&&Math.abs(B-U)<=e.EPSILON*Math.max(1,Math.abs(B),Math.abs(U))&&Math.abs(G-W)<=e.EPSILON*Math.max(1,Math.abs(G),Math.abs(W))},Qt.forEach=Qt.sqrLen=Qt.len=Qt.sqrDist=Qt.dist=Qt.div=Qt.mul=Qt.sub=void 0;var e=function(M){if(M&&M.__esModule)return M;if(null===M||"object"!==r(M)&&"function"!=typeof M)return{default:M};var O=i(void 0);if(O&&O.has(M))return O.get(M);var B={},G=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var q in M)if("default"!==q&&Object.prototype.hasOwnProperty.call(M,q)){var U=G?Object.getOwnPropertyDescriptor(M,q):null;U&&(U.get||U.set)?Object.defineProperty(B,q,U):B[q]=M[q]}return B.default=M,O&&O.set(M,B),B}(Xn());function i(M){if("function"!=typeof WeakMap)return null;var P=new WeakMap,O=new WeakMap;return(i=function(B){return B?O:P})(M)}function s(){var M=new e.ARRAY_TYPE(3);return e.ARRAY_TYPE!=Float32Array&&(M[0]=0,M[1]=0,M[2]=0),M}function h(M){return Math.hypot(M[0],M[1],M[2])}function a(M,P,O){return M[0]=P[0]-O[0],M[1]=P[1]-O[1],M[2]=P[2]-O[2],M}function u(M,P,O){return M[0]=P[0]*O[0],M[1]=P[1]*O[1],M[2]=P[2]*O[2],M}function x(M,P,O){return M[0]=P[0]/O[0],M[1]=P[1]/O[1],M[2]=P[2]/O[2],M}function T(M,P){return Math.hypot(P[0]-M[0],P[1]-M[1],P[2]-M[2])}function C(M,P){var O=P[0]-M[0],B=P[1]-M[1],G=P[2]-M[2];return O*O+B*B+G*G}function g(M){var P=M[0],O=M[1],B=M[2];return P*P+O*O+B*B}function S(M,P){return M[0]*P[0]+M[1]*P[1]+M[2]*P[2]}Qt.sub=a,Qt.mul=u,Qt.div=x,Qt.dist=T,Qt.sqrDist=C,Qt.len=h,Qt.sqrLen=g;var A,w=(A=s(),function(M,P,O,B,G,q){var U,W;for(P||(P=3),O||(O=0),W=B?Math.min(B*P+O,M.length):M.length,U=O;U<W;U+=P)A[0]=M[U],A[1]=M[U+1],A[2]=M[U+2],G(A,A,q),M[U]=A[0],M[U+1]=A[1],M[U+2]=A[2];return M});return Qt.forEach=w,Qt}var Zo,_c,oi={};function Mr(){if(Zo)return oi;function r(w){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(M){return typeof M}:function(M){return M&&"function"==typeof Symbol&&M.constructor===Symbol&&M!==Symbol.prototype?"symbol":typeof M})(w)}Zo=1,Object.defineProperty(oi,"__esModule",{value:!0}),oi.create=s,oi.clone=function(w){var M=new e.ARRAY_TYPE(4);return M[0]=w[0],M[1]=w[1],M[2]=w[2],M[3]=w[3],M},oi.fromValues=function(w,M,P,O){var B=new e.ARRAY_TYPE(4);return B[0]=w,B[1]=M,B[2]=P,B[3]=O,B},oi.copy=function(w,M){return w[0]=M[0],w[1]=M[1],w[2]=M[2],w[3]=M[3],w},oi.set=function(w,M,P,O,B){return w[0]=M,w[1]=P,w[2]=O,w[3]=B,w},oi.add=function(w,M,P){return w[0]=M[0]+P[0],w[1]=M[1]+P[1],w[2]=M[2]+P[2],w[3]=M[3]+P[3],w},oi.subtract=h,oi.multiply=a,oi.divide=u,oi.ceil=function(w,M){return w[0]=Math.ceil(M[0]),w[1]=Math.ceil(M[1]),w[2]=Math.ceil(M[2]),w[3]=Math.ceil(M[3]),w},oi.floor=function(w,M){return w[0]=Math.floor(M[0]),w[1]=Math.floor(M[1]),w[2]=Math.floor(M[2]),w[3]=Math.floor(M[3]),w},oi.min=function(w,M,P){return w[0]=Math.min(M[0],P[0]),w[1]=Math.min(M[1],P[1]),w[2]=Math.min(M[2],P[2]),w[3]=Math.min(M[3],P[3]),w},oi.max=function(w,M,P){return w[0]=Math.max(M[0],P[0]),w[1]=Math.max(M[1],P[1]),w[2]=Math.max(M[2],P[2]),w[3]=Math.max(M[3],P[3]),w},oi.round=function(w,M){return w[0]=Math.round(M[0]),w[1]=Math.round(M[1]),w[2]=Math.round(M[2]),w[3]=Math.round(M[3]),w},oi.scale=function(w,M,P){return w[0]=M[0]*P,w[1]=M[1]*P,w[2]=M[2]*P,w[3]=M[3]*P,w},oi.scaleAndAdd=function(w,M,P,O){return w[0]=M[0]+P[0]*O,w[1]=M[1]+P[1]*O,w[2]=M[2]+P[2]*O,w[3]=M[3]+P[3]*O,w},oi.distance=x,oi.squaredDistance=T,oi.length=C,oi.squaredLength=g,oi.negate=function(w,M){return w[0]=-M[0],w[1]=-M[1],w[2]=-M[2],w[3]=-M[3],w},oi.inverse=function(w,M){return w[0]=1/M[0],w[1]=1/M[1],w[2]=1/M[2],w[3]=1/M[3],w},oi.normalize=function(w,M){var P=M[0],O=M[1],B=M[2],G=M[3],q=P*P+O*O+B*B+G*G;return q>0&&(q=1/Math.sqrt(q)),w[0]=P*q,w[1]=O*q,w[2]=B*q,w[3]=G*q,w},oi.dot=function(w,M){return w[0]*M[0]+w[1]*M[1]+w[2]*M[2]+w[3]*M[3]},oi.cross=function(w,M,P,O){var B=P[0]*O[1]-P[1]*O[0],G=P[0]*O[2]-P[2]*O[0],q=P[0]*O[3]-P[3]*O[0],U=P[1]*O[2]-P[2]*O[1],W=P[1]*O[3]-P[3]*O[1],X=P[2]*O[3]-P[3]*O[2],ee=M[0],ae=M[1],oe=M[2],se=M[3];return w[0]=ae*X-oe*W+se*U,w[1]=-ee*X+oe*q-se*G,w[2]=ee*W-ae*q+se*B,w[3]=-ee*U+ae*G-oe*B,w},oi.lerp=function(w,M,P,O){var B=M[0],G=M[1],q=M[2],U=M[3];return w[0]=B+O*(P[0]-B),w[1]=G+O*(P[1]-G),w[2]=q+O*(P[2]-q),w[3]=U+O*(P[3]-U),w},oi.random=function(w,M){var P,O,B,G,q,U;M=M||1;do{q=(P=2*e.RANDOM()-1)*P+(O=2*e.RANDOM()-1)*O}while(q>=1);do{U=(B=2*e.RANDOM()-1)*B+(G=2*e.RANDOM()-1)*G}while(U>=1);var W=Math.sqrt((1-q)/U);return w[0]=M*P,w[1]=M*O,w[2]=M*B*W,w[3]=M*G*W,w},oi.transformMat4=function(w,M,P){var O=M[0],B=M[1],G=M[2],q=M[3];return w[0]=P[0]*O+P[4]*B+P[8]*G+P[12]*q,w[1]=P[1]*O+P[5]*B+P[9]*G+P[13]*q,w[2]=P[2]*O+P[6]*B+P[10]*G+P[14]*q,w[3]=P[3]*O+P[7]*B+P[11]*G+P[15]*q,w},oi.transformQuat=function(w,M,P){var O=M[0],B=M[1],G=M[2],q=P[0],U=P[1],W=P[2],X=P[3],ee=X*O+U*G-W*B,ae=X*B+W*O-q*G,oe=X*G+q*B-U*O,se=-q*O-U*B-W*G;return w[0]=ee*X+se*-q+ae*-W-oe*-U,w[1]=ae*X+se*-U+oe*-q-ee*-W,w[2]=oe*X+se*-W+ee*-U-ae*-q,w[3]=M[3],w},oi.zero=function(w){return w[0]=0,w[1]=0,w[2]=0,w[3]=0,w},oi.str=function(w){return"vec4("+w[0]+", "+w[1]+", "+w[2]+", "+w[3]+")"},oi.exactEquals=function(w,M){return w[0]===M[0]&&w[1]===M[1]&&w[2]===M[2]&&w[3]===M[3]},oi.equals=function(w,M){var P=w[0],O=w[1],B=w[2],G=w[3],q=M[0],U=M[1],W=M[2],X=M[3];return Math.abs(P-q)<=e.EPSILON*Math.max(1,Math.abs(P),Math.abs(q))&&Math.abs(O-U)<=e.EPSILON*Math.max(1,Math.abs(O),Math.abs(U))&&Math.abs(B-W)<=e.EPSILON*Math.max(1,Math.abs(B),Math.abs(W))&&Math.abs(G-X)<=e.EPSILON*Math.max(1,Math.abs(G),Math.abs(X))},oi.forEach=oi.sqrLen=oi.len=oi.sqrDist=oi.dist=oi.div=oi.mul=oi.sub=void 0;var e=function(w){if(w&&w.__esModule)return w;if(null===w||"object"!==r(w)&&"function"!=typeof w)return{default:w};var P=i(void 0);if(P&&P.has(w))return P.get(w);var O={},B=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var G in w)if("default"!==G&&Object.prototype.hasOwnProperty.call(w,G)){var q=B?Object.getOwnPropertyDescriptor(w,G):null;q&&(q.get||q.set)?Object.defineProperty(O,G,q):O[G]=w[G]}return O.default=w,P&&P.set(w,O),O}(Xn());function i(w){if("function"!=typeof WeakMap)return null;var M=new WeakMap,P=new WeakMap;return(i=function(O){return O?P:M})(w)}function s(){var w=new e.ARRAY_TYPE(4);return e.ARRAY_TYPE!=Float32Array&&(w[0]=0,w[1]=0,w[2]=0,w[3]=0),w}function h(w,M,P){return w[0]=M[0]-P[0],w[1]=M[1]-P[1],w[2]=M[2]-P[2],w[3]=M[3]-P[3],w}function a(w,M,P){return w[0]=M[0]*P[0],w[1]=M[1]*P[1],w[2]=M[2]*P[2],w[3]=M[3]*P[3],w}function u(w,M,P){return w[0]=M[0]/P[0],w[1]=M[1]/P[1],w[2]=M[2]/P[2],w[3]=M[3]/P[3],w}function x(w,M){return Math.hypot(M[0]-w[0],M[1]-w[1],M[2]-w[2],M[3]-w[3])}function T(w,M){var P=M[0]-w[0],O=M[1]-w[1],B=M[2]-w[2],G=M[3]-w[3];return P*P+O*O+B*B+G*G}function C(w){return Math.hypot(w[0],w[1],w[2],w[3])}function g(w){var M=w[0],P=w[1],O=w[2],B=w[3];return M*M+P*P+O*O+B*B}oi.sub=h,oi.mul=a,oi.div=u,oi.dist=x,oi.sqrDist=T,oi.len=C,oi.sqrLen=g;var S,A=(S=s(),function(w,M,P,O,B,G){var q,U;for(M||(M=4),P||(P=0),U=O?Math.min(O*M+P,w.length):w.length,q=P;q<U;q+=M)S[0]=w[q],S[1]=w[q+1],S[2]=w[q+2],S[3]=w[q+3],B(S,S,G),w[q]=S[0],w[q+1]=S[1],w[q+2]=S[2],w[q+3]=S[3];return w});return oi.forEach=A,oi}function ds(){if(_c)return Yt;function r(le){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(ve){return typeof ve}:function(ve){return ve&&"function"==typeof Symbol&&ve.constructor===Symbol&&ve!==Symbol.prototype?"symbol":typeof ve})(le)}_c=1,Object.defineProperty(Yt,"__esModule",{value:!0}),Yt.create=x,Yt.identity=function(le){return le[0]=0,le[1]=0,le[2]=0,le[3]=1,le},Yt.setAxisAngle=T,Yt.getAxisAngle=function(le,ve){var Se=2*Math.acos(ve[3]),we=Math.sin(Se/2);return we>e.EPSILON?(le[0]=ve[0]/we,le[1]=ve[1]/we,le[2]=ve[2]/we):(le[0]=1,le[1]=0,le[2]=0),Se},Yt.getAngle=function(le,ve){var Se=P(le,ve);return Math.acos(2*Se*Se-1)},Yt.multiply=C,Yt.rotateX=function(le,ve,Se){Se*=.5;var we=ve[0],Ae=ve[1],Pe=ve[2],ke=ve[3],Ce=Math.sin(Se),Ze=Math.cos(Se);return le[0]=we*Ze+ke*Ce,le[1]=Ae*Ze+Pe*Ce,le[2]=Pe*Ze-Ae*Ce,le[3]=ke*Ze-we*Ce,le},Yt.rotateY=function(le,ve,Se){Se*=.5;var we=ve[0],Ae=ve[1],Pe=ve[2],ke=ve[3],Ce=Math.sin(Se),Ze=Math.cos(Se);return le[0]=we*Ze-Pe*Ce,le[1]=Ae*Ze+ke*Ce,le[2]=Pe*Ze+we*Ce,le[3]=ke*Ze-Ae*Ce,le},Yt.rotateZ=function(le,ve,Se){Se*=.5;var we=ve[0],Ae=ve[1],Pe=ve[2],ke=ve[3],Ce=Math.sin(Se),Ze=Math.cos(Se);return le[0]=we*Ze+Ae*Ce,le[1]=Ae*Ze-we*Ce,le[2]=Pe*Ze+ke*Ce,le[3]=ke*Ze-Pe*Ce,le},Yt.calculateW=function(le,ve){var Se=ve[0],we=ve[1],Ae=ve[2];return le[0]=Se,le[1]=we,le[2]=Ae,le[3]=Math.sqrt(Math.abs(1-Se*Se-we*we-Ae*Ae)),le},Yt.exp=g,Yt.ln=S,Yt.pow=function(le,ve,Se){return S(le,ve),M(le,le,Se),g(le,le),le},Yt.slerp=A,Yt.random=function(le){var ve=e.RANDOM(),Se=e.RANDOM(),we=e.RANDOM(),Ae=Math.sqrt(1-ve),Pe=Math.sqrt(ve);return le[0]=Ae*Math.sin(2*Math.PI*Se),le[1]=Ae*Math.cos(2*Math.PI*Se),le[2]=Pe*Math.sin(2*Math.PI*we),le[3]=Pe*Math.cos(2*Math.PI*we),le},Yt.invert=function(le,ve){var Se=ve[0],we=ve[1],Ae=ve[2],Pe=ve[3],ke=Se*Se+we*we+Ae*Ae+Pe*Pe,Ce=ke?1/ke:0;return le[0]=-Se*Ce,le[1]=-we*Ce,le[2]=-Ae*Ce,le[3]=Pe*Ce,le},Yt.conjugate=function(le,ve){return le[0]=-ve[0],le[1]=-ve[1],le[2]=-ve[2],le[3]=ve[3],le},Yt.fromMat3=w,Yt.fromEuler=function(le,ve,Se,we){var Ae=.5*Math.PI/180;ve*=Ae,Se*=Ae,we*=Ae;var Pe=Math.sin(ve),ke=Math.cos(ve),Ce=Math.sin(Se),Ze=Math.cos(Se),tt=Math.sin(we),$e=Math.cos(we);return le[0]=Pe*Ze*$e-ke*Ce*tt,le[1]=ke*Ce*$e+Pe*Ze*tt,le[2]=ke*Ze*tt-Pe*Ce*$e,le[3]=ke*Ze*$e+Pe*Ce*tt,le},Yt.str=function(le){return"quat("+le[0]+", "+le[1]+", "+le[2]+", "+le[3]+")"},Yt.setAxes=Yt.sqlerp=Yt.rotationTo=Yt.equals=Yt.exactEquals=Yt.normalize=Yt.sqrLen=Yt.squaredLength=Yt.len=Yt.length=Yt.lerp=Yt.dot=Yt.scale=Yt.mul=Yt.add=Yt.set=Yt.copy=Yt.fromValues=Yt.clone=void 0;var e=u(Xn()),i=u($o()),s=u(za()),h=u(Mr());function a(le){if("function"!=typeof WeakMap)return null;var ve=new WeakMap,Se=new WeakMap;return(a=function(we){return we?Se:ve})(le)}function u(le,ve){if(le&&le.__esModule)return le;if(null===le||"object"!==r(le)&&"function"!=typeof le)return{default:le};var Se=a(ve);if(Se&&Se.has(le))return Se.get(le);var we={},Ae=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var Pe in le)if("default"!==Pe&&Object.prototype.hasOwnProperty.call(le,Pe)){var ke=Ae?Object.getOwnPropertyDescriptor(le,Pe):null;ke&&(ke.get||ke.set)?Object.defineProperty(we,Pe,ke):we[Pe]=le[Pe]}return we.default=le,Se&&Se.set(le,we),we}function x(){var le=new e.ARRAY_TYPE(4);return e.ARRAY_TYPE!=Float32Array&&(le[0]=0,le[1]=0,le[2]=0),le[3]=1,le}function T(le,ve,Se){Se*=.5;var we=Math.sin(Se);return le[0]=we*ve[0],le[1]=we*ve[1],le[2]=we*ve[2],le[3]=Math.cos(Se),le}function C(le,ve,Se){var we=ve[0],Ae=ve[1],Pe=ve[2],ke=ve[3],Ce=Se[0],Ze=Se[1],tt=Se[2],$e=Se[3];return le[0]=we*$e+ke*Ce+Ae*tt-Pe*Ze,le[1]=Ae*$e+ke*Ze+Pe*Ce-we*tt,le[2]=Pe*$e+ke*tt+we*Ze-Ae*Ce,le[3]=ke*$e-we*Ce-Ae*Ze-Pe*tt,le}function g(le,ve){var Se=ve[0],we=ve[1],Ae=ve[2],Pe=ve[3],ke=Math.sqrt(Se*Se+we*we+Ae*Ae),Ce=Math.exp(Pe),Ze=ke>0?Ce*Math.sin(ke)/ke:0;return le[0]=Se*Ze,le[1]=we*Ze,le[2]=Ae*Ze,le[3]=Ce*Math.cos(ke),le}function S(le,ve){var Se=ve[0],we=ve[1],Ae=ve[2],Pe=ve[3],ke=Math.sqrt(Se*Se+we*we+Ae*Ae),Ce=ke>0?Math.atan2(ke,Pe)/ke:0;return le[0]=Se*Ce,le[1]=we*Ce,le[2]=Ae*Ce,le[3]=.5*Math.log(Se*Se+we*we+Ae*Ae+Pe*Pe),le}function A(le,ve,Se,we){var Ae,Pe,ke,Ce,Ze,tt=ve[0],$e=ve[1],gt=ve[2],mt=ve[3],st=Se[0],nt=Se[1],It=Se[2],yt=Se[3];return(Pe=tt*st+$e*nt+gt*It+mt*yt)<0&&(Pe=-Pe,st=-st,nt=-nt,It=-It,yt=-yt),1-Pe>e.EPSILON?(Ae=Math.acos(Pe),ke=Math.sin(Ae),Ce=Math.sin((1-we)*Ae)/ke,Ze=Math.sin(we*Ae)/ke):(Ce=1-we,Ze=we),le[0]=Ce*tt+Ze*st,le[1]=Ce*$e+Ze*nt,le[2]=Ce*gt+Ze*It,le[3]=Ce*mt+Ze*yt,le}function w(le,ve){var Se,we=ve[0]+ve[4]+ve[8];if(we>0)Se=Math.sqrt(we+1),le[3]=.5*Se,le[0]=(ve[5]-ve[7])*(Se=.5/Se),le[1]=(ve[6]-ve[2])*Se,le[2]=(ve[1]-ve[3])*Se;else{var Ae=0;ve[4]>ve[0]&&(Ae=1),ve[8]>ve[3*Ae+Ae]&&(Ae=2);var Pe=(Ae+1)%3,ke=(Ae+2)%3;Se=Math.sqrt(ve[3*Ae+Ae]-ve[3*Pe+Pe]-ve[3*ke+ke]+1),le[Ae]=.5*Se,le[3]=(ve[3*Pe+ke]-ve[3*ke+Pe])*(Se=.5/Se),le[Pe]=(ve[3*Pe+Ae]+ve[3*Ae+Pe])*Se,le[ke]=(ve[3*ke+Ae]+ve[3*Ae+ke])*Se}return le}Yt.clone=h.clone,Yt.fromValues=h.fromValues,Yt.copy=h.copy,Yt.set=h.set,Yt.add=h.add,Yt.mul=C;var M=h.scale;Yt.scale=M;var P=h.dot;Yt.dot=P,Yt.lerp=h.lerp;var O=h.length;Yt.length=O,Yt.len=O;var B=h.squaredLength;Yt.squaredLength=B,Yt.sqrLen=B;var G=h.normalize;Yt.normalize=G,Yt.exactEquals=h.exactEquals,Yt.equals=h.equals;var q,U,W,X=(q=s.create(),U=s.fromValues(1,0,0),W=s.fromValues(0,1,0),function(le,ve,Se){var we=s.dot(ve,Se);return we<-.999999?(s.cross(q,U,ve),s.len(q)<1e-6&&s.cross(q,W,ve),s.normalize(q,q),T(le,q,Math.PI),le):we>.999999?(le[0]=0,le[1]=0,le[2]=0,le[3]=1,le):(s.cross(q,ve,Se),le[0]=q[0],le[1]=q[1],le[2]=q[2],le[3]=1+we,G(le,le))});Yt.rotationTo=X;var ee,ae,oe=(ee=x(),ae=x(),function(le,ve,Se,we,Ae,Pe){return A(ee,ve,Ae,Pe),A(ae,Se,we,Pe),A(le,ee,ae,2*Pe*(1-Pe)),le});Yt.sqlerp=oe;var se,ye=(se=i.create(),function(le,ve,Se,we){return se[0]=Se[0],se[3]=Se[1],se[6]=Se[2],se[1]=we[0],se[4]=we[1],se[7]=we[2],se[2]=-ve[0],se[5]=-ve[1],se[8]=-ve[2],G(le,w(le,se))});return Yt.setAxes=ye,Yt}var po,ci={};var Ra,Hs,ti={};function mh(){if(Ra)return ti;function r(w){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(M){return typeof M}:function(M){return M&&"function"==typeof Symbol&&M.constructor===Symbol&&M!==Symbol.prototype?"symbol":typeof M})(w)}Ra=1,Object.defineProperty(ti,"__esModule",{value:!0}),ti.create=s,ti.clone=function(w){var M=new e.ARRAY_TYPE(2);return M[0]=w[0],M[1]=w[1],M},ti.fromValues=function(w,M){var P=new e.ARRAY_TYPE(2);return P[0]=w,P[1]=M,P},ti.copy=function(w,M){return w[0]=M[0],w[1]=M[1],w},ti.set=function(w,M,P){return w[0]=M,w[1]=P,w},ti.add=function(w,M,P){return w[0]=M[0]+P[0],w[1]=M[1]+P[1],w},ti.subtract=h,ti.multiply=a,ti.divide=u,ti.ceil=function(w,M){return w[0]=Math.ceil(M[0]),w[1]=Math.ceil(M[1]),w},ti.floor=function(w,M){return w[0]=Math.floor(M[0]),w[1]=Math.floor(M[1]),w},ti.min=function(w,M,P){return w[0]=Math.min(M[0],P[0]),w[1]=Math.min(M[1],P[1]),w},ti.max=function(w,M,P){return w[0]=Math.max(M[0],P[0]),w[1]=Math.max(M[1],P[1]),w},ti.round=function(w,M){return w[0]=Math.round(M[0]),w[1]=Math.round(M[1]),w},ti.scale=function(w,M,P){return w[0]=M[0]*P,w[1]=M[1]*P,w},ti.scaleAndAdd=function(w,M,P,O){return w[0]=M[0]+P[0]*O,w[1]=M[1]+P[1]*O,w},ti.distance=x,ti.squaredDistance=T,ti.length=C,ti.squaredLength=g,ti.negate=function(w,M){return w[0]=-M[0],w[1]=-M[1],w},ti.inverse=function(w,M){return w[0]=1/M[0],w[1]=1/M[1],w},ti.normalize=function(w,M){var P=M[0],O=M[1],B=P*P+O*O;return B>0&&(B=1/Math.sqrt(B)),w[0]=M[0]*B,w[1]=M[1]*B,w},ti.dot=function(w,M){return w[0]*M[0]+w[1]*M[1]},ti.cross=function(w,M,P){var O=M[0]*P[1]-M[1]*P[0];return w[0]=w[1]=0,w[2]=O,w},ti.lerp=function(w,M,P,O){var B=M[0],G=M[1];return w[0]=B+O*(P[0]-B),w[1]=G+O*(P[1]-G),w},ti.random=function(w,M){M=M||1;var P=2*e.RANDOM()*Math.PI;return w[0]=Math.cos(P)*M,w[1]=Math.sin(P)*M,w},ti.transformMat2=function(w,M,P){var O=M[0],B=M[1];return w[0]=P[0]*O+P[2]*B,w[1]=P[1]*O+P[3]*B,w},ti.transformMat2d=function(w,M,P){var O=M[0],B=M[1];return w[0]=P[0]*O+P[2]*B+P[4],w[1]=P[1]*O+P[3]*B+P[5],w},ti.transformMat3=function(w,M,P){var O=M[0],B=M[1];return w[0]=P[0]*O+P[3]*B+P[6],w[1]=P[1]*O+P[4]*B+P[7],w},ti.transformMat4=function(w,M,P){var O=M[0],B=M[1];return w[0]=P[0]*O+P[4]*B+P[12],w[1]=P[1]*O+P[5]*B+P[13],w},ti.rotate=function(w,M,P,O){var B=M[0]-P[0],G=M[1]-P[1],q=Math.sin(O),U=Math.cos(O);return w[0]=B*U-G*q+P[0],w[1]=B*q+G*U+P[1],w},ti.angle=function(w,M){var P=w[0],O=w[1],B=M[0],G=M[1],q=Math.sqrt(P*P+O*O)*Math.sqrt(B*B+G*G);return Math.acos(Math.min(Math.max(q&&(P*B+O*G)/q,-1),1))},ti.zero=function(w){return w[0]=0,w[1]=0,w},ti.str=function(w){return"vec2("+w[0]+", "+w[1]+")"},ti.exactEquals=function(w,M){return w[0]===M[0]&&w[1]===M[1]},ti.equals=function(w,M){var P=w[0],O=w[1],B=M[0],G=M[1];return Math.abs(P-B)<=e.EPSILON*Math.max(1,Math.abs(P),Math.abs(B))&&Math.abs(O-G)<=e.EPSILON*Math.max(1,Math.abs(O),Math.abs(G))},ti.forEach=ti.sqrLen=ti.sqrDist=ti.dist=ti.div=ti.mul=ti.sub=ti.len=void 0;var e=function(w){if(w&&w.__esModule)return w;if(null===w||"object"!==r(w)&&"function"!=typeof w)return{default:w};var P=i(void 0);if(P&&P.has(w))return P.get(w);var O={},B=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var G in w)if("default"!==G&&Object.prototype.hasOwnProperty.call(w,G)){var q=B?Object.getOwnPropertyDescriptor(w,G):null;q&&(q.get||q.set)?Object.defineProperty(O,G,q):O[G]=w[G]}return O.default=w,P&&P.set(w,O),O}(Xn());function i(w){if("function"!=typeof WeakMap)return null;var M=new WeakMap,P=new WeakMap;return(i=function(O){return O?P:M})(w)}function s(){var w=new e.ARRAY_TYPE(2);return e.ARRAY_TYPE!=Float32Array&&(w[0]=0,w[1]=0),w}function h(w,M,P){return w[0]=M[0]-P[0],w[1]=M[1]-P[1],w}function a(w,M,P){return w[0]=M[0]*P[0],w[1]=M[1]*P[1],w}function u(w,M,P){return w[0]=M[0]/P[0],w[1]=M[1]/P[1],w}function x(w,M){return Math.hypot(M[0]-w[0],M[1]-w[1])}function T(w,M){var P=M[0]-w[0],O=M[1]-w[1];return P*P+O*O}function C(w){return Math.hypot(w[0],w[1])}function g(w){var M=w[0],P=w[1];return M*M+P*P}ti.len=C,ti.sub=h,ti.mul=a,ti.div=u,ti.dist=x,ti.sqrDist=T,ti.sqrLen=g;var S,A=(S=s(),function(w,M,P,O,B,G){var q,U;for(M||(M=2),P||(P=0),U=O?Math.min(O*M+P,w.length):w.length,q=P;q<U;q+=M)S[0]=w[q],S[1]=w[q+1],B(S,S,G),w[q]=S[0],w[q+1]=S[1];return w});return ti.forEach=A,ti}var Xo,Yo,Es,Ws,Ie=function La(){if(Hs)return Qi;function r(w){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(M){return typeof M}:function(M){return M&&"function"==typeof Symbol&&M.constructor===Symbol&&M!==Symbol.prototype?"symbol":typeof M})(w)}Hs=1,Object.defineProperty(Qi,"__esModule",{value:!0}),Qi.vec4=Qi.vec3=Qi.vec2=Qi.quat2=Qi.quat=Qi.mat4=Qi.mat3=Qi.mat2d=Qi.mat2=Qi.glMatrix=void 0;var e=A(Xn());Qi.glMatrix=e;var i=A(qi());Qi.mat2=i;var s=A(uo());Qi.mat2d=s;var h=A($o());Qi.mat3=h;var a=A(Ms());Qi.mat4=a;var u=A(ds());Qi.quat=u;var x=A(function qs(){if(po)return ci;function r(A){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(w){return typeof w}:function(w){return w&&"function"==typeof Symbol&&w.constructor===Symbol&&w!==Symbol.prototype?"symbol":typeof w})(A)}po=1,Object.defineProperty(ci,"__esModule",{value:!0}),ci.create=function(){var A=new e.ARRAY_TYPE(8);return e.ARRAY_TYPE!=Float32Array&&(A[0]=0,A[1]=0,A[2]=0,A[4]=0,A[5]=0,A[6]=0,A[7]=0),A[3]=1,A},ci.clone=function(A){var w=new e.ARRAY_TYPE(8);return w[0]=A[0],w[1]=A[1],w[2]=A[2],w[3]=A[3],w[4]=A[4],w[5]=A[5],w[6]=A[6],w[7]=A[7],w},ci.fromValues=function(A,w,M,P,O,B,G,q){var U=new e.ARRAY_TYPE(8);return U[0]=A,U[1]=w,U[2]=M,U[3]=P,U[4]=O,U[5]=B,U[6]=G,U[7]=q,U},ci.fromRotationTranslationValues=function(A,w,M,P,O,B,G){var q=new e.ARRAY_TYPE(8);q[0]=A,q[1]=w,q[2]=M,q[3]=P;var U=.5*O,W=.5*B,X=.5*G;return q[4]=U*P+W*M-X*w,q[5]=W*P+X*A-U*M,q[6]=X*P+U*w-W*A,q[7]=-U*A-W*w-X*M,q},ci.fromRotationTranslation=u,ci.fromTranslation=function(A,w){return A[0]=0,A[1]=0,A[2]=0,A[3]=1,A[4]=.5*w[0],A[5]=.5*w[1],A[6]=.5*w[2],A[7]=0,A},ci.fromRotation=function(A,w){return A[0]=w[0],A[1]=w[1],A[2]=w[2],A[3]=w[3],A[4]=0,A[5]=0,A[6]=0,A[7]=0,A},ci.fromMat4=function(A,w){var M=i.create();s.getRotation(M,w);var P=new e.ARRAY_TYPE(3);return s.getTranslation(P,w),u(A,M,P),A},ci.copy=x,ci.identity=function(A){return A[0]=0,A[1]=0,A[2]=0,A[3]=1,A[4]=0,A[5]=0,A[6]=0,A[7]=0,A},ci.set=function(A,w,M,P,O,B,G,q,U){return A[0]=w,A[1]=M,A[2]=P,A[3]=O,A[4]=B,A[5]=G,A[6]=q,A[7]=U,A},ci.getDual=function(A,w){return A[0]=w[4],A[1]=w[5],A[2]=w[6],A[3]=w[7],A},ci.setDual=function(A,w){return A[4]=w[0],A[5]=w[1],A[6]=w[2],A[7]=w[3],A},ci.getTranslation=function(A,w){var M=w[4],P=w[5],O=w[6],B=w[7],G=-w[0],q=-w[1],U=-w[2],W=w[3];return A[0]=2*(M*W+B*G+P*U-O*q),A[1]=2*(P*W+B*q+O*G-M*U),A[2]=2*(O*W+B*U+M*q-P*G),A},ci.translate=function(A,w,M){var P=w[0],O=w[1],B=w[2],G=w[3],q=.5*M[0],U=.5*M[1],W=.5*M[2],X=w[4],ee=w[5],ae=w[6],oe=w[7];return A[0]=P,A[1]=O,A[2]=B,A[3]=G,A[4]=G*q+O*W-B*U+X,A[5]=G*U+B*q-P*W+ee,A[6]=G*W+P*U-O*q+ae,A[7]=-P*q-O*U-B*W+oe,A},ci.rotateX=function(A,w,M){var P=-w[0],O=-w[1],B=-w[2],G=w[3],q=w[4],U=w[5],W=w[6],X=w[7],ee=q*G+X*P+U*B-W*O,ae=U*G+X*O+W*P-q*B,oe=W*G+X*B+q*O-U*P,se=X*G-q*P-U*O-W*B;return i.rotateX(A,w,M),A[4]=ee*(G=A[3])+se*(P=A[0])+ae*(B=A[2])-oe*(O=A[1]),A[5]=ae*G+se*O+oe*P-ee*B,A[6]=oe*G+se*B+ee*O-ae*P,A[7]=se*G-ee*P-ae*O-oe*B,A},ci.rotateY=function(A,w,M){var P=-w[0],O=-w[1],B=-w[2],G=w[3],q=w[4],U=w[5],W=w[6],X=w[7],ee=q*G+X*P+U*B-W*O,ae=U*G+X*O+W*P-q*B,oe=W*G+X*B+q*O-U*P,se=X*G-q*P-U*O-W*B;return i.rotateY(A,w,M),A[4]=ee*(G=A[3])+se*(P=A[0])+ae*(B=A[2])-oe*(O=A[1]),A[5]=ae*G+se*O+oe*P-ee*B,A[6]=oe*G+se*B+ee*O-ae*P,A[7]=se*G-ee*P-ae*O-oe*B,A},ci.rotateZ=function(A,w,M){var P=-w[0],O=-w[1],B=-w[2],G=w[3],q=w[4],U=w[5],W=w[6],X=w[7],ee=q*G+X*P+U*B-W*O,ae=U*G+X*O+W*P-q*B,oe=W*G+X*B+q*O-U*P,se=X*G-q*P-U*O-W*B;return i.rotateZ(A,w,M),A[4]=ee*(G=A[3])+se*(P=A[0])+ae*(B=A[2])-oe*(O=A[1]),A[5]=ae*G+se*O+oe*P-ee*B,A[6]=oe*G+se*B+ee*O-ae*P,A[7]=se*G-ee*P-ae*O-oe*B,A},ci.rotateByQuatAppend=function(A,w,M){var P=M[0],O=M[1],B=M[2],G=M[3],q=w[0],U=w[1],W=w[2],X=w[3];return A[0]=q*G+X*P+U*B-W*O,A[1]=U*G+X*O+W*P-q*B,A[2]=W*G+X*B+q*O-U*P,A[3]=X*G-q*P-U*O-W*B,A[4]=(q=w[4])*G+(X=w[7])*P+(U=w[5])*B-(W=w[6])*O,A[5]=U*G+X*O+W*P-q*B,A[6]=W*G+X*B+q*O-U*P,A[7]=X*G-q*P-U*O-W*B,A},ci.rotateByQuatPrepend=function(A,w,M){var P=w[0],O=w[1],B=w[2],G=w[3],q=M[0],U=M[1],W=M[2],X=M[3];return A[0]=P*X+G*q+O*W-B*U,A[1]=O*X+G*U+B*q-P*W,A[2]=B*X+G*W+P*U-O*q,A[3]=G*X-P*q-O*U-B*W,A[4]=P*(X=M[7])+G*(q=M[4])+O*(W=M[6])-B*(U=M[5]),A[5]=O*X+G*U+B*q-P*W,A[6]=B*X+G*W+P*U-O*q,A[7]=G*X-P*q-O*U-B*W,A},ci.rotateAroundAxis=function(A,w,M,P){if(Math.abs(P)<e.EPSILON)return x(A,w);var O=Math.hypot(M[0],M[1],M[2]);P*=.5;var B=Math.sin(P),G=B*M[0]/O,q=B*M[1]/O,U=B*M[2]/O,W=Math.cos(P),X=w[0],ee=w[1],ae=w[2],oe=w[3];A[0]=X*W+oe*G+ee*U-ae*q,A[1]=ee*W+oe*q+ae*G-X*U,A[2]=ae*W+oe*U+X*q-ee*G,A[3]=oe*W-X*G-ee*q-ae*U;var se=w[4],ye=w[5],le=w[6],ve=w[7];return A[4]=se*W+ve*G+ye*U-le*q,A[5]=ye*W+ve*q+le*G-se*U,A[6]=le*W+ve*U+se*q-ye*G,A[7]=ve*W-se*G-ye*q-le*U,A},ci.add=function(A,w,M){return A[0]=w[0]+M[0],A[1]=w[1]+M[1],A[2]=w[2]+M[2],A[3]=w[3]+M[3],A[4]=w[4]+M[4],A[5]=w[5]+M[5],A[6]=w[6]+M[6],A[7]=w[7]+M[7],A},ci.multiply=T,ci.scale=function(A,w,M){return A[0]=w[0]*M,A[1]=w[1]*M,A[2]=w[2]*M,A[3]=w[3]*M,A[4]=w[4]*M,A[5]=w[5]*M,A[6]=w[6]*M,A[7]=w[7]*M,A},ci.lerp=function(A,w,M,P){var O=1-P;return C(w,M)<0&&(P=-P),A[0]=w[0]*O+M[0]*P,A[1]=w[1]*O+M[1]*P,A[2]=w[2]*O+M[2]*P,A[3]=w[3]*O+M[3]*P,A[4]=w[4]*O+M[4]*P,A[5]=w[5]*O+M[5]*P,A[6]=w[6]*O+M[6]*P,A[7]=w[7]*O+M[7]*P,A},ci.invert=function(A,w){var M=S(w);return A[0]=-w[0]/M,A[1]=-w[1]/M,A[2]=-w[2]/M,A[3]=w[3]/M,A[4]=-w[4]/M,A[5]=-w[5]/M,A[6]=-w[6]/M,A[7]=w[7]/M,A},ci.conjugate=function(A,w){return A[0]=-w[0],A[1]=-w[1],A[2]=-w[2],A[3]=w[3],A[4]=-w[4],A[5]=-w[5],A[6]=-w[6],A[7]=w[7],A},ci.normalize=function(A,w){var M=S(w);if(M>0){M=Math.sqrt(M);var P=w[0]/M,O=w[1]/M,B=w[2]/M,G=w[3]/M,q=w[4],U=w[5],W=w[6],X=w[7],ee=P*q+O*U+B*W+G*X;A[0]=P,A[1]=O,A[2]=B,A[3]=G,A[4]=(q-P*ee)/M,A[5]=(U-O*ee)/M,A[6]=(W-B*ee)/M,A[7]=(X-G*ee)/M}return A},ci.str=function(A){return"quat2("+A[0]+", "+A[1]+", "+A[2]+", "+A[3]+", "+A[4]+", "+A[5]+", "+A[6]+", "+A[7]+")"},ci.exactEquals=function(A,w){return A[0]===w[0]&&A[1]===w[1]&&A[2]===w[2]&&A[3]===w[3]&&A[4]===w[4]&&A[5]===w[5]&&A[6]===w[6]&&A[7]===w[7]},ci.equals=function(A,w){var M=A[0],P=A[1],O=A[2],B=A[3],G=A[4],q=A[5],U=A[6],W=A[7],X=w[0],ee=w[1],ae=w[2],oe=w[3],se=w[4],ye=w[5],le=w[6],ve=w[7];return Math.abs(M-X)<=e.EPSILON*Math.max(1,Math.abs(M),Math.abs(X))&&Math.abs(P-ee)<=e.EPSILON*Math.max(1,Math.abs(P),Math.abs(ee))&&Math.abs(O-ae)<=e.EPSILON*Math.max(1,Math.abs(O),Math.abs(ae))&&Math.abs(B-oe)<=e.EPSILON*Math.max(1,Math.abs(B),Math.abs(oe))&&Math.abs(G-se)<=e.EPSILON*Math.max(1,Math.abs(G),Math.abs(se))&&Math.abs(q-ye)<=e.EPSILON*Math.max(1,Math.abs(q),Math.abs(ye))&&Math.abs(U-le)<=e.EPSILON*Math.max(1,Math.abs(U),Math.abs(le))&&Math.abs(W-ve)<=e.EPSILON*Math.max(1,Math.abs(W),Math.abs(ve))},ci.sqrLen=ci.squaredLength=ci.len=ci.length=ci.dot=ci.mul=ci.setReal=ci.getReal=void 0;var e=a(Xn()),i=a(ds()),s=a(Ms());function h(A){if("function"!=typeof WeakMap)return null;var w=new WeakMap,M=new WeakMap;return(h=function(P){return P?M:w})(A)}function a(A,w){if(A&&A.__esModule)return A;if(null===A||"object"!==r(A)&&"function"!=typeof A)return{default:A};var M=h(w);if(M&&M.has(A))return M.get(A);var P={},O=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var B in A)if("default"!==B&&Object.prototype.hasOwnProperty.call(A,B)){var G=O?Object.getOwnPropertyDescriptor(A,B):null;G&&(G.get||G.set)?Object.defineProperty(P,B,G):P[B]=A[B]}return P.default=A,M&&M.set(A,P),P}function u(A,w,M){var P=.5*M[0],O=.5*M[1],B=.5*M[2],G=w[0],q=w[1],U=w[2],W=w[3];return A[0]=G,A[1]=q,A[2]=U,A[3]=W,A[4]=P*W+O*U-B*q,A[5]=O*W+B*G-P*U,A[6]=B*W+P*q-O*G,A[7]=-P*G-O*q-B*U,A}function x(A,w){return A[0]=w[0],A[1]=w[1],A[2]=w[2],A[3]=w[3],A[4]=w[4],A[5]=w[5],A[6]=w[6],A[7]=w[7],A}function T(A,w,M){var P=w[0],O=w[1],B=w[2],G=w[3],q=M[4],U=M[5],W=M[6],X=M[7],ee=w[4],ae=w[5],oe=w[6],se=w[7],ye=M[0],le=M[1],ve=M[2],Se=M[3];return A[0]=P*Se+G*ye+O*ve-B*le,A[1]=O*Se+G*le+B*ye-P*ve,A[2]=B*Se+G*ve+P*le-O*ye,A[3]=G*Se-P*ye-O*le-B*ve,A[4]=P*X+G*q+O*W-B*U+ee*Se+se*ye+ae*ve-oe*le,A[5]=O*X+G*U+B*q-P*W+ae*Se+se*le+oe*ye-ee*ve,A[6]=B*X+G*W+P*U-O*q+oe*Se+se*ve+ee*le-ae*ye,A[7]=G*X-P*q-O*U-B*W+se*Se-ee*ye-ae*le-oe*ve,A}ci.getReal=i.copy,ci.setReal=i.copy,ci.mul=T;var C=i.dot;ci.dot=C;var g=i.length;ci.length=g,ci.len=g;var S=i.squaredLength;return ci.squaredLength=S,ci.sqrLen=S,ci}());Qi.quat2=x;var T=A(mh());Qi.vec2=T;var C=A(za());Qi.vec3=C;var g=A(Mr());function S(w){if("function"!=typeof WeakMap)return null;var M=new WeakMap,P=new WeakMap;return(S=function(O){return O?P:M})(w)}function A(w,M){if(w&&w.__esModule)return w;if(null===w||"object"!==r(w)&&"function"!=typeof w)return{default:w};var P=S(M);if(P&&P.has(w))return P.get(w);var O={},B=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var G in w)if("default"!==G&&Object.prototype.hasOwnProperty.call(w,G)){var q=B?Object.getOwnPropertyDescriptor(w,G):null;q&&(q.get||q.set)?Object.defineProperty(O,G,q):O[G]=w[G]}return O.default=w,P&&P.set(w,O),O}return Qi.vec4=g,Qi}(),ka=function(){if(Yo)return Xo;function r(e,i,s,h){this.cx=3*e,this.bx=3*(s-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*i,this.by=3*(h-i)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=i,this.p2x=s,this.p2y=h}return Yo=1,Xo=r,r.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,i){if(void 0===i&&(i=1e-6),e<0)return 0;if(e>1)return 1;for(var s=e,h=0;h<8;h++){var a=this.sampleCurveX(s)-e;if(Math.abs(a)<i)return s;var u=this.sampleCurveDerivativeX(s);if(Math.abs(u)<1e-6)break;s-=a/u}var x=0,T=1;for(s=e,h=0;h<20&&(a=this.sampleCurveX(s),!(Math.abs(a-e)<i));h++)e>a?x=s:T=s,s=.5*(T-x)+x;return s},solve:function(e,i){return this.sampleCurveY(this.solveCurveX(e,i))}},Xo}(),Oa=er(ka);function Ko(){if(Ws)return Es;function r(e,i){this.x=e,this.y=i}return Ws=1,Es=r,r.prototype={clone:function(){return new r(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,i){return this.clone()._rotateAround(e,i)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var i=e.x-this.x,s=e.y-this.y;return i*i+s*s},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,i){return Math.atan2(this.x*i-this.y*e,this.x*e+this.y*i)},_matMult:function(e){var i=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=i,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var i=Math.cos(e),s=Math.sin(e),h=s*this.x+i*this.y;return this.x=i*this.x-s*this.y,this.y=h,this},_rotateAround:function(e,i){var s=Math.cos(e),h=Math.sin(e),a=i.y+h*(this.x-i.x)+s*(this.y-i.y);return this.x=i.x+s*(this.x-i.x)-h*(this.y-i.y),this.y=a,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},r.convert=function(e){return e instanceof r?e:Array.isArray(e)?new r(e[0],e[1]):e},Es}var pt=er(Ko());function Fn(r,e){if(Array.isArray(r)){if(!Array.isArray(e)||r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(!Fn(r[i],e[i]))return!1;return!0}if("object"==typeof r&&null!==r&&null!==e){if("object"!=typeof e||Object.keys(r).length!==Object.keys(e).length)return!1;for(const i in r)if(!Fn(r[i],e[i]))return!1;return!0}return r===e}const Er=Math.PI/180,$s=180/Math.PI;function yi(r){return r*Er}function Hn(r){return r*$s}const is=[[0,0],[1,0],[1,1],[0,1]];function Gr(r){if(r<=0)return 0;if(r>=1)return 1;const e=r*r,i=e*r;return 4*(r<.5?i:3*(r-e)+i-.75)}function Fa(r,e,i,s){const h=new Oa(r,e,i,s);return function(a){return h.solve(a)}}const Ar=Fa(.25,.1,.25,1);function ai(r,e,i){return Math.min(i,Math.max(e,r))}function Ai(r,e,i){return(i=ai((i-r)/(e-r),0,1))*i*(3-2*i)}function Yi(r,e,i){const s=i-e,h=((r-e)%s+s)%s+e;return h===e?i:h}function zi(r,e,i){if(!r.length)return i(null,[]);let s=r.length;const h=new Array(r.length);let a=null;r.forEach((u,x)=>{e(u,(T,C)=>{T&&(a=T),h[x]=C,0==--s&&i(a,h)})})}function Hi(r,...e){for(const i of e)for(const s in i)r[s]=i[s];return r}let Bn=1;function Ti(){return Bn++}function Ba(r){return r<=1?1:Math.pow(2,Math.ceil(Math.log(r)/Math.LN2))}function Jo(r,e){r.forEach(i=>{e[i]&&(e[i]=e[i].bind(e))})}function Bi(r,e){return-1!==r.indexOf(e,r.length-e.length)}function Ki(r,e,i){const s={};for(const h in r)s[h]=e.call(this,r[h],h,r);return s}function Zs(r,e,i){const s={};for(const h in r)e.call(this,r[h],h,r)&&(s[h]=r[h]);return s}function vr(r){return Array.isArray(r)?r.map(vr):"object"==typeof r&&r?Ki(r,vr):r}const fo={};function ii(r){fo[r]||(typeof console<"u"&&console.warn(r),fo[r]=!0)}function kr(r,e,i){return(i.y-r.y)*(e.x-r.x)>(e.y-r.y)*(i.x-r.x)}function mo(r){let e=0;for(let i,s,h=0,a=r.length,u=a-1;h<a;u=h++)i=r[h],s=r[u],e+=(s.x-i.x)*(i.y+s.y);return e}function Or([r,e,i]){const s=yi(e+90),h=yi(i);return{x:r*Math.cos(s)*Math.sin(h),y:r*Math.sin(s)*Math.sin(h),z:r*Math.cos(h),azimuthal:e,polar:i}}function _o(){return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope}function Qo(r){const e={};if(r.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(i,s,h,a)=>{const u=h||a;return e[s]=!u||u.toLowerCase(),""}),e["max-age"]){const i=parseInt(e["max-age"],10);isNaN(i)?delete e["max-age"]:e["max-age"]=i}return e}let Na=null;function Va(r,e){return[r[4*e],r[4*e+1],r[4*e+2],r[4*e+3]]}function ps(r,e,i,s){for(;e<i;){const h=e+i>>1;r[h]<s?e=h+1:i=h}return e}function go(r,e,i,s){for(;e<i;){const h=e+i>>1;r[h]<=s?e=h+1:i=h}return e}function yo(r){return r>0?1/(1.001-r):1+r}function fs(r){return r>0?1-1/(1.001-r):-r}const En={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!En.API_URL)return null;try{const r=new URL(En.API_URL);return"api.mapbox.cn"===r.hostname?"https://events.mapbox.cn/events/v2":"api.mapbox.com"===r.hostname?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function Sl(r){return En.API_URL_REGEX.test(r)}function pn(r){return En.API_SPRITE_REGEX.test(r)}let ln,tr,qr,Ge,$,te;function ne(){return null==ln&&(ln=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof self.createImageBitmap),ln}const fe={now:()=>void 0!==Ge?Ge:performance.now(),setNow(r){Ge=r},restoreNow(){Ge=void 0},frame(r){const e=requestAnimationFrame(r);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(r,e=0){const{width:i,height:s}=r;$||($=document.createElement("canvas"));const h=$.getContext("2d",{willReadFrequently:!0});if(!h)throw new Error("failed to create canvas 2d context");return(i>$.width||s>$.height)&&($.width=i,$.height=s),h.clearRect(-e,-e,i+2*e,s+2*e),h.drawImage(r,0,0,i,s),h.getImageData(-e,-e,i+2*e,s+2*e)},resolveURL:r=>(tr||(tr=document.createElement("a")),tr.href=r,tr.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(null==qr&&(qr=window.matchMedia("(prefers-reduced-motion: reduce)")),qr.matches)},hasCanvasFingerprintNoise(){if(void 0!==te)return te;if(!ne())return te=!1,!1;const r=new OffscreenCanvas(85,1),e=r.getContext("2d",{willReadFrequently:!0});let i=0;for(let h=0;h<r.width;++h)e.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,e.fillRect(h,0,1,1);const s=e.getImageData(0,0,r.width,r.height);i=0;for(let h=0;h<s.data.length;++h)if(h%4!=3&&i++!==s.data[h])return te=!0,!0;return te=!1,!1}};function me(r,e){const i=r.indexOf("?");if(i<0)return`${r}?${new URLSearchParams(e).toString()}`;const s=new URLSearchParams(r.slice(i));for(const h in e)s.set(h,e[h]);return`${r.slice(0,i)}?${s.toString()}`}function Te(r,e={persistentParams:[]}){const i=r.indexOf("?");if(i<0)return r;const s=new URLSearchParams,h=new URLSearchParams(r.slice(i));for(const u of e.persistentParams){const x=h.get(u);x&&s.set(u,x)}const a=s.toString();return`${r.slice(0,i)}${a.length>0?`?${a}`:""}`}const ze="mapbox-tiles";let Me=500,Ve=50;const Fe=["language","worldview","jobid"];let Ue,Qe;function ot(){try{return caches}catch{}}function dt(){const r=ot();r&&null==Ue&&(Ue=r.open(ze))}let Rt=1/0;const Nt={supported:!1,testSupport:function(r){!ei&&Ft&&(mi?Ii(r):Vt=r)}};let Vt,Ft,ei=!1,mi=!1;const Gt=typeof self<"u"?self:{};function Ii(r){const e=r.createTexture();r.bindTexture(r.TEXTURE_2D,e);try{if(r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,Ft),r.isContextLost())return;Nt.supported=!0}catch{}r.deleteTexture(e),ei=!0}Gt.document&&(Ft=Gt.document.createElement("img"),Ft.onload=function(){Vt&&Ii(Vt),Vt=null,mi=!0},Ft.onerror=function(){ei=!0,Vt=null},Ft.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const ui={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};"function"==typeof Object.freeze&&Object.freeze(ui);class yn extends Error{constructor(e,i,s){401===i&&Sl(s)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=i,this.url=s}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const ir=_o()?()=>self.worker&&self.worker.referrer:()=>("blob:"===location.protocol?parent:self).location.href,zn=function(r,e){if(!(/^file:/.test(i=r.url)||/^file:/.test(ir())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return function(s,h){const a=new AbortController,u=new Request(s.url,{method:s.method||"GET",body:s.body,credentials:s.credentials,headers:s.headers,referrer:ir(),referrerPolicy:s.referrerPolicy,signal:a.signal});let x=!1,T=!1;const C=(g=u.url).indexOf("sku=")>0&&Sl(g);var g;"json"===s.type&&u.headers.set("Accept","application/json");const S=(w,M,P)=>{if(T)return;if(w&&"SecurityError"!==w.message&&ii(w.toString()),M&&P)return A(M);const O=Date.now();fetch(u).then(B=>{if(B.ok){const G=C?B.clone():null;return A(B,G,O)}return h(new yn(B.statusText,B.status,s.url))}).catch(B=>{"AbortError"!==B.name&&h(new Error(`${B.message} ${s.url}`))})},A=(w,M,P)=>{("arrayBuffer"===s.type?w.arrayBuffer():"json"===s.type?w.json():w.text()).then(O=>{T||(M&&P&&function(B,G,q){if(dt(),null==Ue)return;const U=Qo(G.headers.get("Cache-Control")||"");if(U["no-store"])return;const W={status:G.status,statusText:G.statusText,headers:new Headers};G.headers.forEach((ae,oe)=>W.headers.set(oe,ae)),U["max-age"]&&W.headers.set("Expires",new Date(q+1e3*U["max-age"]).toUTCString());const X=W.headers.get("Expires");if(!X||new Date(X).getTime()-q<42e4)return;let ee=Te(B.url,{persistentParams:Fe});if(206===G.status){const ae=B.headers.get("Range");if(!ae)return;W.status=200,ee=me(ee,{range:ae})}!function(ae,oe){if(void 0===Qe)try{new Response(new ReadableStream),Qe=!0}catch{Qe=!1}Qe?oe(ae.body):ae.blob().then(oe)}(G,ae=>{const oe=new Response(200!==(se=G.status)&&404!==se&&[101,103,204,205,304].includes(se)?null:ae,W);var se;dt(),Ue?.then(ye=>ye.put(ee,oe)).catch(ye=>ii(ye.message))})}(u,M,P),x=!0,h(null,O,w.headers.get("Cache-Control"),w.headers.get("Expires")))}).catch(O=>{T||h(new Error(O.message))})};return C?function(w,M){if(dt(),null==Ue)return M(null);Ue.then(P=>{let O=Te(w.url,{persistentParams:Fe});const B=w.headers.get("Range");B&&(O=me(O,{range:B})),P.match(O).then(G=>{const q=function(U){if(!U)return!1;const W=new Date(U.headers.get("Expires")||0),X=Qo(U.headers.get("Cache-Control")||"");return W>Date.now()&&!X["no-cache"]}(G);P.delete(O),q&&P.put(O,G.clone()),M(null,G,q)}).catch(M)}).catch(M)}(u,S):S(null,null),{cancel:()=>{T=!0,x||a.abort()}}}(r,e);if(_o()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",r,e,void 0,!0)}var i;return function(s,h){const a=new XMLHttpRequest;a.open(s.method||"GET",s.url,!0),"arrayBuffer"===s.type&&(a.responseType="arraybuffer");for(const u in s.headers)a.setRequestHeader(u,s.headers[u]);return"json"===s.type&&(a.responseType="text",a.setRequestHeader("Accept","application/json")),a.withCredentials="include"===s.credentials,a.onerror=()=>{h(new Error(a.statusText))},a.onload=()=>{if((a.status>=200&&a.status<300||0===a.status)&&null!==a.response){let u=a.response;if("json"===s.type)try{u=JSON.parse(a.response)}catch(x){return h(x)}h(null,u,a.getResponseHeader("Cache-Control"),a.getResponseHeader("Expires"))}else h(new yn(a.statusText,a.status,s.url))},a.send(s.body),{cancel:()=>a.abort()}}(r,e)},Nn=function(r,e){return zn(Hi(r,{type:"arrayBuffer"}),e)};function ar(r){const e=document.createElement("a");return e.href=r,e.protocol===location.protocol&&e.host===location.host}const Ml="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let As,Ua;As=[],Ua=0;const Lu=function(r,e){if(Nt.supported&&(r.headers||(r.headers={}),r.headers.accept="image/webp,*/*"),Ua>=En.MAX_PARALLEL_IMAGE_REQUESTS){const a={requestParameters:r,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return As.push(a),a}Ua++;let i=!1;const s=()=>{if(!i)for(i=!0,Ua--;As.length&&Ua<En.MAX_PARALLEL_IMAGE_REQUESTS;){const a=As.shift(),{requestParameters:u,callback:x,cancelled:T}=a;T||(a.cancel=Lu(u,x).cancel)}},h=Nn(r,(a,u,x,T)=>{s(),a?e(a):u&&(self.createImageBitmap?function(C,g){const S=new Blob([new Uint8Array(C)],{type:"image/png"});createImageBitmap(S).then(A=>{g(null,A)}).catch(A=>{g(new Error(`Could not load image because of ${A.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))})}(u,(C,g)=>e(C,g,x,T)):function(C,g){const S=new Image;S.onload=()=>{g(null,S),URL.revokeObjectURL(S.src),S.onload=null,requestAnimationFrame(()=>{S.src=Ml})},S.onerror=()=>g(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const A=new Blob([new Uint8Array(C)],{type:"image/png"});S.src=C.byteLength?URL.createObjectURL(A):Ml}(u,(C,g)=>e(C,g,x,T)))});return{cancel:()=>{h.cancel(),s()}}};var _h,gc,gh,nr={exports:{}},xn={exports:{}},Xs={exports:{}},ms=function(){if(gh)return nr.exports;gh=1;var r=(_h||(_h=1,xn.exports=function(i,s){var h,a,u,x,T,C,g,S;for(a=i.length-(h=3&i.length),u=s,T=3432918353,C=461845907,S=0;S<a;)g=255&i.charCodeAt(S)|(255&i.charCodeAt(++S))<<8|(255&i.charCodeAt(++S))<<16|(255&i.charCodeAt(++S))<<24,++S,u=27492+(65535&(x=5*(65535&(u=(u^=g=(65535&(g=(g=(65535&g)*T+(((g>>>16)*T&65535)<<16)&4294967295)<<15|g>>>17))*C+(((g>>>16)*C&65535)<<16)&4294967295)<<13|u>>>19))+((5*(u>>>16)&65535)<<16)&4294967295))+((58964+(x>>>16)&65535)<<16);switch(g=0,h){case 3:g^=(255&i.charCodeAt(S+2))<<16;case 2:g^=(255&i.charCodeAt(S+1))<<8;case 1:u^=g=(65535&(g=(g=(65535&(g^=255&i.charCodeAt(S)))*T+(((g>>>16)*T&65535)<<16)&4294967295)<<15|g>>>17))*C+(((g>>>16)*C&65535)<<16)&4294967295}return u^=i.length,u=2246822507*(65535&(u^=u>>>16))+((2246822507*(u>>>16)&65535)<<16)&4294967295,u=3266489909*(65535&(u^=u>>>13))+((3266489909*(u>>>16)&65535)<<16)&4294967295,(u^=u>>>16)>>>0}),xn.exports),e=(gc||(gc=1,Xs.exports=function(i,s){for(var h,a=i.length,u=s^a,x=0;a>=4;)h=1540483477*(65535&(h=255&i.charCodeAt(x)|(255&i.charCodeAt(++x))<<8|(255&i.charCodeAt(++x))<<16|(255&i.charCodeAt(++x))<<24))+((1540483477*(h>>>16)&65535)<<16),u=1540483477*(65535&u)+((1540483477*(u>>>16)&65535)<<16)^(h=1540483477*(65535&(h^=h>>>24))+((1540483477*(h>>>16)&65535)<<16)),a-=4,++x;switch(a){case 3:u^=(255&i.charCodeAt(x+2))<<16;case 2:u^=(255&i.charCodeAt(x+1))<<8;case 1:u=1540483477*(65535&(u^=255&i.charCodeAt(x)))+((1540483477*(u>>>16)&65535)<<16)}return u=1540483477*(65535&(u^=u>>>13))+((1540483477*(u>>>16)&65535)<<16),(u^=u>>>15)>>>0}),Xs.exports);return nr.exports=r,nr.exports.murmur3=r,nr.exports.murmur2=e,nr.exports}(),ns=er(ms);class Hr{constructor(e,...i){Hi(this,i[0]||{}),this.type=e}}class El extends Hr{constructor(e,i={}){super("error",Hi({error:e},i))}}function yc(r,e,i){i[r]&&-1!==i[r].indexOf(e)||(i[r]=i[r]||[],i[r].push(e))}function rs(r,e,i){if(i&&i[r]){const s=i[r].indexOf(e);-1!==s&&i[r].splice(s,1)}}class Is{on(e,i){return this._listeners=this._listeners||{},yc(e,i,this._listeners),this}off(e,i){return rs(e,i,this._listeners),rs(e,i,this._oneTimeListeners),this}once(e,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},yc(e,i,this._oneTimeListeners),this):new Promise(s=>this.once(e,s))}fire(e,i){const s="string"==typeof e?new Hr(e,i):e,h=s.type;if(this.listens(h)){s.target=this;const a=this._listeners&&this._listeners[h]?this._listeners[h].slice():[];for(const T of a)T.call(this,s);const u=this._oneTimeListeners&&this._oneTimeListeners[h]?this._oneTimeListeners[h].slice():[];for(const T of u)rs(h,T,this._oneTimeListeners),T.call(this,s);const x=this._eventedParent;x&&(Hi(s,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),x.fire(s))}else s instanceof El&&console.error(s.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,i){return this._eventedParent=e,this._eventedParentData=i,this}}var yh,Al={},ss=function(){if(yh)return Al;yh=1;var r={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(a){return(a=Math.round(a))<0?0:a>255?255:a}function i(a){return e("%"===a[a.length-1]?parseFloat(a)/100*255:parseInt(a))}function s(a){return(u="%"===a[a.length-1]?parseFloat(a)/100:parseFloat(a))<0?0:u>1?1:u;var u}function h(a,u,x){return x<0?x+=1:x>1&&(x-=1),6*x<1?a+(u-a)*x*6:2*x<1?u:3*x<2?a+(u-a)*(2/3-x)*6:a}try{Al.parseCSSColor=function(a){var u,x=a.replace(/ /g,"").toLowerCase();if(x in r)return r[x].slice();if("#"===x[0])return 4===x.length?(u=parseInt(x.substr(1),16))>=0&&u<=4095?[(3840&u)>>4|(3840&u)>>8,240&u|(240&u)>>4,15&u|(15&u)<<4,1]:null:7===x.length&&(u=parseInt(x.substr(1),16))>=0&&u<=16777215?[(16711680&u)>>16,(65280&u)>>8,255&u,1]:null;var T=x.indexOf("("),C=x.indexOf(")");if(-1!==T&&C+1===x.length){var g=x.substr(0,T),S=x.substr(T+1,C-(T+1)).split(","),A=1;switch(g){case"rgba":if(4!==S.length)return null;A=s(S.pop());case"rgb":return 3!==S.length?null:[i(S[0]),i(S[1]),i(S[2]),A];case"hsla":if(4!==S.length)return null;A=s(S.pop());case"hsl":if(3!==S.length)return null;var w=(parseFloat(S[0])%360+360)%360/360,M=s(S[1]),P=s(S[2]),O=P<=.5?P*(M+1):P+M-P*M,B=2*P-O;return[e(255*h(B,O,w+1/3)),e(255*h(B,O,w)),e(255*h(B,O,w-1/3)),A];default:return null}}return null}}catch{}return Al}();class Ri{constructor(e,i,s,h=1){this.r=e,this.g=i,this.b=s,this.a=h}static parse(e){if(!e)return;if(e instanceof Ri)return e;if("string"!=typeof e)return;const i=ss.parseCSSColor(e);return i?new Ri(i[0]/255*i[3],i[1]/255*i[3],i[2]/255*i[3],i[3]):void 0}toStringPremultipliedAlpha(){const[e,i,s,h]=0===this.a?[0,0,0,0]:[255*this.r/this.a,255*this.g/this.a,255*this.b/this.a,this.a];return`rgba(${Math.round(e)},${Math.round(i)},${Math.round(s)},${h})`}toString(){const[e,i,s,h]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*s)},${h})`}toRenderColor(e){const{r:i,g:s,b:h,a}=this;return new xh(e,i,s,h,a)}clone(){return new Ri(this.r,this.g,this.b,this.a)}}class xh{constructor(e,i,s,h,a){if(e){const u=e.image.height,x=u*u;i=0===a?0:i/a*(u-1),s=0===a?0:s/a*(u-1),h=0===a?0:h/a*(u-1);const T=Math.floor(i),C=Math.floor(s),g=Math.floor(h),S=Math.ceil(i),A=Math.ceil(s),w=Math.ceil(h),M=i-T,P=s-C,O=h-g,B=e.image.data,G=4*(T+C*x+g*u),q=4*(T+C*x+w*u),U=4*(T+A*x+g*u),W=4*(T+A*x+w*u),X=4*(S+C*x+g*u),ee=4*(S+C*x+w*u),ae=4*(S+A*x+g*u),oe=4*(S+A*x+w*u);if(G<0||oe>=B.length)throw new Error("out of range");this.r=Ut(Ut(Ut(B[G],B[q],O),Ut(B[U],B[W],O),P),Ut(Ut(B[X],B[ee],O),Ut(B[ae],B[oe],O),P),M)/255*a,this.g=Ut(Ut(Ut(B[G+1],B[q+1],O),Ut(B[U+1],B[W+1],O),P),Ut(Ut(B[X+1],B[ee+1],O),Ut(B[ae+1],B[oe+1],O),P),M)/255*a,this.b=Ut(Ut(Ut(B[G+2],B[q+2],O),Ut(B[U+2],B[W+2],O),P),Ut(Ut(B[X+2],B[ee+2],O),Ut(B[ae+2],B[oe+2],O),P),M)/255*a,this.a=a}else this.r=i,this.g=s,this.b=h,this.a=a}toArray(){const{r:e,g:i,b:s,a:h}=this;return 0===h?[0,0,0,0]:[255*e/h,255*i/h,255*s/h,h]}toHslaArray(){if(0===this.a)return[0,0,0,0];const{r:e,g:i,b:s,a:h}=this,a=Math.min(Math.max(e/h,0),1),u=Math.min(Math.max(i/h,0),1),x=Math.min(Math.max(s/h,0),1),T=Math.min(a,u,x),C=Math.max(a,u,x),g=(T+C)/2;if(T===C)return[0,0,100*g,h];const S=C-T,A=g>.5?S/(2-C-T):S/(C+T);let w=0;return C===a?w=(u-x)/S+(u<x?6:0):C===u?w=(x-a)/S+2:C===x&&(w=(a-u)/S+4),w*=60,[Math.min(Math.max(w,0),360),Math.min(Math.max(100*A,0),100),Math.min(Math.max(100*g,0),100),h]}toArray01(){const{r:e,g:i,b:s,a:h}=this;return 0===h?[0,0,0,0]:[e/h,i/h,s/h,h]}toArray01Scaled(e){const{r:i,g:s,b:h,a}=this;return 0===a?[0,0,0]:[i/a*e,s/a*e,h/a*e]}toArray01PremultipliedAlpha(){const{r:e,g:i,b:s,a:h}=this;return[e,i,s,h]}toArray01Linear(){const{r:e,g:i,b:s,a:h}=this;return 0===h?[0,0,0,0]:[Math.pow(e/h,2.2),Math.pow(i/h,2.2),Math.pow(s/h,2.2),h]}}function Ut(r,e,i){return r*(1-i)+e*i}function vh(r,e,i){return r.map((s,h)=>Ut(s,e[h],i))}Ri.black=new Ri(0,0,0,1),Ri.white=new Ri(1,1,1,1),Ri.transparent=new Ri(0,0,0,0),Ri.red=new Ri(1,0,0,1),Ri.blue=new Ri(0,0,1,1);var xc=Object.freeze({__proto__:null,array:vh,color:function(r,e,i){return new Ri(Ut(r.r,e.r,i),Ut(r.g,e.g,i),Ut(r.b,e.b,i),Ut(r.a,e.a,i))},number:Ut});function xo(r,...e){for(const i of e)for(const s in i)r[s]=i[s];return r}class hi extends Error{constructor(e,i){super(i),this.message=i,this.key=e}}class vc{constructor(e,i=[]){this.parent=e,this.bindings={};for(const[s,h]of i)this.bindings[s]=h}concat(e){return new vc(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const Cs={kind:"null"},Mt={kind:"number"},Mi={kind:"string"},wi={kind:"boolean"},Vn={kind:"color"},_s={kind:"object"},Pi={kind:"value"},fn={kind:"collator"},Ps={kind:"formatted"},vo={kind:"resolvedImage"};function Kn(r,e){return{kind:"array",itemType:r,N:e}}function sn(r){if("array"===r.kind){const e=sn(r.itemType);return"number"==typeof r.N?`array<${e}, ${r.N}>`:"value"===r.itemType.kind?"array":`array<${e}>`}return r.kind}const bc=[Cs,Mt,Mi,wi,Vn,Ps,_s,Kn(Pi),vo];function lr(r,e){if("error"===e.kind)return null;if("array"===r.kind){if("array"===e.kind&&(0===e.N&&"value"===e.itemType.kind||!lr(r.itemType,e.itemType))&&("number"!=typeof r.N||r.N===e.N))return null}else{if(r.kind===e.kind)return null;if("value"===r.kind)for(const i of bc)if(!lr(i,e))return null}return`Expected ${sn(r)} but found ${sn(e)} instead.`}function Il(r,e){return e.some(i=>i.kind===r.kind)}function Wr(r,e){return e.some(i=>"null"===i?null===r:"array"===i?Array.isArray(r):"object"===i?r&&!Array.isArray(r)&&"object"==typeof r:i===typeof r)}class ea{constructor(e,i,s){this.sensitivity=e?i?"variant":"case":i?"accent":"base",this.locale=s,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,i){return this.collator.compare(e,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class bo{constructor(e,i,s,h,a){this.text=e.normalize?e.normalize():e,this.image=i,this.scale=s,this.fontStack=h,this.textColor=a}}class cr{constructor(e){this.sections=e}static fromString(e){return new cr([new bo(e,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some(e=>0!==e.text.length||e.image&&e.image.namePrimary)}static factory(e){return e instanceof cr?e:cr.fromString(e)}toString(){return 0===this.sections.length?"":this.sections.map(e=>e.text).join("")}serialize(){const e=["format"];for(const i of this.sections){if(i.image){e.push(["image",i.image.namePrimary]);continue}e.push(i.text);const s={};i.fontStack&&(s["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(s["font-scale"]=i.scale),i.textColor&&(s["text-color"]=["rgba"].concat(i.textColor.toRenderColor(null).toArray())),e.push(s)}return e}}class Ds{constructor(e,i){if(this.id=e,this.options=i||{params:{}},this.options.transform){const{a:s,b:h,c:a,d:u,e:x,f:T}=this.options.transform;this.options.transform=new DOMMatrix([s,h,a,u,x,T])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}static deserializeId(e){return JSON.parse(e).id}static deserializeFromString(e){const i=JSON.parse(e),{a:s,b:h,c:a,d:u,e:x,f:T}=i.options.transform;return new DOMMatrix([s,h,a,u,x,T]),new Ds(i.id,i.options)}scaleSelf(e){return this.options.transform=this.options.transform.scale(e),this}serialize(){const e={id:this.id};this.options&&(e.options=this.options);const{a:i,b:s,c:h,d:a,e:u,f:x}=this.options.transform;return e.options.transform={a:i,b:s,c:h,d:a,e:u,f:x},JSON.stringify(e)}}class rr{constructor(e){this.namePrimary=e.namePrimary,e.nameSecondary&&(this.nameSecondary=e.nameSecondary),e.optionsPrimary&&(this.optionsPrimary=e.optionsPrimary),e.optionsSecondary&&(this.optionsSecondary=e.optionsSecondary),this.available=e.available}toString(){return this.namePrimary&&this.nameSecondary?`[${this.namePrimary},${this.nameSecondary}]`:this.namePrimary}getPrimary(){return new Ds(this.namePrimary,{params:this.optionsPrimary&&this.optionsPrimary.params||{}})}getSerializedPrimary(){return this.getPrimary().serialize()}getSecondary(){return this.nameSecondary?new Ds(this.nameSecondary,{params:this.optionsSecondary&&this.optionsSecondary.params||{}}):null}static from(e){return"string"==typeof e?rr.build(e):e}static build(e,i,s,h){return e?new rr({namePrimary:e,nameSecondary:i,optionsPrimary:s,optionsSecondary:h,available:!1}):null}}function bh(r,e,i,s){return"number"==typeof r&&r>=0&&r<=255&&"number"==typeof e&&e>=0&&e<=255&&"number"==typeof i&&i>=0&&i<=255?void 0===s||"number"==typeof s&&s>=0&&s<=1?null:`Invalid rgba value [${[r,e,i,s].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof s?[r,e,i,s]:[r,e,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Ys(r){if(null===r||"string"==typeof r||"boolean"==typeof r||"number"==typeof r||r instanceof Ri||r instanceof ea||r instanceof cr||r instanceof rr)return!0;if(Array.isArray(r)){for(const e of r)if(!Ys(e))return!1;return!0}if("object"==typeof r){for(const e in r)if(!Ys(r[e]))return!1;return!0}return!1}function en(r){if(null===r)return Cs;if("string"==typeof r)return Mi;if("boolean"==typeof r)return wi;if("number"==typeof r)return Mt;if(r instanceof Ri)return Vn;if(r instanceof ea)return fn;if(r instanceof cr)return Ps;if(r instanceof rr)return vo;if(Array.isArray(r)){const e=r.length;let i;for(const s of r){const h=en(s);if(i){if(i===h)continue;i=Pi;break}i=h}return Kn(i||Pi,e)}return _s}function br(r){const e=typeof r;return null===r?"":"string"===e||"number"===e||"boolean"===e?String(r):r instanceof Ri?r.toStringPremultipliedAlpha():r instanceof cr||r instanceof rr?r.toString():JSON.stringify(r)}class Jn{constructor(e,i){this.type=e,this.value=i}static parse(e,i){if(2!==e.length)return i.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!Ys(e[1]))return i.error("invalid value");const s=e[1];let h=en(s);const a=i.expectedType;return"array"!==h.kind||0!==h.N||!a||"array"!==a.kind||"number"==typeof a.N&&0!==a.N||(h=a),new Jn(h,s)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof Ri?["rgba"].concat(this.value.toRenderColor(null).toArray()):this.value instanceof cr?this.value.serialize():this.value}}class Sn{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const Cl={string:Mi,number:Mt,boolean:wi,object:_s};class gs{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let s,h=1;const a=e[0];if("array"===a){let x,T;if(e.length>2){const C=e[1];if("string"!=typeof C||!(C in Cl)||"object"===C)return i.error('The item type argument of "array" must be one of string, number, boolean',1);x=Cl[C],h++}else x=Pi;if(e.length>3){if(null!==e[2]&&("number"!=typeof e[2]||e[2]<0||e[2]!==Math.floor(e[2])))return i.error('The length argument to "array" must be a positive integer literal',2);T=e[2],h++}s=Kn(x,T)}else s=Cl[a];const u=[];for(;h<e.length;h++){const x=i.parse(e[h],h,Pi);if(!x)return null;u.push(x)}return new gs(s,u)}evaluate(e){for(let i=0;i<this.args.length;i++){const s=this.args[i].evaluate(e);if(!lr(this.type,en(s)))return s;if(i===this.args.length-1)throw new Sn(`The expression ${JSON.stringify(this.args[i].serialize())} evaluated to ${sn(en(s))} but was expected to be of type ${sn(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=this.type,i=[e.kind];if("array"===e.kind){const s=e.itemType;if("string"===s.kind||"number"===s.kind||"boolean"===s.kind){i.push(s.kind);const h=e.N;("number"==typeof h||this.args.length>1)&&i.push(h)}}return i.concat(this.args.map(s=>s.serialize()))}}class Ks{constructor(e){this.type=Ps,this.sections=e}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const s=e[1];if(!Array.isArray(s)&&"object"==typeof s)return i.error("First argument must be an image or text section.");const h=[];let a=!1;for(let u=1;u<=e.length-1;++u){const x=e[u];if(a&&"object"==typeof x&&!Array.isArray(x)){a=!1;let T=null;if(x["font-scale"]&&(T=i.parseObjectValue(x["font-scale"],u,"font-scale",Mt),!T))return null;let C=null;if(x["text-font"]&&(C=i.parseObjectValue(x["text-font"],u,"text-font",Kn(Mi)),!C))return null;let g=null;if(x["text-color"]&&(g=i.parseObjectValue(x["text-color"],u,"text-color",Vn),!g))return null;const S=h[h.length-1];S.scale=T,S.font=C,S.textColor=g}else{const T=i.parse(e[u],u,Pi);if(!T)return null;const C=T.type.kind;if("string"!==C&&"value"!==C&&"null"!==C&&"resolvedImage"!==C)return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");a=!0,h.push({content:T,scale:null,font:null,textColor:null})}}return new Ks(h)}evaluate(e){return new cr(this.sections.map(i=>{const s=i.content.evaluate(e);return en(s)===vo?new bo("",s,null,null,null):new bo(br(s),null,i.scale?i.scale.evaluate(e):null,i.font?i.font.evaluate(e).join(","):null,i.textColor?i.textColor.evaluate(e):null)}))}eachChild(e){for(const i of this.sections)e(i.content),i.scale&&e(i.scale),i.font&&e(i.font),i.textColor&&e(i.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const i of this.sections){e.push(i.content.serialize());const s={};i.scale&&(s["font-scale"]=i.scale.serialize()),i.font&&(s["text-font"]=i.font.serialize()),i.textColor&&(s["text-color"]=i.textColor.serialize()),e.push(s)}return e}}class ja{constructor(e,i,s,h){this._imageWarnHistory={},this.type=vo,this.inputPrimary=e,this.inputSecondary=i,this.inputPrimaryParams=s,this.inputSecondaryParams=h}static parse(e,i){if(e.length<2)return i.error("Expected two or more arguments.");let s=1;const h=[];function a(){if(s<e.length){const x=i.parse(e[s],s++,Mi);return x?(h.push({image:x,options:void 0}),!0):(i.error(h.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function u(){if(s<e.length){if(null===(x=e[s])||"object"!=typeof x||Array.isArray(x))return!0;const T=e[s].params,C=i.concat(s);if(!T)return s++,!0;if("object"!=typeof T||T.constructor!==Object)return C.error('Image options "params" should be an object'),!1;const g={},S=C.concat(void 0,"params");for(const A in T){if(!A)return S.error("Image parameter name should be non-empty"),!1;const w=S.concat(void 0,A).parse(T[A],void 0,Vn,void 0,{typeAnnotation:"coerce"});if(!w)return!1;g[A]=w}return h[h.length-1].options=g,s++,!0}var x;return!0}for(let x=0;x<2;x++)if(!a()||!u())return;return new ja(h[0].image,h[1]?h[1].image:void 0,h[0].options,h[1]?h[1].options:void 0)}evaluateParams(e,i){const s={};if(i){for(const h in i)if(i[h])try{const a=i[h].evaluate(e),u=`Ignoring image parameter "${h}" with semi-transparent color ${a.toString()}`;if(1!==a.a){this._imageWarnHistory[u]||(console.warn(u),this._imageWarnHistory[u]=!0);continue}s[h]=a}catch{continue}if(0!==Object.keys(s).length)return{params:s}}}evaluate(e){const i=rr.build(this.inputPrimary.evaluate(e),this.inputSecondary?this.inputSecondary.evaluate(e):void 0,this.inputPrimaryParams?this.evaluateParams(e,this.inputPrimaryParams):void 0,this.inputSecondaryParams?this.evaluateParams(e,this.inputSecondaryParams):void 0);return i&&e.availableImages&&(i.available=e.availableImages.indexOf(i.namePrimary)>-1,i.nameSecondary&&i.available&&e.availableImages&&(i.available=e.availableImages.indexOf(i.nameSecondary)>-1)),i}eachChild(e){if(e(this.inputPrimary),this.inputPrimaryParams)for(const i in this.inputPrimaryParams)this.inputPrimaryParams[i]&&e(this.inputPrimaryParams[i]);if(this.inputSecondary&&(e(this.inputSecondary),this.inputSecondaryParams))for(const i in this.inputSecondaryParams)this.inputSecondaryParams[i]&&e(this.inputSecondaryParams[i])}outputDefined(){return!1}serializeParams(e){const i={};if(e){for(const s in e)e[s]&&(i[s]=e[s].serialize());return{params:i}}}serialize(){const e=["image",this.inputPrimary.serialize()];return this.inputPrimaryParams&&e.push(this.serializeParams(this.inputPrimaryParams)),this.inputSecondary&&(e.push(this.inputSecondary.serialize()),this.inputSecondaryParams&&e.push(this.serializeParams(this.inputSecondaryParams))),e}}function hr(r){return r instanceof Number?"number":r instanceof String?"string":r instanceof Boolean?"boolean":Array.isArray(r)?"array":null===r?"null":typeof r}const sr={"to-boolean":wi,"to-color":Vn,"to-number":Mt,"to-string":Mi};class mn{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const s=e[0],h=[];let a=Cs;if("to-array"===s){if(!Array.isArray(e[1]))return null;const u=e[1].length;if(i.expectedType){if("array"!==i.expectedType.kind)return i.error(`Expected ${i.expectedType.kind} but found array.`);a=Kn(i.expectedType.itemType,u)}else{if(!(u>0&&Ys(e[1][0])))return null;a=Kn(en(e[1][0]),u)}for(let x=0;x<u;x++){const T=e[1][x];let C;if("array"===hr(T))C=i.parse(T,void 0,a.itemType);else{const g=hr(T);if(g!==a.itemType.kind)return i.error(`Expected ${a.itemType.kind} but found ${g}.`);C=i.registry.literal.parse(["literal",void 0===T?null:T],i)}if(!C)return null;h.push(C)}}else{if(("to-boolean"===s||"to-string"===s)&&2!==e.length)return i.error("Expected one argument.");a=sr[s];for(let u=1;u<e.length;u++){const x=i.parse(e[u],u,Pi);if(!x)return null;h.push(x)}}return new mn(a,h)}evaluate(e){if("boolean"===this.type.kind)return!!this.args[0].evaluate(e);if("color"===this.type.kind){let i,s;for(const h of this.args){if(i=h.evaluate(e),s=null,i instanceof Ri)return i;if("string"==typeof i){const a=e.parseColor(i);if(a)return a}else if(Array.isArray(i)&&(s=i.length<3||i.length>4?`Invalid rbga value ${JSON.stringify(i)}: expected an array containing either three or four numeric values.`:bh(i[0],i[1],i[2],i[3]),!s))return new Ri(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new Sn(s||`Could not parse color from value '${"string"==typeof i?i:String(JSON.stringify(i))}'`)}if("number"===this.type.kind){let i=null;for(const s of this.args){if(i=s.evaluate(e),null===i)return 0;const h=Number(i);if(!isNaN(h))return h}throw new Sn(`Could not convert ${JSON.stringify(i)} to number.`)}return"formatted"===this.type.kind?cr.fromString(br(this.args[0].evaluate(e))):"resolvedImage"===this.type.kind?rr.build(br(this.args[0].evaluate(e))):"array"===this.type.kind?this.args.map(i=>i.evaluate(e)):br(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){if("formatted"===this.type.kind)return new Ks([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new ja(this.args[0]).serialize();const e="array"===this.type.kind?[]:[`to-${this.type.kind}`];return this.eachChild(i=>{e.push(i.serialize())}),e}}const Pl=["Unknown","Point","LineString","Polygon"];class wh{constructor(e,i){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=i}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?Pl[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:s,y:h}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(s*i-e[0])+this.featureDistanceData.bearing[1]*(h*i-e[1])}return 0}parseColor(e){let i=this._parseColorCache[e];return i||(i=this._parseColorCache[e]=Ri.parse(e)),i}getConfig(e){return this.options?this.options.get(e):null}}class Rn{constructor(e,i,s,h,a){this.name=e,this.type=i,this._evaluate=s,this.args=h,this._overloadIndex=a}evaluate(e){if(!this._evaluate){const i=Rn.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(e=>e.serialize()))}static parse(e,i){const s=e[0],h=Rn.definitions[s];if(!h)return i.error(`Unknown expression "${s}". If you wanted a literal array, use ["literal", [...]].`,0);const a=Array.isArray(h)?h[0]:h.type,u=Array.isArray(h)?[[h[1],h[2]]]:h.overloads,x=[];let T=null,C=-1;for(const[g,S]of u){if(Array.isArray(g)&&g.length!==e.length-1)continue;x.push(g),C++,T=new Vl(i.registry,i.path,null,i.scope,void 0,i._scope,i.options);const A=[];let w=!1;for(let M=1;M<e.length;M++){const P=e[M],O=Array.isArray(g)?g[M-1]:g.type,B=T.parse(P,1+A.length,O);if(!B){w=!0;break}A.push(B)}if(!w)if(Array.isArray(g)&&g.length!==A.length)T.error(`Expected ${g.length} arguments, but found ${A.length} instead.`);else{for(let M=0;M<A.length;M++){const P=Array.isArray(g)?g[M]:g.type,O=A[M];T.concat(M+1).checkSubtype(P,O.type)}if(0===T.errors.length)return new Rn(s,a,S,A,C)}}if(1===x.length)i.errors.push(...T.errors);else{const g=(x.length?x:u.map(([A])=>A)).map(Dl).join(" | "),S=[];for(let A=1;A<e.length;A++){const w=i.parse(e[A],1+S.length);if(!w)return null;S.push(sn(w.type))}i.error(`Expected arguments of type ${g}, but found (${S.join(", ")}) instead.`)}return null}static register(e,i){Rn.definitions=i;for(const s in i)e[s]=Rn}}function Dl(r){return Array.isArray(r)?`(${r.map(sn).join(", ")})`:`(${sn(r.type)}...)`}class Js{constructor(e,i,s){this.type=fn,this.locale=s,this.caseSensitive=e,this.diacriticSensitive=i}static parse(e,i){if(2!==e.length)return i.error("Expected one argument.");const s=e[1];if("object"!=typeof s||Array.isArray(s))return i.error("Collator options argument must be an object.");const h=void 0===s["case-sensitive"]?i.parse(!1,1,wi):i.parseObjectValue(s["case-sensitive"],1,"case-sensitive",wi);if(!h)return null;const a=void 0===s["diacritic-sensitive"]?i.parse(!1,1,wi):i.parseObjectValue(s["diacritic-sensitive"],1,"diacritic-sensitive",wi);if(!a)return null;let u=null;return s.locale&&(u=i.parseObjectValue(s.locale,1,"locale",Mi),!u)?null:new Js(h,a,u)}evaluate(e){return new ea(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function Ga(r,e,i=0,s=r.length-1,h=Th){for(;s>i;){if(s-i>600){const T=s-i+1,C=e-i+1,g=Math.log(T),S=.5*Math.exp(2*g/3),A=.5*Math.sqrt(g*S*(T-S)/T)*(C-T/2<0?-1:1);Ga(r,e,Math.max(i,Math.floor(e-C*S/T+A)),Math.min(s,Math.floor(e+(T-C)*S/T+A)),h)}const a=r[e];let u=i,x=s;for(zl(r,i,e),h(r[s],a)>0&&zl(r,i,s);u<x;){for(zl(r,u,x),u++,x--;h(r[u],a)<0;)u++;for(;h(r[x],a)>0;)x--}0===h(r[i],a)?zl(r,i,x):(x++,zl(r,x,s)),x<=e&&(i=x+1),e<=x&&(s=x-1)}}function zl(r,e,i){const s=r[e];r[e]=r[i],r[i]=s}function Th(r,e){return r<e?-1:r>e?1:0}function ku(r){let e=0;for(let i,s,h=0,a=r.length,u=a-1;h<a;u=h++)i=r[h],s=r[u],e+=(s.x-i.x)*(i.y+s.y);return e}function Rl(r,e){r[0]=Math.min(r[0],e[0]),r[1]=Math.min(r[1],e[1]),r[2]=Math.max(r[2],e[0]),r[3]=Math.max(r[3],e[1])}function Ll(r,e){return!(r[0]<=e[0]||r[2]>=e[2]||r[1]<=e[1]||r[3]>=e[3])}function Pd(r,e,i){const s=r[0]-e[0],h=r[1]-e[1],a=r[0]-i[0],u=r[1]-i[1];return s*u-a*h==0&&s*a<=0&&h*u<=0}function ta(r,e,i=!1){let s=!1;for(let x=0,T=e.length;x<T;x++){const C=e[x];for(let g=0,S=C.length,A=S-1;g<S;A=g++){const w=C[A],M=C[g];if(Pd(r,w,M))return i;(a=w)[1]>(h=r)[1]!=(u=M)[1]>h[1]&&h[0]<(u[0]-a[0])*(h[1]-a[1])/(u[1]-a[1])+a[0]&&(s=!s)}}var h,a,u;return s}function Sh(r,e,i,s){const h=s[0]-i[0],a=s[1]-i[1],u=(r[0]-i[0])*a-h*(r[1]-i[1]),x=(e[0]-i[0])*a-h*(e[1]-i[1]);return u>0&&x<0||u<0&&x>0}function Qs(r,e,i,s){return(h=[s[0]-i[0],s[1]-i[1]])[0]*(a=[e[0]-r[0],e[1]-r[1]])[1]-h[1]*a[0]!=0&&!(!Sh(r,e,i,s)||!Sh(i,s,r,e));var h,a}const zs=8192;function Ou(r,e){const i=(180+r[0])/360,s=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r[1]*Math.PI/360)))/360,h=Math.pow(2,e.z);return[Math.round(i*h*zs),Math.round(s*h*zs)]}function Mh(r,e){for(let i=0;i<e.length;i++)if(ta(r,e[i]))return!0;return!1}function Dd(r,e,i){for(const s of i)for(let h=0,a=s.length,u=a-1;h<a;u=h++)if(Qs(r,e,s[u],s[h]))return!0;return!1}function Eh(r,e){for(let i=0;i<r.length;++i)if(!ta(r[i],e))return!1;for(let i=0;i<r.length-1;++i)if(Dd(r[i],r[i+1],e))return!1;return!0}function Fu(r,e){for(let i=0;i<e.length;i++)if(Eh(r,e[i]))return!0;return!1}function Ah(r,e,i){const s=[];for(let h=0;h<r.length;h++){const a=[];for(let u=0;u<r[h].length;u++){const x=Ou(r[h][u],i);Rl(e,x),a.push(x)}s.push(a)}return s}function wo(r,e,i){const s=[];for(let h=0;h<r.length;h++){const a=Ah(r[h],e,i);s.push(a)}return s}function li(r,e,i,s){if(r[0]<i[0]||r[0]>i[2]){const h=.5*s;let a=r[0]-i[0]>h?-s:i[0]-r[0]>h?s:0;0===a&&(a=r[0]-i[2]>h?-s:i[2]-r[0]>h?s:0),r[0]+=a}Rl(e,r)}function zt(r,e,i,s){const h=Math.pow(2,s.z)*zs,a=[s.x*zs,s.y*zs],u=[];if(!r)return u;for(const x of r)for(const T of x){const C=[T.x+a[0],T.y+a[1]];li(C,e,i,h),u.push(C)}return u}function kl(r,e,i,s){const h=Math.pow(2,s.z)*zs,a=[s.x*zs,s.y*zs],u=[];if(!r)return u;for(const T of r){const C=[];for(const g of T){const S=[g.x+a[0],g.y+a[1]];Rl(e,S),C.push(S)}u.push(C)}if(e[2]-e[0]<=h/2){(x=e)[0]=x[1]=1/0,x[2]=x[3]=-1/0;for(const T of u)for(const C of T)li(C,e,i,h)}var x;return u}class qt{constructor(e,i){this.type=wi,this.geojson=e,this.geometries=i}static parse(e,i){if(2!==e.length)return i.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(Ys(e[1])){const s=e[1];if("FeatureCollection"===s.type)for(let h=0;h<s.features.length;++h){const a=s.features[h].geometry.type;if("Polygon"===a||"MultiPolygon"===a)return new qt(s,s.features[h].geometry)}else if("Feature"===s.type){const h=s.geometry.type;if("Polygon"===h||"MultiPolygon"===h)return new qt(s,s.geometry)}else if("Polygon"===s.type||"MultiPolygon"===s.type)return new qt(s,s)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(null!=e.geometry()&&null!=e.canonicalID()){if("Point"===e.geometryType())return function(i,s){const h=[1/0,1/0,-1/0,-1/0],a=[1/0,1/0,-1/0,-1/0],u=i.canonicalID();if(!u)return!1;if("Polygon"===s.type){const x=Ah(s.coordinates,a,u),T=zt(i.geometry(),h,a,u);if(!Ll(h,a))return!1;for(const C of T)if(!ta(C,x))return!1}if("MultiPolygon"===s.type){const x=wo(s.coordinates,a,u),T=zt(i.geometry(),h,a,u);if(!Ll(h,a))return!1;for(const C of T)if(!Mh(C,x))return!1}return!0}(e,this.geometries);if("LineString"===e.geometryType())return function(i,s){const h=[1/0,1/0,-1/0,-1/0],a=[1/0,1/0,-1/0,-1/0],u=i.canonicalID();if(!u)return!1;if("Polygon"===s.type){const x=Ah(s.coordinates,a,u),T=kl(i.geometry(),h,a,u);if(!Ll(h,a))return!1;for(const C of T)if(!Eh(C,x))return!1}if("MultiPolygon"===s.type){const x=wo(s.coordinates,a,u),T=kl(i.geometry(),h,a,u);if(!Ll(h,a))return!1;for(const C of T)if(!Fu(C,x))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const qa={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},wc=1/298.257223563,Wt=wc*(2-wc),eo=Math.PI/180;class ia{static fromTile(e,i,s){const h=Math.PI*(1-2*(e+.5)/Math.pow(2,i)),a=Math.atan(.5*(Math.exp(h)-Math.exp(-h)))/eo;return new ia(a,s)}static get units(){return qa}constructor(e,i){if(void 0===e)throw new Error("No latitude given.");if(i&&!qa[i])throw new Error(`Unknown unit ${i}. Use one of: ${Object.keys(qa).join(", ")}`);const s=6378.137*eo*(i?qa[i]:1),h=Math.cos(e*eo),a=1/(1-Wt*(1-h*h)),u=Math.sqrt(a);this.kx=s*u*h,this.ky=s*u*a*(1-Wt)}distance(e,i){const s=ur(e[0]-i[0])*this.kx,h=(e[1]-i[1])*this.ky;return Math.sqrt(s*s+h*h)}bearing(e,i){const s=ur(i[0]-e[0])*this.kx;return Math.atan2(s,(i[1]-e[1])*this.ky)/eo}destination(e,i,s){const h=s*eo;return this.offset(e,Math.sin(h)*i,Math.cos(h)*i)}offset(e,i,s){return[e[0]+i/this.kx,e[1]+s/this.ky]}lineDistance(e){let i=0;for(let s=0;s<e.length-1;s++)i+=this.distance(e[s],e[s+1]);return i}area(e){let i=0;for(let s=0;s<e.length;s++){const h=e[s];for(let a=0,u=h.length,x=u-1;a<u;x=a++)i+=ur(h[a][0]-h[x][0])*(h[a][1]+h[x][1])*(s?-1:1)}return Math.abs(i)/2*this.kx*this.ky}along(e,i){let s=0;if(i<=0)return e[0];for(let h=0;h<e.length-1;h++){const a=e[h],u=e[h+1],x=this.distance(a,u);if(s+=x,s>i)return Ha(a,u,(i-(s-x))/x)}return e[e.length-1]}pointToSegmentDistance(e,i,s){let[h,a]=i,u=ur(s[0]-h)*this.kx,x=(s[1]-a)*this.ky;if(0!==u||0!==x){const T=(ur(e[0]-h)*this.kx*u+(e[1]-a)*this.ky*x)/(u*u+x*x);T>1?(h=s[0],a=s[1]):T>0&&(h+=u/this.kx*T,a+=x/this.ky*T)}return u=ur(e[0]-h)*this.kx,x=(e[1]-a)*this.ky,Math.sqrt(u*u+x*x)}pointOnLine(e,i){let s=1/0,h=e[0][0],a=e[0][1],u=0,x=0;for(let T=0;T<e.length-1;T++){let C=e[T][0],g=e[T][1],S=ur(e[T+1][0]-C)*this.kx,A=(e[T+1][1]-g)*this.ky,w=0;0===S&&0===A||(w=(ur(i[0]-C)*this.kx*S+(i[1]-g)*this.ky*A)/(S*S+A*A),w>1?(C=e[T+1][0],g=e[T+1][1]):w>0&&(C+=S/this.kx*w,g+=A/this.ky*w)),S=ur(i[0]-C)*this.kx,A=(i[1]-g)*this.ky;const M=S*S+A*A;M<s&&(s=M,h=C,a=g,u=T,x=w)}return{point:[h,a],index:u,t:Math.max(0,Math.min(1,x))}}lineSlice(e,i,s){let h=this.pointOnLine(s,e),a=this.pointOnLine(s,i);if(h.index>a.index||h.index===a.index&&h.t>a.t){const C=h;h=a,a=C}const u=[h.point],x=h.index+1,T=a.index;!Ih(s[x],u[0])&&x<=T&&u.push(s[x]);for(let C=x+1;C<=T;C++)u.push(s[C]);return Ih(s[T],a.point)||u.push(a.point),u}lineSliceAlong(e,i,s){let h=0;const a=[];for(let u=0;u<s.length-1;u++){const x=s[u],T=s[u+1],C=this.distance(x,T);if(h+=C,h>e&&0===a.length&&a.push(Ha(x,T,(e-(h-C))/C)),h>=i)return a.push(Ha(x,T,(i-(h-C))/C)),a;h>e&&a.push(T)}return a}bufferPoint(e,i){const s=i/this.ky,h=i/this.kx;return[e[0]-h,e[1]-s,e[0]+h,e[1]+s]}bufferBBox(e,i){const s=i/this.ky,h=i/this.kx;return[e[0]-h,e[1]-s,e[2]+h,e[3]+s]}insideBBox(e,i){return ur(e[0]-i[0])>=0&&ur(e[0]-i[2])<=0&&e[1]>=i[1]&&e[1]<=i[3]}}function Ih(r,e){return r[0]===e[0]&&r[1]===e[1]}function Ha(r,e,i){const s=ur(e[0]-r[0]);return[r[0]+s*i,r[1]+(e[1]-r[1])*i]}function ur(r){for(;r<-180;)r+=360;for(;r>180;)r-=360;return r}class Un{constructor(e=[],i=(s,h)=>s<h?-1:s>h?1:0){if(this.data=e,this.length=this.data.length,this.compare=i,this.length>0)for(let s=(this.length>>1)-1;s>=0;s--)this._down(s)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(0===this.length)return;const e=this.data[0],i=this.data.pop();return--this.length>0&&(this.data[0]=i,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:i,compare:s}=this,h=i[e];for(;e>0;){const a=e-1>>1,u=i[a];if(s(h,u)>=0)break;i[e]=u,e=a}i[e]=h}_down(e){const{data:i,compare:s}=this,h=this.length>>1,a=i[e];for(;e<h;){let u=1+(e<<1);const x=u+1;if(x<this.length&&s(i[x],i[u])<0&&(u=x),s(i[u],a)>=0)break;i[e]=i[u],e=u}i[e]=a}}var ft=8192;function Ch(r,e){return e.dist-r.dist}function To(r){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==r.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==r[i])return!1;return!0}function Qn(r){return r[1]-r[0]+1}function Ir(r,e){const i=r[1]>=r[0]&&r[1]<e;return i||console.warn("Distance Expression: Index is out of range"),i}function Ph(r,e){if(r[0]>r[1])return[null,null];const i=Qn(r);if(e){if(2===i)return[r,null];const s=Math.floor(i/2);return[[r[0],r[0]+s],[r[0]+s,r[1]]]}{if(1===i)return[r,null];const s=Math.floor(i/2)-1;return[[r[0],r[0]+s],[r[0]+s+1,r[1]]]}}function Rs(r,e){const i=[1/0,1/0,-1/0,-1/0];if(!Ir(e,r.length))return i;for(let s=e[0];s<=e[1];++s)Rl(i,r[s]);return i}function na(r){const e=[1/0,1/0,-1/0,-1/0];for(let i=0;i<r.length;++i)for(let s=0;s<r[i].length;++s)Rl(e,r[i][s]);return e}function So(r,e,i){if(To(r)||To(e))return NaN;let s=0,h=0;return r[2]<e[0]&&(s=e[0]-r[2]),r[0]>e[2]&&(s=r[0]-e[2]),r[1]>e[3]&&(h=r[1]-e[3]),r[3]<e[1]&&(h=e[1]-r[3]),i.distance([0,0],[s,h])}function Dh(r){return 360*r-180}function Bu(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function to(r,e){const i=Math.pow(2,e.z),s=(r.y/ft+e.y)/i;return[Dh((r.x/ft+e.x)/i),Bu(s)]}function zd(r,e){const i=[];for(let s=0;s<r.length;++s)i.push(to(r[s],e));return i}function Nu(r,e,i){const s=i.pointOnLine(e,r).point;return i.distance(r,s)}function zh(r,e,i,s,h){const a=i.slice(s[0],s[1]+1);let u=1/0;for(let x=e[0];x<=e[1];++x)if(0===(u=Math.min(u,Nu(r[x],a,h))))return 0;return u}function Rh(r,e,i,s,h){const a=Math.min(h.pointToSegmentDistance(r,i,s),h.pointToSegmentDistance(e,i,s)),u=Math.min(h.pointToSegmentDistance(i,r,e),h.pointToSegmentDistance(s,r,e));return Math.min(a,u)}function Wa(r,e,i,s,h){if(!Ir(e,r.length)||!Ir(s,i.length))return NaN;let a=1/0;for(let u=e[0];u<e[1];++u)for(let x=s[0];x<s[1];++x){if(Qs(r[u],r[u+1],i[x],i[x+1]))return 0;a=Math.min(a,Rh(r[u],r[u+1],i[x],i[x+1],h))}return a}function Lh(r,e,i,s,h){if(!Ir(e,r.length)||!Ir(s,i.length))return NaN;let a=1/0;for(let u=e[0];u<=e[1];++u)for(let x=s[0];x<=s[1];++x)if(0===(a=Math.min(a,h.distance(r[u],i[x]))))return a;return a}function Mo(r,e,i){if(ta(r,e,!0))return 0;let s=1/0;for(const h of e){const a=h.length;if(a<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(h[0]!==h[a-1]&&0===(s=Math.min(s,i.pointToSegmentDistance(r,h[a-1],h[0])))||0===(s=Math.min(s,Nu(r,h,i))))return s}return s}function Vu(r,e,i,s){if(!Ir(e,r.length))return NaN;for(let a=e[0];a<=e[1];++a)if(ta(r[a],i,!0))return 0;let h=1/0;for(let a=e[0];a<e[1];++a)for(const u of i)for(let x=0,T=u.length,C=T-1;x<T;C=x++){if(Qs(r[a],r[a+1],u[C],u[x]))return 0;h=Math.min(h,Rh(r[a],r[a+1],u[C],u[x],s))}return h}function kh(r,e){for(const i of r)for(let s=0;s<=i.length-1;++s)if(ta(i[s],e,!0))return!0;return!1}function Oh(r,e,i,s=1/0){const h=na(r),a=na(e);if(s!==1/0&&So(h,a,i)>=s)return s;if(Ll(h,a)){if(kh(r,e))return 0}else if(kh(e,r))return 0;let u=s;for(const x of r)for(let T=0,C=x.length,g=C-1;T<C;g=T++)for(const S of e)for(let A=0,w=S.length,M=w-1;A<w;M=A++){if(Qs(x[g],x[T],S[M],S[A]))return 0;u=Math.min(u,Rh(x[g],x[T],S[M],S[A],i))}return u}function $a(r,e,i,s,h,a,u){if(null===a||null===u)return;const x=So(Rs(s,a),Rs(h,u),i);x<e&&r.push({dist:x,range1:a,range2:u})}function Fh(r,e,i,s,h=1/0){let a=Math.min(s.distance(r[0],i[0][0]),h);if(0===a)return a;const u=new Un([{dist:0,range1:[0,r.length-1],range2:[0,0]}],Ch),x=e?50:100,T=na(i);for(;u.length;){const C=u.pop();if(C.dist>=a)continue;const g=C.range1;if(Qn(g)<=x){if(!Ir(g,r.length))return NaN;if(e){const S=Vu(r,g,i,s);if(0===(a=Math.min(a,S)))return a}else for(let S=g[0];S<=g[1];++S){const A=Mo(r[S],i,s);if(0===(a=Math.min(a,A)))return a}}else{const S=Ph(g,e);if(null!==S[0]){const A=So(Rs(r,S[0]),T,s);A<a&&u.push({dist:A,range1:S[0],range2:[0,0]})}if(null!==S[1]){const A=So(Rs(r,S[1]),T,s);A<a&&u.push({dist:A,range1:S[1],range2:[0,0]})}}}return a}function os(r,e,i,s,h,a=1/0){let u=Math.min(a,h.distance(r[0],i[0]));if(0===u)return u;const x=new Un([{dist:0,range1:[0,r.length-1],range2:[0,i.length-1]}],Ch),T=e?50:100,C=s?50:100;for(;x.length;){const g=x.pop();if(g.dist>=u)continue;const S=g.range1,A=g.range2;if(Qn(S)<=T&&Qn(A)<=C){if(!Ir(S,r.length)||!Ir(A,i.length))return NaN;if(e&&s?u=Math.min(u,Wa(r,S,i,A,h)):e||s?e&&!s?u=Math.min(u,zh(i,A,r,S,h)):!e&&s&&(u=Math.min(u,zh(r,S,i,A,h))):u=Math.min(u,Lh(r,S,i,A,h)),0===u)return u}else{const w=Ph(S,e),M=Ph(A,s);$a(x,u,h,r,i,w[0],M[0]),$a(x,u,h,r,i,w[0],M[1]),$a(x,u,h,r,i,w[1],M[0]),$a(x,u,h,r,i,w[1],M[1])}}return u}function Sc(r,e,i,s,h=1/0){let a=h;const u=Rs(r,[0,r.length-1]);for(const x of i)if(!(a!==1/0&&So(u,Rs(x,[0,x.length-1]),s)>=a)&&(a=Math.min(a,os(r,e,x,!0,s,a)),0===a))return a;return a}function Ol(r,e,i,s,h=1/0){let a=h;const u=Rs(r,[0,r.length-1]);for(const x of i){if(a!==1/0&&So(u,na(x),s)>=a)continue;const T=Fh(r,e,x,s,a);if(isNaN(T))return T;if(0===(a=Math.min(a,T)))return a}return a}function Fl(r){return"Point"===r||"MultiPoint"===r||"LineString"===r||"MultiLineString"===r||"Polygon"===r||"MultiPolygon"===r}class Eo{constructor(e,i){this.type=Mt,this.geojson=e,this.geometries=i}static parse(e,i){if(2!==e.length)return i.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(Ys(e[1])){const s=e[1];if("FeatureCollection"===s.type){for(let h=0;h<s.features.length;++h)if(Fl(s.features[h].geometry.type))return new Eo(s,s.features[h].geometry)}else if("Feature"===s.type){if(Fl(s.geometry.type))return new Eo(s,s.geometry)}else if(Fl(s.type))return new Eo(s,s)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const i=e.geometry(),s=e.canonicalID();if(null!=i&&null!=s){if("Point"===e.geometryType())return function(h,a,u){const x=[];for(const C of h)for(const g of C)x.push(to(g,a));const T=new ia(x[0][1],"meters");return"Point"===u.type||"MultiPoint"===u.type||"LineString"===u.type?os(x,!1,"Point"===u.type?[u.coordinates]:u.coordinates,"LineString"===u.type,T):"MultiLineString"===u.type?Sc(x,!1,u.coordinates,T):"Polygon"===u.type||"MultiPolygon"===u.type?Ol(x,!1,"Polygon"===u.type?[u.coordinates]:u.coordinates,T):null}(i,s,this.geometries);if("LineString"===e.geometryType())return function(h,a,u){const x=[];for(const C of h){const g=[];for(const S of C)g.push(to(S,a));x.push(g)}const T=new ia(x[0][0][1],"meters");if("Point"===u.type||"MultiPoint"===u.type||"LineString"===u.type)return Sc("Point"===u.type?[u.coordinates]:u.coordinates,"LineString"===u.type,x,T);if("MultiLineString"===u.type){let C=1/0;for(let g=0;g<u.coordinates.length;g++){const S=Sc(u.coordinates[g],!0,x,T,C);if(isNaN(S))return S;if(0===(C=Math.min(C,S)))return C}return C}if("Polygon"===u.type||"MultiPolygon"===u.type){let C=1/0;for(let g=0;g<x.length;g++){const S=Ol(x[g],!0,"Polygon"===u.type?[u.coordinates]:u.coordinates,T,C);if(isNaN(S))return S;if(0===(C=Math.min(C,S)))return C}return C}return null}(i,s,this.geometries);if("Polygon"===e.geometryType())return function(h,a,u){const x=[];for(const C of function(g){const A=g.length;if(A<=1)return[g];const w=[];let M,P;for(let O=0;O<A;O++){const B=ku(g[O]);0!==B&&(g[O].area=Math.abs(B),void 0===P&&(P=B<0),P===B<0?(M&&w.push(M),M=[g[O]]):M.push(g[O]))}return M&&w.push(M),w}(h)){const g=[];for(let S=0;S<C.length;++S)g.push(zd(C[S],a));x.push(g)}const T=new ia(x[0][0][0][1],"meters");if("Point"===u.type||"MultiPoint"===u.type||"LineString"===u.type)return Ol("Point"===u.type?[u.coordinates]:u.coordinates,"LineString"===u.type,x,T);if("MultiLineString"===u.type){let C=1/0;for(let g=0;g<u.coordinates.length;g++){const S=Ol(u.coordinates[g],!0,x,T,C);if(isNaN(S))return S;if(0===(C=Math.min(C,S)))return C}return C}return"Polygon"===u.type||"MultiPolygon"===u.type?function(C,g,S){let A=1/0;for(const w of C)for(const M of g){const P=Oh(w,M,S,A);if(isNaN(P))return P;if(0===(A=Math.min(A,P)))return A}return A}("Polygon"===u.type?[u.coordinates]:u.coordinates,x,T):null}(i,s,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function Bl(r,e){switch(r){case"string":return br(e);case"number":return+e;case"boolean":return!!e;case"color":return Ri.parse(e);case"formatted":return cr.fromString(br(e));case"resolvedImage":return rr.build(br(e))}return e}function Bh(r,e,i,s){return void 0!==s&&(r=s*Math.round(r/s)),void 0!==e&&r<e&&(r=e),void 0!==i&&r>i&&(r=i),r}class ra{constructor(e,i,s){this.type=e,this.key=i,this.scope=s}static parse(e,i){let s=i.expectedType;if(null==s&&(s=Pi),e.length<2||e.length>3)return i.error("Invalid number of arguments for 'config' expression.");const h=i.parse(e[1],1);if(!(h instanceof Jn))return i.error("Key name of 'config' expression must be a string literal.");if(e.length>=3){const a=i.parse(e[2],2);return a instanceof Jn?new ra(s,br(h.value),br(a.value)):i.error("Scope of 'config' expression must be a string literal.")}return new ra(s,br(h.value))}evaluate(e){const i=[this.key,this.scope,e.scope].filter(Boolean).join("\x1f"),s=e.getConfig(i);if(!s)return null;const{type:h,value:a,values:u,minValue:x,maxValue:T,stepValue:C}=s,g=s.default.evaluate(e);let S=g;if(a){const A=e.scope;e.scope=(A||"").split("\x1f").slice(1).join("\x1f"),S=a.evaluate(e),e.scope=A}return h&&(S=Bl(h,S)),void 0===S||void 0===x&&void 0===T&&void 0===C||("number"==typeof S?S=Bh(S,x,T,C):Array.isArray(S)&&(S=S.map(A=>"number"==typeof A?Bh(A,x,T,C):A))),void 0!==a&&void 0!==S&&u&&!u.includes(S)&&(S=g,h&&(S=Bl(h,S))),(h&&h!==this.type||void 0!==S&&en(S)!==this.type)&&(S=Bl(this.type.kind,S)),S}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.key),e}}function Fr(r){if(r instanceof Rn&&("get"===r.name&&1===r.args.length||"feature-state"===r.name||"has"===r.name&&1===r.args.length||"properties"===r.name||"geometry-type"===r.name||"id"===r.name||/^filter-/.test(r.name))||r instanceof qt||r instanceof Eo)return!1;let e=!0;return r.eachChild(i=>{e&&!Fr(i)&&(e=!1)}),e}function Za(r){if(r instanceof Rn&&"feature-state"===r.name)return!1;let e=!0;return r.eachChild(i=>{e&&!Za(i)&&(e=!1)}),e}function Nl(r){if(r instanceof ra)return new Set([r.key]);let e=new Set;return r.eachChild(i=>{e=new Set([...e,...Nl(i)])}),e}function sa(r,e){if(r instanceof Rn&&e.indexOf(r.name)>=0)return!1;let i=!0;return r.eachChild(s=>{i&&!sa(s,e)&&(i=!1)}),i}class Ao{constructor(e,i){this.type=i.type,this.name=e,this.boundExpression=i}static parse(e,i){if(2!==e.length||"string"!=typeof e[1])return i.error("'var' expression requires exactly one string literal argument.");const s=e[1];return i.scope.has(s)?new Ao(s,i.scope.get(s)):i.error(`Unknown variable "${s}". Make sure "${s}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Xa{constructor(e,i=[],s,h=new vc,a=[],u,x){this.registry=e,this.path=i,this.key=i.map(T=>"string"==typeof T?`['${T}']`:`[${T}]`).join(""),this.scope=h,this.errors=a,this.expectedType=s,this._scope=u,this.options=x}parse(e,i,s,h,a={}){return i||s?this.concat(i,null,s,h)._parse(e,a):this._parse(e,a)}parseObjectValue(e,i,s,h,a,u={}){return this.concat(i,s,h,a)._parse(e,u)}_parse(e,i){function s(h,a,u){return"assert"===u?new gs(a,[h]):"coerce"===u?new mn(a,[h]):h}if(null!==e&&"string"!=typeof e&&"boolean"!=typeof e&&"number"!=typeof e||(e=["literal",e]),Array.isArray(e)){if(0===e.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const h="string"==typeof e[0]?this.registry[e[0]]:void 0;if(h){let a=h.parse(e,this);if(!a)return null;if(this.expectedType){const u=this.expectedType,x=a.type;if("string"!==u.kind&&"number"!==u.kind&&"boolean"!==u.kind&&"object"!==u.kind&&"array"!==u.kind||"value"!==x.kind)if("color"!==u.kind&&"formatted"!==u.kind&&"resolvedImage"!==u.kind||"value"!==x.kind&&"string"!==x.kind){if(this.checkSubtype(u,x))return null}else a=s(a,u,i.typeAnnotation||"coerce");else a=s(a,u,i.typeAnnotation||"assert")}if(!(a instanceof Jn)&&"resolvedImage"!==a.type.kind&&Ul(a)){const u=new wh(this._scope,this.options);try{a=new Jn(a.type,a.evaluate(u))}catch(x){return this.error(x.message),null}}return a}return mn.parse(["to-array",e],this)}return this.error(void 0===e?"'undefined' value invalid. Use null instead.":"object"==typeof e?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,i,s,h){let a="number"==typeof e?this.path.concat(e):this.path;a="string"==typeof i?a.concat(i):a;const u=h?this.scope.concat(h):this.scope;return new Xa(this.registry,a,s||null,u,this.errors,this._scope,this.options)}error(e,...i){const s=`${this.key}${i.map(h=>`[${h}]`).join("")}`;this.errors.push(new hi(s,e))}checkSubtype(e,i){const s=lr(e,i);return s&&this.error(s),s}}var Vl=Xa;function Ul(r){if(r instanceof Ao)return Ul(r.boundExpression);if(r instanceof Rn&&"error"===r.name||r instanceof Js||r instanceof qt||r instanceof Eo||r instanceof ra)return!1;const e=r instanceof mn||r instanceof gs;let i=!0;return r.eachChild(s=>{i=e?i&&Ul(s):i&&s instanceof Jn}),!!i&&Fr(r)&&sa(r,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function jl(r,e){const i=r.length-1;let s,h,a=0,u=i,x=0;for(;a<=u;)if(x=Math.floor((a+u)/2),s=r[x],h=r[x+1],s<=e){if(x===i||e<h)return x;a=x+1}else{if(!(s>e))throw new Sn("Input is not a number.");u=x-1}return 0}class Ya{constructor(e,i,s){this.type=e,this.input=i,this.labels=[],this.outputs=[];for(const[h,a]of s)this.labels.push(h),this.outputs.push(a)}static parse(e,i){if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");const s=i.parse(e[1],1,Mt);if(!s)return null;const h=[];let a=null;i.expectedType&&"value"!==i.expectedType.kind&&(a=i.expectedType);for(let u=1;u<e.length;u+=2){const x=1===u?-1/0:e[u],T=e[u+1],C=u,g=u+1;if("number"!=typeof x)return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',C);if(h.length&&h[h.length-1][0]>=x)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',C);const S=i.parse(T,g,a);if(!S)return null;a=a||S.type,h.push([x,S])}return new Ya(a,s,h)}evaluate(e){const i=this.labels,s=this.outputs;if(1===i.length)return s[0].evaluate(e);const h=this.input.evaluate(e);if(h<=i[0])return s[0].evaluate(e);const a=i.length;return h>=i[a-1]?s[a-1].evaluate(e):s[jl(i,h)].evaluate(e)}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){const e=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&e.push(this.labels[i]),e.push(this.outputs[i].serialize());return e}}const Uu=4/29,Co=6/29,ju=3*Co*Co,Gu=Co*Co*Co,Rd=Math.PI/180,tn=180/Math.PI;function Mc(r){return r>Gu?Math.pow(r,1/3):r/ju+Uu}function Gl(r){return r>Co?r*r*r:ju*(r-Uu)}function Nh(r){return 255*(r<=.0031308?12.92*r:1.055*Math.pow(r,1/2.4)-.055)}function Vh(r){return(r/=255)<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}function Ka(r){const e=Vh(r.r),i=Vh(r.g),s=Vh(r.b),h=Mc((.4124564*e+.3575761*i+.1804375*s)/.95047),a=Mc((.2126729*e+.7151522*i+.072175*s)/1);return{l:116*a-16,a:500*(h-a),b:200*(a-Mc((.0193339*e+.119192*i+.9503041*s)/1.08883)),alpha:r.a}}function Ec(r){let e=(r.l+16)/116,i=isNaN(r.a)?e:e+r.a/500,s=isNaN(r.b)?e:e-r.b/200;return e=1*Gl(e),i=.95047*Gl(i),s=1.08883*Gl(s),new Ri(Nh(3.2404542*i-1.5371385*e-.4985314*s),Nh(-.969266*i+1.8760108*e+.041556*s),Nh(.0556434*i-.2040259*e+1.0572252*s),r.alpha)}function qu(r,e,i){const s=e-r;return r+i*(s>180||s<-180?s-360*Math.round(s/360):s)}const ql={forward:Ka,reverse:Ec,interpolate:function(r,e,i){return{l:Ut(r.l,e.l,i),a:Ut(r.a,e.a,i),b:Ut(r.b,e.b,i),alpha:Ut(r.alpha,e.alpha,i)}}},as={forward:function(r){const{l:e,a:i,b:s}=Ka(r),h=Math.atan2(s,i)*tn;return{h:h<0?h+360:h,c:Math.sqrt(i*i+s*s),l:e,alpha:r.a}},reverse:function(r){const e=r.h*Rd,i=r.c;return Ec({l:r.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:r.alpha})},interpolate:function(r,e,i){return{h:qu(r.h,e.h,i),c:Ut(r.c,e.c,i),l:Ut(r.l,e.l,i),alpha:Ut(r.alpha,e.alpha,i)}}};var Hu=Object.freeze({__proto__:null,hcl:as,lab:ql});class Br{constructor(e,i,s,h,a,u){this.type=e,this.operator=i,this.interpolation=s,this.input=h,this.dynamicStops=a,this.labels=[],this.outputs=[];for(const[x,T]of u)this.labels.push(x),this.outputs.push(T)}static interpolationFactor(e,i,s,h){let a=0;if("exponential"===e.name)a=Uh(i,e.base,s,h);else if("linear"===e.name)a=Uh(i,1,s,h);else if("cubic-bezier"===e.name){const u=e.controlPoints;a=new Oa(u[0],u[1],u[2],u[3]).solve(Uh(i,1,s,h))}return a}static parse(e,i){let[s,h,a,...u]=e;if(!Array.isArray(h)||0===h.length)return i.error("Expected an interpolation type expression.",1);if("linear"===h[0])h={name:"linear"};else if("exponential"===h[0]){const C=h[1];if("number"!=typeof C)return i.error("Exponential interpolation requires a numeric base.",1,1);h={name:"exponential",base:C}}else{if("cubic-bezier"!==h[0])return i.error(`Unknown interpolation type ${String(h[0])}`,1,0);{const C=h.slice(1);if(4!==C.length||C.some(g=>"number"!=typeof g||g<0||g>1))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);h={name:"cubic-bezier",controlPoints:C}}}if(e.length-1<3)return i.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(a=i.parse(a,2,Mt),!a)return null;const x=[];let T=null;if("interpolate-hcl"===s||"interpolate-lab"===s?T=Vn:i.expectedType&&"value"!==i.expectedType.kind&&(T=i.expectedType),e.length-1==3){const C=i.parse(u[0],3,Pi);return C?new Br(T,s,h,a,C,x):null}for(let C=0;C<u.length;C+=2){const g=u[C],S=u[C+1],A=C+3,w=C+4;if("number"!=typeof g)return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',A);if(x.length&&x[x.length-1][0]>=g)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',A);const M=i.parse(S,w,T);if(!M)return null;T=T||M.type,x.push([g,M])}return"number"===T.kind||"color"===T.kind||"array"===T.kind&&"number"===T.itemType.kind&&"number"==typeof T.N?new Br(T,s,h,a,null,x):i.error(`Type ${sn(T)} is not interpolatable.`)}evaluate(e){let i=this.labels,s=this.outputs;if(this.dynamicStops){const g=this.dynamicStops.evaluate(e);if(g.length%2!=0)throw new Sn("Expected an even number of arguments.");i=[],s=[];for(let S=0;S<g.length;S+=2){const A=g[S],w=new Jn(Mt,g[S+1]);if("number"!=typeof A)throw new Sn('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.');if(i.length&&i[i.length-1]>=A)throw new Sn('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.');i.push(A),s.push(w)}if(0===i.length)throw new Sn("Expected at least one input/output pair.")}if(1===i.length)return s[0].evaluate(e);const h=this.input.evaluate(e);if(h<=i[0])return s[0].evaluate(e);const a=i.length;if(h>=i[a-1])return s[a-1].evaluate(e);const u=jl(i,h),x=Br.interpolationFactor(this.interpolation,h,i[u],i[u+1]),T=s[u].evaluate(e),C=s[u+1].evaluate(e);return"interpolate"===this.operator?xc[this.type.kind.toLowerCase()](T,C,x):"interpolate-hcl"===this.operator?as.reverse(as.interpolate(as.forward(T),as.forward(C),x)):ql.reverse(ql.interpolate(ql.forward(T),ql.forward(C),x))}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every(e=>e.outputDefined())}serialize(){let e;e="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const i=[this.operator,e,this.input.serialize()];if(this.dynamicStops)i.push(this.dynamicStops.serialize());else for(let s=0;s<this.labels.length;s++)i.push(this.labels[s],this.outputs[s].serialize());return i}}function Uh(r,e,i,s){const h=s-i,a=r-i;return 0===h?0:1===e?a/h:(Math.pow(e,a)-1)/(Math.pow(e,h)-1)}class Ac{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expectected at least one argument.");let s=null;const h=i.expectedType;h&&"value"!==h.kind&&(s=h);const a=[];for(const x of e.slice(1)){const T=i.parse(x,1+a.length,s,void 0,{typeAnnotation:"omit"});if(!T)return null;s=s||T.type,a.push(T)}const u=h&&a.some(x=>lr(h,x.type));return new Ac(u?Pi:s,a)}evaluate(e){let i,s=null,h=0;for(const a of this.args){if(h++,s=a.evaluate(e),s&&s instanceof rr&&!s.available&&(i||(i=s),s=null,h===this.args.length))return i;if(null!==s)break}return s}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every(e=>e.outputDefined())}serialize(){const e=["coalesce"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class Ic{constructor(e,i){this.type=i.type,this.bindings=[].concat(e),this.result=i}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const i of this.bindings)e(i[1]);e(this.result)}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const s=[];for(let a=1;a<e.length-1;a+=2){const u=e[a];if("string"!=typeof u)return i.error(`Expected string, but found ${typeof u} instead.`,a);if(/[^a-zA-Z0-9_]/.test(u))return i.error("Variable names must contain only alphanumeric characters or '_'.",a);const x=i.parse(e[a+1],a+1);if(!x)return null;s.push([u,x])}const h=i.parse(e[e.length-1],e.length-1,i.expectedType,s);return h?new Ic(s,h):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[i,s]of this.bindings)e.push(i,s.serialize());return e.push(this.result.serialize()),e}}class Cc{constructor(e,i,s){this.type=e,this.index=i,this.input=s}static parse(e,i){if(3!==e.length)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Mt),h=i.parse(e[2],2,Kn(i.expectedType||Pi));return s&&h?new Cc(h.type.itemType,s,h):null}evaluate(e){const i=this.index.evaluate(e),s=this.input.evaluate(e);if(i<0)throw new Sn(`Array index out of bounds: ${i} < 0.`);if(i>s.length-1)throw new Sn(`Array index out of bounds: ${i} > ${s.length-1}.`);if(i===Math.floor(i))return s[i];const h=Math.floor(i),a=Math.ceil(i),u=s[h],x=s[a];if("number"!=typeof u||"number"!=typeof x)throw new Sn(`Cannot interpolate between non-number values at index ${i}.`);const T=i-h;return u*(1-T)+x*T}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Pc{constructor(e,i){this.type=wi,this.needle=e,this.haystack=i}static parse(e,i){if(3!==e.length)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Pi),h=i.parse(e[2],2,Pi);return s&&h?Il(s.type,[wi,Mi,Mt,Cs,Pi])?new Pc(s,h):i.error(`Expected first argument to be of type boolean, string, number or null, but found ${sn(s.type)} instead`):null}evaluate(e){const i=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(null==s)return!1;if(!Wr(i,["boolean","string","number","null"]))throw new Sn(`Expected first argument to be of type boolean, string, number or null, but found ${sn(en(i))} instead.`);if(!Wr(s,["string","array"]))throw new Sn(`Expected second argument to be of type array or string, but found ${sn(en(s))} instead.`);return s.indexOf(i)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class Ja{constructor(e,i,s){this.type=Mt,this.needle=e,this.haystack=i,this.fromIndex=s}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Pi),h=i.parse(e[2],2,Pi);if(!s||!h)return null;if(!Il(s.type,[wi,Mi,Mt,Cs,Pi]))return i.error(`Expected first argument to be of type boolean, string, number or null, but found ${sn(s.type)} instead`);if(4===e.length){const a=i.parse(e[3],3,Mt);return a?new Ja(s,h,a):null}return new Ja(s,h)}evaluate(e){const i=this.needle.evaluate(e),s=this.haystack.evaluate(e);if(!Wr(i,["boolean","string","number","null"]))throw new Sn(`Expected first argument to be of type boolean, string, number or null, but found ${sn(en(i))} instead.`);if(!Wr(s,["string","array"]))throw new Sn(`Expected second argument to be of type array or string, but found ${sn(en(s))} instead.`);if(this.fromIndex){const h=this.fromIndex.evaluate(e);return s.indexOf(i,h)}return s.indexOf(i)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class jh{constructor(e,i,s,h,a,u){this.inputType=e,this.type=i,this.input=s,this.cases=h,this.outputs=a,this.otherwise=u}static parse(e,i){if(e.length<5)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return i.error("Expected an even number of arguments.");let s,h;i.expectedType&&"value"!==i.expectedType.kind&&(h=i.expectedType);const a={},u=[];for(let C=2;C<e.length-1;C+=2){let g=e[C];const S=e[C+1];Array.isArray(g)||(g=[g]);const A=i.concat(C);if(0===g.length)return A.error("Expected at least one branch label.");for(const M of g){if("number"!=typeof M&&"string"!=typeof M)return A.error("Branch labels must be numbers or strings.");if("number"==typeof M&&Math.abs(M)>Number.MAX_SAFE_INTEGER)return A.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof M&&Math.floor(M)!==M)return A.error("Numeric branch labels must be integer values.");if(s){if(A.checkSubtype(s,en(M)))return null}else s=en(M);if(void 0!==a[String(M)])return A.error("Branch labels must be unique.");a[String(M)]=u.length}const w=i.parse(S,C,h);if(!w)return null;h=h||w.type,u.push(w)}const x=i.parse(e[1],1,Pi);if(!x)return null;const T=i.parse(e[e.length-1],e.length-1,h);return T?"value"!==x.type.kind&&i.concat(1).checkSubtype(s,x.type)?null:new jh(s,h,x,a,u,T):null}evaluate(e){const i=this.input.evaluate(e);return(en(i)===this.inputType&&this.outputs[this.cases[i]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),s=[],h={};for(const u of i){const x=h[this.cases[u]];void 0===x?(h[this.cases[u]]=s.length,s.push([this.cases[u],[u]])):s[x][1].push(u)}const a=u=>"number"===this.inputType.kind?Number(u):u;for(const[u,x]of s)e.push(1===x.length?a(x[0]):x.map(a)),e.push(this.outputs[u].serialize());return e.push(this.otherwise.serialize()),e}}class Gh{constructor(e,i,s){this.type=e,this.branches=i,this.otherwise=s}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return i.error("Expected an odd number of arguments.");let s;i.expectedType&&"value"!==i.expectedType.kind&&(s=i.expectedType);const h=[];for(let u=1;u<e.length-1;u+=2){const x=i.parse(e[u],u,wi);if(!x)return null;const T=i.parse(e[u+1],u+1,s);if(!T)return null;h.push([x,T]),s=s||T.type}const a=i.parse(e[e.length-1],e.length-1,s);return a?new Gh(s,h,a):null}evaluate(e){for(const[i,s]of this.branches)if(i.evaluate(e))return s.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[i,s]of this.branches)e(i),e(s);e(this.otherwise)}outputDefined(){return this.branches.every(([e,i])=>i.outputDefined())&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild(i=>{e.push(i.serialize())}),e}}class Dc{constructor(e,i,s,h){this.type=e,this.input=i,this.beginIndex=s,this.endIndex=h}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const s=i.parse(e[1],1,Pi),h=i.parse(e[2],2,Mt);if(!s||!h)return null;if(!Il(s.type,[Kn(Pi),Mi,Pi]))return i.error(`Expected first argument to be of type array or string, but found ${sn(s.type)} instead`);if(4===e.length){const a=i.parse(e[3],3,Mt);return a?new Dc(s.type,s,h,a):null}return new Dc(s.type,s,h)}evaluate(e){const i=this.input.evaluate(e),s=this.beginIndex.evaluate(e);if(!Wr(i,["string","array"]))throw new Sn(`Expected first argument to be of type array or string, but found ${sn(en(i))} instead.`);if(this.endIndex){const h=this.endIndex.evaluate(e);return i.slice(s,h)}return i.slice(s)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}function qh(r,e){return"=="===r||"!="===r?"boolean"===e.kind||"string"===e.kind||"number"===e.kind||"null"===e.kind||"value"===e.kind:"string"===e.kind||"number"===e.kind||"value"===e.kind}function Wu(r,e,i,s){return 0===s.compare(e,i)}function oa(r,e,i){const s="=="!==r&&"!="!==r;return class Fy{constructor(a,u,x){this.type=wi,this.lhs=a,this.rhs=u,this.collator=x,this.hasUntypedArgument="value"===a.type.kind||"value"===u.type.kind}static parse(a,u){if(3!==a.length&&4!==a.length)return u.error("Expected two or three arguments.");const x=a[0];let T=u.parse(a[1],1,Pi);if(!T)return null;if(!qh(x,T.type))return u.concat(1).error(`"${x}" comparisons are not supported for type '${sn(T.type)}'.`);let C=u.parse(a[2],2,Pi);if(!C)return null;if(!qh(x,C.type))return u.concat(2).error(`"${x}" comparisons are not supported for type '${sn(C.type)}'.`);if(T.type.kind!==C.type.kind&&"value"!==T.type.kind&&"value"!==C.type.kind)return u.error(`Cannot compare types '${sn(T.type)}' and '${sn(C.type)}'.`);s&&("value"===T.type.kind&&"value"!==C.type.kind?T=new gs(C.type,[T]):"value"!==T.type.kind&&"value"===C.type.kind&&(C=new gs(T.type,[C])));let g=null;if(4===a.length){if("string"!==T.type.kind&&"string"!==C.type.kind&&"value"!==T.type.kind&&"value"!==C.type.kind)return u.error("Cannot use collator to compare non-string types.");if(g=u.parse(a[3],3,fn),!g)return null}return new Fy(T,C,g)}evaluate(a){const u=this.lhs.evaluate(a),x=this.rhs.evaluate(a);if(s&&this.hasUntypedArgument){const T=en(u),C=en(x);if(T.kind!==C.kind||"string"!==T.kind&&"number"!==T.kind)throw new Sn(`Expected arguments for "${r}" to be (string, string) or (number, number), but found (${T.kind}, ${C.kind}) instead.`)}if(this.collator&&!s&&this.hasUntypedArgument){const T=en(u),C=en(x);if("string"!==T.kind||"string"!==C.kind)return e(a,u,x)}return this.collator?i(a,u,x,this.collator.evaluate(a)):e(a,u,x)}eachChild(a){a(this.lhs),a(this.rhs),this.collator&&a(this.collator)}outputDefined(){return!0}serialize(){const a=[r];return this.eachChild(u=>{a.push(u.serialize())}),a}}}const Ld=oa("==",function(r,e,i){return e===i},Wu),kd=oa("!=",function(r,e,i){return e!==i},function(r,e,i,s){return!Wu(0,e,i,s)}),Od=oa("<",function(r,e,i){return e<i},function(r,e,i,s){return s.compare(e,i)<0}),Fd=oa(">",function(r,e,i){return e>i},function(r,e,i,s){return s.compare(e,i)>0}),Hh=oa("<=",function(r,e,i){return e<=i},function(r,e,i,s){return s.compare(e,i)<=0}),Bd=oa(">=",function(r,e,i){return e>=i},function(r,e,i,s){return s.compare(e,i)>=0});class zc{constructor(e,i,s,h,a,u){this.type=Mi,this.number=e,this.locale=i,this.currency=s,this.unit=h,this.minFractionDigits=a,this.maxFractionDigits=u}static parse(e,i){if(3!==e.length)return i.error("Expected two arguments.");const s=i.parse(e[1],1,Mt);if(!s)return null;const h=e[2];if("object"!=typeof h||Array.isArray(h))return i.error("NumberFormat options argument must be an object.");let a=null;if(h.locale&&(a=i.parseObjectValue(h.locale,2,"locale",Mi),!a))return null;let u=null;if(h.currency&&(u=i.parseObjectValue(h.currency,2,"currency",Mi),!u))return null;let x=null;if(h.unit&&(x=i.parseObjectValue(h.unit,2,"unit",Mi),!x))return null;let T=null;if(h["min-fraction-digits"]&&(T=i.parseObjectValue(h["min-fraction-digits"],2,"min-fraction-digits",Mt),!T))return null;let C=null;return h["max-fraction-digits"]&&(C=i.parseObjectValue(h["max-fraction-digits"],2,"max-fraction-digits",Mt),!C)?null:new zc(s,a,u,x,T,C)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class $u{constructor(e){this.type=Mt,this.input=e}static parse(e,i){if(2!==e.length)return i.error(`Expected 1 argument, but found ${e.length-1} instead.`);const s=i.parse(e[1],1);return s?"array"!==s.type.kind&&"string"!==s.type.kind&&"value"!==s.type.kind?i.error(`Expected argument of type string or array, but found ${sn(s.type)} instead.`):new $u(s):null}evaluate(e){const i=this.input.evaluate(e);if("string"==typeof i||Array.isArray(i))return i.length;throw new Sn(`Expected value to be of type string or array, but found ${sn(en(i))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild(i=>{e.push(i.serialize())}),e}}function Wh(r){return function(){r=1831565813+(r|=0)|0;let e=Math.imul(r^r>>>15,1|r);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const Hl={"==":Ld,"!=":kd,">":Fd,"<":Od,">=":Bd,"<=":Hh,array:gs,at:Cc,boolean:gs,case:Gh,coalesce:Ac,collator:Js,format:Ks,image:ja,in:Pc,"index-of":Ja,interpolate:Br,"interpolate-hcl":Br,"interpolate-lab":Br,length:$u,let:Ic,literal:Jn,match:jh,number:gs,"number-format":zc,object:gs,slice:Dc,step:Ya,string:gs,"to-boolean":mn,"to-color":mn,"to-number":mn,"to-string":mn,var:Ao,within:qt,distance:Eo,config:ra};function $h(r,[e,i,s,h]){e=e.evaluate(r),i=i.evaluate(r),s=s.evaluate(r);const a=h?h.evaluate(r):1,u=bh(e,i,s,a);if(u)throw new Sn(u);return new Ri(e/255*a,i/255*a,s/255*a,a)}function Po(r,[e,i,s,h]){e=e.evaluate(r),i=i.evaluate(r),s=s.evaluate(r);const a=h?h.evaluate(r):1,u=(g=i,S=s,A=a,"number"==typeof(C=e)&&C>=0&&C<=360?"number"==typeof g&&g>=0&&g<=100&&"number"==typeof S&&S>=0&&S<=100?void 0===A||"number"==typeof A&&A>=0&&A<=1?null:`Invalid hsla value [${[C,g,S,A].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${("number"==typeof A?[C,g,S,A]:[C,g,S]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${("number"==typeof A?[C,g,S,A]:[C,g,S]).join(", ")}]: 'h' must be between 0 and 360.`);var C,g,S,A;if(u)throw new Sn(u);const x=`hsla(${e}, ${i}%, ${s}%, ${a})`,T=Ri.parse(x);if(!T)throw new Sn(`Failed to parse HSLA color: ${x}`);return T}function Rc(r,e){return r in e}function Zh(r,e){const i=e[r];return void 0===i?null:i}function Do(r){return{type:r}}function aa(r){return{result:"success",value:r}}function $r(r){return{result:"error",value:r}}function Qa(r,e){return!!r&&!!r.parameters&&r.parameters.indexOf(e)>-1}function Wl(r){return"data-driven"===r["property-type"]}function Zu(r){return Qa(r.expression,"measure-light")}function el(r){return Qa(r.expression,"zoom")}function tl(r){return!!r.expression&&r.expression.interpolated}function Xh(r){return"object"==typeof r&&null!==r&&!Array.isArray(r)}function Xu(r){return r}function la(r,e){const i="color"===e.type,s=r.stops&&"object"==typeof r.stops[0][0],h=s||!(s||void 0!==r.property),a=r.type||(tl(e)?"exponential":"interval");if(i&&((r=xo({},r)).stops&&(r.stops=r.stops.map(C=>[C[0],Ri.parse(C[1])])),r.default=Ri.parse(r.default?r.default:e.default)),r.colorSpace&&"rgb"!==r.colorSpace&&!Hu[r.colorSpace])throw new Error(`Unknown color space: ${r.colorSpace}`);let u,x,T;if("exponential"===a)u=Yu;else if("interval"===a)u=Nd;else if("categorical"===a){u=$l,x=Object.create(null);for(const C of r.stops)x[C[0]]=C[1];T=typeof r.stops[0][0]}else{if("identity"!==a)throw new Error(`Unknown function type "${a}"`);u=Ku}if(s){const C={},g=[];for(let w=0;w<r.stops.length;w++){const M=r.stops[w],P=M[0].zoom;void 0===C[P]&&(C[P]={zoom:P,type:r.type,property:r.property,default:r.default,stops:[]},g.push(P)),C[P].stops.push([M[0].value,M[1]])}const S=[];for(const w of g)S.push([C[w].zoom,la(C[w],e)]);const A={name:"linear"};return{kind:"composite",interpolationType:A,interpolationFactor:Br.interpolationFactor.bind(void 0,A),zoomStops:S.map(w=>w[0]),evaluate:({zoom:w},M)=>Yu({stops:S,base:r.base},e,w).evaluate(w,M)}}if(h){const C="exponential"===a?{name:"exponential",base:void 0!==r.base?r.base:1}:null;return{kind:"camera",interpolationType:C,interpolationFactor:Br.interpolationFactor.bind(void 0,C),zoomStops:r.stops.map(g=>g[0]),evaluate:({zoom:g})=>u(r,e,g,x,T)}}return{kind:"source",evaluate(C,g){const S=g&&g.properties?g.properties[r.property]:void 0;return void 0===S?ca(r.default,e.default):u(r,e,S,x,T)}}}function ca(r,e,i){return void 0!==r?r:void 0!==e?e:void 0!==i?i:void 0}function $l(r,e,i,s,h){return ca(typeof i===h?s[i]:void 0,r.default,e.default)}function Nd(r,e,i){if("number"!==hr(i))return ca(r.default,e.default);const s=r.stops.length;if(1===s||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[s-1][0])return r.stops[s-1][1];const h=jl(r.stops.map(a=>a[0]),i);return r.stops[h][1]}function Yu(r,e,i){const s=void 0!==r.base?r.base:1;if("number"!==hr(i))return ca(r.default,e.default);const h=r.stops.length;if(1===h||i<=r.stops[0][0])return r.stops[0][1];if(i>=r.stops[h-1][0])return r.stops[h-1][1];const a=jl(r.stops.map(g=>g[0]),i),u=function(g,S,A,w){const M=w-A,P=g-A;return 0===M?0:1===S?P/M:(Math.pow(S,P)-1)/(Math.pow(S,M)-1)}(i,s,r.stops[a][0],r.stops[a+1][0]),x=r.stops[a][1],T=r.stops[a+1][1];let C=xc[e.type]||Xu;if(r.colorSpace&&"rgb"!==r.colorSpace){const g=Hu[r.colorSpace];C=(S,A)=>g.reverse(g.interpolate(g.forward(S),g.forward(A),u))}return"function"==typeof x.evaluate?{evaluate(...g){const S=x.evaluate.apply(void 0,g),A=T.evaluate.apply(void 0,g);if(void 0!==S&&void 0!==A)return C(S,A,u)}}:C(x,T,u)}function Ku(r,e,i){return"color"===e.type?i=Ri.parse(i):"formatted"===e.type?i=cr.fromString(i.toString()):"resolvedImage"===e.type?i=rr.build(i.toString()):hr(i)===e.type||"enum"===e.type&&e.values[i]||(i=void 0),ca(i,r.default,e.default)}Rn.register(Hl,{error:[{kind:"error"},[Mi],(r,[e])=>{throw new Sn(e.evaluate(r))}],typeof:[Mi,[Pi],(r,[e])=>sn(en(e.evaluate(r)))],"to-rgba":[Kn(Mt,4),[Vn],(r,[e])=>e.evaluate(r).toRenderColor(null).toArray()],"to-hsla":[Kn(Mt,4),[Vn],(r,[e])=>e.evaluate(r).toRenderColor(null).toHslaArray()],rgb:[Vn,[Mt,Mt,Mt],$h],rgba:[Vn,[Mt,Mt,Mt,Mt],$h],hsl:[Vn,[Mt,Mt,Mt],Po],hsla:[Vn,[Mt,Mt,Mt,Mt],Po],has:{type:wi,overloads:[[[Mi],(r,[e])=>Rc(e.evaluate(r),r.properties())],[[Mi,_s],(r,[e,i])=>Rc(e.evaluate(r),i.evaluate(r))]]},get:{type:Pi,overloads:[[[Mi],(r,[e])=>Zh(e.evaluate(r),r.properties())],[[Mi,_s],(r,[e,i])=>Zh(e.evaluate(r),i.evaluate(r))]]},"feature-state":[Pi,[Mi],(r,[e])=>Zh(e.evaluate(r),r.featureState||{})],properties:[_s,[],r=>r.properties()],"geometry-type":[Mi,[],r=>r.geometryType()],id:[Pi,[],r=>r.id()],zoom:[Mt,[],r=>r.globals.zoom],pitch:[Mt,[],r=>r.globals.pitch||0],"distance-from-center":[Mt,[],r=>r.distanceFromCenter()],"measure-light":[Mt,[Mi],(r,[e])=>r.measureLight(e.evaluate(r))],"heatmap-density":[Mt,[],r=>r.globals.heatmapDensity||0],"line-progress":[Mt,[],r=>r.globals.lineProgress||0],"raster-value":[Mt,[],r=>r.globals.rasterValue||0],"raster-particle-speed":[Mt,[],r=>r.globals.rasterParticleSpeed||0],"sky-radial-progress":[Mt,[],r=>r.globals.skyRadialProgress||0],accumulated:[Pi,[],r=>void 0===r.globals.accumulated?null:r.globals.accumulated],"+":[Mt,Do(Mt),(r,e)=>{let i=0;for(const s of e)i+=s.evaluate(r);return i}],"*":[Mt,Do(Mt),(r,e)=>{let i=1;for(const s of e)i*=s.evaluate(r);return i}],"-":{type:Mt,overloads:[[[Mt,Mt],(r,[e,i])=>e.evaluate(r)-i.evaluate(r)],[[Mt],(r,[e])=>-e.evaluate(r)]]},"/":[Mt,[Mt,Mt],(r,[e,i])=>e.evaluate(r)/i.evaluate(r)],"%":[Mt,[Mt,Mt],(r,[e,i])=>e.evaluate(r)%i.evaluate(r)],ln2:[Mt,[],()=>Math.LN2],pi:[Mt,[],()=>Math.PI],e:[Mt,[],()=>Math.E],"^":[Mt,[Mt,Mt],(r,[e,i])=>Math.pow(e.evaluate(r),i.evaluate(r))],sqrt:[Mt,[Mt],(r,[e])=>Math.sqrt(e.evaluate(r))],log10:[Mt,[Mt],(r,[e])=>Math.log(e.evaluate(r))/Math.LN10],ln:[Mt,[Mt],(r,[e])=>Math.log(e.evaluate(r))],log2:[Mt,[Mt],(r,[e])=>Math.log(e.evaluate(r))/Math.LN2],sin:[Mt,[Mt],(r,[e])=>Math.sin(e.evaluate(r))],cos:[Mt,[Mt],(r,[e])=>Math.cos(e.evaluate(r))],tan:[Mt,[Mt],(r,[e])=>Math.tan(e.evaluate(r))],asin:[Mt,[Mt],(r,[e])=>Math.asin(e.evaluate(r))],acos:[Mt,[Mt],(r,[e])=>Math.acos(e.evaluate(r))],atan:[Mt,[Mt],(r,[e])=>Math.atan(e.evaluate(r))],min:[Mt,Do(Mt),(r,e)=>Math.min(...e.map(i=>i.evaluate(r)))],max:[Mt,Do(Mt),(r,e)=>Math.max(...e.map(i=>i.evaluate(r)))],abs:[Mt,[Mt],(r,[e])=>Math.abs(e.evaluate(r))],round:[Mt,[Mt],(r,[e])=>{const i=e.evaluate(r);return i<0?-Math.round(-i):Math.round(i)}],floor:[Mt,[Mt],(r,[e])=>Math.floor(e.evaluate(r))],ceil:[Mt,[Mt],(r,[e])=>Math.ceil(e.evaluate(r))],"filter-==":[wi,[Mi,Pi],(r,[e,i])=>r.properties()[e.value]===i.value],"filter-id-==":[wi,[Pi],(r,[e])=>r.id()===e.value],"filter-type-==":[wi,[Mi],(r,[e])=>r.geometryType()===e.value],"filter-<":[wi,[Mi,Pi],(r,[e,i])=>{const s=r.properties()[e.value],h=i.value;return typeof s==typeof h&&s<h}],"filter-id-<":[wi,[Pi],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i<s}],"filter->":[wi,[Mi,Pi],(r,[e,i])=>{const s=r.properties()[e.value],h=i.value;return typeof s==typeof h&&s>h}],"filter-id->":[wi,[Pi],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i>s}],"filter-<=":[wi,[Mi,Pi],(r,[e,i])=>{const s=r.properties()[e.value],h=i.value;return typeof s==typeof h&&s<=h}],"filter-id-<=":[wi,[Pi],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i<=s}],"filter->=":[wi,[Mi,Pi],(r,[e,i])=>{const s=r.properties()[e.value],h=i.value;return typeof s==typeof h&&s>=h}],"filter-id->=":[wi,[Pi],(r,[e])=>{const i=r.id(),s=e.value;return typeof i==typeof s&&i>=s}],"filter-has":[wi,[Pi],(r,[e])=>e.value in r.properties()],"filter-has-id":[wi,[],r=>null!==r.id()&&void 0!==r.id()],"filter-type-in":[wi,[Kn(Mi)],(r,[e])=>e.value.indexOf(r.geometryType())>=0],"filter-id-in":[wi,[Kn(Pi)],(r,[e])=>e.value.indexOf(r.id())>=0],"filter-in-small":[wi,[Mi,Kn(Pi)],(r,[e,i])=>i.value.indexOf(r.properties()[e.value])>=0],"filter-in-large":[wi,[Mi,Kn(Pi)],(r,[e,i])=>function(s,h,a,u){for(;a<=u;){const x=a+u>>1;if(h[x]===s)return!0;h[x]>s?u=x-1:a=x+1}return!1}(r.properties()[e.value],i.value,0,i.value.length-1)],all:{type:wi,overloads:[[[wi,wi],(r,[e,i])=>e.evaluate(r)&&i.evaluate(r)],[Do(wi),(r,e)=>{for(const i of e)if(!i.evaluate(r))return!1;return!0}]]},any:{type:wi,overloads:[[[wi,wi],(r,[e,i])=>e.evaluate(r)||i.evaluate(r)],[Do(wi),(r,e)=>{for(const i of e)if(i.evaluate(r))return!0;return!1}]]},"!":[wi,[wi],(r,[e])=>!e.evaluate(r)],"is-supported-script":[wi,[Mi],(r,[e])=>{const i=r.globals&&r.globals.isSupportedScript;return!i||i(e.evaluate(r))}],upcase:[Mi,[Mi],(r,[e])=>e.evaluate(r).toUpperCase()],downcase:[Mi,[Mi],(r,[e])=>e.evaluate(r).toLowerCase()],concat:[Mi,Do(Pi),(r,e)=>e.map(i=>br(i.evaluate(r))).join("")],"resolved-locale":[Mi,[fn],(r,[e])=>e.evaluate(r).resolvedLocale()],random:[Mt,[Mt,Mt,Pi],(r,e)=>{const[i,s,h]=e.map(u=>u.evaluate(r));if(i>s||i===s)return i;let a;if("string"==typeof h)a=function(u){let x=0;if(0===u.length)return x;for(let T=0;T<u.length;T++)x=(x<<5)-x+u.charCodeAt(T),x|=0;return x}(h);else{if("number"!=typeof h)throw new Sn(`Invalid seed input: ${h}`);a=h}return i+Wh(a)()*(s-i)}]});class Lc{constructor(e,i,s,h){var a;this.expression=e,this._warningHistory={},this._evaluator=new wh(s,h),this._defaultValue=i?"color"===(a=i).type&&(Xh(a.default)||Array.isArray(a.default))?new Ri(0,0,0,0):"color"===a.type?Ri.parse(a.default)||null:void 0===a.default?null:a.default:null,this._enumValues=i&&"enum"===i.type?i.values:null,this.configDependencies=Nl(e)}evaluateWithoutErrorHandling(e,i,s,h,a,u,x,T){return this._evaluator.globals=e,this._evaluator.feature=i,this._evaluator.featureState=s,this._evaluator.canonical=h||null,this._evaluator.availableImages=a||null,this._evaluator.formattedSection=u,this._evaluator.featureTileCoord=x||null,this._evaluator.featureDistanceData=T||null,this.expression.evaluate(this._evaluator)}evaluate(e,i,s,h,a,u,x,T){this._evaluator.globals=e,this._evaluator.feature=i||null,this._evaluator.featureState=s||null,this._evaluator.canonical=h||null,this._evaluator.availableImages=a||null,this._evaluator.formattedSection=u||null,this._evaluator.featureTileCoord=x||null,this._evaluator.featureDistanceData=T||null;try{const C=this.expression.evaluate(this._evaluator);if(null==C||"number"==typeof C&&C!=C)return this._defaultValue;if(this._enumValues&&!(C in this._enumValues))throw new Sn(`Expected value to be one of ${Object.keys(this._enumValues).map(g=>JSON.stringify(g)).join(", ")}, but found ${JSON.stringify(C)} instead.`);return C}catch(C){return this._warningHistory[C.message]||(this._warningHistory[C.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${C.message}`)),this._defaultValue}}}function ha(r){return Array.isArray(r)&&r.length>0&&"string"==typeof r[0]&&r[0]in Hl}function ua(r,e,i,s){const h=new Vl(Hl,[],e?function(u){const x={color:Vn,string:Mi,number:Mt,enum:Mi,boolean:wi,formatted:Ps,resolvedImage:vo};return"array"===u.type?Kn(x[u.value]||Pi,u.length):x[u.type]}(e):void 0,void 0,void 0,i,s),a=h.parse(r,void 0,void 0,void 0,e&&"string"===e.type?{typeAnnotation:"coerce"}:void 0);return a?aa(new Lc(a,e,i,s)):$r(h.errors)}class kc{constructor(e,i,s,h){this.kind=e,this._styleExpression=i,this.isLightConstant=s,this.isLineProgressConstant=h,this.isStateDependent="constant"!==e&&!Za(i.expression),this.configDependencies=Nl(i.expression)}evaluateWithoutErrorHandling(e,i,s,h,a,u){return this._styleExpression.evaluateWithoutErrorHandling(e,i,s,h,a,u)}evaluate(e,i,s,h,a,u){return this._styleExpression.evaluate(e,i,s,h,a,u)}}class Zl{constructor(e,i,s,h,a,u){this.kind=e,this.zoomStops=s,this._styleExpression=i,this.isStateDependent="camera"!==e&&!Za(i.expression),this.isLightConstant=a,this.isLineProgressConstant=u,this.configDependencies=Nl(i.expression),this.interpolationType=h}evaluateWithoutErrorHandling(e,i,s,h,a,u){return this._styleExpression.evaluateWithoutErrorHandling(e,i,s,h,a,u)}evaluate(e,i,s,h,a,u){return this._styleExpression.evaluate(e,i,s,h,a,u)}interpolationFactor(e,i,s){return this.interpolationType?Br.interpolationFactor(this.interpolationType,e,i,s):0}}function Ju(r,e,i,s){if("error"===(r=ua(r,e,i,s)).result)return r;const h=r.value.expression,a=Fr(h);if(!a&&!Wl(e))return $r([new hi("","data expressions not supported")]);const u=sa(h,["zoom","pitch","distance-from-center"]);if(!u&&!el(e))return $r([new hi("","zoom expressions not supported")]);const x=sa(h,["measure-light"]);if(!x&&!Zu(e))return $r([new hi("","measure-light expression not supported")]);const T=sa(h,["line-progress"]);if(!T&&!Qa(e.expression,"line-progress"))return $r([new hi("","line-progress expression not supported")]);const C=e.expression&&e.expression.relaxZoomRestriction,g=zo(h);return g||u||C?g instanceof hi?$r([g]):g instanceof Br&&!tl(e)?$r([new hi("",'"interpolate" expressions cannot be used with this property')]):aa(g?new Zl(a&&T?"camera":"composite",r.value,g.labels,g instanceof Br?g.interpolation:void 0,x,T):new kc(a&&T?"constant":"source",r.value,x,T)):$r([new hi("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class io{constructor(e,i){this._parameters=e,this._specification=i,xo(this,la(this._parameters,this._specification))}static deserialize(e){return new io(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function zo(r){let e=null;if(r instanceof Ic)e=zo(r.result);else if(r instanceof Ac){for(const i of r.args)if(e=zo(i),e)break}else(r instanceof Ya||r instanceof Br)&&r.input instanceof Rn&&"zoom"===r.input.name&&(e=r);return e instanceof hi||r.eachChild(i=>{const s=zo(i);s instanceof hi?e=s:e&&s&&e!==s&&(e=new hi("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),e}var Oc,dr,Qu=function(){if(dr)return Oc;dr=1,Oc=e;var r=3;function e(i,s,h){var a=this.cells=[];if(i instanceof ArrayBuffer){this.arrayBuffer=i;var u=new Int32Array(this.arrayBuffer);i=u[0],this.d=(s=u[1])+2*(h=u[2]);for(var x=0;x<this.d*this.d;x++){var T=u[r+x],C=u[r+x+1];a.push(T===C?null:u.subarray(T,C))}var g=u[r+a.length+1];this.keys=u.subarray(u[r+a.length],g),this.bboxes=u.subarray(g),this.insert=this._insertReadonly}else{this.d=s+2*h;for(var S=0;S<this.d*this.d;S++)a.push([]);this.keys=[],this.bboxes=[]}this.n=s,this.extent=i,this.padding=h,this.scale=s/i,this.uid=0;var A=h/s*i;this.min=-A,this.max=i+A}return e.prototype.insert=function(i,s,h,a,u){this._forEachCell(s,h,a,u,this._insertCell,this.uid++),this.keys.push(i),this.bboxes.push(s),this.bboxes.push(h),this.bboxes.push(a),this.bboxes.push(u)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(i,s,h,a,u,x){this.cells[u].push(x)},e.prototype.query=function(i,s,h,a,u){var x=this.min,T=this.max;if(i<=x&&s<=x&&T<=h&&T<=a&&!u)return Array.prototype.slice.call(this.keys);var C=[];return this._forEachCell(i,s,h,a,this._queryCell,C,{},u),C},e.prototype._queryCell=function(i,s,h,a,u,x,T,C){var g=this.cells[u];if(null!==g)for(var S=this.keys,A=this.bboxes,w=0;w<g.length;w++){var M=g[w];if(void 0===T[M]){var P=4*M;(C?C(A[P+0],A[P+1],A[P+2],A[P+3]):i<=A[P+2]&&s<=A[P+3]&&h>=A[P+0]&&a>=A[P+1])?(T[M]=!0,x.push(S[M])):T[M]=!1}}},e.prototype._forEachCell=function(i,s,h,a,u,x,T,C){for(var g=this._convertToCellCoord(i),S=this._convertToCellCoord(s),A=this._convertToCellCoord(h),w=this._convertToCellCoord(a),M=g;M<=A;M++)for(var P=S;P<=w;P++){var O=this.d*P+M;if((!C||C(this._convertFromCellCoord(M),this._convertFromCellCoord(P),this._convertFromCellCoord(M+1),this._convertFromCellCoord(P+1)))&&u.call(this,i,s,h,a,O,x,T,C))return}},e.prototype._convertFromCellCoord=function(i){return(i-this.padding)/this.scale},e.prototype._convertToCellCoord=function(i){return Math.max(0,Math.min(this.d-1,Math.floor(i*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var i=this.cells,s=r+this.cells.length+1+1,h=0,a=0;a<this.cells.length;a++)h+=this.cells[a].length;var u=new Int32Array(s+h+this.keys.length+this.bboxes.length);u[0]=this.extent,u[1]=this.n,u[2]=this.padding;for(var x=s,T=0;T<i.length;T++){var C=i[T];u[r+T]=x,u.set(C,x),x+=C.length}return u[r+i.length]=x,u.set(this.keys,x),u[r+i.length+1]=x+=this.keys.length,u.set(this.bboxes,x),x+=this.bboxes.length,u.buffer},Oc}(),da=er(Qu);const pa={};function St(r,e,i={}){Object.defineProperty(r,"_classRegistryKey",{value:e,writable:!1}),pa[e]={klass:r,omit:i.omit||[]}}St(Object,"Object"),da.serialize=function(r,e){const i=r.toArrayBuffer();return e&&e.add(i),{buffer:i}},da.deserialize=function(r){return new da(r.buffer)},Object.defineProperty(da,"name",{value:"Grid"}),St(da,"Grid"),typeof DOMMatrix<"u"&&St(DOMMatrix,"DOMMatrix"),St(Ri,"Color"),St(Error,"Error"),St(cr,"Formatted"),St(bo,"FormattedSection"),St(yn,"AJAXError"),St(rr,"ResolvedImage"),St(io,"StylePropertyFunction"),St(Lc,"StyleExpression",{omit:["_evaluator"]}),St(Ds,"ImageIdWithOptions"),St(Zl,"ZoomDependentExpression"),St(kc,"ZoomConstantExpression"),St(Rn,"CompoundExpression",{omit:["_evaluate"]});for(const r in Hl)pa[Hl[r]._classRegistryKey]||St(Hl[r],`Expression${r}`);function Fc(r){return r&&typeof ArrayBuffer<"u"&&(r instanceof ArrayBuffer||r.constructor&&"ArrayBuffer"===r.constructor.name)}function Yh(r){return self.ImageBitmap&&r instanceof ImageBitmap}function no(r,e){if(null==r||"boolean"==typeof r||"number"==typeof r||"string"==typeof r||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp)return r;if(Fc(r)||Yh(r))return e&&e.add(r),r;if(ArrayBuffer.isView(r))return e&&e.add(r.buffer),r;if(r instanceof ImageData)return e&&e.add(r.data.buffer),r;if(Array.isArray(r)){const i=[];for(const s of r)i.push(no(s,e));return i}if(r instanceof Map){const i={$name:"Map"};for(const[s,h]of r.entries())i[s]=no(h);return i}if(r instanceof Set){const i={$name:"Set"};let s=0;for(const h of r.values())i[++s]=no(h);return i}if("object"==typeof r){const i=r.constructor,s=i._classRegistryKey;if(!s)throw new Error(`Can't serialize object of unregistered class "${s}".`);const h=i.serialize?i.serialize(r,e):{};if(!i.serialize){for(const a in r)r.hasOwnProperty(a)&&(pa[s].omit.indexOf(a)>=0||(h[a]=no(r[a],e)));r instanceof Error&&(h.message=r.message)}if(h.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==s&&(h.$name=s),h}throw new Error("can't serialize object of type "+typeof r)}function fa(r){if(null==r||"boolean"==typeof r||"number"==typeof r||"string"==typeof r||r instanceof Boolean||r instanceof Number||r instanceof String||r instanceof Date||r instanceof RegExp||Fc(r)||Yh(r)||ArrayBuffer.isView(r)||r instanceof ImageData)return r;if(Array.isArray(r))return r.map(fa);if("object"==typeof r){const e=r.$name||"Object";if("Map"===e){const h=new Map;for(const a of Object.keys(r))"$name"!==a&&h.set(a,fa(r[a]));return h}if("Set"===e){const h=new Set;for(const a of Object.keys(r))"$name"!==a&&h.add(fa(r[a]));return h}const{klass:i}=pa[e];if(!i)throw new Error(`Can't deserialize unregistered class "${e}".`);if(i.deserialize)return i.deserialize(r);const s=Object.create(i.prototype);for(const h of Object.keys(r))"$name"!==h&&(s[h]=fa(r[h]));return s}throw new Error("can't deserialize object of type "+typeof r)}const Ct_Latin_1_Supplement=r=>r>=128&&r<=255,Ct_Arabic=r=>r>=1536&&r<=1791,Ct_Arabic_Supplement=r=>r>=1872&&r<=1919,Ct_Arabic_Extended_A=r=>r>=2208&&r<=2303,Ct_Hangul_Jamo=r=>r>=4352&&r<=4607,Ct_Unified_Canadian_Aboriginal_Syllabics=r=>r>=5120&&r<=5759,Ct_Khmer=r=>r>=6016&&r<=6143,Ct_Unified_Canadian_Aboriginal_Syllabics_Extended=r=>r>=6320&&r<=6399,Ct_General_Punctuation=r=>r>=8192&&r<=8303,Ct_Letterlike_Symbols=r=>r>=8448&&r<=8527,Ct_Number_Forms=r=>r>=8528&&r<=8591,Ct_Miscellaneous_Technical=r=>r>=8960&&r<=9215,Ct_Control_Pictures=r=>r>=9216&&r<=9279,Ct_Optical_Character_Recognition=r=>r>=9280&&r<=9311,Ct_Enclosed_Alphanumerics=r=>r>=9312&&r<=9471,Ct_Geometric_Shapes=r=>r>=9632&&r<=9727,Ct_Miscellaneous_Symbols=r=>r>=9728&&r<=9983,Ct_Miscellaneous_Symbols_and_Arrows=r=>r>=11008&&r<=11263,Ct_CJK_Radicals_Supplement=r=>r>=11904&&r<=12031,Ct_Kangxi_Radicals=r=>r>=12032&&r<=12255,Ct_Ideographic_Description_Characters=r=>r>=12272&&r<=12287,Ct_CJK_Symbols_and_Punctuation=r=>r>=12288&&r<=12351,Ct_Hiragana=r=>r>=12352&&r<=12447,Ct_Katakana=r=>r>=12448&&r<=12543,Ct_Bopomofo=r=>r>=12544&&r<=12591,Ct_Hangul_Compatibility_Jamo=r=>r>=12592&&r<=12687,Ct_Kanbun=r=>r>=12688&&r<=12703,Ct_Bopomofo_Extended=r=>r>=12704&&r<=12735,Ct_CJK_Strokes=r=>r>=12736&&r<=12783,Ct_Katakana_Phonetic_Extensions=r=>r>=12784&&r<=12799,Ct_Enclosed_CJK_Letters_and_Months=r=>r>=12800&&r<=13055,Ct_CJK_Compatibility=r=>r>=13056&&r<=13311,Ct_CJK_Unified_Ideographs_Extension_A=r=>r>=13312&&r<=19903,Ct_Yijing_Hexagram_Symbols=r=>r>=19904&&r<=19967,Ct_CJK_Unified_Ideographs=r=>r>=19968&&r<=40959,Ct_Yi_Syllables=r=>r>=40960&&r<=42127,Ct_Yi_Radicals=r=>r>=42128&&r<=42191,Ct_Hangul_Jamo_Extended_A=r=>r>=43360&&r<=43391,Ct_Hangul_Syllables=r=>r>=44032&&r<=55215,Ct_Hangul_Jamo_Extended_B=r=>r>=55216&&r<=55295,Ct_Private_Use_Area=r=>r>=57344&&r<=63743,Ct_CJK_Compatibility_Ideographs=r=>r>=63744&&r<=64255,Ct_Arabic_Presentation_Forms_A=r=>r>=64336&&r<=65023,Ct_Vertical_Forms=r=>r>=65040&&r<=65055,Ct_CJK_Compatibility_Forms=r=>r>=65072&&r<=65103,Ct_Small_Form_Variants=r=>r>=65104&&r<=65135,Ct_Arabic_Presentation_Forms_B=r=>r>=65136&&r<=65279,Ct_Halfwidth_and_Fullwidth_Forms=r=>r>=65280&&r<=65519,Ct_Osage=r=>r>=66736&&r<=66815,Ct_CJK_Unified_Ideographs_Extension_B=r=>r>=131072&&r<=173791;function Kh(r){for(const e of r)if(Nc(e.charCodeAt(0)))return!0;return!1}function Bc(r){for(const e of r)if(!Vd(e.charCodeAt(0)))return!1;return!0}function Vd(r){return!(Ct_Arabic(r)||Ct_Arabic_Supplement(r)||Ct_Arabic_Extended_A(r)||Ct_Arabic_Presentation_Forms_A(r)||Ct_Arabic_Presentation_Forms_B(r))}function Nc(r){return!(746!==r&&747!==r&&(r<4352||!(Ct_Bopomofo_Extended(r)||Ct_Bopomofo(r)||Ct_CJK_Compatibility_Forms(r)&&!(r>=65097&&r<=65103)||Ct_CJK_Compatibility_Ideographs(r)||Ct_CJK_Compatibility(r)||Ct_CJK_Radicals_Supplement(r)||Ct_CJK_Strokes(r)||!(!Ct_CJK_Symbols_and_Punctuation(r)||r>=12296&&r<=12305||r>=12308&&r<=12319||12336===r)||Ct_CJK_Unified_Ideographs_Extension_A(r)||Ct_CJK_Unified_Ideographs(r)||Ct_Enclosed_CJK_Letters_and_Months(r)||Ct_Hangul_Compatibility_Jamo(r)||Ct_Hangul_Jamo_Extended_A(r)||Ct_Hangul_Jamo_Extended_B(r)||Ct_Hangul_Jamo(r)||Ct_Hangul_Syllables(r)||Ct_Hiragana(r)||Ct_Ideographic_Description_Characters(r)||Ct_Kanbun(r)||Ct_Kangxi_Radicals(r)||Ct_Katakana_Phonetic_Extensions(r)||Ct_Katakana(r)&&12540!==r||!(!Ct_Halfwidth_and_Fullwidth_Forms(r)||65288===r||65289===r||65293===r||r>=65306&&r<=65310||65339===r||65341===r||65343===r||r>=65371&&r<=65503||65507===r||r>=65512&&r<=65519)||!(!Ct_Small_Form_Variants(r)||r>=65112&&r<=65118||r>=65123&&r<=65126)||Ct_Unified_Canadian_Aboriginal_Syllabics(r)||Ct_Unified_Canadian_Aboriginal_Syllabics_Extended(r)||Ct_Vertical_Forms(r)||Ct_Yijing_Hexagram_Symbols(r)||Ct_Yi_Syllables(r)||Ct_Yi_Radicals(r))))}function ma(r){return!(Nc(r)||(e=r,Ct_Latin_1_Supplement(e)&&(167===e||169===e||174===e||177===e||188===e||189===e||190===e||215===e||247===e)||Ct_General_Punctuation(e)&&(8214===e||8224===e||8225===e||8240===e||8241===e||8251===e||8252===e||8258===e||8263===e||8264===e||8265===e||8273===e)||Ct_Letterlike_Symbols(e)||Ct_Number_Forms(e)||Ct_Miscellaneous_Technical(e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||9003===e||e>=9085&&e<=9114||e>=9150&&e<=9165||9167===e||e>=9169&&e<=9179||e>=9186&&e<=9215)||Ct_Control_Pictures(e)&&9251!==e||Ct_Optical_Character_Recognition(e)||Ct_Enclosed_Alphanumerics(e)||Ct_Geometric_Shapes(e)||Ct_Miscellaneous_Symbols(e)&&!(e>=9754&&e<=9759)||Ct_Miscellaneous_Symbols_and_Arrows(e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||Ct_CJK_Symbols_and_Punctuation(e)||Ct_Katakana(e)||Ct_Private_Use_Area(e)||Ct_CJK_Compatibility_Forms(e)||Ct_Small_Form_Variants(e)||Ct_Halfwidth_and_Fullwidth_Forms(e)||8734===e||8756===e||8757===e||e>=9984&&e<=10087||e>=10102&&e<=10131||65532===e||65533===e));var e}function Vc(r){return r>=1424&&r<=2303||Ct_Arabic_Presentation_Forms_A(r)||Ct_Arabic_Presentation_Forms_B(r)}function Jh(r,e){return!(!e&&Vc(r)||r>=2304&&r<=3583||r>=3840&&r<=4255||Ct_Khmer(r))}function Qh(r){for(const e of r)if(Vc(e.charCodeAt(0)))return!0;return!1}const Xl="deferred",Uc="loading",Yl="loaded";let jc=null,Nr="unavailable",Ro=null;const xs=function(r){r&&"string"==typeof r&&r.indexOf("NetworkError")>-1&&(Nr="error"),jc&&jc(r)};function eu(){il.fire(new Hr("pluginStateChange",{pluginStatus:Nr,pluginURL:Ro}))}const il=new Is,Gc=function(){return Nr},Kl=function(){if(Nr!==Xl||!Ro)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Nr=Uc,eu(),Ro&&Nn({url:Ro},r=>{r?xs(r):(Nr=Yl,eu())})},Zr={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Nr===Yl||null!=Zr.applyArabicShaping,isLoading:()=>Nr===Uc,setState(r){Nr=r.pluginStatus,Ro=r.pluginURL},isParsed:()=>null!=Zr.applyArabicShaping&&null!=Zr.processBidirectionalText&&null!=Zr.processStyledBidirectionalText,getPluginURL:()=>Ro};class Zi{constructor(e,i){this.zoom=e,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return function(i,s){for(const h of i)if(!Jh(h.charCodeAt(0),s))return!1;return!0}(e,Zr.isLoaded())}}class qc{constructor(e,i,s,h){this.property=e,this.value=i,this.expression=function(a,u,x,T){if(Xh(a))return new io(a,u);if(ha(a)||Array.isArray(a)&&a.length>0){const C=Ju(a,u,x,T);if("error"===C.result)throw new Error(C.value.map(g=>`${g.key}: ${g.message}`).join(", "));return C.value}{let C=a;return"string"==typeof a&&"color"===u.type&&(C=Ri.parse(a)),{kind:"constant",configDependencies:new Set,evaluate:()=>C}}}(void 0===i?e.specification.default:i,e.specification,s,h)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(e,i,s){return this.property.possiblyEvaluate(this,e,i,s)}}class Jl{constructor(e,i,s){this.property=e,this.value=new qc(e,void 0,i,s)}transitioned(e,i){return new Hc(this.property,this.value,i,Hi({},e.transition,this.transition),e.now)}untransitioned(){return new Hc(this.property,this.value,null,{},0)}}class Ql{constructor(e,i,s){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=i,this._options=s,this.configDependencies=new Set}getValue(e){return vr(this._values[e].value.value)}setValue(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new Jl(this._values[e].property,this._scope,this._options)),this._values[e].value=new qc(this._values[e].property,null===i?void 0:vr(i),this._scope,this._options),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]))}setTransitionOrValue(e,i){i&&(this._options=i);const s=this._properties.properties;if(e)for(const h in e){const a=e[h];if(Bi(h,"-transition")){const u=h.slice(0,-11);s[u]&&this.setTransition(u,a)}else s.hasOwnProperty(h)&&this.setValue(h,a)}}getTransition(e){return vr(this._values[e].transition)}setTransition(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new Jl(this._values[e].property)),this._values[e].transition=vr(i)||void 0}serialize(){const e={};for(const i of Object.keys(this._values)){const s=this.getValue(i);void 0!==s&&(e[i]=s);const h=this.getTransition(i);void 0!==h&&(e[`${i}-transition`]=h)}return e}transitioned(e,i){const s=new nl(this._properties);for(const h of Object.keys(this._values))s._values[h]=this._values[h].transitioned(e,i._values[h]);return s}untransitioned(){const e=new nl(this._properties);for(const i of Object.keys(this._values))e._values[i]=this._values[i].untransitioned();return e}}class Hc{constructor(e,i,s,h,a){const u=h.delay||0,x=h.duration||0;a=a||0,this.property=e,this.value=i,this.begin=a+u,this.end=this.begin+x,e.specification.transition&&(h.delay||h.duration)&&(this.prior=s)}possiblyEvaluate(e,i,s){const h=e.now||0,a=this.value.possiblyEvaluate(e,i,s),u=this.prior;if(u){if(h>this.end)return this.prior=null,a;if(this.value.isDataDriven())return this.prior=null,a;if(h<this.begin)return u.possiblyEvaluate(e,i,s);{const x=(h-this.begin)/(this.end-this.begin);return this.property.interpolate(u.possiblyEvaluate(e,i,s),a,Gr(x))}}return a}}class nl{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,i,s){const h=new Ls(this._properties);for(const a of Object.keys(this._values))h._values[a]=this._values[a].possiblyEvaluate(e,i,s);return h}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class rl{constructor(e,i,s){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=i,this._options=s,this.configDependencies=new Set}getValue(e){return vr(this._values[e].value)}setValue(e,i){this._values[e]=new qc(this._values[e].property,null===i?void 0:vr(i),this._scope,this._options),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]))}serialize(){const e={};for(const i of Object.keys(this._values)){const s=this.getValue(i);void 0!==s&&(e[i]=s)}return e}possiblyEvaluate(e,i,s){const h=new Ls(this._properties);for(const a of Object.keys(this._values))h._values[a]=this._values[a].possiblyEvaluate(e,i,s);return h}}class sl{constructor(e,i,s){this.property=e,this.value=i,this.parameters=s}isConstant(){return"constant"===this.value.kind}constantOr(e){return"constant"===this.value.kind?this.value.value:e}evaluate(e,i,s,h){return this.property.evaluate(this.value,this.parameters,e,i,s,h)}}class Ls{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class at{constructor(e){this.specification=e}possiblyEvaluate(e,i){return e.expression.evaluate(i)}interpolate(e,i,s){const h=xc[this.specification.type];return h?h(e,i,s):e}}class bt{constructor(e,i){this.specification=e,this.overrides=i}possiblyEvaluate(e,i,s,h){return new sl(this,"constant"===e.expression.kind||"camera"===e.expression.kind?{kind:"constant",value:e.expression.evaluate(i,null,{},s,h)}:e.expression,i)}interpolate(e,i,s){if("constant"!==e.value.kind||"constant"!==i.value.kind)return e;if(void 0===e.value.value||void 0===i.value.value)return new sl(this,{kind:"constant",value:void 0},e.parameters);const h=xc[this.specification.type];return h?new sl(this,{kind:"constant",value:h(e.value.value,i.value.value,s)},e.parameters):e}evaluate(e,i,s,h,a,u){return"constant"===e.kind?e.value:e.evaluate(i,s,h,a,u)}}class ol{constructor(e){this.specification=e}possiblyEvaluate(e,i,s,h){return!!e.expression.evaluate(i,null,{},s,h)}interpolate(){return!1}}class cn{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const i=new Zi(0,{});for(const s in e){const h=e[s];h.specification.overridable&&this.overridableProperties.push(s);const a=this.defaultPropertyValues[s]=new qc(h,void 0),u=this.defaultTransitionablePropertyValues[s]=new Jl(h);this.defaultTransitioningPropertyValues[s]=u.untransitioned(),this.defaultPossiblyEvaluatedValues[s]=a.possiblyEvaluate(i)}}}St(bt,"DataDrivenProperty"),St(at,"DataConstantProperty"),St(ol,"ColorRampProperty");var Ne=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"required":false,"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow","experimental":true},"rain":{"type":"rain","experimental":true},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor","experimental":true},"imports":{"type":"array","value":"import"},"schema":{"type":"schema"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"experimental":true,"type":"featuresets"}},"featuresets":{"experimental":true,"*":{"type":"featureset"}},"featureset":{"experimental":true,"metadata":{"experimental":true,"type":"*"},"selectors":{"experimental":true,"type":"array","value":"selector"}},"selector":{"experimental":true,"layer":{"experimental":true,"type":"string","required":true},"properties":{"experimental":true,"type":"selectorProperty","required":false},"featureNamespace":{"experimental":true,"type":"string","required":false},"_uniqueFeatureID":{"experimental":true,"type":"boolean","private":true,"required":false}},"selectorProperty":{"experimental":true,"*":{"experimental":true,"type":"*"}},"model":{"type":"string","required":true},"import":{"id":{"type":"string","required":true},"url":{"type":"string","required":true},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","property-type":"data-constant","expression":{},"required":true},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string","required":true},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false,"property-type":"data-constant"},"shadow-quality":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]},"experimental":true},"shadow-intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"experimental":true,"type":{"required":true,"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":1}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":1}},"url":{"required":false,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"required":true,"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"raster-particle":{"experimental":true},"hillshade":{},"model":{"experimental":true},"background":{},"sky":{},"slot":{},"clip":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{},"property-type":"data-constant"},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{},"property-type":"data-constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","experimental":true,"private":true,"expression":{},"property-type":"data-constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"fill-extrusion-edge-radius":{"type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","experimental":true,"default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","experimental":true,"expression":{},"property-type":"data-constant"},"line-cross-slope":{"type":"number","experimental":true,"expression":{},"property-type":"constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","experimental":true,"private":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","experimental":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"experimental":true,"private":true,"expression":{},"property-type":"data-constant"},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{},"property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"high-color":{"type":"color","property-type":"data-constant","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"space-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":"#ffffff","experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.4,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","property-type":"data-constant","default":0.71,"minimum":0,"maximum":5,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"opacity":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","property-type":"data-constant","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","property-type":"data-constant","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"center-thinning":{"type":"number","property-type":"data-constant","default":0.57,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","property-type":"data-constant","transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","property-type":"data-constant","default":0.7,"minimum":0,"maximum":1,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective","property-type":"data-constant"}},"colorTheme":{"data":{"type":"string","property-type":"data-constant","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}},"buildingFeaturesetId":{"type":"string","experimental":true,"property-type":"data-constant","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"property-type":"data-constant","expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"flat","property-type":"data-constant"},"fill-extrusion-base-alignment":{"type":"enum","experimental":true,"values":{"terrain":1,"flat":1},"default":"terrain","property-type":"data-constant"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-ambient-occlusion-intensity":{"property-type":"data-constant","type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"property-type":"data-constant","type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"property-type":"data-constant","type":"number","experimental":true,"default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"property-type":"data-constant","type":"color","experimental":true,"default":"#ffffff","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"property-type":"data-constant","type":"number","experimental":true,"default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","experimental":true,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"property-type":"data-constant","type":"number","experimental":true,"default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"property-type":"data-constant","type":"number","experimental":true,"default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"property-type":"data-constant","type":"boolean","default":true,"experimental":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-gradient":{"type":"color","expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"property-type":"constant"},"line-trim-fade-range":{"type":"array","value":"number","experimental":true,"length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-trim-color":{"type":"color","experimental":true,"default":"transparent","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"line-border-width":{"type":"number","private":true,"default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","private":true,"default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true,"property-type":"data-constant"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-image-cross-fade":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"transition":true},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-value"]},"property-type":"color-ramp"},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"raster-array-band":{"type":"string","required":false,"experimental":true,"property-type":"data-constant"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"experimental":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string","required":false,"property-type":"data-constant"},"raster-particle-count":{"type":"number","default":512,"minimum":1,"property-type":"data-constant"},"raster-particle-color":{"type":"color","expression":{"interpolated":true,"parameters":["raster-particle-speed"]},"property-type":"color-ramp"},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1,"property-type":"data-constant"},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1,"property-type":"data-constant"},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]},"experimental":true,"property-type":"data-constant"},"background-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d","property-type":"data-constant"},"model-cast-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-receive-shadows":{"type":"boolean","default":true,"property-type":"data-constant"},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant","transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{},"property-type":"data-constant"},"model-front-cutoff":{"type":"array","private":true,"value":"number","property-type":"data-constant","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"property-type":{"data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"*"}}}');function Lo(r){return r instanceof Number||r instanceof String||r instanceof Boolean?r.valueOf():r}function _a(r){if(Array.isArray(r))return r.map(_a);if(r instanceof Object&&!(r instanceof Number||r instanceof String||r instanceof Boolean)){const e={};for(const i in r)e[i]=_a(r[i]);return e}return Lo(r)}function tu(r){if(!0===r||!1===r)return!0;if(!Array.isArray(r)||0===r.length)return!1;switch(r[0]){case"has":return r.length>=2&&"$id"!==r[1]&&"$type"!==r[1];case"in":return r.length>=3&&("string"!=typeof r[1]||Array.isArray(r[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==r.length||Array.isArray(r[1])||Array.isArray(r[2]);case"any":case"all":for(const e of r.slice(1))if(!tu(e)&&"boolean"!=typeof e)return!1;return!0;default:return!0}}function ed(r,e="",i=null,s="fill"){if(null==r)return{filter:()=>!0,needGeometry:!1,needFeature:!1};tu(r)||(r=Wc(r));const h=r;let a=!0;try{a=function(g){if(!Cr(g))return g;let S=_a(g);return id(S),S=td(S),S}(h)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(h,null,2)}\n        `)}let u=null,x=null;if("background"!==s&&"sky"!==s&&"slot"!==s){x=Ne[`filter_${s}`];const g=ua(a,x,e,i);if("error"===g.result)throw new Error(g.value.map(S=>`${S.key}: ${S.message}`).join(", "));u=(S,A,w)=>g.value.evaluate(S,A,{},w)}let T=null,C=null;if(a!==h){const g=ua(h,x,e,i);if("error"===g.result)throw new Error(g.value.map(S=>`${S.key}: ${S.message}`).join(", "));T=(S,A,w,M,P)=>g.value.evaluate(S,A,{},w,void 0,void 0,M,P),C=!Fr(g.value.expression)}return{filter:u,dynamicFilter:T||void 0,needGeometry:nd(a),needFeature:!!C}}function td(r){if(!Array.isArray(r))return r;const e=function(i){if(Ud.has(i[0]))for(let s=1;s<i.length;s++)if(Cr(i[s]))return!0;return i}(r);return!0===e?e:e.map(i=>td(i))}function id(r){let e=!1;const i=[];if("case"===r[0]){for(let s=1;s<r.length-1;s+=2)e=e||Cr(r[s]),i.push(r[s+1]);i.push(r[r.length-1])}else if("match"===r[0]){e=e||Cr(r[1]);for(let s=2;s<r.length-1;s+=2)i.push(r[s+1]);i.push(r[r.length-1])}else if("step"===r[0]){e=e||Cr(r[1]);for(let s=1;s<r.length-1;s+=2)i.push(r[s+1])}e&&(r.length=0,r.push("any",...i));for(let s=1;s<r.length;s++)id(r[s])}function Cr(r){if(!Array.isArray(r))return!1;if("pitch"===(e=r[0])||"distance-from-center"===e)return!0;var e;for(let i=1;i<r.length;i++)if(Cr(r[i]))return!0;return!1}const Ud=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function jd(r,e){return r<e?-1:r>e?1:0}function nd(r){if(!Array.isArray(r))return!1;if("within"===r[0]||"distance"===r[0])return!0;for(let e=1;e<r.length;e++)if(nd(r[e]))return!0;return!1}function Wc(r){if(!r)return!0;const e=r[0];return r.length<=1?"any"!==e:"=="===e?ko(r[1],r[2],"=="):"!="===e?ga(ko(r[1],r[2],"==")):"<"===e||">"===e||"<="===e||">="===e?ko(r[1],r[2],e):"any"===e?(i=r.slice(1),["any"].concat(i.map(Wc))):"all"===e?["all"].concat(r.slice(1).map(Wc)):"none"===e?["all"].concat(r.slice(1).map(Wc).map(ga)):"in"===e?ec(r[1],r.slice(2)):"!in"===e?ga(ec(r[1],r.slice(2))):"has"===e?iu(r[1]):"!has"!==e||ga(iu(r[1]));var i}function ko(r,e,i){switch(r){case"$type":return[`filter-type-${i}`,e];case"$id":return[`filter-id-${i}`,e];default:return[`filter-${i}`,r,e]}}function ec(r,e){if(0===e.length)return!1;switch(r){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some(i=>typeof i!=typeof e[0])?["filter-in-large",r,["literal",e.sort(jd)]]:["filter-in-small",r,["literal",e]]}}function iu(r){switch(r){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",r]}}function ga(r){return["!",r]}function ks(r,e){return e?`${r}\x1f${e}`:r}const vs="-transition",nu=new Set(["fill","line","background","hillshade","raster"]);class Wn extends Is{constructor(e,i,s,h,a){if(super(),this.id=e.id,this.fqid=ks(this.id,s),this.type=e.type,this.scope=s,this.lut=h,this.options=a,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,"custom"!==e.type){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&"background"!==e.type&&"sky"!==e.type&&"slot"!==e.type){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;const u=ua(this.filter,Ne[`filter_${e.type}`]);"error"!==u.result&&(this.configDependencies=new Set([...this.configDependencies,...u.value.configDependencies]))}if(e.slot&&(this.slot=e.slot),i.layout&&(this._unevaluatedLayout=new rl(i.layout,this.scope,a),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),i.paint){this._transitionablePaint=new Ql(i.paint,this.scope,a);for(const u in e.paint)this.setPaintProperty(u,e.paint[u]);for(const u in e.layout)this.setLayoutProperty(u,e.layout[u]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Ls(i.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D()&&nu.has(this.type)}getLayoutProperty(e){return"visibility"===e?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,i){if("custom"===this.type&&"visibility"===e)return void(this.visibility=i);const s=this._unevaluatedLayout;s._properties.properties[e]&&(s.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...s.configDependencies]),"visibility"===e&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return Bi(e,vs)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,i){const s=this._transitionablePaint,h=s._properties.properties;if(Bi(e,vs)){const S=e.slice(0,-11);return h[S]&&s.setTransition(S,i||void 0),!1}if(!h[e])return!1;const a=s._values[e],u=a.value.isDataDriven(),x=a.value;s.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...s.configDependencies]),this._handleSpecialPaintPropertyUpdate(e);const T=s._values[e].value,C=T.isDataDriven(),g=Bi(e,"pattern")||"line-dasharray"===e;return C||u||g||this._handleOverridablePaintPropertyUpdate(e,x,T)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,i,s){return null}_handleOverridablePaintPropertyUpdate(e,i,s){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||"none"===this.visibility}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,i)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,i)}serialize(){return Zs({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},(e,i)=>!(void 0===e||"layout"===i&&!Object.keys(e).length||"paint"===i&&!Object.keys(e).length))}is3D(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}isStateDependent(){for(const e in this.paint._values){const i=this.paint.get(e);if(i instanceof sl&&Wl(i.property.specification)&&("source"===i.value.kind||"composite"===i.value.kind)&&i.value.isStateDependent)return!0}return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=ed(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&("shadow"===e.renderPass?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,i,s,h,a,u,x,T,C){}}const Gd={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class al{constructor(e,i){this._structArray=e,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Ji{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(e,i){return e._trim(),i&&(e.isTransferred=!0,i.add(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const i=Object.create(this.prototype);return i.arrayBuffer=e.arrayBuffer,i.length=e.length,i.capacity=e.arrayBuffer.byteLength/i.bytesPerElement,i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function Li(r,e=1){let i=0,s=0;return{members:r.map(h=>{const a=Gd[h.type].BYTES_PER_ELEMENT,u=i=ru(i,Math.max(e,a)),x=h.components||1;return s=Math.max(s,a),i+=a*x,{name:h.name,type:h.type,components:x,offset:u}}),size:ru(i,Math.max(s,e)),alignment:e}}function ru(r,e){return Math.ceil(r/e)*e}class Os extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const h=2*e;return this.int16[h+0]=i,this.int16[h+1]=s,e}}Os.prototype.bytesPerElement=4,St(Os,"StructArrayLayout2i4");class ro extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s)}emplace(e,i,s,h){const a=3*e;return this.int16[a+0]=i,this.int16[a+1]=s,this.int16[a+2]=h,e}}ro.prototype.bytesPerElement=6,St(ro,"StructArrayLayout3i6");class Xr extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,h){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s,h)}emplace(e,i,s,h,a){const u=4*e;return this.int16[u+0]=i,this.int16[u+1]=s,this.int16[u+2]=h,this.int16[u+3]=a,e}}Xr.prototype.bytesPerElement=8,St(Xr,"StructArrayLayout4i8");class $c extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,h,a)}emplace(e,i,s,h,a,u){const x=5*e;return this.int16[x+0]=i,this.int16[x+1]=s,this.int16[x+2]=h,this.int16[x+3]=a,this.int16[x+4]=u,e}}$c.prototype.bytesPerElement=10,St($c,"StructArrayLayout5i10");class ll extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a,u,x){const T=this.length;return this.resize(T+1),this.emplace(T,e,i,s,h,a,u,x)}emplace(e,i,s,h,a,u,x,T){const C=6*e,g=12*e,S=3*e;return this.int16[C+0]=i,this.int16[C+1]=s,this.uint8[g+4]=h,this.uint8[g+5]=a,this.uint8[g+6]=u,this.uint8[g+7]=x,this.float32[S+2]=T,e}}ll.prototype.bytesPerElement=12,St(ll,"StructArrayLayout2i4ub1f12");class Fs extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s)}emplace(e,i,s,h){const a=3*e;return this.float32[a+0]=i,this.float32[a+1]=s,this.float32[a+2]=h,e}}Fs.prototype.bytesPerElement=12,St(Fs,"StructArrayLayout3f12");class pr extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,h,a)}emplace(e,i,s,h,a,u){const x=6*e,T=3*e;return this.uint16[x+0]=i,this.uint16[x+1]=s,this.uint16[x+2]=h,this.uint16[x+3]=a,this.float32[T+2]=u,e}}pr.prototype.bytesPerElement=12,St(pr,"StructArrayLayout4ui1f12");class Zc extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,h){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s,h)}emplace(e,i,s,h,a){const u=4*e;return this.uint16[u+0]=i,this.uint16[u+1]=s,this.uint16[u+2]=h,this.uint16[u+3]=a,e}}Zc.prototype.bytesPerElement=8,St(Zc,"StructArrayLayout4ui8");class ic extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a,u){const x=this.length;return this.resize(x+1),this.emplace(x,e,i,s,h,a,u)}emplace(e,i,s,h,a,u,x){const T=6*e;return this.int16[T+0]=i,this.int16[T+1]=s,this.int16[T+2]=h,this.int16[T+3]=a,this.int16[T+4]=u,this.int16[T+5]=x,e}}ic.prototype.bytesPerElement=12,St(ic,"StructArrayLayout6i12");class Xc extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a,u,x,T,C,g,S,A){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,s,h,a,u,x,T,C,g,S,A)}emplace(e,i,s,h,a,u,x,T,C,g,S,A,w){const M=12*e;return this.int16[M+0]=i,this.int16[M+1]=s,this.int16[M+2]=h,this.int16[M+3]=a,this.uint16[M+4]=u,this.uint16[M+5]=x,this.uint16[M+6]=T,this.uint16[M+7]=C,this.int16[M+8]=g,this.int16[M+9]=S,this.int16[M+10]=A,this.int16[M+11]=w,e}}Xc.prototype.bytesPerElement=24,St(Xc,"StructArrayLayout4i4ui4i24");class Yc extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a,u){const x=this.length;return this.resize(x+1),this.emplace(x,e,i,s,h,a,u)}emplace(e,i,s,h,a,u,x){const T=10*e,C=5*e;return this.int16[T+0]=i,this.int16[T+1]=s,this.int16[T+2]=h,this.float32[C+2]=a,this.float32[C+3]=u,this.float32[C+4]=x,e}}Yc.prototype.bytesPerElement=20,St(Yc,"StructArrayLayout3i3f20");class Oo extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,h){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s,h)}emplace(e,i,s,h,a){const u=4*e;return this.float32[u+0]=i,this.float32[u+1]=s,this.float32[u+2]=h,this.float32[u+3]=a,e}}Oo.prototype.bytesPerElement=16,St(Oo,"StructArrayLayout4f16");class su extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint32[1*e+0]=i,e}}su.prototype.bytesPerElement=4,St(su,"StructArrayLayout1ul4");class so extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const h=2*e;return this.uint16[h+0]=i,this.uint16[h+1]=s,e}}so.prototype.bytesPerElement=4,St(so,"StructArrayLayout2ui4");class cl extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a,u,x,T,C,g,S,A,w){const M=this.length;return this.resize(M+1),this.emplace(M,e,i,s,h,a,u,x,T,C,g,S,A,w)}emplace(e,i,s,h,a,u,x,T,C,g,S,A,w,M){const P=20*e,O=10*e;return this.int16[P+0]=i,this.int16[P+1]=s,this.int16[P+2]=h,this.int16[P+3]=a,this.int16[P+4]=u,this.float32[O+3]=x,this.float32[O+4]=T,this.float32[O+5]=C,this.float32[O+6]=g,this.int16[P+14]=S,this.uint32[O+8]=A,this.uint16[P+18]=w,this.uint16[P+19]=M,e}}cl.prototype.bytesPerElement=40,St(cl,"StructArrayLayout5i4f1i1ul2ui40");class nc extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a,u,x){const T=this.length;return this.resize(T+1),this.emplace(T,e,i,s,h,a,u,x)}emplace(e,i,s,h,a,u,x,T){const C=8*e;return this.int16[C+0]=i,this.int16[C+1]=s,this.int16[C+2]=h,this.int16[C+4]=a,this.int16[C+5]=u,this.int16[C+6]=x,this.int16[C+7]=T,e}}nc.prototype.bytesPerElement=16,St(nc,"StructArrayLayout3i2i2i16");class ou extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,h,a)}emplace(e,i,s,h,a,u){const x=4*e,T=8*e;return this.float32[x+0]=i,this.float32[x+1]=s,this.float32[x+2]=h,this.int16[T+6]=a,this.int16[T+7]=u,e}}ou.prototype.bytesPerElement=16,St(ou,"StructArrayLayout2f1f2i16");class au extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a,u){const x=this.length;return this.resize(x+1),this.emplace(x,e,i,s,h,a,u)}emplace(e,i,s,h,a,u,x){const T=20*e,C=5*e;return this.uint8[T+0]=i,this.uint8[T+1]=s,this.float32[C+1]=h,this.float32[C+2]=a,this.float32[C+3]=u,this.float32[C+4]=x,e}}au.prototype.bytesPerElement=20,St(au,"StructArrayLayout2ub4f20");class Ln extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,s)}emplace(e,i,s,h){const a=3*e;return this.uint16[a+0]=i,this.uint16[a+1]=s,this.uint16[a+2]=h,e}}Ln.prototype.bytesPerElement=6,St(Ln,"StructArrayLayout3ui6");class lu extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a,u,x,T,C,g,S,A,w,M,P,O,B,G,q,U,W){const X=this.length;return this.resize(X+1),this.emplace(X,e,i,s,h,a,u,x,T,C,g,S,A,w,M,P,O,B,G,q,U,W)}emplace(e,i,s,h,a,u,x,T,C,g,S,A,w,M,P,O,B,G,q,U,W,X){const ee=30*e,ae=15*e,oe=60*e;return this.int16[ee+0]=i,this.int16[ee+1]=s,this.int16[ee+2]=h,this.float32[ae+2]=a,this.float32[ae+3]=u,this.uint16[ee+8]=x,this.uint16[ee+9]=T,this.uint32[ae+5]=C,this.uint32[ae+6]=g,this.uint32[ae+7]=S,this.uint16[ee+16]=A,this.uint16[ee+17]=w,this.uint16[ee+18]=M,this.float32[ae+10]=P,this.float32[ae+11]=O,this.uint8[oe+48]=B,this.uint8[oe+49]=G,this.uint8[oe+50]=q,this.uint32[ae+13]=U,this.int16[ee+28]=W,this.uint8[oe+58]=X,e}}lu.prototype.bytesPerElement=60,St(lu,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class rc extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a,u,x,T,C,g,S,A,w,M,P,O,B,G,q,U,W,X,ee,ae,oe,se,ye,le,ve,Se,we,Ae){const Pe=this.length;return this.resize(Pe+1),this.emplace(Pe,e,i,s,h,a,u,x,T,C,g,S,A,w,M,P,O,B,G,q,U,W,X,ee,ae,oe,se,ye,le,ve,Se,we,Ae)}emplace(e,i,s,h,a,u,x,T,C,g,S,A,w,M,P,O,B,G,q,U,W,X,ee,ae,oe,se,ye,le,ve,Se,we,Ae,Pe){const ke=20*e,Ce=40*e,Ze=80*e;return this.float32[ke+0]=i,this.float32[ke+1]=s,this.int16[Ce+4]=h,this.int16[Ce+5]=a,this.int16[Ce+6]=u,this.int16[Ce+7]=x,this.int16[Ce+8]=T,this.int16[Ce+9]=C,this.int16[Ce+10]=g,this.int16[Ce+11]=S,this.int16[Ce+12]=A,this.uint16[Ce+13]=w,this.uint16[Ce+14]=M,this.uint16[Ce+15]=P,this.uint16[Ce+16]=O,this.uint16[Ce+17]=B,this.uint16[Ce+18]=G,this.uint16[Ce+19]=q,this.uint16[Ce+20]=U,this.uint16[Ce+21]=W,this.uint16[Ce+22]=X,this.uint16[Ce+23]=ee,this.uint16[Ce+24]=ae,this.uint16[Ce+25]=oe,this.uint16[Ce+26]=se,this.uint16[Ce+27]=ye,this.uint32[ke+14]=le,this.float32[ke+15]=ve,this.float32[ke+16]=Se,this.float32[ke+17]=we,this.float32[ke+18]=Ae,this.uint8[Ze+76]=Pe,e}}rc.prototype.bytesPerElement=80,St(rc,"StructArrayLayout2f9i15ui1ul4f1ub80");class hl extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.float32[1*e+0]=i,e}}hl.prototype.bytesPerElement=4,St(hl,"StructArrayLayout1f4");class Fo extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a){const u=this.length;return this.resize(u+1),this.emplace(u,e,i,s,h,a)}emplace(e,i,s,h,a,u){const x=5*e;return this.float32[x+0]=i,this.float32[x+1]=s,this.float32[x+2]=h,this.float32[x+3]=a,this.float32[x+4]=u,e}}Fo.prototype.bytesPerElement=20,St(Fo,"StructArrayLayout5f20");class Kc extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a,u,x){const T=this.length;return this.resize(T+1),this.emplace(T,e,i,s,h,a,u,x)}emplace(e,i,s,h,a,u,x,T){const C=7*e;return this.float32[C+0]=i,this.float32[C+1]=s,this.float32[C+2]=h,this.float32[C+3]=a,this.float32[C+4]=u,this.float32[C+5]=x,this.float32[C+6]=T,e}}Kc.prototype.bytesPerElement=28,St(Kc,"StructArrayLayout7f28");class Bs extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a,u,x,T,C,g,S){const A=this.length;return this.resize(A+1),this.emplace(A,e,i,s,h,a,u,x,T,C,g,S)}emplace(e,i,s,h,a,u,x,T,C,g,S,A){const w=11*e;return this.float32[w+0]=i,this.float32[w+1]=s,this.float32[w+2]=h,this.float32[w+3]=a,this.float32[w+4]=u,this.float32[w+5]=x,this.float32[w+6]=T,this.float32[w+7]=C,this.float32[w+8]=g,this.float32[w+9]=S,this.float32[w+10]=A,e}}Bs.prototype.bytesPerElement=44,St(Bs,"StructArrayLayout11f44");class oo extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a,u,x,T,C){const g=this.length;return this.resize(g+1),this.emplace(g,e,i,s,h,a,u,x,T,C)}emplace(e,i,s,h,a,u,x,T,C,g){const S=9*e;return this.float32[S+0]=i,this.float32[S+1]=s,this.float32[S+2]=h,this.float32[S+3]=a,this.float32[S+4]=u,this.float32[S+5]=x,this.float32[S+6]=T,this.float32[S+7]=C,this.float32[S+8]=g,e}}oo.prototype.bytesPerElement=36,St(oo,"StructArrayLayout9f36");class ao extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i){const s=this.length;return this.resize(s+1),this.emplace(s,e,i)}emplace(e,i,s){const h=2*e;return this.float32[h+0]=i,this.float32[h+1]=s,e}}ao.prototype.bytesPerElement=8,St(ao,"StructArrayLayout2f8");class cu extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,s,h){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,s,h)}emplace(e,i,s,h,a){const u=6*e;return this.uint32[3*e+0]=i,this.uint16[u+2]=s,this.uint16[u+3]=h,this.uint16[u+4]=a,e}}cu.prototype.bytesPerElement=12,St(cu,"StructArrayLayout1ul3ui12");class hu extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint16[1*e+0]=i,e}}hu.prototype.bytesPerElement=2,St(hu,"StructArrayLayout1ui2");class sc extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a,u,x,T,C,g,S,A,w,M,P,O){const B=this.length;return this.resize(B+1),this.emplace(B,e,i,s,h,a,u,x,T,C,g,S,A,w,M,P,O)}emplace(e,i,s,h,a,u,x,T,C,g,S,A,w,M,P,O,B){const G=16*e;return this.float32[G+0]=i,this.float32[G+1]=s,this.float32[G+2]=h,this.float32[G+3]=a,this.float32[G+4]=u,this.float32[G+5]=x,this.float32[G+6]=T,this.float32[G+7]=C,this.float32[G+8]=g,this.float32[G+9]=S,this.float32[G+10]=A,this.float32[G+11]=w,this.float32[G+12]=M,this.float32[G+13]=P,this.float32[G+14]=O,this.float32[G+15]=B,e}}sc.prototype.bytesPerElement=64,St(sc,"StructArrayLayout16f64");class ul extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,s,h,a,u,x){const T=this.length;return this.resize(T+1),this.emplace(T,e,i,s,h,a,u,x)}emplace(e,i,s,h,a,u,x,T){const C=10*e,g=5*e;return this.uint16[C+0]=i,this.uint16[C+1]=s,this.uint16[C+2]=h,this.uint16[C+3]=a,this.float32[g+2]=u,this.float32[g+3]=x,this.float32[g+4]=T,e}}ul.prototype.bytesPerElement=20,St(ul,"StructArrayLayout4ui3f20");class uu extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.int16[1*e+0]=i,e}}uu.prototype.bytesPerElement=2,St(uu,"StructArrayLayout1i2");class Jc extends Ji{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint8[1*e+0]=i,e}}Jc.prototype.bytesPerElement=1,St(Jc,"StructArrayLayout1ub1");class du extends al{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}du.prototype.size=40;class pu extends cl{get(e){return new du(this,e)}}St(pu,"CollisionBoxArray");class oc extends al{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}oc.prototype.size=60;class Qc extends lu{get(e){return new oc(this,e)}}St(Qc,"PlacedSymbolArray");class rd extends al{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}}rd.prototype.size=80;class sd extends rc{get(e){return new rd(this,e)}}St(sd,"SymbolInstanceArray");class od extends hl{getoffsetX(e){return this.float32[1*e+0]}}St(od,"GlyphOffsetArray");class ad extends Os{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}St(ad,"SymbolLineVertexArray");class ac extends al{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}ac.prototype.size=12;class Bo extends cu{get(e){return new ac(this,e)}}St(Bo,"FeatureIndexArray");class Pr extends so{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}St(Pr,"FillExtrusionCentroidArray");class lc extends al{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}lc.prototype.size=6;class fu extends ro{get(e){return new lc(this,e)}}St(fu,"FillExtrusionWallArray");const No=Li([{name:"a_pos",components:2,type:"Int16"}],4),qd=Li([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class vn{constructor(e=[]){this.segments=e}_prepareSegment(e,i,s,h){let a=this.segments[this.segments.length-1];return e>vn.MAX_VERTEX_ARRAY_LENGTH&&ii(`Max vertices per segment is ${vn.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!a||a.vertexLength+e>vn.MAX_VERTEX_ARRAY_LENGTH||a.sortKey!==h)&&(a={vertexOffset:i,primitiveOffset:s,vertexLength:0,primitiveLength:0},void 0!==h&&(a.sortKey=h),this.segments.push(a)),a}prepareSegment(e,i,s,h){return this._prepareSegment(e,i.length,s.length,h)}get(){return this.segments}destroy(){for(const e of this.segments)for(const i in e.vaos)e.vaos[i].destroy()}static simpleSegment(e,i,s,h){return new vn([{vertexOffset:e,primitiveOffset:i,vertexLength:s,primitiveLength:h,vaos:{},sortKey:0}])}}function eh(r,e){return 256*(r=ai(Math.floor(r),0,255))+ai(Math.floor(e),0,255)}vn.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,St(vn,"SegmentVector");const mu=Li([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),_u=Li([{name:"a_dash",components:4,type:"Uint16"}]);class cc{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,i,s,h){this.ids.push(th(e)),this.positions.push(i,s,h)}eachPosition(e,i){const s=th(e);let h=0,a=this.ids.length-1;for(;h<a;){const u=h+a>>1;this.ids[u]>=s?a=u:h=u+1}for(;this.ids[h]===s;)i(this.positions[3*h],this.positions[3*h+1],this.positions[3*h+2]),h++}static serialize(e,i){const s=new Float64Array(e.ids),h=new Uint32Array(e.positions);return hc(s,h,0,s.length-1),i&&(i.add(s.buffer),i.add(h.buffer)),{ids:s,positions:h}}static deserialize(e){const i=new cc;let s;i.ids=e.ids,i.positions=e.positions;for(const h of i.ids)h!==s&&i.uniqueIds.push(h),s=h;return i.indexed=!0,i}}function th(r){const e=+r;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:ns(String(r))}function hc(r,e,i,s){for(;i<s;){const h=r[i+s>>1];let a=i-1,u=s+1;for(;;){do{a++}while(r[a]<h);do{u--}while(r[u]>h);if(a>=u)break;ih(r,a,u),ih(e,3*a,3*u),ih(e,3*a+1,3*u+1),ih(e,3*a+2,3*u+2)}u-i<s-u?(hc(r,e,i,u),i=u+1):(hc(r,e,u+1,s),s=u)}}function ih(r,e,i){const s=r[e];r[e]=r[i],r[i]=s}St(cc,"FeaturePositionMap");class ls{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,i),this.initialized=!0),!!this.location}set(e,i,s){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class dl extends ls{constructor(e){super(e),this.current=0}set(e,i,s){this.fetchUniformLocation(e,i)&&this.current!==s&&(this.current=s,this.gl.uniform1i(this.location,s))}}class bn extends ls{constructor(e){super(e),this.current=0}set(e,i,s){this.fetchUniformLocation(e,i)&&this.current!==s&&(this.current=s,this.gl.uniform1f(this.location,s))}}class Yr extends ls{constructor(e){super(e),this.current=[0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]||(this.current=s,this.gl.uniform2f(this.location,s[0],s[1])))}}class pl extends ls{constructor(e){super(e),this.current=[0,0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]||(this.current=s,this.gl.uniform3f(this.location,s[0],s[1],s[2])))}}class uc extends ls{constructor(e){super(e),this.current=[0,0,0,0]}set(e,i,s){this.fetchUniformLocation(e,i)&&(s[0]===this.current[0]&&s[1]===this.current[1]&&s[2]===this.current[2]&&s[3]===this.current[3]||(this.current=s,this.gl.uniform4f(this.location,s[0],s[1],s[2],s[3])))}}class ld extends ls{constructor(e){super(e),this.current=Ri.transparent.toRenderColor(null)}set(e,i,s){this.fetchUniformLocation(e,i)&&(s.r===this.current.r&&s.g===this.current.g&&s.b===this.current.b&&s.a===this.current.a||(this.current=s,this.gl.uniform4f(this.location,s.r,s.g,s.b,s.a)))}}const cd=new Float32Array(16);class fl extends ls{constructor(e){super(e),this.current=cd}set(e,i,s){if(this.fetchUniformLocation(e,i)){if(s[12]!==this.current[12]||s[0]!==this.current[0])return this.current=s,void this.gl.uniformMatrix4fv(this.location,!1,s);for(let h=1;h<16;h++)if(s[h]!==this.current[h]){this.current=s,this.gl.uniformMatrix4fv(this.location,!1,s);break}}}}const gu=new Float32Array(9),Hd=new Float32Array(4);class yu extends ls{constructor(e){super(e),this.current=Hd}set(e,i,s){if(this.fetchUniformLocation(e,i))for(let h=0;h<4;h++)if(s[h]!==this.current[h]){this.current=s,this.gl.uniformMatrix2fv(this.location,!1,s);break}}}function xu(r){return[eh(255*r.r,255*r.g),eh(255*r.b,255*r.a)]}class ya{constructor(e,i,s,h){this.value=e,this.uniformNames=i.map(a=>`u_${a}`),this.type=s,this.context=h}setUniform(e,i,s,h,a){const u=h.constantOr(this.value);i.set(e,a,u instanceof Ri?u.toRenderColor(this.ignoreLut?null:this.context.lut):u)}getBinding(e,i){return"color"===this.type?new ld(e):new bn(e)}}class Vo{constructor(e,i){this.uniformNames=i.map(s=>`u_${s}`),this.pattern=null,this.pixelRatio=1}setConstantPatternPositions(e){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br)}setUniform(e,i,s,h,a){const u="u_pattern"===a||"u_dash"===a?this.pattern:"u_pixel_ratio"===a?this.pixelRatio:null;u&&i.set(e,a,u)}getBinding(e,i){return"u_pattern"===i||"u_dash"===i?new uc(e):new bn(e)}}class Ns{constructor(e,i,s,h){this.expression=e,this.type=s,this.maxValue=0,this.paintVertexAttributes=i.map(a=>({name:`a_${a}`,type:"Float32",components:"color"===s?2:1,offset:0})),this.paintVertexArray=new h}populatePaintArray(e,i,s,h,a,u,x){const T=this.paintVertexArray.length,C="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate(new Zi(0,{brightness:u}),i,{},a,h,x):"constant"===this.expression.kind&&this.expression.value;!this.lutExpression||"composite"!==this.lutExpression.kind&&"source"!==this.lutExpression.kind||(this.ignoreLut="none"===this.lutExpression.evaluate(new Zi(0,{brightness:u}),i,{},a,h,x)),this.paintVertexArray.resize(e),this._setPaintValue(T,e,C,this.context)}updatePaintArray(e,i,s,h,a,u,x){const T="composite"===this.expression.kind||"source"===this.expression.kind?this.expression.evaluate({zoom:0,brightness:x},s,h,void 0,a):"constant"===this.expression.kind&&this.expression.value;!this.lutExpression||"composite"!==this.lutExpression.kind&&"source"!==this.lutExpression.kind||(this.ignoreLut="none"===this.lutExpression.evaluate({zoom:0,brightness:x},s,h,void 0,a)),this._setPaintValue(e,i,T,this.context)}_setPaintValue(e,i,s,h){if("color"===this.type){const a=xu(s.toRenderColor(this.ignoreLut?null:h.lut));for(let u=e;u<i;u++)this.paintVertexArray.emplace(u,a[0],a[1])}else{for(let a=e;a<i;a++)this.paintVertexArray.emplace(a,s);this.maxValue=Math.max(this.maxValue,Math.abs(s))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&"constant"!==this.lutExpression.kind&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||"constant"!==this.expression.kind&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class bs{constructor(e,i,s,h,a,u){this.expression=e,this.uniformNames=i.map(x=>`u_${x}_t`),this.type=s,this.useIntegerZoom=h,this.context=a,this.maxValue=0,this.paintVertexAttributes=i.map(x=>({name:`a_${x}`,type:"Float32",components:"color"===s?4:2,offset:0})),this.paintVertexArray=new u}populatePaintArray(e,i,s,h,a,u,x){const T=this.expression.evaluate(new Zi(this.context.zoom,{brightness:u}),i,{},a,h,x),C=this.expression.evaluate(new Zi(this.context.zoom+1,{brightness:u}),i,{},a,h,x);!this.lutExpression||"composite"!==this.lutExpression.kind&&"source"!==this.lutExpression.kind||(this.ignoreLut="none"===this.lutExpression.evaluate(new Zi(this.context.zoom,{brightness:u}),i,{},a,h,x));const g=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(g,e,T,C,this.context)}updatePaintArray(e,i,s,h,a,u,x){const T=this.expression.evaluate({zoom:this.context.zoom,brightness:x},s,h,void 0,a),C=this.expression.evaluate({zoom:this.context.zoom+1,brightness:x},s,h,void 0,a);!this.lutExpression||"composite"!==this.lutExpression.kind&&"source"!==this.lutExpression.kind||(this.ignoreLut="none"===this.lutExpression.evaluate({zoom:this.context.zoom,brightness:x},s,h,void 0,a)),this._setPaintValue(e,i,T,C,this.context)}_setPaintValue(e,i,s,h,a){if("color"===this.type){const u=xu(s.toRenderColor(this.ignoreLut?null:a.lut)),x=xu(s.toRenderColor(this.ignoreLut?null:a.lut));for(let T=e;T<i;T++)this.paintVertexArray.emplace(T,u[0],u[1],x[0],x[1])}else{for(let u=e;u<i;u++)this.paintVertexArray.emplace(u,s,h);this.maxValue=Math.max(this.maxValue,Math.abs(s),Math.abs(h))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,i,s,h,a){const u=this.useIntegerZoom?Math.floor(s.zoom):s.zoom,x=ai(this.expression.interpolationFactor(u,this.context.zoom,this.context.zoom+1),0,1);i.set(e,a,x)}getBinding(e,i){return new bn(e)}}class Uo{constructor(e,i,s,h,a){this.expression=e,this.layerId=a,this.paintVertexAttributes=("array"===s?_u:mu).members;for(let u=0;u<i.length;++u);this.paintVertexArray=new h}populatePaintArray(e,i,s,h){const a=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(a,e,i.patterns&&i.patterns[this.layerId],s)}updatePaintArray(e,i,s,h,a,u,x){this._setPaintValues(e,i,s.patterns&&s.patterns[this.layerId],u)}_setPaintValues(e,i,s,h){if(!h||!s)return;const a=h[s];if(!a)return;const{tl:u,br:x,pixelRatio:T}=a;for(let C=e;C<i;C++)this.paintVertexArray.emplace(C,u[0],u[1],x[0],x[1],T)}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class xa{constructor(e,i,s=()=>!0){this.binders={},this._buffers=[],this.context=i;const h=[];for(const a in e.paint._values){const u=e.paint.get(a),x=e.paint.get(`${a}-use-theme`);if(a.endsWith("-use-theme")||!s(a)||!(u instanceof sl&&Wl(u.property.specification)))continue;const T=vu(a,e.type),C=u.value,g=u.property.specification.type,S=!!u.property.useIntegerZoom,A="line-dasharray"===a||a.endsWith("pattern"),w="line-dasharray"===a&&"constant"!==e.layout.get("line-cap").value.kind||x&&"constant"!==x.value.kind;if("constant"!==C.kind||w)if("source"===C.kind||w||A){const M=bu(a,g,"source");this.binders[a]=A?new Uo(C,T,g,M,e.id):new Ns(C,T,g,M),h.push(`/a_${a}`)}else{const M=bu(a,g,"composite");this.binders[a]=new bs(C,T,g,S,i,M),h.push(`/z_${a}`)}else this.binders[a]=A?new Vo(C.value,T):new ya(C.value,T,g,i),h.push(`/u_${a}`);x&&(this.binders[a].ignoreLut="none"===x.constantOr("default"),this.binders[a].lutExpression=x.value,this.binders[a].checkUseTheme=!0)}this.cacheKey=h.sort().join("")}getMaxValue(e){const i=this.binders[e];return i instanceof Ns||i instanceof bs?i.maxValue:0}populatePaintArrays(e,i,s,h,a,u,x){for(const T in this.binders){const C=this.binders[T];C.context=this.context,C instanceof Ns||C instanceof bs||C instanceof Uo?C.populatePaintArray(e,i,s,h,a,u,x):C.lutExpression&&C instanceof ya&&C.lutExpression&&("composite"===C.lutExpression.kind||"source"===C.lutExpression.kind)&&(C.ignoreLut="none"===C.lutExpression.evaluate(new Zi(0,{brightness:u}),i,{},a,h,x))}}setConstantPatternPositions(e){for(const i in this.binders){const s=this.binders[i];s instanceof Vo&&s.setConstantPatternPositions(e)}}updatePaintArrays(e,i,s,h,a,u,x,T,C){let g=!1;const S=Object.keys(e),A=0!==S.length&&!T,w=A?S:i.uniqueIds;this.context.lut=a.lut;for(const M in this.binders){const P=this.binders[M];if(P.context=this.context,(P instanceof Ns||P instanceof bs||P instanceof Uo)&&P.expression&&P.expression.kind&&"constant"!==P.expression.kind&&(!0===P.expression.isStateDependent||!1===P.expression.isLightConstant)){const O=a.paint.get(M);P.expression=O.value;for(const B of w){const G=e[B.toString()];i.eachPosition(B,(q,U,W)=>{const X=h.feature(q);P.updatePaintArray(U,W,X,G,u,x,C)})}if(!A)for(const B of s.uniqueIds){const G=e[B.toString()];s.eachPosition(B,(q,U,W)=>{const X=h.feature(q);P.updatePaintArray(U,W,X,G,u,x,C)})}g=!0}}return g}defines(){const e=[];for(const i in this.binders){const s=this.binders[i];(s instanceof ya||s instanceof Vo)&&e.push(...s.uniformNames.map(h=>`#define HAS_UNIFORM_${h}`))}return e}getBinderAttributes(){const e=[];for(const i in this.binders){const s=this.binders[i];if(s instanceof Ns||s instanceof bs||s instanceof Uo)for(let h=0;h<s.paintVertexAttributes.length;h++)e.push(s.paintVertexAttributes[h].name)}return e}getBinderUniforms(){const e=[];for(const i in this.binders){const s=this.binders[i];if(s instanceof ya||s instanceof Vo||s instanceof bs)for(const h of s.uniformNames)e.push(h)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const i=[];for(const s in this.binders){const h=this.binders[s];if(h instanceof ya||h instanceof Vo||h instanceof bs)for(const a of h.uniformNames)i.push({name:a,property:s,binding:h.getBinding(e,a)})}return i}setUniforms(e,i,s,h,a){for(const{name:u,property:x,binding:T}of s){if(this.binders[x].checkUseTheme&&this.binders[x]instanceof ya){const C=h.get(`${x}-use-theme`);C.isConstant()&&(this.binders[x].ignoreLut="none"===C.constantOr("default"))}this.binders[x].setUniform(e,T,a,h.get(x),u)}}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const i=this.binders[e];(i instanceof Ns||i instanceof bs||i instanceof Uo)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer)}}upload(e){for(const i in this.binders){const s=this.binders[i];(s instanceof Ns||s instanceof bs||s instanceof Uo)&&s.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const i=this.binders[e];(i instanceof Ns||i instanceof bs||i instanceof Uo)&&i.destroy()}}}class Vs{constructor(e,i,s=()=>!0){this.programConfigurations={};for(const h of e)this.programConfigurations[h.id]=new xa(h,i,s);this.needsUpload=!1,this._featureMap=new cc,this._featureMapWithoutIds=new cc,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,i,s,h,a,u,x,T){for(const C in this.programConfigurations)this.programConfigurations[C].populatePaintArrays(e,i,h,a,u,x,T);void 0!==i.id?this._featureMap.add(i.id,s,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,s,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,i,s,h,a,u,x){for(const T of s)this.needsUpload=this.programConfigurations[T.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,i,T,h,a,u,x||0)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const i in this.programConfigurations)this.programConfigurations[i].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const Wd={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio"],"fill-pattern":["pattern","pixel_ratio"],"fill-extrusion-pattern":["pattern","pixel_ratio"],"line-dasharray":["dash"]};function vu(r,e){return Wd[r]||[r.replace(`${e}-`,"").replace(/-/g,"_")]}const hd={"line-pattern":{source:pr,composite:pr},"fill-pattern":{source:pr,composite:pr},"fill-extrusion-pattern":{source:pr,composite:pr},"line-dasharray":{source:Zc,composite:Zc}},dc={color:{source:ao,composite:Oo},number:{source:hl,composite:ao}};function bu(r,e,i){const s=hd[r];return s&&s[i]||dc[e][i]}St(ya,"ConstantBinder"),St(Vo,"PatternConstantBinder"),St(Ns,"SourceExpressionBinder"),St(Uo,"PatternCompositeBinder"),St(bs,"CompositeExpressionBinder"),St(xa,"ProgramConfiguration",{omit:["_buffers"]}),St(Vs,"ProgramConfigurationSet");const wr=ft/Math.PI/2,nh=[64,32,16],Kr=-wr,Jr=wr;function gl(r,e,i,s=wr){return i=yi(i),[r*Math.sin(i)*s,-e*s,r*Math.cos(i)*s]}function va(r,e,i){return gl(Math.cos(yi(r)),Math.sin(yi(r)),e,i)}const jo=6371008.8,wu=2*Math.PI*jo;class Ci{constructor(e,i){if(isNaN(e)||isNaN(i))throw new Error(`Invalid LngLat object: (${e}, ${i})`);if(this.lng=+e,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Ci(Yi(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const i=Math.PI/180,s=this.lat*i,h=e.lat*i,a=Math.sin(s)*Math.sin(h)+Math.cos(s)*Math.cos(h)*Math.cos((e.lng-this.lng)*i);return jo*Math.acos(Math.min(a,1))}toBounds(e=0){const i=360*e/40075017,s=i/Math.cos(Math.PI/180*this.lat);return new Go({lng:this.lng-s,lat:this.lat-i},{lng:this.lng+s,lat:this.lat+i})}toEcef(e){return va(this.lat,this.lng,wr+e*wr/jo)}static convert(e){if(e instanceof Ci)return e;if(Array.isArray(e)&&(2===e.length||3===e.length))return new Ci(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&"object"==typeof e&&null!==e)return new Ci(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class Go{constructor(e,i){if(e)if(i)this.setSouthWest(e).setNorthEast(i);else if(4===e.length){const s=e;this.setSouthWest([s[0],s[1]]).setNorthEast([s[2],s[3]])}else{const s=e;this.setSouthWest(s[0]).setNorthEast(s[1])}}setNorthEast(e){return this._ne=e instanceof Ci?new Ci(e.lng,e.lat):Ci.convert(e),this}setSouthWest(e){return this._sw=e instanceof Ci?new Ci(e.lng,e.lat):Ci.convert(e),this}extend(e){const i=this._sw,s=this._ne;let h,a;if(e instanceof Ci)h=e,a=e;else{if(!(e instanceof Go))return Array.isArray(e)?4===e.length||e.every(Array.isArray)?this.extend(Go.convert(e)):this.extend(Ci.convert(e)):"object"==typeof e&&null!==e&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(Ci.convert(e)):this;if(h=e._sw,a=e._ne,!h||!a)return this}return i||s?(i.lng=Math.min(h.lng,i.lng),i.lat=Math.min(h.lat,i.lat),s.lng=Math.max(a.lng,s.lng),s.lat=Math.max(a.lat,s.lat)):(this._sw=new Ci(h.lng,h.lat),this._ne=new Ci(a.lng,a.lat)),this}getCenter(){return new Ci((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Ci(this.getWest(),this.getNorth())}getSouthEast(){return new Ci(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:i,lat:s}=Ci.convert(e);let h=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(h=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=s&&s<=this._ne.lat&&h}static convert(e){if(e)return e instanceof Go?e:new Go(e)}}function yl(r){return wu*Math.cos(r*Math.PI/180)}function Us(r){return(180+r)/360}function cs(r){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r*Math.PI/360)))/360}function fr(r,e){return r/yl(e)}function Vr(r){return 360*r-180}function $n(r){return 360/Math.PI*Math.atan(Math.exp((180-360*r)*Math.PI/180))-90}function pd(r,e){return r*yl($n(e))}const _n=85.051129;function Tu(r){return Math.cos(yi(ai(r,-_n,_n)))}function ba(r,e){const i=ai(e,0,25.5),s=Math.pow(2,i);return Tu(r)*wu/(512*s)}function l(r){return 1/Math.cos(r*Math.PI/180)}function t(r,e=0){const i=Math.exp(Math.PI*(1-(r.y+e/ft)/(1<<r.z)*2));return 80150034*i/(i*i+1)/ft/(1<<r.z)}class n{constructor(e,i,s=0){this.x=+e,this.y=+i,this.z=+s}static fromLngLat(e,i=0){const s=Ci.convert(e);return new n(Us(s.lng),cs(s.lat),fr(i,s.lat))}toLngLat(){return new Ci(Vr(this.x),$n(this.y))}toAltitude(){return pd(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/wu*l($n(this.y))}}function c(r,e,i,s,h,a,u,x,T){const C=(e+s)/2,g=(i+h)/2,S=new pt(C,g);x(S),function(A,w,M,P,O,B){const G=M-O,q=P-B;return Math.abs((P-w)*G-(M-A)*q)/Math.hypot(G,q)}(S.x,S.y,a.x,a.y,u.x,u.y)>=T?(c(r,e,i,C,g,a,S,x,T),c(r,C,g,s,h,S,u,x,T)):r.push(u)}function p(r,e,i){let s=r[0],h=s.x,a=s.y;e(s);const u=[s];for(let x=1;x<r.length;x++){const T=r[x],{x:C,y:g}=T;e(T),c(u,h,a,C,g,s,T,e,i),h=C,a=g,s=T}return u}function y(r,e,i,s){if(s(e,i)){const h=e.add(i)._mult(.5);y(r,e,h,s),y(r,h,i,s)}else r.push(i)}function b(r,e){let i=r[0];const s=[i];for(let h=1;h<r.length;h++){const a=r[h];y(s,i,a,e),i=a}return s}const E=Math.pow(2,14)-1,D=-E-1;function L(r,e){const i=Math.round(r.x*e),s=Math.round(r.y*e);return r.x=ai(i,D,E),r.y=ai(s,D,E),(i<r.x||i>r.x+1||s<r.y||s>r.y+1)&&ii("Geometry exceeds allowed extent, reduce your vector tile buffer size"),r}function k(r,e,i){const s=r.loadGeometry(),h=r.extent,a=ft/h;if(e&&i&&i.projection.isReprojectedInTileSpace){const u=1<<e.z,{scale:x,x:T,y:C,projection:g}=i,S=A=>{const w=Vr((e.x+A.x/h)/u),M=$n((e.y+A.y/h)/u),P=g.project(w,M);A.x=(P.x*x-T)*h,A.y=(P.y*x-C)*h};for(let A=0;A<s.length;A++)if(1!==r.type)s[A]=p(s[A],S,1);else{const w=[];for(const M of s[A])M.x<0||M.x>=h||M.y<0||M.y>=h||(S(M),w.push(M));s[A]=w}}for(const u of s)for(const x of u)L(x,a);return s}function N(r,e){return{type:r.type,id:r.id,properties:r.properties,geometry:e?k(r):[]}}function V(r,e,i,s,h){r.emplaceBack(2*e+(s+1)/2,2*i+(h+1)/2)}function j(r,e,i){r.emplaceBack(e.x,e.y,e.z,16384*i[0],16384*i[1],16384*i[2])}class Y{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new Os,this.indexArray=new Ln,this.segments=new vn,this.programConfigurations=new Vs(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id)}updateFootprints(e,i){}populate(e,i,s,h){const a=this.layers[0],u=[];let x=null;"circle"===a.type&&(x=a.layout.get("circle-sort-key"));for(const{feature:C,id:g,index:S,sourceLayerIndex:A}of e){const w=this.layers[0]._featureFilter.needGeometry,M=N(C,w);if(!this.layers[0]._featureFilter.filter(new Zi(this.zoom),M,s))continue;const P=x?x.evaluate(M,{},s):void 0,O={id:g,properties:C.properties,type:C.type,sourceLayerIndex:A,index:S,geometry:w?M.geometry:k(C,s,h),patterns:{},sortKey:P};u.push(O)}x&&u.sort((C,g)=>C.sortKey-g.sortKey);let T=null;"globe"===h.projection.name&&(this.globeExtVertexArray=new ic,T=h.projection);for(const C of u){const{geometry:g,index:S,sourceLayerIndex:A}=C,w=e[S].feature;this.addFeature(C,g,S,i.availableImages,s,T,i.brightness),i.featureIndex.insert(w,g,S,A,this.index)}}update(e,i,s,h,a,u,x){this.programConfigurations.updatePaintArrays(e,i,a,s,h,u,x)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,No.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,qd.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy())}addFeature(e,i,s,h,a,u,x){for(const T of i)for(const C of T){const g=C.x,S=C.y;if(g<0||g>=ft||S<0||S>=ft)continue;if(u){const M=u.projectTilePoint(g,S,a),P=u.upVector(a,g,S),O=this.globeExtVertexArray;j(O,M,P),j(O,M,P),j(O,M,P),j(O,M,P)}const A=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),w=A.vertexLength;V(this.layoutVertexArray,g,S,-1,-1),V(this.layoutVertexArray,g,S,1,-1),V(this.layoutVertexArray,g,S,1,1),V(this.layoutVertexArray,g,S,-1,1),this.indexArray.emplaceBack(w,w+1,w+2),this.indexArray.emplaceBack(w,w+2,w+3),A.vertexLength+=4,A.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,{},h,a,x)}}function Z(r,e){for(let i=0;i<r.length;i++)if(de(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(de(r,e[i]))return!0;return!!he(r,e)}function Q(r,e,i){return!!de(r,e)||!!ge(e,r,i)}function J(r,e){if(1===r.length)return _e(e,r[0]);for(let i=0;i<e.length;i++){const s=e[i];for(let h=0;h<s.length;h++)if(de(r,s[h]))return!0}for(let i=0;i<r.length;i++)if(_e(e,r[i]))return!0;for(let i=0;i<e.length;i++)if(he(r,e[i]))return!0;return!1}function re(r,e,i){if(r.length>1){if(he(r,e))return!0;for(let s=0;s<e.length;s++)if(ge(e[s],r,i))return!0}for(let s=0;s<r.length;s++)if(ge(r[s],e,i))return!0;return!1}function he(r,e){if(0===r.length||0===e.length)return!1;for(let i=0;i<r.length-1;i++){const s=r[i],h=r[i+1];for(let a=0;a<e.length-1;a++)if(ce(s,h,e[a],e[a+1]))return!0}return!1}function ce(r,e,i,s){return kr(r,i,s)!==kr(e,i,s)&&kr(r,e,i)!==kr(r,e,s)}function ge(r,e,i){const s=i*i;if(1===e.length)return r.distSqr(e[0])<s;for(let h=1;h<e.length;h++)if(pe(r,e[h-1],e[h])<s)return!0;return!1}function pe(r,e,i){const s=e.distSqr(i);if(0===s)return r.distSqr(e);const h=((r.x-e.x)*(i.x-e.x)+(r.y-e.y)*(i.y-e.y))/s;return r.distSqr(h<0?e:h>1?i:i.sub(e)._mult(h)._add(e))}function _e(r,e){let i,s,h,a=!1;for(let u=0;u<r.length;u++){i=r[u];for(let x=0,T=i.length-1;x<i.length;T=x++)s=i[x],h=i[T],s.y>e.y!=h.y>e.y&&e.x<(h.x-s.x)*(e.y-s.y)/(h.y-s.y)+s.x&&(a=!a)}return a}function de(r,e){let i=!1;for(let s=0,h=r.length-1;s<r.length;h=s++){const a=r[s],u=r[h];a.y>e.y!=u.y>e.y&&e.x<(u.x-a.x)*(e.y-a.y)/(u.y-a.y)+a.x&&(i=!i)}return i}function be(r,e,i,s,h){for(const u of r)if(e<=u.x&&i<=u.y&&s>=u.x&&h>=u.y)return!0;const a=[new pt(e,i),new pt(e,h),new pt(s,h),new pt(s,i)];if(r.length>2)for(const u of a)if(de(r,u))return!0;for(let u=0;u<r.length-1;u++)if(Ee(r[u],r[u+1],a))return!0;return!1}function Ee(r,e,i){const s=i[0],h=i[2];if(r.x<s.x&&e.x<s.x||r.x>h.x&&e.x>h.x||r.y<s.y&&e.y<s.y||r.y>h.y&&e.y>h.y)return!1;const a=kr(r,e,i[0]);return a!==kr(r,e,i[1])||a!==kr(r,e,i[2])||a!==kr(r,e,i[3])}function qe(r,e,i,s,h,a){let u=e.y-r.y,x=r.x-e.x;if(a=a||0){const T=u*u+x*x;if(0===T)return!0;const C=Math.sqrt(T);u/=C,x/=C}return!((i.x-r.x)*u+(i.y-r.y)*x-a<0||(s.x-r.x)*u+(s.y-r.y)*x-a<0||(h.x-r.x)*u+(h.y-r.y)*x-a<0)}function Le(r,e,i,s,h,a,u){return!(qe(r,e,s,h,a,u)||qe(e,i,s,h,a,u)||qe(i,r,s,h,a,u)||qe(s,h,r,e,i,u)||qe(h,a,r,e,i,u)||qe(a,s,r,e,i,u))}function Ye(r,e,i){const s=e.paint.get(r).value;return"constant"===s.kind?s.value:i.programConfigurations.get(e.id).getMaxValue(r)}function Xe(r){return Math.sqrt(r[0]*r[0]+r[1]*r[1])}function Re(r,e,i,s,h){if(!e[0]&&!e[1])return r;const a=pt.convert(e)._mult(h);"viewport"===i&&a._rotate(-s);const u=[];for(let x=0;x<r.length;x++)u.push(r[x].sub(a));return u}function He(r,e,i,s){const h=pt.convert(r)._mult(s);return"viewport"===e&&h._rotate(-i),h}let it,De;St(Y,"CircleBucket",{omit:["layers"]});var Je,We={exports:{}},ut=(Je||(Je=1,function(i){function s(a,u,x){var T=h(256*a,256*(u=Math.pow(2,x)-u-1),x),C=h(256*(a+1),256*(u+1),x);return T[0]+","+T[1]+","+C[0]+","+C[1]}function h(a,u,x){var T=2*Math.PI*6378137/256/Math.pow(2,x);return[a*T-2*Math.PI*6378137/2,u*T-2*Math.PI*6378137/2]}i.getURL=function(a,u,x,T,C,g){return g=g||{},a+"?"+["bbox="+s(x,T,C),"format="+(g.format||"image/png"),"service="+(g.service||"WMS"),"version="+(g.version||"1.1.1"),"request="+(g.request||"GetMap"),"srs="+(g.srs||"EPSG:3857"),"width="+(g.width||256),"height="+(g.height||256),"layers="+u].join("&")},i.getTileBBox=s,i.getMercCoords=h,Object.defineProperty(i,"__esModule",{value:!0})}(We.exports)),We.exports);class et{constructor(e,i,s){this.z=e,this.x=i,this.y=s,this.key=ct(0,e,e,i,s)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}url(e,i){const s=ut.getTileBBox(this.x,this.y,this.z),h=function(a,u,x){let T,C="";for(let g=a;g>0;g--)T=1<<g-1,C+=(u&T?1:0)+(x&T?2:0);return C}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===i?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",h).replace("{bbox-epsg-3857}",s)}toString(){return`${this.z}/${this.x}/${this.y}`}}class Ke{constructor(e,i){this.wrap=e,this.canonical=i,this.key=ct(e,i.z,i.z,i.x,i.y)}}class rt{constructor(e,i,s,h,a){this.overscaledZ=e,this.wrap=i,this.canonical=new et(s,+h,+a),this.key=0===i&&e===s?this.canonical.key:ct(i,e,s,h,a)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const i=this.canonical.z-e;return e>this.canonical.z?new rt(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new rt(e,this.wrap,e,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(e,i=!0){if(this.overscaledZ===e&&i)return this.key;if(e>this.canonical.z)return ct(this.wrap*+i,e,this.canonical.z,this.canonical.x,this.canonical.y);{const s=this.canonical.z-e;return ct(this.wrap*+i,e,e,this.canonical.x>>s,this.canonical.y>>s)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const i=this.canonical.z-e.canonical.z;return 0===e.overscaledZ||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>i&&e.canonical.y===this.canonical.y>>i}children(e){if(this.overscaledZ>=e)return[new rt(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const i=this.canonical.z+1,s=2*this.canonical.x,h=2*this.canonical.y;return[new rt(i,this.wrap,i,s,h),new rt(i,this.wrap,i,s+1,h),new rt(i,this.wrap,i,s,h+1),new rt(i,this.wrap,i,s+1,h+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new rt(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new rt(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new Ke(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function ct(r,e,i,s,h){const a=1<<Math.min(i,22);let u=a*(h%a)+s%a;return r&&i<22&&(u+=a*a*((r<0?-2*r-1:2*r)%(1<<2*(22-i)))),16*(32*u+i)+(e-i)}const _t=[r=>{let e=r.canonical.x-1,i=r.wrap;return e<0&&(e=(1<<r.canonical.z)-1,i--),new rt(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>{let e=r.canonical.x+1,i=r.wrap;return e===1<<r.canonical.z&&(e=0,i++),new rt(r.overscaledZ,i,r.canonical.z,e,r.canonical.y)},r=>new rt(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,(0===r.canonical.y?1<<r.canonical.z:r.canonical.y)-1),r=>new rt(r.overscaledZ,r.wrap,r.canonical.z,r.canonical.x,r.canonical.y===(1<<r.canonical.z)-1?0:r.canonical.y+1)];St(et,"CanonicalTileID"),St(rt,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const Tt=Li([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:jt}=Tt,Lt=Li([{name:"a_pos_3",components:3,type:"Int16"}]);var kt=Li([{name:"a_pos",type:"Int16",components:2}]);class Zt{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,s){const h=Ie.vec3.dot(i,this.dir);if(Math.abs(h)<1e-6)return!1;const a=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1]+(e[2]-this.pos[2])*i[2])/h;return s[0]=this.pos[0]+this.dir[0]*a,s[1]=this.pos[1]+this.dir[1]*a,s[2]=this.pos[2]+this.dir[2]*a,!0}closestPointOnSphere(e,i,s){if(Ie.vec3.equals(this.pos,e)||0===i)return s[0]=s[1]=s[2]=0,!1;const[h,a,u]=this.dir,x=this.pos[0]-e[0],T=this.pos[1]-e[1],C=this.pos[2]-e[2],g=h*h+a*a+u*u,S=2*(x*h+T*a+C*u),A=S*S-4*g*(x*x+T*T+C*C-i*i);if(A<0){const w=Math.max(-S/2,0),M=x+h*w,P=T+a*w,O=C+u*w,B=Math.hypot(M,P,O);return s[0]=M*i/B,s[1]=P*i/B,s[2]=O*i/B,!1}{const w=(-S-Math.sqrt(A))/(2*g);if(w<0){const M=Math.hypot(x,T,C);return s[0]=x*i/M,s[1]=T*i/M,s[2]=C*i/M,!1}return s[0]=x+h*w,s[1]=T+a*w,s[2]=C+u*w,!0}}}class di{constructor(e,i,s,h,a){this.TL=e,this.TR=i,this.BR=s,this.BL=h,this.horizon=a}static fromInvProjectionMatrix(e,i,s){const h=[-1,1,1],a=[1,1,1],u=[1,-1,1],x=[-1,-1,1],T=Ie.vec3.transformMat4(h,h,e),C=Ie.vec3.transformMat4(a,a,e),g=Ie.vec3.transformMat4(u,u,e),S=Ie.vec3.transformMat4(x,x,e);return new di(T,C,g,S,i/s)}}function Ni(r,e,i){let s=1/0,h=-1/0;const a=[];for(const u of r){Ie.vec3.sub(a,u,e);const x=Ie.vec3.dot(a,i);s=Math.min(s,x),h=Math.max(h,x)}return[s,h]}function hn(r,e){let i=!0;for(let s=0;s<r.planes.length;s++){const h=r.planes[s];let a=0;for(let u=0;u<e.length;u++)a+=Ie.vec3.dot(h,e[u])+h[3]>=0;if(0===a)return 0;a!==e.length&&(i=!1)}return i?2:1}function nn(r,e){for(const i of r.projections){const s=Ni(e,r.points[0],i.axis);if(i.projection[1]<s[0]||i.projection[0]>s[1])return 0}return 1}function Kt(r,e){let i=0;const s=[0,0,0,0];for(let h=0;h<r.length;h++)s[0]=r[h][0],s[1]=r[h][1],s[2]=r[h][2],s[3]=1,Ie.vec4.dot(s,e)>=0&&i++;return i}class Ei{constructor(e,i){this.points=e||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=Pt.fromPoints(this.points),this.projections=[],this.frustumEdges=[Ie.vec3.sub([],this.points[2],this.points[3]),Ie.vec3.sub([],this.points[0],this.points[3]),Ie.vec3.sub([],this.points[4],this.points[0]),Ie.vec3.sub([],this.points[5],this.points[1]),Ie.vec3.sub([],this.points[6],this.points[2]),Ie.vec3.sub([],this.points[7],this.points[3])];for(const s of this.frustumEdges){const h=[0,-s[2],s[1]],a=[s[2],0,-s[0]];this.projections.push({axis:h,projection:Ni(this.points,this.points[0],h)}),this.projections.push({axis:a,projection:Ni(this.points,this.points[0],a)})}}static fromInvProjectionMatrix(e,i,s,h){const a=Math.pow(2,s),u=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(C=>{const g=Ie.vec4.transformMat4([],C,e),S=1/g[3]/i*a;return Ie.vec4.mul(g,g,[S,S,h?1/g[3]:S,S])}),x=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(C=>{const g=Ie.vec3.sub([],u[C[0]],u[C[1]]),S=Ie.vec3.sub([],u[C[2]],u[C[1]]),A=Ie.vec3.normalize([],Ie.vec3.cross([],g,S)),w=-Ie.vec3.dot(A,u[C[1]]);return A.concat(w)}),T=[];for(let C=0;C<u.length;C++)T.push([u[C][0],u[C][1],u[C][2]]);return new Ei(T,x)}intersectsPrecise(e,i,s){for(let h=0;h<i.length;h++)if(!Kt(e,i[h]))return 0;for(let h=0;h<this.planes.length;h++)if(!Kt(e,this.planes[h]))return 0;for(const h of s)for(const a of this.frustumEdges){const u=Ie.vec3.cross([],h,a),x=Ie.vec3.length(u);if(0===x)continue;Ie.vec3.scale(u,u,1/x);const T=Ni(this.points,this.points[0],u),C=Ni(e,this.points[0],u);if(T[0]>C[1]||C[0]>T[1])return 0}return 1}containsPoint(e){for(const i of this.planes){const s=i[3];if(Ie.vec3.dot([i[0],i[1],i[2]],e)+s<0)return!1}return!0}}class Pt{static fromPoints(e){const i=[1/0,1/0,1/0],s=[-1/0,-1/0,-1/0];for(const h of e)Ie.vec3.min(i,i,h),Ie.vec3.max(s,s,h);return new Pt(i,s)}static fromTileIdAndHeight(e,i,s){const h=1<<e.canonical.z,a=e.canonical.x,u=e.canonical.y;return new Pt([a/h,u/h,i],[(a+1)/h,(u+1)/h,s])}static applyTransform(e,i){const s=e.getCorners();for(let h=0;h<s.length;++h)Ie.vec3.transformMat4(s[h],s[h],i);return Pt.fromPoints(s)}static applyTransformFast(e,i){const s=[i[12],i[13],i[14]],h=[...s];for(let a=0;a<3;a++)for(let u=0;u<3;u++){const x=i[4*u+a],T=x*e.min[u],C=x*e.max[u];s[a]+=Math.min(T,C),h[a]+=Math.max(T,C)}return new Pt(s,h)}static projectAabbCorners(e,i){const s=e.getCorners();for(let h=0;h<s.length;++h)Ie.vec3.transformMat4(s[h],s[h],i);return s}constructor(e,i){this.min=e,this.max=i,this.center=Ie.vec3.scale([],Ie.vec3.add([],this.min,this.max),.5)}quadrant(e){const i=[e%2==0,e<2],s=Ie.vec3.clone(this.min),h=Ie.vec3.clone(this.max);for(let a=0;a<i.length;a++)s[a]=i[a]?this.min[a]:this.center[a],h[a]=i[a]?this.center[a]:this.max[a];return h[2]=this.max[2],new Pt(s,h)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,i=this.max;return[[e[0],e[1],e[2]],[i[0],e[1],e[2]],[i[0],i[1],e[2]],[e[0],i[1],e[2]],[e[0],e[1],i[2]],[i[0],e[1],i[2]],[i[0],i[1],i[2]],[e[0],i[1],i[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?hn(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?hn(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,i){return i||this.intersects(e)?nn(e,this.getCorners()):0}intersectsPreciseFlat(e,i){return i||this.intersectsFlat(e)?nn(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let i=0;i<3;++i)if(this.min[i]>e.max[i]||e.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e.min[i]),this.max[i]=Math.max(this.max[i],e.max[i])}encapsulatePoint(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e[i]),this.max[i]=Math.max(this.max[i],e[i])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}function pi(r){return r*wr/jo}St(Pt,"Aabb");const Di=[new Pt([Kr,Kr,Kr],[Jr,Jr,Jr]),new Pt([Kr,Kr,Kr],[0,0,Jr]),new Pt([0,Kr,Kr],[Jr,0,Jr]),new Pt([Kr,0,Kr],[0,Jr,Jr]),new Pt([0,0,Kr],[Jr,Jr,Jr])];function ki(r,e,i,s=!0){const h=Ie.vec3.scale([],r._camera.position,r.worldSize),a=[e,i,1,1];Ie.vec4.transformMat4(a,a,r.pixelMatrixInverse),Ie.vec4.scale(a,a,1/a[3]);const u=Ie.vec3.sub([],a,h),x=Ie.vec3.normalize([],u),T=r.globeMatrix,C=[T[12],T[13],T[14]],g=Ie.vec3.sub([],C,h),S=Ie.vec3.length(g),A=Ie.vec3.normalize([],g),w=r.worldSize/(2*Math.PI),M=Ie.vec3.dot(A,x),P=Math.asin(w/S);if(P<Math.acos(M)){if(!s)return null;const ye=[],le=[];Ie.vec3.scale(ye,x,S/M),Ie.vec3.normalize(le,Ie.vec3.sub(le,ye,g)),Ie.vec3.normalize(x,Ie.vec3.add(x,g,Ie.vec3.scale(x,le,Math.tan(P)*S)))}const O=[];new Zt(h,x).closestPointOnSphere(C,w,O);const B=Ie.vec3.normalize([],Va(T,0)),G=Ie.vec3.normalize([],Va(T,1)),q=Ie.vec3.normalize([],Va(T,2)),U=Ie.vec3.dot(B,O),W=Ie.vec3.dot(G,O),X=Ie.vec3.dot(q,O),ee=Hn(Math.asin(-W/w));let ae=Hn(Math.atan2(U,X));ae=r.center.lng+function(ye,le){const ve=(le-ye+180)%360-180;return ve<-180?ve+360:ve}(r.center.lng,ae);const oe=Us(ae),se=ai(cs(ee),0,1);return new n(oe,se)}class un{constructor(e,i,s){this.a=Ie.vec3.sub([],e,s),this.b=Ie.vec3.sub([],i,s),this.center=s;const h=Ie.vec3.normalize([],this.a),a=Ie.vec3.normalize([],this.b);this.angle=Math.acos(Ie.vec3.dot(h,a))}}function jn(r,e){if(0===r.angle)return null;let i;return i=0===r.a[e]?1/r.angle*.5*Math.PI:1/r.angle*Math.atan(r.b[e]/r.a[e]/Math.sin(r.angle)-1/Math.tan(r.angle)),i<0||i>1?null:function(s,h,a,u){const x=Math.sin(a);return s*(Math.sin((1-u)*a)/x)+h*(Math.sin(u*a)/x)}(r.a[e],r.b[e],r.angle,ai(i,0,1))+r.center[e]}function An(r){if(r.z<=1)return Di[r.z+2*r.y+r.x];const e=ji(dn(r));return Pt.fromPoints(e)}function Mn(r,e,i){return Ie.vec3.scale(r,r,1-i),Ie.vec3.scaleAndAdd(r,r,e,i)}function Qr(r,e,i){for(const s of r)Ie.vec3.transformMat4(s,s,e),Ie.vec3.scale(s,s,i)}function mr(r,e,i,s){const h=e/r.worldSize,a=r.globeMatrix;if(i.z<=1){const oe=An(i).getCorners();return Qr(oe,a,h),Pt.fromPoints(oe)}const u=dn(i,s),x=ji(u,wr+pi(r._tileCoverLift));Qr(x,a,h);const T=Number.MAX_VALUE,C=[-T,-T,-T],g=[T,T,T];if(u.contains(r.center)){for(const ye of x)Ie.vec3.min(g,g,ye),Ie.vec3.max(C,C,ye);C[2]=0;const oe=r.point,se=[oe.x*h,oe.y*h,0];return Ie.vec3.min(g,g,se),Ie.vec3.max(C,C,se),new Pt(g,C)}if(r._tileCoverLift>0){for(const oe of x)Ie.vec3.min(g,g,oe),Ie.vec3.max(C,C,oe);return new Pt(g,C)}const S=[a[12]*h,a[13]*h,a[14]*h],A=u.getCenter(),w=ai(r.center.lat,-_n,_n),M=ai(A.lat,-_n,_n),P=Us(r.center.lng),O=cs(w);let B=P-Us(A.lng);const G=O-cs(M);B>.5?B-=1:B<-.5&&(B+=1);let q=0;if(Math.abs(B)>Math.abs(G))q=B>=0?1:3;else{q=G>=0?0:2;const oe=[a[4]*h,a[5]*h,a[6]*h],se=-Math.sin(yi(G>=0?u.getSouth():u.getNorth()))*wr;Ie.vec3.scaleAndAdd(S,S,oe,se)}const U=x[q],W=x[(q+1)%4],X=new un(U,W,S),ee=[jn(X,0)||U[0],jn(X,1)||U[1],jn(X,2)||U[2]],ae=Tr(r.zoom);if(ae>0){const oe=function({x:ye,y:le,z:ve},Se,we,Ae,Pe){const ke=1/(1<<ve);let Ce=ye*ke,Ze=Ce+ke,tt=le*ke,$e=tt+ke,gt=0;const mt=(Ce+Ze)/2-Ae;return mt>.5?gt=-1:mt<-.5&&(gt=1),Ce=((Ce+gt)*Se-(Ae*=Se))*we+Ae,Ze=((Ze+gt)*Se-Ae)*we+Ae,tt=(tt*Se-(Pe*=Se))*we+Pe,$e=($e*Se-Pe)*we+Pe,[[Ce,$e,0],[Ze,$e,0],[Ze,tt,0],[Ce,tt,0]]}(i,e,r._pixelsPerMercatorPixel,P,O);for(let ye=0;ye<x.length;ye++)Mn(x[ye],oe[ye],ae);const se=Ie.vec3.add([],oe[q],oe[(q+1)%4]);Ie.vec3.scale(se,se,.5),Mn(ee,se,ae)}for(const oe of x)Ie.vec3.min(g,g,oe),Ie.vec3.max(C,C,oe);return g[2]=Math.min(U[2],W[2]),Ie.vec3.min(g,g,ee),Ie.vec3.max(C,C,ee),new Pt(g,C)}function dn({x:r,y:e,z:i},s=!1){const h=1/(1<<i),a=new Ci(Vr(r*h),e===(1<<i)-1&&s?-90:$n((e+1)*h)),u=new Ci(Vr((r+1)*h),0===e&&s?90:$n(e*h));return new Go(a,u)}function ji(r,e=wr){const i=yi(r.getNorth()),s=yi(r.getSouth()),h=Math.cos(i),a=Math.cos(s),u=Math.sin(i),x=Math.sin(s),T=r.getWest(),C=r.getEast();return[gl(a,x,T,e),gl(a,x,C,e),gl(h,u,C,e),gl(h,u,T,e)]}function vi(r,e,i,s){const h=1<<i.z,a=(r/ft+i.x)/h;return va($n((e/ft+i.y)/h),Vr(a),s)}function bi({min:r,max:e}){return 16383/Math.max(e[0]-r[0],e[1]-r[1],e[2]-r[2])}const wn=new Float64Array(16);function kn(r){const e=bi(r),i=Ie.mat4.fromScaling(wn,[e,e,e]);return Ie.mat4.translate(i,i,Ie.vec3.negate([],r.min))}function Xi(r){const e=Ie.mat4.fromTranslation(wn,r.min),i=1/bi(r);return Ie.mat4.scale(e,e,[i,i,i])}function _r(r){const e=ft/(2*Math.PI);return r/(2*Math.PI)/e}function es(r,e){return ft/(512*Math.pow(2,r))*bi(An(e))}function Ur(r,e,i,s,h){const a=_r(i),u=[r,e,-i/(2*Math.PI)],x=Ie.mat4.identity(new Float64Array(16));return Ie.mat4.translate(x,x,u),Ie.mat4.scale(x,x,[a,a,a]),Ie.mat4.rotateX(x,x,yi(-h)),Ie.mat4.rotateY(x,x,yi(-s)),x}function Tr(r){return Ai(5,6,r)}function hs(r,e){const i=va(e.lat,e.lng),s=function(a){const u=va(a._center.lat,a._center.lng),x=Ie.vec3.fromValues(0,1,0);let T=Ie.vec3.cross([],x,u);const C=Ie.mat4.fromRotation([],-a.angle,u);T=Ie.vec3.transformMat4(T,T,C),Ie.mat4.fromRotation(C,-a._pitch,T);const g=Ie.vec3.normalize([],u);return Ie.vec3.scale(g,g,pi(a.cameraToCenterDistance/a.pixelsPerMeter)),Ie.vec3.transformMat4(g,g,C),Ie.vec3.add([],u,g)}(r),h=Ie.vec3.subtract([],s,i);return Ie.vec3.angle(h,i)}function Dr(r,e){return hs(r,e)>Math.PI/2*1.01}const ts=yi(85),wa=Math.cos(ts),js=Math.sin(ts),Ta=Ie.mat4.create(),xl=r=>{const e=[];return"map"===r.paint.get("circle-pitch-alignment")&&e.push("PITCH_WITH_MAP"),"map"===r.paint.get("circle-pitch-scale")&&e.push("SCALE_WITH_MAP"),e};function rh(r,e,i,s,h,a,u,x,T){if(a&&r.queryGeometry.isAboveHorizon)return!1;a&&(T*=r.pixelToTileUnitsFactor);const C=r.tileID.canonical,g=i.projection.upVectorScale(C,i.center.lat,i.worldSize).metersToTile;for(const S of e)for(const A of S){const w=A.add(x),M=h&&i.elevation?i.elevation.exaggeration()*h.getElevationAt(w.x,w.y,!0):0,P=i.projection.projectTilePoint(w.x,w.y,C);if(M>0){const q=i.projection.upVector(C,w.x,w.y);P.x+=q[0]*g*M,P.y+=q[1]*g*M,P.z+=q[2]*g*M}const O=a?w:Su(P.x,P.y,P.z,s),B=a?r.tilespaceRays.map(q=>yf(q,M)):r.queryGeometry.screenGeometry,G=Ie.vec4.transformMat4([],[P.x,P.y,P.z,1],s);if(!u&&a?T*=G[3]/i.cameraToCenterDistance:u&&!a&&(T*=i.cameraToCenterDistance/G[3]),a){const q=$n((A.y/ft+C.y)/(1<<C.z));T/=i.projection.pixelsPerMeter(q,1)/fr(1,q)}if(Q(B,O,T))return!0}return!1}function Su(r,e,i,s){const h=Ie.vec4.transformMat4([],[r,e,i,1],s);return new pt(h[0]/h[3],h[1]/h[3])}const Ep=Ie.vec3.fromValues(0,0,0),gf=Ie.vec3.fromValues(0,0,1);function yf(r,e){const i=Ie.vec3.create();return Ep[2]=e,r.intersectsPlane(Ep,gf,i),new pt(i[0],i[1])}class Ap extends Y{}let Ip,Cp,Pp,m;function f(r,{width:e,height:i},s,h){if(h){if(h instanceof Uint8ClampedArray)h=new Uint8Array(h.buffer);else if(h.length!==e*i*s)throw new RangeError("mismatched image size")}else h=new Uint8Array(e*i*s);return r.width=e,r.height=i,r.data=h,r}function d(r,e,i){const{width:s,height:h}=e;s===r.width&&h===r.height||(_(r,e,{x:0,y:0},{x:0,y:0},{width:Math.min(r.width,s),height:Math.min(r.height,h)},i,null),r.width=s,r.height=h,r.data=e.data)}function _(r,e,i,s,h,a,u,x){if(0===h.width||0===h.height)return e;if(h.width>r.width||h.height>r.height||i.x>r.width-h.width||i.y>r.height-h.height)throw new RangeError("out of range source coordinates for image copy");if(h.width>e.width||h.height>e.height||s.x>e.width-h.width||s.y>e.height-h.height)throw new RangeError("out of range destination coordinates for image copy");const T=r.data,C=e.data,g=4===a&&x;for(let S=0;S<h.height;S++){const A=((i.y+S)*r.width+i.x)*a,w=((s.y+S)*e.width+s.x)*a;if(g)for(let M=0;M<h.width;M++){const P=A+M*a+3,O=w+M*a;C[O+0]=255,C[O+1]=255,C[O+2]=255,C[O+3]=T[P]}else if(u)for(let M=0;M<h.width;M++){const P=A+M*a,O=w+M*a,B=T[P+3],G=new Ri(T[P+0]/255*B,T[P+1]/255*B,T[P+2]/255*B,B).toRenderColor(u).toArray();C[O+0]=G[0],C[O+1]=G[1],C[O+2]=G[2],C[O+3]=G[3]}else for(let M=0;M<h.width*a;M++)C[w+M]=T[A+M]}return e}St(Ap,"HeatmapBucket",{omit:["layers"]});class v{constructor(e,i){f(this,e,1,i)}resize(e){d(this,new v(e),1)}clone(){return new v({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,s,h,a){_(e,i,s,h,a,1,null)}}class I{constructor(e,i){f(this,e,4,i)}resize(e){d(this,new I(e),4)}replace(e,i){i?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new I({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,s,h,a,u,x){_(e,i,s,h,a,4,u,x)}}class z{constructor(e,i){this.width=e.width,this.height=e.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}function R(r){const e={},i=r.resolution||256,s=r.clips?r.clips.length:1,h=r.image||new I({width:i,height:s}),a=(u,x,T)=>{e[r.evaluationKey]=T;const C=r.expression.evaluate(e);C&&(h.data[u+x+0]=Math.floor(255*C.r/C.a),h.data[u+x+1]=Math.floor(255*C.g/C.a),h.data[u+x+2]=Math.floor(255*C.b/C.a),h.data[u+x+3]=Math.floor(255*C.a))};if(r.clips)for(let u=0,x=0;u<s;++u,x+=4*i)for(let T=0,C=0;T<i;T++,C+=4){const g=T/(i-1),{start:S,end:A}=r.clips[u];a(x,C,S*(1-g)+A*g)}else for(let u=0,x=0;u<i;u++,x+=4)a(0,x,u/(i-1));return h}St(v,"AlphaImage"),St(I,"RGBAImage");const F=Li([{name:"a_pos",components:2,type:"Int16"}],4),{members:H}=F;function K(r,e,i=2){const s=e&&e.length,h=s?e[0]*i:r.length;let a=ie(r,0,h,i,!0);const u=[];if(!a||a.next===a.prev)return u;let x,T,C;if(s&&(a=function(g,S,A,w){const M=[];for(let P=0,O=S.length;P<O;P++){const B=ie(g,S[P]*w,P<O-1?S[P+1]*w:g.length,w,!1);B===B.next&&(B.steiner=!0),M.push(At(B))}M.sort(lt);for(let P=0;P<M.length;P++)A=Et(M[P],A);return A}(r,e,a,i)),r.length>80*i){x=1/0,T=1/0;let g=-1/0,S=-1/0;for(let A=i;A<h;A+=i){const w=r[A],M=r[A+1];w<x&&(x=w),M<T&&(T=M),w>g&&(g=w),M>S&&(S=M)}C=Math.max(g-x,S-T),C=0!==C?32767/C:0}return xe(a,u,i,x,T,C,0),u}function ie(r,e,i,s,h){let a;if(h===function(u,x,T,C){let g=0;for(let S=x,A=T-C;S<T;S+=C)g+=(u[A]-u[S])*(u[S+1]+u[A+1]),A=S;return g}(r,e,i,s)>0)for(let u=e;u<i;u+=s)a=In(u/s|0,r[u],r[u+1],a);else for(let u=i-s;u>=e;u-=s)a=In(u/s|0,r[u],r[u+1],a);return a&&Fi(a,a.next)&&(Cn(a),a=a.next),a}function ue(r,e){if(!r)return r;e||(e=r);let i,s=r;do{if(i=!1,s.steiner||!Fi(s,s.next)&&0!==Bt(s.prev,s,s.next))s=s.next;else{if(Cn(s),s=e=s.prev,s===s.next)break;i=!0}}while(i||s!==e);return e}function xe(r,e,i,s,h,a,u){if(!r)return;!u&&a&&function(T,C,g,S){let A=T;do{0===A.z&&(A.z=xt(A.x,A.y,C,g,S)),A.prevZ=A.prev,A.nextZ=A.next,A=A.next}while(A!==T);A.prevZ.nextZ=null,A.prevZ=null,function(w){let M,P=1;do{let O,B=w;w=null;let G=null;for(M=0;B;){M++;let q=B,U=0;for(let X=0;X<P&&(U++,q=q.nextZ,q);X++);let W=P;for(;U>0||W>0&&q;)0!==U&&(0===W||!q||B.z<=q.z)?(O=B,B=B.nextZ,U--):(O=q,q=q.nextZ,W--),G?G.nextZ=O:w=O,O.prevZ=G,G=O;B=q}G.nextZ=null,P*=2}while(M>1)}(A)}(r,s,h,a);let x=r;for(;r.prev!==r.next;){const T=r.prev,C=r.next;if(a?Be(r,s,h,a):Oe(r))e.push(T.i,r.i,C.i),Cn(r),r=C.next,x=C.next;else if((r=C)===x){u?1===u?xe(r=je(ue(r),e),e,i,s,h,a,2):2===u&&ht(r,e,i,s,h,a):xe(ue(r),e,i,s,h,a,1);break}}}function Oe(r){const e=r.prev,i=r,s=r.next;if(Bt(e,i,s)>=0)return!1;const h=e.x,a=i.x,u=s.x,x=e.y,T=i.y,C=s.y,g=h<a?h<u?h:u:a<u?a:u,S=x<T?x<C?x:C:T<C?T:C,A=h>a?h>u?h:u:a>u?a:u,w=x>T?x>C?x:C:T>C?T:C;let M=s.next;for(;M!==e;){if(M.x>=g&&M.x<=A&&M.y>=S&&M.y<=w&&Ht(h,x,a,T,u,C,M.x,M.y)&&Bt(M.prev,M,M.next)>=0)return!1;M=M.next}return!0}function Be(r,e,i,s){const h=r.prev,a=r,u=r.next;if(Bt(h,a,u)>=0)return!1;const x=h.x,T=a.x,C=u.x,g=h.y,S=a.y,A=u.y,w=x<T?x<C?x:C:T<C?T:C,M=g<S?g<A?g:A:S<A?S:A,P=x>T?x>C?x:C:T>C?T:C,O=g>S?g>A?g:A:S>A?S:A,B=xt(w,M,e,i,s),G=xt(P,O,e,i,s);let q=r.prevZ,U=r.nextZ;for(;q&&q.z>=B&&U&&U.z<=G;){if(q.x>=w&&q.x<=P&&q.y>=M&&q.y<=O&&q!==h&&q!==u&&Ht(x,g,T,S,C,A,q.x,q.y)&&Bt(q.prev,q,q.next)>=0||(q=q.prevZ,U.x>=w&&U.x<=P&&U.y>=M&&U.y<=O&&U!==h&&U!==u&&Ht(x,g,T,S,C,A,U.x,U.y)&&Bt(U.prev,U,U.next)>=0))return!1;U=U.nextZ}for(;q&&q.z>=B;){if(q.x>=w&&q.x<=P&&q.y>=M&&q.y<=O&&q!==h&&q!==u&&Ht(x,g,T,S,C,A,q.x,q.y)&&Bt(q.prev,q,q.next)>=0)return!1;q=q.prevZ}for(;U&&U.z<=G;){if(U.x>=w&&U.x<=P&&U.y>=M&&U.y<=O&&U!==h&&U!==u&&Ht(x,g,T,S,C,A,U.x,U.y)&&Bt(U.prev,U,U.next)>=0)return!1;U=U.nextZ}return!0}function je(r,e){let i=r;do{const s=i.prev,h=i.next.next;!Fi(s,h)&&Vi(s,i,i.next,h)&&zr(s,h)&&zr(h,s)&&(e.push(s.i,i.i,h.i),Cn(i),Cn(i.next),i=r=h),i=i.next}while(i!==r);return ue(i)}function ht(r,e,i,s,h,a){let u=r;do{let x=u.next.next;for(;x!==u.prev;){if(u.i!==x.i&&Ot(u,x)){let T=gn(u,x);return u=ue(u,u.next),T=ue(T,T.next),xe(u,e,i,s,h,a,0),void xe(T,e,i,s,h,a,0)}x=x.next}u=u.next}while(u!==r)}function lt(r,e){return r.x-e.x}function Et(r,e){const i=function(h,a){let u=a;const x=h.x,T=h.y;let C,g=-1/0;do{if(T<=u.y&&T>=u.next.y&&u.next.y!==u.y){const P=u.x+(T-u.y)*(u.next.x-u.x)/(u.next.y-u.y);if(P<=x&&P>g&&(g=P,C=u.x<u.next.x?u:u.next,P===x))return C}u=u.next}while(u!==a);if(!C)return null;const S=C,A=C.x,w=C.y;let M=1/0;u=C;do{if(x>=u.x&&u.x>=A&&x!==u.x&&Ht(T<w?x:g,T,A,w,T<w?g:x,T,u.x,u.y)){const P=Math.abs(T-u.y)/(x-u.x);zr(u,h)&&(P<M||P===M&&(u.x>C.x||u.x===C.x&&Dt(C,u)))&&(C=u,M=P)}u=u.next}while(u!==S);return C}(r,e);if(!i)return e;const s=gn(i,r);return ue(s,s.next),ue(i,i.next)}function Dt(r,e){return Bt(r.prev,r,e.prev)<0&&Bt(e.next,r,r.next)<0}function xt(r,e,i,s,h){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=(r-i)*h|0)|r<<8))|r<<4))|r<<2))|r<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*h|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function At(r){let e=r,i=r;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==r);return i}function Ht(r,e,i,s,h,a,u,x){return(h-u)*(e-x)>=(r-u)*(a-x)&&(r-u)*(s-x)>=(i-u)*(e-x)&&(i-u)*(a-x)>=(h-u)*(s-x)}function Ot(r,e){return r.next.i!==e.i&&r.prev.i!==e.i&&!function(i,s){let h=i;do{if(h.i!==i.i&&h.next.i!==i.i&&h.i!==s.i&&h.next.i!==s.i&&Vi(h,h.next,i,s))return!0;h=h.next}while(h!==i);return!1}(r,e)&&(zr(r,e)&&zr(e,r)&&function(i,s){let h=i,a=!1;const u=(i.x+s.x)/2,x=(i.y+s.y)/2;do{h.y>x!=h.next.y>x&&h.next.y!==h.y&&u<(h.next.x-h.x)*(x-h.y)/(h.next.y-h.y)+h.x&&(a=!a),h=h.next}while(h!==i);return a}(r,e)&&(Bt(r.prev,r,e.prev)||Bt(r,e.prev,e))||Fi(r,e)&&Bt(r.prev,r,r.next)>0&&Bt(e.prev,e,e.next)>0)}function Bt(r,e,i){return(e.y-r.y)*(i.x-e.x)-(e.x-r.x)*(i.y-e.y)}function Fi(r,e){return r.x===e.x&&r.y===e.y}function Vi(r,e,i,s){const h=or(Bt(r,e,i)),a=or(Bt(r,e,s)),u=or(Bt(i,s,r)),x=or(Bt(i,s,e));return h!==a&&u!==x||!(0!==h||!Wi(r,i,e))||!(0!==a||!Wi(r,s,e))||!(0!==u||!Wi(i,r,s))||!(0!==x||!Wi(i,e,s))}function Wi(r,e,i){return e.x<=Math.max(r.x,i.x)&&e.x>=Math.min(r.x,i.x)&&e.y<=Math.max(r.y,i.y)&&e.y>=Math.min(r.y,i.y)}function or(r){return r>0?1:r<0?-1:0}function zr(r,e){return Bt(r.prev,r,r.next)<0?Bt(r,e,r.next)>=0&&Bt(r,r.prev,e)>=0:Bt(r,e,r.prev)<0||Bt(r,r.next,e)<0}function gn(r,e){const i=ws(r.i,r.x,r.y),s=ws(e.i,e.x,e.y),h=r.next,a=e.prev;return r.next=e,e.prev=r,i.next=h,h.prev=i,s.next=i,i.prev=s,a.next=s,s.prev=a,s}function In(r,e,i,s){const h=ws(r,e,i);return s?(h.next=s.next,h.prev=s,s.next.prev=h,s.next=h):(h.prev=h,h.next=h),h}function Cn(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function ws(r,e,i){return{i:r,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function gr(r,e){const i=r.length;if(i<=1)return[r];const s=[];let h,a;for(let u=0;u<i;u++){const x=mo(r[u]);0!==x&&(r[u].area=Math.abs(x),void 0===a&&(a=x<0),a===x<0?(h&&s.push(h),h=[r[u]]):h.push(r[u]))}if(h&&s.push(h),e>1)for(let u=0;u<s.length;u++)s[u].length<=e||(Ga(s[u],e,1,s[u].length-1,sh),s[u]=s[u].slice(0,e));return s}function sh(r,e){return e.area-r.area}function Mu(r,e,i=1){if(!r)return null;const s="string"==typeof r?r:r.getPrimary().id;e[s]||(e[s]=[]);const h=rr.from(s).getPrimary().scaleSelf(i);return e[s].push(h),h.serialize()}function vl(r,e,i,s){const h=s.patternDependencies;let a=!1;for(const u of e){const x=u.paint.get(`${r}-pattern`);x.isConstant()||(a=!0),Mu(x.constantOr(null),h,i)&&(a=!0)}return a}function pc(r,e,i,s,h,a){const u=a.patternDependencies;for(const x of e){const T=x.paint.get(`${r}-pattern`).value;if("constant"!==T.kind){let C=T.evaluate({zoom:s},i,{},a.availableImages);C=C&&C.name?C.name:C;const g=Mu(C,u,h);g&&(i.patterns[x.id]=g)}}return i}class Sa{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new Os,this.indexArray=new Ln,this.indexArray2=new so,this.programConfigurations=new Vs(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new vn,this.segments2=new vn,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.projection=e.projection}updateFootprints(e,i){}populate(e,i,s,h){this.hasPattern=vl("fill",this.layers,this.pixelRatio,i);const a=this.layers[0].layout.get("fill-sort-key"),u=[];for(const{feature:x,id:T,index:C,sourceLayerIndex:g}of e){const S=this.layers[0]._featureFilter.needGeometry,A=N(x,S);if(!this.layers[0]._featureFilter.filter(new Zi(this.zoom),A,s))continue;const w=a?a.evaluate(A,{},s,i.availableImages):void 0,M={id:T,properties:x.properties,type:x.type,sourceLayerIndex:g,index:C,geometry:S?A.geometry:k(x,s,h),patterns:{},sortKey:w};u.push(M)}a&&u.sort((x,T)=>x.sortKey-T.sortKey);for(const x of u){const{geometry:T,index:C,sourceLayerIndex:g}=x;if(this.hasPattern){const S=pc("fill",this.layers,x,this.zoom,this.pixelRatio,i);this.patternFeatures.push(S)}else this.addFeature(x,T,C,s,{},i.availableImages,i.brightness,i.elevationFeatures);i.featureIndex.insert(e[C].feature,T,C,g,this.index)}}update(e,i,s,h,a,u,x){this.programConfigurations.updatePaintArrays(e,i,a,s,h,u,x)}addFeatures(e,i,s,h,a,u){for(const x of this.patternFeatures)this.addFeature(x,x.geometry,x.index,i,s,h,u,e.elevationFeatures)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,H),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(e,i,s,h,a,u=[],x,T){for(const C of gr(i,500)){let g=0;for(const O of C)g+=O.length;const S=this.segments.prepareSegment(g,this.layoutVertexArray,this.indexArray),A=S.vertexLength,w=[],M=[];for(const O of C){if(0===O.length)continue;O!==C[0]&&M.push(w.length/2);const B=this.segments2.prepareSegment(O.length,this.layoutVertexArray,this.indexArray2),G=B.vertexLength;this.layoutVertexArray.emplaceBack(O[0].x,O[0].y),this.indexArray2.emplaceBack(G+O.length-1,G),w.push(O[0].x),w.push(O[0].y);for(let q=1;q<O.length;q++)this.layoutVertexArray.emplaceBack(O[q].x,O[q].y),this.indexArray2.emplaceBack(G+q-1,G+q),w.push(O[q].x),w.push(O[q].y);B.vertexLength+=O.length,B.primitiveLength+=O.length}const P=K(w,M);for(let O=0;O<P.length;O+=3)this.indexArray.emplaceBack(A+P[O],A+P[O+1],A+P[O+2]);S.vertexLength+=g,S.primitiveLength+=P.length/3}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,a,u,h,x)}}let oh,bl,Cm,Pm;St(Sa,"FillBucket",{omit:["layers","patternFeatures"]});class xf{constructor(e,i,s,h){if(this.triangleCount=i.length/3,this.min=new pt(0,0),this.max=new pt(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],0===this.triangleCount||0===e.length)return;const[a,u]=[e[0].clone(),e[0].clone()];for(let S=1;S<e.length;++S){const A=e[S];a.x=Math.min(a.x,A.x),a.y=Math.min(a.y,A.y),u.x=Math.max(u.x,A.x),u.y=Math.max(u.y,A.y)}if(h){const S=Math.ceil(Math.max(u.x-a.x,u.y-a.y)/h);s=Math.max(s,S)}if(0===s)return;this.min=a,this.max=u;const x=this.max.sub(this.min);x.x=Math.max(x.x,1),x.y=Math.max(x.y,1);const T=Math.max(x.x,x.y)/s;this.cellsX=Math.max(1,Math.ceil(x.x/T)),this.cellsY=Math.max(1,Math.ceil(x.y/T)),this.xScale=1/T,this.yScale=1/T;const C=[];for(let S=0;S<this.triangleCount;S++){const A=e[i[3*S+0]].sub(this.min),w=e[i[3*S+1]].sub(this.min),M=e[i[3*S+2]].sub(this.min),P=wl(Math.floor(Math.min(A.x,w.x,M.x)),this.xScale,this.cellsX),O=wl(Math.floor(Math.max(A.x,w.x,M.x)),this.xScale,this.cellsX),B=wl(Math.floor(Math.min(A.y,w.y,M.y)),this.yScale,this.cellsY),G=wl(Math.floor(Math.max(A.y,w.y,M.y)),this.yScale,this.cellsY),q=new pt(0,0),U=new pt(0,0),W=new pt(0,0),X=new pt(0,0);for(let ee=B;ee<=G;++ee){q.y=U.y=ee*T,W.y=X.y=(ee+1)*T;for(let ae=P;ae<=O;++ae)q.x=W.x=ae*T,U.x=X.x=(ae+1)*T,(Le(A,w,M,q,U,X)||Le(A,w,M,q,X,W))&&C.push({cellIdx:ee*this.cellsX+ae,triIdx:S})}}if(0===C.length)return;C.sort((S,A)=>S.cellIdx-A.cellIdx||S.triIdx-A.triIdx);let g=0;for(;g<C.length;){const S=C[g].cellIdx,A={start:this.payload.length,len:0};for(;g<C.length&&C[g].cellIdx===S;)++A.len,this.payload.push(C[g++].triIdx);this.cells[S]=A}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,i){if(0===this.triangleCount||0===this.cells.length||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const s=wl(e.x-this.min.x,this.xScale,this.cellsX),h=wl(e.y-this.min.y,this.yScale,this.cellsY),a=this.cells[h*this.cellsX+s];if(a){this._lazyInitLookup();for(let u=0;u<a.len;u++){const x=this.payload[a.start+u],T=Math.floor(x/8),C=1<<x%8;if(!(this.lookup[T]&C)&&(this.lookup[T]|=C,i.push(x),i.length===this.triangleCount))return}}}query(e,i,s){if(0===this.triangleCount||0===this.cells.length||e.x>this.max.x||this.min.x>i.x||e.y>this.max.y||this.min.y>i.y)return;this._lazyInitLookup();const h=wl(e.x-this.min.x,this.xScale,this.cellsX),a=wl(i.x-this.min.x,this.xScale,this.cellsX),u=wl(e.y-this.min.y,this.yScale,this.cellsY),x=wl(i.y-this.min.y,this.yScale,this.cellsY);for(let T=u;T<=x;T++)for(let C=h;C<=a;C++){const g=this.cells[T*this.cellsX+C];if(g)for(let S=0;S<g.len;S++){const A=this.payload[g.start+S],w=Math.floor(A/8),M=1<<A%8;if(!(this.lookup[w]&M)&&(this.lookup[w]|=M,s.push(A),s.length===this.triangleCount))return}}}}function wl(r,e,i){return Math.max(0,Math.min(i-1,Math.floor(r*e)))}St(xf,"TriangleGridIndex");class Dm{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.footprints=[]}updateFootprints(e,i){for(const s of this.footprints)i.push({footprint:s,id:e})}populate(e,i,s,h){const a=[];for(const{feature:u,id:x,index:T,sourceLayerIndex:C}of e){const g=this.layers[0]._featureFilter.needGeometry,S=N(u,g);if(!this.layers[0]._featureFilter.filter(new Zi(this.zoom),S,s))continue;const A={id:x,properties:u.properties,type:u.type,sourceLayerIndex:C,index:T,geometry:g?S.geometry:k(u,s,h),patterns:{}};a.push(A)}for(const u of a){const{geometry:x,index:T,sourceLayerIndex:C}=u;this.addFeature(u,x,T,s,{},i.availableImages,i.brightness),i.featureIndex.insert(e[T].feature,x,T,C,this.index)}}isEmpty(){return 0===this.footprints.length}uploadPending(){return!1}upload(e){}update(e,i,s,h,a,u,x){}destroy(){}addFeature(e,i,s,h,a,u=[],x){for(const T of gr(i,2)){const C=[],g=[],S=[],A=new pt(1/0,1/0),w=new pt(-1/0,-1/0);for(const O of T)if(0!==O.length){O!==T[0]&&S.push(g.length/2);for(let B=0;B<O.length;B++)g.push(O[B].x),g.push(O[B].y),C.push(O[B]),A.x=Math.min(A.x,O[B].x),A.y=Math.min(A.y,O[B].y),w.x=Math.max(w.x,O[B].x),w.y=Math.max(w.y,O[B].y)}const M=K(g,S),P=new xf(C,M,8,256);this.footprints.push({vertices:C,indices:M,grid:P,min:A,max:w})}}}St(Dm,"ClipBucket",{omit:["layers"]});const By=Li([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),Ny=Li([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),Vy=Li([{name:"a_centroid_pos",components:2,type:"Uint16"}]),Uy=Li([{name:"a_join_normal_inside",components:3,type:"Int16"}]),jy=Li([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),Gy=Li([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:qy}=By;var vf,zm,bf,Rm,wf,Lm,km,Dp={};function Om(){if(zm)return vf;zm=1;var r=Ko();function e(h,a,u,x,T){this.properties={},this.extent=u,this.type=0,this._pbf=h,this._geometry=-1,this._keys=x,this._values=T,h.readFields(i,this,a)}function i(h,a,u){1==h?a.id=u.readVarint():2==h?function(x,T){for(var C=x.readVarint()+x.pos;x.pos<C;){var g=T._keys[x.readVarint()],S=T._values[x.readVarint()];T.properties[g]=S}}(u,a):3==h?a.type=u.readVarint():4==h&&(a._geometry=u.pos)}function s(h){for(var a,u,x=0,T=0,C=h.length,g=C-1;T<C;g=T++)x+=((u=h[g]).x-(a=h[T]).x)*(a.y+u.y);return x}return vf=e,e.types=["Unknown","Point","LineString","Polygon"],e.prototype.loadGeometry=function(){var h=this._pbf;h.pos=this._geometry;for(var a,u=h.readVarint()+h.pos,x=1,T=0,C=0,g=0,S=[];h.pos<u;){if(T<=0){var A=h.readVarint();x=7&A,T=A>>3}if(T--,1===x||2===x)C+=h.readSVarint(),g+=h.readSVarint(),1===x&&(a&&S.push(a),a=[]),a.push(new r(C,g));else{if(7!==x)throw new Error("unknown command "+x);a&&a.push(a[0].clone())}}return a&&S.push(a),S},e.prototype.bbox=function(){var h=this._pbf;h.pos=this._geometry;for(var a=h.readVarint()+h.pos,u=1,x=0,T=0,C=0,g=1/0,S=-1/0,A=1/0,w=-1/0;h.pos<a;){if(x<=0){var M=h.readVarint();u=7&M,x=M>>3}if(x--,1===u||2===u)(T+=h.readSVarint())<g&&(g=T),T>S&&(S=T),(C+=h.readSVarint())<A&&(A=C),C>w&&(w=C);else if(7!==u)throw new Error("unknown command "+u)}return[g,A,S,w]},e.prototype.toGeoJSON=function(h,a,u){var x,T,C=this.extent*Math.pow(2,u),g=this.extent*h,S=this.extent*a,A=this.loadGeometry(),w=e.types[this.type];function M(B){for(var G=0;G<B.length;G++){var q=B[G];B[G]=[360*(q.x+g)/C-180,360/Math.PI*Math.atan(Math.exp((180-360*(q.y+S)/C)*Math.PI/180))-90]}}switch(this.type){case 1:var P=[];for(x=0;x<A.length;x++)P[x]=A[x][0];M(A=P);break;case 2:for(x=0;x<A.length;x++)M(A[x]);break;case 3:for(A=function(B){var G=B.length;if(G<=1)return[B];for(var q,U,W=[],X=0;X<G;X++){var ee=s(B[X]);0!==ee&&(void 0===U&&(U=ee<0),U===ee<0?(q&&W.push(q),q=[B[X]]):q.push(B[X]))}return q&&W.push(q),W}(A),x=0;x<A.length;x++)for(T=0;T<A[x].length;T++)M(A[x][T])}1===A.length?A=A[0]:w="Multi"+w;var O={type:"Feature",geometry:{type:w,coordinates:A},properties:this.properties};return"id"in this&&(O.id=this.id),O},vf}function Fm(){if(Rm)return bf;Rm=1;var r=Om();function e(s,h){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=s,this._keys=[],this._values=[],this._features=[],s.readFields(i,this,h),this.length=this._features.length}function i(s,h,a){15===s?h.version=a.readVarint():1===s?h.name=a.readString():5===s?h.extent=a.readVarint():2===s?h._features.push(a.pos):3===s?h._keys.push(a.readString()):4===s&&h._values.push(function(u){for(var x=null,T=u.readVarint()+u.pos;u.pos<T;){var C=u.readVarint()>>3;x=1===C?u.readString():2===C?u.readFloat():3===C?u.readDouble():4===C?u.readVarint64():5===C?u.readVarint():6===C?u.readSVarint():7===C?u.readBoolean():null}return x}(a))}return bf=e,e.prototype.feature=function(s){if(s<0||s>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[s];var h=this._pbf.readVarint()+this._pbf.pos;return new r(this._pbf,h,this.extent,this._keys,this._values)},bf}function Bm(){return km||(km=1,Dp.VectorTile=function(){if(Lm)return wf;Lm=1;var r=Fm();function e(i,s,h){if(3===i){var a=new r(h,h.readVarint()+h.pos);a.length&&(s[a.name]=a)}}return wf=function(i,s){this.layers=i.readFields(e,{},s)}}(),Dp.VectorTileFeature=Om(),Dp.VectorTileLayer=Fm()),Dp}var fd=Bm();class Eu extends pt{constructor(e,i,s){super(e,i),this.z=s}}class Nm extends Eu{constructor(e,i,s,h){super(e,i,s),this.w=h}}function zp(r,e,i,s){const h=[],a=0===s?(u,x,T,C,g,S)=>{u.push(new pt(S,T+(S-x)/(C-x)*(g-T)))}:(u,x,T,C,g,S)=>{u.push(new pt(x+(S-T)/(g-T)*(C-x),S))};for(const u of r){const x=[];for(const T of u){if(T.length<=2)continue;const C=[];for(let A=0;A<T.length-1;A++){const w=T[A].x,M=T[A].y,P=T[A+1].x,O=T[A+1].y,B=0===s?w:M,G=0===s?P:O;B<e?G>e&&a(C,w,M,P,O,e):B>i?G<i&&a(C,w,M,P,O,i):C.push(T[A]),G<e&&B>=e&&a(C,w,M,P,O,e),G>i&&B<=i&&a(C,w,M,P,O,i)}let g=T[T.length-1];const S=0===s?g.x:g.y;S>=e&&S<=i&&C.push(g),C.length&&(g=C[C.length-1],C[0].x===g.x&&C[0].y===g.y||C.push(C[0]),x.push(C))}x.length&&h.push(x)}return h}function Vm(r,e,i,s){const h="x"===i?"y":"x",a=(s-r[i])/(e[i]-r[i]);r[h]=r[h]+(e[h]-r[h])*a,r[i]=s,r.hasOwnProperty("z")&&(r.z=Ut(r.z,e.z,a)),r.hasOwnProperty("w")&&(r.w=Ut(r.w,e.w,a))}function Um(r,e,i,s){const h=i,a=s;for(const u of["x","y"]){let x=r,T=e;x[u]>=T[u]&&(x=e,T=r),x[u]<h&&T[u]>h&&Vm(x,T,u,h),x[u]<a&&T[u]>a&&Vm(T,x,u,a)}}const Rp=Number.MAX_SAFE_INTEGER;function jm(r,e,i,s){return r.order<e||r.order===Rp||!(r.clipMask&i)||(h=s,0!==(a=r.clipScope).length&&void 0===a.find(u=>u===h));var h,a}function Lp(r,e){return r.x-e.x||r.y-e.y}function Gm(r,e){return 0===Lp(r.min,e.min)&&0===Lp(r.max,e.max)}function Tf(r,e){return!(r.min.x>e.max.x||r.max.x<e.min.x||r.min.y>e.max.y||r.max.y<e.min.y)}function Sf(r,e){if(r.length!==e.length)return!1;for(let i=0;i<r.length;i++)if(r[i].sourceId!==e[i].sourceId||!Gm(r[i],e[i])||r[i].order!==e[i].order||r[i].clipMask!==e[i].clipMask||!Fn(r[i].clipScope,e[i].clipScope))return!1;return!0}function qm(r,e,i){const s=1/ft,h=1/(1<<i.canonical.z),a=(e.x*s+i.canonical.x)*h+i.wrap,u=(e.y*s+i.canonical.y)*h;return{min:new pt((r.x*s+i.canonical.x)*h+i.wrap,(r.y*s+i.canonical.y)*h),max:new pt(a,u)}}function Hy(r,e,i){const s=1<<i.canonical.z,h=((e.x-i.wrap)*s-i.canonical.x)*ft,a=(e.y*s-i.canonical.y)*ft;return{min:new pt(((r.x-i.wrap)*s-i.canonical.x)*ft,(r.y*s-i.canonical.y)*ft),max:new pt(h,a)}}function Hm(r,e,i,s,h,a,u){const x=r.indices,T=r.vertices,C=[];for(let g=s;g<s+h;g+=3){const S=e[i[g+0]+a],A=e[i[g+1]+a],w=e[i[g+2]+a],M=Math.min(S.x,A.x,w.x),P=Math.max(S.x,A.x,w.x),O=Math.min(S.y,A.y,w.y),B=Math.max(S.y,A.y,w.y);C.length=0,r.grid.query(new pt(M,O),new pt(P,B),C);for(let G=0;G<C.length;G++){const q=C[G];if(Le(T[x[3*q+0]],T[x[3*q+1]],T[x[3*q+2]],S,A,w,u))return!0}}return!1}function Wm(r,e,i,s){if(!r||!i)return!1;let h=r.vertices;if(!e.canonical.equals(s.canonical)||e.wrap!==s.wrap){if(i.vertices.length<r.vertices.length)return Wm(i,s,r,e);const a=e.canonical,u=s.canonical,x=Math.pow(2,u.z-a.z);h=r.vertices.map(T=>new pt((T.x+a.x*ft)*x-u.x*ft,(T.y+a.y*ft)*x-u.y*ft))}return Hm(i,h,r.indices,0,r.indices.length,0,0)}function $m(r,e,i,s){const h=Math.pow(2,s.z-i.z);return new pt((r+i.x*ft)*h-s.x*ft,(e+i.y*ft)*h-s.y*ft)}function Zm(r,e){const i=[];e.grid.queryPoint(r,i);const s=e.indices,h=e.vertices;for(let a=0;a<i.length;a++){const u=i[a];if(de([h[s[3*u+0]],h[s[3*u+1]],h[s[3*u+2]]],r))return!0}return!1}const Mf=[new pt(0,0),new pt(ft,0),new pt(ft,ft),new pt(0,ft)];function Xm(r,e){const i=[];let s=[];if(!e||r.length<2)return[r];if(2===r.length)return Ee(r[0],r[1],Mf)?[r]:[];for(let h=0;h<r.length+2;h++){const a=r[h%r.length],u=r[(h+1)%r.length],x=Ee(0===h?r[r.length-1]:r[(h-1)%r.length],a,Mf),T=Ee(a,u,Mf),C=x||T;C&&s.push(a),C&&T||s.length>0&&(s.length>1&&i.push(s),s=[])}return s.length>1&&i.push(s),i}const Ef=fd.VectorTileFeature.types,Wy=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],$y=["fill-extrusion-flood-light-ground-radius"],Zy=Math.pow(2,13),Xy=Math.pow(2,15)-1,Ym=new pt(0,1),ah=2147483648;function Xd(r,e,i,s,h,a,u,x){r.emplaceBack((e<<1)+u,(i<<1)+a,(Math.floor(s*Zy)<<1)+h,Math.round(x))}function Yd(r,e,i){r.emplaceBack(e.x*ft,e.y*ft,i?1:0)}function kp(r,e,i,s,h,a){r.emplaceBack(e.x,e.y,(i.x<<1)+s,(i.y<<1)+h,a)}function Kd(r,e,i){r.emplaceBack(e.x,e.y,e.z,16384*i[0],16384*i[1],16384*i[2])}class Km{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class Jm{constructor(){this.centroidXY=new pt(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new pt(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new pt(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0}span(){return new pt(this.max.x-this.min.x,this.max.y-this.min.y)}}class Qm{constructor(){this.acc=new pt(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,i){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=i.x,e.min.y=e.max.y=i.y)}appendEdge(e,i,s){this.accCount++,this.acc._add(i);let h=!!this.borders;i.x<e.min.x?(e.min.x=i.x,h=!0):i.x>e.max.x&&(e.max.x=i.x,h=!0),i.y<e.min.y?(e.min.y=i.y,h=!0):i.y>e.max.y&&(e.max.y=i.y,h=!0),((0===i.x||i.x===ft)&&i.x===s.x)!=((0===i.y||i.y===ft)&&i.y===s.y)&&this.processBorderOverlap(i,s),h&&this.checkBorderIntersection(i,s)}checkBorderIntersection(e,i){i.x<0!=e.x<0&&this.addBorderIntersection(0,Ut(i.y,e.y,(0-i.x)/(e.x-i.x))),i.x>ft!=e.x>ft&&this.addBorderIntersection(1,Ut(i.y,e.y,(ft-i.x)/(e.x-i.x))),i.y<0!=e.y<0&&this.addBorderIntersection(2,Ut(i.x,e.x,(0-i.y)/(e.y-i.y))),i.y>ft!=e.y>ft&&this.addBorderIntersection(3,Ut(i.x,e.x,(ft-i.y)/(e.y-i.y)))}addBorderIntersection(e,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const s=this.borders[e];i<s[0]&&(s[0]=i),i>s[1]&&(s[1]=i)}processBorderOverlap(e,i){if(e.x===i.x){if(e.y===i.y)return;const s=0===e.x?0:1;this.addBorderIntersection(s,i.y),this.addBorderIntersection(s,e.y)}else{const s=0===e.y?2:3;this.addBorderIntersection(s,i.x),this.addBorderIntersection(s,e.x)}}centroid(){return 0===this.accCount?new pt(0,0):new pt(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce((e,i)=>e+ +(i[0]!==Number.MAX_VALUE),0):0}}function e_(r,e){const i=r.add(e)._unit(),s=ai(r.x*i.x+r.y*i.y,-1,1);var h,a,u;return u=Math.acos(s),Math.min(4,Math.max(-4,Math.tan(u)))/4*Xy*((h=r).x*(a=e).y-h.y*a.x<0?-1:1)}const Yy=[r=>r.x<0,r=>r.x>ft,r=>r.y<0,r=>r.y>ft];function Ky(r,e,i,s){const h=[4];if(0===s)return h;i._mult(s);const a=r.sub(i),u=e.sub(i),x=[r,e,a,u];for(let T=0;T<4;T++)for(const C of x)if(Yy[T](C)){h.push(T);break}return h}class t_{constructor(e){this.vertexArray=new $c,this.indexArray=new Ln,this.programConfigurations=new Vs(e.layers,{zoom:e.zoom,lut:e.lut},i=>$y.includes(i)),this._segments=new vn,this.hiddenByLandmarkVertexArray=new Jc,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new vn}getDefaultSegment(){return this.regionSegments[4]}hasData(){return 0!==this.vertexArray.length}addData(e,i,s,h=!1){const a=e.length;if(a>2){let u=Math.max(0,this._segments.get().length-1);const x=this._segments._prepareSegment(4*a,this.vertexArray.length,2*this._segmentToGroundQuads[u].length);let T;u!==this._segments.get().length-1&&(u++,this._segmentToGroundQuads[u]=[],this._segmentToRegionTriCounts[u]=[0,0,0,0,0]);{const C=e[0],g=e[1];T=e_(C.sub(e[a-1])._perp()._unit(),g.sub(C)._perp()._unit())}for(let C=0;C<a;C++){const g=C===a-1?0:C+1,S=e[C],A=e[g],w=e[g===a-1?0:g+1],M=A.sub(S)._perp()._unit(),P=e_(M,w.sub(A)._perp()._unit()),O=T,B=P;if(Af(S,A,i)||h&&r_(S,i)&&r_(A,i)){T=P;continue}const G=x.vertexLength;kp(this.vertexArray,S,A,1,1,O),kp(this.vertexArray,S,A,1,0,O),kp(this.vertexArray,S,A,0,1,B),kp(this.vertexArray,S,A,0,0,B),x.vertexLength+=4;const q=Ky(S,A,M,s);for(const U of q)this._segmentToGroundQuads[u].push({id:G,region:U}),this._segmentToRegionTriCounts[u][U]+=2,x.primitiveLength+=2;T=P}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),i=e.length;for(let s=0;s<i;s++)this._segmentToGroundQuads[s].sort((h,a)=>h.region-a.region);for(let s=0;s<i;s++){const h=this._segmentToGroundQuads[s],a=e[s],u=this._segmentToRegionTriCounts[s];u.reduce((T,C)=>T+C,0);let x=0;for(let T=0;T<=4;T++){const C=u[T];if(0!==C){let g=this.regionSegments[T];g||(g=this.regionSegments[T]=new vn);const S={vertexOffset:a.vertexOffset,primitiveOffset:a.primitiveOffset+x,vertexLength:a.vertexLength,primitiveLength:C};g.get().push(S)}x+=C}for(let T=0;T<h.length;T++){const C=h[T].id;this.indexArray.emplaceBack(C,C+1,C+3),this.indexArray.emplaceBack(C,C+3,C+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,i,s,h,a,u){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,i,s,h,a,u)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,Ny.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,i,s,h,a,u,x){this.hasData()&&this.programConfigurations.updatePaintArrays(e,i,s,h,a,u,x)}updateHiddenByLandmark(e){if(!this.hasData())return;const i=e.groundVertexCount+e.groundVertexArrayOffset;if(0===e.groundVertexCount)return;const s=e.flags&ah?1:0;for(let h=e.groundVertexArrayOffset;h<i;++h)this.hiddenByLandmarkVertexArray.emplace(h,s);this._needsHiddenByLandmarkUpdate=!0}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,jy.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const i=this.regionSegments[e];i&&i.destroy()}}}}class Op{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new Ln,this.footprintVertices=new Os,this.footprintSegments=[],this.layoutVertexArray=new Xr,this.centroidVertexArray=new Pr,this.wallVertexArray=new fu,this.indexArray=new Ln,this.programConfigurations=new Vs(e.layers,{zoom:e.zoom,lut:e.lut},i=>Wy.includes(i)),this.segments=new vn,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.groundEffect=new t_(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[]}updateFootprints(e,i){}populate(e,i,s,h){this.features=[],this.hasPattern=vl("fill-extrusion",this.layers,this.pixelRatio,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=t(s),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=0!==this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1);for(const{feature:a,id:u,index:x,sourceLayerIndex:T}of e){const C=this.layers[0]._featureFilter.needGeometry,g=N(a,C);if(!this.layers[0]._featureFilter.filter(new Zi(this.zoom),g,s))continue;const S={id:u,sourceLayerIndex:T,index:x,geometry:C?g.geometry:k(a,s,h),properties:a.properties,type:a.type,patterns:{}},A=this.layoutVertexArray.length,w="Polygon"===Ef[S.type];if(this.hasPattern)this.features.push(pc("fill-extrusion",this.layers,S,this.zoom,this.pixelRatio,i));else if(this.wallMode)for(const M of S.geometry)for(const P of Xm(M,w))this.addFeature(S,[P],x,s,{},i.availableImages,h,i.brightness);else this.addFeature(S,S.geometry,x,s,{},i.availableImages,h,i.brightness);i.featureIndex.insert(a,S.geometry,x,T,this.index,A)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,i,s,h,a,u){for(const x of this.features){const T="Polygon"===Ef[x.type],{geometry:C}=x;if(this.wallMode)for(const g of C)for(const S of Xm(g,T))this.addFeature(x,[S],x.index,i,s,h,a,u);else this.addFeature(x,C,x.index,i,s,h,a,u)}this.sortBorders(),"mercator"===this.projection.name&&this.splitToSubtiles()}update(e,i,s,h,a,u,x){this.programConfigurations.updatePaintArrays(e,i,a,s,h,u,x),this.groundEffect.update(e,i,a,s,h,u,x)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,qy),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,Uy.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,Gy.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,Vy.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,i,s,h,a,u,x,T){const C=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(e,{})/this.tileToMeter,g=[new pt(0,0),new pt(ft,ft)],S=x.projection,A="globe"===S.name,w=this.wallMode||"Polygon"===Ef[e.type],M=new Qm;M.centroidDataIndex=this.centroidData.length;const P=new Jm,O=this.layers[0].paint.get("fill-extrusion-base").evaluate(e,{},h)<=0,B=this.layers[0].paint.get("fill-extrusion-height").evaluate(e,{},h);let G;if(P.height=B,P.vertexArrayOffset=this.layoutVertexArray.length,P.groundVertexArrayOffset=this.groundEffect.vertexArray.length,A&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new ic),this.wallMode){if(A)return void ii("Non zero fill-extrusion-line-width is not yet supported on globe.");if(1!==i.length)return;G=function(se){const ye=se[0].x===se[se.length-1].x&&se[0].y===se[se.length-1].y;(function(st){let nt=0;const It=st.length;for(let yt=0;yt<It;yt++)nt+=(st[(yt+1)%It].x-st[yt].x)*(st[(yt+1)%It].y+st[yt].y);return nt>=0})(se)||(se=se.reverse());const ve={geometry:[],joinNormals:[],indices:[]},Se=[],we=[],Ae=[];let Pe=se.length;for(;Pe>=2&&se[Pe-1].equals(se[Pe-2]);)Pe--;if(Pe<(ye?3:2))return ve;let ke,Ce,Ze,tt,$e,gt=0;for(;gt<Pe-1&&se[gt].equals(se[gt+1]);)gt++;ye&&(ke=se[Pe-2],$e=se[gt].sub(ke)._unit()._perp());for(let st=gt;st<Pe;st++){if(Ze=st===Pe-1?ye?se[gt+1]:void 0:se[st+1],Ze&&se[st].equals(Ze))continue;$e&&(tt=$e),ke&&(Ce=ke),ke=se[st],$e=Ze?Ze.sub(ke)._unit()._perp():tt,tt=tt||$e;let nt=tt.add($e);0===nt.x&&0===nt.y||nt._unit();const It=nt.x*$e.x+nt.y*$e.y,yt=0!==It?1/It:1/0,wt=tt.x*$e.y-tt.y*$e.x>0;let $t="miter";const ni=2;"miter"===$t&&yt>ni&&($t="bevel"),"bevel"===$t&&(yt>100&&($t="flipbevel"),yt<ni&&($t="miter"));const ri=(si,fi,_i,rn)=>{const $i=new pt(si.x,si.y),Jt=new pt(si.x,si.y);$i.x+=fi.x*rn,$i.y+=fi.y*rn,Jt.x-=fi.x*Math.max(_i,1),Jt.y-=fi.y*Math.max(_i,1),Ae.push(fi),Se.push($i),we.push(Jt)};if("miter"===$t)nt._mult(yt),ri(ke,nt,0,0);else if("flipbevel"===$t)nt=$e.mult(-1),ri(ke,nt,0,0),ri(ke,nt.mult(-1),0,0);else{const si=-Math.sqrt(yt*yt-1),fi=wt?si:0,_i=wt?0:si;Ce&&ri(ke,tt,fi,_i),Ze&&ri(ke,$e,fi,_i)}}ve.geometry=[...Se,...we.reverse(),Se[0]],ve.joinNormals=[...Ae,...Ae.reverse(),Ae[Ae.length-1]];const mt=ve.geometry.length-1;for(let st=0;st<mt/2;st++)if(st+1<mt/2){let nt=st,It=st+1,yt=mt-1-st,wt=mt-2-st;nt=0===nt?mt-1:nt-1,It=0===It?mt-1:It-1,yt=0===yt?mt-1:yt-1,wt=0===wt?mt-1:wt-1,ve.indices.push(yt),ve.indices.push(It),ve.indices.push(nt),ve.indices.push(yt),ve.indices.push(wt),ve.indices.push(It)}return ve}(i[0]),i=[G.geometry]}const q=(se,ye)=>se<(ye.length-1)/2||se===ye.length-1,U=this.wallMode?[i]:gr(i,500);for(let se=U.length-1;se>=0;se--){const ye=U[se];(0===ye.length||(W=ye[0]).every(le=>le.x<=0)||W.every(le=>le.x>=ft)||W.every(le=>le.y<=0)||W.every(le=>le.y>=ft))&&U.splice(se,1)}var W;let X;if(A)X=l_(U,g,h);else{X=[];for(const se of U)X.push({polygon:se,bounds:g})}const ee=w?this.edgeRadius:0,ae=ee>0&&this.zoom<17,oe=(se,ye)=>{if(0===se.length)return!1;const le=se[se.length-1];return ye.x===le.x&&ye.y===le.y};for(const{polygon:se,bounds:ye}of X){let le=0,ve=0;for(const Pe of se)w&&!Pe[0].equals(Pe[Pe.length-1])&&Pe.push(Pe[0]),ve+=w?Pe.length-1:Pe.length;const Se=this.segments.prepareSegment((w?5:4)*ve,this.layoutVertexArray,this.indexArray);P.footprintSegIdx<0&&(P.footprintSegIdx=this.footprintSegments.length),P.polygonSegIdx<0&&(P.polygonSegIdx=this.polygonSegments.length);const we={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},Ae=new Km;if(Ae.vertexOffset=this.footprintVertices.length,Ae.indexOffset=3*this.footprintIndices.length,Ae.ringIndices=[],w){const Pe=[],ke=[];le=Se.vertexLength;for(let Ze=0;Ze<se.length;Ze++){const tt=se[Ze];tt.length&&0!==Ze&&ke.push(Pe.length/2);const $e=[];let gt,mt;gt=tt[1].sub(tt[0])._perp()._unit(),Ae.ringIndices.push(tt.length-1);for(let st=1;st<tt.length;st++){const nt=tt[st],It=tt[st===tt.length-1?1:st+1],yt=nt.clone();if(ee){mt=It.sub(nt)._perp()._unit();const wt=gt.add(mt)._unit(),$t=ee*Math.min(4,1/(gt.x*wt.x+gt.y*wt.y));yt.x+=$t*wt.x,yt.y+=$t*wt.y,yt.x=Math.round(yt.x),yt.y=Math.round(yt.y),gt=mt}if(!O||0!==ee&&!ae||oe($e,yt)||$e.push(yt),Xd(this.layoutVertexArray,yt.x,yt.y,0,0,1,1,0),this.wallMode){const wt=q(st,tt);Yd(this.wallVertexArray,G.joinNormals[st],!wt)}Se.vertexLength++,this.footprintVertices.emplaceBack(nt.x,nt.y),Pe.push(nt.x,nt.y),A&&Kd(this.layoutVertexExtArray,S.projectTilePoint(yt.x,yt.y,h),S.upVector(h,yt.x,yt.y))}O&&(0===ee||ae)&&(0!==$e.length&&oe($e,$e[0])&&$e.pop(),this.groundEffect.addData($e,ye,C))}const Ce=this.wallMode?G.indices:K(Pe,ke);for(let Ze=0;Ze<Ce.length;Ze+=3)this.footprintIndices.emplaceBack(Ae.vertexOffset+Ce[Ze+0],Ae.vertexOffset+Ce[Ze+1],Ae.vertexOffset+Ce[Ze+2]),this.indexArray.emplaceBack(le+Ce[Ze],le+Ce[Ze+2],le+Ce[Ze+1]),Se.primitiveLength++;Ae.indexCount+=Ce.length,Ae.vertexCount+=this.footprintVertices.length-Ae.vertexOffset}for(let Pe=0;Pe<se.length;Pe++){const ke=se[Pe];M.startRing(P,ke[0]);let Ce=ke.length>4&&s_(ke[ke.length-2],ke[0],ke[1]),Ze=ee?Jy(ke[ke.length-2],ke[0],ke[1],ee):0;const tt=[];let $e,gt,mt;gt=ke[1].sub(ke[0])._perp()._unit();let st=!0;for(let nt=1,It=0;nt<ke.length;nt++){let yt=ke[nt-1],wt=ke[nt];const $t=ke[nt===ke.length-1?1:nt+1];if(M.appendEdge(P,wt,yt),Af(wt,yt,ye)){ee&&(gt=$t.sub(wt)._perp()._unit(),st=!st);continue}const ni=wt.sub(yt)._perp(),ri=ni.x/(Math.abs(ni.x)+Math.abs(ni.y)),si=ni.y>0?1:0,fi=yt.dist(wt);if(It+fi>32768&&(It=0),ee){mt=$t.sub(wt)._perp()._unit();let Jt=n_(yt,wt,$t,i_(gt,mt),ee);isNaN(Jt)&&(Jt=0);const Ui=wt.sub(yt)._unit();yt=yt.add(Ui.mult(Ze))._round(),wt=wt.add(Ui.mult(-Jt))._round(),Ze=Jt,gt=mt,O&&this.zoom>=17&&(oe(tt,yt)||tt.push(yt),oe(tt,wt)||tt.push(wt))}const _i=Se.vertexLength,rn=ke.length>4&&s_(yt,wt,$t);let $i=o_(It,Ce,st);if(Xd(this.layoutVertexArray,yt.x,yt.y,ri,si,0,0,$i),Xd(this.layoutVertexArray,yt.x,yt.y,ri,si,0,1,$i),this.wallMode){const Jt=q(nt-1,ke),Ui=G.joinNormals[nt-1];Yd(this.wallVertexArray,Ui,Jt),Yd(this.wallVertexArray,Ui,Jt)}if(It+=fi,$i=o_(It,rn,!st),Ce=rn,Xd(this.layoutVertexArray,wt.x,wt.y,ri,si,0,0,$i),Xd(this.layoutVertexArray,wt.x,wt.y,ri,si,0,1,$i),this.wallMode){const Jt=q(nt,ke),Ui=G.joinNormals[nt];Yd(this.wallVertexArray,Ui,Jt),Yd(this.wallVertexArray,Ui,Jt)}if(Se.vertexLength+=4,this.indexArray.emplaceBack(_i+0,_i+1,_i+2),this.indexArray.emplaceBack(_i+1,_i+3,_i+2),Se.primitiveLength+=2,ee){const Jt=le+(1===nt?ke.length-2:nt-2),Ui=1===nt?le:Jt+1;if(this.indexArray.emplaceBack(_i+1,Jt,_i+3),this.indexArray.emplaceBack(Jt,Ui,_i+3),Se.primitiveLength+=2,void 0===$e&&($e=_i),!Af($t,ke[nt],ye)){const Gi=nt===ke.length-1?$e:Se.vertexLength;this.indexArray.emplaceBack(_i+2,_i+3,Gi),this.indexArray.emplaceBack(_i+3,Gi+1,Gi),this.indexArray.emplaceBack(_i+3,Ui,Gi+1),Se.primitiveLength+=3}st=!st}if(A){const Jt=this.layoutVertexExtArray,Ui=S.projectTilePoint(yt.x,yt.y,h),Gi=S.projectTilePoint(wt.x,wt.y,h),an=S.upVector(h,yt.x,yt.y),Pn=S.upVector(h,wt.x,wt.y);Kd(Jt,Ui,an),Kd(Jt,Ui,an),Kd(Jt,Gi,Pn),Kd(Jt,Gi,Pn)}}w&&(le+=ke.length-1),O&&ee&&this.zoom>=17&&(0!==tt.length&&oe(tt,tt[0])&&tt.pop(),this.groundEffect.addData(tt,ye,C,ee>0))}this.footprintSegments.push(Ae),we.triangleCount=this.indexArray.length-we.triangleArrayOffset,this.polygonSegments.push(we),++P.footprintSegLen,++P.polygonSegLen}if(P.vertexCount=this.layoutVertexArray.length-P.vertexArrayOffset,P.groundVertexCount=this.groundEffect.vertexArray.length-P.groundVertexArrayOffset,0!==P.vertexCount){if(P.centroidXY=M.borders?Ym:this.encodeCentroid(M,P),this.centroidData.push(P),M.borders){this.featuresOnBorder.push(M);const se=this.featuresOnBorder.length-1;for(let ye=0;ye<M.borders.length;ye++)M.borders[ye][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[ye].push(se)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,a,u,h,T),this.groundEffect.addPaintPropertiesData(e,s,a,u,h,T),this.maxHeight=Math.max(this.maxHeight,B)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort((i,s)=>this.featuresOnBorder[i].borders[e][0]-this.featuresOnBorder[s].borders[e][0])}splitToSubtiles(){const e=[];for(let x=0;x<this.centroidData.length;x++){const T=this.centroidData[x],C=+(T.min.y+T.max.y>ft),g=2*C+(+(T.min.x+T.max.x>ft)^C);for(let S=0;S<T.polygonSegLen;S++){const A=T.polygonSegIdx+S;e.push({centroidIdx:x,subtile:g,polygonSegmentIdx:A,triangleSegmentIdx:this.polygonSegments[A].triangleSegIdx})}}const i=new Ln;e.sort((x,T)=>x.triangleSegmentIdx===T.triangleSegmentIdx?x.subtile-T.subtile:x.triangleSegmentIdx-T.triangleSegmentIdx);let s=0,h=0,a=0;for(const x of e){if(x.triangleSegmentIdx!==s)break;a++}const u=e.length;for(;h!==e.length;){s=e[h].triangleSegmentIdx;let x=0,T=h,C=h;for(let g=T;g<a&&e[g].subtile===x;g++)C++;for(;T!==a;){const g=e[T];x=g.subtile;const S=this.centroidData[g.centroidIdx].min.clone(),A=this.centroidData[g.centroidIdx].max.clone(),w={vertexOffset:this.segments.segments[s].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[s].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let M=T;M<C;M++){const P=e[M],O=this.polygonSegments[P.polygonSegmentIdx],B=this.centroidData[P.centroidIdx].min,G=this.centroidData[P.centroidIdx].max,q=this.indexArray.uint16;for(let U=O.triangleArrayOffset;U<O.triangleArrayOffset+O.triangleCount;U++)i.emplaceBack(q[3*U],q[3*U+1],q[3*U+2]);w.primitiveLength+=O.triangleCount,S.x=Math.min(S.x,B.x),S.y=Math.min(S.y,B.y),A.x=Math.max(A.x,G.x),A.y=Math.max(A.y,G.y)}w.primitiveLength>0&&this.triangleSubSegments.push({segment:w,min:S,max:A}),T=C;for(let M=T;M<a&&e[M].subtile===e[T].subtile;M++)C++}h=a;for(let g=h;g<u&&e[g].triangleSegmentIdx===e[h].triangleSegmentIdx;g++)a++}i._trim(),this.indexArray=i}getVisibleSegments(e,i,s){const h=new vn;if(this.wallMode){for(const P of this.triangleSubSegments)h.segments.push(P.segment);return h}let a=0,u=0;const x=1<<e.canonical.z;if(i){const P=i.getMinMaxForTile(e);P&&(a=P.min,u=P.max)}u+=this.maxHeight;const T=e.toUnwrapped();let C;const g=[T.canonical.x/x+T.wrap,T.canonical.y/x],S=[(T.canonical.x+1)/x+T.wrap,(T.canonical.y+1)/x],A=(P,O,B)=>[P[0]*(1-B[0])+O[0]*B[0],P[1]*(1-B[1])+O[1]*B[1]],w=[],M=[];for(const P of this.triangleSubSegments){w[0]=P.min.x/ft,w[1]=P.min.y/ft,M[0]=P.max.x/ft,M[1]=P.max.y/ft;const O=A(g,S,w),B=A(g,S,M);if(0===new Pt([O[0],O[1],a],[B[0],B[1],u]).intersectsPrecise(s)){C&&(h.segments.push(C),C=void 0);continue}const G=P.segment;C&&C.vertexOffset!==G.vertexOffset&&(h.segments.push(C),C=void 0),C?(C.vertexLength+=G.vertexLength,C.primitiveLength+=G.primitiveLength):C={vertexOffset:G.vertexOffset,primitiveLength:G.primitiveLength,vertexLength:G.vertexLength,primitiveOffset:G.primitiveOffset,sortKey:void 0,vaos:{}}}return C&&h.segments.push(C),h}encodeCentroid(e,i){const s=e.centroid(),h=i.span(),a=Math.min(7,Math.round(h.x*this.tileToMeter/10)),u=Math.min(7,Math.round(h.y*this.tileToMeter/10));return new pt(ai(s.x,1,8191)<<3|a,ai(s.y,1,8191)<<3|u)}encodeBorderCentroid(e){if(!e.borders)return new pt(0,0);const i=e.borders,s=Number.MAX_VALUE;if(i[0][0]!==s||i[1][0]!==s){const h=i[0][0]!==s?0:1;return new pt(6|(i[0][0]!==s?0:65528),(i[h][0]+i[h][1])/2<<3|6)}{const h=i[2][0]!==s?2:3;return new pt((i[h][0]+i[h][1])/2<<3|6,6|(i[2][0]!==s?0:65528))}}showCentroid(e){const i=this.centroidData[e.centroidDataIndex];i.flags&=ah,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const i=e.vertexArrayOffset,s=e.vertexCount+e.vertexArrayOffset,h=e.flags&ah?Ym:e.centroidXY,a=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==h.y||a!==h.x){for(let u=i;u<s;++u)this.centroidVertexArray.emplace(u,h.x,h.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,i,s){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const h=i.getReplacementRegionsForTile(e.toUnwrapped());if(Sf(this.activeReplacements,h))return;if(this.activeReplacements=h,0===this.centroidVertexArray.length)this.createCentroidsBuffer();else for(const u of this.centroidData)u.flags&=2147483647;const a=[];for(const u of this.activeReplacements){if(u.order<s)continue;const x=Math.max(1,Math.pow(2,u.footprintTileId.canonical.z-e.canonical.z));for(const T of this.centroidData)if(!(T.flags&ah||u.min.x>T.max.x||T.min.x>u.max.x||u.min.y>T.max.y||T.min.y>u.max.y))for(let C=0;C<T.footprintSegLen;C++){const g=this.footprintSegments[T.footprintSegIdx+C];if(a.length=0,Qy(this.footprintVertices,g.vertexOffset,g.vertexCount,u.footprintTileId.canonical,e.canonical,a),Hm(u.footprint,a,this.footprintIndices.uint16,g.indexOffset,g.indexCount,-g.vertexOffset,-x)){T.flags|=ah;break}}}for(const u of this.centroidData)this.writeCentroidToBuffer(u);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,i,s){let h=!1;for(let a=0;a<s.footprintSegLen;a++){const u=this.footprintSegments[s.footprintSegIdx+a];let x=0;for(const T of u.ringIndices){for(let C=x,g=T+x-1;C<T+x;g=C++){const S=this.footprintVertices.int16[2*(C+u.vertexOffset)+0],A=this.footprintVertices.int16[2*(C+u.vertexOffset)+1],w=this.footprintVertices.int16[2*(g+u.vertexOffset)+1];A>i!=w>i&&e<(this.footprintVertices.int16[2*(g+u.vertexOffset)+0]-S)*(i-A)/(w-A)+S&&(h=!h)}x=T}}return h}getHeightAtTileCoord(e,i){let s=Number.NEGATIVE_INFINITY,h=!0;const a=4*(e+ft)*ft+(i+ft);if(this.partLookup.hasOwnProperty(a)){const u=this.partLookup[a];return u?{height:u.height,hidden:!!(u.flags&ah)}:void 0}for(const u of this.centroidData)e>u.max.x||u.min.x>e||i>u.max.y||u.min.y>i||this.footprintContainsPoint(e,i,u)&&u&&u.height>s&&(s=u.height,this.partLookup[a]=u,h=!!(u.flags&ah));if(s!==Number.NEGATIVE_INFINITY)return{height:s,hidden:h};this.partLookup[a]=void 0}}function i_(r,e){const i=r.add(e)._unit();return r.x*i.x+r.y*i.y}function Jy(r,e,i,s){const h=e.sub(r)._perp()._unit(),a=i.sub(e)._perp()._unit();return n_(r,e,i,i_(h,a),s)}function n_(r,e,i,s,h){const a=Math.sqrt(1-s*s);return Math.min(r.dist(e)/3,e.dist(i)/3,h*a/s)}function Af(r,e,i){return r.x<i[0].x&&e.x<i[0].x||r.x>i[1].x&&e.x>i[1].x||r.y<i[0].y&&e.y<i[0].y||r.y>i[1].y&&e.y>i[1].y}function r_(r,e){return r.x<e[0].x||r.x>e[1].x||r.y<e[0].y||r.y>e[1].y}function s_(r,e,i){if(r.x<0||r.x>=ft||e.x<0||e.x>=ft||i.x<0||i.x>=ft)return!1;const s=i.sub(e),h=s.perp(),a=r.sub(e);return(s.x*a.x+s.y*a.y)/Math.sqrt((s.x*s.x+s.y*s.y)*(a.x*a.x+a.y*a.y))>-.866&&h.x*a.x+h.y*a.y<0}function o_(r,e,i){const s=e?2|r:-3&r;return i?1|s:-2&s}function a_(){const r=Math.PI/32,e=Math.tan(r),i=jo;return i*Math.sqrt(1+2*e*e)-i}function l_(r,e,i){const s=1<<i.z,h=Vr(i.x/s),a=Vr((i.x+1)/s),u=$n(i.y/s),x=$n((i.y+1)/s);return function(T,C,g,S,A=0,w){const M=[];if(!T.length||!g||!S)return M;const P=(X,ee)=>{for(const ae of X)M.push({polygon:ae,bounds:ee})},O=Math.ceil(Math.log2(g)),B=Math.ceil(Math.log2(S)),G=O-B,q=[];for(let X=0;X<Math.abs(G);X++)q.push(G>0?0:1);for(let X=0;X<Math.min(O,B);X++)q.push(0),q.push(1);let U=T;if(U=zp(U,C[0].y-A,C[1].y+A,1),U=zp(U,C[0].x-A,C[1].x+A,0),!U.length)return M;const W=[];for(q.length?W.push({polygons:U,bounds:C,depth:0}):P(U,C);W.length;){const X=W.pop(),ee=X.depth,ae=q[ee],oe=X.bounds[0],se=X.bounds[1],ye=0===ae?oe.x:oe.y,le=0===ae?se.x:se.y,ve=w?w(ae,ye,le):.5*(ye+le),Se=zp(X.polygons,ye-A,ve+A,ae),we=zp(X.polygons,ve-A,le+A,ae);if(Se.length){const Ae=[oe,new pt(0===ae?ve:se.x,1===ae?ve:se.y)];q.length>ee+1?W.push({polygons:Se,bounds:Ae,depth:ee+1}):P(Se,Ae)}if(we.length){const Ae=[new pt(0===ae?ve:oe.x,1===ae?ve:oe.y),se];q.length>ee+1?W.push({polygons:we,bounds:Ae,depth:ee+1}):P(we,Ae)}}return M}(r,e,Math.ceil((a-h)/11.25),Math.ceil((u-x)/11.25),1,(T,C,g)=>{if(0===T)return.5*(C+g);{const S=$n((i.y+C/ft)/s);return(cs(.5*($n((i.y+g/ft)/s)+S))*s-i.y)*ft}})}function Qy(r,e,i,s,h,a){const u=Math.pow(2,s.z-h.z);for(let x=0;x<i;x++){let T=r.int16[2*(x+e)+0],C=r.int16[2*(x+e)+1];T=(T+h.x*ft)*u-s.x*ft,C=(C+h.y*ft)*u-s.y*ft,a.push(new pt(T,C))}}let c_,h_;function Jd(r,e){return r.x*e.x+r.y*e.y}function u_(r,e){if(1===r.length){let i=0;const s=e[i++];let h;for(;!h||s.equals(h);)if(h=e[i++],!h)return 1/0;for(;i<e.length;i++){const a=e[i],u=r[0],x=h.sub(s),T=a.sub(s),C=u.sub(s),g=Jd(x,x),S=Jd(x,T),A=Jd(T,T),w=Jd(C,x),M=Jd(C,T),P=g*A-S*S,O=(A*w-S*M)/P,B=(g*M-S*w)/P,G=s.z*(1-O-B)+h.z*O+a.z*B;if(isFinite(G))return G}return 1/0}{let i=1/0;for(const s of e)i=Math.min(i,s.z);return i}}function d_(r,e,i,s,h,a,u,x){const T=u*h.getElevationAt(r,e,!0,!0),C=0!==a[0],g=C?0===a[1]?u*(a[0]/7-450):u*function(S,A,w){const M=Math.floor(A[0]/8),P=Math.floor(A[1]/8),O=10*(A[0]-8*M),B=10*(A[1]-8*P),G=S.getElevationAt(M,P,!0,!0),q=S.getMeterToDEM(w),U=Math.floor(.5*(O*q-1)),W=Math.floor(.5*(B*q-1)),X=S.tileCoordToPixel(M,P),ee=2*U+1,ae=2*W+1,oe=(ke=ee,Ce=ae,[(we=S).getElevationAtPixel(Ae=X.x-U,Pe=X.y-W,!0),we.getElevationAtPixel(Ae+Ce,Pe,!0),we.getElevationAtPixel(Ae,Pe+Ce,!0),we.getElevationAtPixel(Ae+ke,Pe+Ce,!0)]),se=Math.abs(oe[0]-oe[1]),ye=Math.abs(oe[2]-oe[3]),le=Math.abs(oe[0]-oe[2])+Math.abs(oe[1]-oe[3]),ve=Math.min(.25,.5*q*(se+ye)/ee),Se=Math.min(.25,.5*q*le/ae);var we,Ae,Pe,ke,Ce;return G+Math.max(ve*O,Se*B)}(h,a,x):T;return{base:T+(0===i?-1:i),top:C?Math.max(g+s,T+i+2):T+s}}St(Op,"FillExtrusionBucket",{omit:["layers","features"]}),St(Jm,"PartData"),St(Km,"FootprintSegment"),St(Qm,"BorderCentroidData"),St(t_,"GroundEffect");const e0=Li([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),t0=Li([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:i0}=e0,n0=Li([{name:"a_packed",components:3,type:"Float32"}]),{members:r0}=n0,s0=Li([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:o0}=s0;class p_{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.image=new v({width:e,height:i}),this.positions={},this.uploaded=!1}getDash(e,i){const s=this.getKey(e,i);return this.positions[s]}trim(){const e=this.width,i=this.height=Ba(this.nextRow);this.image.resize({width:e,height:i})}getKey(e,i){return e.join(",")+i}getDashRanges(e,i,s){const h=[];let a=e.length%2==1?-e[e.length-1]*s:0,u=e[0]*s,x=!0;h.push({left:a,right:u,isDash:x,zeroLength:0===e[0]});let T=e[0];for(let C=1;C<e.length;C++){x=!x;const g=e[C];a=T*s,T+=g,u=T*s,h.push({left:a,right:u,isDash:x,zeroLength:0===g})}return h}addRoundDash(e,i,s){const h=i/2;for(let a=-s;a<=s;a++){const u=this.width*(this.nextRow+s+a);let x=0,T=e[x];for(let C=0;C<this.width;C++){C/T.right>1&&(T=e[++x]);const g=Math.abs(C-T.left),S=Math.abs(C-T.right),A=Math.min(g,S);let w;const M=a/s*(h+1);if(T.isDash){const P=h-Math.abs(M);w=Math.sqrt(A*A+P*P)}else w=h-Math.sqrt(A*A+M*M);this.image.data[u+C]=Math.max(0,Math.min(255,w+128))}}}addRegularDash(e,i){for(let T=e.length-1;T>=0;--T){const C=e[T],g=e[T+1];C.zeroLength?e.splice(T,1):g&&g.isDash===C.isDash&&(g.left=C.left,e.splice(T,1))}const s=e[0],h=e[e.length-1];s.isDash===h.isDash&&(s.left=h.left-this.width,h.right=s.right+this.width);const a=this.width*this.nextRow;let u=0,x=e[u];for(let T=0;T<this.width;T++){T/x.right>1&&(x=e[++u]);const C=Math.abs(T-x.left),g=Math.abs(T-x.right),S=Math.min(C,g);this.image.data[a+T]=Math.max(0,Math.min(255,(x.isDash?S:-S)+i+128))}}addDash(e,i){const s=this.getKey(e,i);if(this.positions[s])return this.positions[s];const h="round"===i,a=h?7:0,u=2*a+1;if(this.nextRow+u>this.height)return ii("LineAtlas out of space"),null;0===e.length&&e.push(1);let x=0;for(let g=0;g<e.length;g++)e[g]<0&&(ii("Negative value is found in line dasharray, replacing values with 0"),e[g]=0),x+=e[g];if(0!==x){const g=this.width/x,S=this.getDashRanges(e,this.width,g);h?this.addRoundDash(S,g,a):this.addRegularDash(S,"square"===i?.5*g:0)}const T=this.nextRow+a;this.nextRow+=u;const C={tl:[T,a],br:[x,0]};return this.positions[s]=C,C}}St(p_,"LineAtlas");const a0=fd.VectorTileFeature.types,l0=Math.cos(Math.PI/180*37.5),c0=Math.cos(Math.PI/180*5);class If{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasZOffset=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(i=>{this.gradients[i.id]={}}),this.layoutVertexArray=new ll,this.layoutVertexArray2=new Fs,this.patternVertexArray=new Fs,this.indexArray=new Ln,this.programConfigurations=new Vs(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new vn,this.maxLineLength=0,this.zOffsetVertexArray=new Fs,this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.tessellationStep=e.tessellationStep?e.tessellationStep:128}updateFootprints(e,i){}populate(e,i,s,h){this.hasPattern=vl("line",this.layers,this.pixelRatio,i);const a=this.layers[0].layout.get("line-sort-key");this.tileToMeter=t(s);const u=this.layers[0].layout.get("line-z-offset"),x=u.isConstant()&&!u.constantOr(0),T=this.layers[0].layout.get("line-elevation-reference");this.hasZOffset="sea"===T||"ground"===T||!x&&"none"===T,this.hasZOffset&&"none"===T&&ii(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`);const C=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.hasZOffset&&void 0!==C;const g=[];for(const{feature:M,id:P,index:O,sourceLayerIndex:B}of e){const G=this.layers[0]._featureFilter.needGeometry,q=N(M,G);if(!this.layers[0]._featureFilter.filter(new Zi(this.zoom),q,s))continue;const U=a?a.evaluate(q,{},s):void 0,W={id:P,properties:M.properties,type:M.type,sourceLayerIndex:B,index:O,geometry:G?q.geometry:k(M,s,h),patterns:{},sortKey:U};g.push(W)}a&&g.sort((M,P)=>M.sortKey-P.sortKey);const{lineAtlas:S,featureIndex:A}=i,w=this.addConstantDashes(S);for(const M of g){const{geometry:P,index:O,sourceLayerIndex:B}=M;if(w&&this.addFeatureDashes(M,S),this.hasPattern){const G=pc("line",this.layers,M,this.zoom,this.pixelRatio,i);this.patternFeatures.push(G)}else this.addFeature(M,P,O,s,S.positions,i.availableImages,i.brightness);A.insert(e[O].feature,P,O,B,this.index)}}addConstantDashes(e){let i=!1;for(const s of this.layers){const h=s.paint.get("line-dasharray").value,a=s.layout.get("line-cap").value;if("constant"!==h.kind||"constant"!==a.kind)i=!0;else{const u=a.value,x=h.value;if(!x)continue;e.addDash(x,u)}}return i}addFeatureDashes(e,i){const s=this.zoom;for(const h of this.layers){const a=h.paint.get("line-dasharray").value,u=h.layout.get("line-cap").value;if("constant"===a.kind&&"constant"===u.kind)continue;let x,T;if("constant"===a.kind){if(x=a.value,!x)continue}else x=a.evaluate({zoom:s},e);T="constant"===u.kind?u.value:u.evaluate({zoom:s},e),i.addDash(x,T),e.patterns[h.id]=i.getKey(x,T)}}update(e,i,s,h,a,u,x){this.programConfigurations.updatePaintArrays(e,i,a,s,h,u,x)}addFeatures(e,i,s,h,a,u){for(const x of this.patternFeatures)this.addFeature(x,x.geometry,x.index,i,s,h,u)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,r0)),0!==this.patternVertexArray.length&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,o0)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,t0.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,i0),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,i,s,h,a,u,x){const T=this.layers[0].layout,C=T.get("line-join").evaluate(e,{}),g=T.get("line-cap").evaluate(e,{}),S=T.get("line-miter-limit"),A=T.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e,this.zOffsetValue=T.get("line-z-offset").value;const w=this.layers[0].paint.get("line-width").value;"constant"!==w.kind&&!1===w.isLineProgressConstant&&(this.variableWidthValue=w);for(const M of i)this.addLine(M,e,h,C,g,S,A);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,s,a,u,h,x)}addLine(e,i,s,h,a,u,x){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;const T="none"===h;if(this.patternJoinNone=this.hasPattern&&T,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[],this.lineClips){this.lineClipsArray.push(this.lineClips);for(let q=0;q<e.length-1;q++)this.totalDistance+=e[q].dist(e[q+1]);this.totalFeatureLength=this.totalDistance/(this.lineClips.end-this.lineClips.start),this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const C="Polygon"===a0[i.type];let g=e.length;for(;g>=2&&e[g-1].equals(e[g-2]);)g--;let S=0;for(;S<g-1&&e[S].equals(e[S+1]);)S++;if(g<(C?3:2))return;"bevel"===h&&(u=1.05);const A=this.segments.prepareSegment(10*g,this.layoutVertexArray,this.indexArray);let w,M,P,O,B,G;this.e1=this.e2=-1,C&&(w=e[g-2],B=e[S].sub(w)._unit()._perp());for(let q=S;q<g;q++){if(P=q===g-1?C?e[S+1]:void 0:e[q+1],P&&e[q].equals(P))continue;B&&(O=B),w&&(M=w),w=e[q],G=this.evaluateLineProgressFeatures(M?M.dist(w):0),B=P?P.sub(w)._unit()._perp():O,O=O||B;const U=M&&P;let W=U?h:C||T?"butt":a;const X=O.x*B.x+O.y*B.y;if(T){const Se=function(we){if(we.patternJoinNone){const Ae=we.segmentPoints.length/2,Pe=we.lineSoFar-we.segmentStart;for(let ke=0;ke<Ae;++ke){const Ce=we.segmentPoints[2*ke+1],Ze=Math.round(we.segmentPoints[2*ke])+.5+.25*Ce;we.patternVertexArray.emplaceBack(Ze,Pe,we.segmentStart),we.patternVertexArray.emplaceBack(Ze,Pe,we.segmentStart)}we.segmentPoints.length=0}we.e1=we.e2=-1};if(U&&X<c0){this.updateDistance(M,w),this.addCurrentVertex(w,O,1,1,A,G),Se(this),this.addCurrentVertex(w,B,-1,-1,A,G);continue}if(M){if(!P){this.updateDistance(M,w),this.addCurrentVertex(w,O,1,1,A,G),Se(this);continue}W="miter"}}let ee=O.add(B);0===ee.x&&0===ee.y||ee._unit();const ae=ee.x*B.x+ee.y*B.y,oe=0!==ae?1/ae:1/0,se=2*Math.sqrt(2-2*ae),ye=ae<l0&&M&&P,le=O.x*B.y-O.y*B.x>0,ve=this.overscaling<=16?15*ft/(512*this.overscaling):0;if(U&&"round"===W)if(oe<x)W="miter";else if(oe<=2){const Se=Cf(w,-10,8202);W=this.hasZOffset&&(Se||this.hasCrossSlope)?"miter":"fakeround"}if("miter"===W&&oe>u&&(W="bevel"),"bevel"===W&&(oe>2&&(W="flipbevel"),oe<u&&(W="miter")),M&&!("miter"===W&&ye)&&this.updateDistance(M,w),"miter"===W)if(ye){const Se=w.dist(M);if(Se>2*ve){const Ae=w.sub(w.sub(M)._mult(ve/Se)._round());this.updateDistance(M,Ae),this.addCurrentVertex(Ae,O,0,0,A,G),M=Ae}this.updateDistance(M,w),ee._mult(oe),this.addCurrentVertex(w,ee,0,0,A,G);const we=w.dist(P);if(we>2*ve){const Ae=w.add(P.sub(w)._mult(ve/we)._round());this.updateDistance(w,Ae),this.addCurrentVertex(Ae,B,0,0,A,G),w=Ae}}else ee._mult(oe),this.addCurrentVertex(w,ee,0,0,A,G);else if("flipbevel"===W){if(oe>100)ee=B.mult(-1);else{const Se=oe*O.add(B).mag()/O.sub(B).mag();ee._perp()._mult(Se*(le?-1:1))}this.addCurrentVertex(w,ee,0,0,A,G),this.addCurrentVertex(w,ee.mult(-1),0,0,A,G)}else if("bevel"===W||"fakeround"===W){null!=G&&M&&this.addCurrentVertex(w,O,-1,-1,A,G);const Se=w.dist(M)<=2*ve&&"bevel"!==W,we=ee.mult(le?1:-1);we._mult(oe);const Ae=B.mult(le?-1:1),Pe=O.mult(le?-1:1),ke=this.evaluateLineProgressFeatures(this.distance);if(null==G&&(this.addHalfVertex(w,we.x,we.y,!1,!le,0,A,ke),Se||this.addHalfVertex(w,we.x+2*Pe.x,we.y+2*Pe.y,!1,le,0,A,ke)),"fakeround"===W){const Ce=Math.round(180*se/Math.PI/20);this.addHalfVertex(w,Pe.x,Pe.y,!1,le,0,A,ke);for(let Ze=0;Ze<Ce;Ze++){let tt=Ze/Ce;if(.5!==tt){const gt=tt-.5;tt+=tt*gt*(tt-1)*((1.0904+X*(X*(3.55645-1.43519*X)-3.2452))*gt*gt+(.848013+X*(.215638*X-1.06021)))}const $e=Ae.sub(Pe)._mult(tt)._add(Pe)._unit();this.addHalfVertex(w,$e.x,$e.y,!1,le,0,A,ke)}this.addHalfVertex(w,Ae.x,Ae.y,!1,le,0,A,ke)}Se||null!=G||this.addHalfVertex(w,we.x+2*Ae.x,we.y+2*Ae.y,!1,le,0,A,ke),null!=G&&P&&this.addCurrentVertex(w,B,1,1,A,G)}else"butt"===W?this.addCurrentVertex(w,ee,0,0,A,G):"square"===W?(M||this.addCurrentVertex(w,ee,-1,-1,A,G),this.addCurrentVertex(w,ee,0,0,A,G),M&&this.addCurrentVertex(w,ee,1,1,A,G)):"round"===W&&(M&&(this.addCurrentVertex(w,O,0,0,A,G),this.addCurrentVertex(w,O,1,1,A,G,!0)),P&&(this.addCurrentVertex(w,B,-1,-1,A,G,!0),this.addCurrentVertex(w,B,0,0,A,G)))}}addVerticesTo(e,i,s,h,a,u,x,T,C,g){const S=(i.w-e.w)/this.tessellationStep|0;let A=0;const w=this.scaledDistance;if(S>1){this.lineSoFar=e.w;const P=(i.x-e.x)/S,O=(i.y-e.y)/S,B=(i.z-e.z)/S,G=(i.w-e.w)/S;for(let q=1;q<S;++q){e.x+=P,e.y+=O,e.z+=B,this.lineSoFar+=G,A+=G;const U=this.evaluateLineProgressFeatures(this.prevDistance+A);this.scaledDistance=(this.prevDistance+A)/this.totalDistance,this.addHalfVertex(e,s,h,g,!1,x,C,U),this.addHalfVertex(e,a,u,g,!0,-T,C,U)}}this.lineSoFar=i.w,this.scaledDistance=w;const M=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(i,s,h,g,!1,x,C,M),this.addHalfVertex(i,a,u,g,!0,-T,C,M)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&!this.hasZOffset)return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):ii(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let i=0;return this.variableWidthValue&&"constant"!==this.variableWidthValue.kind&&(i=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.hasZOffset?"constant"===this.zOffsetValue.kind?{zOffset:this.zOffsetValue.value,variableWidth:i}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:i}:{zOffset:0,variableWidth:i}}addCurrentVertex(e,i,s,h,a,u,x=!1){const T=i.x+i.y*s,C=i.y-i.x*s,g=i.y*h-i.x,S=-i.y-i.x*h;if(null!=u){const A=this.hasZOffset,w=-10,M=8202,P=u.zOffset,O=new Nm(e.x,e.y,P,this.lineSoFar),B=!!A&&Cf(e,w,M),G=this.lineSoFar,q=this.distance;if(this.currentVertex)if(B){const U=this.currentVertexIsOutside,W=this.currentVertex,X=new Nm(e.x,e.y,P,this.lineSoFar);if(Um(W,X,w,M),!Cf(X,w,M)){if(U){this.e1=this.e2=-1,this.distance-=W.dist(O),this.lineSoFar=W.w;const ee=this.evaluateLineProgressFeatures(W.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(W,T,C,x,!1,s,a,ee),this.addHalfVertex(W,g,S,x,!0,-h,a,ee),this.prevDistance=this.distance}this.distance=this.prevDistance+W.dist(X),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(W,X,T,C,g,S,s,h,a,x),this.distance=q,this.scaledDistance=this.distance/this.totalDistance}}else{const U=this.currentVertex;if(this.currentVertexIsOutside){Um(U,O,w,M),this.e1=this.e2=-1,this.distance-=U.dist(O),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=U.w;const W=this.evaluateLineProgressFeatures(U.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(U,T,C,x,!1,s,a,W),this.addHalfVertex(U,g,S,x,!0,-h,a,W),this.prevDistance=this.distance,this.distance=q,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(U,O,T,C,g,S,s,h,a,x)}else B||(this.addHalfVertex(e,T,C,x,!1,s,a,u),this.addHalfVertex(e,g,S,x,!0,-h,a,u));this.currentVertex=O,this.currentVertexIsOutside=B,this.lineSoFar=G}else this.addHalfVertex(e,T,C,x,!1,s,a,u),this.addHalfVertex(e,g,S,x,!0,-h,a,u)}addHalfVertex({x:e,y:i},s,h,a,u,x,T,C){if(this.patternJoinNone&&(0===this.segmentPoints.length&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),u||this.segmentPoints.push(this.lineSoFar-this.segmentStart,x)),this.layoutVertexArray.emplaceBack((e<<1)+(a?1:0),(i<<1)+(u?1:0),Math.round(63*s)+128,Math.round(63*h)+128,1+(0===x?0:x<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const S=Ut(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,S)}const g=T.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,g),T.primitiveLength++),u?this.e2=g:this.e1=g,null!=C&&this.zOffsetVertexArray.emplaceBack(C.zOffset,C.variableWidth,C.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,i){this.prevDistance=this.distance,this.distance+=e.dist(i),this.updateScaledDistance()}}function Cf(r,e,i){return r.x<e||r.x>i||r.y<e||r.y>i}let f_,m_;function __(r,e,i){return e*(ft/(r.tileSize*Math.pow(2,i-r.tileID.overscaledZ)))}St(If,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const g_=(r,e,i)=>(1-i)*r+i*e;function y_(r,e){return 1/__(r,1,e.tileZoom)}function x_(r,e,i,s){return r.translatePosMatrix(s||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const v_=r=>{const e=[];b_(r)&&e.push("RENDER_LINE_DASH"),r.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const i=r.paint.get("line-trim-offset");0===i[0]&&0===i[1]||e.push("RENDER_LINE_TRIM_OFFSET"),0!==r.paint.get("line-border-width").constantOr(1)&&e.push("RENDER_LINE_BORDER");const s="none"===r.layout.get("line-join").constantOr("miter"),h=!!r.paint.get("line-pattern").constantOr(1);return s&&h&&e.push("LINE_JOIN_NONE"),e};function b_(r){const e=r.paint.get("line-dasharray").value;return e.value||"constant"!==e.kind}let Pf;const w_=()=>Pf||(Pf={layout:f_||(f_=new cn({"line-cap":new bt(Ne.layout_line["line-cap"]),"line-join":new bt(Ne.layout_line["line-join"]),"line-miter-limit":new at(Ne.layout_line["line-miter-limit"]),"line-round-limit":new at(Ne.layout_line["line-round-limit"]),"line-sort-key":new bt(Ne.layout_line["line-sort-key"]),"line-z-offset":new bt(Ne.layout_line["line-z-offset"]),"line-elevation-reference":new at(Ne.layout_line["line-elevation-reference"]),"line-cross-slope":new at(Ne.layout_line["line-cross-slope"]),visibility:new at(Ne.layout_line.visibility),"line-width-unit":new at(Ne.layout_line["line-width-unit"])})),paint:m_||(m_=new cn({"line-opacity":new bt(Ne.paint_line["line-opacity"]),"line-color":new bt(Ne.paint_line["line-color"]),"line-translate":new at(Ne.paint_line["line-translate"]),"line-translate-anchor":new at(Ne.paint_line["line-translate-anchor"]),"line-width":new bt(Ne.paint_line["line-width"]),"line-gap-width":new bt(Ne.paint_line["line-gap-width"]),"line-offset":new bt(Ne.paint_line["line-offset"]),"line-blur":new bt(Ne.paint_line["line-blur"]),"line-dasharray":new bt(Ne.paint_line["line-dasharray"]),"line-pattern":new bt(Ne.paint_line["line-pattern"]),"line-gradient":new ol(Ne.paint_line["line-gradient"]),"line-trim-offset":new at(Ne.paint_line["line-trim-offset"]),"line-trim-fade-range":new at(Ne.paint_line["line-trim-fade-range"]),"line-trim-color":new at(Ne.paint_line["line-trim-color"]),"line-emissive-strength":new at(Ne.paint_line["line-emissive-strength"]),"line-border-width":new bt(Ne.paint_line["line-border-width"]),"line-border-color":new bt(Ne.paint_line["line-border-color"]),"line-occlusion-opacity":new at(Ne.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"})}))},Pf);class h0 extends bt{possiblyEvaluate(e,i){return i=new Zi(Math.floor(i.zoom),{now:i.now,fadeDuration:i.fadeDuration,transition:i.transition}),super.possiblyEvaluate(e,i)}evaluate(e,i,s,h){return i=Hi({},i,{zoom:Math.floor(i.zoom)}),super.evaluate(e,i,s,h)}}let Qd;function T_(r,e){return e>0?e+2*r:r}const u0=Li([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),d0=Li([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),p0=Li([{name:"a_projected_pos",components:4,type:"Float32"}],4);Li([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const f0=Li([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),m0=Li([{name:"a_texb",components:2,type:"Uint16"}]),_0=Li([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),g0=Li([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);Li([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const S_=Li([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),y0=Li([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);Li([{name:"triangle",components:3,type:"Uint16"}]),Li([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),Li([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"}]),Li([{type:"Float32",name:"offsetX"}]),Li([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);const Ma=128;function Df(r,e,i,s,h){if("camera"===r.kind)return r.maxSize;if("composite"===r.kind){const a=e.possiblyEvaluate(new Zi(r.maxZoom),i).evaluate(h,{},i),u=e.possiblyEvaluate(new Zi(r.minZoom),i).evaluate(h,{},i);return Math.max(a,u)}return e.possiblyEvaluate(new Zi(s)).evaluate(h,{},i)}function zf(r,e){const{expression:i}=e;if("constant"===i.kind)return{kind:"constant",layoutSize:i.evaluate(new Zi(r+1))};if("source"===i.kind)return{kind:"source"};{const{zoomStops:s,interpolationType:h}=i;let a=0;for(;a<s.length&&s[a]<=r;)a++;a=Math.max(0,a-1);let u=a;for(;u<s.length&&s[u]<r+1;)u++;u=Math.min(s.length-1,u);const x=s[a],T=s[u];return"composite"===i.kind?{kind:"composite",minZoom:x,maxZoom:T,interpolationType:h}:{kind:"camera",minZoom:x,maxZoom:T,minSize:i.evaluate(new Zi(x)),maxSize:i.evaluate(new Zi(T)),interpolationType:h}}}function Fp(r,{uSize:e,uSizeT:i},{lowerSize:s,upperSize:h}){return"source"===r.kind?s/Ma:"composite"===r.kind?Ut(s/Ma,h/Ma,i):e}function md(r,e,i=1){let s=0,h=0;if("constant"===r.kind)h=r.layoutSize*i;else if("source"!==r.kind){const{interpolationType:a,minZoom:u,maxZoom:x}=r,T=a?ai(Br.interpolationFactor(a,e,u,x),0,1):0;"camera"===r.kind?h=Ut(r.minSize,r.maxSize,T)*i:s=T*i}return{uSizeT:s,uSize:h}}var x0=Object.freeze({__proto__:null,SIZE_PACK_FACTOR:Ma,evaluateSizeForFeature:Fp,evaluateSizeForZoom:md,getRasterizedIconSize:Df,getSizeData:zf});function v0(r,e,i){return r.sections.forEach(s=>{s.text=function(h,a,u){const x=a.layout.get("text-transform").evaluate(u,{});return"uppercase"===x?h=h.toLocaleUpperCase():"lowercase"===x&&(h=h.toLocaleLowerCase()),Zr.applyArabicShaping&&(h=Zr.applyArabicShaping(h)),h}(s.text,e,i)}),r}const ep={"!":"\ufe15","#":"\uff03",$:"\uff04","%":"\uff05","&":"\uff06","(":"\ufe35",")":"\ufe36","*":"\uff0a","+":"\uff0b",",":"\ufe10","-":"\ufe32",".":"\u30fb","/":"\uff0f",":":"\ufe13",";":"\ufe14","<":"\ufe3f","=":"\uff1d",">":"\ufe40","?":"\ufe16","@":"\uff20","[":"\ufe47","\\":"\uff3c","]":"\ufe48","^":"\uff3e",_:"\ufe33","`":"\uff40","{":"\ufe37","|":"\u2015","}":"\ufe38","~":"\uff5e","\xa2":"\uffe0","\xa3":"\uffe1","\xa5":"\uffe5","\xa6":"\uffe4","\xac":"\uffe2","\xaf":"\uffe3","\u2013":"\ufe32","\u2014":"\ufe31","\u2018":"\ufe43","\u2019":"\ufe44","\u201c":"\ufe41","\u201d":"\ufe42","\u2026":"\ufe19","\u2027":"\u30fb","\u20a9":"\uffe6","\u3001":"\ufe11","\u3002":"\ufe12","\u3008":"\ufe3f","\u3009":"\ufe40","\u300a":"\ufe3d","\u300b":"\ufe3e","\u300c":"\ufe41","\u300d":"\ufe42","\u300e":"\ufe43","\u300f":"\ufe44","\u3010":"\ufe3b","\u3011":"\ufe3c","\u3014":"\ufe39","\u3015":"\ufe3a","\u3016":"\ufe17","\u3017":"\ufe18","\uff01":"\ufe15","\uff08":"\ufe35","\uff09":"\ufe36","\uff0c":"\ufe10","\uff0d":"\ufe32","\uff0e":"\u30fb","\uff1a":"\ufe13","\uff1b":"\ufe14","\uff1c":"\ufe3f","\uff1e":"\ufe40","\uff1f":"\ufe16","\uff3b":"\ufe47","\uff3d":"\ufe48","\uff3f":"\ufe33","\uff5b":"\ufe37","\uff5c":"\u2015","\uff5d":"\ufe38","\uff5f":"\ufe35","\uff60":"\ufe36","\uff61":"\ufe12","\uff62":"\ufe41","\uff63":"\ufe42","\u2190":"\u2191","\u2192":"\u2193"};function b0(r){return"\ufe36"===r||"\ufe48"===r||"\ufe38"===r||"\ufe44"===r||"\ufe42"===r||"\ufe3e"===r||"\ufe3c"===r||"\ufe3a"===r||"\ufe18"===r||"\ufe40"===r||"\ufe10"===r||"\ufe13"===r||"\ufe14"===r||"\uff40"===r||"\uffe3"===r||"\ufe11"===r||"\ufe12"===r}function w0(r){return"\ufe35"===r||"\ufe47"===r||"\ufe37"===r||"\ufe43"===r||"\ufe41"===r||"\ufe3d"===r||"\ufe3b"===r||"\ufe39"===r||"\ufe17"===r||"\ufe3f"===r}var M_,Rf,E_,Lf={};function A_(){if(E_)return Rf;E_=1,Rf=e;var r=function T0(){return M_||(M_=1,Lf.read=function(r,e,i,s,h){var a,u,x=8*h-s-1,T=(1<<x)-1,C=T>>1,g=-7,S=i?h-1:0,A=i?-1:1,w=r[e+S];for(S+=A,a=w&(1<<-g)-1,w>>=-g,g+=x;g>0;a=256*a+r[e+S],S+=A,g-=8);for(u=a&(1<<-g)-1,a>>=-g,g+=s;g>0;u=256*u+r[e+S],S+=A,g-=8);if(0===a)a=1-C;else{if(a===T)return u?NaN:1/0*(w?-1:1);u+=Math.pow(2,s),a-=C}return(w?-1:1)*u*Math.pow(2,a-s)},Lf.write=function(r,e,i,s,h,a){var u,x,T,C=8*a-h-1,g=(1<<C)-1,S=g>>1,A=23===h?Math.pow(2,-24)-Math.pow(2,-77):0,w=s?0:a-1,M=s?1:-1,P=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(x=isNaN(e)?1:0,u=g):(u=Math.floor(Math.log(e)/Math.LN2),e*(T=Math.pow(2,-u))<1&&(u--,T*=2),(e+=u+S>=1?A/T:A*Math.pow(2,1-S))*T>=2&&(u++,T/=2),u+S>=g?(x=0,u=g):u+S>=1?(x=(e*T-1)*Math.pow(2,h),u+=S):(x=e*Math.pow(2,S-1)*Math.pow(2,h),u=0));h>=8;r[i+w]=255&x,w+=M,x/=256,h-=8);for(u=u<<h|x,C+=h;C>0;r[i+w]=255&u,w+=M,u/=256,C-=8);r[i+w-M]|=128*P}),Lf}();function e(U){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(U)?U:new Uint8Array(U||0),this.pos=0,this.type=0,this.length=this.buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var i=4294967296,s=1/i,h=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function a(U){return U.type===e.Bytes?U.readVarint()+U.pos:U.pos+1}function x(U,W,X){var ee=W<=16383?1:W<=2097151?2:W<=268435455?3:Math.floor(Math.log(W)/(7*Math.LN2));X.realloc(ee);for(var ae=X.pos-1;ae>=U;ae--)X.buf[ae+ee]=X.buf[ae]}function T(U,W){for(var X=0;X<U.length;X++)W.writeVarint(U[X])}function C(U,W){for(var X=0;X<U.length;X++)W.writeSVarint(U[X])}function g(U,W){for(var X=0;X<U.length;X++)W.writeFloat(U[X])}function S(U,W){for(var X=0;X<U.length;X++)W.writeDouble(U[X])}function A(U,W){for(var X=0;X<U.length;X++)W.writeBoolean(U[X])}function w(U,W){for(var X=0;X<U.length;X++)W.writeFixed32(U[X])}function M(U,W){for(var X=0;X<U.length;X++)W.writeSFixed32(U[X])}function P(U,W){for(var X=0;X<U.length;X++)W.writeFixed64(U[X])}function O(U,W){for(var X=0;X<U.length;X++)W.writeSFixed64(U[X])}function B(U,W){return(U[W]|U[W+1]<<8|U[W+2]<<16)+16777216*U[W+3]}function G(U,W,X){U[X]=W,U[X+1]=W>>>8,U[X+2]=W>>>16,U[X+3]=W>>>24}function q(U,W){return(U[W]|U[W+1]<<8|U[W+2]<<16)+(U[W+3]<<24)}return e.prototype={destroy:function(){this.buf=null},readFields:function(U,W,X){for(X=X||this.length;this.pos<X;){var ee=this.readVarint(),ae=ee>>3,oe=this.pos;this.type=7&ee,U(ae,W,this),this.pos===oe&&this.skip(ee)}return W},readMessage:function(U,W){return this.readFields(U,W,this.readVarint()+this.pos)},readFixed32:function(){var U=B(this.buf,this.pos);return this.pos+=4,U},readSFixed32:function(){var U=q(this.buf,this.pos);return this.pos+=4,U},readFixed64:function(){var U=B(this.buf,this.pos)+B(this.buf,this.pos+4)*i;return this.pos+=8,U},readSFixed64:function(){var U=B(this.buf,this.pos)+q(this.buf,this.pos+4)*i;return this.pos+=8,U},readFloat:function(){var U=r.read(this.buf,this.pos,!0,23,4);return this.pos+=4,U},readDouble:function(){var U=r.read(this.buf,this.pos,!0,52,8);return this.pos+=8,U},readVarint:function(U){var W,X,ee=this.buf;return W=127&(X=ee[this.pos++]),X<128?W:(W|=(127&(X=ee[this.pos++]))<<7,X<128?W:(W|=(127&(X=ee[this.pos++]))<<14,X<128?W:(W|=(127&(X=ee[this.pos++]))<<21,X<128?W:function(ae,oe,se){var ye,le,ve=se.buf;if(ye=(112&(le=ve[se.pos++]))>>4,le<128||(ye|=(127&(le=ve[se.pos++]))<<3,le<128)||(ye|=(127&(le=ve[se.pos++]))<<10,le<128)||(ye|=(127&(le=ve[se.pos++]))<<17,le<128)||(ye|=(127&(le=ve[se.pos++]))<<24,le<128)||(ye|=(1&(le=ve[se.pos++]))<<31,le<128))return function u(U,W,X){return X?4294967296*W+(U>>>0):4294967296*(W>>>0)+(U>>>0)}(ae,ye,oe);throw new Error("Expected varint not more than 10 bytes")}(W|=(15&(X=ee[this.pos]))<<28,U,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var U=this.readVarint();return U%2==1?(U+1)/-2:U/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var U=this.readVarint()+this.pos,W=this.pos;return this.pos=U,U-W>=12&&h?h.decode(this.buf.subarray(W,U)):function(X,ee,ae){for(var oe="",se=ee;se<ae;){var ye,le,ve,Se=X[se],we=null,Ae=Se>239?4:Se>223?3:Se>191?2:1;if(se+Ae>ae)break;1===Ae?Se<128&&(we=Se):2===Ae?128==(192&(ye=X[se+1]))&&(we=(31&Se)<<6|63&ye)<=127&&(we=null):3===Ae?(le=X[se+2],128==(192&(ye=X[se+1]))&&128==(192&le)&&((we=(15&Se)<<12|(63&ye)<<6|63&le)<=2047||we>=55296&&we<=57343)&&(we=null)):4===Ae&&(le=X[se+2],ve=X[se+3],128==(192&(ye=X[se+1]))&&128==(192&le)&&128==(192&ve)&&((we=(15&Se)<<18|(63&ye)<<12|(63&le)<<6|63&ve)<=65535||we>=1114112)&&(we=null)),null===we?(we=65533,Ae=1):we>65535&&(we-=65536,oe+=String.fromCharCode(we>>>10&1023|55296),we=56320|1023&we),oe+=String.fromCharCode(we),se+=Ae}return oe}(this.buf,W,U)},readBytes:function(){var U=this.readVarint()+this.pos,W=this.buf.subarray(this.pos,U);return this.pos=U,W},readPackedVarint:function(U,W){if(this.type!==e.Bytes)return U.push(this.readVarint(W));var X=a(this);for(U=U||[];this.pos<X;)U.push(this.readVarint(W));return U},readPackedSVarint:function(U){if(this.type!==e.Bytes)return U.push(this.readSVarint());var W=a(this);for(U=U||[];this.pos<W;)U.push(this.readSVarint());return U},readPackedBoolean:function(U){if(this.type!==e.Bytes)return U.push(this.readBoolean());var W=a(this);for(U=U||[];this.pos<W;)U.push(this.readBoolean());return U},readPackedFloat:function(U){if(this.type!==e.Bytes)return U.push(this.readFloat());var W=a(this);for(U=U||[];this.pos<W;)U.push(this.readFloat());return U},readPackedDouble:function(U){if(this.type!==e.Bytes)return U.push(this.readDouble());var W=a(this);for(U=U||[];this.pos<W;)U.push(this.readDouble());return U},readPackedFixed32:function(U){if(this.type!==e.Bytes)return U.push(this.readFixed32());var W=a(this);for(U=U||[];this.pos<W;)U.push(this.readFixed32());return U},readPackedSFixed32:function(U){if(this.type!==e.Bytes)return U.push(this.readSFixed32());var W=a(this);for(U=U||[];this.pos<W;)U.push(this.readSFixed32());return U},readPackedFixed64:function(U){if(this.type!==e.Bytes)return U.push(this.readFixed64());var W=a(this);for(U=U||[];this.pos<W;)U.push(this.readFixed64());return U},readPackedSFixed64:function(U){if(this.type!==e.Bytes)return U.push(this.readSFixed64());var W=a(this);for(U=U||[];this.pos<W;)U.push(this.readSFixed64());return U},skip:function(U){var W=7&U;if(W===e.Varint)for(;this.buf[this.pos++]>127;);else if(W===e.Bytes)this.pos=this.readVarint()+this.pos;else if(W===e.Fixed32)this.pos+=4;else{if(W!==e.Fixed64)throw new Error("Unimplemented type: "+W);this.pos+=8}},writeTag:function(U,W){this.writeVarint(U<<3|W)},realloc:function(U){for(var W=this.length||16;W<this.pos+U;)W*=2;if(W!==this.length){var X=new Uint8Array(W);X.set(this.buf),this.buf=X,this.length=W}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(U){this.realloc(4),G(this.buf,U,this.pos),this.pos+=4},writeSFixed32:function(U){this.realloc(4),G(this.buf,U,this.pos),this.pos+=4},writeFixed64:function(U){this.realloc(8),G(this.buf,-1&U,this.pos),G(this.buf,Math.floor(U*s),this.pos+4),this.pos+=8},writeSFixed64:function(U){this.realloc(8),G(this.buf,-1&U,this.pos),G(this.buf,Math.floor(U*s),this.pos+4),this.pos+=8},writeVarint:function(U){(U=+U||0)>268435455||U<0?function(W,X){var ee,ae,oe,ye;if(W>=0?(ee=W%4294967296|0,ae=W/4294967296|0):(ae=~(-W/4294967296),4294967295^(ee=~(-W%4294967296))?ee=ee+1|0:(ee=0,ae=ae+1|0)),W>=0x10000000000000000||W<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");X.realloc(10),oe=ee,(ye=X).buf[ye.pos++]=127&oe|128,oe>>>=7,ye.buf[ye.pos++]=127&oe|128,oe>>>=7,ye.buf[ye.pos++]=127&oe|128,oe>>>=7,ye.buf[ye.pos++]=127&oe|128,ye.buf[ye.pos]=127&(oe>>>=7),function(oe,se){var ye=(7&oe)<<4;se.buf[se.pos++]|=ye|((oe>>>=3)?128:0),oe&&(se.buf[se.pos++]=127&oe|((oe>>>=7)?128:0),oe&&(se.buf[se.pos++]=127&oe|((oe>>>=7)?128:0),oe&&(se.buf[se.pos++]=127&oe|((oe>>>=7)?128:0),oe&&(se.buf[se.pos++]=127&oe|((oe>>>=7)?128:0),oe&&(se.buf[se.pos++]=127&oe)))))}(ae,X)}(U,this):(this.realloc(4),this.buf[this.pos++]=127&U|(U>127?128:0),U<=127||(this.buf[this.pos++]=127&(U>>>=7)|(U>127?128:0),U<=127||(this.buf[this.pos++]=127&(U>>>=7)|(U>127?128:0),U<=127||(this.buf[this.pos++]=U>>>7&127))))},writeSVarint:function(U){this.writeVarint(U<0?2*-U-1:2*U)},writeBoolean:function(U){this.writeVarint(!!U)},writeString:function(U){U=String(U),this.realloc(4*U.length),this.pos++;var W=this.pos;this.pos=function(ee,ae,oe){for(var se,ye,le=0;le<ae.length;le++){if((se=ae.charCodeAt(le))>55295&&se<57344){if(!ye){se>56319||le+1===ae.length?(ee[oe++]=239,ee[oe++]=191,ee[oe++]=189):ye=se;continue}if(se<56320){ee[oe++]=239,ee[oe++]=191,ee[oe++]=189,ye=se;continue}se=ye-55296<<10|se-56320|65536,ye=null}else ye&&(ee[oe++]=239,ee[oe++]=191,ee[oe++]=189,ye=null);se<128?ee[oe++]=se:(se<2048?ee[oe++]=se>>6|192:(se<65536?ee[oe++]=se>>12|224:(ee[oe++]=se>>18|240,ee[oe++]=se>>12&63|128),ee[oe++]=se>>6&63|128),ee[oe++]=63&se|128)}return oe}(this.buf,U,this.pos);var X=this.pos-W;X>=128&&x(W,X,this),this.pos=W-1,this.writeVarint(X),this.pos+=X},writeFloat:function(U){this.realloc(4),r.write(this.buf,U,this.pos,!0,23,4),this.pos+=4},writeDouble:function(U){this.realloc(8),r.write(this.buf,U,this.pos,!0,52,8),this.pos+=8},writeBytes:function(U){var W=U.length;this.writeVarint(W),this.realloc(W);for(var X=0;X<W;X++)this.buf[this.pos++]=U[X]},writeRawMessage:function(U,W){this.pos++;var X=this.pos;U(W,this);var ee=this.pos-X;ee>=128&&x(X,ee,this),this.pos=X-1,this.writeVarint(ee),this.pos+=ee},writeMessage:function(U,W,X){this.writeTag(U,e.Bytes),this.writeRawMessage(W,X)},writePackedVarint:function(U,W){W.length&&this.writeMessage(U,T,W)},writePackedSVarint:function(U,W){W.length&&this.writeMessage(U,C,W)},writePackedBoolean:function(U,W){W.length&&this.writeMessage(U,A,W)},writePackedFloat:function(U,W){W.length&&this.writeMessage(U,g,W)},writePackedDouble:function(U,W){W.length&&this.writeMessage(U,S,W)},writePackedFixed32:function(U,W){W.length&&this.writeMessage(U,w,W)},writePackedSFixed32:function(U,W){W.length&&this.writeMessage(U,M,W)},writePackedFixed64:function(U,W){W.length&&this.writeMessage(U,P,W)},writePackedSFixed64:function(U,W){W.length&&this.writeMessage(U,O,W)},writeBytesField:function(U,W){this.writeTag(U,e.Bytes),this.writeBytes(W)},writeFixed32Field:function(U,W){this.writeTag(U,e.Fixed32),this.writeFixed32(W)},writeSFixed32Field:function(U,W){this.writeTag(U,e.Fixed32),this.writeSFixed32(W)},writeFixed64Field:function(U,W){this.writeTag(U,e.Fixed64),this.writeFixed64(W)},writeSFixed64Field:function(U,W){this.writeTag(U,e.Fixed64),this.writeSFixed64(W)},writeVarintField:function(U,W){this.writeTag(U,e.Varint),this.writeVarint(W)},writeSVarintField:function(U,W){this.writeTag(U,e.Varint),this.writeSVarint(W)},writeStringField:function(U,W){this.writeTag(U,e.Bytes),this.writeString(W)},writeFloatField:function(U,W){this.writeTag(U,e.Fixed32),this.writeFloat(W)},writeDoubleField:function(U,W){this.writeTag(U,e.Fixed64),this.writeDouble(W)},writeBooleanField:function(U,W){this.writeVarintField(U,!!W)}},Rf}var Bp=er(A_());function S0(r,e,i){e.glyphs=[],1===r&&i.readMessage(M0,e)}function M0(r,e,i){if(3===r){const{id:s,bitmap:h,width:a,height:u,left:x,top:T,advance:C}=i.readMessage(E0,{});e.glyphs.push({id:s,bitmap:new v({width:a+6,height:u+6},h),metrics:{width:a,height:u,left:x,top:T,advance:C}})}else 4===r?e.ascender=i.readSVarint():5===r&&(e.descender=i.readSVarint())}function E0(r,e,i){1===r?e.id=i.readVarint():2===r?e.bitmap=i.readBytes():3===r?e.width=i.readVarint():4===r?e.height=i.readVarint():5===r?e.left=i.readSVarint():6===r?e.top=i.readSVarint():7===r&&(e.advance=i.readVarint())}const lo={horizontal:1,vertical:2,horizontalOnly:3};class tp{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,i){const s=new tp;return s.scale=e||1,s.fontStack=i,s}static forImage(e){const i=new tp;return i.image=e,i}}class _d{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,i){const s=new _d;for(let h=0;h<e.sections.length;h++){const a=e.sections[h];a.image?s.addImageSection(a):s.addTextSection(a,i)}return s}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=function(i,s){let h="";for(let a=0;a<i.length;a++){const u=i.charCodeAt(a+1)||null,x=i.charCodeAt(a-1)||null;h+=!s&&(u&&ma(u)&&!ep[i[a+1]]||x&&ma(x)&&!ep[i[a-1]])||!ep[i[a]]?i[a]:ep[i[a]]}return h}(this.text,e)}trim(){let e=0;for(let s=0;s<this.text.length&&Np[this.text.charCodeAt(s)];s++)e++;let i=this.text.length;for(let s=this.text.length-1;s>=0&&s>=e&&Np[this.text.charCodeAt(s)];s--)i--;this.text=this.text.substring(e,i),this.sectionIndex=this.sectionIndex.slice(e,i)}substring(e,i){const s=new _d;return s.text=this.text.substring(e,i),s.sectionIndex=this.sectionIndex.slice(e,i),s.sections=this.sections,s}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce((e,i)=>Math.max(e,this.sections[i].scale),0)}addTextSection(e,i){this.text+=e.text,this.sections.push(tp.forText(e.scale,e.fontStack||i));const s=this.sections.length-1;for(let h=0;h<e.text.length;++h)this.sectionIndex.push(s)}addImageSection(e){const i=e.image&&e.image.namePrimary?e.image.getPrimary():null;if(!i)return void ii("Can't add FormattedSection with an empty image.");const s=this.getNextImageSectionCharCode();s?(this.text+=String.fromCodePoint(s),this.sections.push(tp.forImage(i)),this.sectionIndex.push(this.sections.length-1)):ii("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function Of(r,e,i,s,h,a,u,x,T,C,g,S,A,w,M){const P=_d.fromFeature(r,h);S===lo.vertical&&P.verticalizePunctuation(A);let O=[];const B=function(X,ee,ae,oe,se,ye){if(!X)return[];const le=[],ve=function(Pe,ke,Ce,Ze,tt,$e){let gt=0;for(let mt=0;mt<Pe.length();mt++){const st=Pe.getSection(mt);gt+=C_(Pe.getCodePoint(mt),st,Ze,tt,ke,$e)}return gt/Math.max(1,Math.ceil(gt/Ce))}(X,ee,ae,oe,se,ye),Se=X.text.indexOf("\u200b")>=0;let we=0;for(let Pe=0;Pe<X.length();Pe++){const ke=X.getSection(Pe),Ce=X.getCodePoint(Pe);if(Np[Ce]||(we+=C_(Ce,ke,oe,se,ee,ye)),Pe<X.length()-1){const Ze=!((Ae=Ce)<11904||!(Ct_Bopomofo_Extended(Ae)||Ct_Bopomofo(Ae)||Ct_CJK_Compatibility_Forms(Ae)||Ct_CJK_Compatibility_Ideographs(Ae)||Ct_CJK_Compatibility(Ae)||Ct_CJK_Radicals_Supplement(Ae)||Ct_CJK_Strokes(Ae)||Ct_CJK_Symbols_and_Punctuation(Ae)||Ct_CJK_Unified_Ideographs_Extension_A(Ae)||Ct_CJK_Unified_Ideographs(Ae)||Ct_Enclosed_CJK_Letters_and_Months(Ae)||Ct_Halfwidth_and_Fullwidth_Forms(Ae)||Ct_Hiragana(Ae)||Ct_Ideographic_Description_Characters(Ae)||Ct_Kangxi_Radicals(Ae)||Ct_Katakana_Phonetic_Extensions(Ae)||Ct_Katakana(Ae)||Ct_Vertical_Forms(Ae)||Ct_Yi_Radicals(Ae)||Ct_Yi_Syllables(Ae)));(A0[Ce]||Ze||ke.image)&&le.push(D_(Pe+1,we,ve,le,I0(Ce,X.getCodePoint(Pe+1),Ze&&Se),!1))}}var Ae;return z_(D_(X.length(),we,ve,le,0,!0))}(P,C,a,e,s,w),{processBidirectionalText:G,processStyledBidirectionalText:q}=Zr;if(G&&1===P.sections.length){const X=G(P.toString(),B);for(const ee of X){const ae=new _d;ae.text=ee,ae.sections=P.sections;for(let oe=0;oe<ee.length;oe++)ae.sectionIndex.push(0);O.push(ae)}}else if(q){const X=q(P.text,P.sectionIndex,B);for(const ee of X){const ae=new _d;ae.text=ee[0],ae.sectionIndex=ee[1],ae.sections=P.sections,O.push(ae)}}else O=function(X,ee){const ae=[],oe=X.text;let se=0;for(const ye of ee)ae.push(X.substring(se,ye)),se=ye;return se<oe.length&&ae.push(X.substring(se,oe.length)),ae}(P,B);const U=[],W={positionedLines:U,text:P.toString(),top:g[1],bottom:g[1],left:g[0],right:g[0],writingMode:S,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(X,ee,ae,oe,se,ye,le,ve,Se,we,Ae,Pe){let ke=0,Ce=0,Ze=0;const tt="right"===ve?1:"left"===ve?0:.5;let $e=!1;for(const yt of se){const wt=yt.getSections();for(const $t of wt){if($t.image)continue;const ni=ee[$t.fontStack];if(ni&&($e=void 0!==ni.ascender&&void 0!==ni.descender,!$e))break}if(!$e)break}let gt=0;for(const yt of se){yt.trim();const wt=yt.getMaxScale(),$t=24*(wt-1),ni={positionedGlyphs:[],lineOffset:0};X.positionedLines[gt]=ni;const ri=ni.positionedGlyphs;let si=0;if(!yt.length()){Ce+=ye,++gt;continue}let fi=0,_i=0;for(let $i=0;$i<yt.length();$i++){const Jt=yt.getSection($i),Ui=yt.getSectionIndex($i),Gi=yt.getCodePoint($i);let an=Jt.scale,Pn=null,qn=null,Dn=null,Tn=24,On=0;const Zn=!(Se===lo.horizontal||!Ae&&!Nc(Gi)||Ae&&(Np[Gi]||(mt=Gi,Ct_Arabic(mt)||Ct_Arabic_Supplement(mt)||Ct_Arabic_Extended_A(mt)||Ct_Arabic_Presentation_Forms_A(mt)||Ct_Arabic_Presentation_Forms_B(mt))));if(Jt.image){const Lr=oe[Jt.image.serialize()];if(!Lr)continue;Dn=Jt.image.id,X.iconsInText=X.iconsInText||!0,qn=Lr.paddedRect;const on=Lr.displaySize;an=24*an/Pe,Pn={width:on[0],height:on[1],left:0,top:-3,advance:Zn?on[1]:on[0],localGlyph:!1},On=$e?-Pn.height*an:24*wt-17-on[1]*an,Tn=Pn.advance;const Ts=(Zn?on[0]:on[1])*an-24*wt;Ts>0&&Ts>si&&(si=Ts)}else{const Lr=ae[Jt.fontStack];if(!Lr)continue;Lr[Gi]&&(qn=Lr[Gi]);const on=ee[Jt.fontStack];if(!on)continue;const Ts=on.glyphs[Gi];if(!Ts)continue;if(Pn=Ts.metrics,Tn=8203!==Gi?24:0,$e){const Pa=void 0!==on.ascender?Math.abs(on.ascender):0,Ho=void 0!==on.descender?Math.abs(on.descender):0,Wo=(Pa+Ho)*an;fi<Wo&&(fi=Wo,_i=(Pa-Ho)/2*an),On=-Pa*an}else On=24*(wt-an)-17}Zn?(X.verticalizable=!0,ri.push({glyph:Gi,imageName:Dn,x:ke,y:Ce+On,vertical:Zn,scale:an,localGlyph:Pn.localGlyph,fontStack:Jt.fontStack,sectionIndex:Ui,metrics:Pn,rect:qn}),ke+=Tn*an+we):(ri.push({glyph:Gi,imageName:Dn,x:ke,y:Ce+On,vertical:Zn,scale:an,localGlyph:Pn.localGlyph,fontStack:Jt.fontStack,sectionIndex:Ui,metrics:Pn,rect:qn}),ke+=Pn.advance*an+we)}0!==ri.length&&(Ze=Math.max(ke-we,Ze),$e?R_(ri,tt,si,_i,ye*wt/2):R_(ri,tt,si,0,ye/2)),ke=0;const rn=ye*wt+si;ni.lineOffset=Math.max(si,$t),Ce+=rn,++gt}var mt;const st=Ce,{horizontalAlign:nt,verticalAlign:It}=Ff(le);(function(yt,wt,$t,ni,ri,si){const fi=(wt-$t)*ri,_i=-si*ni;for(const rn of yt)for(const $i of rn.positionedGlyphs)$i.x+=fi,$i.y+=_i})(X.positionedLines,tt,nt,It,Ze,st),X.top+=-It*st,X.bottom=X.top+st,X.left+=-nt*Ze,X.right=X.left+Ze,X.hasBaseline=$e}(W,e,i,s,O,u,x,T,S,C,A,M),!function(X){for(const ee of X)if(0!==ee.positionedGlyphs.length)return!1;return!0}(U)&&W}const Np={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},A0={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function C_(r,e,i,s,h,a){if(e.image){const u=s[e.image.serialize()];return u?u.displaySize[0]*e.scale*24/a+h:0}{const u=i[e.fontStack],x=u&&u.glyphs[r];return x?x.metrics.advance*e.scale+h:0}}function P_(r,e,i,s){const h=Math.pow(r-e,2);return s?r<e?h/2:2*h:h+Math.abs(i)*i}function I0(r,e,i){let s=0;return 10===r&&(s-=1e4),i&&(s+=150),40!==r&&65288!==r||(s+=50),41!==e&&65289!==e||(s+=50),s}function D_(r,e,i,s,h,a){let u=null,x=P_(e,i,h,a);for(const T of s){const C=P_(e-T.x,i,h,a)+T.badness;C<=x&&(u=T,x=C)}return{index:r,x:e,priorBreak:u,badness:x}}function z_(r){return r?z_(r.priorBreak).concat(r.index):[]}function Ff(r){let e=.5,i=.5;switch(r){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(r){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function R_(r,e,i,s,h){if(!(e||i||s||h))return;const a=r.length-1,u=r[a],x=(u.x+u.metrics.advance*u.scale)*e;for(let T=0;T<=a;T++)r[T].x-=x,r[T].y+=i+s+h}function C0(r,e,i,s){const{horizontalAlign:h,verticalAlign:a}=Ff(s),u=i[0]-r.displaySize[0]*h,x=i[1]-r.displaySize[1]*a;return{imagePrimary:r,imageSecondary:e,top:x,bottom:x+r.displaySize[1],left:u,right:u+r.displaySize[0]}}function L_(r,e,i,s,h,a){const u=r.imagePrimary;let x;if(u.content){const O=u.content,B=u.pixelRatio||1;x=[O[0]/B,O[1]/B,u.displaySize[0]-O[2]/B,u.displaySize[1]-O[3]/B]}const T=e.left*a,C=e.right*a;let g,S,A,w;"width"===i||"both"===i?(w=h[0]+T-s[3],S=h[0]+C+s[1]):(w=h[0]+(T+C-u.displaySize[0])/2,S=w+u.displaySize[0]);const M=e.top*a,P=e.bottom*a;return"height"===i||"both"===i?(g=h[1]+M-s[0],A=h[1]+P+s[2]):(g=h[1]+(M+P-u.displaySize[1])/2,A=g+u.displaySize[1]),{imagePrimary:u,imageSecondary:void 0,top:g,right:S,bottom:A,left:w,collisionPadding:x}}class fc extends pt{constructor(e,i,s,h,a){super(e,i),this.angle=h,this.z=s,void 0!==a&&(this.segment=a)}clone(){return new fc(this.x,this.y,this.z,this.angle,this.segment)}}function k_(r,e,i,s,h){if(void 0===e.segment)return!0;let a=e,u=e.segment+1,x=0;for(;x>-i/2;){if(u--,u<0)return!1;x-=r[u].dist(a),a=r[u]}x+=r[u].dist(r[u+1]),u++;const T=[];let C=0;for(;x<i/2;){const g=r[u],S=r[u+1];if(!S)return!1;let A=r[u-1].angleTo(g)-g.angleTo(S);for(A=Math.abs((A+3*Math.PI)%(2*Math.PI)-Math.PI),T.push({distance:x,angleDelta:A}),C+=A;x-T[0].distance>s;)C-=T.shift().angleDelta;if(C>h)return!1;u++,x+=g.dist(S)}return!0}function O_(r){let e=0;for(let i=0;i<r.length-1;i++)e+=r[i].dist(r[i+1]);return e}function F_(r,e,i){return r?.6*e*i:0}function B_(r,e){return Math.max(r?r.right-r.left:0,e?e.right-e.left:0)}function P0(r,e,i,s,h,a){const u=F_(i,h,a),x=B_(i,s)*a;let T=0;const C=O_(r)/2;for(let g=0;g<r.length-1;g++){const S=r[g],A=r[g+1],w=S.dist(A);if(T+w>C){const M=(C-T)/w,P=Ut(S.x,A.x,M),O=Ut(S.y,A.y,M),B=new fc(P,O,0,A.angleTo(S),g);return!u||k_(r,B,x,u,e)?B:void 0}T+=w}}function D0(r,e,i,s,h,a,u,x,T){const C=F_(s,a,u),g=B_(s,h),S=g*u,A=0===r[0].x||r[0].x===T||0===r[0].y||r[0].y===T;return e-S<e/4&&(e=S+e/4),N_(r,A?e/2*x%e:(g/2+2*a)*u*x%e,e,C,i,S,A,!1,T)}function N_(r,e,i,s,h,a,u,x,T){const C=a/2,g=O_(r);let S=0,A=e-i,w=[];for(let M=0;M<r.length-1;M++){const P=r[M],O=r[M+1],B=P.dist(O),G=O.angleTo(P);for(;A+i<S+B;){A+=i;const q=(A-S)/B,U=Ut(P.x,O.x,q),W=Ut(P.y,O.y,q);if(U>=0&&U<T&&W>=0&&W<T&&A-C>=0&&A+C<=g){const X=new fc(U,W,0,G,M);s&&!k_(r,X,a,s,h)||w.push(X)}}S+=B}return x||w.length||u||(w=N_(r,S/2,i,s,h,a,u,!0,T)),w}function V_(r,e,i,s,h){const a=[];for(let u=0;u<r.length;u++){const x=r[u];let T;for(let C=0;C<x.length-1;C++){let g=x[C],S=x[C+1];g.x<e&&S.x<e||(g.x<e?g=new pt(e,g.y+(e-g.x)/(S.x-g.x)*(S.y-g.y))._round():S.x<e&&(S=new pt(e,g.y+(e-g.x)/(S.x-g.x)*(S.y-g.y))._round()),g.y<i&&S.y<i||(g.y<i?g=new pt(g.x+(i-g.y)/(S.y-g.y)*(S.x-g.x),i)._round():S.y<i&&(S=new pt(g.x+(i-g.y)/(S.y-g.y)*(S.x-g.x),i)._round()),g.x>=s&&S.x>=s||(g.x>=s?g=new pt(s,g.y+(s-g.x)/(S.x-g.x)*(S.y-g.y))._round():S.x>=s&&(S=new pt(s,g.y+(s-g.x)/(S.x-g.x)*(S.y-g.y))._round()),g.y>=h&&S.y>=h||(g.y>=h?g=new pt(g.x+(h-g.y)/(S.y-g.y)*(S.x-g.x),h)._round():S.y>=h&&(S=new pt(g.x+(h-g.y)/(S.y-g.y)*(S.x-g.x),h)._round()),T&&g.equals(T[T.length-1])||(T=[g],a.push(T)),T.push(S)))))}}return a}function U_(r){let e=0,i=0;for(const u of r)e+=u.w*u.h,i=Math.max(i,u.w);r.sort((u,x)=>x.h-u.h);const s=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}];let h=0,a=0;for(const u of r)for(let x=s.length-1;x>=0;x--){const T=s[x];if(!(u.w>T.w||u.h>T.h)){if(u.x=T.x,u.y=T.y,a=Math.max(a,u.y+u.h),h=Math.max(h,u.x+u.w),u.w===T.w&&u.h===T.h){const C=s.pop();x<s.length&&(s[x]=C)}else u.h===T.h?(T.x+=u.w,T.w-=u.w):u.w===T.w?(T.y+=u.h,T.h-=u.h):(s.push({x:T.x+u.w,y:T.y,w:T.w-u.w,h:u.h}),T.y+=u.h,T.h-=u.h);break}}return{w:h,h:a,fill:e/(h*a)||0}}St(fc,"Anchor");class np{static getImagePositionScale(e,i,s){return i&&e&&e.options&&e.options.transform?{x:e.options.transform.a,y:e.options.transform.d}:{x:s,y:s}}constructor(e,{pixelRatio:i,version:s,stretchX:h,stretchY:a,content:u,sdf:x,usvg:T},C,g){this.paddedRect=e,this.pixelRatio=i,this.stretchX=h,this.stretchY=a,this.content=u,this.version=s,this.padding=C,this.sdf=x,this.scale=np.getImagePositionScale(g,T,i)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}class j_{constructor(e,i,s){const h={},a={};this.haveRenderCallbacks=[];const u=[];this.addImages(e,h,1,u),this.addImages(i,a,2,u);const{w:x,h:T}=U_(u),C=new I({width:x||1,height:T||1});for(const g in e){const S=e[g],A=h[g].paddedRect;I.copy(S.data,C,{x:0,y:0},{x:A.x+1,y:A.y+1},S.data,s,S.sdf)}for(const g in i){const S=i[g],A=a[g].paddedRect;let w=a[g].padding;const M=A.x+w,P=A.y+w,O=S.data.width,B=S.data.height;w=w>1?w-1:w,I.copy(S.data,C,{x:0,y:0},{x:M,y:P},S.data,s),I.copy(S.data,C,{x:0,y:B-w},{x:M,y:P-w},{width:O,height:w},s),I.copy(S.data,C,{x:0,y:0},{x:M,y:P+B},{width:O,height:w},s),I.copy(S.data,C,{x:O-w,y:0},{x:M-w,y:P},{width:w,height:B},s),I.copy(S.data,C,{x:0,y:0},{x:M+O,y:P},{width:w,height:B},s),I.copy(S.data,C,{x:O-w,y:B-w},{x:M-w,y:P-w},{width:w,height:w},s),I.copy(S.data,C,{x:0,y:B-w},{x:M+O,y:P-w},{width:w,height:w},s),I.copy(S.data,C,{x:0,y:0},{x:M+O,y:P+B},{width:w,height:w},s),I.copy(S.data,C,{x:O-w,y:0},{x:M-w,y:P+B},{width:w,height:w},s)}this.lut=s,this.image=C,this.iconPositions=h,this.patternPositions=a}addImages(e,i,s,h){for(const a in e){const u=e[a],x={x:0,y:0,w:u.data.width+2*s,h:u.data.height+2*s};h.push(x);const T=Ds.deserializeFromString(a);i[a]=new np(x,u,s,T),u.hasRenderCallback&&this.haveRenderCallbacks.push(T.id)}}patchUpdatedImages(e,i,s){this.haveRenderCallbacks=this.haveRenderCallbacks.filter(h=>e.hasImage(h,s)),e.dispatchRenderCallbacks(this.haveRenderCallbacks,s);for(const h in e.getUpdatedImages(s)){for(const a of Object.keys(this.iconPositions))Ds.deserializeId(a)===h&&this.patchUpdatedImage(this.iconPositions[a],e.getImage(h,s),i);for(const a of Object.keys(this.patternPositions))Ds.deserializeId(a)===h&&this.patchUpdatedImage(this.patternPositions[a],e.getImage(h,s),i)}}patchUpdatedImage(e,i,s){if(!e||!i||e.version===i.version)return;e.version=i.version;const[h,a]=e.tl,u=e.sdf;if(this.lut||u){const x={width:i.data.width,height:i.data.height},T=new I(x);I.copy(i.data,T,{x:0,y:0},{x:0,y:0},x,this.lut,u),s.update(T,{position:{x:h,y:a}})}else s.update(i.data,{position:{x:h,y:a}})}}St(np,"ImagePosition"),St(j_,"ImageAtlas");const rp=1e20;function G_(r,e,i,s,h,a,u,x,T){for(let C=e;C<e+s;C++)q_(r,i*a+C,a,h,u,x,T);for(let C=i;C<i+h;C++)q_(r,C*a+e,1,s,u,x,T)}function q_(r,e,i,s,h,a,u){a[0]=0,u[0]=-rp,u[1]=rp,h[0]=r[e];for(let x=1,T=0,C=0;x<s;x++){h[x]=r[e+x*i];const g=x*x;do{const S=a[T];C=(h[x]-h[S]+g-S*S)/(x-S)/2}while(C<=u[T]&&--T>-1);T++,a[T]=x,u[T]=C,u[T+1]=rp}for(let x=0,T=0;x<s;x++){for(;u[T+1]<x;)T++;const C=a[T],g=x-C;r[e+x*i]=h[C]+g*g}}const Bf={none:0,ideographs:1,all:2};class gd{constructor(e,i,s){this.requestManager=e,this.localGlyphMode=i,this.localFontFamily=s,this.urls={},this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e,i){this.urls[i]=e}getGlyphs(e,i,s){const h=[],a=this.urls[i]||En.GLYPHS_URL;for(const u in e)for(const x of e[u])h.push({stack:u,id:x});zi(h,({stack:u,id:x},T)=>{let C=this.entries[u];C||(C=this.entries[u]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let g=C.glyphs[x];if(void 0!==g)return void T(null,{stack:u,id:x,glyph:g});if(g=this._tinySDF(C,u,x),g)return C.glyphs[x]=g,void T(null,{stack:u,id:x,glyph:g});const S=Math.floor(x/256);if(256*S>65535)return ii("glyphs > 65535 not supported"),void T(null,{stack:u,id:x,glyph:g});if(C.ranges[S])return void T(null,{stack:u,id:x,glyph:g});let A=C.requests[S];A||(A=C.requests[S]=[],gd.loadGlyphRange(u,S,a,this.requestManager,(w,M)=>{if(M){C.ascender=M.ascender,C.descender=M.descender;for(const P in M.glyphs)this._doesCharSupportLocalGlyph(+P)||(C.glyphs[+P]=M.glyphs[+P]);C.ranges[S]=!0}for(const P of A)P(w,M);delete C.requests[S]})),A.push((w,M)=>{w?T(w):M&&T(null,{stack:u,id:x,glyph:M.glyphs[x]||null})})},(u,x)=>{if(u)s(u);else if(x){const T={};for(const{stack:C,id:g,glyph:S}of x)void 0===T[C]&&(T[C]={}),void 0===T[C].glyphs&&(T[C].glyphs={}),T[C].glyphs[g]=S&&{id:S.id,bitmap:S.bitmap.clone(),metrics:S.metrics},T[C].ascender=this.entries[C].ascender,T[C].descender=this.entries[C].descender;s(null,T)}})}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==Bf.none&&(this.localGlyphMode===Bf.all?!!this.localFontFamily:!!this.localFontFamily&&(Ct_CJK_Unified_Ideographs(e)||Ct_Hangul_Syllables(e)||Ct_Hiragana(e)||Ct_Katakana(e)||Ct_CJK_Symbols_and_Punctuation(e)||Ct_CJK_Unified_Ideographs_Extension_A(e)||Ct_CJK_Unified_Ideographs_Extension_B(e)||Ct_Osage(e)))}_tinySDF(e,i,s){const h=this.localFontFamily;if(!h||!this._doesCharSupportLocalGlyph(s))return;let a=e.tinySDF;if(!a){let P="400";/bold/i.test(i)?P="900":/medium/i.test(i)?P="500":/light/i.test(i)&&(P="200"),a=e.tinySDF=new gd.TinySDF({fontFamily:h,fontWeight:P,fontSize:48,buffer:6,radius:16}),a.fontWeight=P}if(this.localGlyphs[a.fontWeight][s])return this.localGlyphs[a.fontWeight][s];const u=String.fromCodePoint(s),{data:x,width:T,height:C,glyphWidth:g,glyphHeight:S,glyphLeft:A,glyphTop:w,glyphAdvance:M}=a.draw(u);return this.localGlyphs[a.fontWeight][s]={id:s,bitmap:new v({width:T,height:C},x),metrics:{width:g/2,height:S/2,left:A/2,top:w/2-27,advance:M/2,localGlyph:!0}}}}gd.loadGlyphRange=function(r,e,i,s,h){const a=256*e,u=a+255,x=s.transformRequest(s.normalizeGlyphsURL(i).replace("{fontstack}",r).replace("{range}",`${a}-${u}`),ui.Glyphs);Nn(x,(T,C)=>{if(T)h(T);else if(C){const g={},S=new Bp(C).readFields(S0,{});for(const A of S.glyphs)g[A.id]=A;h(null,{glyphs:g,ascender:S.ascender,descender:S.descender})}})},gd.TinySDF=class{constructor({fontSize:r=24,buffer:e=3,radius:i=8,cutoff:s=.25,fontFamily:h="sans-serif",fontWeight:a="normal",fontStyle:u="normal"}={}){this.buffer=e,this.cutoff=s,this.radius=i;const x=this.size=r+4*e,T=this._createCanvas(x),C=this.ctx=T.getContext("2d",{willReadFrequently:!0});C.font=`${u} ${a} ${r}px ${h}`,C.textBaseline="alphabetic",C.textAlign="left",C.fillStyle="black",this.gridOuter=new Float64Array(x*x),this.gridInner=new Float64Array(x*x),this.f=new Float64Array(x),this.z=new Float64Array(x+1),this.v=new Uint16Array(x)}_createCanvas(r){const e=document.createElement("canvas");return e.width=e.height=r,e}draw(r){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:s,actualBoundingBoxLeft:h,actualBoundingBoxRight:a}=this.ctx.measureText(r),u=Math.ceil(i),x=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(a-h))),T=Math.min(this.size-this.buffer,u+Math.ceil(s)),C=x+2*this.buffer,g=T+2*this.buffer,S=Math.max(C*g,0),A=new Uint8ClampedArray(S),w={data:A,width:C,height:g,glyphWidth:x,glyphHeight:T,glyphTop:u,glyphLeft:0,glyphAdvance:e};if(0===x||0===T)return w;const{ctx:M,buffer:P,gridInner:O,gridOuter:B}=this;M.clearRect(P,P,x,T),M.fillText(r,P,P+u);const G=M.getImageData(P,P,x,T);B.fill(rp,0,S),O.fill(0,0,S);for(let q=0;q<T;q++)for(let U=0;U<x;U++){const W=G.data[4*(q*x+U)+3]/255;if(0===W)continue;const X=(q+P)*C+U+P;if(1===W)B[X]=0,O[X]=rp;else{const ee=.5-W;B[X]=ee>0?ee*ee:0,O[X]=ee<0?ee*ee:0}}G_(B,0,0,C,g,C,this.f,this.v,this.z),G_(O,P,P,x,T,C,this.f,this.v,this.z);for(let q=0;q<S;q++){const U=Math.sqrt(B[q])-Math.sqrt(O[q]);A[q]=Math.round(255-255*(U/this.radius+this.cutoff))}return w}};function H_(r,e){return r+e[1]-e[0]}function W_(r,e,i,s,h=1){const a=[],u=r.imagePrimary,x=u.pixelRatio,T=u.paddedRect.w-2,C=u.paddedRect.h-2,g=(r.right-r.left)*h,S=(r.bottom-r.top)*h,A=u.stretchX||[[0,T]],w=u.stretchY||[[0,C]],M=A.reduce(H_,0),P=w.reduce(H_,0),O=T-M,B=C-P;let G=0,q=M,U=0,W=P,X=0,ee=O,ae=0,oe=B;if(u.content&&s){const ye=u.content;G=Vp(A,0,ye[0]),U=Vp(w,0,ye[1]),q=Vp(A,ye[0],ye[2]),W=Vp(w,ye[1],ye[3]),X=ye[0]-G,ae=ye[1]-U,ee=ye[2]-ye[0]-q,oe=ye[3]-ye[1]-W}const se=(ye,le,ve,Se)=>{const we=Up(ye.stretch-G,q,g,r.left*h),Ae=jp(ye.fixed-X,ee,ye.stretch,M),Pe=Up(le.stretch-U,W,S,r.top*h),ke=jp(le.fixed-ae,oe,le.stretch,P),Ce=Up(ve.stretch-G,q,g,r.left*h),Ze=jp(ve.fixed-X,ee,ve.stretch,M),tt=Up(Se.stretch-U,W,S,r.top*h),$e=jp(Se.fixed-ae,oe,Se.stretch,P),gt=new pt(we,Pe),mt=new pt(Ce,Pe),st=new pt(Ce,tt),nt=new pt(we,tt),It=new pt(Ae/x,ke/x),yt=new pt(Ze/x,$e/x),wt=e*Math.PI/180;if(wt){const _i=Math.sin(wt),rn=Math.cos(wt),$i=[rn,-_i,_i,rn];gt._matMult($i),mt._matMult($i),nt._matMult($i),st._matMult($i)}const $t=ye.stretch+ye.fixed,ni=ve.stretch+ve.fixed,ri=le.stretch+le.fixed,si=Se.stretch+Se.fixed,fi=r.imageSecondary;return{tl:gt,tr:mt,bl:nt,br:st,texPrimary:{x:u.paddedRect.x+1+$t,y:u.paddedRect.y+1+ri,w:ni-$t,h:si-ri},texSecondary:fi?{x:fi.paddedRect.x+1+$t,y:fi.paddedRect.y+1+ri,w:ni-$t,h:si-ri}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:It,pixelOffsetBR:yt,minFontScaleX:ee/x/g,minFontScaleY:oe/x/S,isSDF:i}};if(s&&(u.stretchX||u.stretchY)){const ye=$_(A,O,M),le=$_(w,B,P);for(let ve=0;ve<ye.length-1;ve++){const Se=ye[ve],we=ye[ve+1];for(let Ae=0;Ae<le.length-1;Ae++)a.push(se(Se,le[Ae],we,le[Ae+1]))}}else a.push(se({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:T+1},{fixed:0,stretch:C+1}));return a}function Vp(r,e,i){let s=0;for(const h of r)s+=Math.max(e,Math.min(i,h[1]))-Math.max(e,Math.min(i,h[0]));return s}function $_(r,e,i){const s=[{fixed:-1,stretch:0}];for(const[h,a]of r){const u=s[s.length-1];s.push({fixed:h-u.stretch,stretch:u.stretch}),s.push({fixed:h-u.stretch,stretch:u.stretch+(a-h)})}return s.push({fixed:e+1,stretch:i}),s}function Up(r,e,i,s){return r/e*i+s}function jp(r,e,i,s){return r-e*i/s}function z0(r,e,i,s){const h=e+r.positionedLines[s].lineOffset;return 0===s?i+h/2:i+(h+(e+r.positionedLines[s-1].lineOffset))/2}function R0(r,e=1,i=!1){let s=1/0,h=1/0,a=-1/0,u=-1/0;const x=r[0];for(let w=0;w<x.length;w++){const M=x[w];(!w||M.x<s)&&(s=M.x),(!w||M.y<h)&&(h=M.y),(!w||M.x>a)&&(a=M.x),(!w||M.y>u)&&(u=M.y)}const T=Math.min(a-s,u-h);let C=T/2;const g=new Un([],L0);if(0===T)return new pt(s,h);for(let w=s;w<a;w+=T)for(let M=h;M<u;M+=T)g.push(new yd(w+C,M+C,C,r));let S=function(w){let M=0,P=0,O=0;const B=w[0];for(let G=0,q=B.length,U=q-1;G<q;U=G++){const W=B[G],X=B[U],ee=W.x*X.y-X.x*W.y;P+=(W.x+X.x)*ee,O+=(W.y+X.y)*ee,M+=3*ee}return new yd(P/M,O/M,0,w)}(r),A=g.length;for(;g.length;){const w=g.pop();(w.d>S.d||!S.d)&&(S=w,i&&console.log("found best %d after %d probes",Math.round(1e4*w.d)/1e4,A)),w.max-S.d<=e||(C=w.h/2,g.push(new yd(w.p.x-C,w.p.y-C,C,r)),g.push(new yd(w.p.x+C,w.p.y-C,C,r)),g.push(new yd(w.p.x-C,w.p.y+C,C,r)),g.push(new yd(w.p.x+C,w.p.y+C,C,r)),A+=4)}return i&&(console.log(`num probes: ${A}`),console.log(`best distance: ${S.d}`)),S.p}function L0(r,e){return e.max-r.max}class yd{constructor(e,i,s,h){this.p=new pt(e,i),this.h=s,this.d=function(a,u){let x=!1,T=1/0;for(let C=0;C<u.length;C++){const g=u[C];for(let S=0,A=g.length,w=A-1;S<A;w=S++){const M=g[S],P=g[w];M.y>a.y!=P.y>a.y&&a.x<(P.x-M.x)*(a.y-M.y)/(P.y-M.y)+M.x&&(x=!x),T=Math.min(T,pe(a,M,P))}}return(x?1:-1)*Math.sqrt(T)}(this.p,h),this.max=this.d+this.h*Math.SQRT2}}const Nf=Number.POSITIVE_INFINITY,k0=Math.sqrt(2);function Z_(r,[e,i]){let s=0,h=0;if(i===Nf){e<0&&(e=0);const a=e/k0;switch(r){case"top-right":case"top-left":h=a-7;break;case"bottom-right":case"bottom-left":h=7-a;break;case"bottom":h=7-e;break;case"top":h=e-7}switch(r){case"top-right":case"bottom-right":s=-a;break;case"top-left":case"bottom-left":s=a;break;case"left":s=e;break;case"right":s=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),r){case"top-right":case"top-left":case"top":h=i-7;break;case"bottom-right":case"bottom-left":case"bottom":h=7-i}switch(r){case"top-right":case"bottom-right":case"right":s=-e;break;case"top-left":case"bottom-left":case"left":s=e}}return[s,h]}function Vf(r){switch(r){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function O0(r,e,i,s,h,a,u,x,T,C,g,S,A,w,M){let P=a.textMaxSize.evaluate(e,{},S);void 0===P?P=u*a.textScaleFactor:P*=a.textScaleFactor;const O=r.layers[0].layout,B=O.get("icon-offset").evaluate(e,{},S),G=Y_(i.horizontal)||i.vertical,q="globe"===A.name,W=u*a.textScaleFactor/24,X=r.tilePixelRatio*P/24,ee=(we=r.overscaling,r.zoom>18&&we>2&&(we>>=1),Math.max(ft/(512*we),1)*O.get("symbol-spacing")),ae=O.get("text-padding")*r.tilePixelRatio,oe=O.get("icon-padding")*r.tilePixelRatio,se=yi(O.get("text-max-angle")),ye="map"===O.get("text-rotation-alignment")&&"point"!==O.get("symbol-placement"),le="map"===O.get("icon-rotation-alignment")&&"point"!==O.get("symbol-placement"),ve=O.get("symbol-placement"),Se=ee/2;var we;const Ae=O.get("icon-text-fit").evaluate(e,{},S),Pe=O.get("icon-text-fit-padding").evaluate(e,{},S),ke="none"!==Ae;let Ce;!1===r.hasAnyIconTextFit&&ke&&(r.hasAnyIconTextFit=!0),s&&ke&&(r.allowVerticalPlacement&&i.vertical&&(Ce=L_(s,i.vertical,Ae,Pe,B,W)),G&&(s=L_(s,G,Ae,Pe,B,W)));const Ze=(tt,$e,gt)=>{if($e.x<0||$e.x>=ft||$e.y<0||$e.y>=ft)return;let mt=null;if(q){const{x:st,y:nt,z:It}=A.projectTilePoint($e.x,$e.y,gt);mt={anchor:new fc(st,nt,It,0,void 0),up:A.upVector(gt,$e.x,$e.y)}}!function(st,nt,It,yt,wt,$t,ni,ri,si,fi,_i,rn,$i,Jt,Ui,Gi,an,Pn,qn,Dn,Tn,On,Zn,Lr,on,Ts,Pa){const Ho=st.addToLineVertexArray(nt,yt);let Wo,Pu,ph,Du,Tp,Py,Dy,zy=0,Ry=0,Ly=0,ky=0,bm=-1,wm=-1;const Tl={};let Oy=ns("");const zu=It?It.anchor:nt,Tm="none"!==si.layout.get("icon-text-fit").evaluate(Tn,{},on);let Sm=0,Mm=0;if(void 0===si._unevaluatedLayout.getValue("text-radial-offset")?[Sm,Mm]=si.layout.get("text-offset").evaluate(Tn,{},on).map(ho=>24*ho):(Sm=24*si.layout.get("text-radial-offset").evaluate(Tn,{},on),Mm=Nf),st.allowVerticalPlacement&&wt.vertical){const ho=wt.vertical;if(Ui)Py=Uf(ho),ri&&(Dy=Uf(ri));else{const Ss=si.layout.get("text-rotate").evaluate(Tn,{},on)+90;ph=Gp(fi,zu,nt,_i,rn,$i,ho,Jt,Ss,Gi),ri&&(Du=Gp(fi,zu,nt,_i,rn,$i,ri,Pn,Ss))}}if($t){const ho=st.iconSizeData,Ss=si.layout.get("icon-rotate").evaluate(Tn,{},on),Sp=W_($t,Ss,Zn,Tm,On.iconScaleFactor),Am=ri?W_(ri,Ss,Zn,Tm,On.iconScaleFactor):void 0;Pu=Gp(fi,zu,nt,_i,rn,$i,$t,Pn,Ss,null),zy=4*Sp.length;let Ru=null;"source"===ho.kind?(Ru=[Ma*si.layout.get("icon-size").evaluate(Tn,{},on)*On.iconScaleFactor],Ru[0]>ch&&ii(`${st.layerIds[0]}: Value for "icon-size" is >= ${sp}. Reduce your "icon-size".`)):"composite"===ho.kind&&(Ru=[Ma*On.compositeIconSizes[0].evaluate(Tn,{},on)*On.iconScaleFactor,Ma*On.compositeIconSizes[1].evaluate(Tn,{},on)*On.iconScaleFactor],(Ru[0]>ch||Ru[1]>ch)&&ii(`${st.layerIds[0]}: Value for "icon-size" is >= ${sp}. Reduce your "icon-size".`)),st.addSymbols(st.icon,Sp,Ru,Dn,qn,Tn,!1,It,nt,Ho.lineStartIndex,Ho.lineLength,-1,Lr,on,Ts,Pa),bm=st.icon.placedSymbolArray.length-1,Am&&(Ry=4*Am.length,st.addSymbols(st.icon,Am,Ru,Dn,qn,Tn,lo.vertical,It,nt,Ho.lineStartIndex,Ho.lineLength,-1,Lr,on,Ts,Pa),wm=st.icon.placedSymbolArray.length-1)}for(const ho in wt.horizontal){const Ss=wt.horizontal[ho];Wo||(Oy=ns(Ss.text),Ui?Tp=Uf(Ss):Wo=Gp(fi,zu,nt,_i,rn,$i,Ss,Jt,si.layout.get("text-rotate").evaluate(Tn,{},on),Gi));const Sp=1===Ss.positionedLines.length;if(Ly+=X_(st,It,nt,Ss,ni,si,Ui,Tn,Gi,Ho,wt.vertical?lo.horizontal:lo.horizontalOnly,Sp?Object.keys(wt.horizontal):[ho],Tl,bm,On,Lr,on,Ts),Sp)break}wt.vertical&&(ky+=X_(st,It,nt,wt.vertical,ni,si,Ui,Tn,Gi,Ho,lo.vertical,["vertical"],Tl,wm,On,Lr,on,Ts));let fh=-1;const Em=(ho,Ss)=>ho?Math.max(ho,Ss):Ss;fh=Em(Tp,fh),fh=Em(Py,fh),fh=Em(Dy,fh);const mv=fh>-1?1:0;st.glyphOffsetArray.length>=65535&&ii("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==Tn.sortKey&&st.addToSortKeyRanges(st.symbolInstances.length,Tn.sortKey),st.symbolInstances.emplaceBack(nt.x,nt.y,zu.x,zu.y,zu.z,Tl.right>=0?Tl.right:-1,Tl.center>=0?Tl.center:-1,Tl.left>=0?Tl.left:-1,Tl.vertical>=0?Tl.vertical:-1,bm,wm,Oy,void 0!==Wo?Wo:st.collisionBoxArray.length,void 0!==Wo?Wo+1:st.collisionBoxArray.length,void 0!==ph?ph:st.collisionBoxArray.length,void 0!==ph?ph+1:st.collisionBoxArray.length,void 0!==Pu?Pu:st.collisionBoxArray.length,void 0!==Pu?Pu+1:st.collisionBoxArray.length,Du||st.collisionBoxArray.length,Du?Du+1:st.collisionBoxArray.length,_i,Ly,ky,zy,Ry,mv,0,Sm,Mm,fh,0,Tm?1:0)}(r,$e,mt,tt,i,s,h,Ce,r.layers[0],r.collisionBoxArray,e.index,e.sourceLayerIndex,r.index,ae,ye,T,0,oe,le,B,e,a,C,g,S,w,M)};if("line"===ve)for(const tt of V_(e.geometry,0,0,ft,ft)){const $e=D0(tt,ee,se,i.vertical||G,s,24,X,r.overscaling,ft);for(const gt of $e)G&&F0(r,G.text,Se,gt)||Ze(tt,gt,S)}else if("line-center"===ve){for(const tt of e.geometry)if(tt.length>1){const $e=P0(tt,se,i.vertical||G,s,24,X);$e&&Ze(tt,$e,S)}}else if("Polygon"===e.type)for(const tt of gr(e.geometry,0)){const $e=R0(tt,16);Ze(tt[0],new fc($e.x,$e.y,0,0,void 0),S)}else if("LineString"===e.type)for(const tt of e.geometry)Ze(tt,new fc(tt[0].x,tt[0].y,0,0,void 0),S);else if("Point"===e.type)for(const tt of e.geometry)for(const $e of tt)Ze([$e],new fc($e.x,$e.y,0,0,void 0),S)}const sp=255,ch=sp*Ma;function X_(r,e,i,s,h,a,u,x,T,C,g,S,A,w,M,P,O,B){const G=function(W,X,ee,ae,oe,se,ye,le){const ve=[];if(0===X.positionedLines.length)return ve;const Se=ae.layout.get("text-rotate").evaluate(se,{})*Math.PI/180,we=function(Ze){const tt=Ze[0],$e=Ze[1],gt=tt*$e;return gt>0?[tt,-$e]:gt<0?[-tt,$e]:0===tt?[$e,tt]:[$e,-tt]}(ee);let Ae=Math.abs(X.top-X.bottom);for(const Ze of X.positionedLines)Ae-=Ze.lineOffset;const Pe=X.positionedLines.length,ke=Ae/Pe;let Ce=X.top-ee[1];for(let Ze=0;Ze<Pe;++Ze){const tt=X.positionedLines[Ze];Ce=z0(X,ke,Ce,Ze);for(const $e of tt.positionedGlyphs){if(!$e.rect)continue;const gt=$e.rect||{};let mt=4,st=!0,nt=1,It=0;if($e.imageName){const Dn=ye[rr.build($e.imageName).getSerializedPrimary()];if(!Dn)continue;if(Dn.sdf){ii("SDF images are not supported in formatted text and will be ignored.");continue}st=!1,nt=Dn.pixelRatio,mt=1/nt}const yt=(oe||le)&&$e.vertical,wt=$e.metrics.advance*$e.scale/2,$t=$e.metrics,ni=$e.rect;if(null===ni)continue;le&&X.verticalizable&&(It=$e.imageName?wt-$e.metrics.width*$e.scale/2:0);const ri=oe?[$e.x+wt,$e.y]:[0,0];let si=[0,0],fi=[0,0],_i=!1;oe||(yt?(fi=[$e.x+wt+we[0],$e.y+we[1]-It],_i=!0):si=[$e.x+wt+ee[0],$e.y+ee[1]-It]);const rn=ni.w*$e.scale/(nt*($e.localGlyph?2:1)),$i=ni.h*$e.scale/(nt*($e.localGlyph?2:1));let Jt,Ui,Gi,an;if(yt){const Dn=$e.y-Ce,Tn=new pt(-wt,wt-Dn),On=-Math.PI/2,Zn=new pt(...fi);Jt=new pt(-wt+si[0],si[1]),Jt._rotateAround(On,Tn)._add(Zn),Jt.x+=-Dn+wt,Jt.y-=($t.left-mt)*$e.scale;const Lr=$e.imageName?$t.advance*$e.scale:24*$e.scale,on=String.fromCodePoint($e.glyph);b0(on)?Jt.x+=(1-mt)*$e.scale:w0(on)?Jt.x+=Lr-$t.height*$e.scale+(-mt-1)*$e.scale:Jt.x+=$e.imageName||$t.width+2*mt===ni.w&&$t.height+2*mt===ni.h?(Lr-$i)/2:(Lr-($t.height+2*mt)*$e.scale)/2,Ui=new pt(Jt.x,Jt.y-rn),Gi=new pt(Jt.x+$i,Jt.y),an=new pt(Jt.x+$i,Jt.y-rn)}else{const Dn=($t.left-mt)*$e.scale-wt+si[0],Tn=(-$t.top-mt)*$e.scale+si[1],On=Dn+rn,Zn=Tn+$i;Jt=new pt(Dn,Tn),Ui=new pt(On,Tn),Gi=new pt(Dn,Zn),an=new pt(On,Zn)}if(Se){let Dn;Dn=oe?new pt(0,0):_i?new pt(we[0],we[1]):new pt(ee[0],ee[1]),Jt._rotateAround(Se,Dn),Ui._rotateAround(Se,Dn),Gi._rotateAround(Se,Dn),an._rotateAround(Se,Dn)}const Pn=new pt(0,0),qn=new pt(0,0);ve.push({tl:Jt,tr:Ui,bl:Gi,br:an,texPrimary:gt,texSecondary:void 0,writingMode:X.writingMode,glyphOffset:ri,sectionIndex:$e.sectionIndex,isSDF:st,pixelOffsetTL:Pn,pixelOffsetBR:qn,minFontScaleX:0,minFontScaleY:0})}}return ve}(0,s,T,a,u,x,h,r.allowVerticalPlacement),q=r.textSizeData;let U=null;"source"===q.kind?(U=[Ma*a.layout.get("text-size").evaluate(x,{},O)*M.textScaleFactor],U[0]>ch&&ii(`${r.layerIds[0]}: Value for "text-size" is >= ${sp}. Reduce your "text-size".`)):"composite"===q.kind&&(U=[Ma*M.compositeTextSizes[0].evaluate(x,{},O)*M.textScaleFactor,Ma*M.compositeTextSizes[1].evaluate(x,{},O)*M.textScaleFactor],(U[0]>ch||U[1]>ch)&&ii(`${r.layerIds[0]}: Value for "text-size" is >= ${sp}. Reduce your "text-size".`)),r.addSymbols(r.text,G,U,T,u,x,g,e,i,C.lineStartIndex,C.lineLength,w,P,O,B,!1);for(const W of S)A[W]=r.text.placedSymbolArray.length-1;return 4*G.length}function Y_(r){for(const e in r)return r[e];return null}function Gp(r,e,i,s,h,a,u,x,T,C){let g=u.top,S=u.bottom,A=u.left,w=u.right;const M=u.collisionPadding;if(M&&(A-=M[0],g-=M[1],w+=M[2],S+=M[3]),T){const P=new pt(A,g),O=new pt(w,g),B=new pt(A,S),G=new pt(w,S),q=yi(T);let U=new pt(0,0);C&&(U=new pt(C[0],C[1])),P._rotateAround(q,U),O._rotateAround(q,U),B._rotateAround(q,U),G._rotateAround(q,U),A=Math.min(P.x,O.x,B.x,G.x),w=Math.max(P.x,O.x,B.x,G.x),g=Math.min(P.y,O.y,B.y,G.y),S=Math.max(P.y,O.y,B.y,G.y)}return r.emplaceBack(e.x,e.y,e.z,i.x,i.y,A,g,w,S,x,s,h,a),r.length-1}function Uf(r){r.collisionPadding&&(r.top-=r.collisionPadding[1],r.bottom+=r.collisionPadding[3]);const e=r.bottom-r.top;return e>0?Math.max(10,e):null}function F0(r,e,i,s){const h=r.compareText;if(e in h){const a=h[e];for(let u=a.length-1;u>=0;u--)if(s.dist(a[u])<i)return!0}else h[e]=[];return h[e].push(s),!1}function K_(r,e){const i=r.fovAboveCenter,s=r.elevation?r.elevation.getMinElevationBelowMSL()*e:0,h=(r._camera.position[2]*r.worldSize-s)/Math.cos(r._pitch),a=Math.sin(i)*h/Math.sin(Math.max(Math.PI/2-r._pitch-i,.01));let u=Math.sin(r._pitch)*a+h;const x=h*(1/r._horizonShift);if(!r.elevation||0===r.elevation.exaggeration()){let T=Math.max(r.zoom-17,0);r.isOrthographic&&(T/=10),u*=1+T}return Math.min(1.01*u,x)}function op(r,e){if(!e.isReprojectedInTileSpace)return{scale:1<<r.z,x:r.x,y:r.y,x2:r.x+1,y2:r.y+1,projection:e};const i=Math.pow(2,-r.z),s=r.x*i,h=(r.x+1)*i,a=r.y*i,u=(r.y+1)*i,x=Vr(s),T=Vr(h),C=$n(a),g=$n(u),S=e.project(x,C),A=e.project(T,C),w=e.project(T,g),M=e.project(x,g);let P=Math.min(S.x,A.x,w.x,M.x),O=Math.min(S.y,A.y,w.y,M.y),B=Math.max(S.x,A.x,w.x,M.x),G=Math.max(S.y,A.y,w.y,M.y);const q=i/16;function U(X,ee,ae,oe,se,ye){const le=(ae+se)/2,ve=(oe+ye)/2,Se=e.project(Vr(le),$n(ve)),we=Math.max(0,P-Se.x,O-Se.y,Se.x-B,Se.y-G);P=Math.min(P,Se.x),B=Math.max(B,Se.x),O=Math.min(O,Se.y),G=Math.max(G,Se.y),we>q&&(U(X,Se,ae,oe,le,ve),U(Se,ee,le,ve,se,ye))}U(S,A,s,a,h,a),U(A,w,h,a,h,u),U(w,M,h,u,s,u),U(M,S,s,u,s,a),P-=q,O-=q,B+=q,G+=q;const W=1/Math.max(B-P,G-O);return{scale:W,x:P*W,y:O*W,x2:B*W,y2:G*W,projection:e}}function J_(r,{x:e,y:i},s=0){return new pt(((e-s)*r.scale-r.x)*ft,(i*r.scale-r.y)*ft)}const B0=Ie.mat4.identity(new Float32Array(16));class hh{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,i){return{x:0,y:0,z:0}}unproject(e,i){return new Ci(0,0)}projectTilePoint(e,i,s){return{x:e,y:i,z:0}}locationPoint(e,i,s=!0){return e._coordinatePoint(e.locationCoordinate(i),s)}pixelsPerMeter(e,i){return fr(1,e)*i}pixelSpaceConversion(e,i,s){return 1}farthestPixelDistance(e){return K_(e,e.pixelsPerMeter)}pointCoordinate(e,i,s,h){const a=e.horizonLineFromTop(!1),u=new pt(i,Math.max(a,s));return e.rayIntersectionCoordinate(e.pointRayIntersection(u,h))}pointCoordinate3D(e,i,s){const h=new pt(i,s);if(e.elevation)return e.elevation.pointCoordinate(h);{const a=this.pointCoordinate(e,h.x,h.y,0);return[a.x,a.y,a.z]}}isPointAboveHorizon(e,i){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,i.x,i.y);const s=e.horizonLineFromTop();return i.y<s}createInversionMatrix(e,i){return B0}createTileMatrix(e,i,s){let h,a,u;const x=s.canonical,T=Ie.mat4.identity(new Float64Array(16));if(this.isReprojectedInTileSpace){const C=op(x,this);h=1,a=C.x+s.wrap*C.scale,u=C.y,Ie.mat4.scale(T,T,[h/C.scale,h/C.scale,e.pixelsPerMeter/i])}else h=i/e.zoomScale(x.z),a=(x.x+Math.pow(2,x.z)*s.wrap)*h,u=x.y*h;return Ie.mat4.translate(T,T,[a,u,0]),Ie.mat4.scale(T,T,[h/ft,h/ft,1]),T}upVector(e,i,s){return[0,0,1]}upVectorScale(e,i,s){return{metersToTile:1}}}class N0 extends hh{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[i,s]=this.parallels=e.parallels||[29.5,45.5],h=Math.sin(yi(i));this.n=(h+Math.sin(yi(s)))/2,this.c=1+h*(2*this.n-h),this.r0=Math.sqrt(this.c)/this.n}project(e,i){const{n:s,c:h,r0:a}=this,u=yi(e-this.center[0]),x=yi(i),T=Math.sqrt(h-2*s*Math.sin(x))/s;return{x:T*Math.sin(u*s),y:T*Math.cos(u*s)-a,z:0}}unproject(e,i){const{n:s,c:h,r0:a}=this,u=a+i;let x=Math.atan2(e,Math.abs(u))*Math.sign(u);u*s<0&&(x-=Math.PI*Math.sign(e)*Math.sign(u));const T=yi(this.center[0])*s;x=Yi(x,-Math.PI-T,Math.PI-T);const C=ai(Hn(x/s)+this.center[0],-180,180),g=Math.asin(ai((h-(e*e+u*u)*s*s)/(2*s),-1,1)),S=ai(Hn(g),-_n,_n);return new Ci(C,S)}}const ap=1.340264,lp=-.081106,cp=893e-6,hp=.003796,qp=Math.sqrt(3)/2;class V0 extends hh{project(e,i){i=i/180*Math.PI,e=e/180*Math.PI;const s=Math.asin(qp*Math.sin(i)),h=s*s,a=h*h*h;return{x:.5*(e*Math.cos(s)/(qp*(ap+3*lp*h+a*(7*cp+9*hp*h)))/Math.PI+.5),y:1-.5*(s*(ap+lp*h+a*(cp+hp*h))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let s=i=(2*(1-i)-1)*Math.PI,h=s*s,a=h*h*h;for(let g,S,A,w=0;w<12&&(S=s*(ap+lp*h+a*(cp+hp*h))-i,A=ap+3*lp*h+a*(7*cp+9*hp*h),g=S/A,s=ai(s-g,-Math.PI/3,Math.PI/3),h=s*s,a=h*h*h,!(Math.abs(g)<1e-12));++w);const u=qp*e*(ap+3*lp*h+a*(7*cp+9*hp*h))/Math.cos(s),x=Math.asin(Math.sin(s)/qp),T=ai(180*u/Math.PI,-180,180),C=ai(180*x/Math.PI,-_n,_n);return new Ci(T,C)}}class U0 extends hh{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){return{x:.5+e/360,y:.5-i/360,z:0}}unproject(e,i){const s=360*(e-.5),h=ai(360*(.5-i),-_n,_n);return new Ci(s,h)}}const xd=Math.PI/2;function Hp(r){return Math.tan((xd+r)/2)}class j0 extends hh{constructor(e){super(e),this.center=e.center||[0,30];const[i,s]=this.parallels=e.parallels||[30,30];let h=yi(i),a=yi(s);this.southernCenter=h+a<0,this.southernCenter&&(h=-h,a=-a);const u=Math.cos(h),x=Hp(h);this.n=h===a?Math.sin(h):Math.log(u/Math.cos(a))/Math.log(Hp(a)/x),this.f=u*Math.pow(Hp(h),this.n)/this.n}project(e,i){i=yi(i),this.southernCenter&&(i=-i),e=yi(e-this.center[0]);const s=1e-6,{n:h,f:a}=this;a>0?i<-xd+s&&(i=-xd+s):i>xd-s&&(i=xd-s);const u=a/Math.pow(Hp(i),h);let x=u*Math.sin(h*e),T=a-u*Math.cos(h*e);return x=.5*(x/Math.PI+.5),T=.5*(T/Math.PI+.5),{x,y:this.southernCenter?T:1-T,z:0}}unproject(e,i){e=(2*e-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;const{n:s,f:h}=this,a=h-i,u=Math.sign(a),x=Math.sign(s)*Math.sqrt(e*e+a*a);let T=Math.atan2(e,Math.abs(a))*u;a*s<0&&(T-=Math.PI*Math.sign(e)*u);const C=ai(Hn(T/s)+this.center[0],-180,180),g=ai(Hn(2*Math.atan(Math.pow(h/x,1/s))-xd),-_n,_n);return new Ci(C,this.southernCenter?-g:g)}}class Q_ extends hh{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,i){return{x:Us(e),y:cs(i),z:0}}unproject(e,i){const s=Vr(e),h=$n(i);return new Ci(s,h)}}const eg=yi(_n);class G0 extends hh{project(e,i){const s=(i=yi(i))*i,h=s*s;return{x:.5*((e=yi(e))*(.8707-.131979*s+h*(h*(.003971*s-.001529*h)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+s*(.015085+h*(.028874*s-.044475-.005916*h)))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let s=i=(2*(1-i)-1)*Math.PI,h=25,a=0,u=s*s;do{u=s*s;const C=u*u;a=(s*(1.007226+u*(.015085+C*(.028874*u-.044475-.005916*C)))-i)/(1.007226+u*(.045255+C*(.259866*u-.311325-.005916*11*C))),s=ai(s-a,-eg,eg)}while(Math.abs(a)>1e-6&&--h>0);u=s*s;const x=ai(Hn(e/(.8707+u*(u*(u*u*u*(.003971-.001529*u)-.013791)-.131979))),-180,180),T=Hn(s);return new Ci(x,T)}}const tg=yi(_n);class q0 extends hh{project(e,i){i=yi(i),e=yi(e);const s=Math.cos(i),h=2/Math.PI,a=Math.acos(s*Math.cos(e/2)),u=Math.sin(a)/a,x=.5*(e*h+2*s*Math.sin(e/2)/u)||0,T=.5*(i+Math.sin(i)/u)||0;return{x:.5*(x/Math.PI+.5),y:1-.5*(T/Math.PI+1),z:0}}unproject(e,i){let s=e=(2*e-.5)*Math.PI,h=i=(2*(1-i)-1)*Math.PI,a=25;const u=1e-6;let x=0,T=0;do{const C=Math.cos(h),g=Math.sin(h),S=2*g*C,A=g*g,w=C*C,M=Math.cos(s/2),P=Math.sin(s/2),O=2*M*P,B=P*P,G=1-w*M*M,q=G?1/G:0,U=G?Math.acos(C*M)*Math.sqrt(1/G):0,W=.5*(2*U*C*P+2*s/Math.PI)-e,X=.5*(U*g+h)-i,ee=.5*q*(w*B+U*C*M*A)+1/Math.PI,ae=q*(O*S/4-U*g*P),oe=.125*q*(S*P-U*g*w*O),se=.5*q*(A*M+U*B*C)+.5,ye=ae*oe-se*ee;x=(X*ae-W*se)/ye,T=(W*oe-X*ee)/ye,s=ai(s-x,-Math.PI,Math.PI),h=ai(h-T,-tg,tg)}while((Math.abs(x)>u||Math.abs(T)>u)&&--a>0);return new Ci(Hn(s),Hn(h))}}class ig extends hh{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(yi(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){const{scale:s,cosPhi:h}=this;return{x:yi(e)*h*s+.5,y:-Math.sin(yi(i))/h*s+.5,z:0}}unproject(e,i){const{scale:s,cosPhi:h}=this,a=-(i-.5)/s,u=ai(Hn((e-.5)/s)/h,-180,180),x=Math.asin(ai(a*h,-1,1)),T=ai(Hn(x),-_n,_n);return new Ci(u,T)}}class H0 extends Q_{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,i,s){const h=vi(e,i,s),a=kn(An(s));return Ie.vec3.transformMat4(h,h,a),{x:h[0],y:h[1],z:h[2]}}locationPoint(e,i){const s=va(i.lat,i.lng),h=Ie.vec3.normalize([],s),a=e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(i),e._centerAltitude):e._centerAltitude,u=fr(1,0)*ft*a;Ie.vec3.scaleAndAdd(s,s,h,u);const x=Ie.mat4.identity(new Float64Array(16));return Ie.mat4.multiply(x,e.pixelMatrix,e.globeMatrix),Ie.vec3.transformMat4(s,s,x),new pt(s[0],s[1])}pixelsPerMeter(e,i){return fr(1,0)*i}pixelSpaceConversion(e,i,s){const h=fr(1,e)*i,a=Ut(fr(1,45)*i,h,s);return this.pixelsPerMeter(e,i)/a}createTileMatrix(e,i,s){const h=Xi(An(s.canonical));return Ie.mat4.multiply(new Float64Array(16),e.globeMatrix,h)}createInversionMatrix(e,i){const{center:s}=e,h=kn(An(i));return Ie.mat4.rotateY(h,h,yi(s.lng)),Ie.mat4.rotateX(h,h,yi(s.lat)),Ie.mat4.scale(h,h,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(h)}pointCoordinate(e,i,s,h){return ki(e,i,s,!0)||new n(0,0)}pointCoordinate3D(e,i,s){const h=this.pointCoordinate(e,i,s,0);return[h.x,h.y,h.z]}isPointAboveHorizon(e,i){return!ki(e,i.x,i.y,!1)}farthestPixelDistance(e){const i=function(h,a){const u=h.cameraToCenterDistance,x=h._centerAltitude*a,T=h._camera,C=h._camera.forward(),g=Ie.vec3.add([],Ie.vec3.scale([],C,-u),[0,0,x]),S=h.worldSize/(2*Math.PI),A=[0,0,-S],w=h.width/h.height,M=Math.tan(h.fovAboveCenter),P=Ie.vec3.scale([],T.up(),M),O=Ie.vec3.scale([],T.right(),M*w),B=Ie.vec3.normalize([],Ie.vec3.add([],Ie.vec3.add([],C,P),O)),G=[];let q;if(new Zt(g,B).closestPointOnSphere(A,S,G)){const U=Ie.vec3.add([],G,A),W=Ie.vec3.sub([],U,g);q=Math.cos(h.fovAboveCenter)*Ie.vec3.length(W)}else{const U=Ie.vec3.sub([],g,A),W=Ie.vec3.sub([],A,g);Ie.vec3.normalize(W,W);const X=Ie.vec3.length(U)-S;q=Math.sqrt(X*(X+2*S));const ee=Math.acos(q/(S+X))-Math.acos(Ie.vec3.dot(C,W));q*=Math.cos(ee)}return 1.01*q}(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),s=Tr(e.zoom);if(s>0){const h=K_(e,fr(1,e.center.lat)*e.worldSize),a=e.worldSize/(2*Math.PI),u=Math.max(e.width,e.height)/e.worldSize*Math.PI;return Ut(i,h+a*(1-Math.cos(u)),Math.pow(s,10))}return i}upVector(e,i,s){return vi(i,s,e,1)}upVectorScale(e){return{metersToTile:pi(bi(An(e)))}}}function ng(r){const e=r.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(r.name){case"mercator":return new Q_(r);case"equirectangular":return new U0(r);case"naturalEarth":return new G0(r);case"equalEarth":return new V0(r);case"winkelTripel":return new q0(r);case"albers":return i?new ig(r):new N0(r);case"lambertConformalConic":return i?new ig(r):new j0(r);case"globe":return new H0(r)}throw new Error(`Invalid projection name: ${r.name}`)}const W0=fd.VectorTileFeature.types,$0=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Wp(r,e,i,s,h,a,u,x,T,C,g,S,A){const w=x?Math.min(ch,Math.round(x[0])):0,M=x?Math.min(ch,Math.round(x[1])):0;r.emplaceBack(e,i,Math.round(32*s),Math.round(32*h),a,u,(w<<1)+(T?1:0),M,16*C,16*g,256*S,256*A)}function $p(r,e,i){r.emplaceBack(e,i)}function Zp(r,e,i,s,h,a,u){r.emplaceBack(e,i,s,h,a,u)}function Xp(r,e,i,s,h){r.emplaceBack(e,i,s,h),r.emplaceBack(e,i,s,h),r.emplaceBack(e,i,s,h),r.emplaceBack(e,i,s,h)}function Z0(r){for(const e of r.sections)if(Qh(e.text))return!0;return!1}class jf{constructor(e){this.layoutVertexArray=new Xc,this.indexArray=new Ln,this.programConfigurations=e,this.segments=new vn,this.dynamicLayoutVertexArray=new Oo,this.opacityVertexArray=new su,this.placedSymbolArray=new Qc,this.iconTransitioningVertexArray=new so,this.globeExtVertexArray=new Yc,this.zOffsetVertexArray=new hl}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length&&0===this.iconTransitioningVertexArray.length}upload(e,i,s,h,a){this.isEmpty()||(s&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,u0.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,p0.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,$0,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,m0.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,d0.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||a)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,f0.members,!0)),this.opacityVertexBuffer.itemSize=1),(s||h)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy())}}St(jf,"SymbolBuffers");class Gf{constructor(e,i,s){this.layoutVertexArray=new e,this.layoutAttributes=i,this.indexArray=new s,this.segments=new vn,this.collisionVertexArray=new au,this.collisionVertexArrayExt=new Oo}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,_0.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,g0.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}St(Gf,"CollisionBuffers");class Yp{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.lut=e.lut,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(u=>u.fqid),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=Ie.mat4.identity([]),this.placementViewportMatrix=Ie.mat4.identity([]);const i=this.layers[0]._unevaluatedLayout._values;this.textSizeData=zf(this.zoom,i["text-size"]),this.iconSizeData=zf(this.zoom,i["icon-size"]);const s=this.layers[0].layout,h=s.get("symbol-sort-key"),a=s.get("symbol-z-order");this.canOverlap=s.get("text-allow-overlap")||s.get("icon-allow-overlap")||s.get("text-ignore-placement")||s.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==a&&void 0!==h.constantOr(1),this.sortFeaturesByY=("viewport-y"===a||"auto"===a&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=s.get("text-writing-mode").map(u=>lo[u]),this.stateDependentLayerIds=this.layers.filter(u=>u.isStateDependent()).map(u=>u.id),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=s.get("symbol-z-elevate"),this.activeReplacements=[],this.replacementUpdateTime=0}createArrays(){this.text=new jf(new Vs(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("text")||e.startsWith("symbol"))),this.icon=new jf(new Vs(this.layers,{zoom:this.zoom,lut:this.lut},e=>e.startsWith("icon")||e.startsWith("symbol"))),this.glyphOffsetArray=new od,this.lineVertexArray=new ad,this.symbolInstances=new sd}calculateGlyphDependencies(e,i,s,h,a){for(const u of e){const x=u.codePointAt(0);if(void 0===x)break;if(i[x]=!0,h&&a&&x<=65535){const T=ep[u];T&&(i[T.charCodeAt(0)]=!0)}}}updateFootprints(e,i){}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const s=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!Sf(this.activeReplacements,s)&&(this.activeReplacements=s,!0)}populate(e,i,s,h){const a=this.layers[0],u=a.layout,x="globe"===this.projection.name,T=u.get("text-font"),C=u.get("text-field"),g=u.get("icon-image"),[S,A]=u.get("icon-size-scale-range"),w=ai(i.scaleFactor||1,S,A),M=("constant"!==C.value.kind||C.value.value instanceof cr&&!C.value.value.isEmpty()||C.value.value.toString().length>0)&&("constant"!==T.value.kind||T.value.value.length>0),P="constant"!==g.value.kind||!!g.value.value||Object.keys(g.parameters).length>0,O=u.get("symbol-sort-key");if(this.features=[],!M&&!P)return;const B=i.iconDependencies,G=i.glyphDependencies,q=i.availableImages,U=new Zi(this.zoom);for(const{feature:W,id:X,index:ee,sourceLayerIndex:ae}of e){const oe=a._featureFilter.needGeometry,se=N(W,oe);if(!a._featureFilter.filter(U,se,s))continue;if(oe||(se.geometry=k(W,s,h)),x&&1!==W.type&&s.z<=5){const we=se.geometry,Ae=.98078528056,Pe=(ke,Ce)=>{const Ze=vi(ke.x,ke.y,s,1),tt=vi(Ce.x,Ce.y,s,1);return Ie.vec3.dot(Ze,tt)<Ae};for(let ke=0;ke<we.length;ke++)we[ke]=b(we[ke],Pe)}let ye,le;if(M){const we=a.getValueAndResolveTokens("text-field",se,s,q),Ae=cr.factory(we);Z0(Ae)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===Gc()||this.hasRTLText&&Zr.isParsed())&&(ye=v0(Ae,a,se))}if(P){const we=a.getValueAndResolveTokens("icon-image",se,s,q);le=we instanceof rr?we:rr.build(we)}if(!ye&&!le)continue;const ve=this.sortFeaturesByKey?O.evaluate(se,{},s):void 0,Se={id:X,text:ye,icon:le,index:ee,sourceLayerIndex:ae,geometry:se.geometry,properties:W.properties,type:W0[W.type],sortKey:ve};if(this.features.push(Se),le){const we=Df(this.iconSizeData,this.layers[0]._unevaluatedLayout._values["icon-size"],s,this.zoom,Se)*w*this.pixelRatio,Ae=le.getPrimary().scaleSelf(we);if(B[Ae.id]=B[Ae.id]||[],B[Ae.id].push(Ae),le.nameSecondary){const Pe=le.getSecondary().scaleSelf(we);B[Pe.id]=B[Pe.id]||[],B[Pe.id].push(Pe)}}if(ye){const we=T.evaluate(se,{},s).join(","),Ae="map"===u.get("text-rotation-alignment")&&"point"!==u.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(lo.vertical)>=0;for(const Pe of ye.sections)if(Pe.image){const ke=Pe.image.getPrimary().scaleSelf(this.pixelRatio);B[ke.id]=B[ke.id]||[],B[ke.id].push(ke)}else{const ke=Kh(ye.toString()),Ce=Pe.fontStack||we,Ze=G[Ce]=G[Ce]||{};this.calculateGlyphDependencies(Pe.text,Ze,Ae,this.allowVerticalPlacement,ke)}}}"line"===u.get("symbol-placement")&&(this.features=function(W){const X={},ee={},ae=[];let oe=0;function se(Se){ae.push(W[Se]),oe++}function ye(Se,we,Ae){const Pe=ee[Se];return delete ee[Se],ee[we]=Pe,ae[Pe].geometry[0].pop(),ae[Pe].geometry[0]=ae[Pe].geometry[0].concat(Ae[0]),Pe}function le(Se,we,Ae){const Pe=X[we];return delete X[we],X[Se]=Pe,ae[Pe].geometry[0].shift(),ae[Pe].geometry[0]=Ae[0].concat(ae[Pe].geometry[0]),Pe}function ve(Se,we,Ae){const Pe=Ae?we[0][we[0].length-1]:we[0][0];return`${Se}:${Pe.x}:${Pe.y}`}for(let Se=0;Se<W.length;Se++){const we=W[Se],Ae=we.geometry,Pe=we.text?we.text.toString():null;if(!Pe){se(Se);continue}const ke=ve(Pe,Ae),Ce=ve(Pe,Ae,!0);if(ke in ee&&Ce in X&&ee[ke]!==X[Ce]){const Ze=le(ke,Ce,Ae),tt=ye(ke,Ce,ae[Ze].geometry);delete X[ke],delete ee[Ce],ee[ve(Pe,ae[tt].geometry,!0)]=tt,ae[Ze].geometry=null}else ke in ee?ye(ke,Ce,Ae):Ce in X?le(ke,Ce,Ae):(se(Se),X[ke]=oe-1,ee[Ce]=oe-1)}return ae.filter(Se=>Se.geometry)}(this.features)),this.sortFeaturesByKey&&this.features.sort((W,X)=>W.sortKey-X.sortKey)}update(e,i,s,h,a,u,x){this.text.programConfigurations.updatePaintArrays(e,i,a,s,h,u,x),this.icon.programConfigurations.updatePaintArrays(e,i,a,s,h,u,x)}updateZOffset(){const e=(a,u,x)=>{s+=u,s>a.length&&a.resize(s);for(let T=-u;T<0;T++)a.emplace(T+s,x)},i=(a,u,x)=>{h+=u,h>a.length&&a.resize(h);for(let T=-u;T<0;T++)a.emplace(T+h,x)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let s=0,h=0;for(let a=0;a<this.symbolInstances.length;a++){const u=this.symbolInstances.get(a),{numHorizontalGlyphVertices:x,numVerticalGlyphVertices:T,numIconVertices:C}=u,g=u.zOffset,S=C>0;if((x>0||T>0)&&(e(this.text.zOffsetVertexArray,x,g),e(this.text.zOffsetVertexArray,T,g)),S){const{placedIconSymbolIndex:A,verticalPlacedIconSymbolIndex:w}=u;A>=0&&i(this.icon.zOffsetVertexArray,C,g),w>=0&&i(this.icon.zOffsetVertexArray,u.numVerticalIconVertices,g)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=ng(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,i){const s=this.lineVertexArray.length;if(void 0!==e.segment)for(const{x:h,y:a}of i)this.lineVertexArray.emplaceBack(h,a);return{lineStartIndex:s,lineLength:this.lineVertexArray.length-s}}addSymbols(e,i,s,h,a,u,x,T,C,g,S,A,w,M,P,O){const B=e.indexArray,G=e.layoutVertexArray,q=e.globeExtVertexArray,U=e.segments.prepareSegment(4*i.length,G,B,this.canOverlap?u.sortKey:void 0),W=this.glyphOffsetArray.length,X=U.vertexLength,ee=this.allowVerticalPlacement&&x===lo.vertical?Math.PI/2:0,ae=u.text&&u.text.sections;for(let se=0;se<i.length;se++){const{tl:ye,tr:le,bl:ve,br:Se,texPrimary:we,texSecondary:Ae,pixelOffsetTL:Pe,pixelOffsetBR:ke,minFontScaleX:Ce,minFontScaleY:Ze,glyphOffset:tt,isSDF:$e,sectionIndex:gt}=i[se],mt=U.vertexLength,st=tt[1];if(Wp(G,C.x,C.y,ye.x,st+ye.y,we.x,we.y,s,$e,Pe.x,Pe.y,Ce,Ze),Wp(G,C.x,C.y,le.x,st+le.y,we.x+we.w,we.y,s,$e,ke.x,Pe.y,Ce,Ze),Wp(G,C.x,C.y,ve.x,st+ve.y,we.x,we.y+we.h,s,$e,Pe.x,ke.y,Ce,Ze),Wp(G,C.x,C.y,Se.x,st+Se.y,we.x+we.w,we.y+we.h,s,$e,ke.x,ke.y,Ce,Ze),T){const{x:nt,y:It,z:yt}=T.anchor,[wt,$t,ni]=T.up;Zp(q,nt,It,yt,wt,$t,ni),Zp(q,nt,It,yt,wt,$t,ni),Zp(q,nt,It,yt,wt,$t,ni),Zp(q,nt,It,yt,wt,$t,ni),Xp(e.dynamicLayoutVertexArray,nt,It,yt,ee)}else Xp(e.dynamicLayoutVertexArray,C.x,C.y,C.z,ee);if(O){const nt=Ae||we;$p(e.iconTransitioningVertexArray,nt.x,nt.y),$p(e.iconTransitioningVertexArray,nt.x+nt.w,nt.y),$p(e.iconTransitioningVertexArray,nt.x,nt.y+nt.h),$p(e.iconTransitioningVertexArray,nt.x+nt.w,nt.y+nt.h)}B.emplaceBack(mt,mt+1,mt+2),B.emplaceBack(mt+1,mt+2,mt+3),U.vertexLength+=4,U.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(tt[0]),se!==i.length-1&&gt===i[se+1].sectionIndex||e.programConfigurations.populatePaintArrays(G.length,u,u.index,{},w,M,P,ae&&ae[gt])}const oe=T?T.anchor:C;e.placedSymbolArray.emplaceBack(oe.x,oe.y,oe.z,C.x,C.y,W,this.glyphOffsetArray.length-W,X,g,S,C.segment,s?s[0]:0,s?s[1]:0,h[0],h[1],x,0,!1,0,A,0)}_commitLayoutVertex(e,i,s,h,a,u,x){e.emplaceBack(i,s,h,a,u,Math.round(x.x),Math.round(x.y))}_addCollisionDebugVertices(e,i,s,h,a,u,x){const T=s.segments.prepareSegment(4,s.layoutVertexArray,s.indexArray),C=T.vertexLength,g=x.tileAnchorX,S=x.tileAnchorY;for(let w=0;w<4;w++)s.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(s.collisionVertexArrayExt,i,e.padding,x.zOffset),this._commitLayoutVertex(s.layoutVertexArray,h,a,u,g,S,new pt(e.x1,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,h,a,u,g,S,new pt(e.x2,e.y1)),this._commitLayoutVertex(s.layoutVertexArray,h,a,u,g,S,new pt(e.x2,e.y2)),this._commitLayoutVertex(s.layoutVertexArray,h,a,u,g,S,new pt(e.x1,e.y2)),T.vertexLength+=4;const A=s.indexArray;A.emplaceBack(C,C+1),A.emplaceBack(C+1,C+2),A.emplaceBack(C+2,C+3),A.emplaceBack(C+3,C),T.primitiveLength+=4}_addTextDebugCollisionBoxes(e,i,s,h,a,u){for(let x=h;x<a;x++){const T=s.get(x),C=this.getSymbolInstanceTextSize(e,u,i,x);this._addCollisionDebugVertices(T,C,this.textCollisionBox,T.projectedAnchorX,T.projectedAnchorY,T.projectedAnchorZ,u)}}_addIconDebugCollisionBoxes(e,i,s,h,a,u){for(let x=h;x<a;x++){const T=s.get(x),C=this.getSymbolInstanceIconSize(e,i,u.placedIconSymbolIndex);this._addCollisionDebugVertices(T,C,this.iconCollisionBox,T.projectedAnchorX,T.projectedAnchorY,T.projectedAnchorZ,u)}}generateCollisionDebugBuffers(e,i,s){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Gf(nc,S_.members,so),this.iconCollisionBox=new Gf(nc,S_.members,so);const h=md(this.iconSizeData,e),a=md(this.textSizeData,e,s);for(let u=0;u<this.symbolInstances.length;u++){const x=this.symbolInstances.get(u);this._addTextDebugCollisionBoxes(a,e,i,x.textBoxStartIndex,x.textBoxEndIndex,x),this._addTextDebugCollisionBoxes(a,e,i,x.verticalTextBoxStartIndex,x.verticalTextBoxEndIndex,x),this._addIconDebugCollisionBoxes(h,e,i,x.iconBoxStartIndex,x.iconBoxEndIndex,x),this._addIconDebugCollisionBoxes(h,e,i,x.verticalIconBoxStartIndex,x.verticalIconBoxEndIndex,x)}}getSymbolInstanceTextSize(e,i,s,h){const a=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:h),u=Fp(this.textSizeData,e,a)/24;return this.tilePixelRatio*u}getSymbolInstanceIconSize(e,i,s){const h=this.icon.placedSymbolArray.get(s),a=Fp(this.iconSizeData,e,h);return this.tilePixelRatio*a}_commitDebugCollisionVertexUpdate(e,i,s,h){e.emplaceBack(i,-s,-s,h),e.emplaceBack(i,s,-s,h),e.emplaceBack(i,s,s,h),e.emplaceBack(i,-s,s,h)}_updateTextDebugCollisionBoxes(e,i,s,h,a,u,x){for(let T=h;T<a;T++){const C=s.get(T),g=this.getSymbolInstanceTextSize(e,u,i,T);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,g,C.padding,u.zOffset)}}_updateIconDebugCollisionBoxes(e,i,s,h,a,u,x){for(let T=h;T<a;T++){const C=s.get(T),g=this.getSymbolInstanceIconSize(e,i,u.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,g,C.padding,u.zOffset)}}updateCollisionDebugBuffers(e,i,s,h){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const a=md(this.iconSizeData,e,h),u=md(this.textSizeData,e,s);for(let x=0;x<this.symbolInstances.length;x++){const T=this.symbolInstances.get(x);this._updateTextDebugCollisionBoxes(u,e,i,T.textBoxStartIndex,T.textBoxEndIndex,T,s),this._updateTextDebugCollisionBoxes(u,e,i,T.verticalTextBoxStartIndex,T.verticalTextBoxEndIndex,T,s),this._updateIconDebugCollisionBoxes(a,e,i,T.iconBoxStartIndex,T.iconBoxEndIndex,T,h),this._updateIconDebugCollisionBoxes(a,e,i,T.verticalIconBoxStartIndex,T.verticalIconBoxEndIndex,T,h)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,i,s,h,a,u,x,T,C){const g={};if(i<s){const{x1:S,y1:A,x2:w,y2:M,padding:P,projectedAnchorX:O,projectedAnchorY:B,projectedAnchorZ:G,tileAnchorX:q,tileAnchorY:U,featureIndex:W}=e.get(i);g.textBox={x1:S,y1:A,x2:w,y2:M,padding:P,projectedAnchorX:O,projectedAnchorY:B,projectedAnchorZ:G,tileAnchorX:q,tileAnchorY:U},g.textFeatureIndex=W}if(h<a){const{x1:S,y1:A,x2:w,y2:M,padding:P,projectedAnchorX:O,projectedAnchorY:B,projectedAnchorZ:G,tileAnchorX:q,tileAnchorY:U,featureIndex:W}=e.get(h);g.verticalTextBox={x1:S,y1:A,x2:w,y2:M,padding:P,projectedAnchorX:O,projectedAnchorY:B,projectedAnchorZ:G,tileAnchorX:q,tileAnchorY:U},g.verticalTextFeatureIndex=W}if(u<x){const{x1:S,y1:A,x2:w,y2:M,padding:P,projectedAnchorX:O,projectedAnchorY:B,projectedAnchorZ:G,tileAnchorX:q,tileAnchorY:U,featureIndex:W}=e.get(u);g.iconBox={x1:S,y1:A,x2:w,y2:M,padding:P,projectedAnchorX:O,projectedAnchorY:B,projectedAnchorZ:G,tileAnchorX:q,tileAnchorY:U},g.iconFeatureIndex=W}if(T<C){const{x1:S,y1:A,x2:w,y2:M,padding:P,projectedAnchorX:O,projectedAnchorY:B,projectedAnchorZ:G,tileAnchorX:q,tileAnchorY:U,featureIndex:W}=e.get(T);g.verticalIconBox={x1:S,y1:A,x2:w,y2:M,padding:P,projectedAnchorX:O,projectedAnchorY:B,projectedAnchorZ:G,tileAnchorX:q,tileAnchorY:U},g.verticalIconFeatureIndex=W}return g}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const s=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,s.textBoxStartIndex,s.textBoxEndIndex,s.verticalTextBoxStartIndex,s.verticalTextBoxEndIndex,s.iconBoxStartIndex,s.iconBoxEndIndex,s.verticalIconBoxStartIndex,s.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,i){const s=e.placedSymbolArray.get(i),h=s.vertexStartIndex+4*s.numGlyphs;for(let a=s.vertexStartIndex;a<h;a+=4)e.indexArray.emplaceBack(a,a+1,a+2),e.indexArray.emplaceBack(a+1,a+2,a+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const i=Math.sin(e),s=Math.cos(e),h=[],a=[],u=[];for(let x=0;x<this.symbolInstances.length;++x){u.push(x);const T=this.symbolInstances.get(x);h.push(0|Math.round(i*T.tileAnchorX+s*T.tileAnchorY)),a.push(T.featureIndex)}return u.sort((x,T)=>h[x]-h[T]||a[T]-a[x]),u}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort((e,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(e).zOffset)}addToSortKeyRanges(e,i){const s=this.sortKeyRanges[this.sortKeyRanges.length-1];s&&s.sortKey===i?s.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const s=this.symbolInstances.get(i);this.featureSortOrder.push(s.featureIndex);const{rightJustifiedTextSymbolIndex:h,centerJustifiedTextSymbolIndex:a,leftJustifiedTextSymbolIndex:u,verticalPlacedTextSymbolIndex:x,placedIconSymbolIndex:T,verticalPlacedIconSymbolIndex:C}=s;h>=0&&this.addIndicesForPlacedSymbol(this.text,h),a>=0&&a!==h&&this.addIndicesForPlacedSymbol(this.text,a),u>=0&&u!==a&&u!==h&&this.addIndicesForPlacedSymbol(this.text,u),x>=0&&this.addIndicesForPlacedSymbol(this.text,x),T>=0&&this.addIndicesForPlacedSymbol(this.icon,T),C>=0&&this.addIndicesForPlacedSymbol(this.icon,C)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let rg,sg,qf;St(Yp,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),Yp.addDynamicAttributes=Xp;class og{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:Cs,this.defaultValue=e}evaluate(e){if(e.formattedSection){const i=this.defaultValue.property.overrides;if(i&&i.hasOverride(e.formattedSection))return i.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}St(og,"FormatSectionOverride",{omit:["defaultValue"]});const Hf=()=>qf||(qf={layout:rg||(rg=new cn({"symbol-placement":new at(Ne.layout_symbol["symbol-placement"]),"symbol-spacing":new at(Ne.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new at(Ne.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new bt(Ne.layout_symbol["symbol-sort-key"]),"symbol-z-order":new at(Ne.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new at(Ne.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new at(Ne.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new at(Ne.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new at(Ne.layout_symbol["icon-ignore-placement"]),"icon-optional":new at(Ne.layout_symbol["icon-optional"]),"icon-rotation-alignment":new at(Ne.layout_symbol["icon-rotation-alignment"]),"icon-size":new bt(Ne.layout_symbol["icon-size"]),"icon-size-scale-range":new at(Ne.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new bt(Ne.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new bt(Ne.layout_symbol["icon-text-fit-padding"]),"icon-image":new bt(Ne.layout_symbol["icon-image"]),"icon-rotate":new bt(Ne.layout_symbol["icon-rotate"]),"icon-padding":new at(Ne.layout_symbol["icon-padding"]),"icon-keep-upright":new at(Ne.layout_symbol["icon-keep-upright"]),"icon-offset":new bt(Ne.layout_symbol["icon-offset"]),"icon-anchor":new bt(Ne.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new at(Ne.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new at(Ne.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new at(Ne.layout_symbol["text-rotation-alignment"]),"text-field":new bt(Ne.layout_symbol["text-field"]),"text-font":new bt(Ne.layout_symbol["text-font"]),"text-size":new bt(Ne.layout_symbol["text-size"]),"text-size-scale-range":new at(Ne.layout_symbol["text-size-scale-range"]),"text-max-width":new bt(Ne.layout_symbol["text-max-width"]),"text-line-height":new bt(Ne.layout_symbol["text-line-height"]),"text-letter-spacing":new bt(Ne.layout_symbol["text-letter-spacing"]),"text-justify":new bt(Ne.layout_symbol["text-justify"]),"text-radial-offset":new bt(Ne.layout_symbol["text-radial-offset"]),"text-variable-anchor":new at(Ne.layout_symbol["text-variable-anchor"]),"text-anchor":new bt(Ne.layout_symbol["text-anchor"]),"text-max-angle":new at(Ne.layout_symbol["text-max-angle"]),"text-writing-mode":new at(Ne.layout_symbol["text-writing-mode"]),"text-rotate":new bt(Ne.layout_symbol["text-rotate"]),"text-padding":new at(Ne.layout_symbol["text-padding"]),"text-keep-upright":new at(Ne.layout_symbol["text-keep-upright"]),"text-transform":new bt(Ne.layout_symbol["text-transform"]),"text-offset":new bt(Ne.layout_symbol["text-offset"]),"text-allow-overlap":new at(Ne.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new at(Ne.layout_symbol["text-ignore-placement"]),"text-optional":new at(Ne.layout_symbol["text-optional"]),visibility:new at(Ne.layout_symbol.visibility)})),paint:sg||(sg=new cn({"icon-opacity":new bt(Ne.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new bt(Ne.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new bt(Ne.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new bt(Ne.paint_symbol["text-emissive-strength"]),"icon-color":new bt(Ne.paint_symbol["icon-color"]),"icon-halo-color":new bt(Ne.paint_symbol["icon-halo-color"]),"icon-halo-width":new bt(Ne.paint_symbol["icon-halo-width"]),"icon-halo-blur":new bt(Ne.paint_symbol["icon-halo-blur"]),"icon-translate":new at(Ne.paint_symbol["icon-translate"]),"icon-translate-anchor":new at(Ne.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new bt(Ne.paint_symbol["icon-image-cross-fade"]),"text-opacity":new bt(Ne.paint_symbol["text-opacity"]),"text-occlusion-opacity":new bt(Ne.paint_symbol["text-occlusion-opacity"]),"text-color":new bt(Ne.paint_symbol["text-color"],{runtimeType:Vn,getOverride:r=>r.textColor,hasOverride:r=>!!r.textColor}),"text-halo-color":new bt(Ne.paint_symbol["text-halo-color"]),"text-halo-width":new bt(Ne.paint_symbol["text-halo-width"]),"text-halo-blur":new bt(Ne.paint_symbol["text-halo-blur"]),"text-translate":new at(Ne.paint_symbol["text-translate"]),"text-translate-anchor":new at(Ne.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new at(Ne.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new at(Ne.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new at(Ne.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new at(Ne.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new bt(Ne.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"})}))},qf);class Kp extends Wn{constructor(e,i,s,h){super(e,Hf(),i,s,h),this._colorAdjustmentMatrix=Ie.mat4.identity([]),this.hasInitialOcclusionOpacityProperties=void 0!==e.paint&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}recalculate(e,i){super.recalculate(e,i),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const s=this.layout.get("text-writing-mode");if(s){const h=[];for(const a of s)h.indexOf(a)<0&&h.push(a);this.layout._values["text-writing-mode"]=h}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,i,s,h){return this._saturation===e&&this._contrast===i&&this._brightnessMin===s&&this._brightnessMax===h||(this._colorAdjustmentMatrix=function(a,u,x,T){a=fs(a),u=yo(u);const C=Ie.mat4.create(),g=a/3,S=1-2*g,A=[S,g,g,0,g,S,g,0,g,g,S,0,0,0,0,1],w=.5-.5*u,M=T-x;return Ie.mat4.multiply(C,[M,0,0,0,0,M,0,0,0,0,M,0,x,x,x,1],[u,0,0,0,0,u,0,0,0,0,u,0,w,w,w,1]),Ie.mat4.multiply(C,C,A),C}(e,i,s,h),this._saturation=e,this._contrast=i,this._brightnessMin=s,this._brightnessMax=h),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,i,s,h){const a=this.layout.get(e).evaluate(i,{},s,h),u=this._unevaluatedLayout._values[e];return u.isDataDriven()||ha(u.value)||!a?a:(x=i.properties,a.replace(/{([^{}]+)}/g,(C,g)=>g in x?String(x[g]):""));var x}createBucket(e){return new Yp(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of Hf().paint.overridableProperties){if(!Kp.hasPaintOverride(this.layout,e))continue;const i=this.paint.get(e),s=new og(i),h=new Lc(s,i.property.specification,this.scope,this.options);let a=null;a="constant"===i.value.kind||"source"===i.value.kind?new kc("source",h):new Zl("composite",h,i.value.zoomStops,i.value._interpolationType),this.paint._values[e]=new sl(i.property,a,i.parameters)}}_handleOverridablePaintPropertyUpdate(e,i,s){return!(!this.layout||i.isDataDriven()||s.isDataDriven())&&Kp.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,i){const s=e.get("text-field"),h=Hf().paint.properties[i];let a=!1;const u=x=>{for(const T of x)if(h.overrides&&h.overrides.hasOverride(T))return void(a=!0)};if("constant"===s.value.kind&&s.value.value instanceof cr)u(s.value.value.sections);else if("source"===s.value.kind){const x=C=>{a||(C instanceof Jn&&en(C.value)===Ps?u(C.value.sections):C instanceof Ks?u(C.sections):C.eachChild(x))},T=s.value;T._styleExpression&&x(T._styleExpression.expression)}return a}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,i,s){return{config:new xa(this,{zoom:i,lut:s}),overrideFog:!1}}}let ag,lg,cg,hg;var Wf=Li([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function $f(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function Zf(r){switch(r){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class Xf{constructor(e,i,s,h){this.context=e,this.format=s,this.useMipmap=h&&h.useMipmap,this.texture=e.gl.createTexture(),this.update(i,{premultiply:h&&h.premultiply})}update(e,i){const s=e&&e instanceof HTMLVideoElement&&0===e.width?e.videoWidth:e.width,h=e&&e instanceof HTMLVideoElement&&0===e.height?e.videoHeight:e.height,{context:a}=this,{gl:u}=a,{x,y:T}=i&&i.position?i.position:{x:0,y:0},C=x+s,g=T+h;!this.size||this.size[0]===C&&this.size[1]===g||(u.bindTexture(u.TEXTURE_2D,null),u.deleteTexture(this.texture),this.texture=u.createTexture(),this.size=null),u.bindTexture(u.TEXTURE_2D,this.texture),a.pixelStoreUnpackFlipY.set(!1),a.pixelStoreUnpack.set(1),a.pixelStoreUnpackPremultiplyAlpha.set(this.format===u.RGBA8&&(!i||!1!==i.premultiply));const S=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&C>0&&g>0){const A=this.useMipmap?Math.floor(Math.log2(Math.max(C,g)))+1:1;u.texStorage2D(u.TEXTURE_2D,A,this.format,C,g),this.size=[C,g]}if(this.size)if(S)u.texSubImage2D(u.TEXTURE_2D,0,x,T,$f(this.format),Zf(this.format),e);else{const A=e.data;A&&u.texSubImage2D(u.TEXTURE_2D,0,x,T,s,h,$f(this.format),Zf(this.format),A)}this.useMipmap&&u.generateMipmap(u.TEXTURE_2D)}bind(e,i,s=!1){const{context:h}=this,{gl:a}=h;a.bindTexture(a.TEXTURE_2D,this.texture),e!==this.minFilter&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,this.useMipmap&&!s?e===a.NEAREST?a.NEAREST_MIPMAP_NEAREST:a.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,i),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(e,i,s,h){const{context:a}=this,{gl:u}=a;u.bindTexture(u.TEXTURE_2D,this.texture),i!==this.magFilter&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,i),this.magFilter=i),e!==this.minFilter&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,this.useMipmap?e===u.NEAREST?u.NEAREST_MIPMAP_NEAREST:u.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),s!==this.wrapS&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,s),this.wrapS=s),h!==this.wrapT&&(u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,h),this.wrapT=h)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Jp{constructor(e,i){this.context=e,this.texture=i}bind(e,i){const{context:s}=this,{gl:h}=s;h.bindTexture(h.TEXTURE_2D,this.texture),e!==this.minFilter&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,e),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,e),this.minFilter=e),i!==this.wrapS&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,i),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,i),this.wrapS=i)}}function Qp(r,e,i,s,h,a,u,x){const T=[r,e,1,i,s,1,h,a,1],C=[u,x,1],g=Ie.mat3.adjoint([],T),[S,A,w]=Ie.vec3.transformMat3(C,C,g);return Ie.mat3.multiply(T,T,[S,0,0,0,A,0,0,0,w])}function ug(r,e,i,s,h,a,u,x){const T=function(C,g,S,A,w,M,P,O){const B=Qp(0,0,1,0,1,1,0,1),G=Qp(C,g,S,A,w,M,P,O),q=Ie.mat3.adjoint([],B);return Ie.mat3.multiply(G,G,q)}(r,e,i,s,h,a,u,x);return[T[2]/T[8]/ft,T[5]/T[8]/ft]}function ef(r){return[r[0],Math.min(Math.max(r[1],-_n),_n)]}class dg extends Is{constructor(e,i,s,h){super(),this.id=e,this.dispatcher=s,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(h),this.options=i,this._dirty=!1}load(e,i){if(this._loaded=i||!1,this.fire(new Hr("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=Lu(this.map._requestManager.transformRequest(this.url,ui.Image),(s,h)=>{this._imageRequest=null,this._loaded=!0,s?this.fire(new El(s)):h&&(this.image=h instanceof HTMLImageElement?fe.getImageData(h):h,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())})}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Jp(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Hr("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Jp||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=e[0][1],s=e[0][1];for(const a of e)a[1]>s&&(s=a[1]),a[1]<i&&(i=a[1]);const h=(s+i)/2;if(h>_n?this.onNorthPole=!0:h<-_n&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const a=e.map(n.fromLngLat);this.tileID=function(u){let x=1/0,T=1/0,C=-1/0,g=-1/0;for(const P of u)x=Math.min(x,P.x),T=Math.min(T,P.y),C=Math.max(C,P.x),g=Math.max(g,P.y);const S=Math.max(C-x,g-T),A=Math.max(0,Math.floor(-Math.log(S)/Math.LN2)),w=Math.pow(2,A);let M=Math.floor((x+C)/2*w);return M>1&&(M-=1),new et(A,M,Math.floor((T+g)/2*w))}(a),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new Hr("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const B in this.tiles){const G=this.tiles[B];"loaded"!==G.state&&(G.state="loaded",G.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const i=op(new et(0,0,0),this.map.transform.projection),s=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!function(B){const G=B[1].x-B[0].x,q=B[1].y-B[0].y,U=B[2].x-B[1].x,W=B[2].y-B[1].y,X=B[3].x-B[2].x,ee=B[3].y-B[2].y,ae=B[0].x-B[3].x,oe=B[0].y-B[3].y,se=G*W-U*q,ye=U*ee-X*W,le=X*oe-ae*ee,ve=ae*q-G*oe;return se>0&&ye>0&&le>0&&ve>0||se<0&&ye<0&&le<0&&ve<0}(s))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const h=op(this.tileID,this.map.transform.projection),[a,u,x,T]=this.coordinates.map(B=>{const G=h.projection.project(B[0],B[1]);return J_(h,G)._round()});this.perspectiveTransform=ug(a.x,a.y,u.x,u.y,x.x,x.y,T.x,T.y);const C=this._boundsArray=new Xr;C.emplaceBack(a.x,a.y,0,0),C.emplaceBack(u.x,u.y,ft,0),C.emplaceBack(T.x,T.y,0,ft),C.emplaceBack(x.x,x.y,ft,ft),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(C,Wf.members),this.boundsSegments=vn.simpleSegment(0,0,4,2);const g=[],S=[ef((A=this.coordinates)[0]),ef(A[1]),ef(A[2]),ef(A[3])];var A;const[w,M,P,O]=function(B){let G=B[0][0],q=G,U=B[0][1],W=U;for(let X=1;X<B.length;X++)B[X][0]<G?G=B[X][0]:B[X][0]>q&&(q=B[X][0]),B[X][1]<U?U=B[X][1]:B[X][1]>W&&(W=B[X][1]);return[G,U,q-G,W-U]}(S);{const B=new Xr,[G,q,U,W]=function(Pe){let ke=Pe[0].x,Ce=ke,Ze=Pe[0].y,tt=Ze;for(let $e=1;$e<Pe.length;$e++)Pe[$e].x<ke?ke=Pe[$e].x:Pe[$e].x>Ce&&(Ce=Pe[$e].x),Pe[$e].y<Ze?Ze=Pe[$e].y:Pe[$e].y>tt&&(tt=Pe[$e].y);return[ke,Ze,Ce-ke,tt-Ze]}(s),X=Pe=>[(Pe.x-G)/U,(Pe.y-q)/W],[ee,ae,oe,se]=s.map(X),ye=function(Pe,ke,Ce,Ze,tt,$e,gt,mt){const st=Qp(0,0,1,0,1,1,0,1),nt=Qp(Pe,ke,Ce,Ze,tt,$e,gt,mt),It=Ie.mat3.adjoint([],nt);return Ie.mat3.multiply(st,st,It)}(ee[0],ee[1],ae[0],ae[1],oe[0],oe[1],se[0],se[1]);this.elevatedGlobePerspectiveTransform=ug(ee[0],ee[1],ae[0],ae[1],oe[0],oe[1],se[0],se[1]);const le=(Pe,ke)=>{g.push(Pe.lng);const Ce=Math.round((Pe.lng-w)/P*ft),Ze=Math.round((Pe.lat-M)/O*ft),tt=X(ke),$e=Ie.vec3.transformMat3([],[tt[0],tt[1],1],ye),gt=Math.round($e[0]/$e[2]*ft),mt=Math.round($e[1]/$e[2]*ft);B.emplaceBack(Ce,Ze,gt,mt)},ve=s[3].x-s[0].x,Se=s[3].y-s[0].y,we=s[2].x-s[1].x,Ae=s[2].y-s[1].y;for(let Pe=0;Pe<65;Pe++){const ke=Pe/64,Ce=[s[0].x+ke*ve,s[0].y+ke*Se],Ze=[s[1].x+ke*we,s[1].y+ke*Ae],tt=Ze[0]-Ce[0],$e=Ze[1]-Ce[1];for(let gt=0;gt<65;gt++){const mt=gt/64,st={x:Ce[0]+tt*mt,y:Ce[1]+$e*mt,z:0};le(i.projection.unproject(st.x,st.y),st)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(B,Wf.members)}{this.maxLongitudeTriangleSize=0;let B=[],G=new Ln;const q=(U,W,X)=>{G.emplaceBack(U,W,X);const ee=g[U],ae=g[W],oe=g[X],se=Math.min(Math.min(ee,ae),oe),ye=Math.max(Math.max(ee,ae),oe)-se;ye>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=ye),B.push(se+ye/2)};for(let U=0;U<64;U++)for(let W=0;W<64;W++){const X=65*U+W,ee=X+1,ae=X+65,oe=ae+1;q(X,ae,ee),q(ee,ae,oe)}[B,G]=function(U,W){const X=Array.from({length:U.length},(oe,se)=>se);X.sort((oe,se)=>U[oe]-U[se]);const ee=[],ae=new Ln;for(let oe=0;oe<X.length;oe++){const se=X[oe];ee.push(U[se]);const ye=3*se,le=ye+1;ae.emplaceBack(W.uint16[ye],W.uint16[le],W.uint16[le+1])}return[ee,ae]}(B,G),this.elevatedGlobeTrianglesCenterLongitudes=B,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(G)}this.elevatedGlobeSegments=vn.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,P/ft,0,O/ft,0,0,M,w,0])}prepare(){const e=0!==Object.keys(this.tiles).length;if(this.tileID&&!e)return;const i=this.map.painter.context,s=i.gl;!this._dirty||this.texture instanceof Jp||(this.texture?this.texture.update(this.image):(this.texture=new Xf(i,this.image,s.RGBA8),this.texture.bind(s.LINEAR,s.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(i)}loadTile(e,i){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},i(null)):(e.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;const s=this.elevatedGlobeTrianglesCenterLongitudes;let h=(a=e+180)+360*Math.round((s[0]-a)/360);var a;const u=new vn,x=(S,A)=>{u.segments.push({vertexOffset:0,primitiveOffset:S,vertexLength:i.segments[0].vertexLength,primitiveLength:A,sortKey:void 0,vaos:{}})},T=.51*this.maxLongitudeTriangleSize;if(Math.abs(s[0]-h)<=T){const S=go(s,0,s.length,h+T);return S===s.length||x(S,ps(s,S+1,s.length,h+360-T)-S),u}h<s[0]&&(h+=360);const C=ps(s,0,s.length,h-T);if(C===s.length)return x(0,s.length),u;x(0,C-0);const g=go(s,C+1,s.length,h+T);return g!==s.length&&x(g,s.length-g),u}}const X0=(Math.pow(256,2)-1)/16907520;class pg extends Wn{constructor(e,i,s,h){super(e,{layout:cg||(cg=new cn({visibility:new at(Ne.layout_raster.visibility)})),paint:hg||(hg=new cn({"raster-opacity":new at(Ne.paint_raster["raster-opacity"]),"raster-color":new ol(Ne.paint_raster["raster-color"]),"raster-color-mix":new at(Ne.paint_raster["raster-color-mix"]),"raster-color-range":new at(Ne.paint_raster["raster-color-range"]),"raster-hue-rotate":new at(Ne.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new at(Ne.paint_raster["raster-brightness-min"]),"raster-brightness-max":new at(Ne.paint_raster["raster-brightness-max"]),"raster-saturation":new at(Ne.paint_raster["raster-saturation"]),"raster-contrast":new at(Ne.paint_raster["raster-contrast"]),"raster-resampling":new at(Ne.paint_raster["raster-resampling"]),"raster-fade-duration":new at(Ne.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new at(Ne.paint_raster["raster-emissive-strength"]),"raster-array-band":new at(Ne.paint_raster["raster-array-band"]),"raster-elevation":new at(Ne.paint_raster["raster-elevation"]),"raster-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"})}))},i,s,h),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof dg&&(e._source.onNorthPole||e._source.onSouthPole))&&0===this.paint.get("raster-elevation")}_handleSpecialPaintPropertyUpdate(e){"raster-color"!==e&&"raster-color-range"!==e||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const i=this._transitionablePaint._values["raster-color"].value.expression,[s,h]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(s)&&isNaN(h)||s===this._curRampRange[0]&&h===this._curRampRange[1]||(this.colorRamp=R({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:s,end:h}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[s,h])}}let fg,mg,_g,gg,yg;class xg extends Wn{constructor(e,i,s,h){super(e,{layout:fg||(fg=new cn({visibility:new at(Ne["layout_raster-particle"].visibility)})),paint:mg||(mg=new cn({"raster-particle-array-band":new at(Ne["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new at(Ne["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new ol(Ne["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new at(Ne["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new at(Ne["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new at(Ne["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new at(Ne["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new at(Ne["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"})}))},i,s,h),this._updateColorRamp(),this.lastInvalidatedAt=fe.now()}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return"none"!==this.visibility}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){"raster-particle-color"!==e&&"raster-particle-max-speed"!==e||(this._updateColorRamp(),this._invalidateAnimationState()),"raster-particle-count"===e&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=R({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=fe.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class Y0 extends Wn{constructor(e,i){super(e,{},i,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}isDraped(e){return void 0!==this.implementation.renderToTile}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function Yf(r,e,i){const s=[0,0,1],h=Ie.quat.identity([]);return Ie.quat.rotateY(h,h,i?-yi(r)+Math.PI:yi(r)),Ie.quat.rotateX(h,h,-yi(e)),Ie.vec3.transformQuat(s,s,h),Ie.vec3.normalize(s,s)}function vg(r,e){const i=tf(r.projection,r.zoom,r.width,r.height),s=function(a,u,x,T,C){const g=new Ci(x.lng-180*uh,x.lat),S=new Ci(x.lng+180*uh,x.lat),A=a.project(g.lng,g.lat),w=a.project(S.lng,S.lat),M=-Math.atan2(w.y-A.y,w.x-A.x),P=n.fromLngLat(x);P.y=ai(P.y,-1+uh,1-uh);const O=P.toLngLat(),B=a.project(O.lng,O.lat),G=n.fromLngLat(O);G.x+=uh;const q=G.toLngLat(),U=a.project(q.lng,q.lat),W=wg(U.x-B.x,U.y-B.y,M),X=n.fromLngLat(O);X.y+=uh;const ee=X.toLngLat(),ae=a.project(ee.lng,ee.lat),oe=wg(ae.x-B.x,ae.y-B.y,M),se=Math.abs(W.x)/Math.abs(oe.y),ye=Ie.mat4.identity([]);Ie.mat4.rotateZ(ye,ye,-M*(1-(C?0:T)));const le=Ie.mat4.identity([]);return Ie.mat4.scale(le,le,[1,1-(1-se)*T,1]),le[4]=-oe.x/oe.y*T,Ie.mat4.rotateZ(le,le,M),Ie.mat4.multiply(le,ye,le),le}(r.projection,0,r.center,i,e),h=bg(r);return Ie.mat4.scale(s,s,[h,h,1]),s}function bg(r){const e=r.projection,i=tf(r.projection,r.zoom,r.width,r.height),s=Kf(e,r.center),h=Kf(e,Ci.convert(e.center));return Math.pow(2,s*i+(1-i)*h)}function tf(r,e,i,s,h=1/0){const a=r.range;if(!a)return 0;const u=Math.min(h,Math.max(i,s)),x=Math.log(u/1024)/Math.LN2;return Ai(a[0]+x,a[1]+x,e)}const uh=1/4e4;function Kf(r,e){const i=ai(e.lat,-_n,_n),s=new Ci(e.lng-180*uh,i),h=new Ci(e.lng+180*uh,i),a=r.project(s.lng,i),u=r.project(h.lng,i),x=n.fromLngLat(s),T=n.fromLngLat(h),C=u.x-a.x,g=u.y-a.y,S=T.x-x.x,A=T.y-x.y,w=Math.sqrt((S*S+A*A)/(C*C+g*g));return Math.log(w)/Math.LN2}function wg(r,e,i){const s=Math.cos(i),h=Math.sin(i);return{x:r*s-e*h,y:r*h+e*s}}function Tg(r,e,i){Ie.mat4.identity(r),Ie.mat4.rotateZ(r,r,yi(e[2])),Ie.mat4.rotateX(r,r,yi(e[0])),Ie.mat4.rotateY(r,r,yi(e[1])),Ie.mat4.scale(r,r,i),Ie.mat4.multiply(r,r,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function nf(r,e,i,s,h,a,u,x){const T=[i[0]-e[0],i[1]-e[1],0],C=[s[0]-e[0],s[1]-e[1],0];if(Ie.vec3.length(T)<1e-12||Ie.vec3.length(C)<1e-12)return Ie.quat.identity(r);const g=Ie.vec3.cross([],T,C);Ie.vec3.normalize(g,g),Ie.vec3.subtract(C,s,e),T[2]=(a-h)*x,C[2]=(u-h)*x;const S=T;return Ie.vec3.cross(S,T,C),Ie.vec3.normalize(S,S),Ie.quat.rotationTo(r,g,S)}function Jf(r,e,i=!1){const s=Tr(e.zoom),h=function(a,u,x){const T=u.worldSize,C=[a[12],a[13],a[14]],g=$n(C[1]/T),S=Vr(C[0]/T),A=Ie.mat4.identity([]),w=fr(1,g)*T,M=fr(1,0)*T*ba(g,u.zoom),P=1/_r(T);let O=M*P;if(x){const U=tf(u.projection,u.zoom,u.width,u.height,1024);O=P*u.projection.pixelSpaceConversion(u.center.lat,T,U)}const B=va(g,S);Ie.vec3.add(B,B,Ie.vec3.scale([],Ie.vec3.normalize([],B),w*O*C[2]));const G=function(U){const W=[U[0],U[1],U[2]];let X=[0,1,0];const ee=Ie.vec3.cross([],X,W);return Ie.vec3.cross(X,W,ee),0===Ie.vec3.squaredLength(X)&&(X=[0,1,0],Ie.vec3.cross(ee,W,X)),Ie.vec3.normalize(ee,ee),Ie.vec3.normalize(X,X),Ie.vec3.normalize(W,W),[ee[0],ee[1],ee[2],0,X[0],X[1],X[2],0,W[0],W[1],W[2],0,U[0],U[1],U[2],1]}(B);Ie.mat4.scale(A,A,[O,O,O*w]),Ie.mat4.translate(A,A,[-C[0],-C[1],-C[2]]);const q=Ie.mat4.multiply([],u.globeMatrix,G);return Ie.mat4.multiply(q,q,A),Ie.mat4.multiply(q,q,a),q}(r,e,i);return s>0?function(u,x,T){const C=(M,P,O)=>{const B=Ie.vec3.length(M),G=Ie.vec3.length(P),q=Mn(M,P,O);return Ie.vec3.scale(q,q,1/Ie.vec3.length(q)*Ut(B,G,O))},g=C([u[0],u[1],u[2]],[x[0],x[1],x[2]],T),S=C([u[4],u[5],u[6]],[x[4],x[5],x[6]],T),A=C([u[8],u[9],u[10]],[x[8],x[9],x[10]],T),w=Mn([u[12],u[13],u[14]],[x[12],x[13],x[14]],T);return[g[0],g[1],g[2],0,S[0],S[1],S[2],0,A[0],A[1],A[2],0,w[0],w[1],w[2],1]}(h,function(u,x){const T=x.worldSize,C=fr(1,0)*T*ba(x.center.lat,x.zoom)/_r(T),g=fr(1,x.center.lat)*T,S=Ie.mat4.identity([]);return Ie.mat4.rotateY(S,S,yi(x.center.lng)),Ie.mat4.rotateX(S,S,yi(x.center.lat)),Ie.mat4.translate(S,S,[0,0,wr]),Ie.mat4.scale(S,S,[C,C,C*g]),Ie.mat4.translate(S,S,[x.point.x-.5*T,x.point.y-.5*T,0]),Ie.mat4.multiply(S,S,u),Ie.mat4.multiply(S,x.globeMatrix,S)}(r,e),s):h}function Sg(r,e,i,s){const h=Pt.projectAabbCorners(s,i);let a=Number.MAX_VALUE,u=-1;for(let C=0;C<h.length;++C){const g=h[C];g[0]=(.5*g[0]+.5)*e.width,g[1]=(.5-.5*g[1])*e.height,g[2]<a&&(u=C,a=g[2])}const x=C=>new pt(h[C][0],h[C][1]);let T;switch(u){case 0:case 6:T=[x(1),x(5),x(4),x(7),x(3),x(2),x(1)];break;case 1:case 7:T=[x(0),x(4),x(5),x(6),x(2),x(3),x(0)];break;case 3:case 5:T=[x(1),x(0),x(4),x(7),x(6),x(2),x(1)];break;default:T=[x(1),x(5),x(6),x(7),x(3),x(0),x(1)]}if(Z(r,T))return a}const K0=Li([{name:"a_pos_3f",components:3,type:"Float32"}]),J0=Li([{name:"a_color_3f",components:3,type:"Float32"}]),Q0=Li([{name:"a_color_4f",components:4,type:"Float32"}]),ex=Li([{name:"a_uv_2f",components:2,type:"Float32"}]),tx=Li([{name:"a_normal_3f",components:3,type:"Float32"}]),ix=Li([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),nx=Li([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]),Mg={None:0,Model:1,Symbol:2,FillExtrusion:4,All:7};class rf{constructor(e,i,s,h){this.message=(e?`${e}: `:"")+s,h&&(this.identifier=h),null!=i&&i.__line__&&(this.line=i.__line__)}}function Eg(r,e){const i=-1===r.indexOf("://");try{return new URL(r,i&&e?"http://example.com":void 0),!0}catch{return!1}}class Ag{constructor(e,i){this.feature=e,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Ig{constructor(){this.instancedDataArray=new sc,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class Qf{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map(i=>i.fqid),this.projection=e.projection,this.index=e.index,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter(i=>i.isStateDependent()).map(i=>i.id),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0}updateFootprints(e,i){}populate(e,i,s,h){this.tileToMeter=t(s);const a=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:u,id:x,index:T,sourceLayerIndex:C}of e){const g=x??(u.properties&&u.properties.hasOwnProperty("id")?u.properties.id:void 0),S=N(u,a);if(!this.layers[0]._featureFilter.filter(new Zi(this.zoom),S,s))continue;const A={id:g,sourceLayerIndex:C,index:T,geometry:a?S.geometry:k(u,s,h),properties:u.properties,type:u.type,patterns:{}},w=this.addFeature(A,A.geometry,S);w&&i.featureIndex.insert(u,A.geometry,T,C,this.index,this.instancesPerModel[w].instancedDataArray.length,256)}this.lookup=null}update(e,i,s,h){for(const a in this.instancesPerModel){const u=this.instancesPerModel[a];for(const x in e)u.idToFeaturesIndex.hasOwnProperty(x)&&(this.evaluate(u.features[u.idToFeaturesIndex[x]],e[x],u,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const i in this.instancesPerModel){const s=this.instancesPerModel[i];for(const h of s.features){const a=this.layers[0],u=h.feature,x=this.canonical,T=a.paint.get("model-rotation").evaluate(u,{},x),C=a.paint.get("model-scale").evaluate(u,{},x),g=a.paint.get("model-translation").evaluate(u,{},x);Ie.vec3.exactEquals(h.rotation,T)&&Ie.vec3.exactEquals(h.scale,C)&&Ie.vec3.exactEquals(h.translation,g)||(this.evaluate(h,h.featureStates,s,!0),e=!0)}}return e}updateReplacement(e,i,s,h){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const a=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(Sf(this.activeReplacements,a))return!1;this.activeReplacements=a;let u=!1;for(const x in this.instancesPerModel){const T=this.instancesPerModel[x],C=T.instancedDataArray;for(const g of T.features){const S=g.instancedDataOffset,A=g.instancedDataCount;for(let w=0;w<A;w++){const M=16*(w+S);let P=C.float32[M+0];const O=P>ft;P=O?P-ft:P;const B=Math.floor(P),G=C.float32[M+1];let q=!1;for(const U of this.activeReplacements)if(!jm(U,s,Mg.Model,h)&&!(U.min.x>B||B>U.max.x||U.min.y>G||G>U.max.y)&&(q=Zm($m(B,G,e.canonical,U.footprintTileId.canonical),U.footprint),q))break;C.float32[M]=q?P+ft:P,u=u||q!==O}}}return u}isEmpty(){for(const e in this.instancesPerModel)if(0!==this.instancesPerModel[e].instancedDataArray.length)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const i in this.instancesPerModel){const s=this.instancesPerModel[i];s.instancedDataArray.length<0||0===s.instancedDataArray.length||(s.instancedDataBuffer?s.instancedDataBuffer.updateData(s.instancedDataArray):s.instancedDataBuffer=e.createVertexBuffer(s.instancedDataArray,ix.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const i in this.instancesPerModel){const s=this.instancesPerModel[i];0!==s.instancedDataArray.length&&s.instancedDataBuffer&&s.instancedDataBuffer.destroy()}const e=this.layers[0].modelManager;if(e&&this.modelUris)for(const i of this.modelUris)e.removeModel(i,"")}addFeature(e,i,s){const h=this.layers[0],a=h.layout.get("model-id").evaluate(s,{},this.canonical);if(!a)return ii(`modelId is not evaluated for layer ${h.id} and it is not going to get rendered.`),a;Eg(a,!1)&&(this.modelUris.includes(a)||this.modelUris.push(a)),this.instancesPerModel[a]||(this.instancesPerModel[a]=new Ig);const u=this.instancesPerModel[a],x=u.instancedDataArray,T=new Ag(s,x.length);for(const C of i)for(const g of C){if(g.x<0||g.x>=ft||g.y<0||g.y>=ft)continue;const S=(this.lookupDim-1)/ft,A=this.lookupDim*(g.y*S|0)+g.x*S|0;if(this.lookup){if(0!==this.lookup[A])continue;this.lookup[A]=1}this.instanceCount++;const w=x.length;x.resize(w+1),u.instancesEvaluatedElevation.push(0),x.float32[16*w]=g.x,x.float32[16*w+1]=g.y}return T.instancedDataCount=u.instancedDataArray.length-T.instancedDataOffset,T.instancedDataCount>0&&(e.id&&(u.idToFeaturesIndex[e.id]=u.features.length),u.features.push(T),this.evaluate(T,{},u,!1)),a}getModelUris(){return this.modelUris}evaluate(e,i,s,h){const a=this.layers[0],u=e.feature,x=this.canonical,T=e.rotation=a.paint.get("model-rotation").evaluate(u,i,x),C=e.scale=a.paint.get("model-scale").evaluate(u,i,x),g=e.translation=a.paint.get("model-translation").evaluate(u,i,x),S=a.paint.get("model-color").evaluate(u,i,x);S.a=a.paint.get("model-color-mix-intensity").evaluate(u,i,x);const A=[];this.maxVerticalOffset<g[2]&&(this.maxVerticalOffset=g[2]),this.maxScale=Math.max(Math.max(this.maxScale,C[0]),Math.max(C[1],C[2])),Tg(A,T,C);const w=Math.round(100*S.a)+S.b/1.05;for(let M=0;M<e.instancedDataCount;++M){const P=e.instancedDataOffset+M,O=16*P,B=s.instancedDataArray.float32;let G=0;h&&(G=B[O+6]-s.instancesEvaluatedElevation[P]);const q=0|B[O+1];B[O]=(0|B[O])+S.r/1.05,B[O+1]=q+S.g/1.05,B[O+2]=w,B[O+3]=1/(x.z>10?this.tileToMeter:t(x,q)),B[O+4]=g[0],B[O+5]=g[1],B[O+6]=g[2]+G,B[O+7]=A[0],B[O+8]=A[1],B[O+9]=A[2],B[O+10]=A[4],B[O+11]=A[5],B[O+12]=A[6],B[O+13]=A[8],B[O+14]=A[9],B[O+15]=A[10],s.instancesEvaluatedElevation[P]=g[2]}}}let Cg,Pg;St(Qf,"ModelBucket",{omit:["layers"]}),St(Ig,"PerModelAttributes"),St(Ag,"ModelFeature");const vd={CoordinateSpaceTile:1,CoordinateSpaceYUp:2,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function Dg(r,e,i,s,h,a,u,x,T,C=!1){const g=i.zoom,S=i.project(s),A=ba(s.lat,g),w=1/A;Ie.mat4.identity(r),Ie.mat4.translate(r,r,[S.x+u[0]*w,S.y+u[1]*w,u[2]]);let M=1,P=1;const O=i.worldSize;if(C){if("mercator"===i.projection.name){let U=0;i.elevation&&(U=i.elevation.getAtPointOrZero(new n(S.x/O,S.y/O),0));const W=Ie.vec4.transformMat4([],[S.x,S.y,U,1],i.projMatrix)[3]/i.cameraToCenterDistance;M=W,P=W*ba(i.center.lat,g)}else if("globe"===i.projection.name){const U=Jf(r,i),W=Ie.mat4.multiply([],i.projMatrix,U),X=[0,0,0,1];Ie.vec4.transformMat4(X,X,W);const ee=X[3]/i.cameraToCenterDistance,ae=Tr(g),oe=i.projection.pixelsPerMeter(s.lat,O)*ba(s.lat,g),se=i.projection.pixelsPerMeter(i.center.lat,O)*ba(i.center.lat,g);M=ee/Ut(oe,Tu(i.center.lat),ae),P=ee*A/oe,M*=se,P*=se}}else M=w;Ie.mat4.scale(r,r,[M,M,P]);const B=[...r],G=e.orientation,q=[];if(Tg(q,[G[0]+h[0],G[1]+h[1],G[2]+h[2]],a),Ie.mat4.multiply(r,B,q),x&&i.elevation){let U=0;const W=[];if(T&&i.elevation){U=function(ae,oe,se,ye,le){const ve=oe.elevation;if(!ve)return 0;const Se=Pt.projectAabbCorners(se,ye),we=fr(1,le.lat)*oe.worldSize,Ae=function(It,yt){const wt=[0,0,1],$t=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const ni of $t){const ri=It[ni.corners[0]],si=It[ni.corners[1]],fi=It[ni.corners[2]],_i=[si[0]-ri[0],si[1]-ri[1],yt*(si[2]-ri[2])],rn=Ie.vec3.cross(_i,_i,[fi[0]-ri[0],fi[1]-ri[1],yt*(fi[2]-ri[2])]);Ie.vec3.normalize(rn,rn),ni.dotProductWithUp=Ie.vec3.dot(rn,wt)}return $t.sort((ni,ri)=>ni.dotProductWithUp-ri.dotProductWithUp),$t[0].corners}(Se,we),Pe=Se[Ae[0]],ke=Se[Ae[1]],Ce=Se[Ae[2]],Ze=Se[Ae[3]],tt=ve.getAtPointOrZero(new n(Pe[0]/oe.worldSize,Pe[1]/oe.worldSize),0),$e=ve.getAtPointOrZero(new n(ke[0]/oe.worldSize,ke[1]/oe.worldSize),0),gt=ve.getAtPointOrZero(new n(Ce[0]/oe.worldSize,Ce[1]/oe.worldSize),0),mt=ve.getAtPointOrZero(new n(Ze[0]/oe.worldSize,Ze[1]/oe.worldSize),0),st=(tt+mt)/2,nt=($e+gt)/2;return st>nt?$e<gt?nf(ae,ke,Ze,Pe,$e,mt,tt,we):nf(ae,Ce,Pe,Ze,gt,tt,mt,we):tt<mt?nf(ae,Pe,ke,Ce,tt,$e,gt,we):nf(ae,Ze,Ce,ke,mt,gt,$e,we),Math.max(st,nt)}(W,i,e.aabb,r,s);const X=Ie.mat4.fromQuat([],W),ee=Ie.mat4.multiply([],X,q);Ie.mat4.multiply(r,B,ee)}else U=i.elevation.getAtPointOrZero(new n(S.x/O,S.y/O),0);0!==U&&(r[14]+=U)}}function up(r,e,i=!1){r.uploaded||(r.gfxTexture=new Xf(e,r.image,i?e.gl.R8:e.gl.RGBA8,{useMipmap:r.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),r.uploaded=!0,r.image=null)}function rx(r,e,i){r.indexBuffer=e.createIndexBuffer(r.indexArray,!1,!0),r.vertexBuffer=e.createVertexBuffer(r.vertexArray,K0.members,!1,!0),r.normalArray&&(r.normalBuffer=e.createVertexBuffer(r.normalArray,tx.members,!1,!0)),r.texcoordArray&&(r.texcoordBuffer=e.createVertexBuffer(r.texcoordArray,ex.members,!1,!0)),r.colorArray&&(r.colorBuffer=e.createVertexBuffer(r.colorArray,(12===r.colorArray.bytesPerElement?J0:Q0).members,!1,!0)),r.featureArray&&(r.pbrBuffer=e.createVertexBuffer(r.featureArray,nx.members,!0)),r.segments=vn.simpleSegment(0,0,r.vertexArray.length,r.indexArray.length);const s=r.material;s.pbrMetallicRoughness.baseColorTexture&&up(s.pbrMetallicRoughness.baseColorTexture,e),s.pbrMetallicRoughness.metallicRoughnessTexture&&up(s.pbrMetallicRoughness.metallicRoughnessTexture,e),s.normalTexture&&up(s.normalTexture,e),s.occlusionTexture&&up(s.occlusionTexture,e,i),s.emissionTexture&&up(s.emissionTexture,e)}function em(r,e,i){if(r.meshes)for(const s of r.meshes)rx(s,e,i);if(r.children)for(const s of r.children)em(s,e,i)}function sf(r){if(r.meshes)for(const e of r.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(r.children)for(const e of r.children)sf(e)}function tm(r){if(r.meshes)for(const i of r.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((e=i.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(r.children)for(const i of r.children)tm(i)}class bd{constructor(e,i,s){this._demTile=e,this._dem=this._demTile.dem,this._scale=i,this._offset=s}static create(e,i,s){const h=s||e.findDEMTileFor(i);if(!h||!h.dem)return;const a=h.dem,u=h.tileID,x=1<<i.canonical.z-u.canonical.z;return new bd(h,a.dim/ft/x,[(i.canonical.x/x-u.canonical.x)*a.dim,(i.canonical.y/x-u.canonical.y)*a.dim])}tileCoordToPixel(e,i){const s=i*this._scale+this._offset[1],h=Math.floor(e*this._scale+this._offset[0]),a=Math.floor(s);return new pt(h,a)}getElevationAt(e,i,s,h){const a=e*this._scale+this._offset[0],u=i*this._scale+this._offset[1],x=Math.floor(a),T=Math.floor(u),C=this._dem;return h=!!h,s?Ut(Ut(C.get(x,T,h),C.get(x,T+1,h),u-T),Ut(C.get(x+1,T,h),C.get(x+1,T+1,h),u-T),a-x):C.get(x,T,h)}getElevationAtPixel(e,i,s){return this._dem.get(e,i,!!s)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*fr(1,e)*this._dem.stride}}const im=new Float32Array(262144),Iu=new Uint8Array(262144);function zg(r){let e=0;if(r.meshes)for(const i of r.meshes)e=Math.max(e,i.aabb.max[2]);if(r.children)for(const i of r.children)e=Math.max(e,zg(i));return e}function Rg(r,e,i){if(r.meshes)for(const s of r.meshes){if(s.aabb.min[0]===1/0)continue;const h=Pt.applyTransform(s.aabb,r.matrix);i.insert(e,h.min[0],h.min[1],h.max[0],h.max[1])}if(r.children)for(const s of r.children)Rg(s,e,i)}const Lg=["","wall","door","roof","window","lamp","logo"];class kg{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:zg(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Pt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const i=new Pt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const s of this.node.meshes)this.node.lightMeshIndex!==e&&(s.transformedAabb=Pt.applyTransformFast(s.aabb,this.node.matrix),i.encapsulate(s.transformedAabb)),e++;this.aabb=i}return this.aabb}}class of{constructor(e,i,s,h,a,u,x){this.id=s,this.layers=e,this.layerIds=this.layers.map(T=>T.fqid),this.stateDependentLayerIds=this.layers.filter(T=>T.isStateDependent()).map(T=>T.id),this.modelTraits|=vd.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,h&&(this.modelTraits|=vd.HasMapboxMeshFeatures),a&&(this.modelTraits|=vd.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=u,this.dirty=!0,this.needsUpload=!1,this.nodesInfo=[];for(const T of i)this.nodesInfo.push(new kg(T)),Rg(T,x.featureIndexArray.length,x.grid),x.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,x.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(e,i){for(const s of this.getNodesInfo()){const h=s.node;h.footprint&&i.push({footprint:h.footprint,id:e})}}update(e){const i=0!==Object.keys(e).length;if(i&&!this.stateDependentLayers.length)return;const s=i?this.stateDependentLayers:this.layers;if(!Fn(e,this.states))for(const h of s)this.evaluate(h,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const i=this.getNodesInfo();for(const s of i){const h=s.node;this.uploaded?this.updatePbrBuffer(h):em(h,e,!0)}for(const s of i)sf(s.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let i=!1;if(!e.meshes)return i;for(const s of e.meshes)s.pbrBuffer&&(s.pbrBuffer.updateData(s.featureArray),i=!0);return i}needsReEvaluation(e,i,s){const h=e.transform.projectionOptions,a=e.style.getBrightness(),u=this.brightness!==a;if(!this.uploaded||this.dirty||h.name!==this.projection.name||dp(s.paint.get("model-color").value,u)||dp(s.paint.get("model-color-mix-intensity").value,u)||dp(s.paint.get("model-roughness").value,u)||dp(s.paint.get("model-emissive-strength").value,u)||dp(s.paint.get("model-height-based-emissive-strength-multiplier").value,u)){this.projection=h,this.brightness=a;const x=this.getNodesInfo();for(const T of x)T.state=null;return!0}return!1}evaluateScale(e,i){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const s=this.getNodesInfo(),h=this.id.canonical;for(const a of s){const u=a.feature;a.evaluatedScale=i.paint.get("model-scale").evaluate(u,{},h)}}evaluate(e,i){const s=this.getNodesInfo();for(const h of s){if(!h.node.meshes)continue;const a=h.feature,u=i&&i[a.id];if(Fn(u,h.state))continue;h.state=structuredClone(u);const x=h.node.meshes&&h.node.meshes[0].featureData,T=h.evaluatedColor[2],C=h.evaluatedRMEA[2],g=this.id.canonical;if(h.hasTranslucentParts=!1,x){for(let S=0;S<Lg.length;S++){const A=Lg[S];A.length&&(a.properties.part=A);const w=e.paint.get("model-color").evaluate(a,u,g).toRenderColor(null),M=e.paint.get("model-color-mix-intensity").evaluate(a,u,g);h.evaluatedColor[S]=[w.r,w.g,w.b,M],h.evaluatedRMEA[S][0]=e.paint.get("model-roughness").evaluate(a,u,g),h.evaluatedRMEA[S][2]=e.paint.get("model-emissive-strength").evaluate(a,u,g),h.evaluatedRMEA[S][3]=w.a,h.emissionHeightBasedParams[S]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(a,u,g),!h.hasTranslucentParts&&w.a<1&&(h.hasTranslucentParts=!0)}delete a.properties.part,ox(h,T!==h.evaluatedColor[2]||C!==h.evaluatedRMEA[2],this.modelTraits)}else h.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(a,u,g);h.evaluatedScale=e.paint.get("model-scale").evaluate(a,u,g),this.updatePbrBuffer(h.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,i,s,h){const a=e.findDEMTileFor(s);if(a&&(a.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(a.dem&&a.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=a.tileID.overscaledZ;const u=bd.create(e,s,a);if(!u)return;this.modelTraits&vd.HasMapboxMeshFeatures&&this.updateDEM(e,u,s,h);for(const x of this.getNodesInfo()){const T=x.node;if(!T.footprint||!T.footprint.vertices||!T.footprint.vertices.length)continue;const C=T.footprint.vertices;let g=u.getElevationAt(C[0].x,C[0].y,!0,!0);for(let S=1;S<C.length;S++)g=Math.min(g,u.getElevationAt(C[S].x,C[S].y,!0,!0));T.elevation=g}}this.terrainTile=a.tileID.canonical,this.terrainExaggeration=i}}updateDEM(e,i,s,h){let a=i._dem._modifiedForSources[h];if(void 0===a&&(i._dem._modifiedForSources[h]=[],a=i._dem._modifiedForSources[h]),a.includes(s.canonical))return;const u=i._dem.dim;a.push(s.canonical);let x=!1;for(const T of this.getNodesInfo()){const C=T.node;if(!C.footprint||!C.footprint.grid)continue;const g=C.footprint.grid,S=i.tileCoordToPixel(g.min.x,g.min.y),A=i.tileCoordToPixel(g.max.x,g.max.y),w=Math.min(Math.min(u-A.y,S.x),Math.min(S.y,u-A.x));if(w<0)continue;const M=ai(w,2,5);let P=Math.max(0,S.x-M),O=Math.max(0,S.y-M),B=Math.min(A.x+M,u-1),G=Math.min(A.y+M,u-1);for(let X=O;X<=G;++X)for(let ee=P;ee<=B;++ee)Iu[X*u+ee]=255;let q=0,U=0;for(let X=0;X<g.cellsY;++X)for(let ee=0;ee<g.cellsX;++ee){if(!g.cells[X*g.cellsX+ee])continue;const ae=i.tileCoordToPixel(g.min.x+ee/g.xScale,g.min.y+X/g.yScale),oe=i.tileCoordToPixel(g.min.x+(ee+1)/g.xScale,g.min.y+(X+1)/g.yScale);for(let se=ae.y;se<=Math.min(oe.y+1,u-1);++se)for(let ye=ae.x;ye<=Math.min(oe.x+1,u-1);++ye)255===Iu[se*u+ye]&&(Iu[se*u+ye]=0,q+=i.getElevationAtPixel(ye,se),U++)}const W=q/U;P=Math.max(1,S.x-M),O=Math.max(1,S.y-M),B=Math.min(A.x+M,u-2),G=Math.min(A.y+M,u-2),x=!0;for(let X=O;X<=G;++X)for(let ee=P;ee<=B;++ee)0===Iu[X*u+ee]&&(im[X*u+ee]=i._dem.set(ee,X,W));for(let X=1;X<M;++X){P=Math.max(1,S.x-X),O=Math.max(1,S.y-X),B=Math.min(A.x+X,u-2),G=Math.min(A.y+X,u-2);for(let ee=O;ee<=G;++ee)for(let ae=P;ae<=B;++ae){const oe=ee*u+ae;if(255===Iu[oe]){let se=0,ye=0,le=-1,ve=-1;for(let Se=-1;Se<=1;++Se)for(let we=-1;we<=1;++we){const Ae=(ee+Se)*u+ae+we;if(Iu[Ae]>=X)continue;const Pe=im[Ae],ke=Math.abs(Pe);ke>ye&&(se=Pe,ye=ke,le=we,ve=Se)}if(ye>.1){const Se=1-(X+.5*Math.abs(le*ve))/M;let we=i._dem.get(ae,ee)+se*Se;const Ae=i._dem.get(ae+le,ee+ve),Pe=i._dem.get(ae-le,ee-ve,!0);(we-Ae)*(we-Pe)>0&&(we=(Ae+Pe)/2),im[oe]=i._dem.set(ae,ee,we),Iu[oe]=X}}}}}x&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=fe.now())}getNodesInfo(){return this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const i of e)sf(i.node),tm(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const s=i.getReplacementRegionsForTile(e.toUnwrapped()),h=this.getNodesInfo();for(let a=0;a<this.nodesInfo.length;a++){const u=h[a].node;h[a].hiddenByReplacement=!!u.footprint&&!s.find(x=>x.footprint===u.footprint)}}getHeightAtTileCoord(e,i){const s=this.getNodesInfo(),h=[],a=[0,0,0],u=Ie.mat4.identity([]);for(let x=0;x<this.nodesInfo.length;x++){const T=s[x],C=T.node.meshes[0],g=C.transformedAabb;if(e<g.min[0]||i<g.min[1]||e>g.max[0]||i>g.max[1])continue;if(!0===T.node.hidden)return{height:1/0,maxHeight:T.feature.properties.height,hidden:!1,verticalScale:T.evaluatedScale[2]};Ie.mat4.invert(u,T.node.matrix),a[0]=e,a[1]=i,Ie.vec3.transformMat4(a,a,u);const S=(a[0]-C.aabb.min[0])/(C.aabb.max[0]-C.aabb.min[0])*64|0,A=64*Math.min(63,(a[1]-C.aabb.min[1])/(C.aabb.max[1]-C.aabb.min[1])*64|0)+Math.min(63,S),w=C.heightmap[A];if(!(w<0&&T.node.footprint))return T.hiddenByReplacement?void 0:{height:w,maxHeight:T.feature.properties.height,hidden:!1,verticalScale:T.evaluatedScale[2]};if(T.node.footprint.grid.query(new pt(e,i),new pt(e,i),h),h.length>0)return{height:void 0,maxHeight:T.feature.properties.height,hidden:T.hiddenByReplacement,verticalScale:T.evaluatedScale[2]}}}}function dp(r,e){return!r.isLightConstant&&e}function sx(r,e,i,s,h,a,u,x){let T=(61440&e|(61440&e)>>4)>>8,C=(3840&e|(3840&e)>>4)>>4,g=240&e|(240&e)>>4;i[3]>0&&(T=Ut(T,255*i[0],i[3]),C=Ut(C,255*i[1],i[3]),g=Ut(g,255*i[2],i[3]));const S=T<<8|C,A=g<<8|Math.floor(255*s[3]),w=function(X){const ee=ai(X,0,2);return Math.min(Math.round(.5*ee*255),255)}(s[2])<<8|15*s[0]<<4|15*s[1],M=ai(h[0],0,1),P=ai(h[1],0,1),O=ai(h[2],0,1),B=ai(h[3],0,1);let G,q,U,W;if(M!==P&&u!==a&&P!==M){const X=u-a;q=1/(X*(P-M)),U=-(a+X*M)/(X*(P-M));const ee=ai(h[4],-1,1);W=Math.pow(10,ee),G=255*O<<8|255*B}else G=65535,q=0,U=1,W=1;if(r.emplaceBack(S,A,w,G,q,U,W),x){const X=x.length;x.clear();for(let ee=0;ee<X;ee++)x.emplaceBack(S,A,w,G,q,U,W)}}function ox(r,e,i){const s=r.node;let h=0;const a=i&vd.HasMeshoptCompression;for(const u of s.meshes){if(s.lights&&s.lightMeshIndex===h||!u.featureData)continue;u.featureArray=new ul,u.featureArray.reserve(u.featureData.length);let x=e;for(const T of u.featureData){const C=a?65535&T:T>>16&65535,g=a?T>>16&65535:65535&T,S=(15&g)<8?15&g:0,A=r.evaluatedRMEA[S],w=r.evaluatedColor[S],M=r.emissionHeightBasedParams[S];let P;if(x&&2===S&&s.lights&&(P=new ul,P.resize(10*s.lights.length)),sx(u.featureArray,C,w,A,M,u.aabb.min[2],u.aabb.max[2],P),P&&x){x=!1;const O=s.meshes[s.lightMeshIndex];O.featureArray=P,O.featureArray._trim()}}u.featureArray._trim(),h++}}function Og(r,e,i,s){const h=1<<r.z;e.lat=$n((s/ft+r.y)/h),e.lng=Vr((i/ft+r.x)/h)}St(of,"Tiled3dModelBucket",{omit:["layers"]}),St(kg,"Tiled3dModelFeature");const ax={circle:class extends Wn{constructor(r,e,i,s){super(r,{layout:it||(it=new cn({"circle-sort-key":new bt(Ne.layout_circle["circle-sort-key"]),"circle-elevation-reference":new at(Ne.layout_circle["circle-elevation-reference"]),visibility:new at(Ne.layout_circle.visibility)})),paint:De||(De=new cn({"circle-radius":new bt(Ne.paint_circle["circle-radius"]),"circle-color":new bt(Ne.paint_circle["circle-color"]),"circle-blur":new bt(Ne.paint_circle["circle-blur"]),"circle-opacity":new bt(Ne.paint_circle["circle-opacity"]),"circle-translate":new at(Ne.paint_circle["circle-translate"]),"circle-translate-anchor":new at(Ne.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new at(Ne.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new at(Ne.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new bt(Ne.paint_circle["circle-stroke-width"]),"circle-stroke-color":new bt(Ne.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new bt(Ne.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new at(Ne.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}createBucket(r){return new Y(r)}queryRadius(r){const e=r;return Ye("circle-radius",this,e)+Ye("circle-stroke-width",this,e)+Xe(this.paint.get("circle-translate"))}queryIntersectsFeature(r,e,i,s,h,a,u,x){const T=He(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),a.angle,r.pixelToTileUnitsFactor),C=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return rh(r,s,a,u,x,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),T,C)}getProgramIds(){return["circle"]}getDefaultProgramParams(r,e,i){const s=xl(this);return{config:new xa(this,{zoom:e,lut:i}),defines:s,overrideFog:!1}}},heatmap:class extends Wn{createBucket(r){return new Ap(r)}constructor(r,e,i,s){super(r,{layout:Ip||(Ip=new cn({visibility:new at(Ne.layout_heatmap.visibility)})),paint:Cp||(Cp=new cn({"heatmap-radius":new bt(Ne.paint_heatmap["heatmap-radius"]),"heatmap-weight":new bt(Ne.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new at(Ne.paint_heatmap["heatmap-intensity"]),"heatmap-color":new ol(Ne.paint_heatmap["heatmap-color"]),"heatmap-opacity":new at(Ne.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){"heatmap-color"===r&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=R({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}queryRadius(r){return Ye("heatmap-radius",this,r)}queryIntersectsFeature(r,e,i,s,h,a,u,x){const T=this.paint.get("heatmap-radius").evaluate(e,i);return rh(r,s,a,u,x,!0,!0,new pt(0,0),T)}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(r,e,i){return"heatmap"===r?{config:new xa(this,{zoom:e,lut:i}),overrideFog:!1}:{}}},hillshade:class extends Wn{constructor(r,e,i,s){super(r,{layout:Pp||(Pp=new cn({visibility:new at(Ne.layout_hillshade.visibility)})),paint:m||(m=new cn({"hillshade-illumination-direction":new at(Ne.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new at(Ne.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new at(Ne.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new at(Ne.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new at(Ne.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new at(Ne.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new at(Ne.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}shouldRedrape(){return this.hasOffscreenPass()&&"viewport"===this.paint.get("hillshade-illumination-anchor")}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}},fill:class extends Wn{constructor(r,e,i,s){super(r,{layout:oh||(oh=new cn({"fill-sort-key":new bt(Ne.layout_fill["fill-sort-key"]),visibility:new at(Ne.layout_fill.visibility),"fill-elevation-reference":new at(Ne.layout_fill["fill-elevation-reference"])})),paint:bl||(bl=new cn({"fill-antialias":new at(Ne.paint_fill["fill-antialias"]),"fill-opacity":new bt(Ne.paint_fill["fill-opacity"]),"fill-color":new bt(Ne.paint_fill["fill-color"]),"fill-outline-color":new bt(Ne.paint_fill["fill-outline-color"]),"fill-translate":new at(Ne.paint_fill["fill-translate"]),"fill-translate-anchor":new at(Ne.paint_fill["fill-translate-anchor"]),"fill-pattern":new bt(Ne.paint_fill["fill-pattern"]),"fill-emissive-strength":new at(Ne.paint_fill["fill-emissive-strength"]),"fill-z-offset":new bt(Ne.paint_fill["fill-z-offset"]),"fill-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}getProgramIds(){const r=this.paint.get("fill-pattern"),e=r&&r.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(r,e,i){return{config:new xa(this,{zoom:e,lut:i}),overrideFog:!1}}recalculate(r,e){super.recalculate(r,e);const i=this.paint._values["fill-outline-color"];"constant"===i.value.kind&&void 0===i.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(r){return new Sa(r)}queryRadius(){return Xe(this.paint.get("fill-translate"))}queryIntersectsFeature(r,e,i,s,h,a){return!r.queryGeometry.isAboveHorizon&&J(Re(r.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),a.angle,r.pixelToTileUnitsFactor),s)}isTileClipped(){return!0}is3D(){return 0!==this.paint.get("fill-z-offset").constantOr(1)}},"fill-extrusion":class extends Wn{constructor(r,e,i,s){super(r,{layout:c_||(c_=new cn({visibility:new at(Ne["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new at(Ne["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:h_||(h_=new cn({"fill-extrusion-opacity":new at(Ne["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new bt(Ne["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new at(Ne["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new at(Ne["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new bt(Ne["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new bt(Ne["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new bt(Ne["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new at(Ne["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new at(Ne["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new at(Ne["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new at(Ne["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new at(Ne["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new at(Ne["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new at(Ne["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new at(Ne["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new at(Ne["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new at(Ne["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new bt(Ne["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new bt(Ne["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new at(Ne["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new at(Ne["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new at(Ne["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new at(Ne["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new bt(Ne["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new bt(Ne["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new at(Ne["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new Op(r)}queryRadius(){return Xe(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(r,e,i,s,h,a,u,x,T){const C=He(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),a.angle,r.pixelToTileUnitsFactor),g=this.paint.get("fill-extrusion-height").evaluate(e,i),S=this.paint.get("fill-extrusion-base").evaluate(e,i),A=[0,0],w=x&&a.elevation,M=a.elevation?a.elevation.exaggeration():1,P=r.tile.getBucket(this);if(w&&P instanceof Op){const U=P.centroidVertexArray,W=T+1;W<U.length&&(A[0]=U.geta_centroid_pos0(W),A[1]=U.geta_centroid_pos1(W))}if(0===A[0]&&1===A[1])return!1;"globe"===a.projection.name&&(s=l_([s],[new pt(0,0),new pt(ft,ft)],r.tileID.canonical).map(U=>U.polygon).flat());const O=w?x:null,[B,G]=(W=s,X=S,ee=g,ae=C,oe=u,se=O,ye=A,le=M,ve=a.center.lat,"globe"===(U=a).projection.name?function(we,Ae,Pe,ke,Ce,Ze,tt,$e,gt,mt,st){const nt=[],It=[],yt=we.projection.upVectorScale(st,we.center.lat,we.worldSize).metersToTile,wt=[0,0,0,1],$t=[0,0,0,1],ni=(si,fi,_i,rn)=>{si[0]=fi,si[1]=_i,si[2]=rn,si[3]=1},ri=a_();Pe>0&&(Pe+=ri),ke+=ri;for(const si of Ae){const fi=[],_i=[];for(const rn of si){const $i=rn.x+Ce.x,Jt=rn.y+Ce.y,Ui=we.projection.projectTilePoint($i,Jt,st),Gi=we.projection.upVector(st,rn.x,rn.y);let an=Pe,Pn=ke;if(tt){const qn=d_($i,Jt,Pe,ke,tt,$e,gt,mt);an+=qn.base,Pn+=qn.top}0!==Pe?ni(wt,Ui.x+Gi[0]*yt*an,Ui.y+Gi[1]*yt*an,Ui.z+Gi[2]*yt*an):ni(wt,Ui.x,Ui.y,Ui.z),ni($t,Ui.x+Gi[0]*yt*Pn,Ui.y+Gi[1]*yt*Pn,Ui.z+Gi[2]*yt*Pn),Ie.vec3.transformMat4(wt,wt,Ze),Ie.vec3.transformMat4($t,$t,Ze),fi.push(new Eu(wt[0],wt[1],wt[2])),_i.push(new Eu($t[0],$t[1],$t[2]))}nt.push(fi),It.push(_i)}return[nt,It]}(U,W,X,ee,ae,oe,se,ye,le,ve,r.tileID.canonical):se?function(we,Ae,Pe,ke,Ce,Ze,tt,$e,gt){const mt=[],st=[],nt=[0,0,0,1];for(const It of we){const yt=[],wt=[];for(const $t of It){const ni=$t.x+ke.x,ri=$t.y+ke.y,si=d_(ni,ri,Ae,Pe,Ze,tt,$e,gt);nt[0]=ni,nt[1]=ri,nt[2]=si.base,nt[3]=1,Ie.vec4.transformMat4(nt,nt,Ce),nt[3]=Math.max(nt[3],1e-5);const fi=new Eu(nt[0]/nt[3],nt[1]/nt[3],nt[2]/nt[3]);nt[0]=ni,nt[1]=ri,nt[2]=si.top,nt[3]=1,Ie.vec4.transformMat4(nt,nt,Ce),nt[3]=Math.max(nt[3],1e-5);const _i=new Eu(nt[0]/nt[3],nt[1]/nt[3],nt[2]/nt[3]);yt.push(fi),wt.push(_i)}mt.push(yt),st.push(wt)}return[mt,st]}(W,X,ee,ae,oe,se,ye,le,ve):function(we,Ae,Pe,ke,Ce){const Ze=[],tt=[],$e=Ce[8]*Ae,gt=Ce[9]*Ae,mt=Ce[10]*Ae,st=Ce[11]*Ae,nt=Ce[8]*Pe,It=Ce[9]*Pe,yt=Ce[10]*Pe,wt=Ce[11]*Pe;for(const $t of we){const ni=[],ri=[];for(const si of $t){const fi=si.x+ke.x,_i=si.y+ke.y,rn=Ce[0]*fi+Ce[4]*_i+Ce[12],$i=Ce[1]*fi+Ce[5]*_i+Ce[13],Jt=Ce[2]*fi+Ce[6]*_i+Ce[14],Ui=Ce[3]*fi+Ce[7]*_i+Ce[15],Gi=rn+$e,an=$i+gt,Pn=Jt+mt,qn=Math.max(Ui+st,1e-5),Dn=rn+nt,Tn=$i+It,On=Jt+yt,Zn=Math.max(Ui+wt,1e-5);ni.push(new Eu(Gi/qn,an/qn,Pn/qn)),ri.push(new Eu(Dn/Zn,Tn/Zn,On/Zn))}Ze.push(ni),tt.push(ri)}return[Ze,tt]}(W,X,ee,ae,oe)),q=r.queryGeometry;var U,W,X,ee,ae,oe,se,ye,le,ve;return function(U,W,X){let ee=1/0;J(X,W)&&(ee=u_(X,W[0]));for(let ae=0;ae<W.length;ae++){const oe=W[ae],se=U[ae];for(let ye=0;ye<oe.length-1;ye++){const le=oe[ye],ve=[le,oe[ye+1],se[ye+1],se[ye],le];Z(X,ve)&&(ee=Math.min(ee,u_(X,ve)))}}return ee!==1/0&&ee}(B,G,q.isPointQuery()?q.screenBounds:q.screenGeometry)}},line:class extends Wn{constructor(r,e,i,s){const h=w_();super(r,h,e,i,s),h.layout&&(this.layout=new Ls(h.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(r){if("line-gradient"===r){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Ya,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(r,e){super.recalculate(r,e),this.paint._values["line-floorwidth"]=(()=>{if(Qd)return Qd;const i=w_();return Qd=new h0(i.paint.properties["line-width"].specification),Qd.useIntegerZoom=!0,Qd})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,r)}createBucket(r){return new If(r)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(r,e,i){const s=v_(this);return{config:new xa(this,{zoom:e,lut:i}),defines:s,overrideFog:!1}}queryRadius(r){const e=r,i=T_(Ye("line-width",this,e),Ye("line-gap-width",this,e)),s=Ye("line-offset",this,e);return i/2+Math.abs(s)+Xe(this.paint.get("line-translate"))}queryIntersectsFeature(r,e,i,s,h,a){if(r.queryGeometry.isAboveHorizon)return!1;const u=Re(r.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),a.angle,r.pixelToTileUnitsFactor),x=r.pixelToTileUnitsFactor/2*T_(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),T=this.paint.get("line-offset").evaluate(e,i);return T&&(s=function(C,g){const S=[],A=new pt(0,0);for(let w=0;w<C.length;w++){const M=C[w],P=[];for(let O=0;O<M.length;O++){const B=M[O],G=M[O+1],q=0===O?A:B.sub(M[O-1])._unit()._perp(),U=O===M.length-1?A:G.sub(B)._unit()._perp(),W=q._add(U)._unit();W._mult(1/(W.x*U.x+W.y*U.y)),P.push(W._mult(g)._add(B))}S.push(P)}return S}(s,T*r.pixelToTileUnitsFactor)),function(C,g,S){for(let A=0;A<g.length;A++){const w=g[A];if(C.length>=3)for(let M=0;M<w.length;M++)if(de(C,w[M]))return!0;if(re(C,w,S))return!0}return!1}(u,s,x)}isTileClipped(){return!0}isDraped(r){return!this.hasElevatedBuckets}},symbol:Kp,background:class extends Wn{constructor(r,e,i,s){super(r,{layout:ag||(ag=new cn({visibility:new at(Ne.layout_background.visibility)})),paint:lg||(lg=new cn({"background-pitch-alignment":new at(Ne.paint_background["background-pitch-alignment"]),"background-color":new at(Ne.paint_background["background-color"]),"background-pattern":new at(Ne.paint_background["background-pattern"]),"background-opacity":new at(Ne.paint_background["background-opacity"]),"background-emissive-strength":new at(Ne.paint_background["background-emissive-strength"]),"background-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(r,e,i){return{overrideFog:!1}}is3D(){return"viewport"===this.paint.get("background-pitch-alignment")}},raster:pg,"raster-particle":xg,sky:class extends Wn{constructor(r,e,i,s){super(r,{layout:_g||(_g=new cn({visibility:new at(Ne.layout_sky.visibility)})),paint:gg||(gg=new cn({"sky-type":new at(Ne.paint_sky["sky-type"]),"sky-atmosphere-sun":new at(Ne.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new at(Ne.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new at(Ne.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new at(Ne.paint_sky["sky-gradient-radius"]),"sky-gradient":new ol(Ne.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new at(Ne.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new at(Ne.paint_sky["sky-atmosphere-color"]),"sky-opacity":new at(Ne.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(r){"sky-gradient"===r?this._updateColorRamp():"sky-atmosphere-sun"!==r&&"sky-atmosphere-halo-color"!==r&&"sky-atmosphere-color"!==r&&"sky-atmosphere-sun-intensity"!==r||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=R({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(r){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=r.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(r,e){if("atmosphere"===this.paint.get("sky-type")){const s=this.paint.get("sky-atmosphere-sun"),h=!s,a=r.style.light,u=a.properties.get("position");return h&&"viewport"===a.properties.get("anchor")&&ii("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),h?Yf(u.azimuthal,90-u.polar,e):Yf(s[0],90-s[1],e)}const i=this.paint.get("sky-gradient-center");return Yf(i[0],90-i[1],e)}isSky(){return!0}markSkyboxValid(r){this._skyboxInvalidated=!1,this._lightPosition=r.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const r=this.paint.get("sky-type");return"atmosphere"===r?["skyboxCapture","skybox"]:"gradient"===r?["skyboxGradient"]:null}},slot:class extends Wn{constructor(r,e,i,s){super(r,{paint:yg||(yg=new cn({}))},e,null)}},model:class extends Wn{constructor(r,e,i,s){super(r,{layout:Cg||(Cg=new cn({visibility:new at(Ne.layout_model.visibility),"model-id":new bt(Ne.layout_model["model-id"])})),paint:Pg||(Pg=new cn({"model-opacity":new bt(Ne.paint_model["model-opacity"]),"model-rotation":new bt(Ne.paint_model["model-rotation"]),"model-scale":new bt(Ne.paint_model["model-scale"]),"model-translation":new bt(Ne.paint_model["model-translation"]),"model-color":new bt(Ne.paint_model["model-color"]),"model-color-mix-intensity":new bt(Ne.paint_model["model-color-mix-intensity"]),"model-type":new at(Ne.paint_model["model-type"]),"model-cast-shadows":new at(Ne.paint_model["model-cast-shadows"]),"model-receive-shadows":new at(Ne.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new at(Ne.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new bt(Ne.paint_model["model-emissive-strength"]),"model-roughness":new bt(Ne.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new bt(Ne.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new at(Ne.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new at(Ne.paint_model["model-front-cutoff"]),"model-color-use-theme":new bt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,s),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(r){return new Qf(r)}getProgramIds(){return["model"]}is3D(){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(r){return r instanceof of?8191:0}queryIntersectsFeature(r,e,i,s,h,a){if(!this.modelManager)return!1;const u=this.modelManager,x=r.tile.getBucket(this);if(!(x&&x instanceof Qf))return!1;for(const T in x.instancesPerModel){const C=x.instancesPerModel[T],g=void 0!==e.id?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(C.idToFeaturesIndex.hasOwnProperty(g)){const S=C.features[C.idToFeaturesIndex[g]],A=u.getModel(T,this.scope);if(!A)return!1;let w=Ie.mat4.create();const M=new Ci(0,0),P=x.canonical;let O=Number.MAX_VALUE;for(let B=0;B<S.instancedDataCount;++B){const G=16*(S.instancedDataOffset+B),q=C.instancedDataArray.float32,U=[q[G+4],q[G+5],q[G+6]];Og(P,M,q[G],0|q[G+1]),Dg(w,A,a,M,S.rotation,S.scale,U,!1,!1,!1),"globe"===a.projection.name&&(w=Jf(w,a));const W=Ie.mat4.multiply([],a.projMatrix,w),X=r.queryGeometry,ee=Sg(X.isPointQuery()?X.screenBounds:X.screenGeometry,a,W,A.aabb);null!=ee&&(O=Math.min(ee,O))}return O!==Number.MAX_VALUE&&O}}return!1}_handleOverridablePaintPropertyUpdate(r,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven()||"model-color"!==r&&"model-color-mix-intensity"!==r&&"model-rotation"!==r&&"model-scale"!==r&&"model-translation"!==r&&"model-emissive-strength"!==r)}_isPropertyZoomDependent(r){const e=this._transitionablePaint._values[r];return null!=e&&null!=e.value&&null!=e.value.expression&&e.value.expression instanceof Zl}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends Wn{constructor(r,e,i,s){super(r,{layout:Cm||(Cm=new cn({"clip-layer-types":new at(Ne.layout_clip["clip-layer-types"]),"clip-layer-scope":new at(Ne.layout_clip["clip-layer-scope"])})),paint:Pm||(Pm=new cn({}))},e,i,s)}recalculate(r,e){super.recalculate(r,e)}createBucket(r){return new Dm(r)}isTileClipped(){return!0}is3D(){return!0}}};class lx{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback()},0))}remove(){this._channel=void 0,this._callback=()=>{}}}class cx{constructor(){this.tasks={},this.taskQueue=[],Jo(["process"],this),this.invoker=new lx(this.process),this.nextId=0}add(e,i){const s=this.nextId++,h=function({type:a,isSymbolTile:u,zoom:x}){return x=x||0,"message"===a?0:"maybePrepare"!==a||u?"parseTile"!==a||u?"parseTile"===a&&u?300-x:"maybePrepare"===a&&u?400-x:500:200-x:100-x}(i);if(0===h){try{e()}finally{}return null}return this.tasks[s]={fn:e,metadata:i,priority:h,id:s},this.taskQueue.push(s),this.invoker.trigger(),{cancel:()=>{delete this.tasks[s]}}}process(){try{if(this.taskQueue=this.taskQueue.filter(s=>!!this.tasks[s]),!this.taskQueue.length)return;const e=this.pick();if(null===e)return;const i=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let e=null,i=1/0;for(let h=0;h<this.taskQueue.length;h++){const a=this.tasks[this.taskQueue[h]];a.priority<i&&(i=a.priority,e=h)}if(null===e)return null;const s=this.taskQueue[e];return this.taskQueue.splice(e,1),s}remove(){this.invoker.remove()}}class Fg{constructor(e,i,s){this.target=e,this.parent=i,this.mapId=s,this.callbacks={},this.cancelCallbacks={},Jo(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new cx}send(e,i,s,h,a=!1,u){const x=Math.round(1e18*Math.random()).toString(36).substring(0,10);s&&(s.metadata=u,this.callbacks[x]=s);const T=new Set;return this.target.postMessage({id:x,type:e,hasCallback:!!s,targetMapId:h,mustQueue:a,sourceMapId:this.mapId,data:no(i,T)},T),{cancel:()=>{s&&delete this.callbacks[x],this.target.postMessage({id:x,type:"<cancel>",targetMapId:h,sourceMapId:this.mapId})}}}receive(e){const i=e.data,s=i.id;if(s&&(!i.targetMapId||this.mapId===i.targetMapId))if("<cancel>"===i.type){const h=this.cancelCallbacks[s];delete this.cancelCallbacks[s],h&&h.cancel()}else if(i.mustQueue||_o()){const h=this.callbacks[s],a=this.scheduler.add(()=>this.processTask(s,i),h&&h.metadata||{type:"message"});a&&(this.cancelCallbacks[s]=a)}else this.processTask(s,i)}processTask(e,i){if(delete this.cancelCallbacks[e],"<response>"===i.type){const s=this.callbacks[e];delete this.callbacks[e],s&&(i.error?s(fa(i.error)):s(null,fa(i.data)))}else{const s=new Set,h=i.hasCallback?(u,x)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:u?no(u):null,data:no(x,s)},s)}:()=>{},a=fa(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,a,h);else if(this.parent.getWorkerSource){const u=i.type.split(".");this.parent.getWorkerSource(i.sourceMapId,u[0],a.source,a.scope)[u[1]](a,h)}else h(new Error(`Could not find function ${i.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var pp={workerUrl:"",workerClass:null,workerParams:void 0};const nm="mapboxgl_preloaded_worker_pool";let fp,rm,af=(()=>{class r{constructor(){this.active={}}acquire(i,s=r.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<s;)this.workers.push(null!=pp.workerClass?new pp.workerClass:new self.Worker(pp.workerUrl,pp.workerParams));return this.active[i]=!0,this.workers.slice()}release(i){delete this.active[i],this.workers&&0===this.numActive()&&(this.workers.forEach(s=>{s.terminate()}),this.workers=null)}isPreloaded(){return!!this.active[nm]}numActive(){return Object.keys(this.active).length}}return r.workerCount=2,r})();class wd{constructor(e,i,s="Worker",h=af.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=Ti();const a=this.workerPool.acquire(this.id,h);for(let u=0;u<a.length;u++){const x=new wd.Actor(a[u],i,this.id);x.name=`${s} ${u}`,this.actors.push(x)}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0})}broadcast(e,i,s){zi(this.actors,(h,a)=>{h.send(e,i,a)},s=s||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach(e=>{e.remove()}),this.actors=[],this.workerPool.release(this.id)}}function lf(){return fp||(fp=new af),fp}wd.Actor=Fg;const sm=new Ri(0,0,0);var r,om=((r=om||{})[r.PATH_RULE_UNSPECIFIED=0]="PATH_RULE_UNSPECIFIED",r[r.PATH_RULE_NON_ZERO=1]="PATH_RULE_NON_ZERO",r[r.PATH_RULE_EVEN_ODD=2]="PATH_RULE_EVEN_ODD",r),cf=(r=>(r[r.LINE_CAP_UNSPECIFIED=0]="LINE_CAP_UNSPECIFIED",r[r.LINE_CAP_BUTT=1]="LINE_CAP_BUTT",r[r.LINE_CAP_ROUND=2]="LINE_CAP_ROUND",r[r.LINE_CAP_SQUARE=3]="LINE_CAP_SQUARE",r))(cf||{}),mp=(r=>(r[r.LINE_JOIN_UNSPECIFIED=0]="LINE_JOIN_UNSPECIFIED",r[r.LINE_JOIN_MITER=1]="LINE_JOIN_MITER",r[r.LINE_JOIN_MITER_CLIP=2]="LINE_JOIN_MITER_CLIP",r[r.LINE_JOIN_ROUND=3]="LINE_JOIN_ROUND",r[r.LINE_JOIN_BEVEL=4]="LINE_JOIN_BEVEL",r))(mp||{}),Bg=(r=>(r[r.PAINT_ORDER_UNSPECIFIED=0]="PAINT_ORDER_UNSPECIFIED",r[r.PAINT_ORDER_FILL_AND_STROKE=1]="PAINT_ORDER_FILL_AND_STROKE",r[r.PAINT_ORDER_STROKE_AND_FILL=2]="PAINT_ORDER_STROKE_AND_FILL",r))(Bg||{}),Td=(r=>(r[r.PATH_COMMAND_UNSPECIFIED=0]="PATH_COMMAND_UNSPECIFIED",r[r.PATH_COMMAND_MOVE=1]="PATH_COMMAND_MOVE",r[r.PATH_COMMAND_LINE=2]="PATH_COMMAND_LINE",r[r.PATH_COMMAND_QUAD=3]="PATH_COMMAND_QUAD",r[r.PATH_COMMAND_CUBIC=4]="PATH_COMMAND_CUBIC",r[r.PATH_COMMAND_CLOSE=5]="PATH_COMMAND_CLOSE",r))(Td||{}),Ng=(r=>(r[r.MASK_TYPE_UNSPECIFIED=0]="MASK_TYPE_UNSPECIFIED",r[r.MASK_TYPE_LUMINANCE=1]="MASK_TYPE_LUMINANCE",r[r.MASK_TYPE_ALPHA=2]="MASK_TYPE_ALPHA",r))(Ng||{});function hx(r,e,i){var s,h;1===r&&e.icons.push((s=i,h=i.readVarint()+i.pos,function(a){if(a.usvg_tree.height||(a.usvg_tree.height=a.usvg_tree.width),!a.metadata)return a;const{metadata:u}=a;if(u.content_area){const{content_area:x}=u;null==x.top&&(x.top=x.left),null==x.width&&(x.width=a.usvg_tree.width),null==x.height&&(x.height=x.width)}return u.stretch_x&&u.stretch_x.length&&Vg(u,"x"),u.stretch_y&&u.stretch_y.length&&Vg(u,"y"),a}(s.readFields(ux,{name:void 0},h))))}function Vg(r,e){const i=[],s=r[`stretch_${e}`];let h=null;for(let a=0;a<s.length;a++)null===h?h=0===i.length?s[0]:i[i.length-1][1]+s[a]:(i.push([h,h+s[a]]),h=null);r[`stretch_${e}_areas`]=i}function ux(r,e,i){var s,h;1===r?e.name=i.readString():2===r?e.metadata=(s=i,h=i.readVarint()+i.pos,s.readFields(dx,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},h)):3===r&&(e.usvg_tree=function(s,h){return s.readFields(mx,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},h)}(i,i.readVarint()+i.pos),e.data="usvg_tree")}function dx(r,e,i){var s,h;1===r?e.stretch_x=i.readPackedVarint():2===r?e.stretch_y=i.readPackedVarint():3===r?e.content_area=(s=i,h=i.readVarint()+i.pos,s.readFields(px,{left:0},h)):4===r&&e.variables.push(function(s,h){return s.readFields(fx,{name:void 0},h)}(i,i.readVarint()+i.pos))}function px(r,e,i){1===r?e.left=i.readVarint():2===r?e.width=i.readVarint():3===r?e.top=i.readVarint():4===r&&(e.height=i.readVarint())}function fx(r,e,i){1===r?e.name=i.readString():2===r&&(e.rgb_color=df(i.readVarint()),e.value="rgb_color")}function mx(r,e,i){var s,h;1===r?e.width=e.height=i.readVarint():2===r?e.height=i.readVarint():3===r?e.children.push(hf(i,i.readVarint()+i.pos)):4===r?e.linear_gradients.push((s=i,h=i.readVarint()+i.pos,s.readFields(wx,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},h))):5===r?e.radial_gradients.push(function(s,h){return s.readFields(Sx,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},h)}(i,i.readVarint()+i.pos)):7===r?e.clip_paths.push(function(s,h){return s.readFields(Mx,{children:[]},h)}(i,i.readVarint()+i.pos)):8===r&&e.masks.push(function(s,h){const a=s.readFields(Ex,{left:0,width:20,mask_type:1,children:[]},h);return null==a.height&&(a.height=a.width),null==a.top&&(a.top=a.left),a}(i,i.readVarint()+i.pos))}function hf(r,e){return r.readFields(_x,{},e)}function _x(r,e,i){var s,h;1===r?(e.group=(s=i,h=i.readVarint()+i.pos,s.readFields(gx,{opacity:255,children:[]},h)),e.node="group"):2===r&&(e.path=function(s,h){return s.readFields(xx,{paint_order:1,commands:[],step:1,diffs:[],rule:1},h)}(i,i.readVarint()+i.pos),e.node="path")}function gx(r,e,i){1===r?e.transform=uf(i,i.readVarint()+i.pos):2===r?e.opacity=i.readVarint():5===r?e.clip_path_idx=i.readVarint():6===r?e.mask_idx=i.readVarint():7===r&&e.children.push(hf(i,i.readVarint()+i.pos))}function uf(r,e){return r.readFields(yx,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function yx(r,e,i){1===r?e.sx=i.readFloat():2===r?e.ky=i.readFloat():3===r?e.kx=i.readFloat():4===r?e.sy=i.readFloat():5===r?e.tx=i.readFloat():6===r&&(e.ty=i.readFloat())}function xx(r,e,i){var s,h;1===r?e.fill=(s=i,h=i.readVarint()+i.pos,s.readFields(vx,{rgb_color:sm,paint:"rgb_color",opacity:255},h)):2===r?e.stroke=function(s,h){return s.readFields(bx,{rgb_color:sm,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},h)}(i,i.readVarint()+i.pos):3===r?e.paint_order=i.readVarint():5===r?i.readPackedVarint(e.commands):6===r?e.step=i.readFloat():7===r?i.readPackedSVarint(e.diffs):8===r&&(e.rule=i.readVarint())}function vx(r,e,i){1===r?(e.rgb_color=df(i.readVarint()),e.paint="rgb_color"):2===r?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):3===r?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):5===r&&(e.opacity=i.readVarint())}function df(r){return new Ri((r>>16&255)/255,(r>>8&255)/255,(255&r)/255,1)}function bx(r,e,i){1===r?(e.rgb_color=df(i.readVarint()),e.paint="rgb_color"):2===r?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):3===r?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):5===r?i.readPackedFloat(e.dasharray):6===r?e.dashoffset=i.readFloat():7===r?e.miterlimit=i.readFloat():8===r?e.opacity=i.readVarint():9===r?e.width=i.readFloat():10===r?e.linecap=i.readVarint():11===r&&(e.linejoin=i.readVarint())}function wx(r,e,i){1===r?e.transform=uf(i,i.readVarint()+i.pos):2===r?e.spread_method=i.readVarint():3===r?e.stops.push(Ug(i,i.readVarint()+i.pos)):4===r?e.x1=i.readFloat():5===r?e.y1=i.readFloat():6===r?e.x2=i.readFloat():7===r&&(e.y2=i.readFloat())}function Ug(r,e){return r.readFields(Tx,{offset:0,opacity:255,rgb_color:sm},e)}function Tx(r,e,i){1===r?e.offset=i.readFloat():2===r?e.opacity=i.readVarint():3===r&&(e.rgb_color=df(i.readVarint()))}function Sx(r,e,i){1===r?e.transform=uf(i,i.readVarint()+i.pos):2===r?e.spread_method=i.readVarint():3===r?e.stops.push(Ug(i,i.readVarint()+i.pos)):4===r?e.cx=i.readFloat():5===r?e.cy=i.readFloat():6===r?e.r=i.readFloat():7===r?e.fx=i.readFloat():8===r?e.fy=i.readFloat():9===r&&(e.fr=i.readFloat())}function Mx(r,e,i){1===r?e.transform=uf(i,i.readVarint()+i.pos):2===r?e.clip_path_idx=i.readVarint():3===r&&e.children.push(hf(i,i.readVarint()+i.pos))}function Ex(r,e,i){1===r?e.left=e.top=i.readFloat():2===r?e.width=e.height=i.readFloat():3===r?e.top=i.readFloat():4===r?e.height=i.readFloat():5===r?e.mask_type=i.readVarint():6===r?e.mask_idx=i.readVarint():7===r&&e.children.push(hf(i,i.readVarint()+i.pos))}class Ax{static calculate(e,i){const s=new Map,h=new Map;if(0===Object.keys(e).length)return s;i.forEach(a=>{h.set(a.name,a.rgb_color||new Ri(0,0,0))});for(const[a,u]of Object.entries(e))h.has(a)?s.set(h.get(a).toStringPremultipliedAlpha(),u):console.warn(`Ignoring unknown image variable "${a}"`);return s}}function Sd(r,e=255,i){const s=e/255,h=r.toStringPremultipliedAlpha(),a=i.has(h)?i.get(h).clone():r.clone();return a.a=s,a.toString()}function _p(r,e){if(!ne()){const i=document.createElement("canvas");return i.width=r,i.height=e,i}return new OffscreenCanvas(r,e)}function Ix(r,e){const i=Ax.calculate(e.params,r.metadata?r.metadata.variables:[]),s=r.usvg_tree,h=s.width,a=s.height,u=e.transform?e.transform:new DOMMatrix,x=Math.max(1,Math.round(h*u.a)),T=Math.max(1,Math.round(a*u.d)),C=new DOMMatrix([x/h,0,0,T/a,0,0]),g=_p(x,T).getContext("2d");return am(g,C,s,s,i),g.getImageData(0,0,x,T)}function am(r,e,i,s,h){for(const a of s.children)jg(r,e,i,a,h)}function jg(r,e,i,s,h){s.group?(r.save(),function(a,u,x,T,C){const g=null!=T.mask_idx?x.masks[T.mask_idx]:null,S=null!=T.clip_path_idx?x.clip_paths[T.clip_path_idx]:null;if(T.transform&&(u=pf(T.transform).preMultiplySelf(u)),255===T.opacity&&!(null!=S)&&!(null!=g))return void am(a,u,x,T,C);const A=_p(a.canvas.width,a.canvas.height),w=A.getContext("2d");am(w,u,x,T,C),S&&Xg(w,u,x,S),g&&Yg(w,u,x,g,C),a.globalAlpha=T.opacity/255,a.drawImage(A,0,0)}(r,e,i,s.group,h),r.restore()):s.path&&(r.save(),function(a,u,x,T,C){const g=Kg(T);a.setTransform(u),T.paint_order===Bg.PAINT_ORDER_FILL_AND_STROKE?(Gg(a,x,T,g,C),Hg(a,x,T,g,C)):(Hg(a,x,T,g,C),Gg(a,x,T,g,C))}(r,e,i,s.path,h),r.restore())}function Gg(r,e,i,s,h){const a=i.fill;if(!a)return;const u=a.opacity/255;switch(a.paint){case"rgb_color":r.fillStyle=Sd(a.rgb_color,a.opacity,h);break;case"linear_gradient_idx":r.fillStyle=Wg(r,e.linear_gradients[a.linear_gradient_idx],u,h);break;case"radial_gradient_idx":r.fillStyle=$g(r,e.radial_gradients[a.radial_gradient_idx],u,h)}r.fill(s,qg(i))}function qg(r){return r.rule===om.PATH_RULE_NON_ZERO?"nonzero":r.rule===om.PATH_RULE_EVEN_ODD?"evenodd":void 0}function Hg(r,e,i,s,h){const a=i.stroke;if(!a)return;r.lineWidth=a.width,r.miterLimit=a.miterlimit,r.setLineDash(a.dasharray),r.lineDashOffset=a.dashoffset;const u=a.opacity/255;switch(a.paint){case"rgb_color":r.strokeStyle=Sd(a.rgb_color,a.opacity,h);break;case"linear_gradient_idx":r.strokeStyle=Wg(r,e.linear_gradients[a.linear_gradient_idx],u,h);break;case"radial_gradient_idx":r.strokeStyle=$g(r,e.radial_gradients[a.radial_gradient_idx],u,h)}switch(a.linejoin){case mp.LINE_JOIN_MITER_CLIP:case mp.LINE_JOIN_MITER:r.lineJoin="miter";break;case mp.LINE_JOIN_ROUND:r.lineJoin="round";break;case mp.LINE_JOIN_BEVEL:r.lineJoin="bevel"}switch(a.linecap){case cf.LINE_CAP_BUTT:r.lineCap="butt";break;case cf.LINE_CAP_ROUND:r.lineCap="round";break;case cf.LINE_CAP_SQUARE:r.lineCap="square"}r.stroke(s)}function Wg(r,e,i,s){if(1===e.stops.length){const A=e.stops[0];return Sd(A.rgb_color,A.opacity*i,s)}const h=pf(e.transform),{x1:a,y1:u,x2:x,y2:T}=e,C=h.transformPoint(new DOMPoint(a,u)),g=h.transformPoint(new DOMPoint(x,T)),S=r.createLinearGradient(C.x,C.y,g.x,g.y);for(const A of e.stops)S.addColorStop(A.offset,Sd(A.rgb_color,A.opacity*i,s));return S}function $g(r,e,i,s){if(1===e.stops.length){const A=e.stops[0];return Sd(A.rgb_color,A.opacity*i,s)}const h=pf(e.transform),{fx:a,fy:u,cx:x,cy:T}=e,C=h.transformPoint(new DOMPoint(a,u)),g=h.transformPoint(new DOMPoint(x,T)),S=r.createRadialGradient(C.x,C.y,0,g.x,g.y,e.r*((h.a+h.d)/2));for(const A of e.stops)S.addColorStop(A.offset,Sd(A.rgb_color,A.opacity*i,s));return S}function Zg(r,e,i,s){const h=s.transform?pf(s.transform).preMultiplySelf(e):e,a=_p(r.canvas.width,r.canvas.height),u=a.getContext("2d");for(const T of s.children)if(T.group)Zg(u,h,i,T.group);else if(T.path){const C=T.path,g=new Path2D;g.addPath(Kg(C),h),u.fill(g,qg(C))}const x=null!=s.clip_path_idx?i.clip_paths[s.clip_path_idx]:null;x&&Xg(u,h,i,x),r.globalCompositeOperation="source-over",r.drawImage(a,0,0)}function Xg(r,e,i,s){const h=_p(r.canvas.width,r.canvas.height);Zg(h.getContext("2d"),e,i,s),r.globalCompositeOperation="destination-in",r.drawImage(h,0,0)}function Yg(r,e,i,s,h){if(0===s.children.length)return;const a=null!=s.mask_idx?i.masks[s.mask_idx]:null;a&&Yg(r,e,i,a,h);const u=r.canvas.width,x=r.canvas.height,T=_p(u,x),C=T.getContext("2d"),g=s.width,S=s.height,A=s.left,w=s.top,M=new Path2D,P=new Path2D;P.rect(A,w,g,S),M.addPath(P,e),C.clip(M);for(const G of s.children)jg(C,e,i,G,h);const O=C.getImageData(0,0,u,x),B=O.data;if(s.mask_type===Ng.MASK_TYPE_LUMINANCE)for(let G=0;G<B.length;G+=4)B[G+3]=B[G+3]/255*(.2126*B[G]+.7152*B[G+1]+.0722*B[G+2]);C.putImageData(O,0,0),r.globalCompositeOperation="destination-in",r.drawImage(T,0,0)}function pf(r){return r?new DOMMatrix([r.sx,r.ky,r.kx,r.sy,r.tx,r.ty]):new DOMMatrix}function Kg(r){const e=new Path2D,i=r.step;let s=r.diffs[0]*i,h=r.diffs[1]*i;e.moveTo(s,h);for(let a=0,u=2;a<r.commands.length;a++)switch(r.commands[a]){case Td.PATH_COMMAND_MOVE:s+=r.diffs[u++]*i,h+=r.diffs[u++]*i,e.moveTo(s,h);break;case Td.PATH_COMMAND_LINE:s+=r.diffs[u++]*i,h+=r.diffs[u++]*i,e.lineTo(s,h);break;case Td.PATH_COMMAND_QUAD:{const x=s+r.diffs[u++]*i,T=h+r.diffs[u++]*i;s=x+r.diffs[u++]*i,h=T+r.diffs[u++]*i,e.quadraticCurveTo(x,T,s,h);break}case Td.PATH_COMMAND_CUBIC:{const x=s+r.diffs[u++]*i,T=h+r.diffs[u++]*i,C=x+r.diffs[u++]*i,g=T+r.diffs[u++]*i;s=C+r.diffs[u++]*i,h=g+r.diffs[u++]*i,e.bezierCurveTo(x,T,C,g,s,h);break}case Td.PATH_COMMAND_CLOSE:e.closePath()}return e}class lm{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;const i=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,i),i}put(e,i){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,i)}delete(e){this.cache.delete(e)}}class cm{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new I(e,e.data)}getFromCache(e,i,s){return this.cacheMap.has(s)||this.cacheMap.set(s,new lm(150)),this.cacheMap.get(s).get(ks(e.serialize(),i))}setInCache(e,i,s,h){this.cacheDependenciesMap.has(h)||this.cacheDependenciesMap.set(h,new Map),this.cacheMap.has(h)||this.cacheMap.set(h,new lm(150));const a=this.cacheDependenciesMap.get(h);a.get(ks(e.id,s))||a.set(ks(e.id,s),new Set);const u=this.cacheMap.get(h),x=e.serialize();a.get(ks(e.id,s)).add(x),u.put(ks(e.serialize(),s),i)}removeImagesFromCacheByIds(e,i,s=""){if(!this.cacheMap.has(s)||!this.cacheDependenciesMap.has(s))return;const h=this.cacheMap.get(s),a=this.cacheDependenciesMap.get(s);for(const u of e)if(a.has(ks(u,i))){for(const x of a.get(ks(u,i)))h.delete(x);a.delete(ks(u,i))}}rasterize(e,i,s,h,a=Ix){const u=this.getFromCache(e,s,h);if(u)return u.clone();const x=a(i.icon,e.options),T=cm._getImage(x);return this.setInCache(e,T,s,h),T.clone()}}class Jg{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,i){const s=this.toIdx(e,i);return{min:this.minimums[s],max:this.maximums[s]}}isLeaf(e,i){return this.leaves[this.toIdx(e,i)]}toIdx(e,i){return i*this.size+e}}function Qg(r,e,i,s){let h=0,a=Number.MAX_VALUE;for(let u=0;u<3;u++)if(Math.abs(s[u])<1e-15){if(i[u]<r[u]||i[u]>e[u])return null}else{const x=1/s[u];let T=(r[u]-i[u])*x,C=(e[u]-i[u])*x;if(T>C){const g=T;T=C,C=g}if(T>h&&(h=T),C<a&&(a=C),h>a)return null}return h}function ey(r,e,i,s,h,a,u,x,T,C,g){const S=s-r,A=h-e,w=a-i,M=u-r,P=x-e,O=T-i,B=g[1]*O-g[2]*P,G=g[2]*M-g[0]*O,q=g[0]*P-g[1]*M,U=S*B+A*G+w*q;if(Math.abs(U)<1e-15)return null;const W=1/U,X=C[0]-r,ee=C[1]-e,ae=C[2]-i,oe=(X*B+ee*G+ae*q)*W;if(oe<0||oe>1)return null;const se=ee*w-ae*A,ye=ae*S-X*w,le=X*A-ee*S,ve=(g[0]*se+g[1]*ye+g[2]*le)*W;return ve<0||oe+ve>1?null:(M*se+P*ye+O*le)*W}function ty(r,e,i){return(r-e)/(i-e)}function iy(r,e,i,s,h,a,u,x,T){const C=1<<i,g=a-s,S=u-h,A=(r+1)/C*g+s,w=(e+0)/C*S+h,M=(e+1)/C*S+h;x[0]=(r+0)/C*g+s,x[1]=w,T[0]=A,T[1]=M}class ny{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const i=function(a){const u=Math.ceil(Math.log2(a.dim/8)),x=[];let T=Math.ceil(Math.pow(2,u));const C=1/T,g=(w,M,P,O,B)=>{const G=O?1:0,q=(w+1)*P-G,U=M*P,W=(M+1)*P-G;B[0]=w*P,B[1]=U,B[2]=q,B[3]=W};let S=new Jg(T);const A=[];for(let w=0;w<T*T;w++){g(w%T,Math.floor(w/T),C,!1,A);const M=dh(A[0],A[1],a),P=dh(A[2],A[1],a),O=dh(A[2],A[3],a),B=dh(A[0],A[3],a);S.minimums.push(Math.min(M,P,O,B)),S.maximums.push(Math.max(M,P,O,B)),S.leaves.push(1)}for(x.push(S),T/=2;T>=1;T/=2){const w=x[x.length-1];S=new Jg(T);for(let M=0;M<T*T;M++){g(M%T,Math.floor(M/T),2,!0,A);const P=w.getElevation(A[0],A[1]),O=w.getElevation(A[2],A[1]),B=w.getElevation(A[2],A[3]),G=w.getElevation(A[0],A[3]),q=w.isLeaf(A[0],A[1]),U=w.isLeaf(A[2],A[1]),W=w.isLeaf(A[2],A[3]),X=w.isLeaf(A[0],A[3]),ee=Math.min(P.min,O.min,B.min,G.min),ae=Math.max(P.max,O.max,B.max,G.max),oe=q&&U&&W&&X;S.maximums.push(ae),S.minimums.push(ee),S.leaves.push(ae-ee<=5&&oe?1:0)}x.push(S)}return x}(this.dem),s=i.length-1,h=i[s];this._addNode(h.minimums[0],h.maximums[0],h.leaves[0]),this._construct(i,0,0,s,0)}raycastRoot(e,i,s,h,a,u,x=1){return Qg([e,i,-100],[s,h,this.maximums[0]*x],a,u)}raycast(e,i,s,h,a,u,x=1){if(!this.nodeCount)return null;const T=this.raycastRoot(e,i,s,h,a,u,x);if(null==T)return null;const C=[],g=[],S=[],A=[],w=[{idx:0,t:T,nodex:0,nodey:0,depth:0}];for(;w.length>0;){const{idx:M,t:P,nodex:O,nodey:B,depth:G}=w.pop();if(this.leaves[M]){iy(O,B,G,e,i,s,h,S,A);const U=1<<G,W=(O+0)/U,X=(O+1)/U,ee=(B+0)/U,ae=(B+1)/U,oe=dh(W,ee,this.dem)*x,se=dh(X,ee,this.dem)*x,ye=dh(X,ae,this.dem)*x,le=dh(W,ae,this.dem)*x,ve=ey(S[0],S[1],oe,A[0],S[1],se,A[0],A[1],ye,a,u),Se=ey(A[0],A[1],ye,S[0],A[1],le,S[0],S[1],oe,a,u),we=Math.min(null!==ve?ve:Number.MAX_VALUE,null!==Se?Se:Number.MAX_VALUE);if(we!==Number.MAX_VALUE)return we;{const Ae=Ie.vec3.scaleAndAdd([],a,u,P);if(ry(oe,se,le,ye,ty(Ae[0],S[0],A[0]),ty(Ae[1],S[1],A[1]))>=Ae[2])return P}continue}let q=0;for(let U=0;U<this._siblingOffset.length;U++){iy((O<<1)+this._siblingOffset[U][0],(B<<1)+this._siblingOffset[U][1],G+1,e,i,s,h,S,A),S[2]=-100,A[2]=this.maximums[this.childOffsets[M]+U]*x;const W=Qg(S,A,a,u);if(null!=W){const X=W;C[U]=X;let ee=!1;for(let ae=0;ae<q&&!ee;ae++)X>=C[g[ae]]&&(g.splice(ae,0,U),ee=!0);ee||(g[q]=U),q++}}for(let U=0;U<q;U++){const W=g[U];w.push({idx:this.childOffsets[M]+W,t:C[W],nodex:(O<<1)+this._siblingOffset[W][0],nodey:(B<<1)+this._siblingOffset[W][1],depth:G+1})}}return null}_addNode(e,i,s){return this.minimums.push(e),this.maximums.push(i),this.leaves.push(s),this.childOffsets.push(0),this.nodeCount++}_construct(e,i,s,h,a){if(1===e[h].isLeaf(i,s))return;this.childOffsets[a]||(this.childOffsets[a]=this.nodeCount);const u=h-1,x=e[u];let T=0,C=0;for(let g=0;g<this._siblingOffset.length;g++){const S=2*i+this._siblingOffset[g][0],A=2*s+this._siblingOffset[g][1],w=x.getElevation(S,A),M=x.isLeaf(S,A),P=this._addNode(w.min,w.max,M);M&&(T|=1<<g),C||(C=P)}for(let g=0;g<this._siblingOffset.length;g++)T&1<<g||this._construct(e,2*i+this._siblingOffset[g][0],2*s+this._siblingOffset[g][1],u,C+g)}}function ry(r,e,i,s,h,a){return Ut(Ut(r,i,a),Ut(e,s,a),h)}function dh(r,e,i){const s=i.dim,h=ai(r*s-.5,0,s-1),a=ai(e*s-.5,0,s-1),u=Math.floor(h),x=Math.floor(a),T=Math.min(u+1,s-1),C=Math.min(x+1,s-1);return ry(i.get(u,x),i.get(T,x),i.get(u,C),i.get(T,C),h-u,a-x)}const Cx={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function Px(r,e,i){return(256*r*256+256*e+i)/10-1e4}function Dx(r,e,i){return 256*r+e+i/256-32768}class ff{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,i,s,h=!1){if(this.uid=e,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(s&&"mapbox"!==s&&"terrarium"!==s)return void ii(`"${s}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=i.height;const a=this.dim=i.height-2,u=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=h,this._modifiedForSources={},!h){for(let T=0;T<a;T++)u[this._idx(-1,T)]=u[this._idx(0,T)],u[this._idx(a,T)]=u[this._idx(a-1,T)],u[this._idx(T,-1)]=u[this._idx(T,0)],u[this._idx(T,a)]=u[this._idx(T,a-1)];u[this._idx(-1,-1)]=u[this._idx(0,0)],u[this._idx(a,-1)]=u[this._idx(a-1,0)],u[this._idx(-1,a)]=u[this._idx(0,a-1)],u[this._idx(a,a)]=u[this._idx(a-1,a-1)]}const x="terrarium"===s?Dx:Px;for(let T=0;T<u.length;++T){const C=4*T;this.floatView[T]=x(this.pixels[C],this.pixels[C+1],this.pixels[C+2])}this._timestamp=fe.now()}_buildQuadTree(){this._tree=new ny(this)}get(e,i,s=!1){s&&(e=ai(e,-1,this.dim),i=ai(i,-1,this.dim));const h=this._idx(e,i);return this.floatView[h]}set(e,i,s){const h=this._idx(e,i),a=this.floatView[h];return this.floatView[h]=s,s-a}static getUnpackVector(e){return Cx[e]}_idx(e,i){if(e<-1||e>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(e+1)}static pack(e,i){const s=[0,0,0,0],h=ff.getUnpackVector(i);let a=Math.floor((e+h[3])/h[2]);return s[2]=a%256,a=Math.floor(a/256),s[1]=a%256,a=Math.floor(a/256),s[0]=a,s}getPixels(){return new z({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,i,s){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let h=i*this.dim,a=i*this.dim+this.dim,u=s*this.dim,x=s*this.dim+this.dim;switch(i){case-1:h=a-1;break;case 1:a=h+1}switch(s){case-1:u=x-1;break;case 1:x=u+1}const T=-i*this.dim,C=-s*this.dim;for(let g=u;g<x;g++)for(let S=h;S<a;S++){const A=4*this._idx(S,g),w=4*this._idx(S+T,g+C);this.pixels[A+0]=e.pixels[w+0],this.pixels[A+1]=e.pixels[w+1],this.pixels[A+2]=e.pixels[w+2],this.pixels[A+3]=e.pixels[w+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function zx(r,e,i){var s,h;1===r?e.headerLength=i.readFixed32():2===r?e.x=i.readVarint():3===r?e.y=i.readVarint():4===r?e.z=i.readVarint():5===r&&e.layers.push((s=i,h=i.readVarint()+i.pos,s.readFields(Fx,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},h)))}function Rx(r,e,i){var s,h;1===r?(e.delta_filter=(s=i,h=i.readVarint()+i.pos,s.readFields(Lx,{blockSize:0},h)),e.filter="delta_filter"):2===r?(i.readVarint(),e.filter="zigzag_filter"):3===r?(i.readVarint(),e.filter="bitshuffle_filter"):4===r&&(i.readVarint(),e.filter="byteshuffle_filter")}function Lx(r,e,i){1===r&&(e.blockSize=i.readVarint())}function kx(r,e,i){1===r?(i.readVarint(),e.codec="gzip_data"):2===r?(i.readVarint(),e.codec="jpeg_image"):3===r?(i.readVarint(),e.codec="webp_image"):4===r&&(i.readVarint(),e.codec="png_image")}function Ox(r,e,i){let s=0,h=0;var a,u;1===r?e.firstByte=i.readFixed64():2===r?e.lastByte=i.readFixed64():3===r?e.filters.push((a=i,u=i.readVarint()+i.pos,a.readFields(Rx,{},u))):4===r?e.codec=function(a,u){return a.readFields(kx,{},u)}(i,i.readVarint()+i.pos):5===r?h=i.readFloat():6===r?s=i.readFloat():7===r?e.bands.push(i.readString()):8===r?e.offset=i.readDouble():9===r&&(e.scale=i.readDouble()),0===e.offset&&(e.offset=h),0===e.scale&&(e.scale=s)}function Fx(r,e,i){var s,h;1===r?e.version=i.readVarint():2===r?e.name=i.readString():3===r?e.units=i.readString():4===r?e.tileSize=i.readVarint():5===r?e.buffer=i.readVarint():6===r?e.pixelFormat=i.readVarint():7===r&&e.dataIndex.push((s=i,h=i.readVarint()+i.pos,s.readFields(Ox,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},h)))}function Bx(r,e,i){if(2===r)s=i,h=i.readVarint()+i.pos,s.readFields(Nx,e,h);else if(3===r)throw new Error("Not implemented");var s,h}function Nx(r,e,i){if(1===r){let s=0;const h=i.readVarint()+i.pos;for(;i.pos<h;)e[s++]=i.readVarint()}}function Vx(r,e){if(4!==e.length)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let i=e[3];for(let s=2;s>=1;s--){const h=1===s?1:0,a=2===s?1:0;for(let u=0;u<e[0];u++){const x=e[1]*u;for(let T=h;T<e[1];T++){const C=e[2]*(T+x);for(let g=a;g<e[2];g++){const S=e[3]*(g+C);for(let A=0;A<e[3];A++){const w=S+A;r[w]+=r[w-i]}}}}i*=e[s]}return r}function Ux(r){for(let e=0,i=r.length;e<i;e++)r[e]=r[e]>>>1^-(1&r[e]);return r}function jx(r,e){switch(e){case"uint32":return r;case"uint16":for(let i=0;i<r.length;i+=2){const s=r[i],h=r[i+1];r[i]=(240&s)>>4|(61440&s)>>8|(240&h)<<4|61440&h,r[i+1]=15&s|(3840&s)>>4|(15&h)<<8|(3840&h)<<4}return r;case"uint8":for(let i=0;i<r.length;i+=4){const s=r[i],h=r[i+1],a=r[i+2],u=r[i+3];r[i+0]=(192&s)>>6|(192&h)>>4|(192&a)>>2|192&u,r[i+1]=(48&s)>>4|(48&h)>>2|48&a|(48&u)<<2,r[i+2]=(12&s)>>2|12&h|(12&a)<<2|(12&u)<<4,r[i+3]=3&s|(3&h)<<2|(3&a)<<4|(3&u)<<6}return r;default:throw new Error(`Invalid pixel format, "${e}"`)}}St(ff,"DEMData"),St(ny,"DemMinMaxQuadTree",{omit:["dem"]});var co=Uint8Array,gp=Uint16Array,Gx=Int32Array,sy=new co([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),oy=new co([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),qx=new co([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),ay=function(r,e){for(var i=new gp(31),s=0;s<31;++s)i[s]=e+=1<<r[s-1];var h=new Gx(i[30]);for(s=1;s<30;++s)for(var a=i[s];a<i[s+1];++a)h[a]=a-i[s]<<5|s;return{b:i,r:h}},ly=ay(sy,2),cy=ly.b,Hx=ly.r;cy[28]=258,Hx[258]=28;for(var Wx=ay(oy,0).b,hy=new gp(32768),Gn=0;Gn<32768;++Gn){var Md=(43690&Gn)>>1|(21845&Gn)<<1;hy[Gn]=((65280&(Md=(61680&(Md=(52428&Md)>>2|(13107&Md)<<2))>>4|(3855&Md)<<4))>>8|(255&Md)<<8)>>1}var yp=function(r,e,i){for(var s=r.length,h=0,a=new gp(e);h<s;++h)r[h]&&++a[r[h]-1];var u,x=new gp(e);for(h=1;h<e;++h)x[h]=x[h-1]+a[h-1]<<1;u=new gp(1<<e);var T=15-e;for(h=0;h<s;++h)if(r[h])for(var C=h<<4|r[h],g=e-r[h],S=x[r[h]-1]++<<g,A=S|(1<<g)-1;S<=A;++S)u[hy[S]>>T]=C;return u},xp=new co(288);for(Gn=0;Gn<144;++Gn)xp[Gn]=8;for(Gn=144;Gn<256;++Gn)xp[Gn]=9;for(Gn=256;Gn<280;++Gn)xp[Gn]=7;for(Gn=280;Gn<288;++Gn)xp[Gn]=8;var uy=new co(32);for(Gn=0;Gn<32;++Gn)uy[Gn]=5;var $x=yp(xp,9),Zx=yp(uy,5),hm=function(r){for(var e=r[0],i=1;i<r.length;++i)r[i]>e&&(e=r[i]);return e},Aa=function(r,e,i){var s=e/8|0;return(r[s]|r[s+1]<<8)>>(7&e)&i},um=function(r,e){var i=e/8|0;return(r[i]|r[i+1]<<8|r[i+2]<<16)>>(7&e)},Xx=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Ia=function(r,e,i){var s=new Error(e||Xx[r]);if(s.code=r,Error.captureStackTrace&&Error.captureStackTrace(s,Ia),!i)throw s;return s},Yx=new co(0),Kx=typeof TextDecoder<"u"&&new TextDecoder;try{Kx.decode(Yx,{stream:!0})}catch{}const Jx={gzip_data:"gzip"};class qo extends Error{constructor(e){super(e),this.name="MRTError"}}const Qx={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},dy={uint32:1,uint16:2,uint8:4},ev={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let dm;class pm{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){const i=this.layers[e];if(!i)throw new qo(`Layer '${e}' not found`);return i}getHeaderLength(e){const i=new Uint8Array(e),s=new DataView(e);if(13!==i[0])throw new qo("File is not a valid MRT.");return s.getUint32(1,!0)}parseHeader(e){const i=new Uint8Array(e),s=this.getHeaderLength(e);if(i.length<s)throw new qo(`Expected header with length >= ${s} but got buffer of length ${i.length}`);const h=new dm(i.subarray(0,s)).readFields(zx,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==h.x||this.y!==h.y||this.z!==h.z))throw new qo(`Invalid attempt to parse header ${h.z}/${h.x}/${h.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=h.x,this.y=h.y,this.z=h.z;for(const a of h.layers)this.layers[a.name]=new tv(a,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const i=[],s=this.getLayer(e.layerName);for(let h of e.blockIndices){const a=s.dataIndex[h],u=a.firstByte-e.firstByte,x=a.lastByte-e.firstByte;if(s._blocksInProgress.has(h))continue;const T={layerName:s.name,firstByte:u,lastByte:x,pixelFormat:s.pixelFormat,blockIndex:h,blockShape:[a.bands.length].concat(s.bandShape),buffer:s.buffer,codec:a.codec.codec,filters:a.filters.map(C=>C.filter)};s._blocksInProgress.add(h),i.push(T)}return new py(i,()=>{i.forEach(h=>s._blocksInProgress.delete(h.blockIndex))},(h,a)=>{if(i.forEach(u=>s._blocksInProgress.delete(u.blockIndex)),h)throw h;a.forEach(u=>{this.getLayer(u.layerName).processDecodedData(u)})})}}class tv{constructor({version:e,name:i,units:s,tileSize:h,pixelFormat:a,buffer:u,dataIndex:x},T){if(this.version=e,1!==this.version)throw new qo(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=i,this.units=s,this.tileSize=h,this.buffer=u,this.pixelFormat=Qx[a],this.dataIndex=x,this.bandShape=[h+2*u,h+2*u,dy[this.pixelFormat]],this._decodedBlocks=new lm(T?T.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return dy[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map(({bands:e})=>e).flat()}processDecodedData(e){const i=e.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.put(i,e.data)}getBlockForBand(e){let i=0;switch(typeof e){case"string":for(const[s,h]of this.dataIndex.entries()){for(const[a,u]of h.bands.entries())if(u===e)return{bandIndex:i+a,blockIndex:s,blockBandIndex:a};i+=h.bands.length}break;case"number":for(const[s,h]of this.dataIndex.entries()){if(e>=i&&e<i+h.bands.length)return{bandIndex:e,blockIndex:s,blockBandIndex:e-i};i+=h.bands.length}break;default:throw new qo(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}throw new qo(`Band not found: ${JSON.stringify(e)}`)}getDataRange(e){let i=1/0,s=-1/0;const h=[],a=new Set;for(const u of e){const{blockIndex:x}=this.getBlockForBand(u);if(x<0)throw new qo(`Invalid band: ${JSON.stringify(u)}`);const T=this.dataIndex[x];h.includes(x)||h.push(x),a.add(x),i=Math.min(i,T.firstByte),s=Math.max(s,T.lastByte)}if(a.size>this.cacheSize)throw new qo(`Number of blocks to decode (${a.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:i,lastByte:s,blockIndices:h}}hasBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0}hasDataForBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(e){const{blockIndex:i,blockBandIndex:s}=this.getBlockForBand(e),h=this._decodedBlocks.get(i.toString());if(!h)throw new qo(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const a=this.dataIndex[i],u=this.bandShape.reduce((C,g)=>C*g,1),x=s*u,T=h.subarray(x,x+u);return{data:T,bytes:new Uint8Array(T.buffer).subarray(T.byteOffset,T.byteOffset+T.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:a.offset,scale:a.scale}}}pm.setPbf=function(r){dm=r};class py{constructor(e,i,s){this.tasks=e,this._onCancel=i,this._onComplete=s,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,i){this._finalized||(this._onComplete(e,i),this._finalized=!0)}}pm.performDecoding=function(r,e){const i=new Uint8Array(r);return Promise.all(e.tasks.map(s=>{const{layerName:h,firstByte:a,lastByte:u,pixelFormat:x,blockShape:T,blockIndex:C,filters:g,codec:S}=s,A=i.subarray(a,u+1),w=new Uint32Array(T[0]*T[1]*T[2]);let M;if("gzip_data"!==S)throw new qo(`Unhandled codec: ${S}`);return M=function(P,O){if(!globalThis.DecompressionStream&&"gzip_data"===O)return Promise.resolve(((U=function(ee){31==ee[0]&&139==ee[1]&&8==ee[2]||Ia(6,"invalid gzip data");var ae=ee[3],oe=10;4&ae&&(oe+=2+(ee[10]|ee[11]<<8));for(var se=(ae>>3&1)+(ae>>4&1);se>0;se-=!ee[oe++]);return oe+(2&ae)}(q=P))+8>q.length&&Ia(6,"invalid gzip data"),function(ee,ae,oe){var ye=ee.length;if(!ye||ae.f&&!ae.l)return oe||new co(0);var le=!oe,ve=le||2!=ae.i,Se=ae.i;le&&(oe=new co(3*ye));var we,Ae,Pe=function(ph){var Du=oe.length;if(ph>Du){var Tp=new co(Math.max(2*Du,ph));Tp.set(oe),oe=Tp}},ke=ae.f||0,Ce=ae.p||0,Ze=ae.b||0,tt=ae.l,$e=ae.d,gt=ae.m,mt=ae.n,st=8*ye;do{if(!tt){ke=Aa(ee,Ce,1);var nt=Aa(ee,Ce+1,3);if(Ce+=3,!nt){var It=ee[(Jt=4+((Ce+7)/8|0))-4]|ee[Jt-3]<<8,yt=Jt+It;if(yt>ye){Se&&Ia(0);break}ve&&Pe(Ze+It),oe.set(ee.subarray(Jt,yt),Ze),ae.b=Ze+=It,ae.p=Ce=8*yt,ae.f=ke;continue}if(1==nt)tt=$x,$e=Zx,gt=9,mt=5;else if(2==nt){var wt=Aa(ee,Ce,31)+257,$t=Aa(ee,Ce+10,15)+4,ni=wt+Aa(ee,Ce+5,31)+1;Ce+=14;for(var ri=new co(ni),si=new co(19),fi=0;fi<$t;++fi)si[qx[fi]]=Aa(ee,Ce+3*fi,7);Ce+=3*$t;var _i=hm(si),rn=(1<<_i)-1,$i=yp(si,_i);for(fi=0;fi<ni;){var Jt,Ui=$i[Aa(ee,Ce,rn)];if(Ce+=15&Ui,(Jt=Ui>>4)<16)ri[fi++]=Jt;else{var Gi=0,an=0;for(16==Jt?(an=3+Aa(ee,Ce,3),Ce+=2,Gi=ri[fi-1]):17==Jt?(an=3+Aa(ee,Ce,7),Ce+=3):18==Jt&&(an=11+Aa(ee,Ce,127),Ce+=7);an--;)ri[fi++]=Gi}}var Pn=ri.subarray(0,wt),qn=ri.subarray(wt);gt=hm(Pn),mt=hm(qn),tt=yp(Pn,gt),$e=yp(qn,mt)}else Ia(1);if(Ce>st){Se&&Ia(0);break}}ve&&Pe(Ze+131072);for(var Dn=(1<<gt)-1,Tn=(1<<mt)-1,On=Ce;;On=Ce){var Zn=(Gi=tt[um(ee,Ce)&Dn])>>4;if((Ce+=15&Gi)>st){Se&&Ia(0);break}if(Gi||Ia(2),Zn<256)oe[Ze++]=Zn;else{if(256==Zn){On=Ce,tt=null;break}var Lr=Zn-254;Zn>264&&(Lr=Aa(ee,Ce,(1<<(Pa=sy[fi=Zn-257]))-1)+cy[fi],Ce+=Pa);var on=$e[um(ee,Ce)&Tn],Ts=on>>4;if(on||Ia(3),Ce+=15&on,qn=Wx[Ts],Ts>3){var Pa=oy[Ts];qn+=um(ee,Ce)&(1<<Pa)-1,Ce+=Pa}if(Ce>st){Se&&Ia(0);break}ve&&Pe(Ze+131072);var Ho=Ze+Lr;if(Ze<qn){var Wo=0-qn,Pu=Math.min(qn,Ho);for(Wo+Ze<0&&Ia(3);Ze<Pu;++Ze)oe[Ze]=(void 0)[Wo+Ze]}for(;Ze<Ho;++Ze)oe[Ze]=oe[Ze-qn]}}ae.l=tt,ae.p=On,ae.b=Ze,ae.f=ke,tt&&(ke=1,ae.m=gt,ae.d=$e,ae.n=mt)}while(!ke);return Ze!=oe.length&&le?(we=oe,(null==(Ae=Ze)||Ae>we.length)&&(Ae=we.length),new co(we.subarray(0,Ae))):oe.subarray(0,Ze)}(q.subarray(U,-8),{i:2},new co(((B=q)[(G=B.length)-4]|B[G-3]<<8|B[G-2]<<16|B[G-1]<<24)>>>0))));var B,G,q,U;const W=Jx[O];if(!W)throw new Error(`Unhandled codec: ${O}`);const X=new globalThis.DecompressionStream(W);return new Response(new Blob([P]).stream().pipeThrough(X)).arrayBuffer().then(ee=>new Uint8Array(ee))}(A,S).then(P=>(new dm(P).readFields(Bx,w),new ev[x](w.buffer))),M.then(P=>{for(let O=g.length-1;O>=0;O--)switch(g[O]){case"delta_filter":Vx(P,T);break;case"zigzag_filter":Ux(P);break;case"bitshuffle_filter":jx(P,x);break;default:throw new qo(`Unhandled filter "${g[O]}"`)}return{layerName:h,blockIndex:C,data:P}}).catch(P=>{throw P})}))},St(py,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]});let vp,fm,Ca,Ed,mm,Ad=null;function fy(){return _o()&&self.worker&&self.worker.dracoUrl?self.worker.dracoUrl:fm||En.DRACO_URL}function my(){if(_o()&&self.worker&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Ed)return Ed;const r=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if("object"!=typeof WebAssembly)throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Ed=WebAssembly.validate(r)?En.MESHOPT_SIMD_URL:En.MESHOPT_URL,Ed}const mf={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},iv={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},bp={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function _y(r,e,i){const s=i.json.bufferViews.length,h=i.buffers.length;e.bufferView=s,i.json.bufferViews[s]={buffer:h,byteLength:r.byteLength},i.buffers[h]=r}const _m="KHR_draco_mesh_compression";function nv(r,e){const i=r.extensions&&r.extensions[_m];if(!i)return;const s=new Ca.Decoder,h=vy(e,i.bufferView),a=new Ca.Mesh;if(!s.DecodeArrayToMesh(h,h.byteLength,a))throw new Error("Failed to decode Draco mesh");const u=e.json.accessors[r.indices],x=mf[u.componentType],T=u.count*x.BYTES_PER_ELEMENT,C=Ca._malloc(T);x===Uint16Array?s.GetTrianglesUInt16Array(a,T,C):s.GetTrianglesUInt32Array(a,T,C),_y(Ca.memory.buffer.slice(C,C+T),u,e),Ca._free(C);for(const g of Object.keys(i.attributes)){const S=s.GetAttributeByUniqueId(a,i.attributes[g]),A=e.json.accessors[r.attributes[g]],w=iv[A.componentType],M=A.count*bp[A.type]*mf[A.componentType].BYTES_PER_ELEMENT,P=Ca._malloc(M);s.GetAttributeDataArrayForAllPoints(a,S,Ca[w],M,P),_y(Ca.memory.buffer.slice(P,P+M),A,e),Ca._free(P)}s.destroy(),a.destroy(),delete r.extensions[_m]}const _f="EXT_meshopt_compression";function rv(r,e){if(!r.extensions||!r.extensions[_f])return;const i=r.extensions[_f],s=new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),h=new Uint8Array(i.count*i.byteStride);mm.decodeGltfBuffer(h,i.count,i.byteStride,s,i.mode,i.filter),r.buffer=e.buffers.length,r.byteOffset=0,e.buffers[r.buffer]=h.buffer,delete r.extensions[_f]}const gy=1179937895,yy=new TextDecoder("utf8");function xy(r,e){return new URL(r,e).href}function sv(r,e,i,s){return fetch(xy(r.uri,s)).then(h=>h.arrayBuffer()).then(h=>{e.buffers[i]=h})}function vy(r,e){const i=r.json.bufferViews[e];return new Uint8Array(r.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function ov(r,e,i,s){if(r.uri){const h=xy(r.uri,s);return fetch(h).then(a=>a.blob()).then(a=>createImageBitmap(a)).then(a=>{e.images[i]=a})}if(void 0!==r.bufferView){const h=vy(e,r.bufferView),a=new Blob([h],{type:r.mimeType});return createImageBitmap(a).then(u=>{e.images[i]=u})}}function by(r,e=0,i){const s={json:null,images:[],buffers:[]};if(new Uint32Array(r,e,1)[0]===gy){const g=new Uint32Array(r,e);let S=2;const A=(g[S++]>>2)-3,w=g[S++]>>2;if(S++,s.json=JSON.parse(yy.decode(g.subarray(S,S+w))),S+=w,S<A){const M=g[S++];S++;const P=e+(S<<2);s.buffers[0]=r.slice(P,P+M)}}else s.json=JSON.parse(yy.decode(new Uint8Array(r,e)));const{buffers:h,images:a,meshes:u,extensionsUsed:x,bufferViews:T}=s.json;let C=Promise.resolve();if(h){const g=[];for(let S=0;S<h.length;S++){const A=h[S];A.uri?g.push(sv(A,s,S,i)):s.buffers[S]||(s.buffers[S]=null)}C=Promise.all(g)}return C.then(()=>{const g=[],S=x&&x.includes(_m),A=x&&x.includes(_f);if(S&&g.push(function(){if(!Ca)return vp??(vp=function(w){let M,P=null;function O(){M=new Uint8Array(P.buffer)}function B(){throw new Error("Unexpected Draco error.")}const G={a:{a:B,d:function(q,U,W){return M.copyWithin(q,U,U+W)},c:function(q){const U=M.length,W=Math.max(q>>>0,Math.ceil(1.2*U)),X=Math.ceil((W-U)/65536);try{return P.grow(X),O(),!0}catch{return!1}},b:B}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(w,G):w.then(q=>q.arrayBuffer()).then(q=>WebAssembly.instantiate(q,G))).then(q=>{const{Rb:U,Qb:W,P:X,T:ee,X:ae,Ja:oe,La:se,Qa:ye,Va:le,Wa:ve,eb:Se,jb:we,f:Ae,e:Pe,yb:ke,zb:Ce,Ab:Ze,Bb:tt,Db:$e,Gb:gt}=q.instance.exports;P=Pe;const mt=(()=>{let st=0,nt=0,It=0,yt=0;return wt=>{It&&(U(yt),U(st),nt+=It,It=st=0),st||(nt+=128,st=W(nt));const $t=wt.length+7&-8;let ni=st;$t>=nt&&(It=$t,ni=yt=W($t));for(let ri=0;ri<wt.length;ri++)M[ni+ri]=wt[ri];return ni}})();return O(),Ae(),{memory:Pe,_free:U,_malloc:W,Mesh:class{constructor(){this.ptr=X()}destroy(){ee(this.ptr)}},Decoder:class{constructor(){this.ptr=oe()}destroy(){we(this.ptr)}DecodeArrayToMesh(st,nt,It){const yt=mt(st),wt=se(this.ptr,yt,nt,It.ptr);return!!ae(wt)}GetAttributeByUniqueId(st,nt){return{ptr:ye(this.ptr,st.ptr,nt)}}GetTrianglesUInt16Array(st,nt,It){le(this.ptr,st.ptr,nt,It)}GetTrianglesUInt32Array(st,nt,It){ve(this.ptr,st.ptr,nt,It)}GetAttributeDataArrayForAllPoints(st,nt,It,yt,wt){Se(this.ptr,st.ptr,nt.ptr,It,yt,wt)}},DT_INT8:ke(),DT_UINT8:Ce(),DT_INT16:Ze(),DT_UINT16:tt(),DT_UINT32:$e(),DT_FLOAT32:gt()}})}(fetch(fy())),vp.then(w=>{Ca=w,vp=void 0}))}()),A&&g.push(function(){if(mm)return;const w=function(M){let P;const O=WebAssembly.instantiateStreaming(M,{}).then(q=>{P=q.instance,P.exports.__wasm_call_ctors()}),B={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},G={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:O,supported:!0,decodeGltfBuffer(q,U,W,X,ee,ae){!function(oe,se,ye,le,ve,Se,we){const Ae=oe.exports.sbrk,Pe=le+3&-4,ke=Ae(Pe*ve),Ce=Ae(Se.length),Ze=new Uint8Array(oe.exports.memory.buffer);Ze.set(Se,Ce);const tt=se(ke,le,ve,Ce,Se.length);if(0===tt&&we&&we(ke,Pe,ve),ye.set(Ze.subarray(ke,ke+le*ve)),Ae(ke-Ae(0)),0!==tt)throw new Error(`Malformed buffer data: ${tt}`)}(P,P.exports[G[ee]],q,U,W,X,P.exports[B[ae]])}}}(fetch(my()));return w.ready.then(()=>{mm=w})}()),a)for(let w=0;w<a.length;w++)g.push(ov(a[w],s,w,i));return(g.length?Promise.all(g):Promise.resolve()).then(()=>{if(S&&u)for(const{primitives:w}of u)for(const M of w)nv(M,s);if(A&&u&&T)for(const w of T)rv(w,s);return s})})}function Cu(r,e){const i=r.json.bufferViews[e.bufferView],s=mf[e.componentType];return new s(r.buffers[i.buffer],(e.byteOffset||0)+(i.byteOffset||0),e.count*(i.byteStride&&i.byteStride!==bp[e.type]*s.BYTES_PER_ELEMENT?i.byteStride/s.BYTES_PER_ELEMENT:bp[e.type]))}function gm(r,e,i,s){const h=mf[e.componentType],a=function(g){switch(g){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}}(h),u=r.json.bufferViews[e.bufferView],x=u.byteStride?u.byteStride/h.BYTES_PER_ELEMENT:bp[e.type],T=i.float32,C=T.length/i.capacity;for(let g=0,S=0;g<e.count*x;g+=x,S+=C)for(let A=0;A<C;A++)T[S+A]=s[g+A]*a;i._trim()}function av(r,e,i){const s=r.indices,h=r.attributes,a={};a.indexArray=new Ln;const u=e.json.accessors[s],x=u.count/3;a.indexArray.reserve(x);const T=Cu(e,u);for(let A=0;A<x;A++)a.indexArray.emplaceBack(T[3*A],T[3*A+1],T[3*A+2]);a.indexArray._trim(),a.vertexArray=new Fs;const C=e.json.accessors[h.POSITION];a.vertexArray.reserve(C.count);const g=Cu(e,C);for(let A=0;A<C.count;A++)a.vertexArray.emplaceBack(g[3*A],g[3*A+1],g[3*A+2]);if(a.vertexArray._trim(),a.aabb=new Pt(C.min,C.max),a.centroid=function(A,w){const M=[0,0,0],P=A.length;if(P>0){for(let O=0;O<P;O++){const B=3*A[O];M[0]+=w[B],M[1]+=w[B+1],M[2]+=w[B+2]}M[0]/=P,M[1]/=P,M[2]/=P}return M}(T,g),void 0!==h.COLOR_0){const A=e.json.accessors[h.COLOR_0],w=bp[A.type],M=Cu(e,A);a.colorArray=3===w?new Fs:new Oo,a.colorArray.resize(A.count),gm(e,A,a.colorArray,M)}if(void 0!==h.NORMAL){a.normalArray=new Fs;const A=e.json.accessors[h.NORMAL];a.normalArray.resize(A.count);const w=Cu(e,A);gm(e,A,a.normalArray,w)}if(void 0!==h.TEXCOORD_0&&i.length>0){a.texcoordArray=new ao;const A=e.json.accessors[h.TEXCOORD_0];a.texcoordArray.resize(A.count);const w=Cu(e,A);gm(e,A,a.texcoordArray,w)}if(void 0!==h._FEATURE_ID_RGBA4444){const A=e.json.accessors[h._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(a.featureData=Cu(e,A))}void 0!==h._FEATURE_RGBA4444&&(a.featureData=new Uint32Array(Cu(e,e.json.accessors[h._FEATURE_RGBA4444]).buffer));const S=r.material;return a.material=function(A,w){const{emissiveFactor:M=[0,0,0],alphaMode:P="OPAQUE",alphaCutoff:O=.5,normalTexture:B,occlusionTexture:G,emissiveTexture:q,doubleSided:U}=A,{baseColorFactor:W=[1,1,1,1],metallicFactor:X=1,roughnessFactor:ee=1,baseColorTexture:ae,metallicRoughnessTexture:oe}=A.pbrMetallicRoughness||{},se=G?w[G.index]:void 0;if(G&&G.extensions&&G.extensions.KHR_texture_transform&&se){const ye=G.extensions.KHR_texture_transform;se.offsetScale=[ye.offset[0],ye.offset[1],ye.scale[0],ye.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new Ri(...W),metallicFactor:X,roughnessFactor:ee,baseColorTexture:ae?w[ae.index]:void 0,metallicRoughnessTexture:oe?w[oe.index]:void 0},doubleSided:U,emissiveFactor:M,alphaMode:P,alphaCutoff:O,normalTexture:B?w[B.index]:void 0,occlusionTexture:se,emissionTexture:q?w[q.index]:void 0,defined:void 0===A.defined}}(void 0!==S?e.json.materials[S]:{defined:!1},i),a}function wy(r,e,i){const{matrix:s,rotation:h,translation:a,scale:u,mesh:x,extras:T,children:C}=r,g={};if(g.matrix=s||Ie.mat4.fromRotationTranslationScale([],h||[0,0,0,1],a||[0,0,0],u||[1,1,1]),void 0!==x){g.meshes=i[x];const S=g.anchor=[0,0];for(const A of g.meshes){const{min:w,max:M}=A.aabb;S[0]+=w[0]+M[0],S[1]+=w[1]+M[1]}S[0]=Math.floor(S[0]/g.meshes.length/2),S[1]=Math.floor(S[1]/g.meshes.length/2)}if(T&&(T.id&&(g.id=T.id),T.lights&&(g.lights=function(S){if(!S.length)return[];const A=function(B){const G=atob(B),q=new Uint8Array(G.length);for(let U=0;U<G.length;U++)q[U]=G.codePointAt(U);return q}(S),w=[],M=A.length/24,P=new Uint16Array(A.buffer),O=new Float32Array(A.buffer);for(let B=0;B<M;B++){const G=P[2*B*6]/30,q=P[2*B*6+1]/30,U=P[2*B*6+10]/100,W=O[6*B+1],X=O[6*B+2],ee=O[6*B+3],ae=O[6*B+4],oe=ee-W,se=ae-X,ye=Math.hypot(oe,se);w.push({pos:[W+.5*oe,X+.5*se,q],normal:[se/ye,-oe/ye,0],width:ye,height:G,depth:U,points:[W,X,ee,ae]})}return w}(T.lights))),C){const S=[];for(const A of C)S.push(wy(e.json.nodes[A],e,i));g.children=S}return g}function lv(r){if(0===r.vertices.length||0===r.indices.length)return null;const e=new xf(r.vertices,r.indices,8,256),[i,s]=[e.min.clone(),e.max.clone()];return{vertices:r.vertices,indices:r.indices,grid:e,min:i,max:s}}function cv(r){if(!r.extras||!r.extras.ground)return null;const e=r.extras.ground;if(!e||!Array.isArray(e)||0===e.length)return null;const i=e[0];if(!i||!Array.isArray(i)||0===i.length)return null;const s=[];for(const u of i){if(!Array.isArray(u)||2!==u.length)continue;const x=u[0],T=u[1];"number"==typeof x&&"number"==typeof T&&s.push(new pt(x,T))}if(s.length<3)return null;s.length>1&&s[s.length-1].equals(s[0])&&s.pop();let h=0;for(let u=0;u<s.length;u++){const x=s[u],T=s[(u+1)%s.length],C=s[(u+2)%s.length];h+=(x.x-T.x)*(C.y-T.y)-(C.x-T.x)*(x.y-T.y)}h>0&&s.reverse();const a=K(s.flatMap(u=>[u.x,u.y]),[]);return 0===a.length?null:{vertices:s,indices:a}}function hv(r,e){const i=[],s=[];let h=0;const a=[];for(const u of r){h=i.length;const x=u.vertexArray.float32,T=u.indexArray.uint16;for(let C=0;C<u.vertexArray.length;C++)a[0]=x[3*C+0],a[1]=x[3*C+1],a[2]=x[3*C+2],Ie.vec3.transformMat4(a,a,e),i.push(new pt(a[0],a[1]));for(let C=0;C<3*u.indexArray.length;C++)s.push(T[C]+h)}if(s.length%3!=0)return null;for(let u=0;u<s.length;u+=3){const x=i[s[u+0]],T=i[s[u+1]],C=i[s[u+2]];(x.x-T.x)*(C.y-T.y)-(C.x-T.x)*(x.y-T.y)>0&&([s[u+1],s[u+2]]=[s[u+2],s[u+1]])}return{vertices:i,indices:s}}function Ty(r){const i=function(T,C){const g=[];for(const S of T.json.meshes){const A=[];for(const w of S.primitives)A.push(av(w,T,C));g.push(A)}return g}(r,function(T,C){const g=[],S=WebGL2RenderingContext;if(T.json.textures)for(const A of T.json.textures){const w={magFilter:S.LINEAR,minFilter:S.NEAREST,wrapS:S.REPEAT,wrapT:S.REPEAT};void 0!==A.sampler&&Object.assign(w,T.json.samplers[A.sampler]),g.push({image:C[A.source],sampler:w,uploaded:!1})}return g}(r,r.images)),{scenes:s,scene:h,nodes:a}=r.json,u=s?s[h||0].nodes:a,x=[];for(const T of u)x.push(wy(a[T],r,i));return function(T,C,g){const S={},A=new Set;for(let w=0;w<T.length;w++){const M=g[C[w]];if(!M.extras)continue;const P=M.extras["mapbox:footprint:version"],O=M.extras["mapbox:footprint:id"];(P||O)&&A.add(w),"1.0.0"===P&&O&&(S[O]=w)}for(let w=0;w<T.length;w++){if(A.has(w))continue;const M=T[w],P=g[C[w]];if(!P.extras)continue;let O=null;M.id in S&&(O=hv(T[S[M.id]].meshes,M.matrix)),O||(O=cv(P)),O&&(M.footprint=lv(O))}if(A.size>0){const w=Array.from(A.values()).sort((M,P)=>M-P);for(let M=w.length-1;M>=0;M--)T.splice(w[M],1)}}(x,u,r.json.nodes),x}function uv(r){r.heightmap=new Float32Array(4096),r.heightmap.fill(-1);const e=r.vertexArray.float32,i=r.aabb.min[0]-1,s=r.aabb.min[1]-1,h=64/(r.aabb.max[0]-i+2),a=64/(r.aabb.max[1]-s+2);for(let u=0;u<e.length;u+=3){const x=e[u+2],T=(e[u+0]-i)*h|0,C=(e[u+1]-s)*a|0;x>r.heightmap[64*C+T]&&(r.heightmap[64*C+T]=x)}}function dv(r,e){const i={};i.indexArray=new Ln,i.indexArray.reserve(4*r.length),i.vertexArray=new Fs,i.vertexArray.reserve(10*r.length),i.colorArray=new Oo,i.vertexArray.reserve(10*r.length);let s=0;for(const u of r){const x=Math.min(10,Math.max(4,1.3*u.height))*e,T=[-u.normal[1],u.normal[0],0],C=Math.min(.29,.1*u.width/u.depth),g=u.width-2*u.depth*e*(C+.01),S=Ie.vec3.scaleAndAdd([],u.pos,T,g/2),A=Ie.vec3.scaleAndAdd([],u.pos,T,-g/2),w=[S[0],S[1],S[2]+u.height],M=[A[0],A[1],A[2]+u.height],P=Ie.vec3.scaleAndAdd([],u.normal,T,C);Ie.vec3.scale(P,P,x);const O=Ie.vec3.scaleAndAdd([],u.normal,T,-C);Ie.vec3.scale(O,O,x),Ie.vec3.add(P,S,P),Ie.vec3.add(O,A,O),S[2]+=.1,A[2]+=.1,i.vertexArray.emplaceBack(P[0],P[1],P[2]),i.vertexArray.emplaceBack(O[0],O[1],O[2]),i.vertexArray.emplaceBack(S[0],S[1],S[2]),i.vertexArray.emplaceBack(A[0],A[1],A[2]),i.vertexArray.emplaceBack(w[0],w[1],w[2]),i.vertexArray.emplaceBack(M[0],M[1],M[2]),i.vertexArray.emplaceBack(S[0],S[1],S[2]),i.vertexArray.emplaceBack(A[0],A[1],A[2]),i.vertexArray.emplaceBack(P[0],P[1],P[2]),i.vertexArray.emplaceBack(O[0],O[1],O[2]);const B=g/x/2;i.colorArray.emplaceBack(-B-C,-1,B,.8),i.colorArray.emplaceBack(B+C,-1,B,.8),i.colorArray.emplaceBack(-B,0,B,1.3),i.colorArray.emplaceBack(B,0,B,1.3),i.colorArray.emplaceBack(B+C,-.8,B,.7),i.colorArray.emplaceBack(B+C,-.8,B,.7),i.colorArray.emplaceBack(0,0,B,1.3),i.colorArray.emplaceBack(0,0,B,1.3),i.colorArray.emplaceBack(B+C,-1.2,B,.8),i.colorArray.emplaceBack(B+C,-1.2,B,.8),i.indexArray.emplaceBack(6+s,4+s,8+s),i.indexArray.emplaceBack(7+s,9+s,5+s),i.indexArray.emplaceBack(0+s,1+s,2+s),i.indexArray.emplaceBack(1+s,3+s,2+s),s+=10}const h={defined:!0,emissiveFactor:[0,0,0]},a={};return a.baseColorFactor=Ri.white,h.pbrMetallicRoughness=a,i.material=h,i.aabb=new Pt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}class Sy{constructor(e){this._stringToNumber={},this._numberToString=[];for(let i=0;i<e.length;i++){const s=e[i];this._stringToNumber[s]=i,this._numberToString[i]=s}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}const pv=["id","tile","layer","source","sourceLayer","state"];class Id{constructor(e,i,s,h,a){this.type="Feature",this._vectorTileFeature=e,this._z=i,this._x=s,this._y=h,this.properties=e.properties,this.id=a}clone(){const e=new Id(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const i of pv)void 0!==this[i]&&(e[i]=this[i]);return e}}class My{constructor(e,i){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new da(ft,16,0),this.featureIndexArray=new Bo,this.promoteId=i,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,i,s,h,a,u=0,x=0){const T=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(s,h,a,u);const C=this.grid;for(let g=0;g<i.length;g++){const S=i[g],A=[1/0,1/0,-1/0,-1/0];for(let w=0;w<S.length;w++){const M=S[w];A[0]=Math.min(A[0],M.x),A[1]=Math.min(A[1],M.y),A[2]=Math.max(A[2],M.x),A[3]=Math.max(A[3],M.y)}0!==x&&(A[0]-=x,A[1]-=x,A[2]+=x,A[3]+=x),A[0]<ft&&A[1]<ft&&A[2]>=0&&A[3]>=0&&C.insert(T,A[0],A[1],A[2],A[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new fd.VectorTile(new Bp(this.rawTileData)).layers,this.sourceLayerCoder=new Sy(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,i){const{tilespaceGeometry:s,transform:h,tileTransform:a,pixelPosMatrix:u,availableImages:x}=i;this.loadVTLayers(),this.serializedLayersCache.clear();const T=s.bufferedTilespaceBounds,C=this.grid.query(T.min.x,T.min.y,T.max.x,T.max.y,(w,M,P,O)=>be(s.bufferedTilespaceGeometry,w,M,P,O));C.sort(fv);let g=null;h.elevation&&C.length>0&&(g=bd.create(h.elevation,this.tileID));const S={};let A;for(let w=0;w<C.length;w++){const M=C[w];if(M===A)continue;A=M;const P=this.featureIndexArray.get(M);let O=null;this.is3DTile?this.loadMatchingModelFeature(S,P,e,s,h):this.loadMatchingFeature(S,P,e,x,(B,G,q,U=0)=>(O||(O=k(B,this.tileID.canonical,a)),G.queryIntersectsFeature(s,B,q,O,this.z,h,u,g,U)))}return S}loadMatchingFeature(e,i,s,h,a){const{featureIndex:u,bucketIndex:x,sourceLayerIndex:T,layoutVertexArrayOffset:C}=i,g=this.bucketLayerIDs[x],S=s.layers,A=Object.keys(S);if(A.length&&!function(B,G){for(let q=0;q<B.length;q++)if(G.indexOf(B[q])>=0)return!0;return!1}(A,g))return;const w=s.sourceCache,M=this.sourceLayerCoder.decode(T),P=this.vtLayers[M].feature(u),O=this.getId(P,M);for(let B=0;B<g.length;B++){const G=g[B];if(!S[G])continue;const{styleLayer:q,targets:U}=S[G];let W={};void 0!==O&&(W=w.getFeatureState(q.sourceLayer,O));const X=!a||a(P,q,W,C);if(!X)continue;const ee=new Id(P,this.z,this.x,this.y,O);ee.tile=this.tileID.canonical,ee.state=W;let ae=this.serializedLayersCache.get(G);ae||(ae=q.serialize(),ae.id=G,this.serializedLayersCache.set(G,ae)),ee.source=ae.source,ee.sourceLayer=ae["source-layer"],ee.layer=Hi({},ae),ee.layer.paint=Ey(ae.paint,q.paint,P,W,h),ee.layer.layout=Ey(ae.layout,q.layout,P,W,h);let oe=!1;for(const se of U){this.updateFeatureProperties(ee,se);const{filter:ye}=se;if(ye)if(P.properties=ee.properties,ye.needGeometry){const le=N(P,!0);if(!ye.filter(new Zi(this.tileID.overscaledZ),le,this.tileID.canonical))continue}else if(!ye.filter(new Zi(this.tileID.overscaledZ),P))continue;oe=!0,se.targetId&&this.addFeatureVariant(ee,se)}oe&&this.appendToResult(e,G,u,ee,X)}}loadMatchingModelFeature(e,i,s,h,a){const u=this.bucketLayerIDs[0][0],x=s.layers;if(!x[u])return;const{styleLayer:T,targets:C}=x[u];if("model"!==T.type)return;const g=h.tile,S=i.featureIndex,A=g.getBucket(T);if(!(A&&A instanceof of))return;const w=function(ae,oe,se,ye){const le=ae.getNodesInfo()[oe];if(le.hiddenByReplacement||!le.node.meshes)return;let ve=Number.MAX_VALUE;const Se=le.node,we=se.tile,Ae=ye.calculatePosMatrix(we.tileID.toUnwrapped(),ye.worldSize),Pe=le.evaluatedScale;let ke=0;ye.elevation&&Se.elevation&&(ke=Se.elevation*ye.elevation.exaggeration()),Ie.mat4.translate(Ae,Ae,[(Se.anchor?Se.anchor[0]:0)*(Pe[0]-1),(Se.anchor?Se.anchor[1]:0)*(Pe[1]-1),ke]),Ie.mat4.scale(Ae,Ae,Pe);const Ce=se.queryGeometry,Ze=Ce.isPointQuery()?Ce.screenBounds:Ce.screenGeometry,tt=function(gt){const mt=Ie.mat4.multiply([],Ae,gt.matrix);Ie.mat4.multiply(mt,ye.expandedFarZProjMatrix,mt);for(let st=0;st<gt.meshes.length;++st){const nt=gt.meshes[st];if(st===gt.lightMeshIndex)continue;const It=Sg(Ze,ye,mt,nt.aabb);null!=It&&(ve=Math.min(It,ve))}if(gt.children)for(const st of gt.children)tt(st)};if(tt(Se),ve===Number.MAX_VALUE)return;const $e=new Ci(0,0);return Og(we.tileID.canonical,$e,le.node.anchor[0],le.node.anchor[1]),{intersectionZ:ve,position:$e,feature:le.feature}}(A,S,h,a);if(!w)return;const{z:M,x:P,y:O}=g.tileID.canonical,{feature:B,intersectionZ:G,position:q}=w;let U={};void 0!==B.id&&(U=s.sourceCache.getFeatureState(T.sourceLayer,B.id));const W=new Id({},M,P,O,B.id);W.tile=this.tileID.canonical,W.state=U,W.properties=B.properties,W.geometry={type:"Point",coordinates:[q.lng,q.lat]};let X=this.serializedLayersCache.get(u);X||(X=T.serialize(),X.id=u,this.serializedLayersCache.set(u,X)),W.source=X.source,W.sourceLayer=X["source-layer"],W.layer=Hi({},X);let ee=!1;for(const ae of C){this.updateFeatureProperties(W,ae);const{filter:oe}=ae;if(oe)if(B.properties=W.properties,oe.needGeometry){if(!oe.filter(new Zi(this.tileID.overscaledZ),B,this.tileID.canonical))continue}else if(!oe.filter(new Zi(this.tileID.overscaledZ),B))continue;ee=!0,ae.targetId&&this.addFeatureVariant(W,ae)}ee&&this.appendToResult(e,u,S,W,G)}updateFeatureProperties(e,i,s){if(i.properties){const h={};for(const a in i.properties){const u=i.properties[a].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,s);null!=u&&(h[a]=u)}e.properties=h}}addFeatureVariant(e,i,s){const h={target:i.target,namespace:i.namespace,uniqueFeatureID:i.uniqueFeatureID};i.properties&&(h.properties=e.properties),e.variants=e.variants||{},e.variants[i.targetId]=e.variants[i.targetId]||[],e.variants[i.targetId].push(h)}appendToResult(e,i,s,h,a){let u=e[i];void 0===u&&(u=e[i]=[]),u.push({featureIndex:s,feature:h,intersectionZ:a})}lookupSymbolFeatures(e,i,s,h,a){const u={};this.loadVTLayers();for(const x of e)this.loadMatchingFeature(u,{bucketIndex:i,sourceLayerIndex:s,featureIndex:x,layoutVertexArrayOffset:0},h,a);return u}loadFeature(e){const{featureIndex:i,sourceLayerIndex:s}=e;this.loadVTLayers();const h=this.sourceLayerCoder.decode(s),a=this.vtFeatures[h];if(a[i])return a[i];const u=this.vtLayers[h].feature(i);return a[i]=u,u}hasLayer(e){for(const i of this.bucketLayerIDs)for(const s of i)if(e===s)return!0;return!1}getId(e,i){let s=e.id;if(this.promoteId){const h=Array.isArray(this.promoteId)||"object"!=typeof this.promoteId?this.promoteId:this.promoteId[i];if(null!=h)if(Array.isArray(h)){if(!this.promoteIdExpression){const a=ua(h);if("success"!==a.result)return void ii(`Failed to create expression for promoteId: ${a.value.map(x=>`${x.key}: ${x.message}`).join(", ")}`);this.promoteIdExpression=a.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new wh),s=this.promoteIdExpression.evaluate({zoom:0},e)}else s=e.properties[h];"boolean"==typeof s&&(s=Number(s))}return s}}function Ey(r,e,i,s,h){return Ki(r,(a,u)=>{const x=e instanceof Ls?e.get(u):null;return x&&x.evaluate?x.evaluate(i,s,h):x})}function fv(r,e){return e-r}St(My,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const Ay=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class ym{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[i,s]=new Uint8Array(e,0,2);if(219!==i)throw new Error("Data does not appear to be in a KDBush format.");const h=s>>4;if(1!==h)throw new Error(`Got v${h} data when expected v1.`);const a=Ay[15&s];if(!a)throw new Error("Unrecognized array type.");const[u]=new Uint16Array(e,2,1),[x]=new Uint32Array(e,4,1);return new ym(x,u,a,e)}constructor(e,i=64,s=Float64Array,h){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=s,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const a=Ay.indexOf(this.ArrayType),u=2*e*this.ArrayType.BYTES_PER_ELEMENT,x=e*this.IndexArrayType.BYTES_PER_ELEMENT,T=(8-x%8)%8;if(a<0)throw new Error(`Unexpected typed array class: ${s}.`);h&&h instanceof ArrayBuffer?(this.data=h,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+x+T,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+u+x+T),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+x+T,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+a]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=e)}add(e,i){const s=this._pos>>1;return this.ids[s]=s,this.coords[this._pos++]=e,this.coords[this._pos++]=i,s}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return xm(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,i,s,h){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:a,coords:u,nodeSize:x}=this,T=[0,a.length-1,0],C=[];for(;T.length;){const g=T.pop()||0,S=T.pop()||0,A=T.pop()||0;if(S-A<=x){for(let O=A;O<=S;O++){const B=u[2*O],G=u[2*O+1];B>=e&&B<=s&&G>=i&&G<=h&&C.push(a[O])}continue}const w=A+S>>1,M=u[2*w],P=u[2*w+1];M>=e&&M<=s&&P>=i&&P<=h&&C.push(a[w]),(0===g?e<=M:i<=P)&&(T.push(A),T.push(w-1),T.push(1-g)),(0===g?s>=M:h>=P)&&(T.push(w+1),T.push(S),T.push(1-g))}return C}within(e,i,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:h,coords:a,nodeSize:u}=this,x=[0,h.length-1,0],T=[],C=s*s;for(;x.length;){const g=x.pop()||0,S=x.pop()||0,A=x.pop()||0;if(S-A<=u){for(let O=A;O<=S;O++)Cy(a[2*O],a[2*O+1],e,i)<=C&&T.push(h[O]);continue}const w=A+S>>1,M=a[2*w],P=a[2*w+1];Cy(M,P,e,i)<=C&&T.push(h[w]),(0===g?e-s<=M:i-s<=P)&&(x.push(A),x.push(w-1),x.push(1-g)),(0===g?e+s>=M:i+s>=P)&&(x.push(w+1),x.push(S),x.push(1-g))}return T}}function xm(r,e,i,s,h,a){if(h-s<=i)return;const u=s+h>>1;Iy(r,e,u,s,h,a),xm(r,e,i,s,u-1,1-a),xm(r,e,i,u+1,h,1-a)}function Iy(r,e,i,s,h,a){for(;h>s;){if(h-s>600){const C=h-s+1,g=i-s+1,S=Math.log(C),A=.5*Math.exp(2*S/3),w=.5*Math.sqrt(S*A*(C-A)/C)*(g-C/2<0?-1:1);Iy(r,e,i,Math.max(s,Math.floor(i-g*A/C+w)),Math.min(h,Math.floor(i+(C-g)*A/C+w)),a)}const u=e[2*i+a];let x=s,T=h;for(wp(r,e,s,i),e[2*h+a]>u&&wp(r,e,s,h);x<T;){for(wp(r,e,x,T),x++,T--;e[2*x+a]<u;)x++;for(;e[2*T+a]>u;)T--}e[2*s+a]===u?wp(r,e,s,T):(T++,wp(r,e,T,h)),T<=i&&(s=T+1),i<=T&&(h=T-1)}}function wp(r,e,i,s){vm(r,i,s),vm(e,2*i,2*s),vm(e,2*i+1,2*s+1)}function vm(r,e,i){const s=r[e];r[e]=r[i],r[i]=s}function Cy(r,e,i,s){const h=r-i,a=e-s;return h*h+a*a}o.$=tu,o.A=rr,o.B=2,o.C=np,o.D=wd,o.E=Is,o.F=U_,o.G=class extends rf{},o.H=hr,o.I=cm,o.J=xo,o.K=Lo,o.L=tl,o.M=Wl,o.N=el,o.O=ha,o.P=pt,o.Q=_a,o.R=ui,o.S=Ju,o.T=Xf,o.U=ua,o.V=rf,o.W=Za,o.X=sa,o.Y=Fr,o.Z=Rn,o._=ss,o.a=function(r){return En.API_CDN_URL_REGEX.test(r)},o.a$=Id,o.a0=Xh,o.a1=Zu,o.a2=function(r){const e=r.value;let i=[];if(!e)return i;const s=hr(e);return"string"!==s?(i=i.concat([new rf(r.key,e,`string expected, "${s}" found`)]),i):(Eg(e,!0)||(i=i.concat([new rf(r.key,e,`invalid url "${e}"`)])),i)},o.a3=Ne,o.a4=Ql,o.a5=cn,o.a6=at,o.a7=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return Or(r.expression.evaluate(e))}interpolate(r,e,i){return{x:Ut(r.x,e.x,i),y:Ut(r.y,e.y,i),z:Ut(r.z,e.z,i),azimuthal:Ut(r.azimuthal,e.azimuthal,i),polar:Ut(r.polar,e.polar,i)}}},o.a8=Zi,o.a9=Zl,o.aA=cs,o.aB=class{constructor(r){this.entries={},this.scheduler=r}request(r,e,i,s){const h=this.entries[r]=this.entries[r]||{callbacks:[]};if(h.result){const[a,u]=h.result;return this.scheduler?this.scheduler.add(()=>{s(a,u)},e):s(a,u),()=>{}}return h.callbacks.push(s),h.cancel||(h.cancel=i((a,u)=>{h.result=[a,u];for(const x of h.callbacks)this.scheduler?this.scheduler.add(()=>{x(a,u)},e):x(a,u);setTimeout(()=>delete this.entries[r],3e3)})),()=>{h.result||(h.callbacks=h.callbacks.filter(a=>a!==s),h.callbacks.length||(h.cancel(),delete this.entries[r]))}}},o.aC=ks,o.aD=function(r,e,i){const s=JSON.stringify(r.request);return r.data&&(this.deduped.entries[s]={result:[null,r.data]}),this.deduped.request(s,{type:"parseTile",isSymbolTile:r.isSymbolTile,zoom:r.tileZoom},h=>{const a=Nn(r.request,(u,x,T,C)=>{u?h(u):x&&h(null,{vectorTile:i?void 0:new fd.VectorTile(new Bp(x)),rawData:x,cacheControl:T,expires:C})});return()=>{a.cancel(),h()}},e)},o.aE=function(r){Rt++,Rt>Ve&&(r.getActor().send("enforceCacheSizeLimit",Me),Rt=0)},o.aF=function(r){return r<=1?1:Math.pow(2,Math.floor(Math.log(r)/Math.LN2))},o.aG=rt,o.aH=pg,o.aI=xg,o.aJ=dg,o.aK=function(r,e){const i=document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let s=0;s<r.length;s++){const h=document.createElement("source");ar(r[s])||(i.crossOrigin="Anonymous"),h.src=r[s],i.appendChild(h)}return{cancel:()=>{}}},o.aL=Jp,o.aM=function(r){return fetch(r).then(e=>e.arrayBuffer()).then(e=>by(e,0,r))},o.aN=Ty,o.aO=class{constructor(r,e,i,s){this.id=r,this.position=null!=e?new Ci(e[0],e[1]):new Ci(0,0),this.orientation=i??[0,0,0],this.nodes=s,this.uploaded=!1,this.aabb=new Pt([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(r,e){if(Ie.mat4.multiply(r.matrix,e,r.matrix),r.meshes)for(const i of r.meshes){const s=Pt.applyTransformFast(i.aabb,r.matrix);this.aabb.encapsulate(s)}if(r.children)for(const i of r.children)this._applyTransformations(i,r.matrix)}computeBoundsAndApplyParent(){const r=Ie.mat4.identity([]);for(const e of this.nodes)this._applyTransformations(e,r)}computeModelMatrix(r,e,i,s,h,a,u=!1){Dg(this.matrix,this,r.transform,this.position,e,i,s,h,a,u)}upload(r){if(!this.uploaded){for(const e of this.nodes)em(e,r);for(const e of this.nodes)sf(e);this.uploaded=!0}}destroy(){for(const r of this.nodes)tm(r)}},o.aP=Jo,o.aQ=op,o.aR=Vr,o.aS=$n,o.aT=Xr,o.aU=Ln,o.aV=Ti,o.aW=pu,o.aX=Yp,o.aY=function(){Zr.isLoading()||Zr.isLoaded()||"deferred"!==Gc()||Kl()},o.aZ=ed,o.a_=N,o.aa=n,o.ab=Ie,o.ac=Ai,o.ad=Ls,o.ae=Tr,o.af=Ut,o.ag=ft,o.ah=vh,o.ai=yi,o.aj=Ri,o.ak=class{constructor(r){this.specification=r}possiblyEvaluate(r,e){return function([i,s]){const h=Or([1,i,s]);return{x:h.x,y:h.y,z:h.z}}(r.expression.evaluate(e))}interpolate(r,e,i){return{x:Ut(r.x,e.x,i),y:Ut(r.y,e.y,i),z:Ut(r.z,e.z,i)}}},o.al=function(r,e,i=0,s=!0){const h=new pt(i,i),a=r.sub(h),u=e.add(h),x=[a,new pt(u.x,a.y),u,new pt(a.x,u.y)];return s&&x.push(a.clone()),x},o.am=function(r,e){const i=[];for(let s=0;s<r.length;s++){const h=Yi(s-1,-1,r.length-1),a=Yi(s+1,-1,r.length-1),u=r[s],x=r[a],T=r[h].sub(u).unit(),C=x.sub(u).unit(),g=C.angleWithSep(T.x,T.y),S=T.add(C).unit().mult(-1*e/Math.sin(g/2));i.push(u.add(S))}return i},o.an=J_,o.ao=be,o.ap=function(r,e,i=0){return Ie.vec3.fromValues(((e.x-i)*r.scale-r.x)*ft,(e.y*r.scale-r.y)*ft,pd(e.z,e.y))},o.aq=Zt,o.ar=__,o.as=function(r){let e=1/0,i=1/0,s=-1/0,h=-1/0;for(const a of r)e=Math.min(e,a.x),i=Math.min(i,a.y),s=Math.max(s,a.x),h=Math.max(h,a.y);return{min:new pt(e,i),max:new pt(s,h)}},o.at=Us,o.au=de,o.av=p,o.aw=ai,o.ax=wr,o.ay=function(r,e){const i={};for(let s=0;s<e.length;s++){const h=e[s];h in r&&(i[h]=r[h])}return i},o.az=Go,o.b=function(r){return En.API_FONTS_REGEX.test(r)},o.b$=tf,o.b0=Qo,o.b1=If,o.b2=Sa,o.b3=k,o.b4=Os,o.b5=hu,o.b6=kt,o.b7=vn,o.b8=K,o.b9=Wf,o.bA=Zm,o.bB=Vf,o.bC=Z_,o.bD=Ff,o.bE=ym,o.bF=Yi,o.bG=Va,o.bH=fr,o.bI=function(r,e,i){r[4*e+0]=i[0],r[4*e+1]=i[1],r[4*e+2]=i[2],r[4*e+3]=i[3]},o.bJ=fl,o.bK=Yr,o.bL=pl,o.bM=bn,o.bN=dl,o.bO=Ci,o.bP=ng,o.bQ=Ke,o.bR=Ei,o.bS=bg,o.bT=et,o.bU=mr,o.bV=function(r,e,i,s,h,a,u,x,T){if("globe"===T.name)return mr(r,e,new et(i,s,h),!1);const C=op({z:i,x:s,y:h},T);return new Pt([(a+C.x/C.scale)*e,e*(C.y/C.scale),u],[(a+C.x2/C.scale)*e,e*(C.y2/C.scale),x])},o.bW=function(r,e,i){let s=0;for(let h=0;h<2;++h)r[h]>0&&(s+=(r[h]-0)*(r[h]-0)),e[h]<0&&(s+=(0-e[h])*(0-e[h]));return s},o.bX=_n,o.bY=6,o.bZ=function(r){const e=Ie.mat4.identity(new Float64Array(16));Ie.mat4.multiply(e,r.pixelMatrix,r.globeMatrix);const i=[0,Kr,0],s=[0,Jr,0];return Ie.vec3.transformMat4(i,i,e),Ie.vec3.transformMat4(s,s,e),[i[0]>0&&i[0]<=r.width&&i[1]>0&&i[1]<=r.height&&!Dr(r,new Ci(r.center.lat,90)),s[0]>0&&s[0]<=r.width&&s[1]>0&&s[1]<=r.height&&!Dr(r,new Ci(r.center.lat,-90))]},o.b_=function(r,e){const{scale:i}=r.tileTransform,s=i*ft/(r.tileSize*Math.pow(2,e.zoom-r.tileID.overscaledZ+r.tileID.canonical.z));return Ie.mat2.scale(new Float32Array(4),e.inverseAdjustmentMatrix,[s,s])},o.ba=function(r,e){const i=Tr(e.zoom);if(0===i)return An(r);const s=dn(r),h=ji(s),a=Us(s.getWest())*e.worldSize,u=Us(s.getEast())*e.worldSize,x=cs(s.getNorth())*e.worldSize,T=cs(s.getSouth())*e.worldSize,C=[a,x,0],g=[u,x,0],S=[a,T,0],A=[u,T,0],w=Ie.mat4.invert([],e.globeMatrix);return Ie.vec3.transformMat4(C,C,w),Ie.vec3.transformMat4(g,g,w),Ie.vec3.transformMat4(S,S,w),Ie.vec3.transformMat4(A,A,w),h[0]=Mn(h[0],S,i),h[1]=Mn(h[1],A,i),h[2]=Mn(h[2],g,i),h[3]=Mn(h[3],C,i),Pt.fromPoints(h)},o.bb=kn,o.bc=vi,o.bd=Mn,o.be=ro,o.bf=Lt,o.bg=pm,o.bh=Bp,o.bi=Nn,o.bj=function(r){const e=[];for(const i in r)e.push(r[i]);return e},o.bk=function(r,e){const i=[];for(const s in r)s in e||i.push(s);return i},o.bl=zi,o.bm=["type","source","source-layer","minzoom","maxzoom","filter","layout"],o.bn=Fn,o.bo=function(r,e){const{x:i,y:s}=r.point,h=Ur(i,s,r.worldSize/r._pixelsPerMercatorPixel,0,0);return Ie.mat4.multiply(h,h,Xi(An(e)))},o.bp=md,o.bq=lo,o.br=Fp,o.bs=function(r,e,i,s,h){const a=5*e+2;r.float32[a+0]=i,r.float32[a+1]=s,r.float32[a+2]=h},o.bt=Xp,o.bu=V_,o.bv=Z,o.bw=24,o.bx=jm,o.by=Mg,o.bz=$m,o.c=pn,o.c$=(r,e,i,s,h,a,u,x)=>{const T=r.transform,C=T.pitch<15?g_(.07,.7,ai((14-T.zoom)/5,0,1)):.07,g="none"===i.paint.get("line-trim-color-use-theme").constantOr("default");return{u_matrix:x_(r,e,i,s),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:T.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:h,u_width_scale:a,u_floor_width_scale:u,u_image:0,u_tile_units_to_pixels:y_(e,T),u_units_to_pixels:[1/T.pixelsToGLUnits[0],1/T.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:x,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toRenderColor(g?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:C,u_tile_to_meter:t(e.tileID.canonical,0)}},o.c0=vg,o.c1=function(r){const e=vg(r,!0);return Ie.mat2.invert([],[e[0],e[1],e[4],e[5]])},o.c2=di,o.c3=function(r){const{x:e,y:i}=r.point,{lng:s,lat:h}=r._center;return Ur(e,i,r.worldSize,s,h)},o.c4=Hn,o.c5=ct,o.c6=5,o.c7=function(r){const e=Math.round((r+45+360)%360/90)%4;return is[e]},o.c8=45,o.c9=yl,o.cA=class extends ls{constructor(r){super(r),this.current=gu}set(r,e,i){if(this.fetchUniformLocation(r,e))for(let s=0;s<9;s++)if(i[s]!==this.current[s]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}},o.cB=Gr,o.cC=function(r,e,i){const s=Tr(i.zoom),h=r.style.map._antialias,a=r.terrain&&r.terrain.exaggeration()>0;return 0===s&&!h&&!a},o.cD=function(r){const e=r.pixelsPerMeter,i=e/fr(1,r.center.lat),s=Ie.mat4.identity(new Float64Array(16));return Ie.mat4.translate(s,s,[r.point.x,r.point.y,0]),Ie.mat4.scale(s,s,[i,i,e]),Float32Array.from(s)},o.cE=dn,o.cF=function(r){const e=_n-5;r=ai(r,-e,e)/e*90;const i=Math.pow(Math.abs(Math.sin(yi(r))),3);return Math.round(i*(nh.length-1))},o.cG=function(r,e,i,s){const h=e.getNorth(),a=e.getSouth(),u=e.getWest(),x=e.getEast(),T=1<<r.z,C=x-u,g=h-a,S=C/64,A=-g/nh[i],w=[0,S,0,A,0,0,h,u,0];if(r.z>0){const M=180/s;Ie.mat3.multiply(w,w,[M/C+1,0,0,0,M/g+1,0,-.5*M/S,.5*M/A,1])}return w[2]=T,w[5]=r.x,w[8]=r.y,w},o.cH=An,o.cI=function(r,e,i){const s=Ie.mat4.identity(new Float64Array(16)),h=(e/(1<<r)-.5)*Math.PI*2;return Ie.mat4.rotateY(s,i.globeMatrix,h),Float32Array.from(s)},o.cJ=class{isDataAvailableAtPoint(r){const e=this._source();if(this.isUsingMockSource()||!e||r.y<0||r.y>1)return!1;const i=e.getSource().maxzoom,s=1<<i,h=Math.floor(r.x),a=Math.floor((r.x-h)*s),u=Math.floor(r.y*s),x=this.findDEMTileFor(new rt(i,h,i,a,u));return!(!x||!x.dem)}getAtPointOrZero(r,e=0){return this.getAtPoint(r,e)||0}getAtPoint(r,e,i=!0){if(this.isUsingMockSource())return null;null==e&&(e=null);const s=this._source();if(!s||r.y<0||r.y>1)return e;const h=s.getSource().maxzoom,a=1<<h,u=Math.floor(r.x),x=r.x-u,T=new rt(h,u,h,Math.floor(x*a),Math.floor(r.y*a)),C=this.findDEMTileFor(T);if(!C||!C.dem)return e;const g=C.dem,S=1<<C.tileID.canonical.z,A=(x*S-C.tileID.canonical.x)*g.dim,w=(r.y*S-C.tileID.canonical.y)*g.dim,M=Math.floor(A),P=Math.floor(w);return(i?this.exaggeration():1)*Ut(Ut(g.get(M,P),g.get(M,P+1),w-P),Ut(g.get(M+1,P),g.get(M+1,P+1),w-P),A-M)}getAtTileOffset(r,e,i){const s=1<<r.canonical.z;return this.getAtPointOrZero(new n(r.wrap+(r.canonical.x+e/ft)/s,(r.canonical.y+i/ft)/s))}getAtTileOffsetFunc(r,e,i,s){return h=>{const a=this.getAtTileOffset(r,h.x,h.y),u=s.upVector(r.canonical,h.x,h.y),x=s.upVectorScale(r.canonical,e,i).metersToTile;return Ie.vec3.scale(u,u,a*x),u}}getForTilePoints(r,e,i,s){if(this.isUsingMockSource())return!1;const h=bd.create(this,r,s);return!!h&&(e.forEach(a=>{a[2]=this.exaggeration()*h.getElevationAt(a[0],a[1],i)}),!0)}getMinMaxForTile(r){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(r);if(!e||!e.dem)return null;const i=e.dem.tree,s=e.tileID,h=1<<r.canonical.z-s.canonical.z;let a=r.canonical.x/h-s.canonical.x,u=r.canonical.y/h-s.canonical.y,x=0;for(let T=0;T<r.canonical.z-s.canonical.z&&!i.leaves[x];T++){a*=2,u*=2;const C=2*Math.floor(u)+Math.floor(a);x=i.childOffsets[x]+C,a%=1,u%=1}return{min:this.exaggeration()*i.minimums[x],max:this.exaggeration()*i.maximums[x]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(r,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(r){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(r){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const r=this.visibleDemTiles;if(0===r.length)return null;let e=!1,i=Number.MAX_VALUE,s=Number.MIN_VALUE;for(const h of r){const a=this.getMinMaxForTile(h.tileID);a&&(i=Math.min(i,a.min),s=Math.max(s,a.max),e=!0)}return e?{min:i,max:s}:null}},o.cK=z,o.cL=pi,o.cM=function(r,e){return[Math.pow(r[0],2.2)*e,Math.pow(r[1],2.2)*e,Math.pow(r[2],2.2)*e]},o.cN=es,o.cO=fs,o.cP=yo,o.cQ=256,o.cR=function(r,e){const i=[0,0,0],s=kn(An(e.canonical));return Ie.vec3.transformMat4(i,i,s),Ie.vec3.transformMat4(i,i,r),i},o.cS=r=>({u_camera_to_center_distance:new bn(r),u_extrude_scale:new yu(r),u_device_pixel_ratio:new bn(r),u_matrix:new fl(r),u_inv_rot_matrix:new fl(r),u_merc_center:new Yr(r),u_tile_id:new pl(r),u_zoom_transition:new bn(r),u_up_dir:new pl(r),u_emissive_strength:new bn(r)}),o.cT=r=>({u_matrix:new fl(r),u_pixels_to_tile_units:new yu(r),u_device_pixel_ratio:new bn(r),u_width_scale:new bn(r),u_floor_width_scale:new bn(r),u_units_to_pixels:new Yr(r),u_dash_image:new dl(r),u_gradient_image:new dl(r),u_image_height:new bn(r),u_texsize:new Yr(r),u_tile_units_to_pixels:new bn(r),u_alpha_discard_threshold:new bn(r),u_trim_offset:new Yr(r),u_trim_fade_range:new Yr(r),u_trim_color:new uc(r),u_emissive_strength:new bn(r),u_zbias_factor:new bn(r),u_tile_to_meter:new bn(r)}),o.cU=r=>({u_matrix:new fl(r),u_texsize:new Yr(r),u_pixels_to_tile_units:new yu(r),u_device_pixel_ratio:new bn(r),u_width_scale:new bn(r),u_floor_width_scale:new bn(r),u_image:new dl(r),u_units_to_pixels:new Yr(r),u_tile_units_to_pixels:new bn(r),u_alpha_discard_threshold:new bn(r),u_trim_offset:new Yr(r),u_trim_fade_range:new Yr(r),u_trim_color:new uc(r),u_emissive_strength:new bn(r),u_zbias_factor:new bn(r),u_tile_to_meter:new bn(r)}),o.cV=ou,o.cW=y0,o.cX=x0,o.cY=xl,o.cZ=(r,e,i,s,h,a)=>{const u=r.transform,x="globe"===u.projection.name;let T;if("map"===a.paint.get("circle-pitch-alignment"))if(x){const g=es(u.zoom,e.canonical)*u._pixelsPerMercatorPixel;T=Float32Array.from([g,0,0,g])}else T=u.calculatePixelsToTileUnitsMatrix(i);else T=new Float32Array([u.pixelsToGLUnits[0],0,0,u.pixelsToGLUnits[1]]);const C={u_camera_to_center_distance:r.transform.getCameraToCenterDistance(u.projection),u_matrix:r.translatePosMatrix(e.projMatrix,i,a.paint.get("circle-translate"),a.paint.get("circle-translate-anchor")),u_device_pixel_ratio:fe.devicePixelRatio,u_extrude_scale:T,u_inv_rot_matrix:Ta,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:a.paint.get("circle-emissive-strength")};if(x){C.u_inv_rot_matrix=s,C.u_merc_center=h,C.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],C.u_zoom_transition=Tr(u.zoom);const g=h[0]*ft,S=h[1]*ft;C.u_up_dir=u.projection.upVector(new et(0,0,0),g,S)}return C},o.c_=v_,o.ca=uc,o.cb=function(r,e,i){const s=Math.sqrt(r*r+e*e+i*i),h=s>0?Math.acos(i/s)*$s:0;let a=0!==r||0!==e?Math.atan2(-e,-r)*$s+90:0;return a<0&&(a+=360),[s,a,h]},o.cc=t,o.cd=Pt,o.ce=Or,o.cf=function(r){return[Math.pow(r[0],1/2.2),Math.pow(r[1],1/2.2),Math.pow(r[2],1/2.2)]},o.cg=function(r,e){return r.readFields(hx,{icons:[]},e)},o.ch=function(r){return r({pluginStatus:Nr,pluginURL:Ro}),il.on("pluginStateChange",r),r},o.ci=lf,o.cj=gd,o.ck=Bf,o.cl=ir,o.cm=xs,o.cn=Te,o.co=ns,o.cp=vr,o.cq=function(r){const e=r.indexOf("\x1f");return e>=0?r.slice(0,e):r},o.cr=function(r){return r.indexOf("\x1f")>=0},o.cs=function(r){const e=r.indexOf("\x1f");return e>=0?r.slice(e+1):""},o.ct=function(r){const e=[],i=r.id;return void 0===i&&e.push({message:`layers.${i}: missing required property "id"`}),void 0===r.render&&e.push({message:`layers.${i}: missing required method "render"`}),r.renderingMode&&"2d"!==r.renderingMode&&"3d"!==r.renderingMode&&e.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),e},o.cu=function(r,e,i,s){return"custom"===r.type?new Y0(r,e):new ax[r.type](r,e,i,s)},o.cv=Zs,o.cw=class extends Id{constructor(r,e){super(r._vectorTileFeature,r._z,r._x,r._y,r.id),r.state&&(this.state=Object.assign({},r.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=r.source,this.sourceLayer=r.sourceLayer,this.layer=r.layer)}toJSON(){const r=super.toJSON();return r.target=this.target,r.namespace=this.namespace,r}},o.cx=il,o.cy=zn,o.cz=ld,o.d=function(r){return En.API_TILEJSON_REGEX.test(r)},o.d$=My,o.d0=(r,e,i,s,h,a,u,x,T)=>{const C=r.transform,g=C.calculatePixelsToTileUnitsMatrix(e),S="none"===i.paint.get("line-trim-color-use-theme").constantOr("default"),A=C.pitch<15?g_(.07,.7,ai((14-C.zoom)/5,0,1)):.07;return{u_matrix:x_(r,e,i,s),u_pixels_to_tile_units:g,u_device_pixel_ratio:a,u_width_scale:u,u_floor_width_scale:x,u_units_to_pixels:[1/C.pixelsToGLUnits[0],1/C.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:h,u_texsize:b_(i)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:y_(e,r.transform),u_alpha_discard_threshold:0,u_trim_offset:T,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toRenderColor(S?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:A,u_tile_to_meter:t(e.tileID.canonical,0)}},o.d1=Ba,o.d2=R,o.d3=a_,o.d4=_t,o.d5=Op,o.d6=ah,o.d7=450,o.d8=7,o.d9=X0,o.dA=Ar,o.dB=l,o.dC=va,o.dD=function([r,e,i]){const s=Math.hypot(r,e,i),h=Math.atan2(r,i),a=.5*Math.PI-Math.acos(-e/s);return new Ci(Hn(h),Hn(a))},o.dE=Kf,o.dF=function(r){const e=r.navigator?r.navigator.userAgent:null;return!!function(i){if(null==Na){const s=i.navigator?i.navigator.userAgent:null;Na=!!i.safari||!(!s||!(/\b(iPad|iPhone|iPod)\b/.test(s)||s.match("Safari")&&!s.match("Chrome")))}return Na}(r)&&e&&(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/))},o.dG=function(r,e){Me=r,Ve=e},o.dH=Dr,o.dI=hs,o.dJ=function(r){const e=[0,0,0],i=Ie.mat4.identity(new Float64Array(16));return Ie.mat4.multiply(i,r.pixelMatrix,r.globeMatrix),Ie.vec3.transformMat4(e,e,i),new pt(e[0],e[1])},o.dK=function(r,e,i=!1){if(Nr===Xl||Nr===Uc||Nr===Yl)throw new Error("setRTLTextPlugin cannot be called multiple times.");Ro=fe.resolveURL(r),Nr=Xl,jc=e,eu(),i||Kl()},o.dL=Gc,o.dM=function(){lf().acquire(nm)},o.dN=function(){const r=fp;r&&(r.isPreloaded()&&1===r.numActive()?(r.release(nm),fp=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},o.dO=af,o.dP=function(r){const e=ot();if(!e)return;const i=e.delete(ze);r&&i.catch(r).then(()=>r())},o.dQ=pp,o.dR=fy,o.dS=function(r){fm=fe.resolveURL(r),Ad||(Ad=new wd(lf(),new Is)),Ad.broadcast("setDracoUrl",fm)},o.dT=my,o.dU=function(r){Ed=fe.resolveURL(r),Ad||(Ad=new wd(lf(),new Is)),Ad.broadcast("setMeshoptUrl",Ed)},o.dV=St,o.dW=v,o.dX=2,o.dY=fd,o.dZ=class{constructor(r,e){this.pos=r,this.dir=e}intersectsPlane(r,e,i){const s=Ie.vec2.dot(e,this.dir);if(Math.abs(s)<1e-6)return!1;const h=((r[0]-this.pos[0])*e[0]+(r[1]-this.pos[1])*e[1])/s;return i[0]=this.pos[0]+this.dir[0]*h,i[1]=this.pos[1]+this.dir[1]*h,!0}},o.d_=Sy,o.da=Li,o.db=uu,o.dc=256,o.dd=Xi,o.de=Fs,o.df=Fo,o.dg=Kc,o.dh=function(r,e,i,s,h){return ai((r-e)/(i-e)*(h-s)+s,s,h)},o.di=Wh,o.dj=ba,o.dk=class{constructor(r,e,i,s){this.context=r,this.format=s,this.size=i,this.texture=r.gl.createTexture();const[h,a,u]=this.size,{gl:x}=r;x.bindTexture(x.TEXTURE_3D,this.texture),r.pixelStoreUnpackFlipY.set(!1),r.pixelStoreUnpack.set(1),r.pixelStoreUnpackPremultiplyAlpha.set(!1),x.texImage3D(x.TEXTURE_3D,0,this.format,h,a,u,0,$f(this.format),Zf(this.format),e.data)}bind(r,e){const{context:i}=this,{gl:s}=i;s.bindTexture(s.TEXTURE_3D,this.texture),r!==this.minFilter&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MAG_FILTER,r),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_MIN_FILTER,r),this.minFilter=r),e!==this.wrapS&&(s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_S,e),s.texParameteri(s.TEXTURE_3D,s.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){const{gl:r}=this.context;r.deleteTexture(this.texture),this.texture=null}},o.dl=Jf,o.dm=[1,1,1],o.dn=bd,o.dp=vd,o.dq=so,o.dr=ao,o.ds=jo,o.dt=oo,o.du=Bs,o.dv=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new pt(1/0,1/0),max:new pt(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(r,e=!1){const i=qm(new pt(0,0),new pt(ft,ft),r),s=[];if(e&&!Tf(i,this._globalClipBounds))return s;for(const h of this._activeRegions){if(h.hiddenByOverlap||!Tf(i,h))continue;const a=Hy(h.min,h.max,r);s.push({min:a.min,max:a.max,sourceId:this._sourceIds[h.priority],footprint:h.footprint,footprintTileId:h.tileId,order:h.order,clipMask:h.clipMask,clipScope:h.clipScope})}return s}setSources(r){this._setSources(r.map(e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const i=[];for(const s of e.cache.getVisibleCoordinates()){const h=e.cache.getTile(s).buckets[e.layer];h&&h.updateFootprints(s.toUnwrapped(),i)}return i},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope})))}_addSource(r){const e=r.getFootprints();if(0===e.length)return;const i=r.getOrder(),s=r.getClipMask(),h=r.getClipScope();for(const a of e){if(!a.footprint)continue;const u=qm(a.footprint.min,a.footprint.max,a.id);this._activeRegions.push({min:u.min,max:u.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:a.id,footprint:a.footprint,order:i,clipMask:s,clipScope:h})}this._sourceIds.push(r.getSourceId())}_computeReplacement(){this._activeRegions.sort((e,i)=>e.priority-i.priority||Lp(e.min,i.min)||Lp(e.max,i.max)||e.order-i.order||e.clipMask-i.clipMask||function(s,h){const a=(u,x)=>u+x;return s.length-h.length||s.reduce(a,"").localeCompare(h.reduce(a,""))}(e.clipScope,i.clipScope));let r=this._activeRegions.length!==this._prevRegions.length;if(!r){let e=0;for(;!r&&e!==this._activeRegions.length;){const i=this._activeRegions[e],s=this._prevRegions[e];r=i.priority!==s.priority||!Gm(i,s)||i.order!==s.order||i.clipMask!==s.clipMask||!Fn(i.clipScope,s.clipScope),++e}}if(r){++this._updateTime;for(const i of this._activeRegions)i.order!==Rp&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,i.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,i.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,i.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,i.max.y));const e=i=>{const s=this._activeRegions;if(i>=s.length)return i;const h=s[i].priority;for(;i<s.length&&s[i].priority===h;)++i;return i};if(this._sourceIds.length>1){let i=0,s=e(i);for(;i!==s;){let h=i;const a=i;for(;h!==s;){const u=this._activeRegions[h];u.hiddenByOverlap=!1;for(let x=0;x<a;x++){const T=this._activeRegions[x];if(!T.hiddenByOverlap&&u.order===Rp&&Tf(u,T)&&(u.hiddenByOverlap=Wm(u.footprint,u.tileId,T.footprint,T.tileId),u.hiddenByOverlap))break}++h}i=s,s=e(i)}}}}_setSources(r){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=r.length-1;e>=0;e--)this._addSource(r[e]);this._computeReplacement()}},o.dw=class{constructor(r){this._createGrid(r),this._createPoles(r)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const r of this._poleSegments)r.destroy();for(const r of this._gridSegments)r.withSkirts.destroy(),r.withoutSkirts.destroy()}_fillGridMeshWithLods(r,e){const i=new Os,s=new Ln,h=[],a=r+1+2,u=e[0]+1,x=e[0]+1+(1+e.length),T=(C,g,S)=>{let A=C===a-1?C-2:0===C?C:C-1;return A+=S?24575:0,[A,g]};for(let C=0;C<a;++C)i.emplaceBack(...T(C,0,!0));for(let C=0;C<u;++C)for(let g=0;g<a;++g)i.emplaceBack(...T(g,C,(0===g||g===a-1)&&!0));for(let C=0;C<e.length;++C){const g=e[C];for(let S=0;S<a;++S)i.emplaceBack(...T(S,g,!0))}for(let C=0;C<e.length;++C){const g=s.length,S=e[C]+1+2,A=new Ln;for(let P=0;P<S-1;P++){const O=P===S-2,B=O?a*(x-e.length+C-P):a;for(let G=0;G<a-1;G++){const q=P*a+G;0===P||O||0===G||G===a-2?(A.emplaceBack(q+1,q,q+B),A.emplaceBack(q+B,q+B+1,q+1)):(s.emplaceBack(q+1,q,q+B),s.emplaceBack(q+B,q+B+1,q+1))}}const w=vn.simpleSegment(0,g,i.length,s.length-g);for(let P=0;P<A.uint16.length;P+=3)s.emplaceBack(A.uint16[P],A.uint16[P+1],A.uint16[P+2]);const M=vn.simpleSegment(0,g,i.length,s.length-g);h.push({withoutSkirts:w,withSkirts:M})}return{vertices:i,indices:s,segments:h}}_createGrid(r){const e=this._fillGridMeshWithLods(64,nh);this._gridSegments=e.segments,this._gridBuffer=r.createVertexBuffer(e.vertices,kt.members),this._gridIndexBuffer=r.createIndexBuffer(e.indices,!0)}_createPoles(r){const e=new Ln;for(let u=0;u<=64;u++)e.emplaceBack(0,u+1,u+2);this._poleIndexBuffer=r.createIndexBuffer(e,!0);const i=new Fo,s=new Fo,h=new Fo,a=new Fo;this._poleSegments=[];for(let u=0,x=0;u<5;u++){const T=360/(1<<u);i.emplaceBack(0,-wr,0,.5,0),s.emplaceBack(0,-wr,0,.5,1),h.emplaceBack(0,-wr,0,.5,.5),a.emplaceBack(0,-wr,0,.5,.5);for(let C=0;C<=64;C++){let g=C/64,S=0;const A=Ut(0,T,g),[w,M,P]=gl(wa,js,A,wr);i.emplaceBack(w,M,P,g,S),s.emplaceBack(w,M,P,g,1-S);const O=yi(A);g=.5+.5*Math.sin(O),S=.5+.5*Math.cos(O),h.emplaceBack(w,M,P,g,S),a.emplaceBack(w,M,P,g,1-S)}this._poleSegments.push(vn.simpleSegment(x,0,66,64)),x+=66}this._poleNorthVertexBuffer=r.createVertexBuffer(i,jt,!1),this._poleSouthVertexBuffer=r.createVertexBuffer(s,jt,!1),this._texturedPoleNorthVertexBuffer=r.createVertexBuffer(h,jt,!1),this._texturedPoleSouthVertexBuffer=r.createVertexBuffer(a,jt,!1)}getGridBuffers(r,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[r].withSkirts:this._gridSegments[r].withoutSkirts]}getPoleBuffers(r,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[r]]}},o.dx=Rp,o.dy=Fa,o.dz=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},o.e=En,o.e0=p_,o.e1=Ki,o.e2=Ds,o.e3=j_,o.e4=function(r,e,i,s,h,a,u,x,T,C,g=1,S,A){r.createArrays(),r.tilePixelRatio=ft/(512*r.overscaling),r.compareText={},r.iconsNeedLinear=!1;const w=r.layers[0].layout,M=r.layers[0]._unevaluatedLayout._values,P={};P.scaleFactor=g,P.textSizeScaleRange=w.get("text-size-scale-range"),P.iconSizeScaleRange=w.get("icon-size-scale-range");const[O,B]=P.textSizeScaleRange,[G,q]=P.iconSizeScaleRange;if(P.textScaleFactor=ai(P.scaleFactor,O,B),P.iconScaleFactor=ai(P.scaleFactor,G,q),"composite"===r.textSizeData.kind){const{minZoom:ee,maxZoom:ae}=r.textSizeData;P.compositeTextSizes=[M["text-size"].possiblyEvaluate(new Zi(ee),x),M["text-size"].possiblyEvaluate(new Zi(ae),x)]}if("composite"===r.iconSizeData.kind){const{minZoom:ee,maxZoom:ae}=r.iconSizeData;P.compositeIconSizes=[M["icon-size"].possiblyEvaluate(new Zi(ee),x),M["icon-size"].possiblyEvaluate(new Zi(ae),x)]}P.layoutTextSize=M["text-size"].possiblyEvaluate(new Zi(T+1),x),P.layoutIconSize=M["icon-size"].possiblyEvaluate(new Zi(T+1),x),P.textMaxSize=M["text-size"].possiblyEvaluate(new Zi(18),x);const U="map"===w.get("text-rotation-alignment")&&"point"!==w.get("symbol-placement"),W=w.get("text-size");let X=!1;for(const ee of r.features)if(ee.icon&&ee.icon.nameSecondary){X=!0;break}for(const ee of r.features){const ae=w.get("text-font").evaluate(ee,{},x).join(","),oe=W.evaluate(ee,{},x)*P.textScaleFactor,se=P.layoutTextSize.evaluate(ee,{},x)*P.textScaleFactor,ye=(P.layoutIconSize.evaluate(ee,{},x),{horizontal:{},vertical:void 0}),le=ee.text;let ve,Se=[0,0];if(le){const Pe=le.toString(),ke=24*w.get("text-letter-spacing").evaluate(ee,{},x),Ce=24*w.get("text-line-height").evaluate(ee,{},x),Ze=Bc(Pe)?ke:0,tt=w.get("text-anchor").evaluate(ee,{},x),$e=w.get("text-variable-anchor");if(!$e){const It=w.get("text-radial-offset").evaluate(ee,{},x);Se=It?Z_(tt,[24*It,Nf]):w.get("text-offset").evaluate(ee,{},x).map(yt=>24*yt)}let gt=U?"center":w.get("text-justify").evaluate(ee,{},x);const mt="point"===w.get("symbol-placement"),st=mt?24*w.get("text-max-width").evaluate(ee,{},x):1/0,nt=It=>{r.allowVerticalPlacement&&Kh(Pe)&&(ye.vertical=Of(le,e,i,h,ae,st,Ce,tt,It,Ze,Se,lo.vertical,!0,se,oe))};if(!U&&$e){const It="auto"===gt?$e.map(wt=>Vf(wt)):[gt];let yt=!1;for(let wt=0;wt<It.length;wt++){const $t=It[wt];if(!ye.horizontal[$t])if(yt)ye.horizontal[$t]=ye.horizontal[0];else{const ni=Of(le,e,i,h,ae,st,Ce,"center",$t,Ze,Se,lo.horizontal,!1,se,oe);ni&&(ye.horizontal[$t]=ni,yt=1===ni.positionedLines.length)}}nt("left")}else{if("auto"===gt&&(gt=Vf(tt)),mt||w.get("text-writing-mode").indexOf("horizontal")>=0||!Kh(Pe)){const It=Of(le,e,i,h,ae,st,Ce,tt,gt,Ze,Se,lo.horizontal,!1,se,oe);It&&(ye.horizontal[gt]=It)}nt(mt?"left":gt)}}let we=!1;if(ee.icon&&ee.icon.namePrimary){const Pe=Df(r.iconSizeData,M["icon-size"],x,r.zoom,ee)*P.iconScaleFactor*S,ke=ee.icon.getPrimary().scaleSelf(Pe).serialize(),Ce=s[ke];Ce&&(ve=C0(h[ke],ee.icon.nameSecondary?h[ee.icon.getSecondary().scaleSelf(Pe).serialize()]:void 0,w.get("icon-offset").evaluate(ee,{},x),w.get("icon-anchor").evaluate(ee,{},x)),we=Ce.sdf,void 0===r.sdfIcons?r.sdfIcons=Ce.sdf:r.sdfIcons!==Ce.sdf&&ii("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Ce.pixelRatio!==r.pixelRatio||0!==w.get("icon-rotate").constantOr(1))&&(r.iconsNeedLinear=!0))}const Ae=Y_(ye.horizontal)||ye.vertical;r.iconsInText||(r.iconsInText=!!Ae&&Ae.iconsInText),(Ae||ve)&&O0(r,ee,ye,ve,s,P,se,0,Se,we,u,x,C,A,X)}a&&r.generateCollisionDebugBuffers(T,r.collisionBoxArray,P.textScaleFactor)},o.e5=ff,o.e6=Ko,o.e7=Bm,o.e8=A_,o.e9=er,o.ea=function(r){let e=0;if(new Uint32Array(r,0,1)[0]!==gy){const i=new Uint32Array(r,0,7),[,,s,h,a,u]=i;e=i.byteLength+h+a+u+a,(s!==r.byteLength||e>=r.byteLength)&&ii("Invalid b3dm header information.")}return by(r,e)},o.eb=function(r,e){const i=Ty(r);for(const s of i){for(const h of s.meshes)uv(h);s.lights&&(s.lightMeshIndex=s.meshes.length,s.meshes.push(dv(s.lights,e)))}return i},o.ec=of,o.ed=Fg,o.ee=Zr,o.ef=function(r){dt(),Ue?.then(e=>{e.keys().then(i=>{for(let s=0;s<i.length-r;s++)e.delete(i[s])})})},o.f=function(r){return 0===r.indexOf("mapbox:")},o.g=function(r,e){return zn(Hi(r,{method:"GET"}),e)},o.h=Sl,o.i=function(r){return En.API_STYLE_REGEX.test(r)&&!pn(r)},o.j=function(r){return decodeURIComponent(atob(r).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))},o.k=function(r){return btoa(encodeURIComponent(r).replace(/%([0-9A-F]{2})/g,(e,i)=>String.fromCharCode(+("0x"+i))))},o.l=Hi,o.m=Nt,o.n=function(r,e){return zn(Hi(r,{type:"json"}),e)},o.o=Lu,o.p=function(r,e){return zn(Hi(r,{method:"POST"}),e)},o.q=fe,o.r=I,o.s=function(r){try{const e=self[r];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},o.t=ne,o.u=function(){return function r(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,r)}()},o.v=function(r){return!!r&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(r)},o.w=ii,o.x=function(){return rm||(rm=new af),rm},o.y=El,o.z=Hr}),vt(0,function(o){function er(Ge){const $=Ge?Ge.url.toString():void 0;return $?performance.getEntriesByName($):[]}function jr(Ge){if("number"==typeof Ge||"boolean"==typeof Ge||"string"==typeof Ge||null==Ge)return JSON.stringify(Ge);if(Array.isArray(Ge)){let te="[";for(const ne of Ge)te+=`${jr(ne)},`;return`${te}]`}let $="{";for(const te of Object.keys(Ge).sort())$+=`${te}:${jr(Ge[te])},`;return`${$}}`}function Qi(Ge){let $="";for(const te of o.bm)("model"!==Ge.type||"minzoom"!==te&&"maxzoom"!==te)&&($+=`/${jr(Ge[te])}`);return $}class Sr{constructor($){this.keyCache={},this._layers={},this._layerConfigs={},$&&this.replace($)}replace($,te){this._layerConfigs={},this._layers={},this.update($,[],te)}update($,te,ne){this._options=ne;for(const me of $)this._layerConfigs[me.id]=me,(this._layers[me.id]=o.cu(me,this.scope,null,this._options)).compileFilter(ne),this.keyCache[me.id]&&delete this.keyCache[me.id];for(const me of te)delete this.keyCache[me],delete this._layerConfigs[me],delete this._layers[me];this.familiesBySource={};const fe=function(me,Te){const ze={};for(let Ve=0;Ve<me.length;Ve++){const Fe=me[Ve];let Ue=Te&&Te[Fe.id];!Ue&&(Ue=Qi(Fe),"line"===Fe.type&&Fe.paint)&&function ot(dt){return"string"==typeof dt&&"line-progress"===dt||(Array.isArray(dt)?dt.some(ot):!(!dt||"object"!=typeof dt)&&Object.values(dt).some(ot))}(Fe.paint["line-width"])&&(Ue+=`/${jr(Fe.paint["line-width"])}`),Te&&(Te[Fe.id]=Ue);let Qe=ze[Ue];Qe||(Qe=ze[Ue]=[]),Qe.push(Fe)}const Me=[];for(const Ve in ze)Me.push(ze[Ve]);return Me}(o.bj(this._layerConfigs),this.keyCache);for(const me of fe){const Te=me.map(Qe=>this._layers[Qe.id]),ze=Te[0];if("none"===ze.visibility)continue;const Me=ze.source||"";let Ve=this.familiesBySource[Me];Ve||(Ve=this.familiesBySource[Me]={});const Fe=ze.sourceLayer||"_geojsonTileLayer";let Ue=Ve[Fe];Ue||(Ue=Ve[Fe]=[]),Ue.push(Te)}}}const Xn=1*o.dX;class yr{constructor($){const te={},ne=[];for(const ze in $){const Me=$[ze],Ve=te[ze]={};for(const Fe in Me.glyphs){const Ue=Me.glyphs[+Fe];if(!Ue||0===Ue.bitmap.width||0===Ue.bitmap.height)continue;const Qe=Ue.metrics.localGlyph?Xn:1,ot={x:0,y:0,w:Ue.bitmap.width+2*Qe,h:Ue.bitmap.height+2*Qe};ne.push(ot),Ve[Fe]=ot}}const{w:fe,h:me}=o.F(ne),Te=new o.dW({width:fe||1,height:me||1});for(const ze in $){const Me=$[ze];for(const Ve in Me.glyphs){const Fe=Me.glyphs[+Ve];if(!Fe||0===Fe.bitmap.width||0===Fe.bitmap.height)continue;const Ue=te[ze][Ve],Qe=Fe.metrics.localGlyph?Xn:1;o.dW.copy(Fe.bitmap,Te,{x:0,y:0},{x:Ue.x+Qe,y:Ue.y+Qe},Fe.bitmap)}}this.image=Te,this.positions=te}}o.dV(yr,"GlyphAtlas");const Oi="3d_elevation_id",qi="hd_road_elevation";class Yn{constructor(){this._valid=!1}reset($){return this.feature=$,this._valid=!0,this._geometry=$.loadGeometry(),0!==this._geometry.length&&0!==this._geometry[0].length||(this._valid=!1),this}geometry($,te){return this._valid&&$(te(this._geometry)),this}require($,te,ne){return this.get($,!0,te,ne)}optional($,te,ne){return this.get($,!1,te,ne)}success(){return this._valid}get($,te,ne,fe){const me=this.feature.properties.hasOwnProperty($)?+this.feature.properties[$]:void 0;return this._valid&&void 0!==me?ne(fe?fe(me):me):te&&(this._valid=!1),this}}class Si{constructor($,te){this.featureFunc=$,this.vertexFunc=te}parseFeature($,te,ne){return this.featureFunc($,te,ne)}parseVertex($,te,ne){return this.vertexFunc($,te,ne)}}const uo=new Si((Ge,$,te)=>Ge.reset($).require(Oi,ne=>{te.id=ne}).optional("fixed_height_relative",ne=>{te.constantHeight=ne},gi.decodeRelativeHeight).geometry(ne=>{te.bounds=ne},gi.computeBounds).success(),(Ge,$,te)=>Ge.reset($).require(Oi,ne=>{te.id=ne}).require("elevation_idx",ne=>{te.idx=ne}).require("extent",ne=>{te.extent=ne}).require("height_relative",ne=>{te.height=ne},gi.decodeRelativeHeight).geometry(ne=>{te.position=ne},gi.getPoint).success()),xr=new Si((Ge,$,te)=>Ge.reset($).require(Oi,ne=>{te.id=ne}).optional("fixed_height",ne=>{te.constantHeight=ne},gi.decodeMetricHeight).geometry(ne=>{te.bounds=ne},gi.computeBounds).success(),(Ge,$,te)=>Ge.reset($).require(Oi,ne=>{te.id=ne}).require("elevation_idx",ne=>{te.idx=ne}).require("extent",ne=>{te.extent=ne}).require("height",ne=>{te.height=ne},gi.decodeMetricHeight).geometry(ne=>{te.position=ne},gi.getPoint).success());class gi{static computeBounds($){const te=new o.P(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),ne=new o.P(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const fe of $[0])te.x>fe.x&&(te.x=fe.x),te.y>fe.y&&(te.y=fe.y),ne.x<fe.x&&(ne.x=fe.x),ne.y<fe.y&&(ne.y=fe.y);return{min:te,max:ne}}static getPoint($){return o.ab.vec2.fromValues($[0][0].x,$[0][0].y)}static decodeRelativeHeight($){return 1e-4*$*5}static decodeMetricHeight($){return 1e-4*$}static parse($){const te=[],ne=[],fe=$.length,me=new Yn;for(let ze=0;ze<fe;ze++){const Me=$.feature(ze),Ve=Me.properties.hasOwnProperty("version")?String(Me.properties.version):void 0,Fe=(Te=Ve)?"1.0.1"===Te?xr:void 0:uo;if(void 0===Fe){o.w(`Unknown elevation feature version number ${Ve||"(unknown)"}`);continue}const Ue=Me.properties.hasOwnProperty("type")?Me.properties.type:void 0;if(Ue)if("Point"===o.dY.VectorTileFeature.types[Me.type]&&"curve_point"===Ue){const Qe={};Fe.parseVertex(me,Me,Qe)&&te.push(Qe)}else if("Polygon"===o.dY.VectorTileFeature.types[Me.type]&&"curve_meta"===Ue){const Qe={};Fe.parseFeature(me,Me,Qe)&&ne.push(Qe)}}var Te;return{vertices:te,features:ne}}}class $o{constructor($,te,ne,fe,me,Te){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=$,this.heightRange={min:ne,max:ne},this.safeArea=te,this.constantHeight=ne,null==this.constantHeight&&(null!=this.constantHeight||0!==fe.length)){this.vertices=fe,this.edges=me,this.edges=this.edges.filter(ze=>ze.a<this.vertices.length&&ze.b<this.vertices.length&&!o.ab.vec2.exactEquals(this.vertices[ze.a].position,this.vertices[ze.b].position)),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const ze of this.vertices)this.vertexProps.push({dir:o.ab.vec2.fromValues(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,ze.height),this.heightRange.max=Math.max(this.heightRange.max,ze.height);for(const ze of this.edges){const Me=this.vertices[ze.a].position,Ve=this.vertices[ze.b].position,Fe=o.ab.vec2.subtract(o.ab.vec2.create(),Ve,Me),Ue=o.ab.vec2.length(Fe),Qe=o.ab.vec2.scale(o.ab.vec2.create(),Fe,1/Ue);this.edgeProps.push({vec:Fe,dir:Qe,len:Ue});const ot=this.vertexProps[ze.a].dir,dt=this.vertexProps[ze.b].dir;o.ab.vec2.add(ot,ot,Qe),o.ab.vec2.add(dt,dt,Qe)}for(const ze of this.vertexProps)0===ze.dir[0]&&0===ze.dir[1]||o.ab.vec2.normalize(ze.dir,ze.dir);this.tessellate(Te)}}pointElevation($){if(null!=this.constantHeight)return this.constantHeight;const te=this.getClosestEdge($);if(null==te)return 0;const[ne,fe]=te;return(1-(me=fe))*this.vertices[this.edges[ne].a].height+me*this.vertices[this.edges[ne].b].height;var me}getClosestEdge($){if(0===this.edges.length)return;let te=0,ne=Number.POSITIVE_INFINITY,fe=0;const me=o.ab.vec2.fromValues($.x,$.y);for(let Te=0;Te<this.edges.length;Te++){const ze=this.edges[Te],Me=this.edgeProps[Te].dir,Ve=new o.dZ(me,this.edgeProps[Te].dir),Fe=this.vertices[ze.a].position,Ue=this.vertices[ze.b].position,Qe=o.ab.vec2.create(),ot=o.ab.vec2.create(),dt=Ve.intersectsPlane(Fe,this.vertexProps[ze.a].dir,Qe),Rt=Ve.intersectsPlane(Ue,this.vertexProps[ze.b].dir,ot);if(!dt||!Rt)continue;const Nt=o.ab.vec2.subtract(o.ab.vec2.create(),ot,Qe),Vt=o.ab.vec2.subtract(o.ab.vec2.create(),me,Qe),Ft=o.ab.vec2.dot(Nt,Nt),ei=Ft>0?o.ab.vec2.dot(Vt,Nt)/Ft:0,mi=o.aw(ei,0,1),Gt=Math.abs((ei-mi)*this.edgeProps[Te].len),Ii=o.ab.vec2.subtract(o.ab.vec2.create(),me,Fe),ui=Gt+Math.abs(o.ab.vec2.dot(Ii,o.ab.vec2.fromValues(Me[1],-Me[0])));ui<ne&&(te=Te,ne=ui,fe=mi)}return[te,fe]}tessellate($){for(let te=this.edges.length-1;te>=0;--te){const ne=this.edges[te].a,fe=this.edges[te].b,{position:me,height:Te,extent:ze}=this.vertices[ne],{position:Me,height:Ve,extent:Fe}=this.vertices[fe],Ue=this.vertexProps[ne].dir,Qe=this.vertexProps[fe].dir,ot=o.ab.vec3.fromValues(me[0]/$,me[1]/$,Te),dt=o.ab.vec3.fromValues(Me[0]/$,Me[1]/$,Ve),Rt=o.ab.vec3.fromValues(Ue[1],-Ue[0],0);o.ab.vec3.scale(Rt,Rt,ze);const Nt=o.ab.vec3.fromValues(Qe[1],-Qe[0],0);if(o.ab.vec3.scale(Nt,Nt,Fe),this.distSqLines(o.ab.vec3.fromValues(ot[0]+.5*Rt[0],ot[1]+.5*Rt[1],ot[2]+.5*Rt[2]),o.ab.vec3.fromValues(dt[0]-.5*Nt[0],dt[1]-.5*Nt[1],dt[2]-.5*Nt[2]),o.ab.vec3.fromValues(ot[0]-.5*Rt[0],ot[1]-.5*Rt[1],ot[2]-.5*Rt[2]),o.ab.vec3.fromValues(dt[0]+.5*Nt[0],dt[1]+.5*Nt[1],dt[2]+.5*Nt[2]))<=.05*.05)continue;const Vt=this.vertices.length,Ft=o.ab.vec2.add(o.ab.vec2.create(),me,Me);this.vertices.push({position:o.ab.vec2.scale(Ft,Ft,.5),height:.5*(Te+Ve),extent:.5*(ze+Fe)});const ei=o.ab.vec2.add(o.ab.vec2.create(),Ue,Qe);this.vertexProps.push({dir:o.ab.vec2.normalize(ei,ei)}),this.edges.splice(te,1),this.edgeProps.splice(te,1),this.edges.push({a:ne,b:Vt}),this.edges.push({a:Vt,b:fe});const mi=o.ab.vec2.subtract(o.ab.vec2.create(),this.vertices[Vt].position,me),Gt=o.ab.vec2.length(mi),Ii={vec:mi,dir:o.ab.vec2.scale(o.ab.vec2.create(),mi,1/Gt),len:Gt};this.edgeProps.push(Ii),this.edgeProps.push(Ii)}}distSqLines($,te,ne,fe){const me=o.ab.vec3.subtract(o.ab.vec3.create(),te,$),Te=o.ab.vec3.subtract(o.ab.vec3.create(),fe,ne),ze=o.ab.vec3.subtract(o.ab.vec3.create(),$,ne),Me=o.ab.vec3.dot(me,me),Ve=o.ab.vec3.dot(me,Te),Fe=o.ab.vec3.dot(me,ze),Ue=o.ab.vec3.dot(Te,Te),Qe=o.ab.vec3.dot(Te,ze),ot=Me*Ue-Ve*Ve;if(0===ot){const Ft=o.ab.vec3.dot(ze,Te)/o.ab.vec3.dot(Te,Te),ei=o.ab.vec3.lerp(o.ab.vec3.create(),ne,fe,Ft);return o.ab.vec3.squaredDistance(ei,$)}const dt=(Ve*Qe-Fe*Ue)/ot,Rt=(Me*Qe-Ve*Fe)/ot,Nt=o.ab.vec3.lerp(o.ab.vec3.create(),$,te,dt),Vt=o.ab.vec3.lerp(o.ab.vec3.create(),ne,fe,Rt);return o.ab.vec3.squaredDistance(Nt,Vt)}}class Da{static parseFrom($,te){const ne=gi.parse($);if(!ne)return[];let{vertices:fe,features:me}=ne;const Te=1/o.cc(te);me.sort((Fe,Ue)=>Fe.id-Ue.id),fe.sort((Fe,Ue)=>Fe.id-Ue.id||Fe.idx-Ue.idx),fe=fe.filter((Fe,Ue,Qe)=>Ue===Qe.findIndex(ot=>ot.id===Fe.id&&ot.idx===Fe.idx));const ze=new Array;let Me=0;const Ve=fe.length;for(const Fe of me){if(Fe.constantHeight){ze.push(new $o(Fe.id,Fe.bounds,Fe.constantHeight));continue}for(;Me!==Ve&&fe[Me].id<Fe.id;)Me++;if(Me===Ve||fe[Me].id!==Fe.id)continue;const Ue=new Array,Qe=new Array,ot=Me;for(;Me!==Ve&&fe[Me].id===Fe.id;){const dt=fe[Me];if(Ue.push({position:dt.position,height:dt.height,extent:dt.extent}),Me!==ot&&fe[Me-1].idx===dt.idx-1){const Rt=Me-ot;Qe.push({a:Rt-1,b:Rt})}Me++}ze.push(new $o(Fe.id,Fe.bounds,void 0,Ue,Qe,Te))}return ze}}o.dV($o,"ElevationFeature");class Xt{constructor($){this.tileID=new o.aG($.tileID.overscaledZ,$.tileID.wrap,$.tileID.canonical.z,$.tileID.canonical.x,$.tileID.canonical.y),this.tileZoom=$.tileZoom,this.uid=$.uid,this.zoom=$.zoom,this.lut=$.lut,this.canonical=$.tileID.canonical,this.pixelRatio=$.pixelRatio,this.tileSize=$.tileSize,this.source=$.source,this.scope=$.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=$.showCollisionBoxes,this.collectResourceTiming=!!$.request&&$.request.collectResourceTiming,this.promoteId=$.promoteId,this.isSymbolTile=$.isSymbolTile,this.tileTransform=o.aQ($.tileID.canonical,$.projection),this.projection=$.projection,this.worldview=$.worldview,this.localizableLayerIds=$.localizableLayerIds,this.brightness=$.brightness,this.extraShadowCaster=!!$.extraShadowCaster,this.tessellationStep=$.tessellationStep,this.scaleFactor=$.scaleFactor}parse($,te,ne,fe,me){this.status="parsing",this.data=$,this.collisionBoxArray=new o.aW;const Te=new o.d_(Object.keys($.layers).sort()),ze=new o.d$(this.tileID,this.promoteId);ze.bucketLayerIDs=[];const Me={},Ve=new o.e0(256,256),Fe={featureIndex:ze,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:Ve,availableImages:ne,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},Ue=te.familiesBySource[this.source];for(const Ft in Ue){const ei=$.layers[Ft];if(!ei)continue;let mi=!1,Gt=!1,Ii=!1;for(const zn of Ue[Ft])"symbol"===zn[0].type?mi=!0:Gt=!0,zn[0].is3D()&&"model"!==zn[0].type&&(Ii=!0);if(this.extraShadowCaster&&!Ii||!0===this.isSymbolTile&&!mi||!1===this.isSymbolTile&&!Gt)continue;1===ei.version&&o.w(`Vector tile source "${this.source}" layer "${Ft}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const ui=Te.encode(Ft),yn=[];let ir=!1;for(let zn=0,Nn=0;zn<ei.length;zn++){const ar=ei.feature(zn),Ml=ze.getId(ar,Ft);if(this.localizableLayerIds&&this.localizableLayerIds.has(Ft)){const As=ar.properties?ar.properties.worldview:null;if(this.worldview&&"string"==typeof As)if("all"===As)ar.properties.$localized=!0;else{if(!As.split(",").includes(this.worldview))continue;ar.properties.$localized=!0,ar.properties.worldview=this.worldview}}!ir&&ar.properties&&ar.properties.hasOwnProperty(Oi)&&(ir=!0),yn.push({feature:ar,id:Ml,index:Nn,sourceLayerIndex:ui}),Nn++}ir&&$.layers.hasOwnProperty(qi)&&(Fe.elevationFeatures=Da.parseFrom($.layers[qi],this.canonical));for(const zn of Ue[Ft]){const Nn=zn[0];(!this.extraShadowCaster||Nn.is3D()&&"model"!==Nn.type)&&(void 0!==this.isSymbolTile&&"symbol"===Nn.type!==this.isSymbolTile||Nn.minzoom&&this.zoom<Math.floor(Nn.minzoom)||Nn.maxzoom&&this.zoom>=Nn.maxzoom||"none"!==Nn.visibility&&(Ms(zn,this.zoom,Fe.brightness,ne),(Me[Nn.id]=Nn.createBucket({index:ze.bucketLayerIDs.length,layers:zn,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:ui,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep})).populate(yn,Fe,this.tileID.canonical,this.tileTransform),ze.bucketLayerIDs.push(zn.map(ar=>o.aC(ar.id,ar.scope)))))}}let Qe,ot,dt,Rt;Ve.trim();const Nt={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},Vt=()=>{if(Qe)return this.status="done",me(Qe);if(this.extraShadowCaster)this.status="done",me(null,{buckets:o.bj(Me).filter(Ft=>!Ft.isEmpty()),featureIndex:ze,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:Fe.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(ot&&dt&&Rt){const Ft=new yr(ot),ei=new o.e3(dt,Rt,this.lut);for(const mi in Me){const Gt=Me[mi];Gt instanceof o.aX?(Ms(Gt.layers,this.zoom,Fe.brightness,ne),o.e4(Gt,ot,Ft.positions,dt,ei.iconPositions,this.showCollisionBoxes,ne,this.tileID.canonical,this.tileZoom,this.projection,this.scaleFactor,this.pixelRatio,this.brightness)):Gt.hasPattern&&(Gt instanceof o.b1||Gt instanceof o.b2||Gt instanceof o.d5)&&(Ms(Gt.layers,this.zoom,Fe.brightness,ne),Gt.addFeatures(Fe,this.tileID.canonical,ei.patternPositions,ne,this.tileTransform,this.brightness))}this.status="done",me(null,{buckets:o.bj(Me).filter(mi=>!mi.isEmpty()),featureIndex:ze,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:Ft.image,lineAtlas:Ve,imageAtlas:ei,brightness:Fe.brightness})}};if(!this.extraShadowCaster){const Ft=o.e1(Fe.glyphDependencies,Gt=>Object.keys(Gt).map(Number));Object.keys(Ft).length?fe.send("getGlyphs",{uid:this.uid,stacks:Ft,scope:this.scope},(Gt,Ii)=>{Qe||(Qe=Gt,ot=Ii,Vt())},void 0,!1,Nt):ot={};const ei=Object.keys(Fe.iconDependencies);ei.length?fe.send("getImages",{icons:ei,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},(Gt,Ii)=>{if(Qe)return;Qe=Gt;const ui={};Object.values(Ii).some(yn=>yn.usvg)?this.rasterize(fe,ui,Ii,Fe.iconDependencies,()=>{dt=ui,Vt()}):(this.fillImageMap(ui,Fe.iconDependencies,Ii),dt=ui,Vt())},void 0,!1,Nt):dt={};const mi=Object.keys(Fe.patternDependencies);mi.length?fe.send("getImages",{icons:mi,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},(Gt,Ii)=>{if(!Qe){Qe=Gt;const ui={};Object.values(Ii).some(yn=>yn.usvg)?this.rasterize(fe,ui,Ii,Fe.patternDependencies,()=>{Rt=ui,Vt()}):(this.fillImageMap(ui,Fe.patternDependencies,Ii),Rt=ui,Vt())}},void 0,!1,Nt):Rt={}}Vt()}fillImageMap($,te,ne){for(const fe in ne){const me=te[fe]||[];for(const Te of me)ne[Te.id].usvg||($[Te.serialize()]=ne[Te.id])}}getImageTaskQueue($,te,ne){const fe={};for(const me in te){const Te=ne[me]||[];for(const ze of Te){const Me=ze.serialize();te[ze.id].usvg?fe[Me]||(fe[Me]=ze):$[Me]=te[ze.id]}}return fe}rasterize($,te,ne,fe,me){const Te=this.getImageTaskQueue(te,ne,fe);this.rasterizeTask=$.send("rasterizeImages",{scope:this.scope,imageTasks:Te},(ze,Me)=>{if(!ze)for(const Ve in Me){const{id:Fe}=o.e2.deserializeFromString(Ve);te[Ve]=Object.assign({},ne[Fe],{data:Me[Ve]})}me()})}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function Ms(Ge,$,te,ne){const fe=new o.a8($,{brightness:te});for(const me of Ge)me.recalculate(fe,ne)}class Gs extends o.E{constructor($,te,ne,fe,me,Te){super(),this.actor=$,this.layerIndex=te,this.availableImages=ne,this.loadVectorData=me||o.aD,this.loading={},this.loaded={},this.deduped=new o.aB($.scheduler),this.isSpriteLoaded=fe,this.scheduler=$.scheduler,this.brightness=Te}loadTile($,te){const ne=$.uid,fe=$&&$.request,me=fe&&fe.collectResourceTiming,Te=this.loading[ne]=new Xt($);Te.abort=this.loadVectorData($,(ze,Me)=>{const Ve=!this.loading[ne];if(delete this.loading[ne],Te.cancelRasterize(),Ve||ze||!Me)return Te.status="done",Ve||(this.loaded[ne]=Te),te(ze);const Fe=Me.rawData,Ue={};Me.expires&&(Ue.expires=Me.expires),Me.cacheControl&&(Ue.cacheControl=Me.cacheControl),Te.vectorTile=Me.vectorTile||new o.dY.VectorTile(new o.bh(Fe));const Qe=()=>{Te.parse(Te.vectorTile,this.layerIndex,this.availableImages,this.actor,(ot,dt)=>{if(ot||!dt)return te(ot);const Rt={};if(me){const Nt=er(fe);Nt.length>0&&(Rt.resourceTiming=JSON.parse(JSON.stringify(Nt)))}te(null,o.l({rawTileData:Fe.slice(0)},dt,Ue,Rt))})};this.isSpriteLoaded?Qe():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(Qe,{type:"parseTile",isSymbolTile:$.isSymbolTile,zoom:$.tileZoom}):Qe()}),this.loaded=this.loaded||{},this.loaded[ne]=Te})}reloadTile($,te){const ne=this.loaded,fe=$.uid;if(ne&&ne[fe]){const me=ne[fe];me.scaleFactor=$.scaleFactor,me.showCollisionBoxes=$.showCollisionBoxes,me.projection=$.projection,me.brightness=$.brightness,me.tileTransform=o.aQ($.tileID.canonical,$.projection),me.extraShadowCaster=$.extraShadowCaster,me.lut=$.lut;const Te=(ze,Me)=>{const Ve=me.reloadCallback;Ve&&(delete me.reloadCallback,me.parse(me.vectorTile,this.layerIndex,this.availableImages,this.actor,Ve)),te(ze,Me)};"parsing"===me.status?me.reloadCallback=Te:"done"===me.status&&(me.vectorTile?me.parse(me.vectorTile,this.layerIndex,this.availableImages,this.actor,Te):Te())}else te(null,void 0)}abortTile($,te){const ne=$.uid,fe=this.loading[ne];fe&&(fe.abort&&fe.abort(),delete this.loading[ne]),te()}removeTile($,te){const ne=this.loaded,fe=$.uid;ne&&ne[fe]&&delete ne[fe],te()}}class Yt{loadTile($,te){const{uid:ne,encoding:fe,rawImageData:me,padding:Te}=$,ze=ImageBitmap&&me instanceof ImageBitmap?this.getImageData(me,Te):me;te(null,new o.e5(ne,ze,fe,Te<1))}getImageData($,te){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas($.width,$.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=$.width,this.offscreenCanvas.height=$.height,this.offscreenCanvasContext.drawImage($,0,0,$.width,$.height);const ne=this.offscreenCanvasContext.getImageData(-te,-te,$.width+2*te,$.height+2*te);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),ne}}o.bg.setPbf(o.bh);class Qt{decodeRasterArray({task:$,buffer:te},ne){o.bg.performDecoding(te,$).then(fe=>{ne(null,fe)},fe=>{ne(fe)})}}const za=o.dY.VectorTileFeature.prototype.toGeoJSON;class Zo{constructor($){this._feature=$,this.extent=o.ag,this.type=$.type,this.properties=$.tags,"id"in $&&!isNaN($.id)&&(this.id=parseInt($.id,10))}loadGeometry(){if(1===this._feature.type){const $=[];for(const te of this._feature.geometry)$.push([new o.P(te[0],te[1])]);return $}{const $=[];for(const te of this._feature.geometry){const ne=[];for(const fe of te)ne.push(new o.P(fe[0],fe[1]));$.push(ne)}return $}}toGeoJSON($,te,ne){return za.call(this,$,te,ne)}}class _c{constructor($){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=o.ag,this.length=$.length,this._features=$}feature($){return new Zo(this._features[$])}}const oi=64/4096;class ds{constructor(){this.features=new Map}clear(){this.features.clear()}load($=[],te){for(const ne of $){const fe=ne.id;if(null==fe)continue;let me=this.features.get(fe);me&&this.updateCache(me,te),ne.geometry?(me=ci(ne),this.updateCache(me,te),this.features.set(fe,me)):this.features.delete(fe),this.updateCache(me,te)}}updateCache($,te){for(const{canonical:ne,uid:fe}of Object.values(te)){const{z:me,x:Te,y:ze}=ne;po($,Math.pow(2,me),Te,ze)&&delete te[fe]}}getTile($,te,ne){const fe=Math.pow(2,$),me=[];for(const Te of this.features.values())po(Te,fe,te,ne)&&me.push(ti(Te,fe,te,ne));return{features:me}}getFeatures(){return[...this.features.values()]}}function po({minX:Ge,minY:$,maxX:te,maxY:ne},fe,me,Te){return Ge<(me+1+oi)/fe&&$<(Te+1+oi)/fe&&te>(me-oi)/fe&&ne>(Te-oi)/fe}function ci(Ge){const{id:$,geometry:te,properties:ne}=Ge;if(!te)return;if("GeometryCollection"===te.type)throw new Error("GeometryCollection not supported in dynamic mode.");const{type:fe,coordinates:me}=te,Te={id:$,type:1,geometry:[],tags:ne,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},ze=Te.geometry;if("Point"===fe)qs(me,ze,Te);else if("MultiPoint"===fe)for(const Me of me)qs(Me,ze,Te);else if("LineString"===fe)Te.type=2,Ra(me,ze,Te);else if("MultiLineString"===fe)Te.type=2,Hs(me,ze,Te);else if("Polygon"===fe)Te.type=3,Hs(me,ze,Te,!0);else{if("MultiPolygon"!==fe)throw new Error("Input data is not a valid GeoJSON object.");Te.type=3;for(const Me of me)Hs(Me,ze,Te,!0)}return Te}function qs([Ge,$],te,ne){const fe=o.at(Ge);let me=o.aA($);me=me<0?0:me>1?1:me,te.push(fe,me),ne.minX=Math.min(ne.minX,fe),ne.minY=Math.min(ne.minY,me),ne.maxX=Math.max(ne.maxX,fe),ne.maxY=Math.max(ne.maxY,me)}function Ra(Ge,$,te,ne=!1,fe=!1){const me=[];for(const Te of Ge)qs(Te,me,te);$.push(me),ne&&function(Te,ze){let Me=0;for(let Ve=0,Fe=Te.length,Ue=Fe-2;Ve<Fe;Ue=Ve,Ve+=2)Me+=(Te[Ve]-Te[Ue])*(Te[Ve+1]+Te[Ue+1]);if(Me>0===ze)for(let Ve=0,Fe=Te.length;Ve<Fe/2;Ve+=2){const Ue=Te[Ve],Qe=Te[Ve+1];Te[Ve]=Te[Fe-2-Ve],Te[Ve+1]=Te[Fe-1-Ve],Te[Fe-2-Ve]=Ue,Te[Fe-1-Ve]=Qe}}(me,fe)}function Hs(Ge,$,te,ne=!1){for(let fe=0;fe<Ge.length;fe++)Ra(Ge[fe],$,te,ne,0===fe)}function ti(Ge,$,te,ne){const{id:fe,type:me,geometry:Te,tags:ze}=Ge,Me=[];if(1===me)!function(Ve,Fe,Ue,Qe,ot){for(let dt=0;dt<Ve.length;dt+=2){const Rt=Math.round(o.ag*(Ve[dt+0]*Fe-Ue)),Nt=Math.round(o.ag*(Ve[dt+1]*Fe-Qe));ot.push([Rt,Nt])}}(Te,$,te,ne,Me);else for(const Ve of Te)mh(Ve,$,te,ne,Me);return{id:fe,type:me,geometry:Me,tags:ze}}function mh(Ge,$,te,ne,fe){const me=-128,Te=o.ag+128;let ze;for(let Me=0;Me<Ge.length-2;Me+=2){let Ve=Math.round(o.ag*(Ge[Me+0]*$-te)),Fe=Math.round(o.ag*(Ge[Me+1]*$-ne)),Ue=Math.round(o.ag*(Ge[Me+2]*$-te)),Qe=Math.round(o.ag*(Ge[Me+3]*$-ne));const ot=Ue-Ve,dt=Qe-Fe;Ve<me&&Ue<me||(Ve<me?(Fe+=Math.round(dt*((me-Ve)/ot)),Ve=me):Ue<me&&(Qe=Fe+Math.round(dt*((me-Ve)/ot)),Ue=me),Fe<me&&Qe<me||(Fe<me?(Ve+=Math.round(ot*((me-Fe)/dt)),Fe=me):Qe<me&&(Ue=Ve+Math.round(ot*((me-Fe)/dt)),Qe=me),Ve>=Te&&Ue>=Te||(Ve>=Te?(Fe+=Math.round(dt*((Te-Ve)/ot)),Ve=Te):Ue>=Te&&(Qe=Fe+Math.round(dt*((Te-Ve)/ot)),Ue=Te),Fe>=Te&&Qe>=Te||(Fe>=Te?(Ve+=Math.round(ot*((Te-Fe)/dt)),Fe=Te):Qe>=Te&&(Ue=Ve+Math.round(ot*((Te-Fe)/dt)),Qe=Te),ze&&Ve===ze[ze.length-1][0]&&Fe===ze[ze.length-1][1]||(ze=[[Ve,Fe]],fe.push(ze)),ze.push([Ue,Qe])))))}}var La,Xo,Yo,Es={exports:{}},Ws=function(){if(Yo)return Es.exports;Yo=1;var Ge=o.e8(),$=function(){if(Xo)return La;Xo=1;var Fe=o.e6(),Ue=o.e7().VectorTileFeature;function Qe(dt,Rt){this.options=Rt||{},this.features=dt,this.length=dt.length}function ot(dt,Rt){this.id="number"==typeof dt.id?dt.id:void 0,this.type=dt.type,this.rawGeometry=1===dt.type?[dt.geometry]:dt.geometry,this.properties=dt.tags,this.extent=Rt||4096}return La=Qe,Qe.prototype.feature=function(dt){return new ot(this.features[dt],this.options.extent)},ot.prototype.loadGeometry=function(){var dt=this.rawGeometry;this.geometry=[];for(var Rt=0;Rt<dt.length;Rt++){for(var Nt=dt[Rt],Vt=[],Ft=0;Ft<Nt.length;Ft++)Vt.push(new Fe(Nt[Ft][0],Nt[Ft][1]));this.geometry.push(Vt)}return this.geometry},ot.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var dt=this.geometry,Rt=1/0,Nt=-1/0,Vt=1/0,Ft=-1/0,ei=0;ei<dt.length;ei++)for(var mi=dt[ei],Gt=0;Gt<mi.length;Gt++){var Ii=mi[Gt];Rt=Math.min(Rt,Ii.x),Nt=Math.max(Nt,Ii.x),Vt=Math.min(Vt,Ii.y),Ft=Math.max(Ft,Ii.y)}return[Rt,Vt,Nt,Ft]},ot.prototype.toGeoJSON=Ue.prototype.toGeoJSON,La}();function te(Fe){var Ue=new Ge;return function(Qe,ot){for(var dt in Qe.layers)ot.writeMessage(3,ne,Qe.layers[dt])}(Fe,Ue),Ue.finish()}function ne(Fe,Ue){var Qe;Ue.writeVarintField(15,Fe.version||1),Ue.writeStringField(1,Fe.name||""),Ue.writeVarintField(5,Fe.extent||4096);var ot={keys:[],values:[],keycache:{},valuecache:{}};for(Qe=0;Qe<Fe.length;Qe++)ot.feature=Fe.feature(Qe),Ue.writeMessage(2,fe,ot);var dt=ot.keys;for(Qe=0;Qe<dt.length;Qe++)Ue.writeStringField(3,dt[Qe]);var Rt=ot.values;for(Qe=0;Qe<Rt.length;Qe++)Ue.writeMessage(4,Ve,Rt[Qe])}function fe(Fe,Ue){var Qe=Fe.feature;void 0!==Qe.id&&Ue.writeVarintField(1,Qe.id),Ue.writeMessage(2,me,Fe),Ue.writeVarintField(3,Qe.type),Ue.writeMessage(4,Me,Qe)}function me(Fe,Ue){var Qe=Fe.feature,ot=Fe.keys,dt=Fe.values,Rt=Fe.keycache,Nt=Fe.valuecache;for(var Vt in Qe.properties){var Ft=Qe.properties[Vt],ei=Rt[Vt];if(null!==Ft){void 0===ei&&(ot.push(Vt),Rt[Vt]=ei=ot.length-1),Ue.writeVarint(ei);var mi=typeof Ft;"string"!==mi&&"boolean"!==mi&&"number"!==mi&&(Ft=JSON.stringify(Ft));var Gt=mi+":"+Ft,Ii=Nt[Gt];void 0===Ii&&(dt.push(Ft),Nt[Gt]=Ii=dt.length-1),Ue.writeVarint(Ii)}}}function Te(Fe,Ue){return(Ue<<3)+(7&Fe)}function ze(Fe){return Fe<<1^Fe>>31}function Me(Fe,Ue){for(var Qe=Fe.loadGeometry(),ot=Fe.type,dt=0,Rt=0,Nt=Qe.length,Vt=0;Vt<Nt;Vt++){var Ft=Qe[Vt],ei=1;1===ot&&(ei=Ft.length),Ue.writeVarint(Te(1,ei));for(var mi=3===ot?Ft.length-1:Ft.length,Gt=0;Gt<mi;Gt++){1===Gt&&1!==ot&&Ue.writeVarint(Te(2,mi-1));var Ii=Ft[Gt].x-dt,ui=Ft[Gt].y-Rt;Ue.writeVarint(ze(Ii)),Ue.writeVarint(ze(ui)),dt+=Ii,Rt+=ui}3===ot&&Ue.writeVarint(Te(7,1))}}function Ve(Fe,Ue){var Qe=typeof Fe;"string"===Qe?Ue.writeStringField(1,Fe):"boolean"===Qe?Ue.writeBooleanField(7,Fe):"number"===Qe&&(Fe%1!=0?Ue.writeDoubleField(3,Fe):Fe<0?Ue.writeSVarintField(6,Fe):Ue.writeVarintField(5,Fe))}return Es.exports=te,Es.exports.fromVectorTileJs=te,Es.exports.fromGeojsonVt=function(Fe,Ue){Ue=Ue||{};var Qe={};for(var ot in Fe)Qe[ot]=new $(Fe[ot].features,Ue),Qe[ot].name=ot,Qe[ot].version=Ue.version,Qe[ot].extent=Ue.extent;return te({layers:Qe})},Es.exports.GeoJSONWrapper=$,Es.exports}(),Ie=o.e9(Ws);const ka={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:Ge=>Ge},Oa=Math.fround||(Ko=new Float32Array(1),Ge=>(Ko[0]=+Ge,Ko[0]));var Ko;class $s{constructor($){this.options=Object.assign(Object.create(ka),$),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load($){const{log:te,minZoom:ne,maxZoom:fe}=this.options;te&&console.time("total time");const me=`prepare ${$.length} points`;te&&console.time(me),this.points=$;const Te=[];for(let Me=0;Me<$.length;Me++){const Ve=$[Me];if(!Ve.geometry)continue;const[Fe,Ue]=Ve.geometry.coordinates,Qe=Oa(is(Fe)),ot=Oa(Gr(Ue));Te.push(Qe,ot,1/0,Me,-1,1),this.options.reduce&&Te.push(0)}let ze=this.trees[fe+1]=this._createTree(Te);te&&console.timeEnd(me);for(let Me=fe;Me>=ne;Me--){const Ve=+Date.now();ze=this.trees[Me]=this._createTree(this._cluster(ze,Me)),te&&console.log("z%d: %d clusters in %dms",Me,ze.numItems,+Date.now()-Ve)}return te&&console.timeEnd("total time"),this}getClusters($,te){let ne=(($[0]+180)%360+360)%360-180;const fe=Math.max(-90,Math.min(90,$[1]));let me=180===$[2]?180:(($[2]+180)%360+360)%360-180;const Te=Math.max(-90,Math.min(90,$[3]));if($[2]-$[0]>=360)ne=-180,me=180;else if(ne>me){const Ue=this.getClusters([ne,fe,180,Te],te),Qe=this.getClusters([-180,fe,me,Te],te);return Ue.concat(Qe)}const ze=this.trees[this._limitZoom(te)],Me=ze.range(is(ne),Gr(Te),is(me),Gr(fe)),Ve=ze.data,Fe=[];for(const Ue of Me){const Qe=this.stride*Ue;Fe.push(Ve[Qe+5]>1?yi(Ve,Qe,this.clusterProps):this.points[Ve[Qe+3]])}return Fe}getChildren($){const te=this._getOriginId($),ne=this._getOriginZoom($),fe="No cluster with the specified id.",me=this.trees[ne];if(!me)throw new Error(fe);const Te=me.data;if(te*this.stride>=Te.length)throw new Error(fe);const ze=this.options.radius/(this.options.extent*Math.pow(2,ne-1)),Me=me.within(Te[te*this.stride],Te[te*this.stride+1],ze),Ve=[];for(const Fe of Me){const Ue=Fe*this.stride;Te[Ue+4]===$&&Ve.push(Te[Ue+5]>1?yi(Te,Ue,this.clusterProps):this.points[Te[Ue+3]])}if(0===Ve.length)throw new Error(fe);return Ve}getLeaves($,te,ne){const fe=[];return this._appendLeaves(fe,$,te=te||10,ne=ne||0,0),fe}getTile($,te,ne){const fe=this.trees[this._limitZoom($)],me=Math.pow(2,$),{extent:Te,radius:ze}=this.options,Me=ze/Te,Ve=(ne-Me)/me,Fe=(ne+1+Me)/me,Ue={features:[]};return this._addTileFeatures(fe.range((te-Me)/me,Ve,(te+1+Me)/me,Fe),fe.data,te,ne,me,Ue),0===te&&this._addTileFeatures(fe.range(1-Me/me,Ve,1,Fe),fe.data,me,ne,me,Ue),te===me-1&&this._addTileFeatures(fe.range(0,Ve,Me/me,Fe),fe.data,-1,ne,me,Ue),Ue.features.length?Ue:null}getClusterExpansionZoom($){let te=this._getOriginZoom($)-1;for(;te<=this.options.maxZoom;){const ne=this.getChildren($);if(te++,1!==ne.length)break;$=ne[0].properties.cluster_id}return te}_appendLeaves($,te,ne,fe,me){const Te=this.getChildren(te);for(const ze of Te){const Me=ze.properties;if(Me&&Me.cluster?me+Me.point_count<=fe?me+=Me.point_count:me=this._appendLeaves($,Me.cluster_id,ne,fe,me):me<fe?me++:$.push(ze),$.length===ne)break}return me}_createTree($){const te=new o.bE($.length/this.stride|0,this.options.nodeSize,Float32Array);for(let ne=0;ne<$.length;ne+=this.stride)te.add($[ne],$[ne+1]);return te.finish(),te.data=$,te}_addTileFeatures($,te,ne,fe,me,Te){for(const ze of $){const Me=ze*this.stride,Ve=te[Me+5]>1;let Fe,Ue,Qe;if(Ve)Fe=Hn(te,Me,this.clusterProps),Ue=te[Me],Qe=te[Me+1];else{const Rt=this.points[te[Me+3]];Fe=Rt.properties;const[Nt,Vt]=Rt.geometry.coordinates;Ue=is(Nt),Qe=Gr(Vt)}const ot={type:1,geometry:[[Math.round(this.options.extent*(Ue*me-ne)),Math.round(this.options.extent*(Qe*me-fe))]],tags:Fe};let dt;dt=Ve||this.options.generateId?te[Me+3]:this.points[te[Me+3]].id,void 0!==dt&&(ot.id=dt),Te.features.push(ot)}}_limitZoom($){return Math.max(this.options.minZoom,Math.min(Math.floor(+$),this.options.maxZoom+1))}_cluster($,te){const{radius:ne,extent:fe,reduce:me,minPoints:Te}=this.options,ze=ne/(fe*Math.pow(2,te)),Me=$.data,Ve=[],Fe=this.stride;for(let Ue=0;Ue<Me.length;Ue+=Fe){if(Me[Ue+2]<=te)continue;Me[Ue+2]=te;const Qe=Me[Ue],ot=Me[Ue+1],dt=$.within(Me[Ue],Me[Ue+1],ze),Rt=Me[Ue+5];let Nt=Rt;for(const Vt of dt){const Ft=Vt*Fe;Me[Ft+2]>te&&(Nt+=Me[Ft+5])}if(Nt>Rt&&Nt>=Te){let Vt,Ft=Qe*Rt,ei=ot*Rt,mi=-1;const Gt=(Ue/Fe<<5)+(te+1)+this.points.length;for(const Ii of dt){const ui=Ii*Fe;if(Me[ui+2]<=te)continue;Me[ui+2]=te;const yn=Me[ui+5];Ft+=Me[ui]*yn,ei+=Me[ui+1]*yn,Me[ui+4]=Gt,me&&(Vt||(Vt=this._map(Me,Ue,!0),mi=this.clusterProps.length,this.clusterProps.push(Vt)),me(Vt,this._map(Me,ui)))}Me[Ue+4]=Gt,Ve.push(Ft/Nt,ei/Nt,1/0,Gt,-1,Nt),me&&Ve.push(mi)}else{for(let Vt=0;Vt<Fe;Vt++)Ve.push(Me[Ue+Vt]);if(Nt>1)for(const Vt of dt){const Ft=Vt*Fe;if(!(Me[Ft+2]<=te)){Me[Ft+2]=te;for(let ei=0;ei<Fe;ei++)Ve.push(Me[Ft+ei])}}}}return Ve}_getOriginId($){return $-this.points.length>>5}_getOriginZoom($){return($-this.points.length)%32}_map($,te,ne){if($[te+5]>1){const Te=this.clusterProps[$[te+6]];return ne?Object.assign({},Te):Te}const fe=this.points[$[te+3]].properties,me=this.options.map(fe);return ne&&me===fe?Object.assign({},me):me}}function yi(Ge,$,te){return{type:"Feature",id:Ge[$+3],properties:Hn(Ge,$,te),geometry:{type:"Point",coordinates:[(ne=Ge[$],360*(ne-.5)),Fa(Ge[$+1])]}};var ne}function Hn(Ge,$,te){const ne=Ge[$+5],fe=ne>=1e4?`${Math.round(ne/1e3)}k`:ne>=1e3?Math.round(ne/100)/10+"k":ne,me=Ge[$+6],Te=-1===me?{}:Object.assign({},te[me]);return Object.assign(Te,{cluster:!0,cluster_id:Ge[$+3],point_count:ne,point_count_abbreviated:fe})}function is(Ge){return Ge/360+.5}function Gr(Ge){const $=Math.sin(Ge*Math.PI/180),te=.5-.25*Math.log((1+$)/(1-$))/Math.PI;return te<0?0:te>1?1:te}function Fa(Ge){const $=(180-360*Ge)*Math.PI/180;return 360*Math.atan(Math.exp($))/Math.PI-90}function Ar(Ge,$,te,ne){let fe=ne;const me=$+(te-$>>1);let Te,ze=te-$;const Me=Ge[$],Ve=Ge[$+1],Fe=Ge[te],Ue=Ge[te+1];for(let Qe=$+3;Qe<te;Qe+=3){const ot=ai(Ge[Qe],Ge[Qe+1],Me,Ve,Fe,Ue);if(ot>fe)Te=Qe,fe=ot;else if(ot===fe){const dt=Math.abs(Qe-me);dt<ze&&(Te=Qe,ze=dt)}}fe>ne&&(Te-$>3&&Ar(Ge,$,Te,ne),Ge[Te+2]=fe,te-Te>3&&Ar(Ge,Te,te,ne))}function ai(Ge,$,te,ne,fe,me){let Te=fe-te,ze=me-ne;if(0!==Te||0!==ze){const Me=((Ge-te)*Te+($-ne)*ze)/(Te*Te+ze*ze);Me>1?(te=fe,ne=me):Me>0&&(te+=Te*Me,ne+=ze*Me)}return Te=Ge-te,ze=$-ne,Te*Te+ze*ze}function Ai(Ge,$,te,ne){const fe={id:Ge??null,type:$,geometry:te,tags:ne,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if("Point"===$||"MultiPoint"===$||"LineString"===$)Yi(fe,te);else if("Polygon"===$)Yi(fe,te[0]);else if("MultiLineString"===$)for(const me of te)Yi(fe,me);else if("MultiPolygon"===$)for(const me of te)Yi(fe,me[0]);return fe}function Yi(Ge,$){for(let te=0;te<$.length;te+=3)Ge.minX=Math.min(Ge.minX,$[te]),Ge.minY=Math.min(Ge.minY,$[te+1]),Ge.maxX=Math.max(Ge.maxX,$[te]),Ge.maxY=Math.max(Ge.maxY,$[te+1])}function zi(Ge,$,te,ne){if(!$.geometry)return;const fe=$.geometry.coordinates;if(fe&&0===fe.length)return;const me=$.geometry.type,Te=Math.pow(te.tolerance/((1<<te.maxZoom)*te.extent),2);let ze=[],Me=$.id;if(te.promoteId?Me=$.properties[te.promoteId]:te.generateId&&(Me=ne||0),"Point"===me)Hi(fe,ze);else if("MultiPoint"===me)for(const Ve of fe)Hi(Ve,ze);else if("LineString"===me)Bn(fe,ze,Te,!1);else if("MultiLineString"===me){if(te.lineMetrics){for(const Ve of fe)ze=[],Bn(Ve,ze,Te,!1),Ge.push(Ai(Me,"LineString",ze,$.properties));return}Ti(fe,ze,Te,!1)}else if("Polygon"===me)Ti(fe,ze,Te,!0);else{if("MultiPolygon"!==me){if("GeometryCollection"===me){for(const Ve of $.geometry.geometries)zi(Ge,{id:Me,geometry:Ve,properties:$.properties},te,ne);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const Ve of fe){const Fe=[];Ti(Ve,Fe,Te,!0),ze.push(Fe)}}Ge.push(Ai(Me,me,ze,$.properties))}function Hi(Ge,$){$.push(Ba(Ge[0]),Jo(Ge[1]),0)}function Bn(Ge,$,te,ne){let fe,me,Te=0;for(let Me=0;Me<Ge.length;Me++){const Ve=Ba(Ge[Me][0]),Fe=Jo(Ge[Me][1]);$.push(Ve,Fe,0),Me>0&&(Te+=ne?(fe*Fe-Ve*me)/2:Math.sqrt(Math.pow(Ve-fe,2)+Math.pow(Fe-me,2))),fe=Ve,me=Fe}const ze=$.length-3;$[2]=1,Ar($,0,ze,te),$[ze+2]=1,$.size=Math.abs(Te),$.start=0,$.end=$.size}function Ti(Ge,$,te,ne){for(let fe=0;fe<Ge.length;fe++){const me=[];Bn(Ge[fe],me,te,ne),$.push(me)}}function Ba(Ge){return Ge/360+.5}function Jo(Ge){const $=Math.sin(Ge*Math.PI/180),te=.5-.25*Math.log((1+$)/(1-$))/Math.PI;return te<0?0:te>1?1:te}function Bi(Ge,$,te,ne,fe,me,Te,ze){if(ne/=$,me>=(te/=$)&&Te<ne)return Ge;if(Te<te||me>=ne)return null;const Me=[];for(const Ve of Ge){const Fe=Ve.geometry;let Ue=Ve.type;const Qe=0===fe?Ve.minX:Ve.minY,ot=0===fe?Ve.maxX:Ve.maxY;if(Qe>=te&&ot<ne){Me.push(Ve);continue}if(ot<te||Qe>=ne)continue;let dt=[];if("Point"===Ue||"MultiPoint"===Ue)Ki(Fe,dt,te,ne,fe);else if("LineString"===Ue)Zs(Fe,dt,te,ne,fe,!1,ze.lineMetrics);else if("MultiLineString"===Ue)fo(Fe,dt,te,ne,fe,!1);else if("Polygon"===Ue)fo(Fe,dt,te,ne,fe,!0);else if("MultiPolygon"===Ue)for(const Rt of Fe){const Nt=[];fo(Rt,Nt,te,ne,fe,!0),Nt.length&&dt.push(Nt)}if(dt.length){if(ze.lineMetrics&&"LineString"===Ue){for(const Rt of dt)Me.push(Ai(Ve.id,Ue,Rt,Ve.tags));continue}"LineString"!==Ue&&"MultiLineString"!==Ue||(1===dt.length?(Ue="LineString",dt=dt[0]):Ue="MultiLineString"),"Point"!==Ue&&"MultiPoint"!==Ue||(Ue=3===dt.length?"Point":"MultiPoint"),Me.push(Ai(Ve.id,Ue,dt,Ve.tags))}}return Me.length?Me:null}function Ki(Ge,$,te,ne,fe){for(let me=0;me<Ge.length;me+=3){const Te=Ge[me+fe];Te>=te&&Te<=ne&&ii($,Ge[me],Ge[me+1],Ge[me+2])}}function Zs(Ge,$,te,ne,fe,me,Te){let ze=vr(Ge);const Me=0===fe?kr:mo;let Ve,Fe,Ue=Ge.start;for(let Nt=0;Nt<Ge.length-3;Nt+=3){const Vt=Ge[Nt],Ft=Ge[Nt+1],ei=Ge[Nt+2],mi=Ge[Nt+3],Gt=Ge[Nt+4],Ii=0===fe?Vt:Ft,ui=0===fe?mi:Gt;let yn=!1;Te&&(Ve=Math.sqrt(Math.pow(Vt-mi,2)+Math.pow(Ft-Gt,2))),Ii<te?ui>te&&(Fe=Me(ze,Vt,Ft,mi,Gt,te),Te&&(ze.start=Ue+Ve*Fe)):Ii>ne?ui<ne&&(Fe=Me(ze,Vt,Ft,mi,Gt,ne),Te&&(ze.start=Ue+Ve*Fe)):ii(ze,Vt,Ft,ei),ui<te&&Ii>=te&&(Fe=Me(ze,Vt,Ft,mi,Gt,te),yn=!0),ui>ne&&Ii<=ne&&(Fe=Me(ze,Vt,Ft,mi,Gt,ne),yn=!0),!me&&yn&&(Te&&(ze.end=Ue+Ve*Fe),$.push(ze),ze=vr(Ge)),Te&&(Ue+=Ve)}let Qe=Ge.length-3;const ot=Ge[Qe],dt=Ge[Qe+1],Rt=0===fe?ot:dt;Rt>=te&&Rt<=ne&&ii(ze,ot,dt,Ge[Qe+2]),Qe=ze.length-3,me&&Qe>=3&&(ze[Qe]!==ze[0]||ze[Qe+1]!==ze[1])&&ii(ze,ze[0],ze[1],ze[2]),ze.length&&$.push(ze)}function vr(Ge){const $=[];return $.size=Ge.size,$.start=Ge.start,$.end=Ge.end,$}function fo(Ge,$,te,ne,fe,me){for(const Te of Ge)Zs(Te,$,te,ne,fe,me,!1)}function ii(Ge,$,te,ne){Ge.push($,te,ne)}function kr(Ge,$,te,ne,fe,me){const Te=(me-$)/(ne-$);return ii(Ge,me,te+(fe-te)*Te,1),Te}function mo(Ge,$,te,ne,fe,me){const Te=(me-te)/(fe-te);return ii(Ge,$+(ne-$)*Te,me,1),Te}function Or(Ge,$){const te=[];for(let ne=0;ne<Ge.length;ne++){const fe=Ge[ne],me=fe.type;let Te;if("Point"===me||"MultiPoint"===me||"LineString"===me)Te=_o(fe.geometry,$);else if("MultiLineString"===me||"Polygon"===me){Te=[];for(const ze of fe.geometry)Te.push(_o(ze,$))}else if("MultiPolygon"===me){Te=[];for(const ze of fe.geometry){const Me=[];for(const Ve of ze)Me.push(_o(Ve,$));Te.push(Me)}}te.push(Ai(fe.id,me,Te,fe.tags))}return te}function _o(Ge,$){const te=[];te.size=Ge.size,void 0!==Ge.start&&(te.start=Ge.start,te.end=Ge.end);for(let ne=0;ne<Ge.length;ne+=3)te.push(Ge[ne]+$,Ge[ne+1],Ge[ne+2]);return te}function Qo(Ge,$){if(Ge.transformed)return Ge;const te=1<<Ge.z,ne=Ge.x,fe=Ge.y;for(const me of Ge.features){const Te=me.geometry,ze=me.type;if(me.geometry=[],1===ze)for(let Me=0;Me<Te.length;Me+=2)me.geometry.push(Na(Te[Me],Te[Me+1],$,te,ne,fe));else for(let Me=0;Me<Te.length;Me++){const Ve=[];for(let Fe=0;Fe<Te[Me].length;Fe+=2)Ve.push(Na(Te[Me][Fe],Te[Me][Fe+1],$,te,ne,fe));me.geometry.push(Ve)}}return Ge.transformed=!0,Ge}function Na(Ge,$,te,ne,fe,me){return[Math.round(te*(Ge*ne-fe)),Math.round(te*($*ne-me))]}function Va(Ge,$,te,ne,fe){const me=$===fe.maxZoom?0:fe.tolerance/((1<<$)*fe.extent),Te={features:[],numPoints:0,numSimplified:0,numFeatures:Ge.length,source:null,x:te,y:ne,z:$,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const ze of Ge)ps(Te,ze,me,fe);return Te}function ps(Ge,$,te,ne){const fe=$.geometry,me=$.type,Te=[];if(Ge.minX=Math.min(Ge.minX,$.minX),Ge.minY=Math.min(Ge.minY,$.minY),Ge.maxX=Math.max(Ge.maxX,$.maxX),Ge.maxY=Math.max(Ge.maxY,$.maxY),"Point"===me||"MultiPoint"===me)for(let ze=0;ze<fe.length;ze+=3)Te.push(fe[ze],fe[ze+1]),Ge.numPoints++,Ge.numSimplified++;else if("LineString"===me)go(Te,fe,Ge,te,!1,!1);else if("MultiLineString"===me||"Polygon"===me)for(let ze=0;ze<fe.length;ze++)go(Te,fe[ze],Ge,te,"Polygon"===me,0===ze);else if("MultiPolygon"===me)for(let ze=0;ze<fe.length;ze++){const Me=fe[ze];for(let Ve=0;Ve<Me.length;Ve++)go(Te,Me[Ve],Ge,te,!0,0===Ve)}if(Te.length){let ze=$.tags||null;if("LineString"===me&&ne.lineMetrics){ze={};for(const Ve in $.tags)ze[Ve]=$.tags[Ve];ze.mapbox_clip_start=fe.start/fe.size,ze.mapbox_clip_end=fe.end/fe.size}const Me={geometry:Te,type:"Polygon"===me||"MultiPolygon"===me?3:"LineString"===me||"MultiLineString"===me?2:1,tags:ze};null!==$.id&&(Me.id=$.id),Ge.features.push(Me)}}function go(Ge,$,te,ne,fe,me){const Te=ne*ne;if(ne>0&&$.size<(fe?Te:ne))return void(te.numPoints+=$.length/3);const ze=[];for(let Me=0;Me<$.length;Me+=3)(0===ne||$[Me+2]>Te)&&(te.numSimplified++,ze.push($[Me],$[Me+1])),te.numPoints++;fe&&function(Me,Ve){let Fe=0;for(let Ue=0,Qe=Me.length,ot=Qe-2;Ue<Qe;ot=Ue,Ue+=2)Fe+=(Me[Ue]-Me[ot])*(Me[Ue+1]+Me[ot+1]);if(Fe>0===Ve)for(let Ue=0,Qe=Me.length;Ue<Qe/2;Ue+=2){const ot=Me[Ue],dt=Me[Ue+1];Me[Ue]=Me[Qe-2-Ue],Me[Ue+1]=Me[Qe-1-Ue],Me[Qe-2-Ue]=ot,Me[Qe-1-Ue]=dt}}(ze,me),Ge.push(ze)}const yo={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class fs{constructor($,te){const ne=(te=this.options=function(me,Te){for(const ze in Te)me[ze]=Te[ze];return me}(Object.create(yo),te)).debug;if(ne&&console.time("preprocess data"),te.maxZoom<0||te.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(te.promoteId&&te.generateId)throw new Error("promoteId and generateId cannot be used together.");let fe=function(me,Te){const ze=[];if("FeatureCollection"===me.type)for(let Me=0;Me<me.features.length;Me++)zi(ze,me.features[Me],Te,Me);else zi(ze,"Feature"===me.type?me:{geometry:me},Te);return ze}($,te);this.tiles={},this.tileCoords=[],ne&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",te.indexMaxZoom,te.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),fe=function(me,Te){const ze=Te.buffer/Te.extent;let Me=me;const Ve=Bi(me,1,-1-ze,ze,0,-1,2,Te),Fe=Bi(me,1,1-ze,2+ze,0,-1,2,Te);return(Ve||Fe)&&(Me=Bi(me,1,-ze,1+ze,0,-1,2,Te)||[],Ve&&(Me=Or(Ve,1).concat(Me)),Fe&&(Me=Me.concat(Or(Fe,-1)))),Me}(fe,te),fe.length&&this.splitTile(fe,0,0,0),ne&&(fe.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile($,te,ne,fe,me,Te,ze){const Me=[$,te,ne,fe],Ve=this.options,Fe=Ve.debug;for(;Me.length;){fe=Me.pop(),ne=Me.pop(),te=Me.pop(),$=Me.pop();const Ue=1<<te,Qe=En(te,ne,fe);let ot=this.tiles[Qe];if(!ot&&(Fe>1&&console.time("creation"),ot=this.tiles[Qe]=Va($,te,ne,fe,Ve),this.tileCoords.push({z:te,x:ne,y:fe}),Fe)){Fe>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",te,ne,fe,ot.numFeatures,ot.numPoints,ot.numSimplified),console.timeEnd("creation"));const yn=`z${te}`;this.stats[yn]=(this.stats[yn]||0)+1,this.total++}if(ot.source=$,null==me){if(te===Ve.indexMaxZoom||ot.numPoints<=Ve.indexMaxPoints)continue}else{if(te===Ve.maxZoom||te===me)continue;if(null!=me){const yn=me-te;if(ne!==Te>>yn||fe!==ze>>yn)continue}}if(ot.source=null,0===$.length)continue;Fe>1&&console.time("clipping");const dt=.5*Ve.buffer/Ve.extent,Rt=.5-dt,Nt=.5+dt,Vt=1+dt;let Ft=null,ei=null,mi=null,Gt=null,Ii=Bi($,Ue,ne-dt,ne+Nt,0,ot.minX,ot.maxX,Ve),ui=Bi($,Ue,ne+Rt,ne+Vt,0,ot.minX,ot.maxX,Ve);$=null,Ii&&(Ft=Bi(Ii,Ue,fe-dt,fe+Nt,1,ot.minY,ot.maxY,Ve),ei=Bi(Ii,Ue,fe+Rt,fe+Vt,1,ot.minY,ot.maxY,Ve),Ii=null),ui&&(mi=Bi(ui,Ue,fe-dt,fe+Nt,1,ot.minY,ot.maxY,Ve),Gt=Bi(ui,Ue,fe+Rt,fe+Vt,1,ot.minY,ot.maxY,Ve),ui=null),Fe>1&&console.timeEnd("clipping"),Me.push(Ft||[],te+1,2*ne,2*fe),Me.push(ei||[],te+1,2*ne,2*fe+1),Me.push(mi||[],te+1,2*ne+1,2*fe),Me.push(Gt||[],te+1,2*ne+1,2*fe+1)}}getTile($,te,ne){$=+$,te=+te,ne=+ne;const fe=this.options,{extent:me,debug:Te}=fe;if($<0||$>24)return null;const ze=1<<$,Me=En($,te=te+ze&ze-1,ne);if(this.tiles[Me])return Qo(this.tiles[Me],me);Te>1&&console.log("drilling down to z%d-%d-%d",$,te,ne);let Ve,Fe=$,Ue=te,Qe=ne;for(;!Ve&&Fe>0;)Fe--,Ue>>=1,Qe>>=1,Ve=this.tiles[En(Fe,Ue,Qe)];return Ve&&Ve.source?(Te>1&&(console.log("found parent tile z%d-%d-%d",Fe,Ue,Qe),console.time("drilling down")),this.splitTile(Ve.source,Fe,Ue,Qe,$,te,ne),Te>1&&console.timeEnd("drilling down"),this.tiles[Me]?Qo(this.tiles[Me],me):null):null}}function En(Ge,$,te){return 32*((1<<Ge)*te+$)+Ge}function Sl(Ge,$){const te=Ge.tileID.canonical;if(!this._geoJSONIndex)return void $(null,null);const ne=this._geoJSONIndex.getTile(te.z,te.x,te.y);if(!ne)return void $(null,null);const fe=new _c(ne.features);let me=Ie(fe);0===me.byteOffset&&me.byteLength===me.buffer.byteLength||(me=new Uint8Array(me)),$(null,{vectorTile:fe,rawData:me.buffer})}class pn extends Gs{constructor($,te,ne,fe,me,Te){super($,te,ne,fe,Sl,Te),me&&(this.loadGeoJSON=me),this._dynamicIndex=new ds}loadData($,te){const ne=$&&$.request,fe=ne&&ne.collectResourceTiming;this.loadGeoJSON($,(me,Te)=>{if(me||!Te)return te(me);if("object"!=typeof Te)return te(new Error(`Input data given to '${$.source}' is not a valid GeoJSON object.`));{try{if($.filter){const Me=o.U($.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===Me.result)throw new Error(Me.value.map(Ve=>`${Ve.key}: ${Ve.message}`).join(", "));Te.features=Te.features.filter(Ve=>Me.value.evaluate({zoom:0},Ve))}$.dynamic?("Feature"===Te.type&&(Te={type:"FeatureCollection",features:[Te]}),$.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(Te.features,this.loaded),$.cluster&&(Te.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=$.cluster?new $s(function({superclusterOptions:Me,clusterProperties:Ve}){if(!Ve||!Me)return Me;const Fe={},Ue={},Qe={accumulated:null,zoom:0},ot={properties:null},dt=Object.keys(Ve);for(const Rt of dt){const[Nt,Vt]=Ve[Rt],Ft=o.U(Vt),ei=o.U("string"==typeof Nt?[Nt,["accumulated"],["get",Rt]]:Nt);Fe[Rt]=Ft.value,Ue[Rt]=ei.value}return Me.map=Rt=>{ot.properties=Rt;const Nt={};for(const Vt of dt)Nt[Vt]=Fe[Vt].evaluate(Qe,ot);return Nt},Me.reduce=(Rt,Nt)=>{ot.properties=Nt;for(const Vt of dt)Qe.accumulated=Rt[Vt],Rt[Vt]=Ue[Vt].evaluate(Qe,ot)},Me}($)).load(Te.features):$.dynamic?this._dynamicIndex:new fs(Me=Te,$.geojsonVtOptions)}catch(Me){return te(Me)}const ze={};if(fe){const Me=er(ne);Me&&(ze.resourceTiming={},ze.resourceTiming[$.source]=JSON.parse(JSON.stringify(Me)))}te(null,ze)}var Me})}reloadTile($,te){const ne=this.loaded;return ne&&ne[$.uid]?$.partial?te(null,void 0):super.reloadTile($,te):this.loadTile($,te)}loadGeoJSON($,te){if($.request)o.n($.request,te);else{if("string"!=typeof $.data)return te(new Error(`Input data given to '${$.source}' is not a valid GeoJSON object.`));try{return te(null,JSON.parse($.data))}catch{return te(new Error(`Input data given to '${$.source}' is not a valid GeoJSON object.`))}}}getClusterExpansionZoom($,te){try{te(null,this._geoJSONIndex.getClusterExpansionZoom($.clusterId))}catch(ne){te(ne)}}getClusterChildren($,te){try{te(null,this._geoJSONIndex.getChildren($.clusterId))}catch(ne){te(ne)}}getClusterLeaves($,te){try{te(null,this._geoJSONIndex.getLeaves($.clusterId,$.limit,$.offset))}catch(ne){te(ne)}}}class ln{constructor($,te){this.tileID=new o.aG($.tileID.overscaledZ,$.tileID.wrap,$.tileID.canonical.z,$.tileID.canonical.x,$.tileID.canonical.y),this.tileZoom=$.tileZoom,this.uid=$.uid,this.zoom=$.zoom,this.canonical=$.tileID.canonical,this.pixelRatio=$.pixelRatio,this.tileSize=$.tileSize,this.source=$.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=$.projection,this.brightness=te}parse($,te,ne,fe){this.status="parsing";const me=new o.aG(ne.tileID.overscaledZ,ne.tileID.wrap,ne.tileID.canonical.z,ne.tileID.canonical.x,ne.tileID.canonical.y),Te=[],ze=te.familiesBySource[ne.source],Me=new o.d$(me,ne.promoteId);return Me.bucketLayerIDs=[],Me.is3DTile=!0,o.ea($).then(Ve=>{if(!Ve)return fe(new Error("Could not parse tile"));const Fe=o.eb(Ve,1/o.cc(ne.tileID.canonical)),Ue=Ve.json.extensionsUsed&&Ve.json.extensionsUsed.includes("MAPBOX_mesh_features")||Ve.json.asset.extras&&Ve.json.asset.extras.MAPBOX_mesh_features,Qe=Ve.json.extensionsUsed&&Ve.json.extensionsUsed.includes("EXT_meshopt_compression"),ot=new o.a8(this.zoom,{brightness:this.brightness});for(const dt in ze)for(const Rt of ze[dt]){const Nt=Rt[0];Me.bucketLayerIDs.push(Rt.map(Ft=>o.aC(Ft.id,Ft.scope))),Nt.recalculate(ot,[]);const Vt=new o.ec(Rt,Fe,me,Ue,Qe,this.brightness,Me);Ue||(Vt.needsUpload=!0),Te.push(Vt),Vt.evaluate(Nt)}this.status="done",fe(null,{buckets:Te,featureIndex:Me,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})}).catch(Ve=>fe(new Error(Ve.message)))}}class tr{constructor($,te,ne,fe,me,Te){this.actor=$,this.layerIndex=te,this.availableImages=ne,this.brightness=Te,this.loading={},this.loaded={}}loadTile($,te){const ne=$.uid,fe=this.loading[ne]=new ln($,this.brightness);o.bi($.request,(me,Te)=>{const ze=!this.loading[ne];return delete this.loading[ne],ze||me?(fe.status="done",ze||(this.loaded[ne]=fe),te(me)):Te&&0!==Te.byteLength?void fe.parse(Te,this.layerIndex,$,(Me,Ve)=>{fe.status="done",this.loaded=this.loaded||{},this.loaded[ne]=fe,Me||!Ve?te(Me):te(null,Ve)}):(fe.status="done",this.loaded[ne]=fe,te())})}reloadTile($,te){const ne=this.loaded,fe=$.uid;if(ne&&ne[fe]){const me=ne[fe];me.projection=$.projection,me.brightness=$.brightness;const Te=(ze,Me)=>{me.reloadCallback&&(delete me.reloadCallback,this.loadTile($,te)),te(ze,Me)};"parsing"===me.status?me.reloadCallback=Te:"done"===me.status&&this.loadTile($,te)}}abortTile($,te){const ne=$.uid;this.loading[ne]&&delete this.loading[ne],te()}removeTile($,te){const ne=this.loaded,fe=$.uid;ne&&ne[fe]&&delete ne[fe],te()}}class qr{constructor($){this.self=$,this.actor=new o.ed($,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.imageRasterizer=new o.I,this.projections={},this.defaultProjection=o.bP({name:"mercator"}),this.workerSourceTypes={vector:Gs,geojson:pn,"batched-model":tr},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(te,ne)=>{if(this.workerSourceTypes[te])throw new Error(`Worker source with name "${te}" already registered.`);this.workerSourceTypes[te]=ne},this.self.registerRTLTextPlugin=te=>{if(o.ee.isParsed())throw new Error("RTL text plugin already registered.");o.ee.applyArabicShaping=te.applyArabicShaping,o.ee.processBidirectionalText=te.processBidirectionalText,o.ee.processStyledBidirectionalText=te.processStyledBidirectionalText}}clearCaches($,te,ne){delete this.layerIndexes[$],delete this.availableImages[$],delete this.workerSources[$],delete this.demWorkerSources[$],delete this.rasterArrayWorkerSource,ne()}checkIfReady($,te,ne){ne()}setReferrer($,te){this.referrer=te}spriteLoaded($,{scope:te,isLoaded:ne}){if(this.isSpriteLoaded[$]||(this.isSpriteLoaded[$]={}),this.isSpriteLoaded[$][te]=ne,this.workerSources[$]&&this.workerSources[$][te])for(const fe in this.workerSources[$][te]){const me=this.workerSources[$][te][fe];for(const Te in me){const ze=me[Te];ze instanceof Gs&&(ze.isSpriteLoaded=ne,ze.fire(new o.z("isSpriteLoaded")))}}}setImages($,{scope:te,images:ne},fe){if(this.availableImages[$]||(this.availableImages[$]={}),this.availableImages[$][te]=ne,this.workerSources[$]&&this.workerSources[$][te]){for(const me in this.workerSources[$][te]){const Te=this.workerSources[$][te][me];for(const ze in Te)Te[ze].availableImages=ne}fe()}else fe()}setProjection($,te){this.projections[$]=o.bP(te)}setBrightness($,te,ne){this.brightness=te,ne()}setLayers($,te,ne){this.getLayerIndex($,te.scope).replace(te.layers,te.options),ne()}updateLayers($,te,ne){this.getLayerIndex($,te.scope).update(te.layers,te.removedIds,te.options),ne()}loadTile($,te,ne){te.projection=this.projections[$]||this.defaultProjection,this.getWorkerSource($,te.type,te.source,te.scope).loadTile(te,ne)}loadDEMTile($,te,ne){this.getDEMWorkerSource($,te.source,te.scope).loadTile(te,ne)}decodeRasterArray($,te,ne){this.getRasterArrayWorkerSource().decodeRasterArray(te,ne)}reloadTile($,te,ne){te.projection=this.projections[$]||this.defaultProjection,this.getWorkerSource($,te.type,te.source,te.scope).reloadTile(te,ne)}abortTile($,te,ne){this.getWorkerSource($,te.type,te.source,te.scope).abortTile(te,ne)}removeTile($,te,ne){this.getWorkerSource($,te.type,te.source,te.scope).removeTile(te,ne)}removeSource($,te,ne){if(!(this.workerSources[$]&&this.workerSources[$][te.scope]&&this.workerSources[$][te.scope][te.type]&&this.workerSources[$][te.scope][te.type][te.source]))return;const fe=this.workerSources[$][te.scope][te.type][te.source];delete this.workerSources[$][te.scope][te.type][te.source],void 0!==fe.removeSource?fe.removeSource(te,ne):ne()}loadWorkerSource($,te,ne){try{this.self.importScripts(te.url),ne()}catch(fe){ne(fe.toString())}}syncRTLPluginState($,te,ne){try{o.ee.setState(te);const fe=o.ee.getPluginURL();if(o.ee.isLoaded()&&!o.ee.isParsed()&&null!=fe){this.self.importScripts(fe);const me=o.ee.isParsed();ne(me?void 0:new Error(`RTL Text Plugin failed to import scripts from ${fe}`),me)}}catch(fe){ne(fe.toString())}}setDracoUrl($,te){this.dracoUrl=te}getAvailableImages($,te){this.availableImages[$]||(this.availableImages[$]={});let ne=this.availableImages[$][te];return ne||(ne=[]),ne}getLayerIndex($,te){this.layerIndexes[$]||(this.layerIndexes[$]={});let ne=this.layerIndexes[$][te];return ne||(ne=this.layerIndexes[$][te]=new Sr,ne.scope=te),ne}getWorkerSource($,te,ne,fe){return this.workerSources[$]||(this.workerSources[$]={}),this.workerSources[$][fe]||(this.workerSources[$][fe]={}),this.workerSources[$][fe][te]||(this.workerSources[$][fe][te]={}),this.isSpriteLoaded[$]||(this.isSpriteLoaded[$]={}),this.workerSources[$][fe][te][ne]||(this.workerSources[$][fe][te][ne]=new this.workerSourceTypes[te]({send:(me,Te,ze,Me,Ve,Fe)=>{this.actor.send(me,Te,ze,$,Ve,Fe)},scheduler:this.actor.scheduler},this.getLayerIndex($,fe),this.getAvailableImages($,fe),this.isSpriteLoaded[$][fe],void 0,this.brightness)),this.workerSources[$][fe][te][ne]}rasterizeImages($,te,ne){const{imageTasks:fe,scope:me}=te,Te={};for(const ze in fe){const{image:Me,imageIdWithOptions:Ve}=fe[ze];Te[ze]=this.imageRasterizer.rasterize(Ve,Me,me,$)}ne(void 0,Te)}removeRasterizedImages($,te,ne){const{imageIds:fe,scope:me}=te;this.imageRasterizer.removeImagesFromCacheByIds(fe,me,$),ne()}getDEMWorkerSource($,te,ne){return this.demWorkerSources[$]||(this.demWorkerSources[$]={}),this.demWorkerSources[$][ne]||(this.demWorkerSources[$][ne]={}),this.demWorkerSources[$][ne][te]||(this.demWorkerSources[$][ne][te]=new Yt),this.demWorkerSources[$][ne][te]}getRasterArrayWorkerSource(){return this.rasterArrayWorkerSource||(this.rasterArrayWorkerSource=new Qt),this.rasterArrayWorkerSource}enforceCacheSizeLimit($,te){o.ef(te)}getWorkerPerformanceMetrics($,te,ne){ne(void 0,void 0)}}return typeof WorkerGlobalScope<"u"&&typeof self<"u"&&self instanceof WorkerGlobalScope&&(self.worker=new qr(self)),qr}),vt(0,function(o){var er="3.10.0";const jr={create:"create",load:"load",fullLoad:"fullLoad"},Qi={mark(l){performance.mark(l)},measure(l,t,n){performance.measure(l,t,n)}};function Sr(l){const t=l.name.split("?")[0];return o.a(t)&&t.includes("mapbox-gl.js")?"javascript":o.a(t)&&t.includes("mapbox-gl.css")?"css":o.b(t)?"fontRange":o.c(t)?"sprite":o.i(t)?"style":o.d(t)?"tilejson":"other"}var Xn,yr={},Oi=function(){if(Xn)return yr;function l(c){return!t(c)}function t(c){return typeof window>"u"||typeof document>"u"?"not a browser":function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var y,b,E=new Blob([""],{type:"text/javascript"}),D=URL.createObjectURL(E);try{b=new Worker(D),y=!0}catch{y=!1}return b&&b.terminate(),URL.revokeObjectURL(D),y}()?function(){var y=document.createElement("canvas");y.width=y.height=1;var b=y.getContext("2d");if(!b)return!1;var E=b.getImageData(0,0,1,1);return E&&E.width===y.width}()?(void 0===n[p=c&&c.failIfMajorPerformanceCaveat]&&(n[p]=function(y){var b,D,L,k,E=(D=y,L=document.createElement("canvas"),(k=Object.create(l.webGLContextAttributes)).failIfMajorPerformanceCaveat=D,L.getContext("webgl2",k));if(!E)return!1;try{b=E.createShader(E.VERTEX_SHADER)}catch{return!1}return!(!b||E.isContextLost())&&(E.shaderSource(b,"void main() {}"),E.compileShader(b),!0===E.getShaderParameter(b,E.COMPILE_STATUS))}(p)),n[p]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var p}Xn=1,yr.supported=l,yr.notSupportedReason=t;var n={};return l.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},yr}();function qi(l,t,n){const c=document.createElement(l);return null!=t&&(c.className=t),n&&n.appendChild(c),c}function Yn(l,t,n){const c=document.createElementNS("http://www.w3.org/2000/svg",l);for(const p of Object.keys(t))c.setAttributeNS(null,p,String(t[p]));return n&&n.appendChild(c),c}const Si=typeof document<"u"?document.documentElement&&document.documentElement.style:null,uo=Si&&void 0!==Si.userSelect?"userSelect":"WebkitUserSelect";let xr;function gi(){Si&&uo&&(xr=Si[uo],Si[uo]="none")}function $o(){Si&&uo&&(Si[uo]=xr)}function Da(l){l.preventDefault(),l.stopPropagation(),window.removeEventListener("click",Da,!0)}function Xt(){window.addEventListener("click",Da,!0),window.setTimeout(()=>{window.removeEventListener("click",Da,!0)},0)}function Ms(l,t){const n=l.getBoundingClientRect();return Qt(l,n,t)}function Gs(l,t){const n=l.getBoundingClientRect(),c=[];for(let p=0;p<t.length;p++)c.push(Qt(l,n,t[p]));return c}function Yt(l){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&2===l.button&&l.ctrlKey?0:l.button}function Qt(l,t,n){const c=l.offsetWidth===t.width?1:l.offsetWidth/t.width;return new o.P((n.clientX-t.left)*c,(n.clientY-t.top)*c)}const za="01",Zo="NO_ACCESS_TOKEN";class _c{constructor(t,n,c){this._transformRequestFn=t,this._customAccessToken=n,this._silenceAuthErrors=!!c,this._createSkuToken()}_createSkuToken(){const t=function(){let n="";for(let c=0;c<10;c++)n+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",za,n].join(""),tokenExpiresAt:Date.now()+432e5}}();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,n){return this._transformRequestFn&&this._transformRequestFn(t,n)||{url:t}}normalizeStyleURL(t,n){if(!o.f(t))return t;const c=Mr(t);return c.params.push(`sdk=js-${er}`),c.path=`/styles/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||n)}normalizeGlyphsURL(t,n){if(!o.f(t))return t;const c=Mr(t);return c.path=`/fonts/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||n)}normalizeModelURL(t,n){if(!o.f(t))return t;const c=Mr(t);return c.path=`/models/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||n)}normalizeSourceURL(t,n,c,p){if(!o.f(t))return t;const y=Mr(t);return y.path=`/v4/${y.authority}.json`,y.params.push("secure"),c&&y.params.push(`language=${c}`),p&&y.params.push(`worldview=${p}`),this._makeAPIURL(y,this._customAccessToken||n)}normalizeIconsetURL(t,n){const c=Mr(t);return o.f(t)?(c.path=`/styles/v1${c.path}/iconset.pbf`,this._makeAPIURL(c,this._customAccessToken||n)):ds(c)}normalizeSpriteURL(t,n,c,p){const y=Mr(t);return o.f(t)?(y.path=`/styles/v1${y.path}/sprite${n}${c}`,this._makeAPIURL(y,this._customAccessToken||p)):(y.path+=`${n}${c}`,ds(y))}normalizeTileURL(t,n,c){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!o.f(t))return t;const p=Mr(t);p.path=p.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${n||c&&"raster"!==p.authority&&512===c?"@2x":""}${o.m.supported?".webp":"$1"}`),"raster"===p.authority?p.path=`/${o.e.RASTER_URL_PREFIX}${p.path}`:"rasterarrays"===p.authority?p.path=`/${o.e.RASTERARRAYS_URL_PREFIX}${p.path}`:"3dtiles"===p.authority?p.path=`/${o.e.TILES3D_URL_PREFIX}${p.path}`:(p.path=p.path.replace(/^.+\/v4\//,"/"),p.path=`/${o.e.TILE_URL_VERSION}${p.path}`);const y=this._customAccessToken||function(b){for(const E of b){const D=E.match(/^access_token=(.*)$/);if(D)return D[1]}return null}(p.params)||o.e.ACCESS_TOKEN;return o.e.REQUIRE_ACCESS_TOKEN&&y&&this._skuToken&&p.params.push(`sku=${this._skuToken}`),this._makeAPIURL(p,y)}canonicalizeTileURL(t,n){const c=Mr(t);if(!c.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!c.path.match(/\.[\w]+$/))return t;let p="mapbox://";c.path.match(/^\/raster\/v1\//)?p+=`raster/${c.path.replace(`/${o.e.RASTER_URL_PREFIX}/`,"")}`:c.path.match(/^\/rasterarrays\/v1\//)?p+=`rasterarrays/${c.path.replace(`/${o.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:p+=`tiles/${c.path.replace(`/${o.e.TILE_URL_VERSION}/`,"")}`;let y=c.params;return n&&(y=y.filter(b=>!b.match(/^access_token=/))),y.length&&(p+=`?${y.join("&")}`),p}canonicalizeTileset(t,n){const c=!!n&&o.f(n),p=[];for(const y of t.tiles||[])o.h(y)?p.push(this.canonicalizeTileURL(y,c)):p.push(y);return p}_makeAPIURL(t,n){const c="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",p=Mr(o.e.API_URL);if(t.protocol=p.protocol,t.authority=p.authority,"http"===t.protocol){const y=t.params.indexOf("secure");y>=0&&t.params.splice(y,1)}if("/"!==p.path&&(t.path=`${p.path}${t.path}`),!o.e.REQUIRE_ACCESS_TOKEN)return ds(t);if(n=n||o.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!n)throw new Error(`An API access token is required to use Mapbox GL. ${c}`);if("s"===n[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${c}`)}return t.params=t.params.filter(y=>-1===y.indexOf("access_token")),t.params.push(`access_token=${n||""}`),ds(t)}}const oi=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Mr(l){const t=l.match(oi);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function ds(l){const t=l.params.length?`?${l.params.join("&")}`:"";return`${l.protocol}://${l.authority}${l.path}${t}`}const po="mapbox.eventData";function ci(l){if(!l)return null;const t=l.split(".");if(!t||3!==t.length)return null;try{return JSON.parse(o.j(t[1]))}catch{return null}}class qs{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const n=ci(o.e.ACCESS_TOKEN);let c="";return c=n&&n.u?o.k(n.u):o.e.ACCESS_TOKEN||"",t?`${po}.${t}:${c}`:`${po}:${c}`}fetchEventData(){const t=o.s("localStorage"),n=this.getStorageKey(),c=this.getStorageKey("uuid");if(t)try{const p=localStorage.getItem(n);p&&(this.eventData=JSON.parse(p));const y=localStorage.getItem(c);y&&(this.anonId=y)}catch{o.w("Unable to read from LocalStorage")}}saveEventData(){const t=o.s("localStorage"),n=this.getStorageKey(),c=this.getStorageKey("uuid"),p=this.anonId;if(t&&p)try{localStorage.setItem(c,p),Object.keys(this.eventData).length>=1&&localStorage.setItem(n,JSON.stringify(this.eventData))}catch{o.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,n,c,p){if(!o.e.EVENTS_URL)return;const y=Mr(o.e.EVENTS_URL);y.params.push(`access_token=${p||o.e.ACCESS_TOKEN||""}`);const b={event:this.type,created:new Date(t).toISOString()},E=n?o.l(b,n):b,D={url:ds(y),headers:{"Content-Type":"text/plain"},body:JSON.stringify([E])};this.pendingRequest=o.p(D,L=>{this.pendingRequest=null,c(L),this.saveEventData(),this.processRequests(p)})}queueRequest(t,n){this.queue.push(t),this.processRequests(n)}}const Ra=new class extends qs{constructor(l){super("appUserTurnstile"),this._customAccessToken=l}postTurnstileEvent(l,t){o.e.EVENTS_URL&&o.e.ACCESS_TOKEN&&Array.isArray(l)&&l.some(n=>o.f(n)||o.h(n))&&this.queueRequest(Date.now(),t)}processRequests(l){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=ci(o.e.ACCESS_TOKEN),n=t?t.u:o.e.ACCESS_TOKEN;let c=n!==this.eventData.tokenU;o.v(this.anonId)||(this.anonId=o.u(),c=!0);const p=this.queue.shift();if(this.eventData.lastSuccess){const y=new Date(this.eventData.lastSuccess),b=new Date(p),E=(p-this.eventData.lastSuccess)/864e5;c=c||E>=1||E<-1||y.getDate()!==b.getDate()}else c=!0;c?this.postEvent(p,{sdkIdentifier:"mapbox-gl-js",sdkVersion:er,skuId:za,"enabled.telemetry":!1,userId:this.anonId},y=>{y||(this.eventData.lastSuccess=p,this.eventData.tokenU=n)},l):this.processRequests()}},Hs=Ra.postTurnstileEvent.bind(Ra),ti=new class extends qs{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(l,t,n,c){this.skuToken=t,this.errorCb=c,o.e.EVENTS_URL&&(n||o.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},n):this.errorCb(new Error(Zo)))}processRequests(l){if(this.pendingRequest||0===this.queue.length)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),o.v(this.anonId)||(this.anonId=o.u()),this.postEvent(n,{sdkIdentifier:"mapbox-gl-js",sdkVersion:er,skuId:za,skuToken:this.skuToken,userId:this.anonId},c=>{c?this.errorCb(c):t&&(this.success[t]=!0)},l))}remove(){this.errorCb=null}},mh=ti.postMapLoadEvent.bind(ti),La=new class extends qs{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(l){let t=this.mapInstanceIdMap.get(l);return t||(t=o.u(),this.mapInstanceIdMap.set(l,t)),t}getEventId(l){const t=this.eventIdPerMapInstanceMap.get(l)||0;return this.eventIdPerMapInstanceMap.set(l,t+1),t}postStyleLoadEvent(l,t){const{map:n,style:c,importedStyles:p}=t;if(!o.e.EVENTS_URL||!l&&!o.e.ACCESS_TOKEN)return;const y=this.getMapInstanceId(n),b={mapInstanceId:y,eventId:this.getEventId(y),style:c};p.length&&(b.importedStyles=p),this.queueRequest({timestamp:Date.now(),payload:b},l)}processRequests(l){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:t,payload:n}=this.queue.shift();this.postEvent(t,n,()=>{},l)}},Xo=La.postStyleLoadEvent.bind(La),Yo=new class extends qs{constructor(){super("gljs.performance")}postPerformanceEvent(l,t){o.e.EVENTS_URL&&(l||o.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},l)}processRequests(l){if(this.pendingRequest||0===this.queue.length)return;const{timestamp:t,performanceData:n}=this.queue.shift(),c=function(p){const y=performance.getEntriesByType("resource"),b=performance.getEntriesByType("mark"),E=function(j){const Y={};if(j)for(const Z in j)if("other"!==Z)for(const Q of j[Z]){const J=`${Z}ResolveRangeMin`,re=`${Z}ResolveRangeMax`,he=`${Z}RequestCount`,ce=`${Z}RequestCachedCount`;Y[J]=Math.min(Y[J]||1/0,Q.startTime),Y[re]=Math.max(Y[re]||-1/0,Q.responseEnd);const ge=pe=>{void 0===Y[pe]&&(Y[pe]=0),++Y[pe]};void 0!==Q.transferSize&&0===Q.transferSize&&ge(ce),ge(he)}return Y}(function(j,Y){const Z={};if(j)for(const Q of j){const J=Y(Q);void 0===Z[J]&&(Z[J]=[]),Z[J].push(Q)}return Z}(y,Sr)),D=window.devicePixelRatio,L=navigator.connection||navigator.mozConnection||navigator.webkitConnection,k=L?L.effectiveType:void 0,N={counters:[],metadata:[],attributes:[]},V=(j,Y,Z)=>{null!=Z&&j.push({name:Y,value:Z.toString()})};for(const j in E)V(N.counters,j,E[j]);if(p.interactionRange[0]!==1/0&&p.interactionRange[1]!==-1/0&&(V(N.counters,"interactionRangeMin",p.interactionRange[0]),V(N.counters,"interactionRangeMax",p.interactionRange[1])),b)for(const j of Object.keys(jr)){const Y=jr[j],Z=b.find(Q=>Q.name===Y);Z&&V(N.counters,Y,Z.startTime)}return V(N.counters,"visibilityHidden",p.visibilityHidden),V(N.attributes,"style",function(j){if(j)for(const Y of j){const Z=Y.name.split("?")[0];if(o.i(Z)){const Q=Z.split("/").slice(-2);if(2===Q.length)return`mapbox://styles/${Q[0]}/${Q[1]}`}}}(y)),V(N.attributes,"terrainEnabled",p.terrainEnabled?"true":"false"),V(N.attributes,"fogEnabled",p.fogEnabled?"true":"false"),V(N.attributes,"projection",p.projection),V(N.attributes,"zoom",p.zoom),V(N.metadata,"devicePixelRatio",D),V(N.metadata,"connectionEffectiveType",k),V(N.metadata,"navigatorUserAgent",navigator.userAgent),V(N.metadata,"screenWidth",window.screen.width),V(N.metadata,"screenHeight",window.screen.height),V(N.metadata,"windowWidth",window.innerWidth),V(N.metadata,"windowHeight",window.innerHeight),V(N.metadata,"mapWidth",p.width/D),V(N.metadata,"mapHeight",p.height/D),V(N.metadata,"webglRenderer",p.renderer),V(N.metadata,"webglVendor",p.vendor),V(N.metadata,"sdkVersion",er),V(N.metadata,"sdkIdentifier","mapbox-gl-js"),N}(n);for(const p of c.metadata);for(const p of c.counters);for(const p of c.attributes);this.postEvent(t,c,()=>{},l)}},Es=Yo.postPerformanceEvent.bind(Yo),Ws=new class extends qs{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(l,t,n,c){if(!o.e.API_URL||!o.e.SESSION_PATH)return;const p=Mr(o.e.API_URL+o.e.SESSION_PATH);p.params.push(`sku=${t||""}`),p.params.push(`access_token=${c||o.e.ACCESS_TOKEN||""}`);const y={url:ds(p),headers:{"Content-Type":"text/plain"}};this.pendingRequest=o.g(y,b=>{this.pendingRequest=null,n(b),this.saveEventData(),this.processRequests(c)})}getSessionAPI(l,t,n,c){this.skuToken=t,this.errorCb=c,o.e.SESSION_PATH&&o.e.API_URL&&(n||o.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},n):this.errorCb(new Error(Zo)))}processRequests(l){if(this.pendingRequest||0===this.queue.length)return;const{id:t,timestamp:n}=this.queue.shift();t&&this.success[t]||this.getSession(n,this.skuToken,c=>{c?this.errorCb(c):t&&(this.success[t]=!0)},l)}remove(){this.errorCb=null}},Ie=Ws.getSessionAPI.bind(Ws),ka=new Set;function Oa(l,t){t?ka.add(l):ka.delete(l)}class Ko{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages=new Set}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,n){this._updatedSourceCaches[t]=n,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){const n=t.scope;this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._updatedLayers[n].add(t.id),this.setDirty()}removeLayer(t){const n=t.scope;this._removedLayers[n]=this._removedLayers[n]||{},this._updatedLayers[n]=this._updatedLayers[n]||new Set,this._removedLayers[n][t.id]=t,this._updatedLayers[n].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){const t={};for(const n in this._updatedLayers)t[n]=t[n]||{},t[n].updatedIds=Array.from(this._updatedLayers[n].values());for(const n in this._removedLayers)t[n]=t[n]||{},t[n].removedIds=Object.keys(this._removedLayers[n]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(){return Array.from(this._updatedImages.values())}updateImage(t){this._updatedImages.add(t),this.setDirty()}resetUpdatedImages(){this._updatedImages.clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages.clear()}}function pt(l){const{userImage:t}=l;return!!(t&&t.render&&t.render())&&(l.data.replace(new Uint8Array(t.data.buffer)),!0)}class Fn extends o.E{constructor(t){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded={},this.requestors=[],this.patterns={},this.atlasImage={},this.atlasTexture={},this.dirty=!0,this.spriteFormat=t,"raster"!==t&&o.t()&&(this.imageRasterizerDispatcher=new o.D(o.x(),this,"Image Rasterizer Worker",1))}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new o.I),this._imageRasterizer}createScope(t){this.images[t]={},this.loaded[t]=!1,this.updatedImages[t]={},this.patterns[t]={},this.callbackDispatchedThisFrame[t]={},this.atlasImage[t]=new o.r({width:1,height:1})}isLoaded(){for(const t in this.loaded)if(!this.loaded[t])return!1;return!0}setLoaded(t,n){if(this.loaded[n]!==t&&(this.loaded[n]=t,t)){for(const{ids:c,callback:p}of this.requestors)this._notify(c,n,p);this.requestors=[]}}hasImage(t,n){return!!this.getImage(t,n)}getImage(t,n){return this.images[n][t]}addImage(t,n,c){this._validate(t,c)&&(this.images[n][t]=c)}_validate(t,n){let c=!0;return this._validateStretch(n.stretchX,n.data&&n.data.width)||(this.fire(new o.y(new Error(`Image "${t}" has invalid "stretchX" value`))),c=!1),this._validateStretch(n.stretchY,n.data&&n.data.height)||(this.fire(new o.y(new Error(`Image "${t}" has invalid "stretchY" value`))),c=!1),this._validateContent(n.content,n)||(this.fire(new o.y(new Error(`Image "${t}" has invalid "content" value`))),c=!1),c}_validateStretch(t,n){if(!t)return!0;let c=0;for(const p of t){if(p[0]<c||p[1]<p[0]||n<p[1])return!1;c=p[1]}return!0}_validateContent(t,n){return!t||!(4!==t.length||!n.usvg&&(t[0]<0||n.data.width<t[0]||t[1]<0||n.data.height<t[1]||t[2]<0||n.data.width<t[2]||t[3]<0||n.data.height<t[3]))&&!(t[2]<t[0]||t[3]<t[1])}updateImage(t,n,c){c.version=this.images[n][t].version+1,this.images[n][t]=c,this.updatedImages[n][t]=!0,this.removeFromImageRasterizerCache(t,n)}removeFromImageRasterizerCache(t,n){"raster"!==this.spriteFormat&&(o.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:n}):this.imageRasterizer.removeImagesFromCacheByIds([t],n))}removeImage(t,n){const c=this.images[n][t];delete this.images[n][t],delete this.patterns[n][t],this.removeFromImageRasterizerCache(t,n),c.userImage&&c.userImage.onRemove&&c.userImage.onRemove()}listImages(t){return Object.keys(this.images[t])}getImages(t,n,c){let p=!0;const y=!!this.loaded[n];if(!y)for(const b of t)this.images[n][b]||(p=!1);y||p?this._notify(t,n,c):this.requestors.push({ids:t,scope:n,callback:c})}rasterizeImages({scope:t,imageTasks:n},c){const p={};for(const y in n){const b=n[y],E=this.getImage(b.id,t);E&&(p[y]={image:E,imageIdWithOptions:b})}o.t()?this.imageRasterizerDispatcher.getActor().send("rasterizeImages",{imageTasks:p,scope:t},c):this.rasterizeImagesInMainThread({imageTasks:p,scope:t},c)}rasterizeImagesInMainThread(t,n){const{imageTasks:c,scope:p}=t,y={};for(const b in c){const{image:E,imageIdWithOptions:D}=c[b];y[b]=this.imageRasterizer.rasterize(D,E,p,"")}n(void 0,y)}getUpdatedImages(t){return this.updatedImages[t]}_notify(t,n,c){const p={};for(const y of t){this.images[n][y]||this.fire(new o.z("styleimagemissing",{id:y}));const b=this.images[n][y];b?p[y]={data:b.usvg?null:b.data.clone(),pixelRatio:b.pixelRatio,sdf:b.sdf,usvg:b.usvg,version:b.version,stretchX:b.stretchX,stretchY:b.stretchY,content:b.content,hasRenderCallback:!(!b.userImage||!b.userImage.render)}:o.w(`Image "${y}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}c(null,p)}getPixelSize(t){const{width:n,height:c}=this.atlasImage[t];return{width:n,height:c}}getPattern(t,n,c){const p=this.patterns[n][t],y=this.getImage(t,n);if(!y)return null;if(p&&p.position.version===y.version)return p.position;if(p)p.position.version=y.version;else{y.usvg&&!y.data&&(y.data=this.imageRasterizer.rasterize(o.A.from(t).getPrimary(),y,n,""));const b={w:y.data.width+2*o.B,h:y.data.height+2*o.B,x:0,y:0},E=new o.C(b,y,o.B);this.patterns[n][t]={bin:b,position:E}}return this._updatePatternAtlas(n,c),this.patterns[n][t].position}bind(t,n){const c=t.gl;let p=this.atlasTexture[n];p?this.dirty&&(p.update(this.atlasImage[n]),this.dirty=!1):(p=new o.T(t,this.atlasImage[n],c.RGBA8),this.atlasTexture[n]=p),p.bind(c.LINEAR,c.CLAMP_TO_EDGE)}_updatePatternAtlas(t,n){const c=[];for(const E in this.patterns[t])c.push(this.patterns[t][E].bin);const{w:p,h:y}=o.F(c),b=this.atlasImage[t];b.resize({width:p||1,height:y||1});for(const E in this.patterns[t]){const{bin:D,position:L}=this.patterns[t][E];let k=L.padding;const N=D.x+k,V=D.y+k,j=this.images[t][E].data,Y=j.width,Z=j.height;k=k>1?k-1:k,o.r.copy(j,b,{x:0,y:0},{x:N,y:V},{width:Y,height:Z},n),o.r.copy(j,b,{x:0,y:Z-k},{x:N,y:V-k},{width:Y,height:k},n),o.r.copy(j,b,{x:0,y:0},{x:N,y:V+Z},{width:Y,height:k},n),o.r.copy(j,b,{x:Y-k,y:0},{x:N-k,y:V},{width:k,height:Z},n),o.r.copy(j,b,{x:0,y:0},{x:N+Y,y:V},{width:k,height:Z},n),o.r.copy(j,b,{x:Y-k,y:Z-k},{x:N-k,y:V-k},{width:k,height:k},n),o.r.copy(j,b,{x:0,y:Z-k},{x:N+Y,y:V-k},{width:k,height:k},n),o.r.copy(j,b,{x:0,y:0},{x:N+Y,y:V+Z},{width:k,height:k},n),o.r.copy(j,b,{x:Y-k,y:0},{x:N-k,y:V+Z},{width:k,height:k},n)}this.dirty=!0}beginFrame(){for(const t in this.images)this.callbackDispatchedThisFrame[t]={}}dispatchRenderCallbacks(t,n){for(const c of t){if(this.callbackDispatchedThisFrame[n][c])continue;this.callbackDispatchedThisFrame[n][c]=!0;const p=this.images[n][c];pt(p)&&this.updateImage(c,n,p)}}}function Er(l){const t=l.key,n=l.value,c=l.valueSpec||{},p=l.objectElementValidators||{},y=l.style,b=l.styleSpec;let E=[];const D=o.H(n);if("object"!==D)return[new o.V(t,n,`object expected, ${D} found`)];for(const L in n){const k=L.split(".")[0];let N;p[k]?N=p[k]:c[k]?N=ii:p["*"]?N=p["*"]:c["*"]&&(N=ii),N?E=E.concat(N({key:(t&&`${t}.`)+L,value:n[L],valueSpec:c[k]||c["*"],style:y,styleSpec:b,object:n,objectKey:L},n)):E.push(new o.G(t,n[L],`unknown property "${L}"`))}for(const L in c)p[L]||c[L].required&&void 0===c[L].default&&void 0===n[L]&&E.push(new o.V(t,n,`missing required property "${L}"`));return E}function $s(l){const t=l.value,n=l.valueSpec,c=l.style,p=l.styleSpec,y=l.key,b=l.arrayElementValidator||ii;if("array"!==o.H(t))return[new o.V(y,t,`array expected, ${o.H(t)} found`)];if(n.length&&t.length!==n.length)return[new o.V(y,t,`array length ${n.length} expected, length ${t.length} found`)];if(n["min-length"]&&t.length<n["min-length"])return[new o.V(y,t,`array length at least ${n["min-length"]} expected, length ${t.length} found`)];let E={type:n.value,values:n.values,minimum:n.minimum,maximum:n.maximum,function:void 0};p.$version<7&&(E.function=n.function),"object"===o.H(n.value)&&(E=n.value);let D=[];for(let L=0;L<t.length;L++)D=D.concat(b({array:t,arrayIndex:L,value:t[L],valueSpec:E,style:c,styleSpec:p,key:`${y}[${L}]`},!0));return D}function yi(l){const t=l.key,n=l.value,c=l.valueSpec;let p=o.H(n);if("number"===p&&n!=n&&(p="NaN"),"number"!==p)return[new o.V(t,n,`number expected, ${p} found`)];if("minimum"in c){let y=c.minimum;if("array"===o.H(c.minimum)&&(y=c.minimum[l.arrayIndex]),n<y)return[new o.V(t,n,`${n} is less than the minimum value ${y}`)]}if("maximum"in c){let y=c.maximum;if("array"===o.H(c.maximum)&&(y=c.maximum[l.arrayIndex]),n>y)return[new o.V(t,n,`${n} is greater than the maximum value ${y}`)]}return[]}function Hn(l){const t=l.valueSpec,n=o.K(l.value.type);let c,p,y,b={};const E="categorical"!==n&&void 0===l.value.property,D=!E,L="array"===o.H(l.value.stops)&&"array"===o.H(l.value.stops[0])&&"object"===o.H(l.value.stops[0][0]),k=Er({key:l.key,value:l.value,valueSpec:l.styleSpec.function,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{stops:function(j){if("identity"===n)return[new o.V(j.key,j.value,'identity function may not have a "stops" property')];let Y=[];const Z=j.value;return Y=Y.concat($s({key:j.key,value:Z,valueSpec:j.valueSpec,style:j.style,styleSpec:j.styleSpec,arrayElementValidator:N})),"array"===o.H(Z)&&0===Z.length&&Y.push(new o.V(j.key,Z,"array must have at least one stop")),Y},default:function(j){return ii({key:j.key,value:j.value,valueSpec:t,style:j.style,styleSpec:j.styleSpec})}}});return"identity"===n&&E&&k.push(new o.V(l.key,l.value,'missing required property "property"')),"identity"===n||l.value.stops||k.push(new o.V(l.key,l.value,'missing required property "stops"')),"exponential"===n&&l.valueSpec.expression&&!o.L(l.valueSpec)&&k.push(new o.V(l.key,l.value,"exponential functions not supported")),l.styleSpec.$version>=8&&(D&&!o.M(l.valueSpec)?k.push(new o.V(l.key,l.value,"property functions not supported")):E&&!o.N(l.valueSpec)&&k.push(new o.V(l.key,l.value,"zoom functions not supported"))),"categorical"!==n&&!L||void 0!==l.value.property||k.push(new o.V(l.key,l.value,'"property" property is required')),k;function N(j){let Y=[];const Z=j.value,Q=j.key;if("array"!==o.H(Z))return[new o.V(Q,Z,`array expected, ${o.H(Z)} found`)];if(2!==Z.length)return[new o.V(Q,Z,`array length 2 expected, length ${Z.length} found`)];if(L){if("object"!==o.H(Z[0]))return[new o.V(Q,Z,`object expected, ${o.H(Z[0])} found`)];if(void 0===Z[0].zoom)return[new o.V(Q,Z,"object stop key must have zoom")];if(void 0===Z[0].value)return[new o.V(Q,Z,"object stop key must have value")];const J=o.K(Z[0].zoom);if("number"!=typeof J)return[new o.V(Q,Z[0].zoom,"stop zoom values must be numbers")];if(y&&y>J)return[new o.V(Q,Z[0].zoom,"stop zoom values must appear in ascending order")];J!==y&&(y=J,p=void 0,b={}),Y=Y.concat(Er({key:`${Q}[0]`,value:Z[0],valueSpec:{zoom:{}},style:j.style,styleSpec:j.styleSpec,objectElementValidators:{zoom:yi,value:V}}))}else Y=Y.concat(V({key:`${Q}[0]`,value:Z[0],valueSpec:{},style:j.style,styleSpec:j.styleSpec},Z));return o.O(o.Q(Z[1]))?Y.concat([new o.V(`${Q}[1]`,Z[1],"expressions are not allowed in function stops.")]):Y.concat(ii({key:`${Q}[1]`,value:Z[1],valueSpec:t,style:j.style,styleSpec:j.styleSpec}))}function V(j,Y){const Z=o.H(j.value),Q=o.K(j.value),J=null!==j.value?j.value:Y;if(c){if(Z!==c)return[new o.V(j.key,J,`${Z} stop domain type must match previous stop domain type ${c}`)]}else c=Z;if("number"!==Z&&"string"!==Z&&"boolean"!==Z&&"number"!=typeof Q&&"string"!=typeof Q&&"boolean"!=typeof Q)return[new o.V(j.key,J,"stop domain value must be a number, string, or boolean")];if("number"!==Z&&"categorical"!==n){let re=`number expected, ${Z} found`;return o.M(t)&&void 0===n&&(re+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new o.V(j.key,J,re)]}return"categorical"!==n||"number"!==Z||"number"==typeof Q&&isFinite(Q)&&Math.floor(Q)===Q?"categorical"!==n&&"number"===Z&&"number"==typeof Q&&"number"==typeof p&&void 0!==p&&Q<p?[new o.V(j.key,J,"stop domain values must appear in ascending order")]:(p=Q,"categorical"===n&&Q in b?[new o.V(j.key,J,"stop domain values must be unique")]:(b[Q]=!0,[])):[new o.V(j.key,J,`integer expected, found ${String(Q)}`)]}}function is(l){const t=("property"===l.expressionContext?o.S:o.U)(o.Q(l.value),l.valueSpec);if("error"===t.result)return t.value.map(c=>new o.V(`${l.key}${c.key}`,l.value,c.message));const n=t.value.expression||t.value._styleExpression.expression;if("property"===l.expressionContext&&"text-font"===l.propertyKey&&!n.outputDefined())return[new o.V(l.key,l.value,`Invalid data expression for "${l.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===l.expressionContext&&"layout"===l.propertyType&&!o.W(n))return[new o.V(l.key,l.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===l.expressionContext)return Gr(n,l);if(l.expressionContext&&0===l.expressionContext.indexOf("cluster")){if(!o.X(n,["zoom","feature-state"]))return[new o.V(l.key,l.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===l.expressionContext&&!o.Y(n))return[new o.V(l.key,l.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Gr(l,t){const n=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const p of t.valueSpec.expression.parameters)n.delete(p);if(0===n.size)return[];const c=[];return l instanceof o.Z&&n.has(l.name)?[new o.V(t.key,t.value,`["${l.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(l.eachChild(p=>{c.push(...Gr(p,t))}),c)}function Fa(l){const t=l.key,n=l.value,c=l.valueSpec,p=[];return Array.isArray(c.values)?-1===c.values.indexOf(o.K(n))&&p.push(new o.V(t,n,`expected one of [${c.values.join(", ")}], ${JSON.stringify(n)} found`)):-1===Object.keys(c.values).indexOf(o.K(n))&&p.push(new o.V(t,n,`expected one of [${Object.keys(c.values).join(", ")}], ${JSON.stringify(n)} found`)),p}function Ar(l){return o.$(o.Q(l.value))?is(o.J({},l,{expressionContext:"filter",valueSpec:l.styleSpec[`filter_${l.layerType||"fill"}`]})):ai(l)}function ai(l){const t=l.value,n=l.key;if("array"!==o.H(t))return[new o.V(n,t,`array expected, ${o.H(t)} found`)];const c=l.styleSpec;let p,y=[];if(t.length<1)return[new o.V(n,t,"filter array must have at least 1 element")];switch(y=y.concat(Fa({key:`${n}[0]`,value:t[0],valueSpec:c.filter_operator,style:l.style,styleSpec:l.styleSpec})),o.K(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&"$type"===o.K(t[1])&&y.push(new o.V(n,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":3!==t.length&&y.push(new o.V(n,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(p=o.H(t[1]),"string"!==p&&y.push(new o.V(`${n}[1]`,t[1],`string expected, ${p} found`)));for(let b=2;b<t.length;b++)p=o.H(t[b]),"$type"===o.K(t[1])?y=y.concat(Fa({key:`${n}[${b}]`,value:t[b],valueSpec:c.geometry_type,style:l.style,styleSpec:l.styleSpec})):"string"!==p&&"number"!==p&&"boolean"!==p&&y.push(new o.V(`${n}[${b}]`,t[b],`string, number, or boolean expected, ${p} found`));break;case"any":case"all":case"none":for(let b=1;b<t.length;b++)y=y.concat(ai({key:`${n}[${b}]`,value:t[b],style:l.style,styleSpec:l.styleSpec}));break;case"has":case"!has":p=o.H(t[1]),2!==t.length?y.push(new o.V(n,t,`filter array for "${t[0]}" operator must have 2 elements`)):"string"!==p&&y.push(new o.V(`${n}[1]`,t[1],`string expected, ${p} found`))}return y}function Ai(l,t){const n=l.key,c=l.style,p=l.layer,y=l.styleSpec,b=l.value,E=l.objectKey,D=y[`${t}_${l.layerType}`];if(!D)return[];const L=E.match(/^(.*)-use-theme$/);if("paint"===t&&L&&D[L[1]])return o.O(b)?[].concat(ii({key:l.key,value:b,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:c,styleSpec:y,expressionContext:"property",propertyType:t,propertyKey:E})):ii({key:n,value:b,valueSpec:{type:"string"},style:c,styleSpec:y});const k=E.match(/^(.*)-transition$/);if("paint"===t&&k&&D[k[1]]&&D[k[1]].transition)return ii({key:n,value:b,valueSpec:y.transition,style:c,styleSpec:y});const N=l.valueSpec||D[E];if(!N)return[new o.G(n,b,`unknown property "${E}"`)];let V;if("string"===o.H(b)&&o.M(N)&&!N.tokens&&(V=/^{([^}]+)}$/.exec(b))){const Y=`\`{ "type": "identity", "property": ${V?JSON.stringify(V[1]):'"_"'} }\``;return[new o.V(n,b,`"${E}" does not support interpolation syntax\nUse an identity property function instead: ${Y}.`)]}const j=[];if("symbol"===l.layerType)"text-field"!==E||!c||c.glyphs||c.imports||j.push(new o.V(n,b,'use of "text-field" requires a style "glyphs" property')),"text-font"===E&&o.a0(o.Q(b))&&"identity"===o.K(b.type)&&j.push(new o.V(n,b,'"text-font" does not support identity functions'));else if("model"===l.layerType&&"paint"===t&&p&&p.layout&&p.layout.hasOwnProperty("model-id")&&o.M(N)&&(o.a1(N)||o.N(N))){const Y=o.S(o.Q(b),N),Z=Y.value.expression||Y.value._styleExpression.expression;Z&&!o.X(Z,["measure-light"])&&("model-emissive-strength"===E&&o.Y(Z)&&o.W(Z)||j.push(new o.V(n,b,`${E} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return j.concat(ii({key:l.key,value:b,valueSpec:N,style:c,styleSpec:y,expressionContext:"property",propertyType:t,propertyKey:E}))}function Yi(l){return Ai(l,"paint")}function zi(l){return Ai(l,"layout")}function Hi(l){let t=[];const n=l.value,c=l.key,p=l.style,y=l.styleSpec;n.type||n.ref||t.push(new o.V(c,n,'either "type" or "ref" is required'));let b=o.K(n.type);const E=o.K(n.ref);if(n.id){const D=o.K(n.id);for(let L=0;L<l.arrayIndex;L++){const k=p.layers[L];o.K(k.id)===D&&t.push(new o.V(c,n.id,`duplicate layer id "${n.id}", previously used at line ${k.id.__line__}`))}}if("ref"in n){let D;["type","source","source-layer","filter","layout"].forEach(L=>{L in n&&t.push(new o.V(c,n[L],`"${L}" is prohibited for ref layers`))}),p.layers.forEach(L=>{o.K(L.id)===E&&(D=L)}),D?D.ref?t.push(new o.V(c,n.ref,"ref cannot reference another ref layer")):b=o.K(D.type):"string"==typeof E&&t.push(new o.V(c,n.ref,`ref layer "${E}" not found`))}else if("background"!==b&&"sky"!==b&&"slot"!==b)if(n.source){const D=p.sources&&p.sources[n.source],L=D&&o.K(D.type);D?"vector"===L&&"raster"===b?t.push(new o.V(c,n.source,`layer "${n.id}" requires a raster source`)):"raster"===L&&"raster"!==b?t.push(new o.V(c,n.source,`layer "${n.id}" requires a vector source`)):"vector"!==L||n["source-layer"]?"raster-dem"===L&&"hillshade"!==b?t.push(new o.V(c,n.source,"raster-dem source can only be used with layer type 'hillshade'.")):"raster-array"!==L||["raster","raster-particle"].includes(b)?"line"!==b||!n.paint||!n.paint["line-gradient"]&&!n.paint["line-trim-offset"]||"geojson"===L&&D.lineMetrics?"raster-particle"===b&&"raster-array"!==L&&t.push(new o.V(c,n.source,`layer "${n.id}" requires a 'raster-array' source.`)):t.push(new o.V(c,n,`layer "${n.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new o.V(c,n.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new o.V(c,n,`layer "${n.id}" must specify a "source-layer"`)):t.push(new o.V(c,n.source,`source "${n.source}" not found`))}else t.push(new o.V(c,n,'missing required property "source"'));return t=t.concat(Er({key:c,value:n,valueSpec:y.layer,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{"*":()=>[],type:()=>ii({key:`${c}.type`,value:n.type,valueSpec:y.layer.type,style:l.style,styleSpec:l.styleSpec,object:n,objectKey:"type"}),filter:D=>Ar(o.J({layerType:b},D)),layout:D=>Er({layer:n,key:D.key,value:D.value,valueSpec:{},style:D.style,styleSpec:D.styleSpec,objectElementValidators:{"*":L=>zi(o.J({layerType:b},L))}}),paint:D=>Er({layer:n,key:D.key,value:D.value,valueSpec:{},style:D.style,styleSpec:D.styleSpec,objectElementValidators:{"*":L=>Yi(o.J({layerType:b,layer:n},L))}})}})),t}function Bn(l){const t=l.value,n=l.key,c=o.H(t);return"string"!==c?[new o.V(n,t,`string expected, ${c} found`)]:[]}const Ti={promoteId:function l({key:t,value:n}){if("string"===o.H(n))return Bn({key:t,value:n});if(Array.isArray(n)){const c=[],p=o.Q(n),y=o.U(p);return"error"===y.result&&y.value.forEach(b=>{c.push(new o.V(`${t}${b.key}`,null,`${b.message}`))}),o.X(y.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||c.push(new o.V(`${t}`,null,"promoteId expression should be only feature dependent")),c}{const c=[];for(const p in n)c.push(...l({key:`${t}.${p}`,value:n[p]}));return c}}};function Ba(l){const t=l.value,n=l.key,c=l.styleSpec,p=l.style;if(!t.type)return[new o.V(n,t,'"type" is required')];const y=o.K(t.type);let b=[];switch(["vector","raster","raster-dem","raster-array"].includes(y)&&(t.url||t.tiles||b.push(new o.G(n,t,'Either "url" or "tiles" is required.'))),y){case"vector":case"raster":case"raster-dem":case"raster-array":return b=b.concat(Er({key:n,value:t,valueSpec:c[`source_${y.replace("-","_")}`],style:l.style,styleSpec:c,objectElementValidators:Ti})),b;case"geojson":if(b=Er({key:n,value:t,valueSpec:c.source_geojson,style:p,styleSpec:c,objectElementValidators:Ti}),t.cluster)for(const E in t.clusterProperties){const[D,L]=t.clusterProperties[E],k="string"==typeof D?[D,["accumulated"],["get",E]]:D;b.push(...is({key:`${n}.${E}.map`,value:L,expressionContext:"cluster-map"})),b.push(...is({key:`${n}.${E}.reduce`,value:k,expressionContext:"cluster-reduce"}))}return b;case"video":return Er({key:n,value:t,valueSpec:c.source_video,style:p,styleSpec:c});case"image":return Er({key:n,value:t,valueSpec:c.source_image,style:p,styleSpec:c});case"canvas":return[new o.V(n,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return Fa({key:`${n}.type`,value:t.type,valueSpec:{values:Jo(c)},style:p,styleSpec:c})}}function Jo(l){return l.source.reduce((t,n)=>{const c=l[n];return"enum"===c.type.type&&(t=t.concat(Object.keys(c.type.values))),t},[])}function Bi(l){const t=l.value,n=l.styleSpec,c=n.light,p=l.style;let y=[];const b=o.H(t);if(void 0===t)return y;if("object"!==b)return y=y.concat([new o.V("light",t,`object expected, ${b} found`)]),y;for(const E in t){const D=E.match(/^(.*)-transition$/),L=E.match(/^(.*)-use-theme$/);y=y.concat(L&&c[L[1]]?ii({key:E,value:t[E],valueSpec:{type:"string"},style:p,styleSpec:n}):D&&c[D[1]]&&c[D[1]].transition?ii({key:E,value:t[E],valueSpec:n.transition,style:p,styleSpec:n}):c[E]?ii({key:E,value:t[E],valueSpec:c[E],style:p,styleSpec:n}):[new o.V(E,t[E],`unknown property "${E}"`)])}return y}function Ki(l){const t=l.value;let n=[];if(!t)return n;const c=o.H(t);if("object"!==c)return n=n.concat([new o.V("light-3d",t,`object expected, ${c} found`)]),n;const p=l.styleSpec,y=p["light-3d"],b=l.key,E=l.style,D=l.style.lights;for(const N of["type","id"])if(!(N in t))return n=n.concat([new o.V("light-3d",t,`missing property ${N} on light`)]),n;if(t.type&&D)for(let N=0;N<l.arrayIndex;N++){const V=o.K(t.type),j=D[N];o.K(j.type)===V&&n.push(new o.V(b,t.id,`duplicate light type "${t.type}", previously defined at line ${j.id.__line__}`))}const L=`properties_light_${t.type}`;if(!(L in p))return n=n.concat([new o.V("light-3d",t,`Invalid light type ${t.type}`)]),n;const k=p[L];for(const N in t)if("properties"===N){const V=t[N],j=o.H(V);if("object"!==j)return n=n.concat([new o.V("properties",V,`object expected, ${j} found`)]),n;for(const Y in V)n=n.concat(k[Y]?ii({key:Y,value:V[Y],valueSpec:k[Y],style:E,styleSpec:p}):[new o.G(l.key,V[Y],`unknown property "${Y}"`)])}else{const V=N.match(/^(.*)-transition$/),j=N.match(/^(.*)-use-theme$/);n=n.concat(j&&y[j[1]]?ii({key:N,value:t[N],valueSpec:{type:"string"},style:E,styleSpec:p}):V&&y[V[1]]&&y[V[1]].transition?ii({key:N,value:t[N],valueSpec:p.transition,style:E,styleSpec:p}):y[N]?ii({key:N,value:t[N],valueSpec:y[N],style:E,styleSpec:p}):[new o.G(N,t[N],`unknown property "${N}"`)])}return n}function Zs(l){const t=l.value,n=l.key,c=l.style,p=l.styleSpec,y=p.terrain;let b=[];const E=o.H(t);if(void 0===t||"null"===E)return b;if("object"!==E)return b=b.concat([new o.V("terrain",t,`object expected, ${E} found`)]),b;for(const D in t){const L=D.match(/^(.*)-transition$/),k=D.match(/^(.*)-use-theme$/);b=b.concat(k&&y[k[1]]?ii({key:D,value:t[D],valueSpec:{type:"string"},style:c,styleSpec:p}):L&&y[L[1]]&&y[L[1]].transition?ii({key:D,value:t[D],valueSpec:p.transition,style:c,styleSpec:p}):y[D]?ii({key:D,value:t[D],valueSpec:y[D],style:c,styleSpec:p}):[new o.G(D,t[D],`unknown property "${D}"`)])}if(t.source){const D=c.sources&&c.sources[t.source],L=D&&o.K(D.type);D?"raster-dem"!==L&&b.push(new o.V(n,t.source,`terrain cannot be used with a source of type ${String(L)}, it only be used with a "raster-dem" source type`)):b.push(new o.V(n,t.source,`source "${t.source}" not found`))}else b.push(new o.V(n,t,'terrain is missing required property "source"'));return b}function vr(l){const t=l.value,n=l.style,c=l.styleSpec,p=c.fog;let y=[];const b=o.H(t);if(void 0===t)return y;if("object"!==b)return y=y.concat([new o.V("fog",t,`object expected, ${b} found`)]),y;for(const E in t){const D=E.match(/^(.*)-transition$/),L=E.match(/^(.*)-use-theme$/);y=y.concat(L&&p[L[1]]?ii({key:E,value:t[E],valueSpec:{type:"string"},style:n,styleSpec:c}):D&&p[D[1]]&&p[D[1]].transition?ii({key:E,value:t[E],valueSpec:c.transition,style:n,styleSpec:c}):p[E]?ii({key:E,value:t[E],valueSpec:p[E],style:n,styleSpec:c}):[new o.G(E,t[E],`unknown property "${E}"`)])}return y}const fo={"*":()=>[],array:$s,boolean:function(l){const t=l.value,n=l.key,c=o.H(t);return"boolean"!==c?[new o.V(n,t,`boolean expected, ${c} found`)]:[]},number:yi,color:function(l){const t=l.key,n=l.value,c=o.H(n);return"string"!==c?[new o.V(t,n,`color expected, ${c} found`)]:null===o._.parseCSSColor(n)?[new o.V(t,n,`color expected, "${n}" found`)]:[]},enum:Fa,filter:Ar,function:Hn,layer:Hi,object:Er,source:Ba,model:o.a2,light:Bi,"light-3d":Ki,terrain:Zs,fog:vr,string:Bn,formatted:function(l){return 0===Bn(l).length?[]:is(l)},resolvedImage:function(l){return 0===Bn(l).length?[]:is(l)},projection:function(l){const t=l.value,n=l.styleSpec,c=n.projection,p=l.style;let y=[];const b=o.H(t);if("object"===b)for(const E in t)y=y.concat(ii({key:E,value:t[E],valueSpec:c[E],style:p,styleSpec:n}));else"string"!==b&&(y=y.concat([new o.V("projection",t,`object or string expected, ${b} found`)]));return y},import:function(l){const{value:t,styleSpec:n}=l,{data:c,...p}=t;Object.defineProperty(p,"__line__",{value:t.__line__,enumerable:!1});let y=Er(o.J({},l,{value:p,valueSpec:n.import}));return""===o.K(p.id)&&y.push(new o.V(`${l.key}.id`,p,"import id can't be an empty string")),c&&(y=y.concat(mo(c,n,{key:`${l.key}.data`}))),y}};function ii(l,t=!1){const n=l.value,c=l.valueSpec,p=l.styleSpec;if(c.expression&&o.a0(o.K(n)))return Hn(l);if(c.expression&&o.O(o.Q(n)))return is(l);if(c.type&&fo[c.type]){const y=fo[c.type](l);return!0===t&&y.length>0&&"array"===o.H(l.value)?is(l):y}return Er(o.J({},l,{valueSpec:c.type?p[c.type]:c}))}function kr(l){const t=l.value,n=l.key,c=Bn(l);return c.length||(-1===t.indexOf("{fontstack}")&&c.push(new o.V(n,t,'"glyphs" url must include a "{fontstack}" token')),-1===t.indexOf("{range}")&&c.push(new o.V(n,t,'"glyphs" url must include a "{range}" token'))),c}function mo(l,t=o.a3,n={}){return ii({key:n.key||"",value:l,valueSpec:t.$root,styleSpec:t,style:l,objectElementValidators:{glyphs:kr,"*":()=>[]}})}function Or(l,t=o.a3){return tr(mo(l,t))}const _o=l=>tr(Ba(l)),Qo=l=>tr(Bi(l)),Na=l=>tr(Ki(l)),Va=l=>tr(Zs(l)),ps=l=>tr(vr(l)),go=l=>tr(function(t){const n=t.value,c=t.style,p=t.styleSpec,y=p.snow;let b=[];const E=o.H(n);if(void 0===n)return b;if("object"!==E)return b=b.concat([new o.V("snow",n,`object expected, ${E} found`)]),b;for(const D in n){const L=D.match(/^(.*)-transition$/);b=b.concat(L&&y[L[1]]&&y[L[1]].transition?ii({key:D,value:n[D],valueSpec:p.transition,style:c,styleSpec:p}):y[D]?ii({key:D,value:n[D],valueSpec:y[D],style:c,styleSpec:p}):[new o.G(D,n[D],`unknown property "${D}"`)])}return b}(l)),yo=l=>tr(function(t){const n=t.value,c=t.style,p=t.styleSpec,y=p.rain;let b=[];const E=o.H(n);if(void 0===n)return b;if("object"!==E)return b=b.concat([new o.V("rain",n,`object expected, ${E} found`)]),b;for(const D in n){const L=D.match(/^(.*)-transition$/);b=b.concat(L&&y[L[1]]&&y[L[1]].transition?ii({key:D,value:n[D],valueSpec:p.transition,style:c,styleSpec:p}):y[D]?ii({key:D,value:n[D],valueSpec:y[D],style:c,styleSpec:p}):[new o.G(D,n[D],`unknown property "${D}"`)])}return b}(l)),fs=l=>tr(Hi(l)),En=l=>tr(Ar(l)),Sl=l=>tr(Yi(l)),pn=l=>tr(zi(l)),ln=l=>tr(o.a2(l));function tr(l){return l.slice().sort((t,n)=>t.line&&n.line?t.line-n.line:0)}function qr(l,t){let n=!1;if(t&&t.length)for(const c of t)c instanceof o.G?o.w(c.message):(l.fire(new o.y(new Error(c.message))),n=!0);return n}let Ge;class $ extends o.E{constructor(t,n="flat"){super(),this._transitionable=new o.a4(Ge||(Ge=new o.a5({anchor:new o.a6(o.a3.light.anchor),position:new o.a7(o.a3.light.position),color:new o.a6(o.a3.light.color),intensity:new o.a6(o.a3.light.intensity)}))),this.setLight(t,n),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,n,c={}){this._validate(Qo,t,c)||(this._transitionable.setTransitionOrValue(t),this.id=n)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,c){return(!c||!1!==c.validate)&&qr(this,t.call(Or,o.l({value:n,style:{glyphs:!0,sprite:!0},styleSpec:o.a3})))}}let te=class extends o.E{constructor(l,t,n,c){super(),this.scope=n,this._transitionable=new o.a4(new o.a5({source:new o.a6(o.a3.terrain.source),exaggeration:new o.a6(o.a3.terrain.exaggeration)}),n,c),this._transitionable.setTransitionOrValue(l,c),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t}get(){return this._transitionable.serialize()}set(l,t){this._transitionable.setTransitionOrValue(l,t)}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}getExaggeration(l){return this._transitioning.possiblyEvaluate(new o.a8(l)).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const l=this._transitionable._values.exaggeration;if(!l)return null;const t=l.value.expression;if(!t)return null;let n=-1,c=-1,p=1;for(const y of t.zoomStops)p=t.evaluate(new o.a8(y)),p>.01?(n=y,c=-1):c=y;return p<.01&&n>0&&c>n?[n,c]:null}isZoomDependent(){const l=this._transitionable._values.exaggeration;return null!=l&&null!=l.value&&null!=l.value.expression&&l.value.expression instanceof o.a9}};const me=.05;function Te(l,t,n,c){const p=o.ac(45,65,n),[y,b]=ze(l,c);let E=1-Math.min(1,Math.exp((t-y)/(b-y)*-6));return E*=E*E,E=Math.min(1,1.00747*E),E*p*l.alpha}function ze(l,t){const n=.5/Math.tan(.5*t);return[l.range[0]+n,l.range[1]+n]}function Me(l,t,n,c,p){const y=o.ab.vec3.transformMat4([],[t,n,c],p.mercatorFogMatrix);return Te(l,o.ab.vec3.length(y),p.pitch,p._fov)}function Ve(l,t,n,c,p,y,b){const E=[[n,c,0],[p,c,0],[p,y,0],[n,y,0]];let D=Number.MAX_VALUE,L=-Number.MAX_VALUE;for(const k of E){const N=o.ab.vec3.transformMat4([],k,t),V=o.ab.vec3.length(N);D=Math.min(D,V),L=Math.max(L,V)}return[Te(l,D,b.pitch,b._fov),Te(l,L,b.pitch,b._fov)]}class Fe extends o.E{constructor(t,n,c,p){super();const y=new o.a5({range:new o.a6(o.a3.fog.range),color:new o.a6(o.a3.fog.color),"color-use-theme":new o.a6({type:"string","property-type":"data-constant",default:"default"}),"high-color":new o.a6(o.a3.fog["high-color"]),"high-color-use-theme":new o.a6({type:"string","property-type":"data-constant",default:"default"}),"space-color":new o.a6(o.a3.fog["space-color"]),"space-color-use-theme":new o.a6({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new o.a6(o.a3.fog["horizon-blend"]),"star-intensity":new o.a6(o.a3.fog["star-intensity"]),"vertical-range":new o.a6(o.a3.fog["vertical-range"])});this._transitionable=new o.a4(y,c,new Map(p)),this.set(t,p),this._transitioning=this._transitionable.untransitioned(),this._transform=n,this.properties=new o.ad(y),this.scope=c}get state(){const t=this._transform,n="globe"===t.projection.name,c=o.ae(t.zoom),p=this.properties.get("range"),y=[.5,3];return{range:n?[o.af(y[0],p[0],c),o.af(y[1],p[1],c)]:p,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,n,c={}){if(this._validate(ps,t,c))return;const p=o.l({},t);for(const y of Object.keys(o.a3.fog))void 0===p[y]&&(p[y]=o.a3.fog[y].default);this._options=p,this._transitionable.setTransitionOrValue(this._options,n)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const n=this.properties&&this.properties.get("color")||1;return("globe"===this._transform.projection.name?1:o.ac(45,65,t))*n.a}getOpacityAtLatLng(t,n){return this._transform.projection.supportsFog?function(c,p,y){const b=o.aa.fromLngLat(p),E=y.elevation?y.elevation.getAtPointOrZero(b):0;return Me(c,b.x,b.y,E,y)}(this.state,t,n):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const n=this._transform.calculateFogTileMatrix(t.toUnwrapped());return Ve(this.state,n,0,0,o.ag,o.ag,this._transform)}getOpacityForBounds(t,n,c,p,y){return this._transform.projection.supportsFog?Ve(this.state,t,n,c,p,y,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?ze(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const n=[4,5,6,7];for(const c of n){const p=t.points[c];let y;if(p[2]>=0)y=p;else{const b=t.points[c-4];y=o.ah(b,p,b[2]/(b[2]-p[2]))}if(Me(this.state,y[0],y[1],0,this._transform)>=me)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,n,c){return(!c||!1!==c.validate)&&qr(this,t.call(Or,o.l({value:n,style:{glyphs:!0,sprite:!0},styleSpec:o.a3})))}}let Ue,Qe,ot,dt,Rt=class extends o.E{constructor(l,t,n,c){super();const p=Ue||(Ue=new o.a5({density:new o.a6(o.a3.snow.density),intensity:new o.a6(o.a3.snow.intensity),color:new o.a6(o.a3.snow.color),opacity:new o.a6(o.a3.snow.opacity),vignette:new o.a6(o.a3.snow.vignette),"vignette-color":new o.a6(o.a3.snow["vignette-color"]),"center-thinning":new o.a6(o.a3.snow["center-thinning"]),direction:new o.a6(o.a3.snow.direction),"flake-size":new o.a6(o.a3.snow["flake-size"])}));this._transitionable=new o.a4(p,n,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new o.ad(p),this.scope=n}get state(){const l=this.properties.get("opacity"),t=this.properties.get("color"),n=this.properties.get("direction"),c=o.ai(n[0]),p=-Math.max(o.ai(n[1]),.01),y=[Math.cos(c)*Math.cos(p),Math.sin(c)*Math.cos(p),Math.sin(p)],b=this.properties.get("vignette"),E=this.properties.get("vignette-color");return E.a=b,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new o.aj(t.r,t.g,t.b,t.a*l),direction:y,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:E}}get(){return this._transitionable.serialize()}set(l,t,n={}){if(this._validate(go,l,n))return;const c=o.l({},l);for(const p of Object.keys(o.a3.snow))void 0===c[p]&&(c[p]=o.a3.snow[p].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,n){return(!n||!1!==n.validate)&&qr(this,l.call(Or,o.l({value:t,style:{glyphs:!0,sprite:!0},styleSpec:o.a3})))}},Nt=class extends o.E{constructor(l,t,n,c){super();const p=Qe||(Qe=new o.a5({density:new o.a6(o.a3.rain.density),intensity:new o.a6(o.a3.rain.intensity),color:new o.a6(o.a3.rain.color),opacity:new o.a6(o.a3.rain.opacity),vignette:new o.a6(o.a3.rain.vignette),"vignette-color":new o.a6(o.a3.rain["vignette-color"]),"center-thinning":new o.a6(o.a3.rain["center-thinning"]),direction:new o.a6(o.a3.rain.direction),"droplet-size":new o.a6(o.a3.rain["droplet-size"]),"distortion-strength":new o.a6(o.a3.rain["distortion-strength"])}));this._transitionable=new o.a4(p,n,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new o.ad(p),this.scope=n}get state(){const l=this.properties.get("opacity"),t=this.properties.get("color"),n=this.properties.get("direction"),c=o.ai(n[0]),p=-Math.max(o.ai(n[1]),.01),y=[Math.cos(c)*Math.cos(p),Math.sin(c)*Math.cos(p),Math.sin(p)],b=this.properties.get("vignette-color");return b.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new o.aj(t.r,t.g,t.b,t.a*l),direction:y,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:b}}get(){return this._transitionable.serialize()}set(l,t,n={}){if(this._validate(yo,l,n))return;const c=o.l({},l);for(const p of Object.keys(o.a3.rain))void 0===c[p]&&(c[p]=o.a3.rain[p].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,n){return(!n||!1!==n.validate)&&qr(this,l.call(Or,o.l({value:t,style:{glyphs:!0,sprite:!0},styleSpec:o.a3})))}};class Vt extends o.E{constructor(t,n,c,p){super(),this.scope=c,this._options=t,this.properties=new o.ad(n),this._transitionable=new o.a4(n,c,new Map(p)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,n){this._options=t,this._transitionable.setTransitionOrValue(t.properties,n)}shadowsEnabled(){return!!this.properties&&!0===this.properties.get("cast-shadows")}}class Ft{constructor(t,n,c,p){this.screenBounds=t,this.cameraPoint=n,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=c,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,p)}static createFromScreenPoints(t,n){let c,p;if(t instanceof o.P||"number"==typeof t[0]){const y=o.P.convert(t);c=[y],p=n.isPointAboveHorizon(y)}else{const y=o.P.convert(t[0]),b=o.P.convert(t[1]);c=[y,b],p=o.al(y,b).every(E=>n.isPointAboveHorizon(E))}return new Ft(c,n.getCameraPoint(),p,n)}isPointQuery(){return 1===this.screenBounds.length}bufferedScreenGeometry(t){return o.al(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const n=this.screenBounds[0],c=1===this.screenBounds.length?this.screenBounds[0].add(new o.P(1,1)):this.screenBounds[1],p=o.al(n,c,0,!1);return this.cameraPoint.y>c.y&&(this.cameraPoint.x>n.x&&this.cameraPoint.x<c.x?p.splice(3,0,this.cameraPoint):this.cameraPoint.x>=c.x?p[2]=this.cameraPoint:this.cameraPoint.x<=n.x&&(p[3]=this.cameraPoint)),o.am(p,t)}bufferedCameraGeometryGlobe(t){const n=this.screenBounds[0],c=1===this.screenBounds.length?this.screenBounds[0].add(new o.P(1,1)):this.screenBounds[1],p=o.al(n,c,t),y=this.cameraPoint.clone();switch(3*((y.y>n.y)+(y.y>c.y))+((y.x>n.x)+(y.x>c.x))){case 0:p[0]=y,p[4]=y.clone();break;case 1:p.splice(1,0,y);break;case 2:p[1]=y;break;case 3:p.splice(4,0,y);break;case 5:p.splice(2,0,y);break;case 6:p[3]=y;break;case 7:p.splice(3,0,y);break;case 8:p[2]=y}return p}containsTile(t,n,c,p=0){const y=t.queryPadding/n._pixelsPerMercatorPixel+1,b=c?this._bufferedCameraMercator(y,n):this._bufferedScreenMercator(y,n);let E=t.tileID.wrap+(b.unwrapped?p:0);const D=b.polygon.map(Q=>o.an(t.tileTransform,Q,E));if(!o.ao(D,0,0,o.ag,o.ag))return;E=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?p:0);const L=this.screenGeometryMercator.polygon.map(Q=>o.ap(t.tileTransform,Q,E)),k=L.map(Q=>new o.P(Q[0],Q[1])),N=n.getFreeCameraOptions().position||new o.aa(0,0,0),V=o.ap(t.tileTransform,N,E),j=L.map(Q=>{const J=o.ab.vec3.sub(Q,Q,V);return o.ab.vec3.normalize(J,J),new o.aq(V,J)}),Y=o.ar(t,1,n.zoom)*n._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:k,tilespaceRays:j,bufferedTilespaceGeometry:D,bufferedTilespaceBounds:(Z=o.as(D),Z.min.x=o.aw(Z.min.x,0,o.ag),Z.min.y=o.aw(Z.min.y,0,o.ag),Z.max.x=o.aw(Z.max.x,0,o.ag),Z.max.y=o.aw(Z.max.y,0,o.ag),Z),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:Y};var Z}_bufferedScreenMercator(t,n){const c=Gt(t);if(this._screenRaycastCache[c])return this._screenRaycastCache[c];{let p;return p="globe"===n.projection.name?this._projectAndResample(this.bufferedScreenGeometry(t),n):{polygon:this.bufferedScreenGeometry(t).map(y=>n.pointCoordinate3D(y)),unwrapped:!0},this._screenRaycastCache[c]=p,p}}_bufferedCameraMercator(t,n){const c=Gt(t);if(this._cameraRaycastCache[c])return this._cameraRaycastCache[c];{let p;return p="globe"===n.projection.name?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),n):{polygon:this.bufferedCameraGeometry(t).map(y=>n.pointCoordinate3D(y)),unwrapped:!0},this._cameraRaycastCache[c]=p,p}}_projectAndResample(t,n){const c=function(y,b){const E=o.ab.mat4.multiply([],b.pixelMatrix,b.globeMatrix),D=[0,-o.ax,0,1],L=[0,o.ax,0,1],k=[0,0,0,1];o.ab.vec4.transformMat4(D,D,E),o.ab.vec4.transformMat4(L,L,E),o.ab.vec4.transformMat4(k,k,E);const N=new o.P(D[0]/D[3],D[1]/D[3]),V=new o.P(L[0]/L[3],L[1]/L[3]),j=o.au(y,N)&&D[3]<k[3],Y=o.au(y,V)&&L[3]<k[3];if(!j&&!Y)return null;const Z=function(_e,de,be){for(let Ee=1;Ee<_e.length;Ee++){const qe=mi(de.pointCoordinate3D(_e[Ee-1]).x),Le=mi(de.pointCoordinate3D(_e[Ee]).x);if(be<0){if(qe<Le)return{idx:Ee,t:-qe/(Le-1-qe)}}else if(Le<qe)return{idx:Ee,t:(1-qe)/(Le+1-qe)}}return null}(y,b,j?-1:1);if(!Z)return null;const{idx:Q,t:J}=Z;let re=Q>1?ei(y.slice(0,Q),b):[],he=Q<y.length?ei(y.slice(Q),b):[];re=re.map(_e=>new o.P(mi(_e.x),_e.y)),he=he.map(_e=>new o.P(mi(_e.x),_e.y));const ce=[...re];0===ce.length&&ce.push(he[he.length-1]);const ge=o.af(ce[ce.length-1].y,(0===he.length?re[0]:he[0]).y,J);let pe;return pe=j?[new o.P(0,ge),new o.P(0,0),new o.P(1,0),new o.P(1,ge)]:[new o.P(1,ge),new o.P(1,1),new o.P(0,1),new o.P(0,ge)],ce.push(...pe),0===he.length?ce.push(re[0]):ce.push(...he),{polygon:ce.map(_e=>new o.aa(_e.x,_e.y)),unwrapped:!1}}(t,n);if(c)return c;const p=function(y,b){let E=!1,D=-1/0,L=0;for(let N=0;N<y.length-1;N++)y[N].x>D&&(D=y[N].x,L=N);for(let N=0;N<y.length-1;N++){const V=(L+N)%(y.length-1),j=y[V],Y=y[V+1];Math.abs(j.x-Y.x)>.5&&(j.x<Y.x?(j.x+=1,0===V&&(y[y.length-1].x+=1)):(Y.x+=1,V+1===y.length-1&&(y[0].x+=1)),E=!0)}const k=o.at(b.center.lng);return E&&k<Math.abs(k-1)&&y.forEach(N=>{N.x-=1}),{polygon:y,unwrapped:E}}(ei(t,n).map(y=>new o.P(mi(y.x),y.y)),n);return{polygon:p.polygon.map(y=>new o.aa(y.x,y.y)),unwrapped:p.unwrapped}}}function ei(l,t){return o.av(l,n=>{const c=t.pointCoordinate3D(n);n.x=c.x,n.y=c.y},1/256)}function mi(l){return l<0?1+l%1:l%1}function Gt(l){return 100*l|0}function Ii(l,t,n,c,p){const y=function(E,D){if(E)return p(E);if(D){if(l.url&&D.tiles&&l.tiles&&delete l.tiles,D.variants){if(!Array.isArray(D.variants))return p(new Error("variants must be an array"));for(const k of D.variants){if(null==k||"object"!=typeof k||k.constructor!==Object)return p(new Error("variant must be an object"));if(!Array.isArray(k.capabilities))return p(new Error("capabilities must be an array"));if(1===k.capabilities.length&&"meshopt"===k.capabilities[0]){D=o.l(D,k);break}}}const L=o.ay(o.l({},D,l),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);L.tiles=t.canonicalizeTileset(L,l.url),p(null,L)}},b=function(E,D,L){if(!E)return null;if(!D&&!L)return E;L=L||E.worldview_default;const k=Object.values(E.language||{});if(0===k.length)return null;const N=Object.values(E.worldview||{});if(0===N.length)return null;const V=k.every(Y=>Y===D),j=N.every(Y=>Y===L);return V&&j?E:D in(E.language_options||{})||L in(E.worldview_options||{})?null:E.language_options&&E.worldview_options?E:null}(l.data,n,c);return b?o.q.frame(()=>y(null,b)):l.url?o.n(t.transformRequest(t.normalizeSourceURL(l.url,null,n,c),o.R.Source),y):o.q.frame(()=>{const{data:E,...D}=l;y(null,D)})}class ui{constructor(t,n,c){this.bounds=o.az.convert(this.validateBounds(t)),this.minzoom=n||0,this.maxzoom=c||24}validateBounds(t){return Array.isArray(t)&&4===t.length?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}contains(t){const n=Math.pow(2,t.z),c=Math.floor(o.at(this.bounds.getWest())*n),p=Math.floor(o.aA(this.bounds.getNorth())*n),y=Math.ceil(o.at(this.bounds.getEast())*n),b=Math.ceil(o.aA(this.bounds.getSouth())*n);return t.x>=c&&t.x<y&&t.y>=p&&t.y<b}}class yn extends o.E{constructor(t,n,c,p){if(super(),this.id=t,this.dispatcher=c,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,o.l(this,o.ay(n,["url","scheme","tileSize","promoteId"])),this._options=o.l({type:"vector"},n),this._collectResourceTiming=!!n.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(p),this._tileWorkers={},this._deduped=new o.aB}load(t){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"}));const n=Array.isArray(this.map._language)?this.map._language.join():this.map._language,c=this.map.getWorldview();this._tileJSONRequest=Ii(this._options,this.map._requestManager,n,c,(p,y)=>{if(this._tileJSONRequest=null,this._loaded=!0,p)n&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${n}`),c&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${c}`),this.fire(new o.y(p));else if(y){if(o.l(this,y),this.hasWorldviews=!!y.worldview_options,y.worldview_default&&(this.worldviewDefault=y.worldview_default),y.vector_layers){this.vectorLayers=y.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const b of y.vector_layers)this.vectorLayerIds.push(b.id),y.worldview&&y.worldview[b.source]&&this.localizableLayerIds.add(b.id)}y.bounds&&(this.tileBounds=new ui(y.bounds,this.minzoom,this.maxzoom)),Hs(y.tiles,this.map._requestManager._customAccessToken),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}t&&t(p)})}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=o.aC(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return o.l({},this._options)}loadTile(t,n){const c=t.tileID.canonical.url(this.tiles,this.scheme),p=this.map._requestManager.normalizeTileURL(c),y=this.map._requestManager.transformRequest(p,o.R.Tile),b=this.map.style?this.map.style.getLut(this.scope):null,E=b?{image:b.image.clone()}:null,D={request:y,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:E,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:o.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor()};if(this.hasWorldviews&&o.f(c)&&(D.worldview=this.map.getWorldview()||this.worldviewDefault,D.localizableLayerIds=this.localizableLayerIds),D.request.collectResourceTiming=this._collectResourceTiming,t.actor&&"expired"!==t.state)"loading"===t.state?t.reloadCallback=n:t.request=t.actor.send("reloadTile",D,L.bind(this));else if(t.actor=this._tileWorkers[p]=this._tileWorkers[p]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",D,L.bind(this),void 0,!0);else{const k=o.aD.call({deduped:this._deduped},D,(N,V)=>{N||!V?L.call(this,N):(D.data={cacheControl:V.cacheControl,expires:V.expires,rawData:V.rawData.slice(0)},t.actor&&t.actor.send("loadTile",D,L.bind(this),void 0,!0))},!0);t.request={cancel:k}}function L(k,N){return delete t.request,t.aborted?n(null):k&&404!==k.status?n(k):(N&&N.resourceTiming&&(t.resourceTiming=N.resourceTiming),this.map._refreshExpiredTiles&&N&&t.setExpiryData(N),t.loadVectorData(N,this.map.painter),o.aE(this.dispatcher),n(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,n){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class ir extends o.E{constructor(t,n,c,p){super(),this.id=t,this.dispatcher=c,this.setEventedParent(p),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=o.l({type:"raster"},n),o.l(this,o.ay(n,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"})),this._tileJSONRequest=Ii(this._options,this.map._requestManager,null,null,(n,c)=>{this._tileJSONRequest=null,this._loaded=!0,n?this.fire(new o.y(n)):c&&(o.l(this,c),c.raster_layers&&(this.rasterLayers=c.raster_layers,this.rasterLayerIds=this.rasterLayers.map(p=>p.id)),c.bounds&&(this.tileBounds=new ui(c.bounds,this.minzoom,this.maxzoom)),Hs(c.tiles),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))),t&&t(n)})}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=o.aC(this.id,this.scope);this.load(()=>this.map.style.clearSource(t))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return o.l({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,n){const c=o.q.devicePixelRatio>=2,p=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),c,this.tileSize);t.request=o.o(this.map._requestManager.transformRequest(p,o.R.Tile),(y,b,E,D)=>(delete t.request,t.aborted?(t.state="unloaded",n(null)):y?(t.state="errored",n(y)):b?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:E,expires:D}),t.setTexture(b,this.map.painter),t.state="loaded",o.aE(this.dispatcher),void n(null)):n(null)))}abortTile(t,n){t.request&&(t.request.cancel(),delete t.request),n&&n()}unloadTile(t,n){t.texture&&t.texture instanceof o.T?(t.destroy(!0),t.texture&&t.texture instanceof o.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),n&&n()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class zn extends ir{constructor(t,n,c,p){super(t,n,c,p),this.type="raster-array",this.maxzoom=22,this._options=o.l({type:"raster-array"},n)}triggerRepaint(t){const n=this.map.painter._terrain,c=this.map.style.getSourceCache(this.id);n&&n.enabled&&c&&n._clearRenderCacheForTile(c.id,t.tileID),this.map.triggerRepaint()}loadTile(t,n){const c=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),p=this.map._requestManager.transformRequest(c,o.R.Tile);t.requestParams=p,t.actor||(t.actor=this.dispatcher.getActor()),t.request=t.fetchHeader(void 0,(y,b,E,D)=>(delete t.request,t.aborted?(t.state="unloaded",n(null)):y?20===y.code?void 0:(t.state="errored",n(y)):(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:E,expires:D}),t.state="empty",void n(null))))}unloadTile(t,n){const c=t.texture;c&&c instanceof o.T?(t.destroy(!0),this.map.painter.saveTileTexture(c)):(t.destroy(),t.flushQueues(),t._isHeaderLoaded=!1,delete t._mrt,delete t.textureDescriptor),t.fbo&&(t.fbo.destroy(),delete t.fbo),delete t.request,delete t.requestParams,delete t.neighboringTiles,t.state="unloaded"}prepareTile(t,n,c){t._isHeaderLoaded&&("empty"!==t.state&&(t.state="reloading"),t.fetchBand(n,c,(p,y)=>{if(p)return t.state="errored",this.fire(new o.y(p)),void this.triggerRepaint(t);y&&(t.setTexture(y,this.map.painter),t.state="loaded",this.triggerRepaint(t))}))}getInitialBand(t){if(!this.rasterLayers)return 0;const n=this.rasterLayers.find(({id:y})=>y===t),c=n&&n.fields,p=c&&c.bands&&c.bands;return p?p[0]:0}getTextureDescriptor(t,n,c){if(!t)return;const p=n.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!p)return;let y=null;n instanceof o.aH?y=n.paint.get("raster-array-band"):n instanceof o.aI&&(y=n.paint.get("raster-particle-array-band"));const b=y||this.getInitialBand(p);if(null!=b)if(t.textureDescriptor){if(!t.updateNeeded(p,b)||c)return Object.assign({},t.textureDescriptor,{texture:t.texture})}else this.prepareTile(t,p,b)}}const Nn={vector:yn,raster:ir,"raster-dem":class extends ir{constructor(l,t,n,c){super(l,t,n,c),this.type="raster-dem",this.maxzoom=22,this._options=o.l({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(l,t){const n=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function c(p,y){p&&(l.state="errored",t(p)),y&&(l.dem=y,l.dem.onDeserialize(),l.needsHillshadePrepare=!0,l.needsDEMTextureUpload=!0,l.state="loaded",t(null))}l.request=o.o(this.map._requestManager.transformRequest(n,o.R.Tile),function(p,y,b,E){if(delete l.request,l.aborted)l.state="unloaded",t(null);else if(p)l.state="errored",t(p);else if(y){this.map._refreshExpiredTiles&&l.setExpiryData({cacheControl:b,expires:E});const D=ImageBitmap&&y instanceof ImageBitmap&&o.t(),L=1-(y.width-o.aF(y.width))/2;L<1||l.neighboringTiles||(l.neighboringTiles=this._getNeighboringTiles(l.tileID));const k=D?y:o.q.getImageData(y,L),N={uid:l.uid,coord:l.tileID,source:this.id,scope:this.scope,rawImageData:k,encoding:this.encoding,padding:L};l.actor&&"expired"!==l.state||(l.actor=this.dispatcher.getActor(),l.actor.send("loadDEMTile",N,c.bind(this),void 0,!0))}}.bind(this))}_getNeighboringTiles(l){const t=l.canonical,n=Math.pow(2,t.z),c=(t.x-1+n)%n,p=0===t.x?l.wrap-1:l.wrap,y=(t.x+1+n)%n,b=t.x+1===n?l.wrap+1:l.wrap,E={};return E[new o.aG(l.overscaledZ,p,t.z,c,t.y).key]={backfilled:!1},E[new o.aG(l.overscaledZ,b,t.z,y,t.y).key]={backfilled:!1},t.y>0&&(E[new o.aG(l.overscaledZ,p,t.z,c,t.y-1).key]={backfilled:!1},E[new o.aG(l.overscaledZ,l.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},E[new o.aG(l.overscaledZ,b,t.z,y,t.y-1).key]={backfilled:!1}),t.y+1<n&&(E[new o.aG(l.overscaledZ,p,t.z,c,t.y+1).key]={backfilled:!1},E[new o.aG(l.overscaledZ,l.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},E[new o.aG(l.overscaledZ,b,t.z,y,t.y+1).key]={backfilled:!1}),E}},"raster-array":zn,geojson:class extends o.E{constructor(l,t,n,c){super(),this.id=l,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=n.getActor(),this.setEventedParent(c),this._data=t.data,this._options=o.l({},t),this._collectResourceTiming=t.collectResourceTiming,void 0!==t.maxzoom&&(this.maxzoom=t.maxzoom),void 0!==t.minzoom&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const p=o.ag/this.tileSize;this.workerOptions=o.l({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(void 0!==t.buffer?t.buffer:128)*p,tolerance:(void 0!==t.tolerance?t.tolerance:.375)*p,extent:o.ag,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:void 0!==t.clusterMaxZoom?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:o.ag,radius:(void 0!==t.clusterRadius?t.clusterRadius:50)*p,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(l){this.map=l,this.setData(this._data)}setData(l){return this._data=l,this._updateWorkerData(),this}updateData(l){if(!this._options.dynamic)return this.fire(new o.y(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if("string"!=typeof l&&("Feature"===l.type&&(l={type:"FeatureCollection",features:[l]}),"FeatureCollection"!==l.type))return this.fire(new o.y(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&"string"!=typeof l&&"string"!=typeof this._data&&"FeatureCollection"===this._data.type){const t=new Map;for(const n of this._data.features)t.set(n.id,n);for(const n of l.features)t.set(n.id,n);this._data.features=[...t.values()]}else this._data=l;return this._updateWorkerData(!0),this}getClusterExpansionZoom(l,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterChildren(l,t){return this.actor.send("geojson.getClusterChildren",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterLeaves(l,t,n,c){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:l,limit:t,offset:n},c),this}_updateWorkerData(l=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new o.z("dataloading",{dataType:"source"})),this._loaded=!1;const t=o.l({append:l},this.workerOptions);t.scope=this.scope;const n=this._data;"string"==typeof n?(t.request=this.map._requestManager.transformRequest(o.q.resolveURL(n),o.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(n),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,(c,p)=>{if(this._loaded=!0,this._pendingLoad=null,c)this.fire(new o.y(c));else{const y={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&p&&p.resourceTiming&&p.resourceTiming[this.id]&&(y.resourceTiming=p.resourceTiming[this.id]),l&&(this._partialReload=!0),this.fire(new o.z("data",y)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(l),this._coalesce=!1)})}loaded(){return this._loaded}reload(){const l=o.aC(this.id,this.scope);this.map.style.clearSource(l),this._updateWorkerData()}loadTile(l,t){const n=l.actor?"reloadTile":"loadTile";l.actor=this.actor;const c=this.map.style?this.map.style.getLut(this.scope):null,p=c?{image:c.image.clone()}:null,y=this._partialReload,b={type:this.type,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:p,scope:this.scope,pixelRatio:o.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,scaleFactor:this.map.getScaleFactor(),partial:y};l.request=this.actor.send(n,b,(E,D)=>y&&!D?(l.state="loaded",t(null)):(delete l.request,l.destroy(),l.aborted?t(null):E?t(E):(l.loadVectorData(D,this.map.painter,"reloadTile"===n),t(null))),void 0,"loadTile"===n)}abortTile(l){l.request&&(l.request.cancel(),delete l.request),l.aborted=!0}unloadTile(l,t){this.actor.send("removeTile",{uid:l.uid,type:this.type,source:this.id,scope:this.scope}),l.destroy()}onRemove(l){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return o.l({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends o.aJ{constructor(l,t,n,c){super(l,t,n,c),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const l=this.options;this.urls=[];for(const t of l.urls)this.urls.push(this.map._requestManager.transformRequest(t,o.R.Source).url);o.aK(this.urls,(t,n)=>{this._loaded=!0,t?this.fire(new o.y(t)):n&&(this.video=n,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint()}),this.map&&this.video.play(),this._finishLoading())})}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(l){if(this.video){const t=this.video.seekable;l<t.start(0)||l>t.end(0)?this.fire(new o.y(new o.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=l}}getVideo(){return this.video}onAdd(l){this.map||(this.map=l,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const l=this.map.painter.context,t=l.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new o.T(l,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(l)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:o.aJ,model:class extends o.E{constructor(l,t,n,c){super(),this.id=l,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){const l=[];for(const t in this._options.models){const n=this._options.models[t],c=o.aM(this.map._requestManager.transformRequest(n.uri,o.R.Model).url).then(p=>{if(!p)return;const y=o.aN(p),b=new o.aO(t,n.position,n.orientation,y);b.computeBoundsAndApplyParent(),this.models.push(b)}).catch(p=>{this.fire(new o.y(new Error(`Could not load model ${t} from ${n.uri}: ${p.message}`)))});l.push(c)}return Promise.allSettled(l).then(()=>{this._loaded=!0,this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"}))}).catch(t=>{this.fire(new o.y(new Error(`Could not load models: ${t.message}`)))})}onAdd(l){this.map=l,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(l,t){}serialize(){return{type:"model"}}},"batched-model":class extends o.E{constructor(l,t,n,c){super(),this.type="batched-model",this.id=l,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=n,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(c)}onAdd(l){this.map=l,this.load()}reload(){this.cancelTileJSONRequest();const l=o.aC(this.id,this.scope);this.load(()=>this.map.style.clearSource(l))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(l){this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,n=this.map.getWorldview();this._tileJSONRequest=Ii(this._options,this.map._requestManager,t,n,(c,p)=>{this._tileJSONRequest=null,this._loaded=!0,c?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),n&&2!==n.length&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${n}`),this.fire(new o.y(c))):p&&(o.l(this,p),p.bounds&&(this.tileBounds=new ui(p.bounds,this.minzoom,this.maxzoom)),Hs(p.tiles,this.map._requestManager._customAccessToken),this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))),l&&l(c)})}hasTransition(){return!1}hasTile(l){return!this.tileBounds||this.tileBounds.contains(l.canonical)}loaded(){return this._loaded}loadTile(l,t){const n=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme)),c={request:this.map._requestManager.transformRequest(n,o.R.Tile),data:void 0,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,tileSize:this.tileSize*l.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:l.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,lut:null,maxZoom:null,promoteId:null,pixelRatio:null,scaleFactor:null};if(l.actor&&"expired"!==l.state)if("loading"===l.state)l.reloadCallback=t;else{if(l.buckets){const y=Object.values(l.buckets);for(const b of y)b.dirty=!0;return void(l.state="loaded")}l.request=l.actor.send("reloadTile",c,p.bind(this))}else l.actor=this.dispatcher.getActor(),l.request=l.actor.send("loadTile",c,p.bind(this),void 0,!0);function p(y,b){return l.aborted?t(null):y&&404!==y.status?t(y):(this.map._refreshExpiredTiles&&b&&l.setExpiryData(b),l.loadModelData(b,this.map.painter),l.state="loaded",void t(null))}}serialize(){return o.l({},this._options)}},canvas:class extends o.aJ{constructor(l,t,n,c){super(l,t,n,c),t.coordinates?Array.isArray(t.coordinates)&&4===t.coordinates.length&&!t.coordinates.some(p=>!Array.isArray(p)||2!==p.length||p.some(y=>"number"!=typeof y))||this.fire(new o.y(new o.V(`sources.${l}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new o.y(new o.V(`sources.${l}`,null,'missing required property "coordinates"'))),t.animate&&"boolean"!=typeof t.animate&&this.fire(new o.y(new o.V(`sources.${l}`,null,'optional "animate" property must be a boolean value'))),t.canvas?"string"==typeof t.canvas||t.canvas instanceof HTMLCanvasElement||this.fire(new o.y(new o.V(`sources.${l}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new o.y(new o.V(`sources.${l}`,null,'missing required property "canvas"'))),this.options=t,this.animate=void 0===t.animate||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new o.y(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(l){this.map=l,this.load(),this.canvas&&this.animate&&this.play()}onRemove(l){this.pause()}prepare(){let l=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,l=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,l=!0),this._hasInvalidDimensions()||0===Object.keys(this.tiles).length)return;const t=this.map.painter.context;this.texture?!l&&!this._playing||this.texture instanceof o.aL||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new o.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const l of[this.canvas.width,this.canvas.height])if(isNaN(l)||l<=0)return!0;return!1}},custom:class extends o.E{constructor(l,t,n,c){super(),this.id=l,this.type="custom",this._dataType="raster",this._dispatcher=n,this._implementation=t,this.setEventedParent(c),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new o.y(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new o.y(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new ui(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),o.l(this,o.ay(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return o.ay(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new o.z("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(l){this.map=l,this._loaded=!1,this.fire(new o.z("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(l),this.load()}onRemove(l){this._implementation.onRemove&&this._implementation.onRemove(l)}hasTile(l){if(this._implementation.hasTile){const{x:t,y:n,z:c}=l.canonical;return this._implementation.hasTile({x:t,y:n,z:c})}return!this.tileBounds||this.tileBounds.contains(l.canonical)}loadTile(l,t){const{x:n,y:c,z:p}=l.tileID.canonical,y=new AbortController;l.request=Promise.resolve(this._implementation.loadTile({x:n,y:c,z:p},{signal:y.signal})).then(function(b){return delete l.request,l.aborted?(l.state="unloaded",t(null)):void 0===b?(l.state="errored",t(null)):null===b?(this.loadTileData(l,{width:this.tileSize,height:this.tileSize,data:null}),l.state="loaded",t(null)):(E=b)instanceof ImageData||E instanceof HTMLCanvasElement||E instanceof ImageBitmap||E instanceof HTMLImageElement?(this.loadTileData(l,b),l.state="loaded",void t(null)):(l.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)));var E}.bind(this)).catch(b=>{20!==b.code&&(l.state="errored",t(b))}),l.request.cancel=()=>y.abort()}loadTileData(l,t){l.setTexture(t,this.map.painter)}unloadTile(l,t){if(l.texture&&l.texture instanceof o.T?(l.destroy(!0),l.texture&&l.texture instanceof o.T&&this.map.painter.saveTileTexture(l.texture)):l.destroy(),this._implementation.unloadTile){const{x:n,y:c,z:p}=l.tileID.canonical;this._implementation.unloadTile({x:n,y:c,z:p})}t&&t()}abortTile(l,t){l.request&&l.request.cancel&&(l.request.cancel(),delete l.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map(l=>({x:l.canonical.x,y:l.canonical.y,z:l.canonical.z}))}_clearTiles(){const l=o.aC(this.id,this.scope);this.map.style.clearSource(l)}_update(){this.fire(new o.z("data",{dataType:"source",sourceDataType:"content"}))}}},ar=function(l,t,n,c){const p=new Nn[t.type](l,t,n,c);if(p.id!==l)throw new Error(`Expected Source id to be ${l} instead of ${p.id}`);return o.aP(["load","abort","unload","serialize","prepare"],p),p};function Ml(l,t,n=""){return`${n}:${t.id||""}:${t.layer.id}:${function(c){if("layerId"in c)return`layer:${c.layerId}`;{const{featuresetId:p,importId:y}=c;return`featureset:${p}${y?`:import:${y}`:""}`}}(l.target)}`}function As(l,t,n,c=""){if(l.uniqueFeatureID){const p=Ml(l,t,c);if(n.has(p))return!0;n.add(p)}return!1}function Ua(l,t,n,c,p=!1){const y=t.sourceCache.transform,b=t.sourceCache.tilesIn(l,t.has3DLayers,p);b.sort(gc);const E=[];for(const D of b){const L=D.tile.queryRenderedFeatures(t,D,n,c,y,p);Object.keys(L).length&&E.push({wrappedTileID:D.tile.tileID.wrapped().key,queryResults:L})}return 0===E.length?{}:function(D){const L={},k={};for(const N of D){const V=N.queryResults,j=N.wrappedTileID,Y=k[j]=k[j]||{};for(const Z in V){const Q=V[Z],J=Y[Z]=Y[Z]||{},re=L[Z]=L[Z]||[];for(const he of Q)J[he.featureIndex]||(J[he.featureIndex]=!0,re.push(he))}}return L}(E)}function Lu(l,t,n,c,p){const y={},b=c.queryRenderedSymbols(l),E=[];for(const D of Object.keys(b).map(Number))E.push(p[D]);E.sort(gc);for(const D of E){const L=D.featureIndex.lookupSymbolFeatures(b[D.bucketInstanceId],D.bucketIndex,D.sourceLayerIndex,t,n);for(const k in L){const N=y[k]=y[k]||[],V=L[k];V.sort((j,Y)=>{const Z=D.featureSortOrder;if(Z){const Q=Z.indexOf(j.featureIndex);return Z.indexOf(Y.featureIndex)-Q}return Y.featureIndex-j.featureIndex});for(const j of V)N.push(j)}}return y}function _h(l,t){const n=l.getRenderableIds().map(y=>l.getTileByID(y)),c=[],p={};for(let y=0;y<n.length;y++){const b=n[y],E=b.tileID.canonical.key;p[E]||(p[E]=!0,b.querySourceFeatures(c,t))}return c}function gc(l,t){const n=l.tileID,c=t.tileID;return n.overscaledZ-c.overscaledZ||n.canonical.y-c.canonical.y||n.wrap-c.wrap||n.canonical.x-c.canonical.x}function gh(l,t){const n={};if(!t)return n;for(const c of l){const p=c.layerIds.map(y=>t.getLayer(y)).filter(Boolean);if(0!==p.length){c.layers=p,c.stateDependentLayerIds&&(c.stateDependentLayers=c.stateDependentLayerIds.map(y=>p.filter(b=>b.id===y)[0]));for(const y of p)n[y.fqid]=c}}return n}const Xs=new Uint16Array(8184);for(let l=0;l<2046;l++){let t=l+2,n=0,c=0,p=0,y=0,b=0,E=0;for(1&t?p=y=b=32:n=c=E=32;(t>>=1)>1;){const L=n+p>>1,k=c+y>>1;1&t?(p=n,y=c,n=b,c=E):(n=p,c=y,p=b,y=E),b=L,E=k}const D=4*l;Xs[D+0]=n,Xs[D+1]=c,Xs[D+2]=p,Xs[D+3]=y}const ms=new Uint16Array(2178),ns=new Uint8Array(1089),Hr=new Uint16Array(1089);function El(l){return 0===l?-.03125:32===l?.03125:0}const yc={type:2,extent:o.ag,loadGeometry:()=>[[new o.P(0,0),new o.P(o.ag+1,0),new o.P(o.ag+1,o.ag+1),new o.P(0,o.ag+1),new o.P(0,0)]]};class rs{constructor(t,n,c,p,y){this.tileID=t,this.uid=o.aV(),this.uses=0,this.tileSize=n,this.tileZoom=c,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=y,p&&p.style&&(this._lastUpdatedBrightness=p.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",p&&p.transform&&(this.projection=p.transform.projection)}registerFadeDuration(t){const n=t+this.timeAdded;n<o.q.now()||this.fadeEndTime&&n<this.fadeEndTime||(this.fadeEndTime=n)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}get tileTransform(){return this._tileTransform||(this._tileTransform=o.aQ(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,n,c){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=gh(t.buckets,n.style),this.hasSymbolBuckets=!1;for(const p in this.buckets){const y=this.buckets[p];if(y instanceof o.aX){if(this.hasSymbolBuckets=!0,!c)break;y.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const p in this.buckets){const y=this.buckets[p];if(y instanceof o.aX&&y.hasRTLText){this.hasRTLText=!0,o.aY();break}}this.queryPadding=0;for(const p in this.buckets){const y=this.buckets[p],b=n.style.getOwnLayer(p);if(!b)continue;const E=b.queryRadius(y);this.queryPadding=Math.max(this.queryPadding,E)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new o.aW}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,n,c){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,gh(t.buckets,n.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t){for(const p in this.buckets){const y=this.buckets[p];y.uploadPending()&&y.upload(t)}const n=t.gl,c=this.imageAtlas;if(c&&!c.uploaded){const p=!!Object.keys(c.patternPositions).length;this.imageAtlasTexture=new o.T(t,c.image,n.RGBA8,{useMipmap:p}),this.imageAtlas.uploaded=!0}this.glyphAtlasImage&&(this.glyphAtlasTexture=new o.T(t,this.glyphAtlasImage,n.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new o.T(t,this.lineAtlas.image,n.R8),this.lineAtlas.uploaded=!0)}prepare(t,n,c){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,c),!n||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const p=n.style.getBrightness();(this._lastUpdatedBrightness||p)&&(this._lastUpdatedBrightness&&p&&Math.abs(this._lastUpdatedBrightness-p)<.001||(this.updateBuckets(n,this._lastUpdatedBrightness!==p),this._lastUpdatedBrightness=p))}queryRenderedFeatures(t,n,c,p,y,b){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const E=function(D,L){const k=o.ab.mat4.fromScaling([],[.5*D.width,.5*-D.height,1]);return o.ab.mat4.translate(k,k,[1,-1,0]),o.ab.mat4.multiply(k,k,D.calculateProjMatrix(L.toUnwrapped())),Float32Array.from(k)}(y,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:n,pixelPosMatrix:E,transform:p,availableImages:c,tileTransform:this.tileTransform})}querySourceFeatures(t,n){const c=this.latestFeatureIndex;if(!c||!c.rawTileData)return;const p=c.loadVTLayers(),y=n?n.sourceLayer:"",b=p._geojsonTileLayer||p[y];if(!b)return;const E=o.aZ(n&&n.filter),{z:D,x:L,y:k}=this.tileID.canonical,N={z:D,x:L,y:k};for(let V=0;V<b.length;V++){const j=b.feature(V);if(E.needGeometry){const Q=o.a_(j,!0);if(!E.filter(new o.a8(this.tileID.overscaledZ),Q,this.tileID.canonical))continue}else if(!E.filter(new o.a8(this.tileID.overscaledZ),j))continue;const Y=c.getId(j,y),Z=new o.a$(j,D,L,k,Y);Z.tile=N,t.push(Z)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return!!this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(t){const n=this.expirationTime;if(t.cacheControl){const c=o.b0(t.cacheControl);c["max-age"]&&(this.expirationTime=Date.now()+1e3*c["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const c=Date.now();let p=!1;if(this.expirationTime>c)p=!1;else if(n)if(this.expirationTime<n)p=!0;else{const y=this.expirationTime-n;y?this.expirationTime=c+Math.max(y,3e4):p=!0}else p=!0;p?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}updateBuckets(t,n){if(!this.latestFeatureIndex||!t.style)return;const c=this.latestFeatureIndex.loadVTLayers(),p=t.style.listImages(),y=t.style.getBrightness();for(const b in this.buckets){if(!t.style.hasLayer(b))continue;const E=this.buckets[b],D=E.layers[0],L=D.sourceLayer||"_geojsonTileLayer",k=c[L],N=t.style.getLayerSourceCache(D);let V={};N&&(V=N._state.getState(L,void 0));const j=this.imageAtlas&&this.imageAtlas.patternPositions||{},Y=Object.keys(V).length>0&&!n;Y&&!E.stateDependentLayers.length&&!n||E.update(V,k,p,j,Y?E.stateDependentLayers:E.layers,n,y),(E instanceof o.b1||E instanceof o.b2)&&t._terrain&&t._terrain.enabled&&N&&E.programConfigurations.needsUpload&&t._terrain._clearRenderCacheForTile(N.id,this.tileID);const Z=t&&t.style&&t.style.getOwnLayer(b);Z&&(this.queryPadding=Math.max(this.queryPadding,Z.queryRadius(E)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<o.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=o.q.now()+t}setTexture(t,n){const c=n.context,p=c.gl;this.texture=this.texture||n.getTileTexture(t.width),this.texture&&this.texture instanceof o.T?this.texture.update(t):(this.texture=new o.T(c,t,p.RGBA8,{useMipmap:!0}),this.texture.bind(p.LINEAR,p.CLAMP_TO_EDGE))}setDependencies(t,n){const c={};for(const p of n)c[p]=!0;this.dependencies[t]=c}hasDependency(t,n){for(const c of t){const p=this.dependencies[c];if(p)for(const y of n)if(p[y])return!0}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,n){if(!n||"mercator"===n.name||this._tileDebugBuffer)return;const c=o.b3(yc,this.tileID.canonical,this.tileTransform)[0],p=new o.b4,y=new o.b5;for(let b=0;b<c.length;b++){const{x:E,y:D}=c[b];p.emplaceBack(E,D),y.emplaceBack(b)}y.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(y),this._tileDebugBuffer=t.createVertexBuffer(p,o.b6.members),this._tileDebugSegments=o.b7.simpleSegment(0,0,p.length,y.length)}_makeTileBoundsBuffers(t,n){if(this._tileBoundsBuffer||!n||"mercator"===n.name)return;const c=o.b3(yc,this.tileID.canonical,this.tileTransform)[0];let p,y;if(this.isRaster){const b=function(E,D){const L=o.aQ(E,D),k=Math.pow(2,E.z);for(let Q=0;Q<33;Q++)for(let J=0;J<33;J++){const re=o.aR((E.x+(J+El(J))/32)/k),he=o.aS((E.y+(Q+El(Q))/32)/k),ce=D.project(re,he),ge=33*Q+J;ms[2*ge+0]=Math.round((ce.x*L.scale-L.x)*o.ag),ms[2*ge+1]=Math.round((ce.y*L.scale-L.y)*o.ag)}ns.fill(0),Hr.fill(0);for(let Q=2045;Q>=0;Q--){const J=4*Q,re=Xs[J+0],he=Xs[J+1],ce=Xs[J+2],ge=Xs[J+3],pe=re+ce>>1,_e=he+ge>>1,de=pe+_e-he,be=_e+re-pe,Ee=33*he+re,qe=33*ge+ce,Le=33*_e+pe,Ye=Math.hypot((ms[2*Ee+0]+ms[2*qe+0])/2-ms[2*Le+0],(ms[2*Ee+1]+ms[2*qe+1])/2-ms[2*Le+1])>=16;ns[Le]=ns[Le]||(Ye?1:0),Q<1022&&(ns[Le]=ns[Le]||ns[33*(he+be>>1)+(re+de>>1)]||ns[33*(ge+be>>1)+(ce+de>>1)])}const N=new o.aT,V=new o.aU;let j=0;function Y(Q,J){const re=33*J+Q;return 0===Hr[re]&&(N.emplaceBack(ms[2*re+0],ms[2*re+1],Q*o.ag/32,J*o.ag/32),Hr[re]=++j),Hr[re]-1}function Z(Q,J,re,he,ce,ge){const pe=Q+re>>1,_e=J+he>>1;if(Math.abs(Q-ce)+Math.abs(J-ge)>1&&ns[33*_e+pe])Z(ce,ge,Q,J,pe,_e),Z(re,he,ce,ge,pe,_e);else{const de=Y(Q,J),be=Y(re,he),Ee=Y(ce,ge);V.emplaceBack(de,be,Ee)}}return Z(0,0,32,32,32,0),Z(32,32,0,0,0,32),{vertices:N,indices:V}}(this.tileID.canonical,n);p=b.vertices,y=b.indices}else{p=new o.aT,y=new o.aU;for(const{x:E,y:D}of c)p.emplaceBack(E,D,0,0);const b=o.b8(p.int16,void 0,4);for(let E=0;E<b.length;E+=3)y.emplaceBack(b[E],b[E+1],b[E+2])}this._tileBoundsBuffer=t.createVertexBuffer(p,o.b9.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(y),this._tileBoundsSegments=o.b7.simpleSegment(0,0,p.length,y.length)}_makeGlobeTileDebugBuffers(t,n){const c=n.projection;if(!c||"globe"!==c.name||n.freezeTileCoverage)return;const p=this.tileID.canonical,y=o.ba(p,n),b=o.bb(y),E=o.ae(n.zoom);let D;E>0&&(D=o.ab.mat4.invert(new Float64Array(16),n.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,p,n,b,D,E),this._makeGlobeTileDebugTextBuffer(t,p,n,b,D,E)}_globePoint(t,n,c,p,y,b,E){let D=o.bc(t,n,c);if(b){const L=1<<c.z,k=o.at(p.center.lng),N=o.aA(p.center.lat),V=(c.x+.5)/L-k;let j=0;V>.5?j=-1:V<-.5&&(j=1);let Y=(t/o.ag+c.x)/L+j,Z=(n/o.ag+c.y)/L;Y=(Y-k)*p._pixelsPerMercatorPixel+k,Z=(Z-N)*p._pixelsPerMercatorPixel+N;const Q=[Y*p.worldSize,Z*p.worldSize,0];o.ab.vec3.transformMat4(Q,Q,b),D=o.bd(D,Q,E)}return o.ab.vec3.transformMat4(D,D,y)}_makeGlobeTileDebugBorderBuffer(t,n,c,p,y,b){const E=new o.b4,D=new o.b5,L=new o.be,k=(V,j,Y,Z,Q)=>{const J=(Y-V)/(Q-1),re=(Z-j)/(Q-1),he=E.length;for(let ce=0;ce<Q;ce++){const ge=V+ce*J,pe=j+ce*re;E.emplaceBack(ge,pe);const _e=this._globePoint(ge,pe,n,c,p,y,b);L.emplaceBack(_e[0],_e[1],_e[2]),D.emplaceBack(he+ce)}},N=o.ag;k(0,0,N,0,16),k(N,0,N,N,16),k(N,N,0,N,16),k(0,N,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(D),this._tileDebugBuffer=t.createVertexBuffer(E,o.b6.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(L,o.bf.members),this._tileDebugSegments=o.b7.simpleSegment(0,0,E.length,D.length)}_makeGlobeTileDebugTextBuffer(t,n,c,p,y,b){const E=o.ag/4,D=new o.b4,L=new o.aU,k=new o.be,N=25;L.reserve(32),D.reserve(N),k.reserve(N);const V=(j,Y)=>N*j+Y;for(let j=0;j<N;j++){const Y=j*E;for(let Z=0;Z<N;Z++){const Q=Z*E;D.emplaceBack(Q,Y);const J=this._globePoint(Q,Y,n,c,p,y,b);k.emplaceBack(J[0],J[1],J[2])}}for(let j=0;j<4;j++)for(let Y=0;Y<4;Y++){const Z=V(j,Y),Q=V(j,Y+1),J=V(j+1,Y),re=V(j+1,Y+1);L.emplaceBack(Z,Q,J),L.emplaceBack(J,Q,re)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(L),this._tileDebugTextBuffer=t.createVertexBuffer(D,o.b6.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(k,o.bf.members),this._tileDebugTextSegments=o.b7.simpleSegment(0,0,N,32)}destroy(t=!1){for(const n in this.buckets)this.buckets[n].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof o.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}o.bg.setPbf(o.bh);class Is extends rs{constructor(t,n,c,p,y){super(t,n,c,p,y),this._workQueue=[],this._fetchQueue=[],this._isHeaderLoaded=!1}setTexture(t,n){const c=n.context,p=c.gl;this.texture=this.texture||n.getTileTexture(t.width),this.texture&&this.texture instanceof o.T?this.texture.update(t,{premultiply:!1}):this.texture=new o.T(c,t,p.RGBA8,{premultiply:!1})}flushQueues(){for(;this._workQueue.length;)this._workQueue.pop()();for(;this._fetchQueue.length;)this._fetchQueue.pop()()}fetchHeader(t=16384,n){const c=this._mrt=new o.bg(30),p=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=o.bi(p,(y,b,E,D)=>{if(y)n(y);else try{const L=c.getHeaderLength(b);if(L>t)return void(this.request=this.fetchHeader(L,n));c.parseHeader(b),this._isHeaderLoaded=!0;let k=0;for(const N of Object.values(c.layers))k=Math.max(k,N.dataIndex[N.dataIndex.length-1].last_byte);b.byteLength>=k&&(this.entireBuffer=b),n(null,this.entireBuffer||b,E,D)}catch(L){n(L)}}),this.request}fetchBand(t,n,c){const p=this._mrt;if(!this._isHeaderLoaded||!p)return void c(new Error("Tile header is not ready"));const y=this.actor;if(!y)return void c(new Error("Can't fetch tile band without an actor"));let b;const E=(N,V)=>{b.complete(N,V),N?c(N):(this.updateTextureDescriptor(t,n),c(null,this.textureDescriptor&&this.textureDescriptor.img))},D=(N,V)=>{if(N)return c(N);const j=y.send("decodeRasterArray",{buffer:V,task:b},E,void 0,!0);this._workQueue.push(()=>{j&&j.cancel(),b.cancel()})},L=p.getLayer(t);if(!L)return void c(new Error(`Unknown sourceLayer "${t}"`));if(L.hasDataForBand(n))return this.updateTextureDescriptor(t,n),void c(null,this.textureDescriptor?this.textureDescriptor.img:null);const k=L.getDataRange([n]);if(b=p.createDecodingTask(k),!b||b.tasks.length)if(this.flushQueues(),this.entireBuffer)D(null,this.entireBuffer.slice(k.firstByte,k.lastByte+1));else{const N=Object.assign({},this.requestParams,{headers:{Range:`bytes=${k.firstByte}-${k.lastByte}`}}),V=o.bi(N,D);this._fetchQueue.push(()=>{V.cancel(),b.cancel()})}else c(null)}updateNeeded(t,n){return(!this.textureDescriptor||this.textureDescriptor.band!==n||this.textureDescriptor.layer!==t)&&"errored"!==this.state}updateTextureDescriptor(t,n){if(!this._mrt)return;const c=this._mrt.getLayer(t);if(!c||!c.hasBand(n)||!c.hasDataForBand(n))return;const{bytes:p,tileSize:y,buffer:b,offset:E,scale:D}=c.getBandView(n),L=y+2*b,k={data:p,width:L,height:L},N=this.texture;N&&N instanceof o.T&&N.update(k,{premultiply:!1}),this.textureDescriptor={layer:t,band:n,img:k,buffer:b,offset:E,tileSize:y,format:c.pixelFormat,mix:[D,256*D,65536*D,16777216*D]}}}class yh{constructor(t,n){this.max=t,this.onRemove=n,this.reset()}reset(){for(const t in this.data)for(const n of this.data[t])n.timeout&&clearTimeout(n.timeout),this.onRemove(n.value);return this.data={},this.order=[],this}add(t,n,c){const p=t.wrapped().key;void 0===this.data[p]&&(this.data[p]=[]);const y={value:n,timeout:void 0};if(void 0!==c&&(y.timeout=setTimeout(()=>{this.remove(t,y)},c)),this.data[p].push(y),this.order.push(p),this.order.length>this.max){const b=this._getAndRemoveByKey(this.order[0]);b&&this.onRemove(b)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const n=this.data[t].shift();return n.timeout&&clearTimeout(n.timeout),0===this.data[t].length&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),n.value}getByKey(t){const n=this.data[t];return n?n[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,n){if(!this.has(t))return this;const c=t.wrapped().key,p=void 0===n?0:this.data[c].indexOf(n),y=this.data[c][p];return this.data[c].splice(p,1),y.timeout&&clearTimeout(y.timeout),0===this.data[c].length&&delete this.data[c],this.onRemove(y.value),this.order.splice(this.order.indexOf(c),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const n=this._getAndRemoveByKey(this.order[0]);n&&this.onRemove(n)}return this}filter(t){const n=[];for(const c in this.data)for(const p of this.data[c])t(p.value)||n.push(p);for(const c of n)this.remove(c.value.tileID,c)}}class Al{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,n,c){const p=String(n);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][p]=this.stateChanges[t][p]||{},o.l(this.stateChanges[t][p],c),null===this.deletedStates[t]){this.deletedStates[t]={};for(const y in this.state[t])y!==p&&(this.deletedStates[t][y]=null)}else if(this.deletedStates[t]&&null===this.deletedStates[t][p]){this.deletedStates[t][p]={};for(const y in this.state[t][p])c[y]||(this.deletedStates[t][p][y]=null)}else for(const y in c)this.deletedStates[t]&&this.deletedStates[t][p]&&null===this.deletedStates[t][p][y]&&delete this.deletedStates[t][p][y]}removeFeatureState(t,n,c){if(null===this.deletedStates[t])return;const p=String(n);if(this.deletedStates[t]=this.deletedStates[t]||{},c&&void 0!==n)null!==this.deletedStates[t][p]&&(this.deletedStates[t][p]=this.deletedStates[t][p]||{},this.deletedStates[t][p][c]=null);else if(void 0!==n)if(this.stateChanges[t]&&this.stateChanges[t][p])for(c in this.deletedStates[t][p]={},this.stateChanges[t][p])this.deletedStates[t][p][c]=null;else this.deletedStates[t][p]=null;else this.deletedStates[t]=null}getState(t,n){const c=this.state[t]||{},p=this.stateChanges[t]||{},y=this.deletedStates[t];if(null===y)return{};if(void 0!==n){const E=String(n),D=o.l({},c[E],p[E]);if(y){const L=y[n];if(null===L)return{};for(const k in L)delete D[k]}return D}const b=o.l({},c,p);if(y)for(const E in y)delete b[E];return b}initializeTileState(t,n){t.refreshFeatureState(n)}coalesceChanges(t,n){const c={};for(const p in this.stateChanges){this.state[p]=this.state[p]||{};const y={};for(const b in this.stateChanges[p])this.state[p][b]||(this.state[p][b]={}),o.l(this.state[p][b],this.stateChanges[p][b]),y[b]=this.state[p][b];c[p]=y}for(const p in this.deletedStates){this.state[p]=this.state[p]||{};const y={};if(null===this.deletedStates[p])for(const b in this.state[p])y[b]={},this.state[p][b]={};else for(const b in this.deletedStates[p]){if(null===this.deletedStates[p][b])this.state[p][b]={};else if(this.state[p][b])for(const E of Object.keys(this.deletedStates[p][b]))delete this.state[p][b][E];y[b]=this.state[p][b]}c[p]=c[p]||{},o.l(c[p],y)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(c).length)for(const p in t)t[p].refreshFeatureState(n)}}class ss extends o.E{constructor(t,n,c){super(),this.id=t,this._onlySymbols=c,n.on("data",p=>{"source"===p.dataType&&"metadata"===p.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===p.dataType&&"content"===p.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform))}),n.on("error",()=>{this._sourceErrored=!0}),this._source=n,this._tiles={},this._cache=new yh(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=n.minTileCacheSize,this._maxTileCacheSize=n.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new Al,this._isRaster="raster"===this._source.type||"raster-dem"===this._source.type||"raster-array"===this._source.type||"custom"===this._source.type&&"raster"===this._source._dataType}onAdd(t){this.map=t,this._minTileCacheSize=void 0===this._minTileCacheSize&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=void 0===this._maxTileCacheSize&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles){const n=this._tiles[t];if("loaded"!==n.state&&"errored"!==n.state)return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,n){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,n)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const n in this._tiles){const c=this._tiles[n];c.upload(t),c.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return o.bj(this._tiles).map(t=>t.tileID).sort(Ri).map(t=>t.key)}getRenderableIds(t,n){const c=[];for(const p in this._tiles)this._isIdRenderable(+p,t,n)&&c.push(this._tiles[p]);return t?c.sort((p,y)=>{const b=p.tileID,E=y.tileID,D=new o.P(b.canonical.x,b.canonical.y)._rotate(this.transform.angle),L=new o.P(E.canonical.x,E.canonical.y)._rotate(this.transform.angle);return b.overscaledZ-E.overscaledZ||L.y-D.y||L.x-D.x}).map(p=>p.tileID.key):c.map(p=>p.tileID).sort(Ri).map(p=>p.key)}hasRenderableParent(t){const n=this.findLoadedParent(t,0);return!!n&&this._isIdRenderable(n.tileID.key)}_isIdRenderable(t,n,c){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(n||!this._tiles[t].holdingForFade())&&(c||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)"errored"!==this._tiles[t].state&&this._reloadTile(+t,"reloading")}}_reloadTile(t,n){const c=this._tiles[t];c&&("loading"!==c.state&&(c.state=n),this._loadTile(c,this._tileLoaded.bind(this,c,t,n)))}_tileLoaded(t,n,c,p){if(p)if(t.state="errored",404!==p.status)this._source.fire(new o.y(p,{tile:t}));else{if(this._source.fire(new o.z("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const y=this.map.painter.terrain;this.update(this.transform,y.getScaledDemTileSize(),!0),y.resetTileLookupCache(this.id)}else this.update(this.transform)}else t.timeAdded=o.q.now(),"expired"===c&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(n,t),"raster-dem"===this._source.type&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new o.z("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const n=this.getRenderableIds();for(let p=0;p<n.length;p++){const y=n[p];if(t.neighboringTiles&&t.neighboringTiles[y]){const b=this.getTileByID(y);c(t,b),c(b,t)}}function c(p,y){if(!p.dem||p.dem.borderReady)return;p.needsHillshadePrepare=!0,p.needsDEMTextureUpload=!0;let b=y.tileID.canonical.x-p.tileID.canonical.x;const E=y.tileID.canonical.y-p.tileID.canonical.y,D=Math.pow(2,p.tileID.canonical.z),L=y.tileID.key;0===b&&0===E||Math.abs(E)>1||(Math.abs(b)>1&&(1===Math.abs(b+D)?b+=D:1===Math.abs(b-D)&&(b-=D)),y.dem&&p.dem&&(p.dem.backfillBorder(y.dem,b,E),p.neighboringTiles&&p.neighboringTiles[L]&&(p.neighboringTiles[L].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,n,c,p){for(const y in this._tiles){let b=this._tiles[y];if(p[y]||!b.hasData()||b.tileID.overscaledZ<=n||b.tileID.overscaledZ>c)continue;let E=b.tileID;for(;b&&b.tileID.overscaledZ>n+1;){const L=b.tileID.scaledTo(b.tileID.overscaledZ-1);b=this._tiles[L.key],b&&b.hasData()&&(E=L)}let D=E;for(;D.overscaledZ>n;)if(D=D.scaledTo(D.overscaledZ-1),t[D.key]){p[E.key]=E;break}}}findLoadedParent(t,n){if(t.key in this._loadedParentTiles){const c=this._loadedParentTiles[t.key];return c&&c.tileID.overscaledZ>=n?c:null}for(let c=t.overscaledZ-1;c>=n;c--){const p=t.scaledTo(c),y=this._getLoadedTile(p);if(y)return y}}_getLoadedTile(t){const n=this._tiles[t.key];return n&&n.hasData()?n:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,n){n=n||this._source.tileSize;const c=Math.ceil(t.width/n)+1,p=Math.ceil(t.height/n)+1,y=Math.floor(c*p*5),b="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,y):y,E="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,b):b;this._cache.setMaxSize(E)}handleWrapJump(t){const n=Math.round((t-(void 0===this._prevLng?t:this._prevLng))/360);if(this._prevLng=t,n){const c={};for(const p in this._tiles){const y=this._tiles[p];y.tileID=y.tileID.unwrapTo(y.tileID.wrap+n),c[y.tileID.key]=y}this._tiles=c;for(const p in this._timers)clearTimeout(this._timers[p]),delete this._timers[p];for(const p in this._tiles)this._setTileReloadTimer(+p,this._tiles[p])}}update(t,n,c,p){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!c)return;this.updateCacheSize(t,n),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const y="batched-model"===this._source.type;let b,E=this._source.maxzoom;const D=this.map&&this.map.painter?this.map.painter._terrain:null;if(D&&D.sourceCache===this&&D.attenuationRange()){const N=D.attenuationRange()[0],V=Math.floor(N)-Math.log2(D.getDemUpscale());E>V&&(E=V)}if(this.used||this.usedForTerrain){if(this._source.tileID)b=t.getVisibleUnwrappedCoordinates(this._source.tileID).map(N=>new o.aG(N.canonical.z,N.wrap,N.canonical.z,N.canonical.x,N.canonical.y));else if(0!==this.tileCoverLift){const N=t.clone();N.tileCoverLift=this.tileCoverLift,b=N.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:E,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:y}),this._source.minzoom<=1&&"globe"===t.projection.name&&(b.push(new o.aG(1,0,1,0,0)),b.push(new o.aG(1,0,1,1,0)),b.push(new o.aG(1,0,1,0,1)),b.push(new o.aG(1,0,1,1,1)))}else if(b=t.coveringTiles({tileSize:n||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:E,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:y}),this._source.hasTile){const N=this._source.hasTile.bind(this._source);b=b.filter(V=>N(V))}}else b=[];if(b.length>0&&this.castsShadows&&p&&"globe"!==this.transform.projection.name&&!this.usedForTerrain&&!xh(this._source.type)){const N=t.coveringZoomLevel({tileSize:n||this._source.tileSize,roundZoom:this._source.roundZoom&&!c}),V=Math.min(N,this._source.maxzoom);if(y){const j=t.extendTileCover(b,V);for(const Y of j)b.push(Y)}else{const j=t.extendTileCover(b,V,p);for(const Y of j)this._shadowCasterTiles[Y.key]=!0,b.push(Y)}}const L=this._updateRetainedTiles(b);if(xh(this._source.type)&&0!==b.length){const N={},V={},j=Object.keys(L);for(const Z of j){const Q=L[Z],J=this._tiles[Z];if(!J||J.fadeEndTime&&J.fadeEndTime<=o.q.now())continue;const re=this.findLoadedParent(Q,Math.max(Q.overscaledZ-ss.maxOverzooming,this._source.minzoom));re&&(this._addTile(re.tileID),N[re.tileID.key]=re.tileID),V[Z]=Q}const Y=b[b.length-1].overscaledZ;for(const Z in this._tiles){const Q=this._tiles[Z];if(L[Z]||!Q.hasData())continue;let J=Q.tileID;for(;J.overscaledZ>Y;){J=J.scaledTo(J.overscaledZ-1);const re=this._tiles[J.key];if(re&&re.hasData()&&V[J.key]){L[Z]=Q.tileID;break}}}for(const Z in N)L[Z]||(this._coveredTiles[Z]=!0,L[Z]=N[Z])}for(const N in L)this._tiles[N].clearFadeHold();const k=o.bk(this._tiles,L);for(const N of k){const V=this._tiles[N];V.hasSymbolBuckets&&!V.holdingForFade()?V.setHoldDuration(this.map._fadeDuration):V.hasSymbolBuckets&&!V.symbolFadeFinished()||this._removeTile(+N)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const n={};if(0===t.length)return n;const c={},p=t.reduce((L,k)=>Math.min(L,k.overscaledZ),1/0),y=t[0].overscaledZ,b=Math.max(y-ss.maxOverzooming,this._source.minzoom),E=Math.max(y+ss.maxUnderzooming,this._source.minzoom),D={};for(const L of t){const k=this._addTile(L);n[L.key]=L,k.hasData()||p<this._source.maxzoom&&(D[L.key]=L)}this._retainLoadedChildren(D,p,E,n);for(const L of t){let k=this._tiles[L.key];if(k.hasData())continue;if(L.canonical.z>=this._source.maxzoom){const V=L.children(this._source.maxzoom)[0],j=this.getTile(V);if(j&&j.hasData()){n[V.key]=V;continue}}else{const V=L.children(this._source.maxzoom);if(n[V[0].key]&&n[V[1].key]&&n[V[2].key]&&n[V[3].key])continue}let N=k.wasRequested();for(let V=L.overscaledZ-1;V>=b;--V){const j=L.scaledTo(V);if(c[j.key]||(c[j.key]=!0,k=this.getTile(j),!k&&N&&(k=this._addTile(j)),k&&(n[j.key]=j,N=k.wasRequested(),k.hasData())))break}}return n}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const n=[];let c,p=this._tiles[t].tileID;for(;p.overscaledZ>0;){if(p.key in this._loadedParentTiles){c=this._loadedParentTiles[p.key];break}n.push(p.key);const y=p.scaledTo(p.overscaledZ-1);if(c=this._getLoadedTile(y),c)break;p=y}for(const y of n)this._loadedParentTiles[y]=c}}_addTile(t){let n=this._tiles[t.key];if(n)return!0!==n.isExtraShadowCaster||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),n;n=this._cache.getAndRemove(t),n&&(this._setTileReloadTimer(t.key,n),n.tileID=t,this._state.initializeTileState(n,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,n)));const c=!!n;if(!c){const p=this.map?this.map.painter:null,y=this._source.tileSize*t.overscaleFactor();n="raster-array"===this._source.type?new Is(t,y,this.transform.tileZoom,p,this._isRaster):new rs(t,y,this.transform.tileZoom,p,this._isRaster),this._loadTile(n,this._tileLoaded.bind(this,n,t.key,n.state))}return n?(n.uses++,this._tiles[t.key]=n,c||this._source.fire(new o.z("dataloading",{tile:n,coord:n.tileID,dataType:"source"})),n):null}_setTileReloadTimer(t,n){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const c=n.getExpiryTimeout();c&&(this._timers[t]=setTimeout(()=>{this._reloadTile(t,"expired"),delete this._timers[t]},c))}_removeTile(t){const n=this._tiles[t];n&&(n.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),n.uses>0||(n.hasData()&&"reloading"!==n.state||"empty"===n.state?this._cache.add(n.tileID,n,n.getExpiryTimeout()):(n.aborted=!0,this._abortTile(n),this._unloadTile(n))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,n,c){const p=[],y=this.transform;if(!y)return p;const b="globe"===y.projection.name,E=o.at(y.center.lng);for(const D in this._tiles){const L=this._tiles[D];if(c&&L.clearQueryDebugViz(),L.holdingForFade())continue;let k;if(b){const N=L.tileID.canonical;if(0===N.z){const V=[Math.abs(o.aw(E,...Ut(N,-1))-E),Math.abs(o.aw(E,...Ut(N,1))-E)];k=[0,2*V.indexOf(Math.min(...V))-1]}else{const V=[Math.abs(o.aw(E,...Ut(N,-1))-E),Math.abs(o.aw(E,...Ut(N,0))-E),Math.abs(o.aw(E,...Ut(N,1))-E)];k=[V.indexOf(Math.min(...V))-1]}}else k=[0];for(const N of k){const V=t.containsTile(L,y,n,N);V&&p.push(V)}}return p}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,n){const c=this.getRenderableIds(t,n).map(y=>this._tiles[y].tileID),p="globe"===this.transform.projection.name;for(const y of c)y.projMatrix=this.transform.calculateProjMatrix(y.toUnwrapped()),y.expandedProjMatrix=p?this.transform.calculateProjMatrix(y.toUnwrapped(),!1,!0):y.projMatrix;return c}sortCoordinatesByDistance(t){const n=t.slice(),c=this.transform._camera.position,p=this.transform._camera.forward(),y={};for(const b of n){const E=1/(1<<b.canonical.z);y[b.key]=((b.canonical.x+.5)*E+b.wrap-c[0])*p[0]+((b.canonical.y+.5)*E-c[1])*p[1]-c[2]*p[2]}return n.sort((b,E)=>y[b.key]-y[E.key]),n}hasTransition(){if(this._source.hasTransition())return!0;if(xh(this._source.type))for(const t in this._tiles){const n=this._tiles[t];if(void 0!==n.fadeEndTime&&n.fadeEndTime>=o.q.now())return!0}return!1}setFeatureState(t,n,c){this._state.updateState(t=t||"_geojsonTileLayer",n,c)}removeFeatureState(t,n,c){this._state.removeFeatureState(t=t||"_geojsonTileLayer",n,c)}getFeatureState(t,n){return this._state.getState(t=t||"_geojsonTileLayer",n)}setDependencies(t,n,c){const p=this._tiles[t];p&&p.setDependencies(n,c)}reloadTilesForDependencies(t,n){for(const c in this._tiles)this._tiles[c].hasDependency(t,n)&&this._reloadTile(+c,"reloading");this._cache.filter(c=>!c.hasDependency(t,n))}_preloadTiles(t,n){if(!this._sourceLoaded){const D=()=>{this._sourceLoaded&&(this._source.off("data",D),this._preloadTiles(t,n))};return void this._source.on("data",D)}const c=new Map,p=Array.isArray(t)?t:[t],y=this.map.painter.terrain,b=this.usedForTerrain&&y?y.getScaledDemTileSize():this._source.tileSize;for(const D of p){const L=D.coveringTiles({tileSize:b,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const k of L)c.set(k.key,k);this.usedForTerrain&&D.updateElevation(!1)}const E=Array.from(c.values());o.bl(E,(D,L)=>{const k=new rs(D,this._source.tileSize*D.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster);this._loadTile(k,N=>{"raster-dem"===this._source.type&&k.dem&&this._backfillDEM(k),L(N,k)})},n)}}function Ri(l,t){const n=Math.abs(2*l.wrap)-+(l.wrap<0),c=Math.abs(2*t.wrap)-+(t.wrap<0);return l.overscaledZ-t.overscaledZ||c-n||t.canonical.y-l.canonical.y||t.canonical.x-l.canonical.x}function xh(l){return"raster"===l||"image"===l||"video"===l||"custom"===l}function Ut(l,t){const n=1<<l.z;return[l.x/n+t,(l.x+1)/n+t]}ss.maxOverzooming=10,ss.maxUnderzooming=3;class vh{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const t=!1,n=!1;for(const c in this.style._mergedLayers){const p=this.style._mergedLayers[c];if("fill-extrusion"===p.type)this.layers.push({layer:p,visible:t,visibilityChanged:n});else if("model"===p.type){const y=this.style.getLayerSource(p);y&&"batched-model"===y.type&&this.layers.push({layer:p,visible:t,visibilityChanged:n})}}}onNewFrame(t){this.layersGotHidden=!1;for(const n of this.layers){const c=n.layer;let p=!1;"fill-extrusion"===c.type?p=!c.isHidden(t)&&c.paint.get("fill-extrusion-opacity")>0:"model"===c.type&&(p=!c.isHidden(t)&&c.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!p&&n.visible,n.visible=p}}updateZOffset(t,n){this.currentBuildingBuckets=[];for(const p of this.layers){const y=p.layer,b=this.style.getLayerSourceCache(y);let E=1;"fill-extrusion"===y.type&&(E=p.visible?y.paint.get("fill-extrusion-vertical-scale"):0);let D=b?b.getTile(n):null;if(!D&&b&&n.canonical.z>b.getSource().minzoom){let L=n.scaledTo(Math.min(b.getSource().maxzoom,n.overscaledZ-1));for(;L.overscaledZ>=b.getSource().minzoom&&(D=b.getTile(L),!D&&0!==L.overscaledZ);)L=L.scaledTo(L.overscaledZ-1)}this.currentBuildingBuckets.push({bucket:D?D.getBucket(y):null,tileID:D?D.tileID:n,verticalScale:E})}t.hasAnyZOffset=!1;let c=!1;for(let p=0;p<t.symbolInstances.length;p++){const y=t.symbolInstances.get(p),b=y.zOffset,E=this._getHeightAtTileOffset(n,y.tileAnchorX,y.tileAnchorY);y.zOffset=E!==Number.NEGATIVE_INFINITY?E:b,c||b===y.zOffset||(c=!0),t.hasAnyZOffset||0===y.zOffset||(t.hasAnyZOffset=!0)}c&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,n,c,p){let y=n,b=c;if(t.canonical.z!==p.canonical.z){const E=p.canonical,D=1/(1<<t.canonical.z-E.z);y=(n+t.canonical.x*o.ag)*D-E.x*o.ag|0,b=(c+t.canonical.y*o.ag)*D-E.y*o.ag|0}return{tileX:y,tileY:b}}_getHeightAtTileOffset(t,n,c){let p,y;for(let b=0;b<this.layers.length;++b){if("fill-extrusion"!==this.layers[b].layer.type)continue;const{bucket:E,tileID:D,verticalScale:L}=this.currentBuildingBuckets[b];if(!E)continue;const{tileX:k,tileY:N}=this._mapCoordToOverlappingTile(t,n,c,D),V=E.getHeightAtTileCoord(k,N);V&&void 0!==V.height&&(V.hidden?p=V.height:y=Math.max(V.height*L,y||0))}if(void 0!==y)return y;for(let b=0;b<this.layers.length;++b){const E=this.layers[b];if("model"!==E.layer.type||!E.visible)continue;const{bucket:D,tileID:L}=this.currentBuildingBuckets[b];if(!D)continue;const{tileX:k,tileY:N}=this._mapCoordToOverlappingTile(t,n,c,L),V=D.getHeightAtTileCoord(k,N);if(V&&!V.hidden)return void 0===V.height&&void 0!==p?Math.min(V.maxHeight,p)*V.verticalScale:V.height?V.height*V.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function xc(l,t){const n={};for(const c in l)"ref"!==c&&(n[c]=l[c]);return o.bm.forEach(c=>{c in t&&(n[c]=t[c])}),n}function xo(l){l=l.slice();const t=Object.create(null);for(let n=0;n<l.length;n++)t[l[n].id]=l[n];for(let n=0;n<l.length;n++)"ref"in l[n]&&(l[n]=xc(l[n],t[l[n].ref]));return l}const hi={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport"};function vc(l,t,n){n.push({command:hi.addSource,args:[l,t[l]]})}function Cs(l,t,n){t.push({command:hi.removeSource,args:[l]}),n[l]=!0}function Mt(l,t,n,c){Cs(l,n,c),vc(l,t,n)}function Mi(l,t,n){let c;for(c in l[n])if(l[n].hasOwnProperty(c)&&"data"!==c&&!o.bn(l[n][c],t[n][c]))return!1;for(c in t[n])if(t[n].hasOwnProperty(c)&&"data"!==c&&!o.bn(l[n][c],t[n][c]))return!1;return!0}function wi(l,t,n,c,p,y){let b;for(b in t=t||{},l=l||{})l.hasOwnProperty(b)&&(o.bn(l[b],t[b])||n.push({command:y,args:[c,b,t[b],p]}));for(b in t)t.hasOwnProperty(b)&&!l.hasOwnProperty(b)&&(o.bn(l[b],t[b])||n.push({command:y,args:[c,b,t[b],p]}))}function Vn(l){return l.id}function _s(l,t){return l[t.id]=t,l}class Pi{constructor(t,n){this.reset(t,n)}reset(t,n){this.points=t||[],this._distances=[0];for(let c=1;c<this.points.length;c++)this._distances[c]=this._distances[c-1]+this.points[c].dist(this.points[c-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(n||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(1===this.points.length)return this.points[0];t=o.aw(t,0,1);let n=1,c=this._distances[n];const p=t*this.paddedLength+this.padding;for(;c<p&&n<this._distances.length;)c=this._distances[++n];const y=n-1,b=this._distances[y],E=c-b,D=E>0?(p-b)/E:0;return this.points[y].mult(1-D).add(this.points[n].mult(D))}}class fn{constructor(t,n,c){const p=this.boxCells=[],y=this.circleCells=[];this.xCellCount=Math.ceil(t/c),this.yCellCount=Math.ceil(n/c);for(let b=0;b<this.xCellCount*this.yCellCount;b++)p.push([]),y.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=n,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/n,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,n,c,p,y){this._forEachCell(n,c,p,y,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(n),this.bboxes.push(c),this.bboxes.push(p),this.bboxes.push(y)}insertCircle(t,n,c,p){this._forEachCell(n-p,c-p,n+p,c+p,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(n),this.circles.push(c),this.circles.push(p)}_insertBoxCell(t,n,c,p,y,b){this.boxCells[y].push(b)}_insertCircleCell(t,n,c,p,y,b){this.circleCells[y].push(b)}_query(t,n,c,p,y,b){if(c<0||t>this.width||p<0||n>this.height)return!y&&[];const E=[];if(t<=0&&n<=0&&this.width<=c&&this.height<=p){if(y)return!0;for(let D=0;D<this.boxKeys.length;D++)E.push({key:this.boxKeys[D],x1:this.bboxes[4*D],y1:this.bboxes[4*D+1],x2:this.bboxes[4*D+2],y2:this.bboxes[4*D+3]});for(let D=0;D<this.circleKeys.length;D++){const L=this.circles[3*D],k=this.circles[3*D+1],N=this.circles[3*D+2];E.push({key:this.circleKeys[D],x1:L-N,y1:k-N,x2:L+N,y2:k+N})}return b?E.filter(b):E}return this._forEachCell(t,n,c,p,this._queryCell,E,{hitTest:y,seenUids:{box:{},circle:{}}},b),y?E.length>0:E}_queryCircle(t,n,c,p,y){const b=t-c,E=t+c,D=n-c,L=n+c;if(E<0||b>this.width||L<0||D>this.height)return!p&&[];const k=[];return this._forEachCell(b,D,E,L,this._queryCellCircle,k,{hitTest:p,circle:{x:t,y:n,radius:c},seenUids:{box:{},circle:{}}},y),p?k.length>0:k}query(t,n,c,p,y){return this._query(t,n,c,p,!1,y)}hitTest(t,n,c,p,y){return this._query(t,n,c,p,!0,y)}hitTestCircle(t,n,c,p){return this._queryCircle(t,n,c,!0,p)}_queryCell(t,n,c,p,y,b,E,D){const L=E.seenUids,k=this.boxCells[y];if(null!==k){const V=this.bboxes;for(const j of k)if(!L.box[j]){L.box[j]=!0;const Y=4*j;if(t<=V[Y+2]&&n<=V[Y+3]&&c>=V[Y+0]&&p>=V[Y+1]&&(!D||D(this.boxKeys[j]))){if(E.hitTest)return b.push(!0),!0;b.push({key:this.boxKeys[j],x1:V[Y],y1:V[Y+1],x2:V[Y+2],y2:V[Y+3]})}}}const N=this.circleCells[y];if(null!==N){const V=this.circles;for(const j of N)if(!L.circle[j]){L.circle[j]=!0;const Y=3*j;if(this._circleAndRectCollide(V[Y],V[Y+1],V[Y+2],t,n,c,p)&&(!D||D(this.circleKeys[j]))){if(E.hitTest)return b.push(!0),!0;{const Z=V[Y],Q=V[Y+1],J=V[Y+2];b.push({key:this.circleKeys[j],x1:Z-J,y1:Q-J,x2:Z+J,y2:Q+J})}}}}}_queryCellCircle(t,n,c,p,y,b,E,D){const L=E.circle,k=E.seenUids,N=this.boxCells[y];if(null!==N){const j=this.bboxes;for(const Y of N)if(!k.box[Y]){k.box[Y]=!0;const Z=4*Y;if(this._circleAndRectCollide(L.x,L.y,L.radius,j[Z+0],j[Z+1],j[Z+2],j[Z+3])&&(!D||D(this.boxKeys[Y])))return b.push(!0),!0}}const V=this.circleCells[y];if(null!==V){const j=this.circles;for(const Y of V)if(!k.circle[Y]){k.circle[Y]=!0;const Z=3*Y;if(this._circlesCollide(j[Z],j[Z+1],j[Z+2],L.x,L.y,L.radius)&&(!D||D(this.circleKeys[Y])))return b.push(!0),!0}}}_forEachCell(t,n,c,p,y,b,E,D){const L=this._convertToXCellCoord(t),k=this._convertToYCellCoord(n),N=this._convertToXCellCoord(c),V=this._convertToYCellCoord(p);for(let j=L;j<=N;j++)for(let Y=k;Y<=V;Y++)if(y.call(this,t,n,c,p,this.xCellCount*Y+j,b,E,D))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,n,c,p,y,b){const E=p-t,D=y-n,L=c+b;return L*L>E*E+D*D}_circleAndRectCollide(t,n,c,p,y,b,E){const D=(b-p)/2,L=Math.abs(t-(p+D));if(L>D+c)return!1;const k=(E-y)/2,N=Math.abs(n-(y+k));if(N>k+c)return!1;if(L<=D||N<=k)return!0;const V=L-D,j=N-k;return V*V+j*j<=c*c}}const Ps_unknown=0,Ps_flipRequired=1,Ps_flipNotRequired=2,vo=Math.tan(85*Math.PI/180);function Kn(l,t,n,c,p,y,b){const E=o.ab.mat4.create();if(n)if("globe"===y.name){const D=o.bo(p,t);o.ab.mat4.multiply(E,E,D)}else{const D=o.ab.mat2.invert([],b);E[0]=D[0],E[1]=D[1],E[4]=D[2],E[5]=D[3],c||o.ab.mat4.rotateZ(E,E,p.angle)}else o.ab.mat4.multiply(E,p.labelPlaneMatrix,l);return E}function sn(l,t,n,c,p,y,b){const E=Kn(l,t,n,c,p,y,b);return"globe"===y.name&&n||(E[2]=E[6]=E[10]=E[14]=0),E}function bc(l,t,n,c,p,y,b){if(n){if("globe"===y.name){const E=Kn(l,t,n,c,p,y,b);return o.ab.mat4.invert(E,E),o.ab.mat4.multiply(E,l,E),E}{const E=o.ab.mat4.clone(l),D=o.ab.mat4.identity([]);return D[0]=b[0],D[1]=b[1],D[4]=b[2],D[5]=b[3],o.ab.mat4.multiply(E,E,D),c||o.ab.mat4.rotateZ(E,E,-p.angle),E}}return p.glCoordMatrix}function lr(l,t,n,c){const p=[l,t,n,1];n?o.ab.vec4.transformMat4(p,p,c):br(p,p,c);const y=p[3];return p[0]/=y,p[1]/=y,p[2]/=y,p}function Il(l,t){return Math.min(.5+l/t*.5,1.5)}function Wr(l,t){const n=l[0]/l[3],c=l[1]/l[3];return n>=-t[0]&&n<=t[0]&&c>=-t[1]&&c<=t[1]}function ea(l,t,n,c,p,y,b,E,D,L){const k=n.transform,N=c?l.textSizeData:l.iconSizeData,V=o.bp(N,n.transform.zoom),j="globe"===k.projection.name,Y=[256/n.width*2+1,256/n.height*2+1],Z=c?l.text.dynamicLayoutVertexArray:l.icon.dynamicLayoutVertexArray;Z.clear();let Q=null;j&&(Q=c?l.text.globeExtVertexArray:l.icon.globeExtVertexArray);const J=l.lineVertexArray,re=c?l.text.placedSymbolArray:l.icon.placedSymbolArray,he=n.transform.width/n.transform.height;let ce,ge=!1;for(let pe=0;pe<re.length;pe++){const _e=re.get(pe),{numGlyphs:de,writingMode:be}=_e;if(be!==o.bq.vertical||ge||ce===o.bq.horizontal||(ge=!0),ce=be,(_e.hidden||be===o.bq.vertical)&&!ge){en(de,Z);continue}ge=!1;const Ee=new o.P(_e.tileAnchorX,_e.tileAnchorY);let{x:qe,y:Le,z:Ye}=k.projection.projectTilePoint(Ee.x,Ee.y,L.canonical);if(D){const[Ke,rt,ct]=D(Ee);qe+=Ke,Le+=rt,Ye+=ct}const Xe=[qe,Le,Ye,1];if(o.ab.vec4.transformMat4(Xe,Xe,t),!Wr(Xe,Y)){en(de,Z);continue}const Re=Xe[3],He=Il(n.transform.getCameraToCenterDistance(k.projection),Re),it=o.br(N,V,_e),De=b?it/He:it*He,Je=lr(qe,Le,Ye,p);if(Je[3]<=0){en(de,Z);continue}let We={};const ut=b?null:D,et=Ds(_e,De,!1,E,t,p,y,l.glyphOffsetArray,J,Z,Q,Je,Ee,We,he,ut,k.projection,L,b);ge=et.useVertical,ut&&et.needsFlipping&&(We={}),(et.notEnoughRoom||ge||et.needsFlipping&&Ds(_e,De,!0,E,t,p,y,l.glyphOffsetArray,J,Z,Q,Je,Ee,We,he,ut,k.projection,L,b).notEnoughRoom)&&en(de,Z)}c?(l.text.dynamicLayoutVertexBuffer.updateData(Z),Q&&l.text.globeExtVertexBuffer&&l.text.globeExtVertexBuffer.updateData(Q)):(l.icon.dynamicLayoutVertexBuffer.updateData(Z),Q&&l.icon.globeExtVertexBuffer&&l.icon.globeExtVertexBuffer.updateData(Q))}function bo(l,t,n,c,p,y,b,E,D,L,k,N,V,j,Y,Z){const{lineStartIndex:Q,glyphStartIndex:J,segment:re}=E,he=J+E.numGlyphs,ce=Q+E.lineLength,ge=t.getoffsetX(J),pe=t.getoffsetX(he-1),_e=Ys(l*ge,n,c,p,y,b,re,Q,ce,D,L,k,N,V,!0,j,Y,Z);if(!_e)return null;const de=Ys(l*pe,n,c,p,y,b,re,Q,ce,D,L,k,N,V,!0,j,Y,Z);return de?{first:_e,last:de}:null}function cr(l,t,n,c){return l===o.bq.horizontal&&Math.abs(c)>Math.abs(n)?{useVertical:!0}:l===o.bq.vertical?c>0?{needsFlipping:!0}:null:t!==Ps_unknown&&(0===(p=n)||Math.abs(c/p)>vo)?t===Ps_flipRequired?{needsFlipping:!0}:null:n<0?{needsFlipping:!0}:null;var p}function Ds(l,t,n,c,p,y,b,E,D,L,k,N,V,j,Y,Z,Q,J,re){const he=t/24,ce=l.lineOffsetX*he,ge=l.lineOffsetY*he,{lineStartIndex:pe,glyphStartIndex:_e,numGlyphs:de,segment:be,writingMode:Ee,flipState:qe}=l,Le=pe+l.lineLength,Ye=Xe=>{if(k){const[De,Je,We]=Xe.up,ut=L.length;o.bs(k,ut+0,De,Je,We),o.bs(k,ut+1,De,Je,We),o.bs(k,ut+2,De,Je,We),o.bs(k,ut+3,De,Je,We)}const[Re,He,it]=Xe.point;o.bt(L,Re,He,it,Xe.angle)};if(de>1){const Xe=bo(he,E,ce,ge,n,N,V,l,D,y,j,Z,!1,Q,J,re);if(!Xe)return{notEnoughRoom:!0};if(c&&!n){let[Re,He,it]=Xe.first.point,[De,Je,We]=Xe.last.point;[Re,He]=lr(Re,He,it,b),[De,Je]=lr(De,Je,We,b);const ut=cr(Ee,qe,(De-Re)*Y,Je-He);if(l.flipState=ut&&ut.needsFlipping?Ps_flipRequired:Ps_flipNotRequired,ut)return ut}Ye(Xe.first);for(let Re=_e+1;Re<_e+de-1;Re++){const He=Ys(he*E.getoffsetX(Re),ce,ge,n,N,V,be,pe,Le,D,y,j,Z,!1,!1,Q,J,re);if(!He)return L.length-=4*(Re-_e),{notEnoughRoom:!0};Ye(He)}Ye(Xe.last)}else{if(c&&!n){const Re=lr(V.x,V.y,0,p),He=pe+be+1,it=new o.P(D.getx(He),D.gety(He)),De=lr(it.x,it.y,0,p),Je=De[3]>0?De:bh(V,it,Re,1,p,void 0,Q,J.canonical),We=cr(Ee,qe,(Je[0]-Re[0])*Y,Je[1]-Re[1]);if(l.flipState=We&&We.needsFlipping?Ps_flipRequired:Ps_flipNotRequired,We)return We}const Xe=Ys(he*E.getoffsetX(_e),ce,ge,n,N,V,be,pe,Le,D,y,j,Z,!1,!1,Q,J,re);if(!Xe)return{notEnoughRoom:!0};Ye(Xe)}return{}}function rr(l,t,n,c,p){const{x:y,y:b,z:E}=c.projectTilePoint(l.x,l.y,t);if(!p)return lr(y,b,E,n);const[D,L,k]=p(l);return lr(y+D,b+L,E+k,n)}function bh(l,t,n,c,p,y,b,E){const D=rr(l.sub(t)._unit()._add(l),E,p,b,y);return o.ab.vec3.sub(D,n,D),o.ab.vec3.normalize(D,D),o.ab.vec3.scaleAndAdd(D,n,D,c)}function Ys(l,t,n,c,p,y,b,E,D,L,k,N,V,j,Y,Z,Q,J){const re=c?l-t:l+t;let he=re>0?1:-1,ce=0;c&&(he*=-1,ce=Math.PI),he<0&&(ce+=Math.PI);let ge=E+b+(he>0?0:1)|0,pe=p,_e=p,de=0,be=0;const Ee=Math.abs(re),qe=[],Le=[];let Ye=y,Xe=Ye;const Re=()=>bh(Xe,Ye,_e,Ee-de+1,k,V,Z,Q.canonical);for(;de+be<=Ee;){if(ge+=he,ge<E||ge>=D)return null;if(_e=pe,Xe=Ye,qe.push(_e),j&&Le.push(Xe),Ye=new o.P(L.getx(ge),L.gety(ge)),pe=N[ge],!pe){const rt=rr(Ye,Q.canonical,k,Z,V);pe=rt[3]>0?N[ge]=rt:Re()}de+=be,be=o.ab.vec3.distance(_e,pe)}Y&&V&&(N[ge]&&(pe=Re(),be=o.ab.vec3.distance(_e,pe)),N[ge]=pe);const He=(Ee-de)/be,it=Ye.sub(Xe)._mult(He)._add(Xe),De=o.ab.vec3.sub([],pe,_e),Je=o.ab.vec3.scaleAndAdd([],_e,De,He);let We=[0,0,1],ut=De[0],et=De[1];if(J&&(We=Z.upVector(Q.canonical,it.x,it.y),0!==We[0]||0!==We[1]||1!==We[2])){const rt=[We[2],0,-We[0]],ct=o.ab.vec3.cross([],We,rt);o.ab.vec3.normalize(rt,rt),o.ab.vec3.normalize(ct,ct),ut=o.ab.vec3.dot(De,rt),et=o.ab.vec3.dot(De,ct)}if(n){const rt=o.ab.vec3.cross([],We,De);o.ab.vec3.normalize(rt,rt),o.ab.vec3.scaleAndAdd(Je,Je,rt,n*he)}const Ke=ce+Math.atan2(et,ut);return qe.push(Je),j&&Le.push(it),{point:Je,angle:Ke,path:qe,tilePath:Le,up:We}}function en(l,t){const n=t.length,c=n+4*l;t.resize(c),t.float32.fill(-1/0,4*n,4*c)}function br(l,t,n){const c=t[0],p=t[1];return l[0]=n[0]*c+n[4]*p+n[12],l[1]=n[1]*c+n[5]*p+n[13],l[3]=n[3]*c+n[7]*p+n[15],l}const Jn=100;class Sn{constructor(t,n,c=new fn(t.width+200,t.height+200,25),p=new fn(t.width+200,t.height+200,25)){this.transform=t,this.grid=c,this.ignoredGrid=p,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+Jn,this.screenBottomBoundary=t.height+Jn,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=n}placeCollisionBox(t,n,c,p,y,b,E,D){let L=c.projectedAnchorX,k=c.projectedAnchorY,N=c.projectedAnchorZ;const V=c.elevation,j=c.tileID,Y=t.getProjection();if(V&&j){const[pe,_e,de]=Y.upVector(j.canonical,c.tileAnchorX,c.tileAnchorY),be=Y.upVectorScale(j.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;L+=pe*V*be,k+=_e*V*be,N+=de*V*be}const Z=this.projectAndGetPerspectiveRatio(E,L,k,N,c.tileID,"globe"===Y.name||!!V||this.transform.pitch>0,Y),Q=b*Z.perspectiveRatio,J=(c.x1*n+p.x-c.padding)*Q+Z.point.x,re=(c.y1*n+p.y-c.padding)*Q+Z.point.y,he=(c.x2*n+p.x+c.padding)*Q+Z.point.x,ce=(c.y2*n+p.y+c.padding)*Q+Z.point.y,ge=Z.perspectiveRatio<=.55||Z.occluded;return!this.isInsideGrid(J,re,he,ce)||!y&&this.grid.hitTest(J,re,he,ce,D)||ge?{box:[],offscreen:!1,occluded:Z.occluded}:{box:[J,re,he,ce],offscreen:this.isOffscreen(J,re,he,ce),occluded:!1}}placeCollisionCircles(t,n,c,p,y,b,E,D,L,k,N,V,j,Y,Z){const Q=[],J=this.transform.elevation,re=t.getProjection(),he=J?J.getAtTileOffsetFunc(Z,this.transform.center.lat,this.transform.worldSize,re):null,ce=new o.P(c.tileAnchorX,c.tileAnchorY);let{x:ge,y:pe,z:_e}=re.projectTilePoint(ce.x,ce.y,Z.canonical);if(he){const[it,De,Je]=he(ce);ge+=it,pe+=De,_e+=Je}const de="globe"===re.name,be=this.projectAndGetPerspectiveRatio(E,ge,pe,_e,Z,de||!!J||this.transform.pitch>0,re),{perspectiveRatio:Ee}=be,qe=(N?b/Ee:b*Ee)/o.bw,Le=lr(ge,pe,_e,D),Ye=be.signedDistanceFromCamera>0?bo(qe,y,c.lineOffsetX*qe,c.lineOffsetY*qe,!1,Le,ce,c,p,D,{},J&&!N?he:null,N&&!!J,re,Z,N):null;let Xe=!1,Re=!1,He=!0;if(Ye&&!be.occluded){const it=.5*j*Ee+Y,De=new o.P(-100,-100),Je=new o.P(this.screenRightBoundary,this.screenBottomBoundary),We=new Pi,{first:ut,last:et}=Ye,Ke=ut.path.length;let rt=[];for(let Tt=Ke-1;Tt>=1;Tt--)rt.push(ut.path[Tt]);for(let Tt=1;Tt<et.path.length;Tt++)rt.push(et.path[Tt]);const ct=2.5*it;L&&(rt=rt.map(([Tt,jt,Lt],kt)=>(he&&!de&&(Lt=he(kt<Ke-1?ut.tilePath[Ke-1-kt]:et.tilePath[kt-Ke+2])[2]),lr(Tt,jt,Lt,L))),rt.some(Tt=>Tt[3]<=0)&&(rt=[]));let _t=[];if(rt.length>0){let Tt=1/0,jt=-1/0,Lt=1/0,kt=-1/0;for(const Zt of rt)Tt=Math.min(Tt,Zt[0]),Lt=Math.min(Lt,Zt[1]),jt=Math.max(jt,Zt[0]),kt=Math.max(kt,Zt[1]);jt>=De.x&&Tt<=Je.x&&kt>=De.y&&Lt<=Je.y&&(_t=[rt.map(Zt=>new o.P(Zt[0],Zt[1]))],(Tt<De.x||jt>Je.x||Lt<De.y||kt>Je.y)&&(_t=o.bu(_t,De.x,De.y,Je.x,Je.y)))}for(const Tt of _t){We.reset(Tt,.25*it);let jt=0;jt=We.length<=.5*it?1:Math.ceil(We.paddedLength/ct)+1;for(let Lt=0;Lt<jt;Lt++){const kt=Lt/Math.max(jt-1,1),Zt=We.lerp(kt),di=Zt.x+Jn,Ni=Zt.y+Jn;Q.push(di,Ni,it,0);const hn=di-it,nn=Ni-it,Kt=di+it,Ei=Ni+it;if(He=He&&this.isOffscreen(hn,nn,Kt,Ei),Re=Re||this.isInsideGrid(hn,nn,Kt,Ei),!n&&this.grid.hitTestCircle(di,Ni,it,V)&&(Xe=!0,!k))return{circles:[],offscreen:!1,collisionDetected:Xe,occluded:!1}}}}return{circles:!k&&Xe||!Re?[]:Q,offscreen:He,collisionDetected:Xe,occluded:be.occluded}}queryRenderedSymbols(t){if(0===t.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const n=[];let c=1/0,p=1/0,y=-1/0,b=-1/0;for(const k of t){const N=new o.P(k.x+Jn,k.y+Jn);c=Math.min(c,N.x),p=Math.min(p,N.y),y=Math.max(y,N.x),b=Math.max(b,N.y),n.push(N)}const E=this.grid.query(c,p,y,b).concat(this.ignoredGrid.query(c,p,y,b)),D={},L={};for(const k of E){const N=k.key;if(void 0===D[N.bucketInstanceId]&&(D[N.bucketInstanceId]={}),D[N.bucketInstanceId][N.featureIndex])continue;const V=[new o.P(k.x1,k.y1),new o.P(k.x2,k.y1),new o.P(k.x2,k.y2),new o.P(k.x1,k.y2)];o.bv(n,V)&&(D[N.bucketInstanceId][N.featureIndex]=!0,void 0===L[N.bucketInstanceId]&&(L[N.bucketInstanceId]=[]),L[N.bucketInstanceId].push(N.featureIndex))}return L}insertCollisionBox(t,n,c,p,y){(n?this.ignoredGrid:this.grid).insert({bucketInstanceId:c,featureIndex:p,collisionGroupID:y},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,n,c,p,y){const b=n?this.ignoredGrid:this.grid,E={bucketInstanceId:c,featureIndex:p,collisionGroupID:y};for(let D=0;D<t.length;D+=4)b.insertCircle(E,t[D],t[D+1],t[D+2])}projectAndGetPerspectiveRatio(t,n,c,p,y,b,E){const D=[n,c,p,1];let L=!1;p||this.transform.pitch>0?(o.ab.vec4.transformMat4(D,D,t),this.fogState&&y&&"globe"!==E.name&&(L=function(V,j,Y,Z,Q,J){const re=J.calculateFogTileMatrix(Q),he=[j,Y,Z];return o.ab.vec3.transformMat4(he,he,re),Te(V,o.ab.vec3.length(he),J.pitch,J._fov)}(this.fogState,n,c,p,y.toUnwrapped(),this.transform)>.9)):br(D,D,t);const k=D[3];return{point:new o.P((D[0]/k+1)/2*this.transform.width+Jn,(-D[1]/k+1)/2*this.transform.height+Jn),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(E)/k*.5,1.5),signedDistanceFromCamera:k,occluded:b&&D[2]>k||L}}isOffscreen(t,n,c,p){return c<Jn||t>=this.screenRightBoundary||p<Jn||n>this.screenBottomBoundary}isInsideGrid(t,n,c,p){return c>=0&&t<this.gridRightBoundary&&p>=0&&n<this.gridBottomBoundary}getViewportMatrix(){const t=o.ab.mat4.identity([]);return o.ab.mat4.translate(t,t,[-100,-100,0]),t}}function Cl(l,t,n){const c=t.createTileMatrix(l,l.worldSize,n.toUnwrapped());return o.ab.mat4.multiply(new Float32Array(16),l.projMatrix,c)}function gs(l,t,n){if(t.projection.name===n.projection.name)return l.projMatrix;const c=n.clone();return c.setProjection(t.projection),Cl(c,t.getProjection(),l)}function Ks(l,t,n){return t.name===n.projection.name?l.projMatrix:Cl(n,t,l)}class ja{constructor(t,n,c,p){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?n:-n))):p&&c?1:0,this.placed=c}isHidden(){return 0===this.opacity&&!this.placed}}class hr{constructor(t,n,c,p,y,b=!1){this.text=new ja(t?t.text:null,n,c,y),this.icon=new ja(t?t.icon:null,n,p,y),this.clipped=b}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class sr{constructor(t,n,c,p=!1){this.text=t,this.icon=n,this.skipFade=c,this.clipped=p}}class mn{constructor(){this.invProjMatrix=o.ab.mat4.create(),this.viewportMatrix=o.ab.mat4.create(),this.circles=[]}}class Pl{constructor(t,n,c,p,y){this.bucketInstanceId=t,this.featureIndex=n,this.sourceLayerIndex=c,this.bucketIndex=p,this.tileID=y}}class wh{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const n=++this.maxGroupID;this.collisionGroups[t]={ID:n,predicate:c=>c.collisionGroupID===n}}return this.collisionGroups[t]}}function Rn(l,t,n,c,p){const{horizontalAlign:y,verticalAlign:b}=o.bD(l),E=-(y-.5)*t,D=-(b-.5)*n,L=o.bC(l,c);return new o.P(E+L[0]*p,D+L[1]*p)}function Dl(l,t,n,c,p){const y=new o.P(l,t);return n&&y._rotate(c?p:-p),y}class Js{constructor(t,n,c,p,y,b){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new Sn(this.transform,y),this.buildingIndex=b,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=n,this.retainedQueryData={},this.collisionGroups=new wh(c),this.collisionCircleArrays={},this.prevPlacement=p,p&&(p.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,n,c,p,y=1){const b=c.getBucket(n),E=c.latestFeatureIndex;if(!b||!E||n.fqid!==b.layerIds[0])return;const D=b.layers[0].layout,L=b.layers[0].paint,k=c.collisionBoxArray,N=Math.pow(2,this.transform.zoom-c.tileID.overscaledZ),V=c.tileSize/o.ag,j=c.tileID.toUnwrapped();this.transform.setProjection(b.projection);const Y=(Z=c.tileID,Q=b.getProjection(),J=this.transform,Q.name===this.projection?J.calculateProjMatrix(Z.toUnwrapped()):Cl(J,Q,Z));var Z,Q,J;const re="map"===D.get("text-pitch-alignment"),he="map"===D.get("text-rotation-alignment");n.compileFilter(n.options);const ce=n.dynamicFilter(),ge=n.dynamicFilterNeedsFeature(),pe=this.transform.calculatePixelsToTileUnitsMatrix(c),_e=sn(Y,c.tileID.canonical,re,he,this.transform,b.getProjection(),pe);let de=null;if(re){const it=bc(Y,c.tileID.canonical,re,he,this.transform,b.getProjection(),pe);de=o.ab.mat4.multiply([],this.transform.labelPlaneMatrix,it)}let be=null;ce&&c.latestFeatureIndex&&(be={unwrappedTileID:j,dynamicFilter:ce,dynamicFilterNeedsFeature:ge}),this.retainedQueryData[b.bucketInstanceId]=new Pl(b.bucketInstanceId,E,b.sourceLayerIndex,b.index,c.tileID);const[Ee,qe]=b.layers[0].layout.get("text-size-scale-range"),Le=o.aw(y,Ee,qe),[Ye,Xe]=D.get("icon-size-scale-range"),Re=o.aw(y,Ye,Xe),He={bucket:b,layout:D,paint:L,posMatrix:Y,textLabelPlaneMatrix:_e,labelToScreenMatrix:de,clippingData:be,scale:N,textPixelRatio:V,holdingForFade:c.holdingForFade(),collisionBoxArray:k,partiallyEvaluatedTextSize:o.bp(b.textSizeData,this.transform.zoom,Le),partiallyEvaluatedIconSize:o.bp(b.iconSizeData,this.transform.zoom,Re),collisionGroup:this.collisionGroups.get(b.sourceID),latestFeatureIndex:c.latestFeatureIndex};if(p)for(const it of b.sortKeyRanges){const{sortKey:De,symbolInstanceStart:Je,symbolInstanceEnd:We}=it;t.push({sortKey:De,symbolInstanceStart:Je,symbolInstanceEnd:We,parameters:He})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:b.symbolInstances.length,parameters:He})}attemptAnchorPlacement(t,n,c,p,y,b,E,D,L,k,N,V,j,Y,Z,Q,J,re){const{textOffset0:he,textOffset1:ce,crossTileID:ge}=V,pe=[he,ce],_e=Rn(t,c,p,pe,y),de=this.collisionIndex.placeCollisionBox(Y,y,n,Dl(_e.x,_e.y,b,E,this.transform.angle),N,D,L,k.predicate);if(Q){const be=Y.getSymbolInstanceIconSize(re,this.transform.zoom,V.placedIconSymbolIndex);if(0===this.collisionIndex.placeCollisionBox(Y,be,Q,Dl(_e.x,_e.y,b,E,this.transform.angle),N,D,L,k.predicate).box.length)return}if(de.box.length>0){let be;return this.prevPlacement&&this.prevPlacement.variableOffsets[ge]&&this.prevPlacement.placements[ge]&&this.prevPlacement.placements[ge].text&&(be=this.prevPlacement.variableOffsets[ge].anchor),this.variableOffsets[ge]={textOffset:pe,width:c,height:p,anchor:t,textScale:y,prevAnchor:be},this.markUsedJustification(Y,t,V,Z),Y.allowVerticalPlacement&&(this.markUsedOrientation(Y,Z,V),this.placedOrientations[ge]=Z),{shift:_e,placedGlyphBoxes:de}}}placeLayerBucketPart(t,n,c,p,y=1){const{bucket:b,layout:E,paint:D,posMatrix:L,textLabelPlaneMatrix:k,labelToScreenMatrix:N,clippingData:V,textPixelRatio:j,holdingForFade:Y,collisionBoxArray:Z,partiallyEvaluatedTextSize:Q,partiallyEvaluatedIconSize:J,collisionGroup:re,latestFeatureIndex:he}=t.parameters,ce=E.get("text-optional"),ge=E.get("icon-optional"),pe=E.get("text-allow-overlap"),_e=E.get("icon-allow-overlap"),de="map"===E.get("text-rotation-alignment"),be="map"===E.get("text-pitch-alignment"),Ee=E.get("symbol-z-elevate"),qe=D.get("symbol-z-offset"),Le="sea"===E.get("symbol-elevation-reference"),[Ye,Xe]=E.get("text-size-scale-range"),[Re,He]=E.get("icon-size-scale-range"),it=o.aw(y,Ye,Xe),De=o.aw(y,Re,He);this.transform.setProjection(b.projection);let Je=pe&&(_e||!b.hasIconData()||ge),We=_e&&(pe||!b.hasTextData()||ce);const ut=!qe.isConstant();!b.collisionArrays&&Z&&b.deserializeCollisionBoxes(Z),c&&p&&b.updateCollisionDebugBuffers(this.transform.zoom,Z,it,De);const et=(Ke,rt,ct)=>{const{crossTileID:_t,numVerticalGlyphVertices:Tt}=Ke;let jt=null;if(V&&V.dynamicFilterNeedsFeature||ut){const ji=this.retainedQueryData[b.bucketInstanceId];jt=he.loadFeature({featureIndex:Ke.featureIndex,bucketIndex:ji.bucketIndex,sourceLayerIndex:ji.sourceLayerIndex,layoutVertexArrayOffset:0})}if(V&&!(0,V.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},jt,this.retainedQueryData[b.bucketInstanceId].tileID.canonical,new o.P(Ke.tileAnchorX,Ke.tileAnchorY),this.transform.calculateDistanceTileData(V.unwrappedTileID)))return this.placements[_t]=new sr(!1,!1,!1,!0),void n.add(_t);const Lt=qe.evaluate(jt,{});if(n.has(_t))return;if(Y)return void(this.placements[_t]=new sr(!1,!1,!1));let kt=!1,Zt=!1,di=!0,Ni=!1,hn=!1,nn=null,Kt={box:null,offscreen:null,occluded:null},Ei={box:null,offscreen:null,occluded:null},Pt=null,pi=null,Di=null,ki=0,un=0,jn=0;ct.textFeatureIndex?ki=ct.textFeatureIndex:Ke.useRuntimeCollisionCircles&&(ki=Ke.featureIndex),ct.verticalTextFeatureIndex&&(un=ct.verticalTextFeatureIndex);const An=ji=>{ji.tileID=this.retainedQueryData[b.bucketInstanceId].tileID;const vi=this.transform.elevation;ji.elevation=Le?Lt:Lt+(vi?vi.getAtTileOffset(ji.tileID,ji.tileAnchorX,ji.tileAnchorY):0),ji.elevation+=Ke.zOffset},Mn=ct.textBox;if(Mn){An(Mn);const ji=bi=>{let wn=o.bq.horizontal;if(b.allowVerticalPlacement&&!bi&&this.prevPlacement){const kn=this.prevPlacement.placedOrientations[_t];kn&&(this.placedOrientations[_t]=kn,wn=kn,this.markUsedOrientation(b,wn,Ke))}return wn},vi=(bi,wn)=>{if(b.allowVerticalPlacement&&Tt>0&&ct.verticalTextBox){for(const kn of b.writingModes)if(kn===o.bq.vertical?(Kt=wn(),Ei=Kt):Kt=bi(),Kt&&Kt.box&&Kt.box.length)break}else Kt=bi()};if(E.get("text-variable-anchor")){let bi=E.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[_t]){const Xi=this.prevPlacement.variableOffsets[_t];bi.indexOf(Xi.anchor)>0&&(bi=bi.filter(_r=>_r!==Xi.anchor),bi.unshift(Xi.anchor))}const wn=(Xi,_r,es)=>{const Ur=b.getSymbolInstanceTextSize(Q,Ke,this.transform.zoom,rt),Tr=(Xi.x2-Xi.x1)*Ur+2*Xi.padding,hs=(Xi.y2-Xi.y1)*Ur+2*Xi.padding,Dr=Ke.hasIconTextFit&&!_e?_r:null;Dr&&An(Dr);let ts={box:[],offscreen:!1,occluded:!1};const wa=pe?2*bi.length:bi.length;for(let js=0;js<wa;++js){const Ta=this.attemptAnchorPlacement(bi[js%bi.length],Xi,Tr,hs,Ur,de,be,j,L,re,js>=bi.length,Ke,rt,b,es,Dr,Q,J);if(Ta&&(ts=Ta.placedGlyphBoxes,ts&&ts.box&&ts.box.length)){kt=!0,nn=Ta.shift;break}}return ts};vi(()=>wn(Mn,ct.iconBox,o.bq.horizontal),()=>{const Xi=ct.verticalTextBox;return Xi&&An(Xi),b.allowVerticalPlacement&&!(Kt&&Kt.box&&Kt.box.length)&&Tt>0&&Xi?wn(Xi,ct.verticalIconBox,o.bq.vertical):{box:null,offscreen:null,occluded:null}}),Kt&&(kt=Kt.box,di=Kt.offscreen,Ni=Kt.occluded);const kn=ji(!(!Kt||!Kt.box));if(!kt&&this.prevPlacement){const Xi=this.prevPlacement.variableOffsets[_t];Xi&&(this.variableOffsets[_t]=Xi,this.markUsedJustification(b,Xi.anchor,Ke,kn))}}else{const bi=(wn,kn)=>{const Xi=b.getSymbolInstanceTextSize(Q,Ke,this.transform.zoom,rt,y),_r=this.collisionIndex.placeCollisionBox(b,Xi,wn,new o.P(0,0),pe,j,L,re.predicate);return _r&&_r.box&&_r.box.length&&(this.markUsedOrientation(b,kn,Ke),this.placedOrientations[_t]=kn),_r};vi(()=>bi(Mn,o.bq.horizontal),()=>{const wn=ct.verticalTextBox;return b.allowVerticalPlacement&&Tt>0&&wn?(An(wn),bi(wn,o.bq.vertical)):{box:null,offscreen:null,occluded:null}}),ji(!!(Kt&&Kt.box&&Kt.box.length))}}if(Pt=Kt,kt=Pt&&Pt.box&&Pt.box.length>0,di=Pt&&Pt.offscreen,Ni=Pt&&Pt.occluded,Ke.useRuntimeCollisionCircles){const ji=b.text.placedSymbolArray.get(Ke.centerJustifiedTextSymbolIndex>=0?Ke.centerJustifiedTextSymbolIndex:Ke.verticalPlacedTextSymbolIndex),vi=o.br(b.textSizeData,Q,ji),bi=E.get("text-padding");pi=this.collisionIndex.placeCollisionCircles(b,pe,ji,b.lineVertexArray,b.glyphOffsetArray,vi,L,k,N,c,be,re.predicate,Ke.collisionCircleDiameter*vi/o.bw,bi,this.retainedQueryData[b.bucketInstanceId].tileID),kt=pe||pi.circles.length>0&&!pi.collisionDetected,di=di&&pi.offscreen,Ni=pi.occluded}if(ct.iconFeatureIndex&&(jn=ct.iconFeatureIndex),ct.iconBox){const ji=vi=>{An(vi);const bi=Ke.hasIconTextFit&&nn?Dl(nn.x,nn.y,de,be,this.transform.angle):new o.P(0,0),wn=b.getSymbolInstanceIconSize(J,this.transform.zoom,Ke.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(b,wn,vi,bi,_e,j,L,re.predicate)};Ei&&Ei.box&&Ei.box.length&&ct.verticalIconBox?(Di=ji(ct.verticalIconBox),Zt=Di.box.length>0):(Di=ji(ct.iconBox),Zt=Di.box.length>0),di=di&&Di.offscreen,hn=Di.occluded}const Qr=ce||0===Ke.numHorizontalGlyphVertices&&0===Tt,mr=ge||0===Ke.numIconVertices;if(Qr||mr?mr?Qr||(Zt=Zt&&kt):kt=Zt&&kt:Zt=kt=Zt&&kt,kt&&Pt&&Pt.box&&this.collisionIndex.insertCollisionBox(Pt.box,E.get("text-ignore-placement"),b.bucketInstanceId,Ei&&Ei.box&&un?un:ki,re.ID),Zt&&Di&&this.collisionIndex.insertCollisionBox(Di.box,E.get("icon-ignore-placement"),b.bucketInstanceId,jn,re.ID),pi&&(kt&&this.collisionIndex.insertCollisionCircles(pi.circles,E.get("text-ignore-placement"),b.bucketInstanceId,ki,re.ID),c)){const ji=b.bucketInstanceId;let vi=this.collisionCircleArrays[ji];void 0===vi&&(vi=this.collisionCircleArrays[ji]=new mn);for(let bi=0;bi<pi.circles.length;bi+=4)vi.circles.push(pi.circles[bi+0]),vi.circles.push(pi.circles[bi+1]),vi.circles.push(pi.circles[bi+2]),vi.circles.push(pi.collisionDetected?1:0)}const dn="globe"!==b.projection.name;Je=Je&&(dn||!Ni),We=We&&(dn||!hn),this.placements[_t]=new sr(kt||Je,Zt||We,di||b.justReloaded),n.add(_t)};if(Ee&&this.buildingIndex&&(this.buildingIndex.updateZOffset(b,this.retainedQueryData[b.bucketInstanceId].tileID),b.updateZOffset()),b.sortFeaturesByY){const Ke=b.getSortedSymbolIndexes(this.transform.angle);for(let rt=Ke.length-1;rt>=0;--rt){const ct=Ke[rt];et(b.symbolInstances.get(ct),ct,b.collisionArrays[ct])}b.hasAnyZOffset&&o.w(`${b.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(b.hasAnyZOffset){const Ke=b.getSortedIndexesByZOffset();for(let rt=0;rt<Ke.length;++rt){const ct=Ke[rt];et(b.symbolInstances.get(ct),ct,b.collisionArrays[ct])}}else for(let Ke=t.symbolInstanceStart;Ke<t.symbolInstanceEnd;Ke++)et(b.symbolInstances.get(Ke),Ke,b.collisionArrays[Ke]);if(c&&b.bucketInstanceId in this.collisionCircleArrays){const Ke=this.collisionCircleArrays[b.bucketInstanceId];o.ab.mat4.invert(Ke.invProjMatrix,L),Ke.viewportMatrix=this.collisionIndex.getViewportMatrix()}b.justReloaded=!1}markUsedJustification(t,n,c,p){const{leftJustifiedTextSymbolIndex:y,centerJustifiedTextSymbolIndex:b,rightJustifiedTextSymbolIndex:E,verticalPlacedTextSymbolIndex:D,crossTileID:L}=c,k=o.bB(n),N=p===o.bq.vertical?D:"left"===k?y:"center"===k?b:"right"===k?E:-1;y>=0&&(t.text.placedSymbolArray.get(y).crossTileID=N>=0&&y!==N?0:L),b>=0&&(t.text.placedSymbolArray.get(b).crossTileID=N>=0&&b!==N?0:L),E>=0&&(t.text.placedSymbolArray.get(E).crossTileID=N>=0&&E!==N?0:L),D>=0&&(t.text.placedSymbolArray.get(D).crossTileID=N>=0&&D!==N?0:L)}markUsedOrientation(t,n,c){const p=n===o.bq.horizontal||n===o.bq.horizontalOnly?n:0,y=n===o.bq.vertical?n:0,{leftJustifiedTextSymbolIndex:b,centerJustifiedTextSymbolIndex:E,rightJustifiedTextSymbolIndex:D,verticalPlacedTextSymbolIndex:L}=c,k=t.text.placedSymbolArray;b>=0&&(k.get(b).placedOrientation=p),E>=0&&(k.get(E).placedOrientation=p),D>=0&&(k.get(D).placedOrientation=p),L>=0&&(k.get(L).placedOrientation=y)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const n=this.prevPlacement;let c=!1;this.prevZoomAdjustment=n?n.zoomAdjustment(this.transform.zoom):0;const p=n?n.symbolFadeChange(t):1,y=n?n.opacities:{},b=n?n.variableOffsets:{},E=n?n.placedOrientations:{};for(const D in this.placements){const L=this.placements[D],k=y[D];k?(this.opacities[D]=new hr(k,p,L.text,L.icon,null,L.clipped),c=c||L.text!==k.text.placed||L.icon!==k.icon.placed):(this.opacities[D]=new hr(null,p,L.text,L.icon,L.skipFade,L.clipped),c=c||L.text||L.icon)}for(const D in y){const L=y[D];if(!this.opacities[D]){const k=new hr(L,p,!1,!1);k.isHidden()||(this.opacities[D]=k,c=c||L.text.placed||L.icon.placed)}}for(const D in b)this.variableOffsets[D]||!this.opacities[D]||this.opacities[D].isHidden()||(this.variableOffsets[D]=b[D]);for(const D in E)this.placedOrientations[D]||!this.opacities[D]||this.opacities[D].isHidden()||(this.placedOrientations[D]=E[D]);c?this.lastPlacementChangeTime=t:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=n?n.lastPlacementChangeTime:t)}updateLayerOpacities(t,n,c,p){const y=new Set;for(const b of n){const E=b.getBucket(t);E&&b.latestFeatureIndex&&t.fqid===E.layerIds[0]&&(this.updateBucketOpacities(E,y,b,b.collisionBoxArray,c,p,b.tileID,t.scope),E.layers[0].layout.get("symbol-z-elevate")&&this.buildingIndex&&(this.buildingIndex.updateZOffset(E,b.tileID),E.updateZOffset()))}}updateBucketOpacities(t,n,c,p,y,b,E,D){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const L=t.layers[0].layout,k=t.layers[0].paint,N=!!t.layers[0].dynamicFilter(),V=new hr(null,0,!1,!1,!0),j=L.get("text-allow-overlap"),Y=L.get("icon-allow-overlap"),Z=L.get("text-variable-anchor"),Q="map"===L.get("text-rotation-alignment"),J="map"===L.get("text-pitch-alignment"),re=k.get("symbol-z-offset"),he="sea"===L.get("symbol-elevation-reference"),ce=!re.isConstant(),ge=new hr(null,0,j&&(Y||!t.hasIconData()||L.get("icon-optional")),Y&&(j||!t.hasTextData()||L.get("text-optional")),!0);!t.collisionArrays&&p&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(p);const pe=(de,be,Ee)=>{for(let qe=0;qe<be/4;qe++)de.opacityVertexArray.emplaceBack(Ee)};let _e=0;b&&t.updateReplacement(E,b);for(let de=0;de<t.symbolInstances.length;de++){const be=t.symbolInstances.get(de),{numHorizontalGlyphVertices:Ee,numVerticalGlyphVertices:qe,crossTileID:Le,numIconVertices:Ye,tileAnchorX:Xe,tileAnchorY:Re}=be;let He=null;const it=this.retainedQueryData[t.bucketInstanceId];ce&&be&&it&&(He=c.latestFeatureIndex.loadFeature({featureIndex:be.featureIndex,bucketIndex:it.bucketIndex,sourceLayerIndex:it.sourceLayerIndex,layoutVertexArrayOffset:0}));const De=re.evaluate(He,{}),Je=n.has(Le);let We=this.opacities[Le];Je?We=V:We||(We=ge,this.opacities[Le]=We),n.add(Le);const ut=Ee>0||qe>0,et=Ye>0,Ke=this.placedOrientations[Le],rt=Ke===o.bq.vertical,ct=Ke===o.bq.horizontal||Ke===o.bq.horizontalOnly;!ut&&!et||We.isHidden()||_e++;let _t=!1;if((ut||et)&&b)for(const Tt of t.activeReplacements){if(o.bx(Tt,y,o.by.Symbol,D)||Tt.min.x>Xe||Xe>Tt.max.x||Tt.min.y>Re||Re>Tt.max.y)continue;const jt=o.bz(Xe,Re,E.canonical,Tt.footprintTileId.canonical);if(_t=o.bA(jt,Tt.footprint),_t)break}if(ut){const Tt=_t?Qs:Sh(We.text);pe(t.text,Ee,rt?Qs:Tt),pe(t.text,qe,ct?Qs:Tt);const jt=We.text.isHidden(),{leftJustifiedTextSymbolIndex:Lt,centerJustifiedTextSymbolIndex:kt,rightJustifiedTextSymbolIndex:Zt,verticalPlacedTextSymbolIndex:di}=be,Ni=t.text.placedSymbolArray,hn=jt||rt?1:0;Lt>=0&&(Ni.get(Lt).hidden=hn),kt>=0&&(Ni.get(kt).hidden=hn),Zt>=0&&(Ni.get(Zt).hidden=hn),di>=0&&(Ni.get(di).hidden=jt||ct?1:0);const nn=this.variableOffsets[Le];nn&&this.markUsedJustification(t,nn.anchor,be,Ke);const Kt=this.placedOrientations[Le];Kt&&(this.markUsedJustification(t,"left",be,Kt),this.markUsedOrientation(t,Kt,be))}if(et){const Tt=_t?Qs:Sh(We.icon),{placedIconSymbolIndex:jt,verticalPlacedIconSymbolIndex:Lt}=be,kt=t.icon.placedSymbolArray,Zt=We.icon.isHidden()?1:0;jt>=0&&(pe(t.icon,Ye,rt?Qs:Tt),kt.get(jt).hidden=Zt),Lt>=0&&(pe(t.icon,be.numVerticalIconVertices,ct?Qs:Tt),kt.get(Lt).hidden=Zt)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const Tt=t.collisionArrays[de];if(Tt){let jt=new o.P(0,0),Lt=!0;if(Tt.textBox||Tt.verticalTextBox){if(Z){const Zt=this.variableOffsets[Le];Zt?(jt=Rn(Zt.anchor,Zt.width,Zt.height,Zt.textOffset,Zt.textScale),Q&&jt._rotate(J?this.transform.angle:-this.transform.angle)):Lt=!1}N&&(Lt=!We.clipped),Tt.textBox&&Ga(t.textCollisionBox.collisionVertexArray,We.text.placed,!Lt||rt,De,he,jt.x,jt.y),Tt.verticalTextBox&&Ga(t.textCollisionBox.collisionVertexArray,We.text.placed,!Lt||ct,De,he,jt.x,jt.y)}const kt=Lt&&!(ct||!Tt.verticalIconBox);Tt.iconBox&&Ga(t.iconCollisionBox.collisionVertexArray,We.icon.placed,kt,De,he,be.hasIconTextFit?jt.x:0,be.hasIconTextFit?jt.y:0),Tt.verticalIconBox&&Ga(t.iconCollisionBox.collisionVertexArray,We.icon.placed,!kt,De,he,be.hasIconTextFit?jt.x:0,be.hasIconTextFit?jt.y:0)}}}if(t.fullyClipped=0===_e,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const de=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=de.invProjMatrix,t.placementViewportMatrix=de.viewportMatrix,t.collisionCircleArray=de.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return 0===this.fadeDuration?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,n){const c=this.zoomAtLastRecencyCheck===n?1-this.zoomAdjustment(n):1;return this.zoomAtLastRecencyCheck=n,this.commitTime+this.fadeDuration*c>t}setStale(){this.stale=!0}}function Ga(l,t,n,c,p,y,b){l.emplaceBack(t?1:0,n?1:0,y||0,b||0,c,p?1:0),l.emplaceBack(t?1:0,n?1:0,y||0,b||0,c,p?1:0),l.emplaceBack(t?1:0,n?1:0,y||0,b||0,c,p?1:0),l.emplaceBack(t?1:0,n?1:0,y||0,b||0,c,p?1:0)}const zl=Math.pow(2,25),Th=Math.pow(2,24),ku=Math.pow(2,17),Rl=Math.pow(2,16),Ll=Math.pow(2,9),Pd=Math.pow(2,8),ta=Math.pow(2,1);function Sh(l){if(0===l.opacity&&!l.placed)return 0;if(1===l.opacity&&l.placed)return 4294967295;const t=l.placed?1:0,n=Math.floor(127*l.opacity);return n*zl+t*Th+n*ku+t*Rl+n*Ll+t*Pd+n*ta+t}const Qs=0;class zs{constructor(t){this._sortAcrossTiles="viewport-y"!==t.layout.get("symbol-z-order")&&void 0!==t.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,n,c,p,y,b){const E=this._bucketParts;for(;this._currentTileIndex<t.length;)if(n.getBucketParts(E,p,t[this._currentTileIndex],this._sortAcrossTiles,b),this._currentTileIndex++,y())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,E.sort((D,L)=>D.sortKey-L.sortKey));this._currentPartIndex<E.length;){const D=E[this._currentPartIndex];if(n.placeLayerBucketPart(D,this._seenCrossTileIDs,c,0===D.symbolInstanceStart,b),this._currentPartIndex++,y())return!0}return!1}}class Ou{constructor(t,n,c,p,y,b,E,D,L){this.placement=new Js(t,y,b,E,D,L),this._currentPlacementIndex=n.length-1,this._forceFullPlacement=c,this._showCollisionBoxes=p,this._done=!1}isDone(){return this._done}continuePlacement(t,n,c,p,y){const b=o.q.now(),E=()=>{const D=o.q.now()-b;return!this._forceFullPlacement&&D>2};for(;this._currentPlacementIndex>=0;){const D=n[t[this._currentPlacementIndex]],L=this.placement.collisionIndex.transform.zoom;if("symbol"===D.type&&(!D.minzoom||D.minzoom<=L)&&(!D.maxzoom||D.maxzoom>L)){const k=D,N=k.layout.get("symbol-z-elevate"),V=void 0!==k.layout.get("symbol-sort-key").constantOr(1),j=k.layout.get("symbol-z-order"),Y="viewport-y"===j||"auto"===j&&!("viewport-y"!==j&&V),Z=k.layout.get("text-allow-overlap")||k.layout.get("icon-allow-overlap")||k.layout.get("text-ignore-placement")||k.layout.get("icon-ignore-placement"),Q=Y&&Z,J=this._inProgressLayer=this._inProgressLayer||new zs(k),re=o.aC(D.source,D.scope);if(J.continuePlacement(N||Q?p[re]:c[re],this.placement,this._showCollisionBoxes,D,E,y))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const Mh=512/o.ag/2;class Dd{constructor(t,n,c){this.tileID=t,this.bucketInstanceId=c,this.index=new o.bE(n.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const p=t.canonical.x*o.ag,y=t.canonical.y*o.ag;for(let b=0;b<n.length;b++){const{key:E,crossTileID:D,tileAnchorX:L,tileAnchorY:k}=n.get(b),N=Math.floor((p+L)*Mh),V=Math.floor((y+k)*Mh);this.index.add(N,V),this.keys.push(E),this.crossTileIDs.push(D)}this.index.finish()}findMatches(t,n,c){const p=this.tileID.canonical.z<n.canonical.z?1:Math.pow(2,this.tileID.canonical.z-n.canonical.z),y=Mh/Math.pow(2,n.canonical.z-this.tileID.canonical.z),b=n.canonical.x*o.ag,E=n.canonical.y*o.ag;for(let D=0;D<t.length;D++){const L=t.get(D);if(L.crossTileID)continue;const{key:k,tileAnchorX:N,tileAnchorY:V}=L,j=Math.floor((b+N)*y),Y=Math.floor((E+V)*y),Z=this.index.range(j-p,Y-p,j+p,Y+p);for(const Q of Z){const J=this.crossTileIDs[Q];if(this.keys[Q]===k&&!c.has(J)){c.add(J),L.crossTileID=J;break}}}}}class Eh{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class Fu{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const n=Math.round((t-this.lng)/360);if(0!==n)for(const c in this.indexes){const p=this.indexes[c],y={};for(const b in p){const E=p[b];E.tileID=E.tileID.unwrapTo(E.tileID.wrap+n),y[E.tileID.key]=E}this.indexes[c]=y}this.lng=t}addBucket(t,n,c){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===n.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let y=0;y<n.symbolInstances.length;y++)n.symbolInstances.get(y).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const p=this.usedCrossTileIDs[t.overscaledZ];for(const y in this.indexes){const b=this.indexes[y];if(Number(y)>t.overscaledZ)for(const E in b){const D=b[E];D.tileID.isChildOf(t)&&D.findMatches(n.symbolInstances,t,p)}else{const E=b[t.scaledTo(Number(y)).key];E&&E.findMatches(n.symbolInstances,t,p)}}for(let y=0;y<n.symbolInstances.length;y++){const b=n.symbolInstances.get(y);b.crossTileID||(b.crossTileID=c.generate(),p.add(b.crossTileID))}return void 0===this.indexes[t.overscaledZ]&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new Dd(t,n.symbolInstances,n.bucketInstanceId),!0}removeBucketCrossTileIDs(t,n){for(const c of n.crossTileIDs)this.usedCrossTileIDs[t].delete(c)}removeStaleBuckets(t){let n=!1;for(const c in this.indexes){const p=this.indexes[c];for(const y in p)t[p[y].bucketInstanceId]||(this.removeBucketCrossTileIDs(c,p[y]),delete p[y],n=!0)}return n}}class Ah{constructor(){this.layerIndexes={},this.crossTileIDs=new Eh,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,n,c,p){let y=this.layerIndexes[t.fqid];void 0===y&&(y=this.layerIndexes[t.fqid]=new Fu);let b=!1;const E={};"globe"!==p.name&&y.handleWrapJump(c);for(const D of n){const L=D.getBucket(t);L&&t.fqid===L.layerIds[0]&&(L.bucketInstanceId||(L.bucketInstanceId=++this.maxBucketInstanceId),y.addBucket(D.tileID,L,this.crossTileIDs)&&(b=!0),E[L.bucketInstanceId]=!0)}return y.removeStaleBuckets(E)&&(b=!0),b}pruneUnusedLayers(t){const n={};t.forEach(c=>{n[c]=!0});for(const c in this.layerIndexes)n[c]||delete this.layerIndexes[c]}}class li{constructor(t,n,c,p){this.blendFunction=t,this.blendColor=n,this.mask=c,this.blendEquation=p}}li.Replace=[1,0,1,0],li.disabled=new li(li.Replace,o.aj.transparent,[!1,!1,!1,!1]),li.unblended=new li(li.Replace,o.aj.transparent,[!0,!0,!0,!0]),li.alphaBlended=new li([1,771,1,771],o.aj.transparent,[!0,!0,!0,!0]),li.alphaBlendedNonPremultiplied=new li([770,771,770,771],o.aj.transparent,[!0,!0,!0,!0]),li.multiply=new li([774,0,774,0],o.aj.transparent,[!0,!0,!0,!0]);class zt{constructor(t,n,c){this.func=t,this.mask=n,this.range=c}}zt.ReadOnly=!1,zt.ReadWrite=!0,zt.disabled=new zt(519,zt.ReadOnly,[0,1]);class qt{constructor(t,n,c,p,y,b){this.test=t,this.ref=n,this.mask=c,this.fail=p,this.depthFail=y,this.pass=b}}qt.disabled=new qt({func:519,mask:0},0,0,7680,7680,7680);class Wt{constructor(t,n,c){this.enable=t,this.mode=n,this.frontFace=c}}function eo(l,t){const n=o.bG(l,3);o.ab.mat4.fromQuat(l,t),o.bI(l,3,n)}function ia(l,t){const n=o.ab.quat.identity([]);return o.ab.quat.rotateZ(n,n,-t),o.ab.quat.rotateX(n,n,-l),n}function Ih(l,t){const n=[l[0],l[1],0],c=[t[0],t[1],0];if(o.ab.vec3.length(n)>=1e-15){const b=o.ab.vec3.normalize([],n);o.ab.vec3.scale(c,b,o.ab.vec3.dot(c,b)),t[0]=c[0],t[1]=c[1]}const p=o.ab.vec3.cross([],t,l);if(o.ab.vec3.len(p)<1e-15)return null;const y=Math.atan2(-p[1],p[0]);return ia(Math.atan2(Math.sqrt(l[0]*l[0]+l[1]*l[1]),-l[2]),y)}Wt.disabled=new Wt(!1,1029,2305),Wt.backCCW=new Wt(!0,1029,2305),Wt.backCW=new Wt(!0,1029,2304),Wt.frontCW=new Wt(!0,1028,2304),Wt.frontCCW=new Wt(!0,1028,2305);class Ha{constructor(t,n){this.position=t,this.orientation=n}get position(){return this._position}set position(t){if(t){const n=t instanceof o.aa?t:new o.aa(t[0],t[1],t[2]);this._renderWorldCopies&&(n.x=o.bF(n.x,0,1)),this._position=n}else this._position=null}lookAtPoint(t,n){if(this.orientation=null,!this.position)return;const c=this.position,p=this._elevation?this._elevation.getAtPointOrZero(o.aa.fromLngLat(t)):0,y=o.aa.fromLngLat(t,p),b=[y.x-c.x,y.y-c.y,y.z-c.z];n||(n=[0,0,1]),n[2]=Math.abs(n[2]),this.orientation=Ih(b,n)}setPitchBearing(t,n){this.orientation=ia(o.ai(t),o.ai(-n))}}class ur{constructor(t,n){this._transform=o.ab.mat4.identity([]),this.orientation=n,this.position=t}get mercatorPosition(){const t=this.position;return new o.aa(t[0],t[1],t[2])}get position(){const t=o.bG(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var n;t&&o.bI(this._transform,3,[(n=t)[0],n[1],n[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||o.ab.quat.identity([]),t&&eo(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),n=this.right();return{bearing:Math.atan2(-n[1],n[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,n){this._orientation=ia(t,n),eo(this._transform,this._orientation)}forward(){const t=o.bG(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=o.bG(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=o.bG(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,n){const c=new Float64Array(16);return o.ab.mat4.invert(c,this.getWorldToCamera(t,n)),c}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,n,c){const p=this.position;o.ab.vec3.scale(p,p,-t);const y=new Float64Array(16);return o.ab.mat4.fromScaling(y,[c,c,c]),o.ab.mat4.translate(y,y,p),y[10]*=n,y}getWorldToCamera(t,n){const c=new Float64Array(16),p=new Float64Array(4),y=this.position;return o.ab.quat.conjugate(p,this._orientation),o.ab.vec3.scale(y,y,-t),o.ab.mat4.fromQuat(c,p),o.ab.mat4.translate(c,c,y),c[1]*=-1,c[5]*=-1,c[9]*=-1,c[13]*=-1,c[8]*=n,c[9]*=n,c[10]*=n,c[11]*=n,c}getCameraToClipPerspective(t,n,c,p){const y=new Float64Array(16);return o.ab.mat4.perspective(y,t,n,c,p),y}getCameraToClipOrthographic(t,n,c,p,y,b){const E=new Float64Array(16);return o.ab.mat4.ortho(E,t,n,c,p,y,b),E}getDistanceToElevation(t,n=!1){const c=0===t?0:o.bH(t,n?o.aS(this.position[1]):this.position[1]),p=this.forward();return(c-this.position[2])/p[2]}clone(){return new ur([...this.position],[...this.orientation])}}const Un_BaseColor=5,Un_MetallicRoughness=6,Un_Normal=7,Un_Occlusion=8,Un_Emission=9,Un_LUT=10,Un_ShadowMap0=11;class ft{constructor(t=0,n=0,c=0,p=0){if(isNaN(t)||t<0||isNaN(n)||n<0||isNaN(c)||c<0||isNaN(p)||p<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=n,this.left=c,this.right=p}interpolate(t,n,c){return null!=n.top&&null!=t.top&&(this.top=o.af(t.top,n.top,c)),null!=n.bottom&&null!=t.bottom&&(this.bottom=o.af(t.bottom,n.bottom,c)),null!=n.left&&null!=t.left&&(this.left=o.af(t.left,n.left,c)),null!=n.right&&null!=t.right&&(this.right=o.af(t.right,n.right,c)),this}getCenter(t,n){const c=o.aw((this.left+t-this.right)/2,0,t),p=o.aw((this.top+n-this.bottom)/2,0,n);return new o.P(c,p)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new ft(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const Ch=(l,t,n)=>(1-n)*l+n*t,Tc=l=>l*l*l*l*l;class ys{constructor(t,n,c,p,y,b,E){this.tileSize=512,this._renderWorldCopies=void 0===y||y,this._minZoom=t||0,this._maxZoom=n||22,this._minPitch=c??0,this._maxPitch=p??60,this.setProjection(b),this.setMaxBounds(E),this.width=0,this.height=0,this._center=new o.bO(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new ft,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new ur,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1}clone(){const t=new ys(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection());return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t}get isOrthographic(){return"globe"!==this.projection.name&&this._orthographicProjectionAtLowPitch&&this.pitch<15}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return"globe"!==this.projection.name&&!this.isOrthographic}updateElevation(t,n=!1){const c=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(null==this._seaLevelZoom||c)&&this._updateCameraOnTerrain(),(t||c)&&this._constrainCamera(n),this._calcMatrices()}getProjection(){return o.ay(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const n=this.projection?this.getProjection():void 0;this.projection=o.bP(this.projectionOptions);const c=this.getProjection(),p=!o.bn(n,c);return p&&this._calcMatrices(),this.mercatorFromTransition=!1,p}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=o.bP({name:"mercator"});const n=t!==this.projection.name;return n&&this._calcMatrices(),n}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies}set renderWorldCopies(t){void 0===t?t=!0:null===t&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return o.bH(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new o.P(this.width,this.height)}get bearing(){return o.bF(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const n=-t*Math.PI/180;this.angle!==n&&(this._unmodified=!1,this.angle=n,this._calcMatrices(),this.rotationMatrix=o.ab.mat2.create(),o.ab.mat2.rotate(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const n=o.aw(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==n&&(this._unmodified=!1,this._pitch=n,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=o.ai(t),this._calcMatrices())}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const n=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==n&&(this._unmodified=!1,this._setZoom(n),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){const t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,n=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!n||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const c=this._elevation;n||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&c.exaggeration()&&this._centerAltitudeValidForExaggeration!==c.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*c.exaggeration(),this._centerAltitudeValidForExaggeration=c.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=c.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){void 0!==this._centerAltitudeValidForExaggeration&&(this._seaLevelZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize))}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,n=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],c=this.horizonLineFromTop();let p=0,y=0;for(let b=0;b<n.length;b++){const E=new o.P(n[b][0]*this.width,c+n[b][1]*(this.height-c)),D=t.pointCoordinate(E);if(!D)continue;const L=1/Math.hypot(D[0]-this._camera.position[0],D[1]-this._camera.position[1]);p+=D[3]*L,y+=L}return 0===y?NaN:p/y}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(null==this._seaLevelZoom||!this._elevation)return;const t=this._seaLevelZoom,n=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),c=this.pixelsPerMeter/this.worldSize*n,p=this._mercatorZfromZoom(t),y=this._mercatorZfromZoom(this._maxZoom),b=Math.max(p-c,y);this._setZoom(this._zoomFromMercatorZ(b))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){const n=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let c;c=t.z<this._camera.position[2]?[n.x,n.y,n.z]:[t.x,t.y,t.z];const p=o.ab.vec3.length(o.ab.vec3.sub([],this._camera.position,c));return o.aw(this._zoomFromMercatorZ(p),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let n=!1;if(t.orientation&&!o.ab.quat.exactEquals(t.orientation,this._camera.orientation)&&(n=this._setCameraOrientation(t.orientation)),t.position){const c=[t.position.x,t.position.y,t.position.z];o.ab.vec3.exactEquals(c,this._camera.position)||(this._setCameraPosition(c),n=!0)}n&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,n=new Ha;return n.position=new o.aa(t[0],t[1],t[2]),n.orientation=this._camera.orientation,n._elevation=this.elevation,n._renderWorldCopies=this.renderWorldCopies,n}_setCameraOrientation(t){if(!o.ab.quat.length(t))return!1;o.ab.quat.normalize(t,t);const n=o.ab.vec3.transformQuat([],[0,0,-1],t),c=o.ab.vec3.transformQuat([],[0,-1,0],t);if(c[2]<0)return!1;const p=Ih(n,c);return!!p&&(this._camera.orientation=p,!0)}_setCameraPosition(t){const n=this.zoomScale(this.minZoom)*this.tileSize,c=this.zoomScale(this.maxZoom)*this.tileSize,p=this.cameraToCenterDistance;t[2]=o.aw(t[2],p/c,p/n),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,n,c){this._unmodified=!1,this._edgeInsets.interpolate(t,n,c),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const n=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,n)}getVisibleUnwrappedCoordinates(t){const n=[new o.bQ(0,t)];if(this.renderWorldCopies){const c=this.pointCoordinate(new o.P(0,0)),p=this.pointCoordinate(new o.P(this.width,0)),y=this.pointCoordinate(new o.P(this.width,this.height)),b=this.pointCoordinate(new o.P(0,this.height)),E=Math.floor(Math.min(c.x,p.x,y.x,b.x)),D=Math.floor(Math.max(c.x,p.x,y.x,b.x)),L=1;for(let k=E-L;k<=D+L;k++)0!==k&&n.push(new o.bQ(k,t))}return n}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,n,c){let p=[];const y=void 0!==c,b=!y;if(b&&this.zoom<n||y&&0===c[0]&&0===c[1])return p;const E=new Set,D=(k,N,V,j,Y)=>{const Z=o.c5(N,k,V,j,Y);E.has(Z)||(p.push(new o.aG(k,N,V,j,Y)),E.add(Z))};for(let k=0;k<t.length;k++){const N=t[k];if(b&&N.canonical.z!==n)continue;const V=N.canonical,j=N.overscaledZ,Y=N.wrap,Z=1<<V.z,Q=V.x+1<Z,J=V.x>0,re=V.y+1<Z,he=V.y>0,ce=N.wrap-(J?0:1),ge=N.wrap+(Q?0:1),pe=J?V.x-1:Z-1,_e=Q?V.x+1:0;if(y)c[0]<0?(D(j,ge,V.z,_e,V.y),c[1]<0&&re&&(D(j,Y,V.z,V.x,V.y+1),D(j,ge,V.z,_e,V.y+1)),c[1]>0&&he&&(D(j,Y,V.z,V.x,V.y-1),D(j,ge,V.z,_e,V.y-1))):c[0]>0?(D(j,ce,V.z,pe,V.y),c[1]<0&&re&&(D(j,Y,V.z,V.x,V.y+1),D(j,ce,V.z,pe,V.y+1)),c[1]>0&&he&&(D(j,Y,V.z,V.x,V.y-1),D(j,ce,V.z,pe,V.y-1))):c[1]<0&&re?D(j,Y,V.z,V.x,V.y+1):he&&D(j,Y,V.z,V.x,V.y-1);else{const de=N.visibleQuadrants;1&de&&(D(j,ce,V.z,pe,V.y),he&&(D(j,Y,V.z,V.x,V.y-1),D(j,ce,V.z,pe,V.y-1))),2&de&&(D(j,ge,V.z,_e,V.y),he&&(D(j,Y,V.z,V.x,V.y-1),D(j,ge,V.z,_e,V.y-1))),4&de&&(D(j,ce,V.z,pe,V.y),re&&(D(j,Y,V.z,V.x,V.y+1),D(j,ce,V.z,pe,V.y+1))),8&de&&(D(j,ge,V.z,_e,V.y),re&&(D(j,Y,V.z,V.x,V.y+1),D(j,ge,V.z,_e,V.y+1)))}}const L=[];for(const k of p)p.some(N=>k.isChildOf(N))||L.push(k);if(p=L.filter(k=>!t.some(N=>!!(k.overscaledZ<n&&N.isChildOf(k))||k.equals(N)||k.isChildOf(N))),b){const k=1<<n,N="globe"===this.projection.name?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),V=[k*N.x,k*N.y],j=4,Y=j*j;p=p.filter(Z=>{const Q=Z.canonical.x+.5-V[0],J=Z.canonical.y+.5-V[1];return Q*Q+J*J<Y})}return p}coveringTiles(t){let n=this.coveringZoomLevel(t);const c=n,p=this.elevation&&this.elevation.exaggeration(),y=p&&!t.isTerrainDEM,b="mercator"===this.projection.name;if(void 0!==t.minzoom&&n<t.minzoom)return[];void 0!==t.maxzoom&&n>t.maxzoom&&(n=t.maxzoom);const E=this.locationCoordinate(this.center),D=this.center.lat,L=1<<n,k=[L*E.x,L*E.y,0],N="globe"===this.projection.name,V=!N,j=o.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,n,V),Y=N?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),Z=L*o.bH(1,this.center.lat),Q=this._camera.position[2]/o.bH(1,this.center.lat),J=[L*Y.x,L*Y.y,Q*(V?1:Z)],re=N||p,he=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),ce=this.isLODDisabled(!0)?n:0;let ge;if(this._elevation&&t.isTerrainDEM)ge=1e4*this._elevation.exaggeration();else if(this._elevation){const De=this._elevation.getMinMaxForVisibleTiles();ge=De?De.max:this._centerAltitude}else ge=this._centerAltitude;const pe=t.isTerrainDEM?-ge:this._elevation?this._elevation.getMinElevationBelowMSL():0,_e=this.projection.isReprojectedInTileSpace?o.bS(this):1,de=De=>{const We=new o.aa(De.x+25e-6,De.y,De.z),ut=new o.aa(De.x,De.y+25e-6,De.z),et=De.toLngLat(),Ke=We.toLngLat(),rt=ut.toLngLat(),ct=this.locationCoordinate(et),_t=this.locationCoordinate(Ke),Tt=this.locationCoordinate(rt),jt=Math.hypot(_t.x-ct.x,_t.y-ct.y),Lt=Math.hypot(Tt.x-ct.x,Tt.y-ct.y);return Math.sqrt(jt*Lt)*_e/25e-6},be=De=>{const Je=ge,We=pe;return{aabb:o.bV(this,L,0,0,0,De,We,Je,this.projection),zoom:0,x:0,y:0,minZ:We,maxZ:Je,wrap:De,fullyVisible:!1}},Ee=[];let qe=[];const Le=n,Ye=t.reparseOverscaled?c:n,Xe=(Q-this._centerAltitude)*Z,Re=De=>{if(!this._elevation||!De.tileID||!b)return;const Je=this._elevation.getMinMaxForTile(De.tileID),We=De.aabb;Je?(We.min[2]=Je.min,We.max[2]=Je.max,We.center[2]=(We.min[2]+We.max[2])/2):(De.shouldSplit=it(De),De.shouldSplit||(We.min[2]=We.max[2]=We.center[2]=this._centerAltitude))},He=(De,Je)=>{if(.707*Je<De)return 1;const We=Je/De;return We/(1.4144271570014144+(Math.pow(1.1,We-1.4144271570014144+1)-1)/(1.1-1)-1)},it=De=>{if(De.zoom<ce)return!0;if(De.zoom===Le)return!1;if(null!=De.shouldSplit)return De.shouldSplit;const Je=De.aabb.distanceX(J),We=De.aabb.distanceY(J);let ut=Xe,et=1;if(N){ut=De.aabb.distanceZ(J);const Lt=Math.pow(2,De.zoom),kt=o.aS((De.y+1)/Lt),Zt=o.aS(De.y/Lt),di=Math.min(Math.max(D,kt),Zt),Ni=o.c9(di)/o.c9(D);if(et=di===D?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,Ni/this._mercatorScaleRatio),this.zoom<=o.c6&&De.zoom===Le-1&&Ni>=.9)return!0}else if(y&&(ut=De.aabb.distanceZ(J)*Z),this.projection.isReprojectedInTileSpace&&c<=5){const Lt=Math.pow(2,De.zoom),kt=de(new o.aa((De.x+.5)/Lt,(De.y+.5)/Lt));et=kt>.85?1:kt}if(!b){const Lt=Math.sqrt(Je*Je+We*We+ut*ut);let kt=(1<<Le-De.zoom)*he*et;return kt*=He(Math.max(ut,Xe),Lt),Lt<kt}let Ke=Number.MAX_VALUE,rt=0;const ct=De.aabb.getCorners(),_t=[];for(const Lt of ct){o.ab.vec3.sub(_t,Lt,J),N||(y?_t[2]*=Z:_t[2]=Xe);const kt=o.ab.vec3.dot(_t,this._camera.forward());kt<Ke&&(Ke=kt,rt=Math.abs(_t[2]))}let Tt=(1<<Le-De.zoom)*he*et;if(Tt*=He(Math.max(rt,Xe),Ke),Ke<Tt)return!0;const jt=De.aabb.closestPoint(k);return jt[0]===k[0]&&jt[1]===k[1]};if(this.renderWorldCopies)for(let De=1;De<=3;De++)Ee.push(be(-De)),Ee.push(be(De));for(Ee.push(be(0));Ee.length>0;){const De=Ee.pop(),Je=De.x,We=De.y;let ut=De.fullyVisible;const et=()=>"globe"===this.projection.name&&(0===De.y||De.y===(1<<De.zoom)-1);if(!ut){let Ke=re?De.aabb.intersects(j):De.aabb.intersectsFlat(j);if(0===Ke&&et()){const rt=new o.bT(De.zoom,Je,We);Ke=o.bU(this,L,rt,!0).intersects(j)}if(0===Ke)continue;ut=2===Ke}if(De.zoom!==Le&&it(De))for(let Ke=0;Ke<4;Ke++){const rt=(Je<<1)+Ke%2,ct=(We<<1)+(Ke>>1),_t={aabb:b?De.aabb.quadrant(Ke):o.bV(this,L,De.zoom+1,rt,ct,De.wrap,De.minZ,De.maxZ,this.projection),zoom:De.zoom+1,x:rt,y:ct,wrap:De.wrap,fullyVisible:ut,tileID:void 0,shouldSplit:void 0,minZ:De.minZ,maxZ:De.maxZ};y&&!N&&(_t.tileID=new o.aG(De.zoom+1===Le?Ye:De.zoom+1,De.wrap,De.zoom+1,rt,ct),Re(_t)),Ee.push(_t)}else{const Ke=De.zoom===Le?Ye:De.zoom;if(t.minzoom&&t.minzoom>Ke)continue;let rt=0;if(!ut){let jt=re?De.aabb.intersectsPrecise(j):De.aabb.intersectsPreciseFlat(j);if(0===jt&&et()){const Lt=new o.bT(De.zoom,Je,We);jt=o.bU(this,L,Lt,!0).intersectsPrecise(j)}if(0===jt)continue;if(t.calculateQuadrantVisibility)if(j.containsPoint(De.aabb.center))rt=15;else for(let Lt=0;Lt<4;Lt++)0!==De.aabb.quadrant(Lt).intersects(j)&&(rt|=1<<Lt)}const ct=k[0]-(.5+Je+(De.wrap<<De.zoom))*(1<<n-De.zoom),_t=k[1]-.5-We,Tt=De.tileID?De.tileID:new o.aG(Ke,De.wrap,De.zoom,Je,We);t.calculateQuadrantVisibility&&(Tt.visibleQuadrants=rt),qe.push({tileID:Tt,distanceSq:ct*ct+_t*_t})}}if(this.fogCullDistSq){const De=this.fogCullDistSq,Je=this.horizonLineFromTop();qe=qe.filter(We=>{const ut=[0,0,0,1],et=[o.ag,o.ag,0,1],Ke=this.calculateFogTileMatrix(We.tileID.toUnwrapped());o.ab.vec4.transformMat4(ut,ut,Ke),o.ab.vec4.transformMat4(et,et,Ke);const rt=o.ab.vec4.min([],ut,et),ct=o.ab.vec4.max([],ut,et),_t=o.bW(rt,ct);if(0===_t)return!0;let Tt=!1;const jt=this._elevation;if(jt&&_t>De&&0!==Je){const Lt=this.calculateProjMatrix(We.tileID.toUnwrapped());let kt;t.isTerrainDEM||(kt=jt.getMinMaxForTile(We.tileID)),kt||(kt={min:pe,max:ge});const Zt=o.c7(this.rotation),di=[Zt[0]*o.ag,Zt[1]*o.ag,kt.max];o.ab.vec3.transformMat4(di,di,Lt),Tt=(1-di[1])*this.height*.5<Je}return _t<De||Tt})}return qe.sort((De,Je)=>De.distanceSq-Je.distanceSq).map(De=>De.tileID)}resize(t,n){this.width=t,this.height=n,this.pixelsToGLUnits=[2/t,-2/n],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){const n=o.aw(t.lat,-o.bX,o.bX),c=this.projection.project(t.lng,n);return new o.P(c.x*this.worldSize,c.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/o.bH(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,n){let c,p;const y=this.centerPoint;if("globe"===this.projection.name){const E=this.worldSize;c=(n.x-y.x)/E,p=(n.y-y.y)/E}else{const E=this.pointCoordinate(n),D=this.pointCoordinate(y);c=E.x-D.x,p=E.y-D.y}const b=this.locationCoordinate(t);this.setLocation(new o.aa(b.x-c,b.y-p))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t){return this.projection.locationPoint(this,t)}locationPoint3D(t){return this.projection.locationPoint(this,t,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t){return this.coordinateLocation(this.pointCoordinate3D(t))}locationCoordinate(t,n){const c=n?o.bH(n,t.lat):void 0,p=this.projection.project(t.lng,t.lat);return new o.aa(p.x,p.y,c)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,n){const c=n??this._centerAltitude,p=[t.x,t.y,0,1],y=[t.x,t.y,1,1];o.ab.vec4.transformMat4(p,p,this.pixelMatrixInverse),o.ab.vec4.transformMat4(y,y,this.pixelMatrixInverse);const b=y[3];o.ab.vec4.scale(p,p,1/p[3]),o.ab.vec4.scale(y,y,1/b);const E=p[2],D=y[2];return{p0:p,p1:y,t:E===D?0:(c-E)/(D-E)}}screenPointToMercatorRay(t){const n=[t.x,t.y,0,1],c=[t.x,t.y,1,1];return o.ab.vec4.transformMat4(n,n,this.pixelMatrixInverse),o.ab.vec4.transformMat4(c,c,this.pixelMatrixInverse),o.ab.vec4.scale(n,n,1/n[3]),o.ab.vec4.scale(c,c,1/c[3]),n[2]=o.bH(n[2],this._center.lat)*this.worldSize,c[2]=o.bH(c[2],this._center.lat)*this.worldSize,o.ab.vec4.scale(n,n,1/this.worldSize),o.ab.vec4.scale(c,c,1/this.worldSize),new o.aq([n[0],n[1],n[2]],o.ab.vec3.normalize([],o.ab.vec3.sub([],c,n)))}rayIntersectionCoordinate(t){const{p0:n,p1:c,t:p}=t,y=o.bH(n[2],this._center.lat),b=o.bH(c[2],this._center.lat);return new o.aa(o.af(n[0],c[0],p)/this.worldSize,o.af(n[1],c[1],p)/this.worldSize,o.af(y,b,p))}pointCoordinate(t,n=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,n)}pointCoordinate3D(t){if(!this.elevation)return this.pointCoordinate(t);let n=this.projection.pointCoordinate3D(this,t.x,t.y);if(n)return new o.aa(n[0],n[1],n[2]);let c=0,p=this.horizonLineFromTop();if(t.y>p)return this.pointCoordinate(t);const y=.02*p,b=t.clone();for(let E=0;E<10&&p-c>y;E++){b.y=o.af(c,p,.66);const D=this.projection.pointCoordinate3D(this,b.x,b.y);D?(p=b.y,n=D):c=b.y}return n?new o.aa(n[0],n[1],n[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=o.bY)return!this.isPointAboveHorizon(t);const n=this.pointCoordinate(t);return n.y>=0&&n.y<=1}_coordinatePoint(t,n){const c=n&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,p=[t.x*this.worldSize,t.y*this.worldSize,c+t.toAltitude(),1];return o.ab.vec4.transformMat4(p,p,this.pixelMatrix),p[3]>0?new o.P(p[0]/p[3],p[1]/p[3]):new o.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:n}=this._edgeInsets,c=this.height-this._edgeInsets.bottom,p=this.width-this._edgeInsets.right,y=this.pointLocation3D(new o.P(n,t)),b=this.pointLocation3D(new o.P(p,t)),E=this.pointLocation3D(new o.P(p,c)),D=this.pointLocation3D(new o.P(n,c));let L=Math.min(y.lng,b.lng,E.lng,D.lng),k=Math.max(y.lng,b.lng,E.lng,D.lng),N=Math.min(y.lat,b.lat,E.lat,D.lat),V=Math.max(y.lat,b.lat,E.lat,D.lat);const j=Math.pow(2,-this.zoom)/16*270,Y="globe"===this.projection.name?1:4,Z=(Q,J,re,he,ce)=>{const ge=(Q+re)/2,pe=(J+he)/2,_e=new o.P(ge,pe),{lng:de,lat:be}=this.pointLocation3D(_e),Ee=Math.max(0,L-de,N-be,de-k,be-V);L=Math.min(L,de),k=Math.max(k,de),N=Math.min(N,be),V=Math.max(V,be),(ce<Y||Ee>j)&&(Z(Q,J,ge,pe,ce+1),Z(ge,pe,re,he,ce+1))};if(Z(n,t,p,t,1),Z(p,t,p,c,1),Z(p,c,n,c,1),Z(n,c,n,t,1),"globe"===this.projection.name){const[Q,J]=o.bZ(this);Q?(V=90,k=180,L=-180):J&&(N=-90,k=180,L=-180)}return new o.az(new o.bO(L,N),new o.bO(k,V))}_getBoundsRectangular(t,n){const{top:c,left:p}=this._edgeInsets,y=this.height-this._edgeInsets.bottom,b=this.width-this._edgeInsets.right,E=new o.P(p,c),D=new o.P(b,c),L=new o.P(b,y),k=new o.P(p,y);let N=this.pointCoordinate(E,t),V=this.pointCoordinate(D,t);const j=this.pointCoordinate(L,n),Y=this.pointCoordinate(k,n),Z=(Q,J)=>(J.y-Q.y)/(J.x-Q.x);return N.y>1&&V.y>=0?N=new o.aa((1-Y.y)/Z(Y,N)+Y.x,1):N.y<0&&V.y<=1&&(N=new o.aa(-Y.y/Z(Y,N)+Y.x,0)),V.y>1&&N.y>=0?V=new o.aa((1-j.y)/Z(j,V)+j.x,1):V.y<0&&N.y<=1&&(V=new o.aa(-j.y/Z(j,V)+j.x,0)),(new o.az).extend(this.coordinateLocation(N)).extend(this.coordinateLocation(V)).extend(this.coordinateLocation(Y)).extend(this.coordinateLocation(j))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const n=t.visibleDemTiles.reduce((c,p)=>{if(p.dem){const y=p.dem.tree;c.min=Math.min(c.min,y.minimums[0]),c.max=Math.max(c.max,y.maximums[0])}return c},{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(n.min*t.exaggeration(),n.max*t.exaggeration())}getBounds(){return"mercator"===this.projection.name||"equirectangular"===this.projection.name?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const n=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,c=this.height/2-n*(1-this._horizonShift);return t?Math.max(0,c):c}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-o.bX,this.maxLat=o.bX,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=o.at(this.minLng)*this.tileSize,this.worldMaxX=o.at(this.maxLng)*this.tileSize,this.worldMinY=o.aA(this.maxLat)*this.tileSize,this.worldMaxY=o.aA(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,n){return this.projection.createTileMatrix(this,n,t)}calculateDistanceTileData(t){const n=t.key,c=this._distanceTileDataCache;if(c[n])return c[n];const p=t.canonical,y=1/this.height,b=this.cameraWorldSize,E=b/this.zoomScale(p.z),D=(p.x+Math.pow(2,p.z)*t.wrap)*E,L=p.y*E,k=this.point;k.x*=b/this.worldSize,k.y*=b/this.worldSize;const N=this.angle,V=Math.sin(-N),j=-Math.cos(-N);return c[n]={bearing:[V,j],center:[(k.x-D)*y,(k.y-L)*y],scale:E/o.ag*y},c[n]}calculateFogTileMatrix(t){const n=t.key,c=this._fogTileMatrixCache;if(c[n])return c[n];const p=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return o.ab.mat4.multiply(p,this.worldToFogMatrix,p),c[n]=new Float32Array(p),c[n]}calculateProjMatrix(t,n=!1,c=!1){const p=t.key;let y;if(y=c?this._expandedProjMatrixCache:n?this._alignedProjMatrixCache:this._projMatrixCache,y[p])return y[p];const b=this.calculatePosMatrix(t,this.worldSize);let E;return E=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:c?this.expandedFarZProjMatrix:n?this.alignedProjMatrix:this.projMatrix,o.ab.mat4.multiply(b,E,b),y[p]=new Float32Array(b),y[p]}calculatePixelsToTileUnitsMatrix(t){const n=t.tileID.key,c=this._pixelsToTileUnitsCache;if(c[n])return c[n];const p=o.b_(t,this);return c[n]=p,c[n]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if("globe"===this.projection.name){const t=1/this.worldSize,n=o.ab.mat4.fromScaling([],[t,t,t]);return o.ab.mat4.multiply(n,n,this.globeMatrix),n}}recenterOnTerrain(){if(!this._elevation||"globe"===this.projection.name)return;const t=this._elevation;this._updateCameraState();const n=o.bH(1,this._center.lat)*this.worldSize,c=this._computeCameraPosition(n),p=this._camera.forward(),y=o.bH(1,this._center.lat);c[2]/=y,p[2]/=y,o.ab.vec3.normalize(p,p);const b=t.raycast(c,p,t.exaggeration());if(b){const E=o.ab.vec3.scaleAndAdd([],c,p,b),D=new o.aa(E[0],E[1],o.bH(E[2],o.aS(E[1]))),L=(D.z+o.ab.vec3.length([D.x-c[0],D.y-c[1],D.z-c[2]*y]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(L),this._centerAltitude=D.toAltitude(),this._center=this.coordinateLocation(D),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const n=this._elevation,c=o.bH(1,this._center.lat)*this.worldSize,p=this._computeCameraPosition(c),y=n.getAtPointOrZero(new o.aa(...p)),b=this.pixelsPerMeter/this.worldSize*y,E=this._minimumHeightOverTerrain(),D=p[2]-b;if(D<=E)if(D<0||t){const L=this.locationCoordinate(this._center,this._centerAltitude),k=[p[0],p[1],L.z-p[2]],N=o.ab.vec3.length(k);k[2]-=(E-D)/this._pixelsPerMercatorPixel;const V=o.ab.vec3.length(k);if(0===V)return;o.ab.vec3.scale(k,k,N/V*this._pixelsPerMercatorPixel),this._camera.position=[p[0],p[1],L.z*this._pixelsPerMercatorPixel-k[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t="globe"===this.projection.name||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const V=this.center;return V.lat=o.aw(V.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(V.lng=o.aw(V.lng,this.minLng,this.maxLng)),this.center=V,void(this._constraining=!1)}const n=this._unmodified,{x:c,y:p}=this.point;let y=0,b=c,E=p;const D=this.width/2,L=this.height/2,k=this.worldMinY*this.scale,N=this.worldMaxY*this.scale;if(p-L<k&&(E=k+L),p+L>N&&(E=N-L),N-k<this.height&&(y=Math.max(y,this.height/(N-k)),E=(N+k)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const V=this.worldMinX*this.scale,j=this.worldMaxX*this.scale,Y=this.worldSize/2-(V+j)/2;b=(c+Y+this.worldSize)%this.worldSize-Y,b-D<V&&(b=V+D),b+D>j&&(b=j-D),j-V<this.width&&(y=Math.max(y,this.width/(j-V)),b=(j+V)/2)}b===c&&E===p||(this.center=this.unproject(new o.P(b,E))),y&&(this.zoom+=this.scaleZoom(y)),this._constrainCamera(),this._unmodified=n,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,n="globe"===this.projection.name,c=this.pixelsPerMeter;"globe"===this.projection.name&&(this._mercatorScaleRatio=o.bH(1,this.center.lat)/o.bH(1,o.c8));const p=o.b$(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,p),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const y="meters"===this.projection.zAxisUnit?c:1,b=this._camera.getWorldToCamera(this.worldSize,y);let E;const D=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(D[8]=2*-t.x/this.width,D[9]=2*t.y/this.height,this.isOrthographic){let be=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),Ee=be*this.aspect,qe=-Ee,Le=-be;Ee-=t.x,qe-=t.x,be+=t.y,Le+=t.y,E=this._camera.getCameraToClipOrthographic(qe,Ee,Le,be,this._nearZ,this._farZ),((Ye,Xe,Re,He)=>{for(let it=0;it<16;it++)Ye[it]=Ch(Xe[it],Re[it],He)})(E,E,D,Tc(this.pitch>=15?1:this.pitch/15))}else E=D;const L=o.ab.mat4.mul([],D,b);let k=o.ab.mat4.mul([],E,b);if(this.projection.isReprojectedInTileSpace){const be=this.locationCoordinate(this.center),Ee=o.ab.mat4.identity([]);o.ab.mat4.translate(Ee,Ee,[be.x*this.worldSize,be.y*this.worldSize,0]),o.ab.mat4.multiply(Ee,Ee,o.c0(this)),o.ab.mat4.translate(Ee,Ee,[-be.x*this.worldSize,-be.y*this.worldSize,0]),o.ab.mat4.multiply(k,k,Ee),o.ab.mat4.multiply(L,L,Ee),this.inverseAdjustmentMatrix=o.c1(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=o.ab.mat4.scale([],k,[this.worldSize,this.worldSize,this.worldSize/y,1]),this.projMatrix=k,this.invProjMatrix=o.ab.mat4.invert(new Float64Array(16),this.projMatrix),n){const be=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);be[8]=2*-t.x/this.width,be[9]=2*t.y/this.height,this.expandedFarZProjMatrix=o.ab.mat4.mul([],be,b)}else this.expandedFarZProjMatrix=this.projMatrix;const N=o.ab.mat4.invert([],E);this.frustumCorners=o.c2.fromInvProjectionMatrix(N,this.horizonLineFromTop(),this.height),this.cameraFrustum=o.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!n);const V=new Float32Array(16);o.ab.mat4.identity(V),o.ab.mat4.scale(V,V,[1,-1,1]),o.ab.mat4.rotateX(V,V,this._pitch),o.ab.mat4.rotateZ(V,V,this.angle);const j=o.ab.mat4.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=o.ab.mat4.clone(j);const Y=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;j[8]=2*-t.x/this.width,j[9]=2*(t.y+Y)/this.height,this.skyboxMatrix=o.ab.mat4.multiply(V,j,V);const Z=this.point,Q=Z.x,J=Z.y,re=this.width%2/2,he=this.height%2/2,ce=Math.cos(this.angle),ge=Math.sin(this.angle),pe=Q-Math.round(Q)+ce*re+ge*he,_e=J-Math.round(J)+ce*he+ge*re,de=new Float64Array(k);if(o.ab.mat4.translate(de,de,[pe>.5?pe-1:pe,_e>.5?_e-1:_e,0]),this.alignedProjMatrix=de,k=o.ab.mat4.create(),o.ab.mat4.scale(k,k,[this.width/2,-this.height/2,1]),o.ab.mat4.translate(k,k,[1,-1,0]),this.labelPlaneMatrix=k,k=o.ab.mat4.create(),o.ab.mat4.scale(k,k,[1,-1,1]),o.ab.mat4.translate(k,k,[-1,-1,0]),o.ab.mat4.scale(k,k,[2/this.width,2/this.height,1]),this.glCoordMatrix=k,this.pixelMatrix=o.ab.mat4.multiply(new Float64Array(16),this.labelPlaneMatrix,L),this._calcFogMatrices(),this._distanceTileDataCache={},k=o.ab.mat4.invert(new Float64Array(16),this.pixelMatrix),!k)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=k,"globe"===this.projection.name||this.mercatorFromTransition){this.globeMatrix=o.c3(this);const be=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=o.ab.vec3.transformMat4(be,be,b),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=k;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,n=this.cameraPixelsPerMeter,c=this._camera.position,p=1/this.height/this._pixelsPerMercatorPixel,y=[t,t,n];o.ab.vec3.scale(y,y,p),o.ab.vec3.scale(c,c,-1),o.ab.vec3.multiply(c,c,y);const b=o.ab.mat4.create();o.ab.mat4.translate(b,b,c),o.ab.mat4.scale(b,b,y),this.mercatorFogMatrix=b,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,n,p)}_computeCameraPosition(t){const n=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,c=this._camera.forward(),p=this.point,y=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*n-t/this.worldSize*this._centerAltitude;return[p.x/this.worldSize-c[0]*y,p.y/this.worldSize-c[1]*y,t/this.worldSize*this._centerAltitude-c[2]*y]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const n=this._maxCameraBoundsDistance()*Math.cos(this._pitch),c=this._camera.position[2],p=t[2];let y=1;this.projection.wrap&&(this.center=this.center.wrap()),p>0&&(y=Math.min((n-c)/p,1)),this._camera.position=o.ab.vec3.scaleAndAdd([],this._camera.position,t,y),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,n=this._camera.forward(),{pitch:c,bearing:p}=this._camera.getPitchBearing(),y=o.bH(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,b=this._mercatorZfromZoom(this._maxZoom)*Math.cos(o.ai(this._maxPitch)),E=Math.max((t[2]-y)/Math.cos(c),b),D=this._zoomFromMercatorZ(E);o.ab.vec3.scaleAndAdd(t,t,n,E),this._pitch=o.aw(c,o.ai(this.minPitch),o.ai(this.maxPitch)),this.angle=o.bF(p,-Math.PI,Math.PI),this._setZoom(o.aw(D,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new o.aa(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min(null!=this._seaLevelZoom?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(t*this.tileSize))}zoomFromMercatorZAdjusted(t){let n=0,c=o.bY,p=0,y=1/0;for(;c-n>1e-6&&c>n;){const b=n+.5*(c-n),E=this.tileSize*Math.pow(2,b),D=this.getCameraToCenterDistance(this.projection,b,E),L=this.scaleZoom(D/(t*this.tileSize)),k=Math.abs(b-L);k<y&&(y=k,p=b),b<L?n=b:c=b}return p}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(o.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,n){const c=Math.min(t.x,n.x),p=Math.max(t.x,n.x),y=Math.min(t.y,n.y),b=Math.max(t.y,n.y);if(y<this.horizonLineFromTop(!1))return!0;if("mercator"!==this.projection.name)return!1;const E=[new o.P(c,y),new o.P(p,b),new o.P(c,b),new o.P(p,y)],D=this.renderWorldCopies?-3:0,L=this.renderWorldCopies?4:1;for(const k of E){const N=this.pointRayIntersection(k);if(N.t<0)return!0;const V=this.rayIntersectionCoordinate(N);if(V.x<D||V.y<0||V.x>L||V.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+o.c4(this.fovAboveCenter)>88||this.anyCornerOffEdge(new o.P(0,0),new o.P(this.width,this.height))}zoomDeltaToMovement(t,n){const c=o.ab.vec3.length(o.ab.vec3.sub([],this._camera.position,t)),p=this._zoomFromMercatorZ(c)+n;return c-this._mercatorZfromZoom(p)}getCameraPoint(){if("globe"===this.projection.name){const t=function([n,c,p],y){const b=[n,c,p,1];o.ab.vec4.transformMat4(b,b,y);const E=b[3]=Math.max(b[3],1e-6);return b[0]/=E,b[1]/=E,b[2]/=E,b}([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new o.P(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new o.P(0,t))}}getCameraToCenterDistance(t,n=this.zoom,c=this.worldSize){const p=o.b$(t,n,this.width,this.height,1024),y=t.pixelSpaceConversion(this.center.lat,c,p);let b=.5/Math.tan(.5*this._fov)*this.height*y;return this.isOrthographic&&(b=Ch(1,b,Tc(this.pitch>=15?1:this.pitch/15))),b}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?this.pixelsPerMeter:1);return"globe"===this.projection.name&&o.ab.mat4.multiply(t,t,this.globeMatrix),t}getFrustum(t){return o.bR.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,"meters"===this.projection.zAxisUnit)}}const To=(l,t)=>{if(t>0&&l.terrain&&o.w("Cutoff is currently disabled on terrain"),t<=0||l.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const n=l.transform,c=Math.max(Math.abs(n._zoom-(l.minCutoffZoom-1)),1),p=n.isLODDisabled(!1)?o.ac(60,45,n.pitch):o.ac(30,15,n.pitch),y=n._farZ-n._nearZ,b=t*n.height,E=((1-(D=p))*n.cameraToCenterDistance+D*(n._farZ+b))*c;var D;return{shouldRenderCutoff:p<1,uniformValues:{u_cutoff_params:[n._nearZ,n._farZ,(E-n._nearZ)/y,(E-b-n._nearZ)/y]}}},Qn={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class Ir{constructor(t,n){this.aabb=t,this.lastCascade=n}}class Ph{add(t,n){const c=this.receivers[t.key];void 0!==c?(c.aabb.min[0]=Math.min(c.aabb.min[0],n.min[0]),c.aabb.min[1]=Math.min(c.aabb.min[1],n.min[1]),c.aabb.min[2]=Math.min(c.aabb.min[2],n.min[2]),c.aabb.max[0]=Math.max(c.aabb.max[0],n.max[0]),c.aabb.max[1]=Math.max(c.aabb.max[1],n.max[1]),c.aabb.max[2]=Math.max(c.aabb.max[2],n.max[2])):this.receivers[t.key]=new Ir(n,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,n,c){const p=o.cd.fromPoints(t.points);let y=0;for(const b in this.receivers){const E=this.receivers[b];if(!E||!p.intersectsAabb(E.aabb))continue;E.aabb.min=p.closestPoint(E.aabb.min),E.aabb.max=p.closestPoint(E.aabb.max);const D=E.aabb.getCorners();for(let L=0;L<c.length;L++){let k=!0;for(const N of D){const V=[N[0]*n,N[1]*n,N[2]];if(o.ab.vec3.transformMat4(V,V,c[L].matrix),V[0]<-1||V[0]>1||V[1]<-1||V[1]>1){k=!1;break}}if(E.lastCascade=L,y=Math.max(y,L),k)break}}return y+1}}class Rs{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new Ph,this._depthMode=new zt(t.context.gl.LEQUAL,zt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},()=>{this.painter.style.map.triggerRepaint()}),t.tp.registerParameter(Qn,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter(Qn,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter(Qn,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,n){const c=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!n||!n.properties)return;const p=n.properties.get("shadow-intensity");if(!n.shadowsEnabled()||p<=0||(this._shadowLayerCount=c.style.order.reduce((Y,Z)=>{const Q=c.style._mergedLayers[Z];return Y+(Q.hasShadowPass()&&!Q.isHidden(t.zoom)?1:0)},0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const y=c.context,b=Qn.shadowMapResolution,E=Qn.shadowMapResolution;if(0===this._cascades.length||Qn.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let Y=0;Y<Qn.cascadeCount;++Y){const Z=c._shadowMapDebug,Q=y.gl,J=y.createFramebuffer(b,E,Z,"texture"),re=new o.T(y,{width:b,height:E,data:null},Q.DEPTH_COMPONENT16);if(J.depthAttachment.set(re.texture),Z){const he=new o.T(y,{width:b,height:E,data:null},Q.RGBA8);J.colorAttachment.set(he.texture)}this._cascades.push({framebuffer:J,texture:re,matrix:[],far:0,boundingSphereRadius:0,frustum:new o.bR,scale:0})}}this.shadowDirection=So(n);let D=0;if(t.elevation){const Y=t.elevation,Z=[1e4,-1e4];Y.visibleDemTiles.filter(Q=>Q.dem).forEach(Q=>{const J=Q.dem.tree;Z[0]=Math.min(Z[0],J.minimums[0]),Z[1]=Math.max(Z[1],J.maximums[0])}),1e4!==Z[0]&&(D=(Z[1]-Z[0])*Y.exaggeration())}const L=1.5*t.cameraToCenterDistance,k=3*L,N=new Float64Array(16);for(let Y=0;Y<this._cascades.length;++Y){const Z=this._cascades[Y];let Q=t.height/50,J=1;1===Qn.cascadeCount?J=k:0===Y?J=L:(Q=L,J=k);const[re,he]=Bu(t,this.shadowDirection,Q,J,Qn.shadowMapResolution,D);Z.scale=t.scale,Z.matrix=re,Z.boundingSphereRadius=he,o.ab.mat4.invert(N,Z.matrix),Z.frustum=o.bR.fromInvProjectionMatrix(N,1,0,!0),Z.far=J}const V=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[V].far,this._cascades[V].far],this._uniformValues.u_shadow_intensity=p,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Qn.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Qn.shadowMapResolution,this._uniformValues.u_shadowmap_0=Un_ShadowMap0,this._uniformValues.u_shadowmap_1=Un_ShadowMap0+1,this._groundShadowTiles=c.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const j=c.transform.elevation;for(const Y of this._groundShadowTiles){let Z={min:0,max:0};if(j){const Q=j.getMinMaxForTile(Y);Q&&(Z=Q)}this.addShadowReceiver(Y.toUnwrapped(),Z.min,Z.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,n){if(!this.enabled)return;const c=this.painter,p=c.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(c.transform.getFrustum(0),c.transform.worldSize,this._cascades),p.viewport.set([0,0,Qn.shadowMapResolution,Qn.shadowMapResolution]);for(let y=0;y<this._numCascadesToRender;++y){c.currentShadowCascade=y,p.bindFramebuffer.set(this._cascades[y].framebuffer.framebuffer),p.clear({color:o.aj.white,depth:1});for(const b of t.order){const E=t._mergedLayers[b];if(!E.hasShadowPass()||E.isHidden(c.transform.zoom))continue;const D=t.getLayerSourceCache(E),L=D?n[D.id]:void 0;("model"===E.type||L&&L.length)&&c.renderLayer(c,D,E,L)}}c.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const t=this.painter,n=t.style,c=t.context,p=n.directionalLight,y=n.ambientLight;if(!p||!y)return;const b=[],E=To(t,t.longestCutoffRange);E.shouldRenderCutoff&&b.push("RENDER_CUTOFF"),b.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&b.push("NORMAL_OFFSET");const D=Dh(n,p,y),L=new zt(c.gl.LEQUAL,zt.ReadOnly,t.depthRangeFor3D);for(const k of this._groundShadowTiles){const N=k.toUnwrapped(),V=t.isTileAffectedByFog(k),j=t.getOrCreateProgram("groundShadow",{defines:b,overrideFog:V});this.setupShadows(N,j),t.uploadCommonUniforms(c,j,N,null,E);const Y={u_matrix:t.transform.calculateProjMatrix(N),u_ground_shadow_factor:D};j.draw(t,c.gl.TRIANGLES,L,qt.disabled,li.multiply,Wt.disabled,Y,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,{},t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?li.unblended:li.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const n=this.painter.transform,c=n.calculatePosMatrix(t,n.worldSize);return o.ab.mat4.multiply(c,this._cascades[this.painter.currentShadowCascade].matrix,c),Float32Array.from(c)}calculateShadowPassMatrixFromMatrix(t){return o.ab.mat4.multiply(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,n,c,p=0){if(!this.enabled)return;const y=this.painter.transform,b=this.painter.context,E=b.gl,D=this._uniformValues,L=new Float64Array(16),k=y.calculatePosMatrix(t,y.worldSize);for(let N=0;N<this._cascades.length;N++)o.ab.mat4.multiply(L,this._cascades[N].matrix,k),D[0===N?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(L),b.activeTexture.set(E.TEXTURE0+Un_ShadowMap0+N),this._cascades[N].texture.bind(E.NEAREST,E.CLAMP_TO_EDGE);if(this.useNormalOffset=!!c,this.useNormalOffset){const N=o.cc(t.canonical),V=2/y.tileSize*o.ag/Qn.shadowMapResolution,j=V*this._cascades[0].boundingSphereRadius,Y=V*this._cascades[this._cascades.length-1].boundingSphereRadius,Z=("vector-tile"===c?1:3)/Math.pow(2,p-t.canonical.z-(1-y.zoom+Math.floor(y.zoom)));D.u_shadow_normal_offset=[N,j*Z,Y*Z],D.u_shadow_bias=[6e-5,.0012,.012]}else D.u_shadow_bias=[36e-5,.0012,.012];n.setShadowUniformValues(b,D)}setupShadowsFromMatrix(t,n,c=!1){if(!this.enabled)return;const p=this.painter.context,y=p.gl,b=this._uniformValues,E=new Float64Array(16);for(let D=0;D<Qn.cascadeCount;D++)o.ab.mat4.multiply(E,this._cascades[D].matrix,t),b[0===D?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(E),p.activeTexture.set(y.TEXTURE0+Un_ShadowMap0+D),this._cascades[D].texture.bind(y.NEAREST,y.CLAMP_TO_EDGE);if(this.useNormalOffset=c,c){const D=Qn.normalOffset;b.u_shadow_normal_offset=[1,D,D],b.u_shadow_bias=[6e-5,.0012,.012]}else b.u_shadow_bias=[36e-5,.0012,.012];n.setShadowUniformValues(p,b)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,n,c,p){if(p[2]>=0)return{};const y=function(D,L,k){const N=k/(1<<D.canonical.z);return new o.cd([D.canonical.x*N+D.wrap*k,D.canonical.y*N+D.wrap*k,0],[(D.canonical.x+1)*N+D.wrap*k,(D.canonical.y+1)*N+D.wrap*k,L])}(t,n,c).getCorners(),b=n/-p[2];p[0]<0?(o.ab.vec3.add(y[0],y[0],[p[0]*b,0,0]),o.ab.vec3.add(y[3],y[3],[p[0]*b,0,0])):p[0]>0&&(o.ab.vec3.add(y[1],y[1],[p[0]*b,0,0]),o.ab.vec3.add(y[2],y[2],[p[0]*b,0,0])),p[1]<0?(o.ab.vec3.add(y[0],y[0],[0,p[1]*b,0]),o.ab.vec3.add(y[1],y[1],[0,p[1]*b,0])):p[1]>0&&(o.ab.vec3.add(y[2],y[2],[0,p[1]*b,0]),o.ab.vec3.add(y[3],y[3],[0,p[1]*b,0]));const E={};return E.vertices=y,E.planes=[na(y[1],y[0],y[4]),na(y[2],y[1],y[5]),na(y[3],y[2],y[6]),na(y[0],y[3],y[7])],E}addShadowReceiver(t,n,c){this._receivers.add(t,o.cd.fromTileIdAndHeight(t,n,c))}getMaxCascadeForTile(t){const n=this._receivers.get(t);return n&&n.lastCascade?n.lastCascade:0}}function na(l,t,n){const c=o.ab.vec3.sub([],n,t),p=o.ab.vec3.sub([],l,t),y=o.ab.vec3.cross([],c,p),b=o.ab.vec3.length(y);return 0===b?[0,0,1,0]:(o.ab.vec3.scale(y,y,1/b),[y[0],y[1],y[2],-o.ab.vec3.dot(y,t)])}function So(l){const t=l.properties.get("direction"),n=o.cb(t.x,t.y,t.z);n[2]=o.aw(n[2],0,75);const c=o.ce([n[0],n[1],n[2]]);return o.ab.vec3.fromValues(c.x,c.y,c.z)}function Dh(l,t,n){const c="none"===t.properties.get("color-use-theme"),p=t.properties.get("color"),y=t.properties.get("intensity"),b=t.properties.get("direction"),E=[b.x,b.y,b.z],D="none"===n.properties.get("color-use-theme"),L=n.properties.get("color"),k=n.properties.get("intensity"),N=Math.max(o.ab.vec3.dot([0,0,1],E),0),V=[0,0,0];o.ab.vec3.scale(V,L.toRenderColor(D?null:l.getLut(t.scope)).toArray01Linear().slice(0,3),k);const j=[0,0,0];return o.ab.vec3.scale(j,p.toRenderColor(c?null:l.getLut(n.scope)).toArray01Linear().slice(0,3),N*y),o.cf([V[0]>0?V[0]/(V[0]+j[0]):0,V[1]>0?V[1]/(V[1]+j[1]):0,V[2]>0?V[2]/(V[2]+j[2]):0])}function Bu(l,t,n,c,p,y){const b=l.zoom,E=l.scale,D=l.worldSize,L=1/D,k=l.aspect,N=Math.sqrt(1+k*k)*Math.tan(.5*l.fovX),V=N*N,j=c-n,Y=c+n;let Z,Q;V>j/Y?(Z=c,Q=c*N):(Z=.5*Y*(1+V),Q=.5*Math.sqrt(j*j+2*(c*c+n*n)*V+Y*Y*V*V));const J=l.projection.pixelsPerMeter(l.center.lat,D),re=l._camera.getCameraToWorldMercator(),he=[0,0,-Z*L];o.ab.vec3.transformMat4(he,he,re);let ce=Q*L;const ge=l._edgeInsets;if(!(0===ge.left&&0===ge.top&&0===ge.right&&0===ge.bottom||ge.left===ge.right&&ge.top===ge.bottom)){const ut=l._camera.getWorldToCamera(l.worldSize,"meters"===l.projection.zAxisUnit?J:1),et=l._camera.getCameraToClipPerspective(l._fov,l.width/l.height,n,c);et[8]=2*-l.centerOffset.x/l.width,et[9]=2*l.centerOffset.y/l.height;const Ke=new Float64Array(16);o.ab.mat4.mul(Ke,et,ut);const rt=new Float64Array(16);o.ab.mat4.invert(rt,Ke);const ct=o.bR.fromInvProjectionMatrix(rt,D,b,!0);for(const _t of ct.points){const Tt=((pe=_t)[0]/=E,pe[1]/=E,pe[2]=o.bH(pe[2],l._center.lat),pe);ce=Math.max(ce,o.ab.vec3.len(o.ab.vec3.subtract([],he,Tt)))}}var pe;ce*=p/(p-1);const _e=Math.acos(t[2]),de=Math.atan2(-t[0],-t[1]),be=new ur;be.position=he,be.setPitchBearing(_e,de);const Ee=be.getWorldToCamera(D,J),qe=ce*D,Le=Math.min(l._mercatorZfromZoom(17)*D*-2,-2*qe),Ye=be.getCameraToClipOrthographic(-qe,qe,-qe,qe,Le,(qe+y*J)/t[2]),Xe=new Float64Array(16);o.ab.mat4.multiply(Xe,Ye,Ee);const Re=o.ab.vec3.fromValues(Math.floor(1e6*he[0])/1e6*D,Math.floor(1e6*he[1])/1e6*D,0),He=.5*p,it=[0,0,0];o.ab.vec3.transformMat4(it,Re,Xe),o.ab.vec3.scale(it,it,He);const De=[Math.floor(it[0]),Math.floor(it[1]),Math.floor(it[2])],Je=[0,0,0];o.ab.vec3.sub(Je,it,De),o.ab.vec3.scale(Je,Je,-1/He);const We=new Float64Array(16);return o.ab.mat4.identity(We),o.ab.mat4.translate(We,We,Je),o.ab.mat4.multiply(Xe,We,Xe),[Xe,qe]}class to extends o.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.numModelsLoading={}}loadModel(t,n){return o.aM(this.requestManager.transformRequest(n,o.R.Model).url).then(c=>{if(!c)return;const p=o.aN(c),y=new o.aO(t,void 0,void 0,p);return y.computeBoundsAndApplyParent(),y}).catch(c=>{if(c&&404===c.status)return null;this.fire(new o.y(new Error(`Could not load model ${t} from ${n}: ${c.message}`)))})}load(t,n,c={keepNumReferences:!1}){this.models[n]||(this.models[n]={});const p=Object.keys(t);this.numModelsLoading[n]=(this.numModelsLoading[n]||0)+p.length;const y=[];for(const b of p)y.push(this.loadModel(b,t[b]));Promise.allSettled(y).then(b=>{for(let E=0;E<b.length;E++){const{status:D,value:L}=b[E];if("fulfilled"===D&&L){const k=this.models[n][p[E]];this.models[n][p[E]]={model:L,numReferences:c.keepNumReferences&&k?k.numReferences:1}}}this.numModelsLoading[n]-=p.length,this.fire(new o.z("data",{dataType:"style"}))}).catch(b=>{this.fire(new o.y(new Error(`Could not load models: ${b.message}`)))})}isLoaded(){for(const t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,n){return!!this.getModel(t,n)}getModel(t,n){return this.models[n]||(this.models[n]={}),this.models[n][t]?this.models[n][t].model:void 0}addModel(t,n,c){this.models[c]||(this.models[c]={}),this.modelUris[c]||(this.modelUris[c]={}),this.hasModel(t,c)&&this.models[c][t].numReferences++,this.modelUris[c][t]=this.requestManager.normalizeModelURL(n),this.load({[t]:this.modelUris[c][t]},c)}addModels(t,n){this.models[n]||(this.models[n]={}),this.modelUris[n]||(this.modelUris[n]={});const c=this.modelUris[n];for(const p in t)this.models[n][p]={},c[p]=this.requestManager.normalizeModelURL(t[p]);this.load(c,n,{keepNumReferences:!0})}reloadModels(t){this.load(this.modelUris[t],t)}addModelsFromBucket(t,n){this.models[n]||(this.models[n]={}),this.modelUris[n]||(this.modelUris[n]={});const c={};for(const p of t)this.hasModel(p,n)?this.models[n][p].numReferences++:(this.modelUris[n][p]=this.requestManager.normalizeModelURL(p),c[p]=this.modelUris[n][p]);this.load(c,n)}removeModel(t,n){if(this.models[n]&&this.models[n][t]&&(this.models[n][t].numReferences--,0===this.models[n][t].numReferences)){const c=this.models[n][t].model;delete this.models[n][t],delete this.modelUris[n][t],c.destroy()}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,n){this.models[n]||(this.models[n]={});for(const c in this.models[n])this.models[n][c].model&&this.models[n][c].model.upload(t.context)}}const zd=new o.a5({data:new o.a6(o.a3.colorTheme.data)}),Nu={"mbx-indoor-active-floorplans":{default:["literal",[]]},"mbx-indoor-underground":{default:["literal",!1]},"mbx-indoor-loaded-levels":{default:["literal",[]]},"mbx-indoor-level-height":{default:["literal",{}]},"mbx-indoor-level-base":{default:["literal",{}]},"mbx-indoor-level-selected":{default:["literal",{}]},"mbx-indoor-level-overlapped":{default:["literal",{}]}};function zh(l){return l=l||{},Object.assign(l,Nu)}class Rh extends o.E{constructor(t){super(),this.mergeFloors=!0,this._scope=void 0,this._queryFeatureSetId=void 0,this._buildingEntryFeatureSetId=void 0,this._selectedFloorplan=void 0,this._indoorData=void 0,this._selectedLevel=void 0,this._floorplanStates={},o.aP(["_onLoad","_onMove","_checkFloorplanVisible"],this),this._map=t,this._checkFloorplanVisible(!0),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=void 0}_onLoad(){this._map.style.forEachFragmentStyle(t=>{t.stylesheet.indoor&&(this._queryFeatureSetId?this.fire(new o.y(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._queryFeatureSetId=t.stylesheet.indoor.floorplanFeaturesetId,this._buildingEntryFeatureSetId=t.stylesheet.indoor.buildingFeaturesetId,this._scope=t.scope))}),this._queryFeatureSetId&&this._buildingEntryFeatureSetId&&this._map.addInteraction("mbx-indoor-buildingclick",{type:"click",target:{featuresetId:this._buildingEntryFeatureSetId,importId:this._scope},handler:t=>(t.feature&&t.feature.properties.floorplan&&this.selectFloorplan(t.feature.properties.floorplan),!0)}),this._checkFloorplanVisible(!0)}_onMove(){this._checkFloorplanVisible(!1)}_checkFloorplanVisible(t){if(!this._queryFeatureSetId||!this._map.isStyleLoaded()||this._map.transform.zoom<13)return;this._indoorData&&!function(b,E){const[D,L]=b,{center:k,radius:N}=E,[V,j]=k,Y=Math.abs(D-V);return Math.sqrt((Y>180?360-Y:Y)**2+(L-j)**2)<=N}([this._map.getCenter().lng,this._map.getCenter().lat],this._indoorData.circumCircle)&&(this._indoorData=void 0,this._selectedFloorplan=void 0,this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",["literal",[]]),this.fire(new o.z("floorplangone")));const n={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},c=new o.P(this._map.transform.width/2,this._map.transform.height/2),p=[new o.P(0,0),new o.P(this._map.transform.width,this._map.transform.height)],y=this._map.queryRenderedFeatures(t?p:c,n);y.length>0&&(this._selectedFloorplan&&y[0].properties.id===this._selectedFloorplan.properties.id||(this._selectedFloorplan=y[0],this._floorplanSelected(!1)))}_floorplanSelected(t){this._indoorData=JSON.parse(this._selectedFloorplan.properties["indoor-data"]),this._indoorData.id=this._selectedFloorplan.properties.id,this._indoorData.circumCircle=function(y){const[[b,E],[D,L]]=y,k=(D-b+360)%360,N=k>180?360-k:k;return{center:[(b+N/2+360)%360,(E+L)/2],radius:Math.sqrt(N**2+(L-E)**2)/2}}(this._indoorData.extent),this._floorplanStates[this._indoorData.id]||(this._floorplanStates[this._indoorData.id]={});const n=this._floorplanStates[this._indoorData.id].selectedBuilding,c=this._floorplanStates[this._indoorData.id].selectedLevel;let p;if(this._map.setConfigProperty(this._scope,"mbx-indoor-active-floorplans",this._indoorData.floorplanIDs),this._selectedLevel)for(const y of this._indoorData.levels)y.id===this._selectedLevel.id&&(p=y.id);if(this.fire(new o.z("floorplanselected",{buildings:this._indoorData.buildings,levels:this._indoorData.levels,selectedLevelId:p})),n){const y=this._indoorData.buildings.find(b=>b.id===n);this._buildingSelected(y,!1)}else this._indoorData.buildings.length>0&&this._buildingSelected(this._indoorData.buildings[0],!1);if(c){const y=this._indoorData.levels.find(b=>b.id===c);this._updateLevels(y,t)}else t&&this._indoorData["default-levels"].length>0&&this.selectLevel(this._indoorData["default-levels"][0])}_buildingSelected(t,n){n&&t&&t.extent&&this._map.fitBounds(t.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),this._floorplanStates[this._indoorData.id].selectedBuilding=t?t.id:void 0;const c=this._indoorData.levels.filter(p=>t.levels.includes(p.id));this.fire(new o.z("buildingselected",{buildingId:t.id,levels:c}))}_levelSelected(t){if("overview"===t)this._updateLevels(void 0,!0);else{const n=this._indoorData.levels.find(c=>c.id===t);this._updateLevels(n,!0)}this.fire(new o.z("levelselected",{levelId:"overview"===t?void 0:t}))}_updateLevels(t,n){if(!t)return this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",[]]),this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!1),this._floorplanStates[this._indoorData.id].selectedLevel=void 0,void(n&&this._indoorData.extent&&this._map.fitBounds(this._indoorData.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}));function c(L){const k=L.indexOf("/floor/");if(-1===k)return L;const N=k+7,V=L.indexOf("/",N);return-1===V?L.slice(N):L.slice(N,V)}this._selectedLevel=t,this._floorplanStates[this._indoorData.id].selectedLevel=t?t.id:void 0;const p=[],y={},b={},E={},D={};for(const L of this._indoorData.levels)if(p.push(L.id),y[L.id]=L.height,b[L.id]=L.base,t){if(this.mergeFloors){const k=c(t.id),N=c(L.id);E[L.id]=N===k?"true":"false"}else E[L.id]=L.id===t.id?"true":"false";D[L.id]=L.base<t.base?"true":"false"}else D[L.id]=!0;if(this._map.setConfigProperty(this._scope,"mbx-indoor-loaded-levels",["literal",p]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-height",["literal",y]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-base",["literal",b]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",E]),this._map.setConfigProperty(this._scope,"mbx-indoor-level-overlapped",["literal",D]),t&&(this._map.setConfigProperty(this._scope,"mbx-indoor-underground",!!t.isUnderground),n&&t.extent)){const L=this._map.cameraForBounds(t.extent,{pitch:this._map.getPitch(),bearing:this._map.getBearing()}),k=this._map.getZoom(),N=L.zoom?Math.abs(k-L.zoom):0;this._map.fitBounds(t.extent,N>=1?{pitch:this._map.getPitch(),bearing:this._map.getBearing()}:{pitch:this._map.getPitch(),bearing:this._map.getBearing(),zoom:k})}}selectFloorplan(t){const n={target:{featuresetId:this._queryFeatureSetId,importId:this._scope}},c=[new o.P(0,0),new o.P(this._map.transform.width,this._map.transform.height)],p=this._map.queryRenderedFeatures(c,n);if(p.length>0)for(const y of p)if(JSON.parse(y.properties["indoor-data"]).floorplanIDs.includes(t)){this._selectedFloorplan=y,this._floorplanSelected(!0);break}}selectBuilding(t){const n=this._indoorData.buildings.find(c=>c.id===t);this._buildingSelected(n,!0)}selectLevel(t){this._levelSelected(t)}}function Wa(l){if(!l.metadata||!l.metadata.content_area)return;const t=o.q.devicePixelRatio,{left:n,top:c,width:p,height:y}=l.metadata.content_area,b=n*t,E=c*t;return[b,E,b+p*t,E+y*t]}function Lh(l){if(l)return l.map(([t,n])=>[t*o.q.devicePixelRatio,n*o.q.devicePixelRatio])}const Mo=(l,t)=>qr(l,t&&t.filter(n=>"source.canvas"!==n.identifier)),Vu=o.ay(hi,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport"]),kh=o.ay(hi,["setCenter","setZoom","setBearing","setPitch"]),Oh=new Set(["background","sky","slot","custom"]),$a={version:8,layers:[],sources:{}},Fh={duration:300,delay:0};class os extends o.E{constructor(t,n={}){super(),this.map=t,this.scope=n.scope||"",this.globalId=null,this.fragments=[],this.importDepth=n.importDepth||0,this.importsCache=n.importsCache||new Map,this.resolvedImports=n.resolvedImports||new Set,this.transition=o.l({},Fh),this._buildingIndex=new vh(this),this.crossTileSymbolIndex=new Ah,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=n.styleChanges||new Ko,this.dispatcher=n.dispatcher?n.dispatcher:new o.D(o.ci(),this),n.imageManager?this.imageManager=n.imageManager:(this.imageManager=new Fn(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.createScope(this.scope),this.glyphManager=n.glyphManager?n.glyphManager:new o.cj(t._requestManager,n.localFontFamily?o.ck.all:n.localIdeographFontFamily?o.ck.ideographs:o.ck.none,n.localFontFamily||n.localIdeographFontFamily),n.modelManager?this.modelManager=n.modelManager:(this.modelManager=new to(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._order=[],this._markersNeedUpdate=!1,this.options=n.configOptions?n.configOptions:new Map,this._configDependentLayers=n.configDependentLayers?n.configDependentLayers:new Set,this._config=n.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:n.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=n.initialConfig,this.dispatcher.broadcast("setReferrer",o.cl());const c=this;this._rtlTextPluginCallback=os.registerForPluginStateChange(p=>{c.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:p.pluginStatus,pluginURL:p.pluginURL},(y,b)=>{if(o.cm(y),b&&b.every(E=>E))for(const E in c._sourceCaches){const D=c._sourceCaches[E],L=D.getSource().type;"vector"!==L&&"geojson"!==L||D.reload()}})}),this.on("data",p=>{if("source"!==p.dataType||"metadata"!==p.sourceDataType)return;const y=this.getOwnSource(p.sourceId);if(y&&y.vectorLayerIds)for(const b in this._layers){const E=this._layers[b];E.source===y.id&&this._validateLayer(E)}})}load(t){return t?("string"==typeof t?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if("string"==typeof t){if(o.f(t))return t;const n=o.cn(t);if(!n.startsWith("http"))try{return new URL(n,location.href).toString()}catch{return n}return n}return`json://${o.co(JSON.stringify(t))}`}_diffStyle(t,n,c){this.globalId=this._getGlobalId(t);const p=(y,b)=>{try{b(null,this.setState(y,c))}catch(E){b(E,!1)}};if("string"==typeof t){const y=this.map._requestManager.normalizeStyleURL(t),b=this.map._requestManager.transformRequest(y,o.R.Style);o.n(b,(E,D)=>{E?this.fire(new o.y(E)):D&&p(D,n)})}else"object"==typeof t&&p(t,n)}loadURL(t,n={}){this.fire(new o.z("dataloading",{dataType:"style"}));const c="boolean"==typeof n.validate?n.validate:!o.f(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,n.accessToken),this.resolvedImports.add(t);const p=this.importsCache.get(t);if(p)return this._load(p,c);const y=this.map._requestManager.transformRequest(t,o.R.Style);this._request=o.n(y,(b,E)=>{if(this._request=null,b)this.fire(new o.y(b));else if(E)return this.importsCache.set(t,E),this._load(E,c)})}loadJSON(t,n={}){this.fire(new o.z("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=o.q.frame(()=>{this._request=null,this._load(t,!1!==n.validate)})}loadEmpty(){this.fire(new o.z("dataloading",{dataType:"style"})),this._load($a,!1)}_loadImports(t,n,c){if(this.importDepth>=4)return o.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const p=[];for(const y of t){const b=this._createFragmentStyle(y),E=new Promise(k=>{b.once("style.import.load",k),b.once("error",k)}).then(()=>this.mergeAll());if(p.push(E),this.resolvedImports.has(y.url)){b.loadEmpty();continue}const D=y.data||this.importsCache.get(y.url);D?(b.loadJSON(D,{validate:n}),this._isInternalStyle(D)&&(b.globalId=null)):y.url?b.loadURL(y.url,{validate:n}):b.loadEmpty();const L={style:b,id:y.id,config:y.config};if(c){const k=this.fragments.findIndex(({id:N})=>N===c);this.fragments=this.fragments.slice(0,k).concat(L).concat(this.fragments.slice(k))}else this.fragments.push(L)}return Promise.allSettled(p)}getImportGlobalIds(t=this,n=new Set){for(const c of t.fragments)c.style.globalId&&n.add(c.style.globalId),this.getImportGlobalIds(c.style,n);return[...n.values()]}_createFragmentStyle(t){const n=this.scope?o.aC(t.id,this.scope):t.id;let c;const p=this._initialConfig&&this._initialConfig[n];(t.config||p)&&(c=o.l({},t.config,p));const y=new os(this.map,{scope:n,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:c,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers});return y.setEventedParent(this.map,{style:y}),y}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&!1!==t.fragment)}_load(t,n){const c=t.indoor?zh(t.schema):t.schema;if(this._isInternalStyle(t)){const b=o.l({},$a,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(b,n)}if(this.updateConfig(this._config,c),n&&Mo(this,Or(t)))return;this._loaded=!0,this.stylesheet=o.cp(t);const p=()=>{for(const L in t.sources)this.addSource(L,t.sources[L],{validate:!1,isInitialLoad:!0});t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),this.glyphManager.setURL(t.glyphs,this.scope);const b=xo(this.stylesheet.layers);if(this._order=b.map(L=>L.id),this.stylesheet.light&&o.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(1===this.stylesheet.lights.length&&"flat"===this.stylesheet.lights[0].type){const L=this.stylesheet.lights[0];this.light=new $(L.properties,L.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new $(this.stylesheet.light)),this._layers={};for(const L of b){const k=o.cu(L,this.scope,this._styleColorTheme.lut,this.options);0!==k.configDependencies.size&&this._configDependentLayers.add(k.fqid),k.setEventedParent(this,{layer:{id:k.id}}),this._layers[k.id]=k;const N=this.getOwnLayerSourceCache(k),V=!!this.directionalLight&&this.directionalLight.shadowsEnabled();N&&k.canCastShadows()&&V&&(N.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.modelManager.addModels(this.stylesheet.models,this.scope);const E=this.stylesheet.terrain;E&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(E,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new o.z("data",{dataType:"style"}));const D=this.isRootStyle();t.imports?this._loadImports(t.imports,n).then(()=>{this._reloadImports(),this.fire(new o.z(D?"style.load":"style.import.load"))}):(this._reloadImports(),this.fire(new o.z(D?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const y=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(y){const b=this._evaluateColorThemeData(y);this._loadColorTheme(b).then(()=>{p()}).catch(E=>{o.w(`Couldn't load color theme from the stylesheet: ${E}`),p()})}else this._styleColorTheme.lut=null,p()}isRootStyle(){return 0===this.importDepth}mergeAll(){let t,n,c,p,y,b,E,D,L,k;const N={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(V=>{if(V.stylesheet){if(null!=V.light&&(t=V.light),V.stylesheet.lights)for(const j of V.stylesheet.lights)"ambient"===j.type&&null!=V.ambientLight&&(n=V.ambientLight),"directional"===j.type&&null!=V.directionalLight&&(c=V.directionalLight);p=this._prioritizeTerrain(p,V.terrain,V.stylesheet.terrain),V.stylesheet.fog&&null!=V.fog&&(y=V.fog),V.stylesheet.snow&&null!=V.snow&&(b=V.snow),V.stylesheet.rain&&null!=V.rain&&(E=V.rain),null!=V.stylesheet.camera&&(k=V.stylesheet.camera),null!=V.stylesheet.projection&&(D=V.stylesheet.projection),null!=V.stylesheet.transition&&(L=V.stylesheet.transition),N[V.scope]=V._styleColorTheme}}),this.light=t,this.ambientLight=n,this.directionalLight=c,this.fog=y,this.snow=b,this.rain=E,this._styleColorThemeForScope=N,null===p?delete this.terrain:this.terrain=p,this.camera=k||{"camera-projection":"perspective"},this.projection=D||{name:"mercator"},this.transition=o.l({},Fh,L),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){const n=c=>{for(const p of c.fragments)n(p.style);t(c)};n(this)}_prioritizeTerrain(t,n,c){const p=t&&0===t.drapeRenderMode;return null===c?n&&0===n.drapeRenderMode?n:p?t:null:null!=n&&(!t||p||n&&1===n.drapeRenderMode)?n:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle(n=>{t=this._prioritizeTerrain(t,n.terrain,n.stylesheet.terrain)}),null===t?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle(n=>{null!=n.stylesheet.projection&&(t=n.stylesheet.projection)}),this.projection=t||{name:"mercator"}}mergeSources(){const t={},n={},c={};this.forEachFragmentStyle(p=>{for(const y in p._sourceCaches){const b=o.aC(y,p.scope);t[b]=p._sourceCaches[y]}for(const y in p._otherSourceCaches){const b=o.aC(y,p.scope);n[b]=p._otherSourceCaches[y]}for(const y in p._symbolSourceCaches){const b=o.aC(y,p.scope);c[b]=p._symbolSourceCaches[y]}}),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=n,this._mergedSymbolSourceCaches=c}mergeLayers(){const t={},n=[],c={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle(y=>{for(const b of y._order){const E=y._layers[b];if("slot"===E.type){const D=o.cq(b);if(t[D])continue;t[D]=[]}E.slot&&t[E.slot]?t[E.slot].push(E):n.push(E)}}),this._mergedOrder=[];const p=(y=[])=>{for(const b of y)if("slot"===b.type){const E=o.cq(b.id);t[E]&&p(t[E]),this._mergedSlots.push(E)}else{const E=o.aC(b.id,b.scope);this._mergedOrder.push(E),c[E]=b,b.is3D()&&(this._has3DLayers=!0),"circle"===b.type&&(this._hasCircleLayers=!0),"symbol"===b.type&&(this._hasSymbolLayers=!0),"clip"===b.type&&(this._clipLayerPresent=!0)}};p(n),this._mergedOrder.sort((y,b)=>{const E=c[y],D=c[b];return E.hasInitialOcclusionOpacityProperties?D.is3D()?1:0:E.is3D()&&D.hasInitialOcclusionOpacityProperties?-1:0}),this._mergedLayers=c,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&0===this.terrain.drapeRenderMode}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=o.l({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?function(n,c,p){const y=o.l({},c);for(const E of Object.keys(o.a3.colorTheme))void 0===y[E]&&(y[E]=o.a3.colorTheme[E].default);const b=new o.a4(zd,n,new Map(p));return b.setTransitionOrValue(y,p),b.untransitioned().possiblyEvaluate(new o.a8(0))}(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const n=this._styleColorTheme.lutLoadingCorrelationID;return new Promise((c,p)=>{const y="data:image/png;base64,";if(!t||0===t.length)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void c();let b=t;b.startsWith(y)||(b=y+b);const E="mapbox-reserved-lut",D=new Image;D.src=b,D.onerror=()=>{this._styleColorTheme.lutLoading=!1,p(new Error("Failed to load image data"))},D.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==n)return void c();this._styleColorTheme.lutLoading=!1;const{width:L,height:k,data:N}=o.q.getImageData(D);if(k>32)return void p(new Error("The height of the image must be less than or equal to 32 pixels."));if(L!==k*k)return void p(new Error("The width of the image must be equal to the height squared."));this.getImage(E)&&this.removeImage(E),this.addImage(E,{data:new o.r({width:L,height:k},N),pixelRatio:1,sdf:!1,usvg:!1,version:0});const V=this.imageManager.getImage(E,this.scope);V?(this._styleColorTheme.lut={image:V.data,data:t},c()):p(new Error("Missing LUT image."))}})}getLut(t){const n=this._styleColorThemeForScope[t];return n?n.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=function(n,c,p){let y,b,E;const D=o.q.devicePixelRatio>1?"@2x":"";let L=o.n(c.transformRequest(c.normalizeSpriteURL(n,D,".json"),o.R.SpriteJSON),(V,j)=>{L=null,E||(E=V,y=j,N())}),k=o.o(c.transformRequest(c.normalizeSpriteURL(n,D,".png"),o.R.SpriteImage),(V,j)=>{k=null,E||(E=V,b=j,N())});function N(){if(E)p(E);else if(y&&b){const V=o.q.getImageData(b),j={};for(const Y in y){const{width:Z,height:Q,x:J,y:re,sdf:he,pixelRatio:ce,stretchX:ge,stretchY:pe,content:_e}=y[Y],de=new o.r({width:Z,height:Q});o.r.copy(V,de,{x:J,y:re},{x:0,y:0},{width:Z,height:Q},null),j[Y]={data:de,pixelRatio:ce,sdf:he,stretchX:ge,stretchY:pe,content:_e,usvg:!1}}p(null,j)}}return{cancel(){L&&(L.cancel(),L=null),k&&(k.cancel(),k=null)}}}(t,this.map._requestManager,(n,c)=>{if(this._spriteRequest=null,n)this.fire(new o.y(n));else if(c)for(const p in c)this.imageManager.addImage(p,this.scope,c[p]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new o.z("data",{dataType:"style"}))})}_loadIconset(t){if(!o.f(t)&&"icon_set"!==this.map._spriteFormat||"raster"===this.map._spriteFormat)return void this._loadSprite(t);const n="auto"===this.map._spriteFormat;var c,p;this._spriteRequest=(p=(y,b)=>{if(this._spriteRequest=null,y)n?this._loadSprite(t):this.fire(new o.y(y));else if(b)for(const E in b)this.imageManager.addImage(E,this.scope,b[E]);this.imageManager.setLoaded(!0,this.scope),this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new o.z("data",{dataType:"style"}))},o.bi((c=this.map._requestManager).transformRequest(c.normalizeIconsetURL(t),o.R.Iconset),(y,b)=>{if(y)return void p(y);const E={},D=o.cg(new o.bh(b));for(const L of D.icons){const k={version:1,pixelRatio:o.q.devicePixelRatio,content:Wa(L),stretchX:L.metadata?Lh(L.metadata.stretch_x_areas):void 0,stretchY:L.metadata?Lh(L.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:L};E[L.name]=k}p(null,E)}))}_validateLayer(t){const n=this.getOwnSource(t.source);if(!n)return;const c=t.sourceLayer;c&&("geojson"===n.type||n.vectorLayerIds&&-1===n.vectorLayerIds.indexOf(c))&&this.fire(new o.y(new Error(`Source layer "${c}" does not exist on source "${n.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map((t,n)=>{const c=this.fragments[n];return c&&c.style&&(t.data=c.style.serialize()),t})}_serializeSources(){const t={};for(const n in this._sourceCaches){const c=this._sourceCaches[n].getSource();t[c.id]||(t[c.id]=c.serialize())}return t}_serializeLayers(t){const n=[];for(const c of t){const p=this._layers[c];p&&"custom"!==p.type&&n.push(p.serialize())}return n}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const n=this.getOwnLayer(t);if(n)return n;this.fire(new o.y(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){const n=this.getOwnSource(t);if(n)return n;this.fire(new o.y(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,n){const c=this.map.painter;if(c)for(let p=t.minzoom||0;p<(t.maxzoom||25.5);p++){const y=t.getProgramIds();if(y)for(const b of y){const E=t.getDefaultProgramParams(b,n.zoom,this._styleColorTheme.lut);E&&(c.style=this,this.fog&&(c._fogVisible=!0,E.overrideFog=!0,c.getOrCreateProgram(b,E)),c._fogVisible=!1,E.overrideFog=!1,c.getOrCreateProgram(b,E),(this.stylesheet.terrain||this.stylesheet.projection&&"globe"===this.stylesheet.projection.name)&&(E.overrideRtt=!0,c.getOrCreateProgram(b,E)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const n=this.calculateLightsBrightness();t.brightness=n||0,n!==this._brightness&&(this._brightness=n,this.dispatcher.broadcast("setBrightness",n));const c=this._changes.isDirty();let p=!1;if(this._changes.isDirty()){const b=this._changes.getLayerUpdatesByScope();for(const E in b){const{updatedIds:D,removedIds:L}=b[E];(D||L)&&(this._updateWorkerLayers(E,D,L),p=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}const y={};for(const b in this._mergedSourceCaches){const E=this._mergedSourceCaches[b];y[b]=E.used,E.used=!1,E.tileCoverLift=0}for(const b of this._mergedOrder){const E=this._mergedLayers[b];if(E.recalculate(t,this._availableImages),!E.isHidden(t.zoom)){const D=this.getLayerSourceCache(E);D&&(D.used=!0,D.tileCoverLift=Math.max(D.tileCoverLift,E.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback(()=>{this.precompilePrograms(E,t)}):this.precompilePrograms(E,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&p&&this.mergeLayers();for(const b in y){const E=this._mergedSourceCaches[b];y[b]!==E.used&&E.getSource().fire(new o.z("data",{sourceDataType:"visibility",dataType:"source",sourceId:E.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),c&&this.fire(new o.z("data",{dataType:"style"}))}_updateTilesForChangedImages(){const t=this._changes.getUpdatedImages();if(t.length){for(const n in this._sourceCaches)this._sourceCaches[n].reloadTilesForDependencies(["icons","patterns"],t);this._changes.resetUpdatedImages()}}_updateWorkerLayers(t,n,c){const p=this.getFragmentStyle(t);p&&this.dispatcher.broadcast("updateLayers",{layers:n?p._serializeLayers(n):[],scope:t,removedIds:c||[],options:p.options})}setState(t,n){if(this._checkLoaded(),Mo(this,Or(t)))return!1;(t=o.cp(t)).layers=xo(t.layers);const c=function(b,E){if(!b)return[{command:hi.setStyle,args:[E]}];let D=[];try{if(!o.bn(b.version,E.version))return[{command:hi.setStyle,args:[E]}];if(o.bn(b.center,E.center)||D.push({command:hi.setCenter,args:[E.center]}),o.bn(b.zoom,E.zoom)||D.push({command:hi.setZoom,args:[E.zoom]}),o.bn(b.bearing,E.bearing)||D.push({command:hi.setBearing,args:[E.bearing]}),o.bn(b.pitch,E.pitch)||D.push({command:hi.setPitch,args:[E.pitch]}),o.bn(b.sprite,E.sprite)||D.push({command:hi.setSprite,args:[E.sprite]}),o.bn(b.glyphs,E.glyphs)||D.push({command:hi.setGlyphs,args:[E.glyphs]}),o.bn(b.imports,E.imports)||function(j=[],Y=[],Z){Y=Y||[];const Q=(j=j||[]).map(Vn),J=Y.map(Vn),re=j.reduce(_s,{}),he=Y.reduce(_s,{}),ce=Q.slice();let ge,pe,_e,de;for(ge=0,pe=0;ge<Q.length;ge++)_e=Q[ge],he.hasOwnProperty(_e)?pe++:(Z.push({command:hi.removeImport,args:[_e]}),ce.splice(ce.indexOf(_e,pe),1));for(ge=0,pe=0;ge<J.length;ge++)_e=J[J.length-1-ge],ce[ce.length-1-ge]!==_e&&(re.hasOwnProperty(_e)?(Z.push({command:hi.removeImport,args:[_e]}),ce.splice(ce.lastIndexOf(_e,ce.length-pe),1)):pe++,de=ce[ce.length-ge],Z.push({command:hi.addImport,args:[he[_e],de]}),ce.splice(ce.length-ge,0,_e));for(const be of Y){const Ee=re[be.id];Ee&&!o.bn(Ee,be)&&Z.push({command:hi.updateImport,args:[be.id,be]})}}(b.imports,E.imports,D),o.bn(b.transition,E.transition)||D.push({command:hi.setTransition,args:[E.transition]}),o.bn(b.light,E.light)||D.push({command:hi.setLight,args:[E.light]}),o.bn(b.fog,E.fog)||D.push({command:hi.setFog,args:[E.fog]}),o.bn(b.snow,E.snow)||D.push({command:hi.setSnow,args:[E.snow]}),o.bn(b.rain,E.rain)||D.push({command:hi.setRain,args:[E.rain]}),o.bn(b.projection,E.projection)||D.push({command:hi.setProjection,args:[E.projection]}),o.bn(b.lights,E.lights)||D.push({command:hi.setLights,args:[E.lights]}),o.bn(b.camera,E.camera)||D.push({command:hi.setCamera,args:[E.camera]}),!o.bn(b["color-theme"],E["color-theme"]))return[{command:hi.setStyle,args:[E]}];const L={},k=[];!function(j,Y,Z,Q){let J;for(J in Y=Y||{},j=j||{})j.hasOwnProperty(J)&&(Y.hasOwnProperty(J)||Cs(J,Z,Q));for(J in Y){if(!Y.hasOwnProperty(J))continue;const re=Y[J];j.hasOwnProperty(J)?o.bn(j[J],re)||("geojson"===j[J].type&&"geojson"===re.type&&Mi(j,Y,J)?Z.push({command:hi.setGeoJSONSourceData,args:[J,re.data]}):Mt(J,Y,Z,Q)):vc(J,Y,Z)}}(b.sources,E.sources,k,L);const N=[];b.layers&&b.layers.forEach(j=>{j.source&&L[j.source]?D.push({command:hi.removeLayer,args:[j.id]}):N.push(j)});let V=b.terrain;V&&L[V.source]&&(D.push({command:hi.setTerrain,args:[void 0]}),V=void 0),D=D.concat(k),o.bn(V,E.terrain)||D.push({command:hi.setTerrain,args:[E.terrain]}),function(j,Y,Z){Y=Y||[];const Q=(j=j||[]).map(Vn),J=Y.map(Vn),re=j.reduce(_s,{}),he=Y.reduce(_s,{}),ce=Q.slice(),ge=Object.create(null);let pe,_e,de,be,Ee,qe,Le;for(pe=0,_e=0;pe<Q.length;pe++)de=Q[pe],he.hasOwnProperty(de)?_e++:(Z.push({command:hi.removeLayer,args:[de]}),ce.splice(ce.indexOf(de,_e),1));for(pe=0,_e=0;pe<J.length;pe++)de=J[J.length-1-pe],ce[ce.length-1-pe]!==de&&(re.hasOwnProperty(de)?(Z.push({command:hi.removeLayer,args:[de]}),ce.splice(ce.lastIndexOf(de,ce.length-_e),1)):_e++,qe=ce[ce.length-pe],Z.push({command:hi.addLayer,args:[he[de],qe]}),ce.splice(ce.length-pe,0,de),ge[de]=!0);for(pe=0;pe<J.length;pe++)if(de=J[pe],be=re[de],Ee=he[de],!ge[de]&&!o.bn(be,Ee))if(o.bn(be.source,Ee.source)&&o.bn(be["source-layer"],Ee["source-layer"])&&o.bn(be.type,Ee.type)){for(Le in wi(be.layout,Ee.layout,Z,de,null,hi.setLayoutProperty),wi(be.paint,Ee.paint,Z,de,null,hi.setPaintProperty),o.bn(be.slot,Ee.slot)||Z.push({command:hi.setSlot,args:[de,Ee.slot]}),o.bn(be.filter,Ee.filter)||Z.push({command:hi.setFilter,args:[de,Ee.filter]}),o.bn(be.minzoom,Ee.minzoom)&&o.bn(be.maxzoom,Ee.maxzoom)||Z.push({command:hi.setLayerZoomRange,args:[de,Ee.minzoom,Ee.maxzoom]}),be)be.hasOwnProperty(Le)&&"layout"!==Le&&"paint"!==Le&&"filter"!==Le&&"metadata"!==Le&&"minzoom"!==Le&&"maxzoom"!==Le&&"slot"!==Le&&(0===Le.indexOf("paint.")?wi(be[Le],Ee[Le],Z,de,Le.slice(6),hi.setPaintProperty):o.bn(be[Le],Ee[Le])||Z.push({command:hi.setLayerProperty,args:[de,Le,Ee[Le]]}));for(Le in Ee)Ee.hasOwnProperty(Le)&&!be.hasOwnProperty(Le)&&"layout"!==Le&&"paint"!==Le&&"filter"!==Le&&"metadata"!==Le&&"minzoom"!==Le&&"maxzoom"!==Le&&"slot"!==Le&&(0===Le.indexOf("paint.")?wi(be[Le],Ee[Le],Z,de,Le.slice(6),hi.setPaintProperty):o.bn(be[Le],Ee[Le])||Z.push({command:hi.setLayerProperty,args:[de,Le,Ee[Le]]}))}else Z.push({command:hi.removeLayer,args:[de]}),qe=ce[ce.lastIndexOf(de)+1],Z.push({command:hi.addLayer,args:[Ee,qe]})}(N,E.layers,D)}catch(L){console.warn("Unable to compute style diff:",L),D=[{command:hi.setStyle,args:[E]}]}return D}(this.serialize(),t).filter(b=>!(b.command in kh));if(0===c.length)return!1;const p=c.filter(b=>!(b.command in Vu));if(p.length>0)throw new Error(`Unimplemented: ${p.map(b=>b.command).join(", ")}.`);const y=[];return c.forEach(b=>{y.push(this[b.command].apply(this,b.args))}),n&&Promise.all(y).then(n),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}addImage(t,n){return this.getImage(t)?this.fire(new o.y(new Error("An image with this name already exists."))):(this.imageManager.addImage(t,this.scope,n),this._afterImageUpdated(t),this)}updateImage(t,n,c=!1){this.imageManager.updateImage(t,this.scope,n),c&&this._afterImageUpdated(t)}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._afterImageUpdated(t),this):this.fire(new o.y(new Error("No image with this name exists.")))}_afterImageUpdated(t){this._availableImages=this.imageManager.listImages(this.scope),this._changes.updateImage(t),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages}),this.fire(new o.z("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModel(t,n,c={}){return this._checkLoaded(),this._validate(ln,`models.${t}`,n,null,c)||(this.modelManager.addModel(t,n,this.scope),this._changes.setDirty()),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope),this):this.fire(new o.y(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,n,c={}){if(this._checkLoaded(),void 0!==this.getOwnSource(t))throw new Error(`There is already a source with ID "${t}".`);if(!n.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(n).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(n.type)>=0&&this._validate(_o,`sources.${t}`,n,null,c))return;this.map&&this.map._collectResourceTiming&&(n.collectResourceTiming=!0);const p=ar(t,n,this.dispatcher,this);p.scope=this.scope,p.setEventedParent(this,()=>({isSourceLoaded:this._isSourceCacheLoaded(p.id),source:p.serialize(),sourceId:p.id}));const y=b=>{const E=(b?"symbol:":"other:")+p.id,D=o.aC(E,this.scope),L=this._sourceCaches[E]=new ss(D,p,b);(b?this._symbolSourceCaches:this._otherSourceCaches)[p.id]=L,L.onAdd(this.map)};y(!1),"vector"!==n.type&&"geojson"!==n.type||y(!0),p.onAdd&&p.onAdd(this.map),c.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const n=this.getOwnSource(t);if(!n)throw new Error("There is no source with this ID");for(const p in this._layers)if(this._layers[p].source===t)return this.fire(new o.y(new Error(`Source "${t}" cannot be removed while layer "${p}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new o.y(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));const c=this.getOwnSourceCaches(t);for(const p of c){const y=o.cq(p.id);delete this._sourceCaches[y],this._changes.discardSourceCacheUpdate(p.id),p.fire(new o.z("data",{sourceDataType:"metadata",dataType:"source",sourceId:p.getSource().id})),p.setEventedParent(null),p.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),n.setEventedParent(null),n.onRemove&&n.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,n){this._checkLoaded(),this.getOwnSource(t).setData(n),this._changes.setDirty()}getOwnSource(t){const n=this.getOwnSourceCache(t);return n&&n.getSource()}getOwnSources(){const t=[];for(const n in this._otherSourceCaches){const c=this.getOwnSourceCache(n);c&&t.push(c.getSource())}return t}areTilesLoaded(){const t=this._mergedSourceCaches;for(const n in t){const c=t[n]._tiles;for(const p in c){const y=c[p];if("loaded"!==y.state&&"errored"!==y.state)return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const n=this._getTransitionParameters();for(const p of t){if(this._validate(Na,"lights",p))return;switch(p.type){case"ambient":if(this.ambientLight){const y=this.ambientLight;y.set(p),y.updateTransitions(n)}else this.ambientLight=new Vt(p,ot||(ot=new o.a5({color:new o.a6(o.a3.properties_light_ambient.color),"color-use-theme":new o.a6({type:"string",default:"default","property-type":"data-constant"}),intensity:new o.a6(o.a3.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const y=this.directionalLight;y.set(p),y.updateTransitions(n)}else this.directionalLight=new Vt(p,dt||(dt=new o.a5({direction:new o.ak(o.a3.properties_light_directional.direction),color:new o.a6(o.a3.properties_light_directional.color),"color-use-theme":new o.a6({type:"string",default:"default","property-type":"data-constant"}),intensity:new o.a6(o.a3.properties_light_directional.intensity),"cast-shadows":new o.a6(o.a3.properties_light_directional["cast-shadows"]),"shadow-quality":new o.a6(o.a3.properties_light_directional["shadow-quality"]),"shadow-intensity":new o.a6(o.a3.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const c=new o.a8(this.z||0,n);this.ambientLight&&this.ambientLight.recalculate(c),this.directionalLight&&this.directionalLight.recalculate(c),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,n=this.ambientLight;if(!t||!n)return;const c=V=>.2126*(V[0]<=.03928?V[0]/12.92:Math.pow((V[0]+.055)/1.055,2.4))+.7152*(V[1]<=.03928?V[1]/12.92:Math.pow((V[1]+.055)/1.055,2.4))+.0722*(V[2]<=.03928?V[2]/12.92:Math.pow((V[2]+.055)/1.055,2.4)),p=t.properties.get("color").toRenderColor(null).toArray01(),y=t.properties.get("intensity"),b=t.properties.get("direction"),E=1-o.cb(b.x,b.y,b.z)[2]/90,D=c(p)*y*E,L=n.properties.get("color").toRenderColor(null).toArray01(),k=n.properties.get("intensity"),N=c(L)*k;return Number(((D+N)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(!t)return this;if(o.cr(t)){const n=o.cs(t),c=this.fragments.find(({id:y})=>y===n);if(!c)throw new Error(`Style import '${t}' not found`);const p=o.cq(t);return c.style.getFragmentStyle(p)}{const n=this.fragments.find(({id:c})=>c===t);return n?n.style:void 0}}setFeaturesetSelectors(t){if(!t)return;const n={},c=(p,y="")=>`${p}::${y}`;this._featuresetSelectors={};for(const p in t){const y=this._featuresetSelectors[p]=[];for(const b of t[p].selectors){if(b.featureNamespace){const D=this.getOwnLayer(b.layer);if(!D){o.w(`Layer is undefined for selector: ${b.layer}`);continue}const L=c(D.source,D.sourceLayer);if(L in n&&n[L]!==b.featureNamespace){o.w(`"featureNamespace ${b.featureNamespace} of featureset ${p}'s selector is not associated to the same source, skip this selector`);continue}n[L]=b.featureNamespace}let E;if(b.properties)for(const D in b.properties){const L=o.U(b.properties[D]);"success"===L.result&&(E=E||{},E[D]=L.value)}y.push({layerId:b.layer,namespace:b.featureNamespace,properties:E,uniqueFeatureID:b._uniqueFeatureID})}}}getFeaturesetDescriptors(t){const n=this.getFragmentStyle(t);if(!n||!n.stylesheet.featuresets)return[];const c=[];for(const p in n.stylesheet.featuresets)c.push({featuresetId:p,importId:n.scope?n.scope:void 0});return c}getFeaturesetLayers(t,n){const c=this.getFragmentStyle(n),p=c.stylesheet.featuresets;if(!p||!p[t])return this.fire(new o.y(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];const y=[];for(const b of p[t].selectors){const E=c.getOwnLayer(b.layer);E&&y.push(E)}return y}getConfigProperty(t,n){const c=this.getFragmentStyle(t);if(!c)return null;const p=o.aC(n,c.scope),y=c.options.get(p),b=y?y.value||y.default:null;return b?b.serialize():null}setConfigProperty(t,n,c){const p=this.getFragmentStyle(t);if(!p)return;const y=p.stylesheet.indoor?zh(p.stylesheet.schema):p.stylesheet.schema;if(!y||!y[n])return;const b=o.U(c);if("success"!==b.result)return void Mo(this,b.value);const E=b.value.expression,D=o.aC(n,p.scope),L=p.options.get(D);if(!L)return;let k;const{minValue:N,maxValue:V,stepValue:j,type:Y,values:Z}=y[n],Q=o.U(y[n].default);"success"===Q.result&&(k=Q.value.expression),k?(this.options.set(D,Object.assign({},L,{value:E,default:k,minValue:N,maxValue:V,stepValue:j,type:Y,values:Z})),this.updateConfigDependencies(n)):this.fire(new o.y(new Error(`No schema defined for the config option "${n}" in the "${t}" fragment.`)))}getConfig(t){const n=this.getFragmentStyle(t);if(!n)return null;const c=n.stylesheet.schema;if(!c)return null;const p={};for(const y in c){const b=o.aC(y,n.scope),E=n.options.get(b),D=E?E.value||E.default:null;p[y]=D?D.serialize():null}return p}setConfig(t,n){const c=this.getFragmentStyle(t);c&&(c.updateConfig(n,c.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){const n=this.getFragmentStyle(t);return n?n.stylesheet.schema:null}setSchema(t,n){const c=this.getFragmentStyle(t);c&&(c.stylesheet.schema=n,c.updateConfig(c._config,n),this.updateConfigDependencies())}updateConfig(t,n){if(this._config=t,t||n)if(n)for(const c in n){let p,y;const b=o.U(n[c].default);if("success"===b.result&&(p=b.value.expression),t&&void 0!==t[c]){const V=o.U(t[c]);"success"===V.result&&(y=V.value.expression)}const{minValue:E,maxValue:D,stepValue:L,type:k,values:N}=n[c];if(p){const V=o.aC(c,this.scope);this.options.set(V,{default:p,value:y,minValue:E,maxValue:D,stepValue:L,type:k,values:N})}else this.fire(new o.y(new Error(`No schema defined for config option "${c}".`)))}else this.fire(new o.y(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(t){for(const n of this._configDependentLayers){const c=this.getLayer(n);if(c){if(t&&!c.configDependencies.has(t))continue;c.possiblyEvaluateVisibility(),this._updateLayer(c)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle(n=>{const c=n._styleColorTheme.colorThemeOverride?n._styleColorTheme.colorThemeOverride:n._styleColorTheme.colorTheme;if(c){const p=n._evaluateColorThemeData(c);(!n._styleColorTheme.lut&&""!==p||n._styleColorTheme.lut&&p!==n._styleColorTheme.lut.data)&&n.setColorTheme(c)}}),this._changes.setDirty()}addLayer(t,n,c={}){this._checkLoaded();const p=t.id;if(this._layers[p])return void this.fire(new o.y(new Error(`Layer with id "${p}" already exists on this map`)));let y;if("custom"===t.type){if(Mo(this,o.ct(t)))return;y=o.cu(t,this.scope,this._styleColorTheme.lut,this.options)}else{if("object"==typeof t.source&&(this.addSource(p,t.source),t=o.cp(t),t=o.l(t,{source:p})),this._validate(fs,`layers.${p}`,t,{arrayIndex:-1},c))return;y=o.cu(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(y),y.setEventedParent(this,{layer:{id:p}})}0!==y.configDependencies.size&&this._configDependentLayers.add(y.fqid);let b=this._order.length;if(n){const k=this._order.indexOf(n);if(-1===k)return void this.fire(new o.y(new Error(`Layer with id "${n}" does not exist on this map.`)));y.slot===this._layers[n].slot?b=k:o.w(`Layer with id "${n}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(b,0,p),this._layerOrderChanged=!0,this._layers[p]=y;const E=this.getOwnLayerSourceCache(y),D=!!this.directionalLight&&this.directionalLight.shadowsEnabled();E&&y.canCastShadows()&&D&&(E.castsShadows=!0);const L=this._changes.getRemovedLayer(y);if(L&&y.source&&E&&"custom"!==y.type){this._changes.discardLayerRemoval(y);const k=o.aC(y.source,y.scope);L.type!==y.type?this._changes.updateSourceCache(k,"clear"):(this._changes.updateSourceCache(k,"reload"),E.pause())}this._updateLayer(y),y.onAdd&&y.onAdd(this.map),y.scope=this.scope,this.mergeLayers()}moveLayer(t,n){this._checkLoaded();const c=this._checkLayer(t);if(!c||t===n)return;const p=this._order.indexOf(t);this._order.splice(p,1);let y=this._order.length;if(n){const b=this._order.indexOf(n);if(-1===b)return void this.fire(new o.y(new Error(`Layer with id "${n}" does not exist on this map.`)));c.slot===this._layers[n].slot?y=b:o.w(`Layer with id "${n}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(y,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();const n=this._checkLayer(t);if(!n)return;n.setEventedParent(null);const c=this._order.indexOf(t);this._order.splice(c,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(n.fqid),this._changes.removeLayer(n);const p=this.getOwnLayerSourceCache(n);if(p&&p.castsShadows){let y=!1;for(const b in this._layers)if(this._layers[b].source===n.source&&this._layers[b].canCastShadows()){y=!0;break}p.castsShadows=y}n.onRemove&&n.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(const n in this._layers)if(this._layers[n].type===t)return!0;return!1}setLayerZoomRange(t,n,c){this._checkLoaded();const p=this._checkLayer(t);p&&(p.minzoom===n&&p.maxzoom===c||(null!=n&&(p.minzoom=n),null!=c&&(p.maxzoom=c),this._updateLayer(p)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,n){this._checkLoaded();const c=this._checkLayer(t);c&&c.slot!==n&&(c.slot=n,this._updateLayer(c))}setFilter(t,n,c={}){this._checkLoaded();const p=this._checkLayer(t);if(p&&!o.bn(p.filter,n))return null==n?(p.filter=void 0,void this._updateLayer(p)):void(this._validate(En,`layers.${p.id}.filter`,n,{layerType:p.type},c)||(p.filter=o.cp(n),this._updateLayer(p)))}getFilter(t){const n=this._checkLayer(t);if(n)return o.cp(n.filter)}setLayoutProperty(t,n,c,p={}){this._checkLoaded();const y=this._checkLayer(t);if(y&&!o.bn(y.getLayoutProperty(n),c)){if(null!=c&&(!p||!1!==p.validate)&&Mo(y,pn.call(Or,{key:`layers.${t}.layout.${n}`,layerType:y.type,objectKey:n,value:c,styleSpec:o.a3,style:{glyphs:!0,sprite:!0}})))return;y.setLayoutProperty(n,c),0!==y.configDependencies.size&&this._configDependentLayers.add(y.fqid),this._updateLayer(y)}}getLayoutProperty(t,n){const c=this._checkLayer(t);if(c)return c.getLayoutProperty(n)}setPaintProperty(t,n,c,p={}){this._checkLoaded();const y=this._checkLayer(t);if(!y||o.bn(y.getPaintProperty(n),c)||null!=c&&(!p||!1!==p.validate)&&Mo(y,Sl.call(Or,{key:`layers.${t}.paint.${n}`,layerType:y.type,objectKey:n,value:c,styleSpec:o.a3})))return;const b=y.setPaintProperty(n,c);0!==y.configDependencies.size&&this._configDependentLayers.add(y.fqid),b&&this._updateLayer(y),this._changes.updatePaintProperties(y)}getPaintProperty(t,n){const c=this._checkLayer(t);if(c)return c.getPaintProperty(n)}setFeatureState(t,n){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:D,importId:L}=t.target,k=this.getFragmentStyle(L),N=k.getFeaturesetLayers(D);for(const{source:V,sourceLayer:j}of N)k.setFeatureState({id:t.id,source:V,sourceLayer:j},n)}else if("layerId"in t.target){const{layerId:D}=t.target,L=this.getLayer(D);this.setFeatureState({id:t.id,source:L.source,sourceLayer:L.sourceLayer},n)}return}const c=t.source,p=t.sourceLayer,y=this._checkSource(c);if(!y)return;const b=y.type;if("geojson"===b&&p)return void this.fire(new o.y(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===b&&!p)return void this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===t.id&&this.fire(new o.y(new Error("The feature id parameter must be provided.")));const E=this.getOwnSourceCaches(c);for(const D of E)D.setFeatureState(p,t.id,n)}removeFeatureState(t,n){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:D,importId:L}=t.target,k=this.getFragmentStyle(L),N=k.getFeaturesetLayers(D);for(const{source:V,sourceLayer:j}of N)k.removeFeatureState({id:t.id,source:V,sourceLayer:j},n)}else if("layerId"in t.target){const{layerId:D}=t.target,L=this.getLayer(D);this.removeFeatureState({id:t.id,source:L.source,sourceLayer:L.sourceLayer},n)}return}const c=t.source,p=this._checkSource(c);if(!p)return;const y=p.type,b="vector"===y?t.sourceLayer:void 0;if("vector"===y&&!b)return void this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")));if(n&&"string"!=typeof t.id&&"number"!=typeof t.id)return void this.fire(new o.y(new Error("A feature id is required to remove its specific state property.")));const E=this.getOwnSourceCaches(c);for(const D of E)D.removeFeatureState(b,t.id,n)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let y;if("featuresetId"in t.target){const{featuresetId:b,importId:E}=t.target,D=this.getFragmentStyle(E),L=D.getFeaturesetLayers(b);for(const{source:k,sourceLayer:N}of L){const V=D.getFeatureState({id:t.id,source:k,sourceLayer:N});if(V&&!y)y=V;else if(!o.bn(y,V))return void this.fire(new o.y(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){const{layerId:b}=t.target,E=this.getLayer(b);y=this.getFeatureState({id:t.id,source:E.source,sourceLayer:E.sourceLayer})}return y}const n=t.source,c=t.sourceLayer,p=this._checkSource(n);if(p){if("vector"!==p.type||c)return void 0===t.id&&this.fire(new o.y(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(n)[0].getFeatureState(c,t.id);this.fire(new o.y(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=o.l({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return o.l({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),n=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return o.cv({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:n,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},c=>void 0!==c)}_updateFilteredLayers(t){for(const n of Object.values(this._mergedLayers))t(n)&&this._updateLayer(n)}_updateLayer(t){this._changes.updateLayer(t);const n=this.getLayerSourceCache(t),c=o.aC(t.source,t.scope),p=this._changes.getUpdatedSourceCaches();t.source&&!p[c]&&n&&"raster"!==n.getSource().type&&(this._changes.updateSourceCache(c,"reload"),n.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const n=E=>this._mergedLayers[E].is3D(),c=this.order,p={},y=[];for(let E=c.length-1;E>=0;E--){const D=c[E];if(n(D)){p[D]=E;for(const L of t){const k=L[D];if(k)for(const N of k)y.push(N)}}}y.sort((E,D)=>D.intersectionZ-E.intersectionZ);const b=[];for(let E=c.length-1;E>=0;E--){const D=c[E];if(n(D))for(let L=y.length-1;L>=0;L--){const k=y[L].feature;if(k.layer&&p[k.layer.id]<E)break;b.push(k),y.pop()}else for(const L of t){const k=L[D];if(k)for(const N of k)b.push(N.feature)}}return b}queryRenderedFeatures(t,n,c){let p;n&&!Array.isArray(n)&&n.filter&&(this._validate(En,"queryRenderedFeatures.filter",n.filter,null,n),p=o.aZ(n.filter));const y={},b=k=>{if(Oh.has(k.type))return;const N=this.getOwnLayerSourceCache(k),V=y[N.id]=y[N.id]||{sourceCache:N,layers:{},has3DLayers:!1};k.is3D()&&(V.has3DLayers=!0),V.layers[k.fqid]=V.layers[k.fqid]||{styleLayer:k,targets:[]},V.layers[k.fqid].targets.push({filter:p})};if(n&&n.layers){if(!Array.isArray(n.layers))return this.fire(new o.y(new Error("parameters.layers must be an Array."))),[];for(const k of n.layers){const N=this._layers[k];if(!N)return this.fire(new o.y(new Error(`The layer '${k}' does not exist in the map's style and cannot be queried for features.`))),[];b(N)}}else for(const k in this._layers)b(this._layers[k]);const E=this._queryRenderedFeatures(t,y,c),D=this._flattenAndSortRenderedFeatures(E),L=[];for(const k of D)o.cs(k.layer.id)===this.scope&&L.push(k);return L}queryRenderedFeatureset(t,n,c){let p;n&&!Array.isArray(n)&&n.filter&&(this._validate(En,"queryRenderedFeatures.filter",n.filter,null,n),p=o.aZ(n.filter));const y="mock",b=[];if(n&&n.target)b.push(Object.assign({},n,{targetId:y,filter:p}));else{const k=this.getFeaturesetDescriptors();for(const N of k)b.push({targetId:y,filter:p,target:N});for(const{style:N}of this.fragments){const V=N.getFeaturesetDescriptors();for(const j of V)b.push({targetId:y,filter:p,target:j})}}const E=this.queryRenderedTargets(t,b,c),D=[],L=new Set;for(const k of E)for(const N of k.variants[y])As(N,k,L)||D.push(new o.cw(k,N));return D}queryRenderedTargets(t,n,c){const p={},y=(E,D,L,k)=>{const N=p[D.id]=p[D.id]||{sourceCache:D,layers:{},has3DLayers:!1};if(N.layers[E.fqid]=N.layers[E.fqid]||{styleLayer:E,targets:[]},E.is3D()&&(N.has3DLayers=!0),!k)return L.uniqueFeatureID=!1,void N.layers[E.fqid].targets.push(L);N.layers[E.fqid].targets.push(Object.assign({},L,{namespace:k.namespace,properties:k.properties,uniqueFeatureID:k.uniqueFeatureID}))};for(const E of n)if("featuresetId"in E.target){const{featuresetId:D,importId:L}=E.target,k=this.getFragmentStyle(L);if(!k||!k._featuresetSelectors)continue;const N=k._featuresetSelectors[D];if(!N){this.fire(new o.y(new Error(`The featureset '${D}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const V of N){const j=k.getOwnLayer(V.layerId);j&&!Oh.has(j.type)&&y(j,k.getOwnLayerSourceCache(j),E,V)}}else if("layerId"in E.target){const{layerId:D}=E.target,L=this.getLayer(D);if(!L||Oh.has(L.type))continue;y(L,this.getLayerSourceCache(L),E)}const b=this._queryRenderedFeatures(t,p,c);return this._flattenAndSortRenderedFeatures(b)}_queryRenderedFeatures(t,n,c){const p=[],y=!!this.map._showQueryGeometry,b=Ft.createFromScreenPoints(t,c);for(const E in n){const D=Ua(b,n[E],this._availableImages,c,y);Object.keys(D).length&&p.push(D)}if(this.placement)for(const E in n){if(!n[E].sourceCache._onlySymbols)continue;const D=Lu(b.screenGeometry,n[E],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData);Object.keys(D).length&&p.push(D)}return p}querySourceFeatures(t,n){const c=n&&n.filter;c&&this._validate(En,"querySourceFeatures.filter",c,null,n);let p=[];const y=this.getOwnSourceCaches(t);for(const b of y)p=p.concat(_h(b,n));return p}addSourceType(t,n,c){return os.getSourceType(t)?c(new Error(`A source type called "${t}" already exists.`)):(os.setSourceType(t,n),n.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:n.workerSourceURL},c):c(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,n,c={}){this._checkLoaded();const p=this.light.getLight();let y=!1;for(const E in t)if(!o.bn(t[E],p[E])){y=!0;break}if(!y)return;const b=this._getTransitionParameters();this.light.setLight(t,n,c),this.light.updateTransitions(b)}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){void 0===this.disableElevatedTerrain&&(this.disableElevatedTerrain=o.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&o.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,n=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),0===n&&delete this.terrain,null===t?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let c=t;const p=null==t.source;if(1===n){if(this.disableElevatedTerrain)return;if("object"==typeof c.source){const E="terrain-dem-src";this.addSource(E,c.source),c=o.cp(c),c=o.l(c,{source:E})}const y=o.l({},c),b={};if(this.terrain&&p){y.source=this.terrain.get().source;const E=this.terrain?this.getFragmentStyle(this.terrain.scope):null;E&&(b.style=E.serialize())}if(this._validate(Va,"terrain",y,b))return}if(!this.terrain||this.terrain.scope!==this.scope&&!p||this.terrain&&n!==this.terrain.drapeRenderMode){if(!c)return;this._createTerrain(c,n),this.fire(new o.z("data",{dataType:"style"}))}else{const y=this.terrain,b=y.get();for(const E of Object.keys(o.a3.terrain))!c.hasOwnProperty(E)&&o.a3.terrain[E].default&&(c[E]=o.a3.terrain[E].default);for(const E in t)if(!o.bn(t[E],b[E])){y.set(t,this.options),this.stylesheet.terrain=t;const D=this._getTransitionParameters({duration:0});y.updateTransitions(D),this.fire(new o.z("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const n=this.fog=new Fe(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_createSnow(t){const n=this.snow=new Rt(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_createRain(t){const n=this.rain=new Nt(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask(()=>{for(const t of this.map._markers)t._evaluateOpacity()})}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const n=this.fog;if(!o.bn(n.get(),t)){n.set(t,this.options),this.stylesheet.fog=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const n=this.snow;if(!o.bn(n.get(),t)){n.set(t,this.options),this.stylesheet.snow=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const n=this.rain;if(!o.bn(n.get(),t)){n.set(t,this.options),this.stylesheet.rain=n.get();const c=this._getTransitionParameters({duration:0});n.updateTransitions(c)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const p in this._layers)this._layers[p].lut=this._styleColorTheme.lut;for(const p in this._sourceCaches)this._sourceCaches[p].clearTiles()},n=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!n)return this._styleColorTheme.lut=null,void t();const c=this._evaluateColorThemeData(n);this._loadColorTheme(c).then(()=>{this.fire(new o.z("colorthemeset")),t()}).catch(p=>{o.w(`Couldn't set color theme: ${p}`)})}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&o.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,n){const c=this.getFragmentStyle(t);c&&(c._styleColorTheme.colorThemeOverride=n,c._reloadColorTheme())}_getTransitionParameters(t){return{now:o.q.now(),transition:o.l(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const t=[],n=[];for(const c of this._mergedOrder)this.isLayerDraped(this._mergedLayers[c])?t.push(c):n.push(c);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...n)}_createTerrain(t,n){const c=this.terrain=new te(t,n,this.scope,this.options);1===n&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const p=this._getTransitionParameters({duration:0});c.updateTransitions(p)}_force3DLayerUpdate(){for(const t in this._layers){const n=this._layers[t];"fill-extrusion"===n.type&&this._updateLayer(n)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const n=this._layers[t];"symbol"===n.type&&this._updateLayer(n)}}_validate(t,n,c,p,y={}){if(y&&!1===y.validate)return!1;const b=o.l({},this.serialize());return Mo(this,t.call(Or,o.l({key:n,style:b,value:c,styleSpec:o.a3},p)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),o.cx.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.modelManager.setEventedParent(null),this.dispatcher.remove())}clearSource(t){const n=this.getSourceCaches(t);for(const c of n)c.clearTiles()}clearSources(){for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}reloadSource(t){const n=this.getSourceCaches(t);for(const c of n)c.resume(),c.reload()}reloadSources(){for(const t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle(t=>{t.modelManager.reloadModels(t.scope)})}updateSources(t){let n;this.directionalLight&&(n=So(this.directionalLight));for(const c in this._mergedSourceCaches)this._mergedSourceCaches[c].update(t,void 0,void 0,n)}_generateCollisionBoxes(){for(const t in this._sourceCaches){const n=this._sourceCaches[t];n.resume(),n.reload()}}_updatePlacement(t,n,c,p,y,b,E=!1){let D=!1,L=!1;const k={},N={};for(const V of this._mergedOrder){const j=this._mergedLayers[V];if("symbol"!==j.type)continue;const Y=o.aC(j.source,j.scope);let Z=k[Y];if(!Z){const J=this.getLayerSourceCache(j);if(!J)continue;const re=J.getRenderableIds(!0).map(he=>J.getTileByID(he));N[Y]=re.slice(),Z=k[Y]=re.sort((he,ce)=>ce.tileID.overscaledZ-he.tileID.overscaledZ||(he.tileID.isLessThan(ce.tileID)?-1:1))}const Q=this.crossTileSymbolIndex.addLayer(j,Z,n.center.lng,n.projection);D=D||Q}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),E=E||this._layerOrderChanged||0===p,this._layerOrderChanged&&this.fire(new o.z("neworder")),(E||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(o.q.now(),n.zoom))&&(this.pauseablePlacement=new Ou(n,this._mergedOrder,E,c,p,y,this.placement,this.fog&&n.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,k,N,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(o.q.now()),L=!0),D&&this.pauseablePlacement.placement.setStale()),L||D){this._buildingIndex.onNewFrame(n.zoom);for(let V=0;V<this._mergedOrder.length;V++){const j=this._mergedLayers[this._mergedOrder[V]];if("symbol"!==j.type)continue;const Y=this.isLayerClipped(j);this.placement.updateLayerOpacities(j,k[o.aC(j.source,j.scope)],V,Y?b:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(o.q.now())}}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,n){this._checkLoaded();const c=this.stylesheet.imports=this.stylesheet.imports||[];if(-1!==c.findIndex(({id:y})=>y===t.id))return void this.fire(new o.y(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!n)return c.push(t),this._loadImports([t],!0);const p=c.findIndex(({id:y})=>y===n);return-1===p&&this.fire(new o.y(new Error(`Import with id "${n}" does not exist on this map.`))),this.stylesheet.imports=c.slice(0,p).concat(t).concat(c.slice(p)),this._loadImports([t],!0,n)}updateImport(t,n){this._checkLoaded();const c=this.stylesheet.imports||[],p=this.getImportIndex(t);return-1===p?this:"string"==typeof n?(this.setImportUrl(t,n),this):(n.url&&n.url!==c[p].url&&this.setImportUrl(t,n.url),o.bn(n.config,c[p].config)||this.setImportConfig(t,n.config,n.data.schema),o.bn(n.data,c[p].data)||this.setImportData(t,n.data),this)}moveImport(t,n){this._checkLoaded();let c=this.stylesheet.imports||[];const p=this.getImportIndex(t);if(-1===p)return this;const y=this.getImportIndex(n);if(-1===y)return this;const b=c[p],E=this.fragments[p];return c=c.filter(({id:D})=>D!==t),this.fragments=this.fragments.filter(({id:D})=>D!==t),this.stylesheet.imports=c.slice(0,y).concat(b).concat(c.slice(y)),this.fragments=this.fragments.slice(0,y).concat(E).concat(this.fragments.slice(y)),this.mergeLayers(),this}setImportUrl(t,n){this._checkLoaded();const c=this.stylesheet.imports||[],p=this.getImportIndex(t);if(-1===p)return this;c[p].url=n;const y=this.fragments[p];return y.style=this._createFragmentStyle(c[p]),y.style.on("style.import.load",()=>this.mergeAll()),y.style.loadURL(n),this}setImportData(t,n){this._checkLoaded();const c=this.getImportIndex(t),p=this.stylesheet.imports||[];return-1===c?this:n?(this.fragments[c].style.setState(n),this._reloadImports(),this):(delete p[c].data,this.setImportUrl(t,p[c].url))}setImportConfig(t,n,c){this._checkLoaded();const p=this.getImportIndex(t),y=this.stylesheet.imports||[];if(-1===p)return this;n?y[p].config=n:delete y[p].config;const b=this.fragments[p];c&&b.style.stylesheet&&(b.style.stylesheet.schema=c);const E=b.style.stylesheet&&b.style.stylesheet.schema;return b.config=n,b.style.updateConfig(n,E),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();const n=this.stylesheet.imports||[],c=this.getImportIndex(t);-1!==c&&(n.splice(c,1),this.fragments[c].style._remove(),this.fragments.splice(c,1),this._reloadImports())}getImportIndex(t){const n=(this.stylesheet.imports||[]).findIndex(c=>c.id===t);return-1===n&&this.fire(new o.y(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),n}getLayer(t){return this._mergedLayers[t]}getSources(){const t=[];for(const n in this._mergedOtherSourceCaches){const c=this._mergedOtherSourceCaches[n];c&&t.push(c.getSource())}return t}getSource(t,n){const c=this.getSourceCache(t,n);return c&&c.getSource()}getLayerSource(t){const n=this.getLayerSourceCache(t);return n&&n.getSource()}getSourceCache(t,n){const c=o.aC(t,n);return this._mergedOtherSourceCaches[c]}getLayerSourceCache(t){const n=o.aC(t.source,t.scope);return"symbol"===t.type?this._mergedSymbolSourceCaches[n]:this._mergedOtherSourceCaches[n]}getSourceCaches(t){if(null==t)return Object.values(this._mergedSourceCaches);const n=[];return this._mergedOtherSourceCaches[t]&&n.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&n.push(this._mergedSymbolSourceCaches[t]),n}updateSourceCaches(){const t=this._changes.getUpdatedSourceCaches();for(const n in t){const c=t[n];"reload"===c?this.reloadSource(n):"clear"===c&&this.clearSource(n)}}updateLayers(t){const n=this._changes.getUpdatedPaintProperties();for(const c of n){const p=this.getLayer(c);p&&p.updateTransitions(t)}}getImages(t,n,c){this.imageManager.getImages(n.icons,n.scope,c),this._updateTilesForChangedImages();const p=y=>{y&&y.setDependencies(n.tileID.key,n.type,n.icons)};p(this._otherSourceCaches[n.source]),p(this._symbolSourceCaches[n.source])}rasterizeImages(t,n,c){this.imageManager.rasterizeImages(n,c)}getGlyphs(t,n,c){this.glyphManager.getGlyphs(n.stacks,n.scope,c)}getResource(t,n,c){return o.cy(n,c)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return"symbol"===t.type?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){const n=[];return this._otherSourceCaches[t]&&n.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&n.push(this._symbolSourceCaches[t]),n}_isSourceCacheLoaded(t){const n=this.getOwnSourceCaches(t);return 0===n.length?(this.fire(new o.y(new Error(`There is no source with ID '${t}'`))),!1):n.every(c=>c.loaded())}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,n){if(!this._clipLayerPresent&&"fill-extrusion"!==t.type)return!1;const c="fill-extrusion"===t.type&&"building"===t.sourceLayer;if(t.is3D()){if(c||n&&"batched-model"===n.type||"model"===t.type)return!0}else if("symbol"===t.type)return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach(t=>{t.style._remove()}),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}os.getSourceType=function(l){return Nn[l]},os.setSourceType=function(l,t){Nn[l]=t},os.registerForPluginStateChange=o.ch;var Sc="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#ifdef RENDER_CUTOFF\nfloat cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}\n#endif",Ol="\nout vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#ifdef INDICATOR_CUTOUT\nuniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;\n#endif\nvec4 applyCutout(vec4 color,float height) {\n#ifdef INDICATOR_CUTOUT\nfloat verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);\n#else\nreturn color;\n#endif\n}\n#ifdef DEBUG_WIREFRAME\n#define HANDLE_WIREFRAME_DEBUG \\\nglFragColor=vec4(0.7,0.0,0.0,0.7); \\\ngl_FragDepth=gl_FragCoord.z-0.0001;\n#else\n#define HANDLE_WIREFRAME_DEBUG\n#endif\n#ifdef RENDER_CUTOFF\nuniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;\n#endif\nvec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}",Fl="\n#define EXTENT 8192.0\n#define RAD_TO_DEG 180.0/PI\n#define DEG_TO_RAD PI/180.0\n#define GLOBE_RADIUS EXTENT/PI/2.0\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#ifndef PROJECTED_POS_ON_VIEWPORT\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}\n#ifdef RENDER_CUTOFF\nuniform vec4 u_cutoff_params;out float v_cutoff_opacity;\n#endif\nconst vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)\n{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}",Eo="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",Bl="\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nfloat nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {\n#ifdef ZERO_EXAGGERATION\nreturn 0.0;\n#endif\nreturn currentElevation(apos);}\n#endif\nvec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }\n#endif\n#ifdef DEPTH_OCCLUSION\nuniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;\n#ifdef DEPTH_D24\nfloat unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}\n#else\nhighp float unpack_depth_rgba(vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;\n#ifdef DEPTH_D24\nfloat depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);\n#else\nfloat depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));\n#endif\nreturn coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;\n#ifdef DEPTH_D24\nhighp vec4 depth=vec4(\ntexture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r\n);depth=unpack_depth4(depth);\n#else\nhighp vec4 depth=vec4(\nunpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))\n);\n#endif\nreturn depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));\n#endif\nres+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}\n#else\nbool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }\n#endif//DEPTH_OCCLUSION",Bh="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",ra="#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif",Fr="#ifdef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)\n);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)\n);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}\n#endif",Za="#ifdef RASTER_ARRAY\nuniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}\n#endif\nuniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}",Nl="#ifdef RENDER_SHADOWS\nuniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}\n#endif//RENDER_SHADOWS",sa="#ifdef RENDER_SHADOWS\n#ifdef DEPTH_TEXTURE\nuniform highp sampler2D u_shadowmap_0;uniform highp sampler2D u_shadowmap_1;\n#else\nuniform sampler2D u_shadowmap_0;uniform sampler2D u_shadowmap_1;\n#endif\nuniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;highp float shadow_sample_1(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_1,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_1,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}highp float shadow_sample_0(highp vec2 uv,highp float compare) {highp float shadow_depth;\n#ifdef DEPTH_TEXTURE\nshadow_depth=texture(u_shadowmap_0,uv).r;\n#else\nshadow_depth=unpack_depth(texture(u_shadowmap_0,uv))*0.5+0.5;\n#endif\nreturn step(shadow_depth,compare);}float shadow_occlusion_1(highp vec4 pos,highp float bias) {highp vec2 uv=pos.xy;return shadow_sample_1(uv,pos.z-bias);}float shadow_occlusion_0(highp vec4 pos,highp float bias) {highp float compare0=pos.z-bias;\n#ifdef TEXTURE_GATHER\nhighp vec2 uv=pos.xy;highp vec4 samples=textureGather(u_shadowmap_0,uv,0);lowp vec4 stepSamples=step(samples,vec4(compare0));\n#else\nhighp vec2 uv00=pos.xy-vec2(0.5*u_shadow_texel_size);highp vec2 uv10=uv00+vec2(u_shadow_texel_size,0.0);highp vec2 uv01=uv00+vec2(0.0,u_shadow_texel_size);highp vec2 uv11=uv01+vec2(u_shadow_texel_size,0.0);lowp vec4 stepSamples=vec4(\nshadow_sample_0(uv01,compare0),shadow_sample_0(uv11,compare0),shadow_sample_0(uv10,compare0),shadow_sample_0(uv00,compare0)\n);\n#endif\nvec2 f=fract(pos.xy*u_shadow_map_resolution-vec2(0.5));lowp vec2 lerpx=mix(stepSamples.wx,stepSamples.zy,f.xx);return mix(lerpx.x,lerpx.y,f.y);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {\n#ifdef SHADOWS_SINGLE_CASCADE\nlight_view_pos0.xyz/=light_view_pos0.w;vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);\n#else\nlight_view_pos0.xyz/=light_view_pos0.w;light_view_pos1.xyz/=light_view_pos1.w;vec4 uv=vec4(light_view_pos0.xy,light_view_pos1.xy);vec4 abs_bounds=abs(uv);if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {light_view_pos0.xyz=light_view_pos0.xyz*0.5+0.5;return shadow_occlusion_0(light_view_pos0,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}light_view_pos1.xyz=light_view_pos1.xyz*0.5+0.5;float occlusion1=shadow_occlusion_1(light_view_pos1,bias);return mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth));\n#endif\n}highp float calculate_shadow_bias(float NDotL) {\n#ifdef NORMAL_OFFSET\nreturn 0.5*u_shadow_bias.x;\n#else\nreturn 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));\n#endif\n}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)\n{highp vec2 biasUV=vec2(\npos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}\n#endif";const Ao=[];Io(Sc,Ao),Io(Fl,Ao),Io(Ol,Ao);const Xa={"_prelude_fog.vertex.glsl":Bh,"_prelude_terrain.vertex.glsl":Bl,"_prelude_shadow.vertex.glsl":Nl,"_prelude_fog.fragment.glsl":ra,"_prelude_shadow.fragment.glsl":sa,"_prelude_lighting.glsl":"\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}\n#endif//LIGHTING_3D_MODE","_prelude_raster_array.glsl":Fr,"_prelude_raster_particle.glsl":Za},Vl={};xi("",Bl),xi(ra,Bh),xi(sa,Nl),xi(Fr,""),xi(Za,"");const Ul=xi(Ol,Fl),jl=Sc;var Ya={background:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec4 u_color;uniform float u_opacity;\n#ifdef LIGHTING_3D_MODE\nin vec4 v_color;\n#endif\nvoid main() {vec4 out_color;\n#ifdef LIGHTING_3D_MODE\nout_color=v_color;\n#else\nout_color=u_color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_lighting.glsl"\nin vec2 a_pos;uniform mat4 u_matrix;\n#ifdef LIGHTING_3D_MODE\nuniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef LIGHTING_3D_MODE\nv_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),backgroundPattern:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),circle:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nuniform float u_emissive_strength;void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? \nsmoothstep(0.0,-antialiased_blur,1.0-extrude_length) : \nsmoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#endif\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\nglFragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\n#ifdef ELEVATED_ROADS\nin float a_circle_z_offset;\n#endif\nout vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);\n#else \nsurface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);\n#endif\n#ifdef ELEVATED_ROADS\nworld_center.z+=a_circle_z_offset+ELEVATION_BIAS;\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nocclusion_world_center=world_center;occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}'),clippingMask:xi("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:xi('#include "_prelude_fog.fragment.glsl"\nuniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\nif (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nout vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\npos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),heatmapTexture:xi("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(0.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}","in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:xi("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",'#include "_prelude_terrain.vertex.glsl"\nin vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}'),collisionCircle:xi("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}","in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:xi("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",'#include "_prelude_terrain.vertex.glsl"\nin vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;\n#endif\nout vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}'),fill:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nuniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=opacity;\n#ifdef INDICATOR_CUTOUT\nif (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=z_offset;\n#endif\n}'),fillOutline:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nin highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nuniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp float z_offset\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillOutlinePattern:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nin highp vec2 v_pos;in highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;out highp vec2 v_pos_world;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillPattern:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;in highp vec2 v_pos;uniform float u_emissive_strength;\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nglFragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;\n#ifdef ELEVATED_ROADS\nin float a_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\nout highp vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern\n#pragma mapbox: define lowp float pixel_ratio\n#pragma mapbox: define highp float z_offset\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize lowp float pixel_ratio\n#pragma mapbox: initialize highp float z_offset\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;\n#ifdef ELEVATED_ROADS\nz_offset+=a_road_z_offset;\n#endif\nfloat hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),fillExtrusion:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nin vec4 v_color;in vec4 v_flat;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;\n#endif\nuniform lowp float u_opacity;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec2 v_ao;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nin vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nin highp vec3 v_normal;\n#endif\nuniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nin float v_flood_radius;in float v_has_floodlight;\n#endif\nin float v_height;\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float emissive_strength\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nvec3 normal=normalize(v_normal);\n#endif\nfloat z;vec4 color=v_color;\n#ifdef ZERO_ROOF_RADIUS\nz=float(normal.z > 0.00001);\n#ifdef LIGHTING_3D_MODE\nnormal=mix(normal,vec3(0.0,0.0,1.0),z);\n#else\ncolor=mix(v_color,v_roof_color,z);\n#endif\n#endif\nfloat h=max(0.0,v_height);float ao_shade=1.0;\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;\n#ifdef ZERO_ROOF_RADIUS\nconcave*=(1.0-z);\n#endif\nfloat x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\ncolor.rgb*=mix(ao_shade,1.0,v_has_floodlight);\n#else\ncolor.rgb*=ao_shade;\n#endif\n#else\ncolor.rgb*=ao_shade;\n#endif\n#endif\n#ifdef LIGHTING_3D_MODE\nfloat flood_radiance=0.0;\n#ifdef FLOOD_LIGHT\nflood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;\n#endif\n#ifdef RENDER_SHADOWS\n#ifdef FLOOD_LIGHT\nfloat ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);\n#else\nfloat shadowed_lighting_factor;\n#ifdef RENDER_CUTOFF\nshadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}\n#else\nshadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);\n#endif\ncolor.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);\n#endif\n#else\ncolor.rgb=apply_lighting(color.rgb,normal);\n#ifdef FLOOD_LIGHT\ncolor.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);\n#endif\n#endif\ncolor.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));\n#endif\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,h);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nuniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nout vec4 v_roof_color;\n#endif\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nout highp vec3 v_normal;\n#endif\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec2 v_ao;\n#endif\n#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)\nout float v_flood_radius;out float v_has_floodlight;\n#endif\nout float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define highp float flood_light_wall_radius\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize highp float flood_light_wall_radius\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp float emissive_strength\nbase*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));\n#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)\nv_normal=normal;\n#endif\nbase=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\nh=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat cutoff=1.0;vec3 scaled_pos=pos;\n#ifdef RENDER_CUTOFF\nvec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);cutoff=cutoff_opacity(u_cutoff_params,ground.z);if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\ngl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;\n#ifdef RENDER_SHADOWS\nvec3 shd_pos0=pos;vec3 shd_pos1=pos;\n#ifdef NORMAL_OFFSET\nvec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);\n#endif\nfloat NdotL=0.0;float colorvalue=0.0;\n#ifndef LIGHTING_3D_MODE\ncolorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#endif\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\n#ifdef FLOOD_LIGHT\nfloat is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;\n#endif\nv_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);\n#else\nv_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#endif\n#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)\nfloat roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}'),fillExtrusionDepth:xi("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nin vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp float line_width\n#pragma mapbox: define highp vec4 color\nout highp float v_depth;void main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp float line_width\n#pragma mapbox: initialize highp vec4 color\nbase*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nvec3 pos;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);\n#else\npos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}'),fillExtrusionPattern:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform vec2 u_texsize;uniform sampler2D u_image;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;in vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nin vec3 v_normal;\n#endif\nin highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;\n#else\nout_color=out_color*v_lighting;\n#endif\n#ifdef FAUX_AO\nfloat intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,height);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#include "_prelude_lighting.glsl"\nuniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;\n#ifdef RENDER_WALL_MODE\nin vec3 a_join_normal_inside;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\n#ifdef TERRAIN\nuniform int u_height_type;uniform int u_base_type;\n#endif\nout highp vec2 v_pos;out vec4 v_lighting;\n#ifdef FAUX_AO\nuniform lowp vec2 u_ao;out vec3 v_ao;\n#endif\n#ifdef LIGHTING_3D_MODE\nout vec3 v_normal;\n#endif\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define highp float pixel_ratio\n#pragma mapbox: define highp float line_width\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize highp float pixel_ratio\n#pragma mapbox: initialize highp float line_width\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\nfloat ele=0.0;float h=z;vec3 p;float c_ele;\n#ifdef TERRAIN\nbool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);\n#else\np=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\n#ifdef RENDER_WALL_MODE\nvec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;\n#endif\nfloat hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;\n#ifdef LIGHTING_3D_MODE\nNdotL=calculate_NdotL(normal);\n#else\nNdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);\n#endif\nif (normal.y !=0.0) {float r=0.84;\n#ifndef LIGHTING_3D_MODE\nr=mix(0.7,0.98,1.0-u_lightintensity);\n#endif\nNdotL*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}\n#ifdef FAUX_AO\nfloat concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;\n#ifdef TERRAIN\ntop_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);\n#endif\nv_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);\n#ifdef PROJECTION_GLOBE_VIEW\ntop_height+=u_height_lift;\n#endif\ngl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;\n#endif\n#ifdef LIGHTING_3D_MODE\nv_normal=normal;\n#else\nv_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#endif \n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}'),groundShadow:xi('#include "_prelude_shadow.fragment.glsl"\nprecision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\nvoid main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);\n#ifdef RENDER_CUTOFF\nshadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));\n#endif\n#ifdef FOG\nshadow=mix(shadow,vec3(1.0),v_fog_opacity);\n#endif\n#ifdef INDICATOR_CUTOUT\nshadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);\n#endif\nglFragColor=vec4(shadow,1.0);}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\nvoid main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);\n#endif\n}'),fillExtrusionGroundEffect:xi("uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;\n#ifdef SDF_SUBPASS\nin highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}\n#ifdef FOG\nin highp float v_fog;\n#endif\n#endif\nvoid main() {\n#ifdef CLEAR_SUBPASS\nvec4 color=vec4(1.0);\n#ifdef CLEAR_FROM_TEXTURE\ncolor=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));\n#endif\nglFragColor=color;\n#else\n#ifdef SDF_SUBPASS\nhighp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;\n#ifdef FOG\nfog=v_fog;\n#endif\n#ifdef RENDER_CUTOFF\nfog*=v_cutoff_opacity;\n#endif\nglFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));\n#else\nvec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);\n#ifdef OVERDRAW_INSPECTOR\ncolor=vec4(1.0);\n#endif\nglFragColor=color;\n#endif\nHANDLE_WIREFRAME_DEBUG;\n#endif\n}",'#include "_prelude_fog.vertex.glsl"\nin highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;\n#ifdef SDF_SUBPASS\nout highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;\n#ifdef FOG\nout highp float v_fog;\n#endif\n#endif\nuniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;\n#pragma mapbox: define highp float flood_light_ground_radius\nconst float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {\n#pragma mapbox: initialize highp float flood_light_ground_radius\nvec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;\n#ifdef SDF_SUBPASS\nv_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);\n#ifdef FOG\nv_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);\n#endif\n#endif\nfloat hidden_by_landmark=0.0;\n#ifdef HAS_CENTROID\nhidden_by_landmark=a_hidden_by_landmark;\n#endif\nfloat isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n}'),hillshadePrepare:xi("precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef LIGHTING_3D_MODE\nglFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);\n#endif\n#ifdef FOG\nglFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}'),line:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;in vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nfloat luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nfloat linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);\n#endif\nhighp vec4 out_color;\n#ifdef RENDER_LINE_GRADIENT\nout_color=texture(u_gradient_image,v_uv.xy);\n#else\nout_color=color;\n#endif\nfloat trim_alpha=1.0;\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}\n#endif\nif (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}\n#ifdef RENDER_LINE_BORDER\nfloat edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}\n#endif\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\nout_color.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\nout_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\nout_color*=(alpha*opacity);\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define EXTRUDE_SCALE 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)\nin vec3 a_z_offset_width;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nin highp vec3 a_packed;\n#endif\n#ifdef RENDER_LINE_DASH\nin float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float border_width\n#pragma mapbox: define lowp vec4 border_color\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float border_width\n#pragma mapbox: initialize lowp vec4 border_color\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;\n#ifdef VARIABLE_LINE_WIDTH\nfloat left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;\n#else\nhalfwidth=(u_width_scale*width)/2.0;\n#endif\noffset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)\nhighp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];\n#ifdef RENDER_LINE_GRADIENT\nhighp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);\n#else\nv_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\n#endif\n#ifdef RENDER_LINE_DASH\nfloat scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),linePattern:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_shadow.fragment.glsl"\nuniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nin highp float v_road_z_offset;\n#endif\n#ifdef LINE_JOIN_NONE\nin vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;\n#endif\nuniform float u_emissive_strength;\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\nvec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}\n#endif\n#ifdef LINE_JOIN_NONE\nhighp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}\n#endif\n#ifdef LIGHTING_3D_MODE\ncolor=apply_lighting_with_emission_ground(color,u_emissive_strength);\n#ifdef RENDER_SHADOWS\nfloat light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);\n#ifdef ELEVATED_ROADS\ncolor.rgb*=mix(v_road_z_offset > 0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);\n#else\ncolor.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}\n#ifdef INDICATOR_CUTOUT\ncolor=applyCutout(color,v_z_offset);\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\nin vec3 a_z_offset_width;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nin highp vec3 a_packed;\n#endif\nin highp float a_linesofar;\n#ifdef LINE_JOIN_NONE\nin highp vec3 a_pattern_data;out vec2 v_pattern_data;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;\n#ifdef ELEVATED\nuniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {\n#ifdef ELEVATION_REFERENCE_SEA\nreturn 0.0;\n#else\nreturn elevation(apos);\n#endif\n}\n#endif\nout vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef RENDER_LINE_TRIM_OFFSET\nout highp vec3 v_uv;\n#endif\n#ifdef ELEVATED_ROADS\nout highp float v_road_z_offset;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;\n#endif\n#pragma mapbox: define mediump float blur\n#pragma mapbox: define mediump float opacity\n#pragma mapbox: define mediump float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define mediump float floorwidth\n#pragma mapbox: define mediump vec4 pattern\n#pragma mapbox: define mediump float pixel_ratio\nvoid main() {\n#pragma mapbox: initialize mediump float blur\n#pragma mapbox: initialize mediump float opacity\n#pragma mapbox: initialize mediump float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize mediump float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern\n#pragma mapbox: initialize mediump float pixel_ratio\nfloat a_z_offset;\n#if defined(ELEVATED) || defined(ELEVATED_ROADS)\na_z_offset=a_z_offset_width.x;\n#endif\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;\n#ifdef ELEVATED_ROADS\nv_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;\n#else\n#ifdef ELEVATED\nvec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;\n#ifdef CROSS_SLOPE_VERTICAL\nfloat top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);\n#else\n#ifdef CROSS_SLOPE_HORIZONTAL\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;\n#else\nfloat ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;\n#endif\n#endif\ngl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);\n#else\ngl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);\n#endif\n#endif\n#ifdef ELEVATED_ROADS\n#ifdef RENDER_SHADOWS\nvec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;\n#ifdef NORMAL_OFFSET\nvec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();\n#endif\nv_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;\n#endif\n#endif\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_TRIM_OFFSET\nhighp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);\n#ifdef LINE_JOIN_NONE\nv_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=a_z_offset;\n#endif\n}'),raster:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\n#include "_prelude_raster_array.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nin float v_split_fade;\n#endif\nuniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;\n#ifndef RASTER_ARRAY\nuniform highp sampler2D u_image0;uniform sampler2D u_image1;\n#endif\n#ifdef RASTER_COLOR\nuniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;\n#endif\nvoid main() {vec4 color0,color1,color;vec2 value;\n#ifdef RASTER_COLOR\n#ifdef RASTER_ARRAY\n#ifdef RASTER_ARRAY_LINEAR\nvalue=mix(\nraTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#else\nvalue=mix(\nraTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t\n);\n#endif\nif (value.y > 0.0) value.x/=value.y;\n#else\ncolor=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);\n#endif\ncolor=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;\n#else\ncolor0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);\n#endif\ncolor.a*=u_opacity;\n#ifdef GLOBE_POLES\ncolor.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);\n#endif\nvec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef PROJECTION_GLOBE_VIEW\nglFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));\n#endif\n#ifdef RENDER_CUTOFF\nglFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);\n#endif\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;in vec2 a_texture_pos;\n#endif\nout vec2 v_pos0;out vec2 v_pos1;out float v_depth;\n#ifdef PROJECTION_GLOBE_VIEW\nout float v_split_fade;\n#endif\nvoid main() {vec2 uv;\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);\n#endif\n#else\nfloat w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    \nv_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\ngl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;\n#ifdef RENDER_CUTOFF\nv_depth=gl_Position.z;\n#endif\n}'),rasterParticle:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;\n#endif\n#ifdef FOG\nhighp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));\n#endif\nglFragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\nuniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;\n#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8\nin vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n#else\nuv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n#endif\nv_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}'),rasterParticleDraw:xi("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",'#include "_prelude_raster_particle.glsl"\nin float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(\nmod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}'),rasterParticleTexture:xi("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:xi('#include "_prelude_raster_particle.glsl"\nuniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(\nlinearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)\n);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}',"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:xi('#include "_prelude_lighting.glsl"\n#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;\n#ifdef ICON_TRANSITION\nuniform float u_icon_transition;\n#endif\n#ifdef COLOR_ADJUSTMENT\nuniform mat4 u_color_adj_mat;\n#endif\n#ifdef INDICATOR_CUTOUT\nin highp float v_z_offset;\n#endif\nin vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nin vec2 v_tex_b;\n#endif\nin float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nin float is_sdf;in vec2 v_tex_a_icon;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\nvec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];\n#ifdef RENDER_TEXT_AND_SYMBOL\nif (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nreturn;}\n#endif\n#ifdef RENDER_SDF\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;\n#else\n#ifdef ICON_TRANSITION\nvec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);\n#else\nout_color=texture(u_texture,v_tex_a);\n#endif\n#ifdef COLOR_ADJUSTMENT\nout_color=u_color_adj_mat*out_color;\n#endif\n#endif\nout_color*=opacity*fade_opacity;\n#ifdef LIGHTING_3D_MODE\nout_color=apply_lighting_with_emission_ground(out_color,emissive_strength);\n#endif\n#ifdef INDICATOR_CUTOUT\nout_color=applyCutout(out_color,v_z_offset);\n#endif\nglFragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_terrain.vertex.glsl"\nin vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;\n#ifdef Z_OFFSET\nin float a_auto_z_offset;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nin vec3 a_globe_anchor;in vec3 a_globe_normal;\n#endif\n#ifdef ICON_TRANSITION\nin vec2 a_texb;\n#endif\n#ifdef OCCLUSION_QUERIES\nin float a_occlusion_query_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nout highp float v_z_offset;\n#endif\nuniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;\n#endif\nout vec2 v_tex_a;\n#ifdef ICON_TRANSITION\nout vec2 v_tex_b;\n#endif\nout float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;\n#ifdef RENDER_TEXT_AND_SYMBOL\nout float is_sdf;out vec2 v_tex_a_icon;\n#endif\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\n#pragma mapbox: define lowp float emissive_strength\n#pragma mapbox: define lowp float occlusion_opacity\n#pragma mapbox: define lowp float z_offset\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\n#pragma mapbox: initialize lowp float emissive_strength\n#pragma mapbox: initialize lowp float occlusion_opacity\n#pragma mapbox: initialize lowp float z_offset\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);\n#ifdef Z_OFFSET\ne+=a_auto_z_offset;\n#endif\nvec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;\n#ifdef PROJECTION_GLOBE_VIEW\nmercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;\n#else\nworld_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;\n#else\noffsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;\n#endif\nvec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;\n#ifdef PROJECTION_GLOBE_VIEW\n#ifdef PROJECTED_POS_ON_VIEWPORT\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);\n#else\nvec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    \n#endif\n#else\nprojected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);\n#ifdef TERRAIN\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\n#endif\n#ifdef Z_OFFSET\nz+=u_pitch_with_map ? a_auto_z_offset+(u_elevation_from_sea ? z_offset : z_offset) : 0.0;\n#else\nz+=u_pitch_with_map ? (u_elevation_from_sea ? z_offset : z_offset) : 0.0;\n#endif\nfloat occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));\n#ifdef DEPTH_OCCLUSION\nfloat depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;\n#endif\n#ifdef OCCLUSION_QUERIES\nfloat occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;\n#endif\nfloat alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);\n#ifdef PROJECTION_GLOBE_VIEW\nvec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y,1.0),AWAY,hidden);\n#else\ngl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,hidden);\n#endif\nfloat gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;\n#ifdef RENDER_TEXT_AND_SYMBOL\nis_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;\n#endif\n#ifdef ICON_TRANSITION\nv_tex_b=a_texb/u_texsize;\n#endif\n#ifdef INDICATOR_CUTOUT\nv_z_offset=e;\n#endif\n}'),terrainRaster:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;in vec2 v_pos0;\n#ifdef FOG\nin float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nin vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;\n#endif\nuniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;\n#ifdef LIGHTING_3D_MODE\nconst vec3 normal=vec3(0.0,0.0,1.0);\n#ifdef RENDER_SHADOWS\nfloat cutoffOpacity=1.0;\n#ifdef RENDER_CUTOFF\ncutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);\n#endif\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nvec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;\n#else\nfloat lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));\n#endif\n#else\nfloat lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;\n#endif\n#endif\n#else\ncolor=image_color;\n#endif\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#else\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\n#endif\nglFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;\n#ifdef FOG\nout float v_fog_opacity;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;out float v_depth;\n#endif\nvoid main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\n#ifdef ZERO_EXAGGERATION\nv_fog_pos=fog_position(decodedPos);\n#else\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);\n#endif\n}'),terrainDepth:xi("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",'#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}'),skybox:xi('#include "_prelude_fog.fragment.glsl"\nin lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',Eo),skyboxGradient:xi('#include "_prelude_fog.fragment.glsl"\nin highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\n}',Eo),skyboxCapture:xi("\nin highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}","in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;\n#ifndef FOG\nuniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;\n#endif\nvoid main() {vec4 color;\n#ifdef CUSTOM_ANTIALIASING\nhighp vec2 uv=gl_FragCoord.xy/u_viewport;highp vec3 ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\nraster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);\n#else\nraster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=vec4(raster.rgb*antialias,raster.a*antialias);\n#endif\n#else\ncolor=texture(u_image0,v_pos0);\n#ifdef LIGHTING_3D_MODE\n#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS\ncolor=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;\n#else\ncolor=apply_lighting_ground(color);\n#endif\n#endif\n#endif\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ncolor*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_terrain.vertex.glsl"\nuniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;\n#ifdef GLOBE_POLES\nin vec3 a_globe_pos;in vec2 a_uv;\n#else\nin vec2 a_pos;\n#endif\nout vec2 v_pos0;void main() {\n#ifdef GLOBE_POLES\nvec3 globe_pos=a_globe_pos;vec2 uv=a_uv;\n#else\nfloat tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);\n#endif\nv_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;\n#ifdef GLOBE_POLES\nvec3 up_vector=globe_derived_up_vector;\n#else\nvec3 up_vector=elevationVector(tile_pos);\n#endif\nfloat height=elevation(tile_pos);globe_pos+=up_vector*height;\n#ifndef GLOBE_POLES\nglobe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;\n#endif\n#ifdef GLOBE_POLES\nvec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);\n#else\nvec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);\n#endif\ngl_Position=u_proj_matrix*interpolated_pos;\n#ifdef FOG\nv_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);\n#endif\n}'),globeAtmosphere:xi('#include "_prelude_fog.fragment.glsl"\nuniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;\n#ifdef PROJECTION_GLOBE_VIEW\nglobe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {\n#ifdef ALPHA_PASS\nglFragColor=vec4(0,0,0,0);return;\n#else\n#ifdef NATIVE\nglFragColor=vec4(1,1,1,1);\n#else\nglFragColor=vec4(0,0,0,1);\n#endif\nreturn;\n#endif\n}\n#endif\nhighp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?\n0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;\n#ifdef PROJECTION_GLOBE_VIEW\nhighp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?\nPI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);\n#else\nhorizon_angle=horizon_angle_mercator;\n#endif\nhorizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;\n#ifdef ALPHA_PASS\nfloat a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);\n#else\nvec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);\n#endif\n}',"in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(\nmix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(\nmix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}"),model:xi('#include "_prelude_fog.fragment.glsl"\n#include "_prelude_shadow.fragment.glsl"\n#include "_prelude_lighting.glsl"\nuniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;\n#ifdef RENDER_SHADOWS\nin highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;\n#endif\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nuniform vec4 u_occlusionTextureTransform;\n#endif\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#ifdef HAS_ATTRIBUTE_a_pbr\nin lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;\n#endif\n#ifdef HAS_TEXTURE_u_baseColorTexture\nuniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;\n#endif\n#ifdef HAS_TEXTURE_u_metallicRoughnessTexture\nuniform sampler2D u_metallicRoughnessTexture;\n#endif\n#ifdef HAS_TEXTURE_u_occlusionTexture\nuniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;\n#endif\n#ifdef HAS_TEXTURE_u_normalTexture\nuniform sampler2D u_normalTexture;\n#endif\n#ifdef HAS_TEXTURE_u_emissionTexture\nuniform sampler2D u_emissionTexture;\n#endif\n#ifdef APPLY_LUT_ON_GPU\nuniform highp sampler3D u_lutTexture;\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nin highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;\n#ifdef DEPTH_D24\nhighp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}\n#else\nhighp float unpack_depth_rgba(highp vec4 rgba_depth)\n{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}\n#endif\nbool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;\n#ifdef DEPTH_D24\nhighp float depth=unpack_depth(texture(u_depthTexture,coord).r);\n#else\nhighp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));\n#endif\nreturn v_depth > depth+0.0005;}\n#endif\n#define saturate(_x) clamp(_x,0.,1.)\nvec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)\n{\n#ifdef LIGHTING_3D_MODE\nvec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));\n#endif\nreturn apply_lighting(albedo,transformed_normal,lighting_factor);\n#else\nvec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;\n#endif\n}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;\n#ifdef HAS_ATTRIBUTE_a_color_3f\nalbedo*=vec4(color_3f,1.0);\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#else\n#ifdef HAS_ATTRIBUTE_a_color_4f\nalbedo*=color_4f;\n#endif\n#endif\n#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)\nvec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}\n#ifdef UNPREMULT_TEXTURE_IN_SHADER\nif(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;\n#endif\nif(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}\n#endif\nvec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);\n#ifdef APPLY_LUT_ON_GPU\ncolor=applyLUT(u_lutTexture,color);\n#endif\nreturn color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {\n#ifdef HAS_TEXTURE_u_normalTexture\nhighp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;\n#else\nreturn mat3(1.0);\n#endif\n}highp vec3 getNormal(){highp vec3 n;\n#ifdef HAS_ATTRIBUTE_a_normal_3f\nn=normalize(normal_3f);\n#else\nhighp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));n=normalize(cross(fdx,fdy))*-1.0;\n#endif\n#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nvec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);\n#endif\nreturn n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;\n#ifdef HAS_ATTRIBUTE_a_pbr\nmat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;\n#endif\n#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) \nvec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;\n#endif\nconst float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)\n{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)\n{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)\n{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)\n{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)\n{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)\n{\n#ifdef LIGHTING_3D_MODE\nreturn mat.diffuseColor;\n#else\nreturn mat.diffuseColor/PI;\n#endif\n}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)\n{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)\n{vec3 env_light=vec3(0.65,0.65,0.65);\n#ifdef LIGHTING_3D_MODE\nfloat ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;\n#endif\nvec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)\n{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;\n#ifdef RENDER_SHADOWS\nlighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);\n#else\nlighting_factor=NdotL;\n#endif\nvec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;\n#if !defined(LIGHTING_3D_MODE)\nconst vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);\n#endif\ncolor*=intensityFactor;return color;}void main() {\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nif (isOccluded()) {discard;}\n#endif\nvec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;\n#ifdef LIGHTING_3D_MODE\nlightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;\n#endif\nvec4 finalColor;\n#ifdef DIFFUSE_SHADED\nvec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);\n#ifdef HAS_TEXTURE_u_occlusionTexture\nfloat ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;\n#endif\nfinalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;\n#else\nMaterial mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;\n#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\n#ifdef OCCLUSION_TEXTURE_TRANSFORM\nvec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;\n#else\nvec2 uv=uv_2f;\n#endif\nao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;\n#endif\nvec4 emissive=u_emissiveFactor;\n#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)\nemissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);\n#endif\n#ifdef APPLY_LUT_ON_GPU\nfloat emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;\n#endif\ncolor+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;\n#ifdef HAS_ATTRIBUTE_a_pbr\nfloat resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;\n#ifdef APPLY_LUT_ON_GPU\ncolor_mix=applyLUT(u_lutTexture,color_mix);\n#endif\ncolor=mix(color,color_mix,min(1.0,resEmission));\n#ifdef HAS_ATTRIBUTE_a_color_4f\nfloat distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);\n#endif\n#endif\nvec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);\n#endif\n#ifdef FOG\nfinalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));\n#endif\n#ifdef RENDER_CUTOFF\nfinalColor*=v_cutoff_opacity;\n#endif\n#ifdef INDICATOR_CUTOUT\nfinalColor=applyCutout(finalColor,v_position_height.w);\n#endif\nglFragColor=finalColor;\n#ifdef OVERDRAW_INSPECTOR\nglFragColor=vec4(1.0);\n#endif\nHANDLE_WIREFRAME_DEBUG;}','#include "_prelude_fog.vertex.glsl"\n#include "_prelude_shadow.vertex.glsl"\nin vec3 a_pos_3f;\n#pragma mapbox: define-attribute highp vec3 normal_3f\n#pragma mapbox: define-attribute highp vec2 uv_2f\n#pragma mapbox: define-attribute highp vec3 color_3f\n#pragma mapbox: define-attribute highp vec4 color_4f\n#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr\n#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength\nuniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_normal_matrix;\n#endif\n#ifdef RENDER_SHADOWS\nuniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;\n#endif\nout vec4 v_position_height;out lowp vec4 v_color_mix;\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nout highp float v_depth;\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\nout lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;\n#endif\nvec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {\n#pragma mapbox: initialize-attribute highp vec3 normal_3f\n#pragma mapbox: initialize-attribute highp vec2 uv_2f\n#pragma mapbox: initialize-attribute highp vec3 color_3f\n#pragma mapbox: initialize-attribute highp vec4 color_4f\n#pragma mapbox: initialize-attribute-custom highp vec4 pbr\n#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength\nhighp mat4 normal_matrix;\n#ifdef INSTANCED_ARRAYS\nnormal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\nnormal_matrix=u_normal_matrix;\n#endif\nvec3 local_pos;mat3 rs;\n#ifdef MODEL_POSITION_ON_GPU\nvec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;\n#else\nlocal_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);\n#endif\nv_position_height.w=a_pos_3f.z;\n#ifdef HAS_ATTRIBUTE_a_pbr\nvec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;\n#endif\n#ifdef FOG\nv_fog_pos=fog_position(local_pos);\n#endif\n#ifdef RENDER_CUTOFF\nv_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);\n#endif\n#ifdef TERRAIN_FRAGMENT_OCCLUSION\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nfloat x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);\n#else\nnormal_3f=vec3(normal_matrix*vec4(normal_3f,0));\n#endif\n#endif\n#ifdef HAS_ATTRIBUTE_a_pbr\n#ifdef HAS_ATTRIBUTE_a_color_4f\nv_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);\n#endif\n#endif\n#ifdef RENDER_SHADOWS\nvec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);\n#ifdef NORMAL_OFFSET\n#ifdef HAS_ATTRIBUTE_a_normal_3f\n#ifdef MODEL_POSITION_ON_GPU\nvec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#else\nvec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();\n#endif\n#endif\n#endif\nv_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;\n#endif\n}'),modelDepth:xi("in highp float v_depth;void main() {\n#ifndef DEPTH_TEXTURE\nglFragColor=pack_depth(v_depth);\n#endif\n}","in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;\n#ifdef MODEL_POSITION_ON_GPU\n#ifdef INSTANCED_ARRAYS\nin vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;\n#else\nuniform highp mat4 u_instance;\n#endif\nuniform highp mat4 u_node_matrix;\n#endif\nvoid main() {\n#ifdef MODEL_POSITION_ON_GPU\nhighp mat4 instance;\n#ifdef INSTANCED_ARRAYS\ninstance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);\n#else\ninstance=u_instance;\n#endif\nvec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);\n#else\ngl_Position=u_matrix*vec4(a_pos_3f,1);\n#endif\nv_depth=gl_Position.z/gl_Position.w;}"),stars:xi("in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)\n{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}","\nin vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}"),snowParticle:xi("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; \nuniform float u_horizontalOscillationRate; \nuniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}"),rainParticle:xi("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}","\nin highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; \nuniform float u_velocity; \nuniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; \npos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+\nlocalY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}"),vignette:xi("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:xi("uniform vec4 u_color;void main() {glFragColor=u_color;}",'#include "_prelude_terrain.vertex.glsl"\nin highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;\n#ifdef TERRAIN\nfloat e=elevation(world_pos.xy);world_pos.z+=e;\n#endif\nvec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}')};function Io(l,t){const n=l.replace(/\s*\/\/[^\n]*\n/g,"\n").split("\n");for(let c of n)if(c=c.trim(),"#"===c[0]&&c.includes("if")&&!c.includes("endif")){c=c.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const p=c.split(" ");for(const y of p)t.includes(y)||t.push(y)}}function xi(l,t){const n=/#include\s+"([^"]+)"/g,c=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let p=t.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);p&&(p=p.map(L=>{const k=L.split(" ");return k[k.length-1]}),p=[...new Set(p)]);const y={},b=[],E=[];if(l=l.replace(n,(L,k)=>(E.push(k),"")),(t=t.replace(n,(L,k)=>(b.push(k),""))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let D=[...Ao];Io(l,D),Io(t,D);for(const L of[...b,...E])Xa[L]||console.error(`Undefined include: ${L}`),Vl[L]||(Vl[L]=[],Io(Xa[L],Vl[L])),D=[...D,...Vl[L]];return{fragmentSource:l=l.replace(c,(L,k,N,V,j)=>(y[j]=!0,"define"===k?`\n#ifndef HAS_UNIFORM_u_${j}\nin ${N} ${V} ${j};\n#else\nuniform ${N} ${V} u_${j};\n#endif\n`:"initialize"===k?`\n#ifdef HAS_UNIFORM_u_${j}\n    ${N} ${V} ${j} = u_${j};\n#endif\n`:"define-attribute"===k?`\n#ifdef HAS_ATTRIBUTE_a_${j}\n    in ${N} ${V} ${j};\n#endif\n`:"initialize-attribute"===k?"":void 0)),vertexSource:t=t.replace(c,(L,k,N,V,j)=>{const Y="float"===V?"vec2":V,Z=j.match(/color/)?"color":Y;return"define-attribute-vertex-shader-only"===k?`\n#ifdef HAS_ATTRIBUTE_a_${j}\nin ${N} ${V} a_${j};\n#endif\n`:y[j]?"define"===k?`\n#ifndef HAS_UNIFORM_u_${j}\nuniform lowp float u_${j}_t;\nin ${N} ${Y} a_${j};\nout ${N} ${V} ${j};\n#else\nuniform ${N} ${V} u_${j};\n#endif\n`:"initialize"===k?"vec4"===Z?`\n#ifndef HAS_UNIFORM_u_${j}\n    ${j} = a_${j};\n#else\n    ${N} ${V} ${j} = u_${j};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${j}\n    ${j} = unpack_mix_${Z}(a_${j}, u_${j}_t);\n#else\n    ${N} ${V} ${j} = u_${j};\n#endif\n`:"define-attribute"===k?`\n#ifdef HAS_ATTRIBUTE_a_${j}\n    in ${N} ${V} a_${j};\n    out ${N} ${V} ${j};\n#endif\n`:"initialize-attribute"===k?`\n#ifdef HAS_ATTRIBUTE_a_${j}\n    ${j} = a_${j};\n#endif\n`:void 0:"define"===k?`\n#ifndef HAS_UNIFORM_u_${j}\nuniform lowp float u_${j}_t;\nin ${N} ${Y} a_${j};\n#else\nuniform ${N} ${V} u_${j};\n#endif\n`:"define-instanced"===k?"mat4"===Z?`\n#ifdef INSTANCED_ARRAYS\nin vec4 a_${j}0;\nin vec4 a_${j}1;\nin vec4 a_${j}2;\nin vec4 a_${j}3;\n#else\nuniform ${N} ${V} u_${j};\n#endif\n`:`\n#ifdef INSTANCED_ARRAYS\nin ${N} ${Y} a_${j};\n#else\nuniform ${N} ${V} u_${j};\n#endif\n`:"initialize-attribute-custom"===k?`\n#ifdef HAS_ATTRIBUTE_a_${j}\n    ${N} ${V} ${j} = a_${j};\n#endif\n`:"vec4"===Z?`\n#ifndef HAS_UNIFORM_u_${j}\n    ${N} ${V} ${j} = a_${j};\n#else\n    ${N} ${V} ${j} = u_${j};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${j}\n    ${N} ${V} ${j} = unpack_mix_${Z}(a_${j}, u_${j}_t);\n#else\n    ${N} ${V} ${j} = u_${j};\n#endif\n`}),staticAttributes:p,usedDefines:D,vertexIncludes:b,fragmentIncludes:E}}class Uu{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,n,c,p,y,b,E,D){this.context=t;let L=this.boundPaintVertexBuffers.length!==p.length;for(let N=0;!L&&N<p.length;N++)this.boundPaintVertexBuffers[N]!==p[N]&&(L=!0);let k=this.boundDynamicVertexBuffers.length!==E.length;for(let N=0;!k&&N<E.length;N++)this.boundDynamicVertexBuffers[N]!==E[N]&&(k=!0);if(!this.vao||this.boundProgram!==n||this.boundLayoutVertexBuffer!==c||L||k||this.boundIndexBuffer!==y||this.boundVertexOffset!==b)this.freshBind(n,c,p,y,b,E,D);else{t.bindVertexArrayOES.set(this.vao);for(const N of E)N&&(N.bind(),D&&N.instanceCount&&N.setVertexAttribDivisor(t.gl,n,D));y&&y.dynamicDraw&&y.bind()}}freshBind(t,n,c,p,y,b,E){const D=t.numAttributes,L=this.context,k=L.gl;this.vao&&this.destroy(),this.vao=L.gl.createVertexArray(),L.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=n,this.boundPaintVertexBuffers=c,this.boundIndexBuffer=p,this.boundVertexOffset=y,this.boundDynamicVertexBuffers=b,n.enableAttributes(k,t),n.bind(),n.setVertexAttribPointers(k,t,y);for(const N of c)N.enableAttributes(k,t),N.bind(),N.setVertexAttribPointers(k,t,y);for(const N of b)N&&(N.enableAttributes(k,t),N.bind(),N.setVertexAttribPointers(k,t,y),E&&N.instanceCount&&N.setVertexAttribDivisor(k,t,E));p&&p.bind(),L.currentNumAttributes=D}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function Co(l,t){const n=Math.pow(2,t.canonical.z),c=t.canonical.y;return[new o.aa(0,c/n).toLngLat().lat,new o.aa(0,(c+1)/n).toLngLat().lat]}function ju(l,t,n,c,p,y,b){const E=l.context,D=E.gl,L=n.hillshadeFBO;if(!L)return;l.prepareDrawTile();const k=l.isTileAffectedByFog(t),N=l.getOrCreateProgram("hillshade",{overrideFog:k});E.activeTexture.set(D.TEXTURE0),D.bindTexture(D.TEXTURE_2D,L.colorAttachment.get());const V=((Q,J,re,he)=>{const ce=re.paint.get("hillshade-shadow-color"),ge="none"===re.paint.get("hillshade-shadow-color-use-theme").constantOr("default"),pe=re.paint.get("hillshade-highlight-color"),_e="none"===re.paint.get("hillshade-highlight-color-use-theme").constantOr("default"),de=re.paint.get("hillshade-accent-color"),be="none"===re.paint.get("hillshade-accent-color-use-theme").constantOr("default"),Ee=re.paint.get("hillshade-emissive-strength");let qe=o.ai(re.paint.get("hillshade-illumination-direction"));if("viewport"===re.paint.get("hillshade-illumination-anchor"))qe-=Q.transform.angle;else if(Q.style&&Q.style.enable3dLights()&&Q.style.directionalLight){const Ye=Q.style.directionalLight.properties.get("direction"),Xe=o.cb(Ye.x,Ye.y,Ye.z);qe=o.ai(Xe[1])}const Le=!Q.options.moving;return{u_matrix:he||Q.transform.calculateProjMatrix(J.tileID.toUnwrapped(),Le),u_image:0,u_latrange:Co(0,J.tileID),u_light:[re.paint.get("hillshade-exaggeration"),qe],u_shadow:ce.toRenderColor(ge?null:re.lut),u_highlight:pe.toRenderColor(_e?null:re.lut),u_emissive_strength:Ee,u_accent:de.toRenderColor(be?null:re.lut)}})(l,n,c,l.terrain?t.projMatrix:null);l.uploadCommonUniforms(E,N,t.toUnwrapped());const{tileBoundsBuffer:j,tileBoundsIndexBuffer:Y,tileBoundsSegments:Z}=l.getTileBoundsBuffers(n);N.draw(l,D.TRIANGLES,p,y,b,Wt.disabled,V,c.id,j,Y,Z)}function Gu(l,t,n){if(!t.needsDEMTextureUpload)return;const c=l.context,p=c.gl;c.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||l.getTileTexture(n.stride);const y=n.getPixels();t.demTexture?t.demTexture.update(y,{premultiply:!1}):t.demTexture=new o.T(c,y,p.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function Rd(l,t,n){const c=l.context,p=c.gl;if(!t.dem)return;const y=t.dem;if(c.activeTexture.set(p.TEXTURE1),Gu(l,t,y),!t.demTexture)return;t.demTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE);const b=y.dim;c.activeTexture.set(p.TEXTURE0);let E=t.hillshadeFBO;if(!E){const V=new o.T(c,{width:b,height:b,data:null},p.RGBA8);V.bind(p.LINEAR,p.CLAMP_TO_EDGE),E=t.hillshadeFBO=c.createFramebuffer(b,b,!0,"renderbuffer"),E.colorAttachment.set(V.texture)}c.bindFramebuffer.set(E.framebuffer),c.viewport.set([0,0,b,b]);const{tileBoundsBuffer:D,tileBoundsIndexBuffer:L,tileBoundsSegments:k}=l.getMercatorTileBoundsBuffers(),N=[];l.linearFloatFilteringSupported()&&N.push("TERRAIN_DEM_FLOAT_FORMAT"),l.getOrCreateProgram("hillshadePrepare",{defines:N}).draw(l,p.TRIANGLES,zt.disabled,qt.disabled,li.unblended,Wt.disabled,((V,j)=>{const Y=j.stride,Z=o.ab.mat4.create();return o.ab.mat4.ortho(Z,0,o.ag,-o.ag,0,0,1),o.ab.mat4.translate(Z,Z,[0,-o.ag,0]),{u_matrix:Z,u_image:1,u_dimension:[Y,Y],u_zoom:V.overscaledZ}})(t.tileID,y),n.id,D,L,k),t.needsHillshadePrepare=!1}class tn{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Mc extends tn{getDefault(){return o.aj.transparent}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Gl extends tn{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Nh extends tn{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class Vh extends tn{getDefault(){return[!0,!0,!0,!0]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Ka extends tn{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class Ec extends tn{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class qu extends tn{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const n=this.current;(t.func!==n.func||t.ref!==n.ref||t.mask!==n.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class ql extends tn{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class as extends tn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.STENCIL_TEST):n.disable(n.STENCIL_TEST),this.current=t,this.dirty=!1}}class Hu extends tn{getDefault(){return[0,1]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class Br extends tn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),this.current=t,this.dirty=!1}}class Uh extends tn{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class Ac extends tn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.BLEND):n.disable(n.BLEND),this.current=t,this.dirty=!1}}class Ic extends tn{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Cc extends tn{getDefault(){return o.aj.transparent}set(t){const n=this.current;(t.r!==n.r||t.g!==n.g||t.b!==n.b||t.a!==n.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Pc extends tn{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class Ja extends tn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;t?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),this.current=t,this.dirty=!1}}class jh extends tn{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Gh extends tn{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let Dc=class extends tn{getDefault(){return null}set(l){(l!==this.current||this.dirty)&&(this.gl.useProgram(l),this.current=l,this.dirty=!1)}};class qh extends tn{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class Wu extends tn{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const n=this.current;(t[0]!==n[0]||t[1]!==n[1]||t[2]!==n[2]||t[3]!==n[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class oa extends tn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindFramebuffer(n.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Ld extends tn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindRenderbuffer(n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class kd extends tn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindTexture(n.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class Od extends tn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.bindBuffer(n.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Fd extends tn{getDefault(){return null}set(t){const n=this.gl;n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class Hh extends tn{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class Bd extends tn{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class zc extends tn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class $u extends tn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const n=this.gl;n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Wh extends tn{constructor(t,n){super(t),this.context=t,this.parent=n}getDefault(){return null}}class Hl extends Wh{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class $h extends Wh{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferRenderbuffer(n.FRAMEBUFFER,this.attachment(),n.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Po extends Wh{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const n=this.gl;n.framebufferTexture2D(n.FRAMEBUFFER,this.attachment(),n.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class Rc extends $h{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Zh=(l,t,n)=>({u_matrix:l,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:n}),Do=(l,t,n,c,p,y,b,E,D,L,k,N,V,j,Y,Z)=>({u_proj_matrix:Float32Array.from(l),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(c),u_merc_matrix:n,u_zoom_transition:p,u_merc_center:y,u_image0:0,u_frustum_tl:b,u_frustum_tr:E,u_frustum_br:D,u_frustum_bl:L,u_globe_pos:k,u_globe_radius:N,u_viewport:V,u_grid_matrix:Z?Float32Array.from(Z):new Float32Array(9),u_skirt_height:j,u_far_z_cutoff:Y});function aa(l,t){return null!=l&&null!=t&&!(!l.hasData()||!t.hasData())&&null!=l.demTexture&&null!=t.demTexture&&l.tileID.key!==t.tileID.key}const $r=new class{constructor(){this.operations={}}newMorphing(l,t,n,c,p){if(l in this.operations){const y=this.operations[l];y.to.tileID.key!==n.tileID.key&&(y.queued=n)}else this.operations[l]={startTime:c,phase:0,duration:p,from:t,to:n,queued:null}}getMorphValuesForProxy(l){if(!(l in this.operations))return null;const t=this.operations[l];return{from:t.from,to:t.to,phase:t.phase}}update(l){for(const t in this.operations){const n=this.operations[t];for(n.phase=(l-n.startTime)/n.duration;n.phase>=1||!this._validOp(n);)if(!this._nextOp(n,l)){delete this.operations[t];break}}}_nextOp(l,t){return!!l.queued&&(l.from=l.to,l.to=l.queued,l.queued=null,l.phase=0,l.startTime=t,!0)}_validOp(l){return l.from.hasData()&&l.to.hasData()}},Qa={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Wl(l,t,n){if(0===t)return 0;const c=t<1&&514===n?.25/t:1;return 6*Math.pow(1.5,22-l)*Math.max(t,1)*c}function Zu(l,t){const n=1<<l.z;return!t&&(0===l.x||l.x===n-1)||0===l.y||l.y===n-1}const el=l=>({u_matrix:l});function tl(l,t,n,c,p){if(p>0){const y=o.q.now(),b=(y-l.timeAdded)/p,E=t?(y-t.timeAdded)/p:-1,D=n.getSource(),L=c.coveringZoomLevel({tileSize:D.tileSize,roundZoom:D.roundZoom}),k=!t||Math.abs(t.tileID.overscaledZ-L)>Math.abs(l.tileID.overscaledZ-L),N=k&&l.refreshedUponExpiration?1:o.aw(k?b:1-E,0,1);return l.refreshedUponExpiration&&b>=1&&(l.refreshedUponExpiration=!1),t?{opacity:1,mix:1-N}:{opacity:N,mix:0}}return{opacity:1,mix:0}}class Xh extends ss{constructor(t){const n={type:"raster-dem",maxzoom:t.transform.maxZoom},c=new o.D(o.ci(),null),p=ar("mock-dem",n,c,t.style);super("mock-dem",p,!1),p.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,n){t.state="loaded",n(null)}}class Xu extends ss{constructor(t){const n=ar("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},new o.D(o.ci(),null),t.style);super("proxy",n,!1),n.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,n,c){if(t.freezeTileCoverage)return;this.transform=t;const p=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((y,b)=>{if(y[b.key]="",!this._tiles[b.key]){const E=new rs(b,this._source.tileSize*b.overscaleFactor(),t.tileZoom);E.state="loaded",this._tiles[b.key]=E}return y},{});for(const y in this._tiles)y in p||(this.freeFBO(y),this._tiles[y].unloadVectorData(),delete this._tiles[y])}freeFBO(t){const n=this.proxyCachedFBO[t];if(void 0!==n){const c=Object.values(n);this.renderCachePool.push(...c),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach(t=>t.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class la extends o.aG{constructor(t,n,c){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=n,this.projMatrix=c}}class ca extends o.cJ{constructor(t,n){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},()=>{this._style.map.triggerRepaint()}),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()}),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[c,p,y]=function(){const L=new o.b4,k=new o.aU,N=131;L.reserve(17161),k.reserve(33800);const V=o.ag/128,j=o.ag+V/2,Y=j+V;for(let Q=-V;Q<Y;Q+=V)for(let J=-V;J<Y;J+=V){const re=J<0||J>j||Q<0||Q>j?24575:0,he=o.aw(Math.round(J),0,o.ag),ce=o.aw(Math.round(Q),0,o.ag);L.emplaceBack(he+re,ce)}const Z=(Q,J)=>{const re=J*N+Q;k.emplaceBack(re+1,re,re+N),k.emplaceBack(re+N,re+N+1,re+1)};for(let Q=1;Q<129;Q++)for(let J=1;J<129;J++)Z(J,Q);return[0,129].forEach(Q=>{for(let J=0;J<130;J++)Z(J,Q),Z(Q,J)}),[L,k,32768]}(),b=t.context;this.gridBuffer=b.createVertexBuffer(c,o.b6.members),this.gridIndexBuffer=b.createIndexBuffer(p),this.gridSegments=o.b7.simpleSegment(0,0,c.length,p.length),this.gridNoSkirtSegments=o.b7.simpleSegment(0,0,c.length,y),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new Xu(n.map),this.orthoMatrix=o.ab.mat4.create(),o.ab.mat4.ortho(this.orthoMatrix,"globe"===this.painter.transform.projection.name?.015:0,o.ag,0,o.ag,0,1);const E=b.gl;this._overlapStencilMode=new qt({func:E.GEQUAL,mask:255},0,255,E.KEEP,E.KEEP,E.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=n,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Xh(n.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",()=>{this._clearLineLayersFromRenderCache()})}update(t,n,c){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const p=t.terrain.properties,y=0===t.terrain.drapeRenderMode,b=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=o.q.now();const E=t.terrain&&t.terrain.scope,D=p.get("source"),L=y?this._mockSourceCache:t.getSourceCache(D,E);if(!L)return void o.w(`Couldn't find terrain source "${D}".`);if(this.sourceCache=L,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=b?this.calculateExaggeration(n):p.get("exaggeration"),!n.projection.requiresDraping&&b&&0===this._exaggeration)return void this._disable();this.enabled=!0;const k=()=>{this.sourceCache.used&&o.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const N=this.getScaledDemTileSize();this.sourceCache.update(n,N,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,k(),this._initializing=!0),k(),n.updateElevation(!0,c),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(n),this._emptyDEMTextureDirty=!0,this._previousZoom=n.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);const n=this._previousCameraAltitude,c=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=c;const p=null!=n?c-n:Number.MAX_VALUE;if(Math.abs(p)<2)return this._exaggeration;const y=t.zoom,b=this._style.terrain;if(!this._previousUpdateTimestamp)return b.getExaggeration(y);let E=y-this._previousZoom;const D=this._previousUpdateTimestamp;let L=y;null!=this._evaluationZoom&&(L=this._evaluationZoom,Math.abs(y-L)>.5&&(E=.5*(y-L+E)),E*p<0&&(L+=E)),this._evaluationZoom=L;const k=b.getExaggeration(L),N=k===b.getExaggeration(Math.max(0,L-.1));if(N&&Math.abs(k-this._exaggeration)<.01)return k;let V=Math.min(.1,.00375*(this._updateTimestamp-D));return(N||k<.1||Math.abs(E)<1e-4)&&(V=Math.min(.2,4*V)),o.af(this._exaggeration,k,V)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.coord&&"source"===t.dataType?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):"style"===t.dataType&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach(t=>t.fb.destroy()),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const n=this.proxySourceCache,c=this.painter.transform;this._initializing&&(this._initializing=0===c._centerAltitude&&-1===this.getAtPointOrZero(o.aa.fromLngLat(c.center),-1),this._emptyDEMTextureDirty=!this._initializing);const p=this.proxyCoords=n.getIds().map(D=>{const L=n.getTileByID(D).tileID;return L.projMatrix=c.calculateProjMatrix(L.toUnwrapped()),L});!function(D,L){const k=L.transform.pointCoordinate(L.transform.getCameraPoint()),N=new o.P(k.x,k.y);D.sort((V,j)=>{if(j.overscaledZ-V.overscaledZ)return j.overscaledZ-V.overscaledZ;const Y=new o.P(V.canonical.x+(1<<V.canonical.z)*V.wrap,V.canonical.y),Z=new o.P(j.canonical.x+(1<<j.canonical.z)*j.wrap,j.canonical.y),Q=N.mult(1<<V.canonical.z);return Q.x-=.5,Q.y-=.5,Q.distSqr(Y)-Q.distSqr(Z)})}(p,this.painter);const y=this.proxyToSource||{};this.proxyToSource={},p.forEach(D=>{this.proxyToSource[D.key]={}}),this.terrainTileForTile={};const b=this._style._mergedSourceCaches;for(const D in b){const L=b[D];if(!L.used||(L!==this.sourceCache&&this.resetTileLookupCache(L.id),this._setupProxiedCoordsForOrtho(L,t[D],y),L.usedForTerrain))continue;const k=t[D];L.getSource().reparseOverscaled&&this._assignTerrainTiles(k)}this.proxiedCoords[n.id]=p.map(D=>new la(D,D.key,this.orthoMatrix)),this._assignTerrainTiles(p),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(y),this.renderingToTexture=!1;const E={};this._visibleDemTiles=[];for(const D of this.proxyCoords){const L=this.terrainTileForTile[D.key];if(!L)continue;const k=L.tileID.key;k in E||(this._visibleDemTiles.push(L),E[k]=k)}}_assignTerrainTiles(t){this._initializing||t.forEach(n=>{if(this.terrainTileForTile[n.key])return;const c=this._findTileCoveringTileID(n,this.sourceCache);c&&(this.terrainTileForTile[n.key]=c)})}_prepareDEMTextures(){const t=this.painter.context,n=t.gl;for(const c in this.terrainTileForTile){const p=this.terrainTileForTile[c],y=p.dem;!y||p.demTexture&&!p.needsDEMTextureUpload||(t.activeTexture.set(n.TEXTURE1),Gu(this.painter,p,y))}}_prepareDemTileUniforms(t,n,c,p){if(!n||null==n.demTexture)return!1;const y=t.tileID.canonical,b=Math.pow(2,n.tileID.canonical.z-y.z),E=p||"";return c[`u_dem_tl${E}`]=[y.x*b%1,y.y*b%1],c[`u_dem_scale${E}`]=b,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0;const n=this._visibleDemTiles.reduce((c,p)=>{if(!p.dem)return c;const y=p.dem.tree.minimums[0];return y>0&&t++,c+y},0);return t?n/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,n=t.gl;t.activeTexture.set(n.TEXTURE2);const c=this._getLoadedAreaMinimum(),p=new o.cK({width:1,height:1},new Float32Array([c]));this._emptyDEMTextureDirty=!1;let y=this._emptyDEMTexture;return y?y.update(p,{premultiply:!1}):y=this._emptyDEMTexture=new o.T(t,p,n.R32F,{premultiply:!1}),y}setupElevationDraw(t,n,c){const p=this.painter.context,y=p.gl,b={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};b.u_exaggeration=this.exaggeration();let E=null,D=null,L=1;if(c&&c.morphing&&this._useVertexMorphing){const j=c.morphing.srcDemTile,Y=c.morphing.dstDemTile;L=c.morphing.phase,j&&Y&&(this._prepareDemTileUniforms(t,j,b,"_prev")&&(D=j),this._prepareDemTileUniforms(t,Y,b)&&(E=Y))}const k=j=>j&&j.demTexture&&this.painter.linearFloatFilteringSupported()?y.LINEAR:y.NEAREST;let N=null;var V;if(this.enabled?D&&E?(N=E.demTexture,p.activeTexture.set(y.TEXTURE4),D.demTexture.bind(k(D),y.CLAMP_TO_EDGE),b.u_dem_lerp=L):(E=this.terrainTileForTile[t.tileID.key],N=this._prepareDemTileUniforms(t,E,b)?E.demTexture:this.emptyDEMTexture):N=this.emptyDEMTexture,p.activeTexture.set(y.TEXTURE2),N&&(b.u_dem_size=1===(V=N).size[0]?1:V.size[0]-2,N.bind(k(E),y.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(c&&c.useDepthForOcclusion,n,b),c&&c.useMeterToDem&&E){const j=(1<<E.tileID.canonical.z)*o.bH(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;b.u_meter_to_dem=j}if(c&&c.labelPlaneMatrixInv&&(b.u_label_plane_matrix_inv=c.labelPlaneMatrixInv),n.setTerrainUniformValues(p,b),"globe"===this.painter.transform.projection.name){const j=this.globeUniformValues(this.painter.transform,t.tileID.canonical,c&&c.useDenormalizedUpVectorScale);n.setGlobeUniformValues(p,j)}}globeUniformValues(t,n,c){const p=t.projection;return{u_tile_tl_up:p.upVector(n,0,0),u_tile_tr_up:p.upVector(n,o.ag,0),u_tile_br_up:p.upVector(n,o.ag,o.ag),u_tile_bl_up:p.upVector(n,0,o.ag),u_tile_up_scale:c?o.cL(1):p.upVectorScale(n,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const n=this.painter,c=this.painter.context;0!==t.length&&(c.bindFramebuffer.set(null),c.viewport.set([0,0,n.width,n.height]),n.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,function(p,y,b,E,D){if("globe"===p.transform.projection.name)!function(L,k,N,V,j){const Y=L.context,Z=Y.gl;let Q,J;const re=L.transform,he=o.cC(L,Y,re),ce=(Ye,Xe)=>{if(J===Xe)return;const Re=[Qa[Xe],"PROJECTION_GLOBE_VIEW"];he&&Re.push("CUSTOM_ANTIALIASING");const He=L.isTileAffectedByFog(Ye);Q=L.getOrCreateProgram("globeRaster",{defines:Re,overrideFog:He}),J=Xe},ge=L.colorModeForRenderPass(),pe=new zt(Z.LEQUAL,zt.ReadWrite,L.depthRangeFor3D);$r.update(j);const _e=o.cD(re),de=[o.at(re.center.lng),o.aA(re.center.lat)],be=L.globeSharedBuffers,Ee=[re.width*o.q.devicePixelRatio,re.height*o.q.devicePixelRatio],qe=Float32Array.from(re.globeMatrix),Le={useDenormalizedUpVectorScale:!0};{const Ye=L.transform,Xe=Wl(Ye.zoom,k.exaggeration(),k.sourceCache._source.tileSize);J=-1;const Re=Z.TRIANGLES;for(const He of V){const it=N.getTile(He),De=qt.disabled,Je=k.prevTerrainTileForTile[He.key],We=k.terrainTileForTile[He.key];aa(Je,We)&&$r.newMorphing(He.key,Je,We,j,250),Y.activeTexture.set(Z.TEXTURE0),it.texture&&it.texture.bind(Z.LINEAR,Z.CLAMP_TO_EDGE);const ut=$r.getMorphValuesForProxy(He.key),et=ut?1:0;ut&&o.J(Le,{morphing:{srcDemTile:ut.from,dstDemTile:ut.to,phase:o.cB(ut.phase)}});const Ke=o.cE(He.canonical),rt=o.cF(Ke.getCenter().lat),ct=o.cG(He.canonical,Ke,rt,Ye.worldSize/Ye._pixelsPerMercatorPixel),_t=o.bb(o.cH(He.canonical)),Tt=Do(Ye.expandedFarZProjMatrix,qe,_e,_t,o.ae(Ye.zoom),de,Ye.frustumCorners.TL,Ye.frustumCorners.TR,Ye.frustumCorners.BR,Ye.frustumCorners.BL,Ye.globeCenterInViewSpace,Ye.globeRadius,Ee,Xe,Ye._farZ,ct);if(ce(He,et),Q&&(k.setupElevationDraw(it,Q,Le),L.uploadCommonUniforms(Y,Q,He.toUnwrapped()),be)){const[jt,Lt,kt]=be.getGridBuffers(rt,0!==Xe);Q.draw(L,Re,pe,De,ge,Wt.backCCW,Tt,"globe_raster",jt,Lt,kt)}}}if(be&&(L.renderDefaultNorthPole||L.renderDefaultSouthPole)){const Ye=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];he&&Ye.push("CUSTOM_ANTIALIASING"),Q=L.getOrCreateProgram("globeRaster",{defines:Ye});for(const Xe of V){const{x:Re,y:He,z:it}=Xe.canonical,De=0===He,Je=He===(1<<it)-1,[We,ut,et,Ke]=be.getPoleBuffers(it,!1);if(Ke&&(De||Je)){const rt=N.getTile(Xe);Y.activeTexture.set(Z.TEXTURE0),rt.texture&&rt.texture.bind(Z.LINEAR,Z.CLAMP_TO_EDGE);let ct=o.cI(it,Re,re);const _t=o.bb(o.cH(Xe.canonical)),Tt=(jt,Lt)=>jt.draw(L,Z.TRIANGLES,pe,qt.disabled,ge,Wt.disabled,Do(re.expandedFarZProjMatrix,ct,ct,_t,0,de,re.frustumCorners.TL,re.frustumCorners.TR,re.frustumCorners.BR,re.frustumCorners.BL,re.globeCenterInViewSpace,re.globeRadius,Ee,0,re._farZ),"globe_pole_raster",Lt,et,Ke);k.setupElevationDraw(rt,Q,Le),L.uploadCommonUniforms(Y,Q,Xe.toUnwrapped()),De&&L.renderDefaultNorthPole&&Tt(Q,We),Je&&L.renderDefaultSouthPole&&(ct=o.ab.mat4.scale(o.ab.mat4.create(),ct,[1,-1,1]),Tt(Q,ut))}}}}(p,y,b,E,D);else{const L=p.context,k=L.gl;let N,V;const j=p.shadowRenderer,Y=To(p,p.longestCutoffRange),Z=ge=>{if(V===ge)return;const pe=[];pe.push(Qa[ge]),Y.shouldRenderCutoff&&pe.push("RENDER_CUTOFF"),j&&(pe.push("RENDER_SHADOWS","DEPTH_TEXTURE"),j.useNormalOffset&&pe.push("NORMAL_OFFSET")),N=p.getOrCreateProgram("terrainRaster",{defines:pe}),V=ge},Q=p.colorModeForRenderPass(),J=new zt(k.LEQUAL,zt.ReadWrite,p.depthRangeFor3D);$r.update(D);const re=p.transform,he=Wl(re.zoom,y.exaggeration(),y.sourceCache._source.tileSize);let ce=[0,0,0];if(j){const ge=p.style.directionalLight,pe=p.style.ambientLight;ge&&pe&&(ce=Dh(p.style,ge,pe))}{V=-1;const ge=k.TRIANGLES,[pe,_e]=[y.gridIndexBuffer,y.gridSegments];for(const de of E){const be=b.getTile(de),Ee=qt.disabled,qe=y.prevTerrainTileForTile[de.key],Le=y.terrainTileForTile[de.key];aa(qe,Le)&&$r.newMorphing(de.key,qe,Le,D,250),L.activeTexture.set(k.TEXTURE0),be.texture&&be.texture.bind(k.LINEAR,k.CLAMP_TO_EDGE);const Ye=$r.getMorphValuesForProxy(de.key),Xe=Ye?1:0;let Re;Ye&&(Re={morphing:{srcDemTile:Ye.from,dstDemTile:Ye.to,phase:o.cB(Ye.phase)}});const He=Zh(de.projMatrix,Zu(de.canonical,re.renderWorldCopies)?he/10:he,ce);if(Z(Xe),!N)continue;y.setupElevationDraw(be,N,Re);const it=de.toUnwrapped();j&&j.setupShadows(it,N),p.uploadCommonUniforms(L,N,it,null,Y),N.draw(p,ge,J,Ee,Q,Wt.backCCW,He,"terrain_raster",y.gridBuffer,pe,_e)}}}}(n,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,n.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(0===this._drapedRenderBatches.length)return t+1;this.renderingToTexture=!0;const n=this.painter,c=this.painter.context,p=this.proxySourceCache,y=this.proxiedCoords[p.id],b=this._drapedRenderBatches.shift(),E=n.style.order,D=[];let L=0;for(const k of y){const N=p.getTileByID(k.proxyTileKey),V=p.proxyCachedFBO[k.key]?p.proxyCachedFBO[k.key][t]:void 0,j=void 0!==V?p.renderCache[V]:this.pool[L++],Y=void 0!==V;if(N.texture=j.tex,Y&&!j.dirty){D.push(N.tileID);continue}let Z;c.bindFramebuffer.set(j.fb.framebuffer),this.renderedToTile=!1,j.dirty&&(c.clear({color:o.aj.transparent,stencil:0}),j.dirty=!1);for(let Q=b.start;Q<=b.end;++Q){const J=n.style._mergedLayers[E[Q]];if(J.isHidden(n.transform.zoom))continue;const re=n.style.getLayerSourceCache(J),he=re?this.proxyToSource[k.key][re.id]:[k];if(!he)continue;const ce=he;c.viewport.set([0,0,j.fb.width,j.fb.height]),Z!==(re?re.id:null)&&(this._setupStencil(j,he,J,re),Z=re?re.id:null),n.renderLayer(n,re,J,ce)}if(0===this._drapedRenderBatches.length)for(const Q of this._pendingGroundEffectLayers){const J=n.style._mergedLayers[E[Q]];if(J.isHidden(n.transform.zoom))continue;const re=n.style.getLayerSourceCache(J),he=re?this.proxyToSource[k.key][re.id]:[k];if(!he)continue;const ce=he;c.viewport.set([0,0,j.fb.width,j.fb.height]),Z!==(re?re.id:null)&&(this._setupStencil(j,he,J,re),Z=re?re.id:null),n.renderLayer(n,re,J,ce)}this.renderedToTile?(j.dirty=!0,D.push(N.tileID)):Y||--L,5===L&&(L=0,this.renderToBackBuffer(D))}return this.renderToBackBuffer(D),this.renderingToTexture=!1,c.bindFramebuffer.set(null),c.viewport.set([0,0,n.width,n.height]),b.end+1}postRender(){}isLayerOrderingCorrect(t){const n=t.order.length;let c=-1,p=n;for(let y=0;y<n;++y)this._style.isLayerDraped(t._mergedLayers[t.order[y]])?c=Math.max(c,y):p=Math.min(p,y);return p>c}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter(n=>n.dem).forEach(n=>{t=Math.min(t,n.dem.tree.minimums[0])}),0===t?t:(t-30)*this._exaggeration}raycast(t,n,c){if(!this._visibleDemTiles)return null;const p=this._visibleDemTiles.filter(y=>y.dem).map(y=>{const b=y.tileID,E=1<<b.overscaledZ,{x:D,y:L}=b.canonical,k=D/E,N=(D+1)/E,V=L/E,j=(L+1)/E;return{minx:k,miny:V,maxx:N,maxy:j,t:y.dem.tree.raycastRoot(k,V,N,j,t,n,c),tile:y}});p.sort((y,b)=>(null!==y.t?y.t:Number.MAX_VALUE)-(null!==b.t?b.t:Number.MAX_VALUE));for(const y of p){if(null==y.t)return null;const b=y.tile.dem.tree.raycast(y.minx,y.miny,y.maxx,y.maxy,t,n,c);if(null!=b)return b}return null}_createFBO(){const t=this.painter.context,n=t.gl,c=this.drapeBufferSize;t.activeTexture.set(n.TEXTURE0);const p=new o.T(t,{width:c[0],height:c[1],data:null},n.RGBA8);p.bind(n.LINEAR,n.CLAMP_TO_EDGE);const y=t.createFramebuffer(c[0],c[1],!0,null);return y.colorAttachment.set(p.texture),y.depthAttachment=new Rc(t,y.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,c[0],c[1]),this._stencilRef=0,y.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):y.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&n.texParameterf(n.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:y,tex:p,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some(t=>{const n=this._style._mergedLayers[t],c=n.isHidden(this.painter.transform.zoom);return"hillshade"===n.type||"custom"===n.type?!c&&n.shouldRedrape():!c&&n.hasTransition()})}_clearLineLayersFromRenderCache(){let t=!1;for(const c of this._style.getSources())if(c instanceof yn){t=!0;break}if(!t)return;const n={};for(let c=0;c<this._style.order.length;++c){const p=this._style._mergedLayers[this._style.order[c]],y=this._style.getLayerSourceCache(p);if(y&&!n[y.id]&&!p.isHidden(this.painter.transform.zoom)&&"line"===p.type&&p.widthExpression()instanceof o.a9){n[y.id]=!0;for(const b of this.proxyCoords){const E=this.proxyToSource[b.key][y.id];if(E)for(const D of E)this._clearRenderCacheForTile(y.id,D)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const c in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[c]._source instanceof ir){t=!0;break}if(!t)return;const n={};for(let c=0;c<this._style.order.length;++c){const p=this._style._mergedLayers[this._style.order[c]],y=this._style.getLayerSourceCache(p);if(!y||n[y.id]||p.isHidden(this.painter.transform.zoom)||"raster"!==p.type)continue;const b=p.paint.get("raster-fade-duration");for(const E of this.proxyCoords){const D=this.proxyToSource[E.key][y.id];if(D)for(const L of D){const k=tl(y.getTile(L),y.findLoadedParent(L,0),y,this.painter.transform,b);(1!==k.opacity||0!==k.mix)&&this._clearRenderCacheForTile(y.id,L)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const t=this._style.order,n=t.length;if(0===n)return;const c=[];this._pendingGroundEffectLayers=[];let p,y=0,b=this._style._mergedLayers[t[y]];for(;!this._style.isLayerDraped(b)&&b.isHidden(this.painter.transform.zoom)&&++y<n;)b=this._style._mergedLayers[t[y]];for(;y<n;++y){const E=this._style._mergedLayers[t[y]];E.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(E)?void 0===p&&(p=y):("fill-extrusion"===E.type&&this._pendingGroundEffectLayers.push(y),void 0!==p&&(c.push({start:p,end:y-1}),p=void 0)))}if(void 0!==p&&c.push({start:p,end:y-1}),0!==c.length){const E=c[c.length-1];this._pendingGroundEffectLayers.every(D=>D>E.end)||o.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=c}_setupRenderCache(t){const n=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,n.renderCache.length>n.renderCachePool.length){const b=Object.values(n.proxyCachedFBO);n.proxyCachedFBO={};for(let E=0;E<b.length;++E){const D=Object.values(b[E]);n.renderCachePool.push(...D)}}return}this._clearRasterLayersFromRenderCache();const c=this.proxyCoords,p=this._tilesDirty;for(let b=c.length-1;b>=0;b--){const E=c[b];if(n.getTileByID(E.key),void 0!==n.proxyCachedFBO[E.key]){const D=t[E.key],L=this.proxyToSource[E.key];let k=0;for(const N in L){const V=L[N],j=D[N];if(!j||j.length!==V.length||V.some((Y,Z)=>Y!==j[Z]||p[N]&&p[N].hasOwnProperty(Y.key))){k=-1;break}++k}for(const N in n.proxyCachedFBO[E.key])n.renderCache[n.proxyCachedFBO[E.key][N]].dirty=k<0||k!==Object.values(D).length}}const y=[...this._drapedRenderBatches];y.sort((b,E)=>E.end-E.start-(b.end-b.start));for(const b of y)for(const E of c){if(n.proxyCachedFBO[E.key])continue;let D=n.renderCachePool.pop();void 0===D&&n.renderCache.length<50&&(D=n.renderCache.length,n.renderCache.push(this._createFBO())),void 0!==D&&(n.proxyCachedFBO[E.key]={},n.proxyCachedFBO[E.key][b.start]=D,n.renderCache[D].dirty=!0)}this._tilesDirty={}}_setupStencil(t,n,c,p){if(!p||!this._sourceTilesOverlap[p.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const y=this.painter.context,b=y.gl;if(n.length<=1)return void(this._overlapStencilType=!1);let E;if(c.isTileClipped())E=n.length,this._overlapStencilMode.test={func:b.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(n[0].overscaledZ>n[n.length-1].overscaledZ))return void(this._overlapStencilType=!1);E=1,this._overlapStencilMode.test={func:b.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+E>255&&(y.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=E,this._overlapStencilMode.ref=this._stencilRef,c.isTileClipped()&&this._renderTileClippingMasks(n,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return"Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):qt.disabled}_renderTileClippingMasks(t,n){const c=this.painter,p=this.painter.context,y=p.gl;c._tileClippingMaskIDs={},p.setColorMode(li.disabled),p.setDepthMode(zt.disabled);const b=c.getOrCreateProgram("clippingMask");for(const E of t){const D=c._tileClippingMaskIDs[E.key]=--n;b.draw(c,y.TRIANGLES,zt.disabled,new qt({func:y.ALWAYS,mask:0},D,255,y.KEEP,y.KEEP,y.REPLACE),li.disabled,Wt.disabled,el(E.projMatrix),"$clipping",c.tileExtentBuffer,c.quadTriangleIndexBuffer,c.tileExtentSegments)}}pointCoordinate(t){const n=this.painter.transform;if(t.x<0||t.x>n.width||t.y<0||t.y>n.height)return null;const c=[t.x,t.y,1,1];o.ab.vec4.transformMat4(c,c,n.pixelMatrixInverse),o.ab.vec4.scale(c,c,1/c[3]),c[0]/=n.worldSize,c[1]/=n.worldSize;const p=n._camera.position,y=o.bH(1,n.center.lat),b=[p[0],p[1],p[2]/y,0],E=o.ab.vec3.subtract([],c.slice(0,3),b);o.ab.vec3.normalize(E,E);const D=this.raycast(b,E,this._exaggeration);return null!==D&&D?(o.ab.vec3.scaleAndAdd(b,b,E,D),b[3]=b[2],b[2]*=y,b):null}_setupProxiedCoordsForOrtho(t,n,c){if(t.getSource()instanceof o.aJ)return this._setupProxiedCoordsForImageSource(t,n,c);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const p=this.proxiedCoords[t.id]=[],y=this.proxyCoords;for(let D=0;D<y.length;D++){const L=y[D],k=this._findTileCoveringTileID(L,t);if(k){const N=this._createProxiedId(L,k,c[L.key]&&c[L.key][t.id]);p.push(N),this.proxyToSource[L.key][t.id]=[N]}}let b=!1;const E=new Set;for(let D=0;D<n.length;D++){const L=t.getTile(n[D]);if(!L||!L.hasData())continue;const k=this._findTileCoveringTileID(L.tileID,this.proxySourceCache);if(k&&k.tileID.canonical.z!==L.tileID.canonical.z){const N=this.proxyToSource[k.tileID.key][t.id],V=this._createProxiedId(k.tileID,L,c[k.tileID.key]&&c[k.tileID.key][t.id]);N?N.splice(N.length-1,0,V):this.proxyToSource[k.tileID.key][t.id]=[V];const j=this.proxyToSource[k.tileID.key][t.id];E.has(j)||E.add(j),p.push(V),b=!0}}if(this._sourceTilesOverlap[t.id]=b,b&&this._debugParams.sortTilesHiZFirst)for(const D of E)D.sort((L,k)=>k.overscaledZ-L.overscaledZ)}_setupProxiedCoordsForImageSource(t,n,c){if(!t.getSource().loaded())return;const p=this.proxiedCoords[t.id]=[],y=this.proxyCoords,b=t.getSource(),E=b.tileID;if(!E)return;const D=new o.P(E.x,E.y)._div(1<<E.z),L=b.coordinates.map(o.aa.fromLngLat).reduce((N,V)=>(N.min.x=Math.min(N.min.x,V.x-D.x),N.min.y=Math.min(N.min.y,V.y-D.y),N.max.x=Math.max(N.max.x,V.x-D.x),N.max.y=Math.max(N.max.y,V.y-D.y),N),{min:new o.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new o.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),k=(N,V)=>{const j=N.wrap+N.canonical.x/(1<<N.canonical.z),Y=N.canonical.y/(1<<N.canonical.z),Z=o.ag/(1<<N.canonical.z),Q=V.wrap+V.canonical.x/(1<<V.canonical.z),J=V.canonical.y/(1<<V.canonical.z);return j+Z<Q+L.min.x||j>Q+L.max.x||Y+Z<J+L.min.y||Y>J+L.max.y};for(let N=0;N<y.length;N++){const V=y[N];for(let j=0;j<n.length;j++){const Y=t.getTile(n[j]);if(!Y||!Y.hasData()||k(V,Y.tileID))continue;const Z=this._createProxiedId(V,Y,c[V.key]&&c[V.key][t.id]),Q=this.proxyToSource[V.key][t.id];Q?Q.push(Z):this.proxyToSource[V.key][t.id]=[Z],p.push(Z)}}}_createProxiedId(t,n,c){let p=this.orthoMatrix;if(c){const y=c.find(b=>b.key===n.tileID.key);if(y)return y}if(n.tileID.key!==t.key){const y=t.canonical.z-n.tileID.canonical.z;let b,E,D;p=o.ab.mat4.create();const L=n.tileID.wrap-t.wrap<<t.overscaledZ;y>0?(b=o.ag>>y,E=b*((n.tileID.canonical.x<<y)-t.canonical.x+L),D=b*((n.tileID.canonical.y<<y)-t.canonical.y)):(b=o.ag<<-y,E=o.ag*(n.tileID.canonical.x-(t.canonical.x+L<<-y)),D=o.ag*(n.tileID.canonical.y-(t.canonical.y<<-y))),o.ab.mat4.ortho(p,0,b,0,b,0,1),o.ab.mat4.translate(p,p,[E,D,0])}return new la(n.tileID,t.key,p)}_findTileCoveringTileID(t,n){let c=n.getTile(t);if(c&&c.hasData())return c;const p=this._findCoveringTileCache[n.id],y=p[t.key];if(c=y?n.getTileByID(y):null,c&&c.hasData()||null===y)return c;let b=c?c.tileID:t,E=b.overscaledZ;const D=n.getSource().minzoom,L=[];if(!y){const N=n.getSource().maxzoom;if(t.canonical.z>=N){const V=t.canonical.z-N;n.getSource().reparseOverscaled?(E=Math.max(t.canonical.z+2,n.transform.tileZoom),b=new o.aG(E,t.wrap,N,t.canonical.x>>V,t.canonical.y>>V)):0!==V&&(E=N,b=new o.aG(E,t.wrap,N,t.canonical.x>>V,t.canonical.y>>V))}b.key!==t.key&&(L.push(b.key),c=n.getTile(b))}const k=N=>{L.forEach(V=>{p[V]=N}),L.length=0};for(E-=1;E>=D&&(!c||!c.hasData());E--){c&&k(c.tileID.key);const N=b.calculateScaledKey(E);if(c=n.getTileByID(N),c&&c.hasData())break;const V=p[N];if(null===V)break;void 0===V?L.push(N):c=n.getTileByID(V)}return k(c?c.tileID.key:null),c&&c.hasData()?c:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,n){let c=this._tilesDirty[t];c||(c=this._tilesDirty[t]={}),c[n.key]=!0}}function $l(l,t,n){const c=function(E,D,L){const k=o.ab.vec3.dot(D,E),N=o.ab.vec3.dot(L,[.2126,.7152,.0722]),V=(Y,Z,Q)=>(1-Q)*Y+Q*Z,j=V(1-.3*Math.min(N,1),1,Math.min(k+1,1));return V(.92,1,Math.asin(o.aw(D[2],-1,1))/Math.PI+.5)*j}(l,[0,0,1],t),p=[0,0,0];o.ab.vec3.scale(p,n.slice(0,3),c);const y=[0,0,0];o.ab.vec3.scale(y,t.slice(0,3),l[2]);const b=[0,0,0];return o.ab.vec3.add(b,p,y),o.cf(b)}const Nd=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],Yu=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","model","symbol"];class Ku{static cacheKey(t,n,c,p){let y=`${n}${p?p.cacheKey:""}`;for(const b of c)t.usedDefines.includes(b)&&(y+=`/${b}`);return y}constructor(t,n,c,p,y,b){const E=t.gl;this.program=E.createProgram(),this.configuration=p,this.name=n,this.fixedDefines=[...b];const D=p?p.getBinderAttributes():[],L=(c.staticAttributes||[]).concat(D);let k=p?p.defines():[];k=k.concat(b.map(Q=>`#define ${Q}`));const N="#version 300 es\n";let V=N+k.concat("precision mediump float;",jl,Ul.fragmentSource).join("\n");for(const Q of c.fragmentIncludes)V+=`\n${Xa[Q]}`;V+=`\n${c.fragmentSource}`;let j=N+k.concat("precision highp float;",jl,Ul.vertexSource).join("\n");for(const Q of c.vertexIncludes)j+=`\n${Xa[Q]}`;this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&-1!==c.vertexSource.indexOf("gl_InstanceID"),this.forceManualRenderingForInstanceIDShaders&&(j+="\nuniform int u_instanceID;\n"),j+=`\n${c.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(j=j.replaceAll("gl_InstanceID","u_instanceID"));const Y=E.createShader(E.FRAGMENT_SHADER);if(E.isContextLost())return void(this.failedToCreate=!0);E.shaderSource(Y,V),E.compileShader(Y),E.attachShader(this.program,Y);const Z=E.createShader(E.VERTEX_SHADER);if(E.isContextLost())this.failedToCreate=!0;else{E.shaderSource(Z,j),E.compileShader(Z),E.attachShader(this.program,Z),this.attributes={},this.numAttributes=L.length;for(let Q=0;Q<this.numAttributes;Q++)if(L[Q]){const J=L[Q].startsWith("a_")?L[Q]:`a_${L[Q]}`;E.bindAttribLocation(this.program,Q,J),this.attributes[J]=Q}E.linkProgram(this.program),E.deleteShader(Z),E.deleteShader(Y),this.fixedUniforms=y(t),this.binderUniforms=p?p.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms={u_instanceID:new o.bN(t)}),(b.includes("TERRAIN")||-1!==n.indexOf("symbol")||-1!==n.indexOf("circle"))&&(this.terrainUniforms={u_dem:new o.bN(Q=t),u_dem_prev:new o.bN(Q),u_dem_tl:new o.bK(Q),u_dem_scale:new o.bM(Q),u_dem_tl_prev:new o.bK(Q),u_dem_scale_prev:new o.bM(Q),u_dem_size:new o.bM(Q),u_dem_lerp:new o.bM(Q),u_exaggeration:new o.bM(Q),u_depth:new o.bN(Q),u_depth_size_inv:new o.bK(Q),u_depth_range_unpack:new o.bK(Q),u_occluder_half_size:new o.bM(Q),u_occlusion_depth_offset:new o.bM(Q),u_meter_to_dem:new o.bM(Q),u_label_plane_matrix_inv:new o.bJ(Q)}),b.includes("GLOBE")&&(this.globeUniforms=(Q=>({u_tile_tl_up:new o.bL(Q),u_tile_tr_up:new o.bL(Q),u_tile_br_up:new o.bL(Q),u_tile_bl_up:new o.bL(Q),u_tile_up_scale:new o.bM(Q)}))(t)),b.includes("FOG")&&(this.fogUniforms=(Q=>({u_fog_matrix:new o.bJ(Q),u_fog_range:new o.bK(Q),u_fog_color:new o.ca(Q),u_fog_horizon_blend:new o.bM(Q),u_fog_vertical_limit:new o.bK(Q),u_fog_temporal_offset:new o.bM(Q),u_frustum_tl:new o.bL(Q),u_frustum_tr:new o.bL(Q),u_frustum_br:new o.bL(Q),u_frustum_bl:new o.bL(Q),u_globe_pos:new o.bL(Q),u_globe_radius:new o.bM(Q),u_globe_transition:new o.bM(Q),u_is_globe:new o.bN(Q),u_viewport:new o.bK(Q)}))(t)),b.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(Q=>({u_cutoff_params:new o.ca(Q)}))(t)),b.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(Q=>({u_lighting_ambient_color:new o.bL(Q),u_lighting_directional_dir:new o.bL(Q),u_lighting_directional_color:new o.bL(Q),u_ground_radiance:new o.bL(Q)}))(t)),b.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(Q=>({u_light_matrix_0:new o.bJ(Q),u_light_matrix_1:new o.bJ(Q),u_fade_range:new o.bK(Q),u_shadow_normal_offset:new o.bL(Q),u_shadow_intensity:new o.bM(Q),u_shadow_texel_size:new o.bM(Q),u_shadow_map_resolution:new o.bM(Q),u_shadow_direction:new o.bL(Q),u_shadow_bias:new o.bL(Q),u_shadowmap_0:new o.bN(Q),u_shadowmap_1:new o.bN(Q)}))(t))}var Q}setTerrainUniformValues(t,n){if(!this.terrainUniforms)return;const c=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in n)c[p]&&c[p].set(this.program,p,n[p])}}setGlobeUniformValues(t,n){if(!this.globeUniforms)return;const c=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in n)c[p]&&c[p].set(this.program,p,n[p])}}setFogUniformValues(t,n){if(!this.fogUniforms)return;const c=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in n)c[p].set(this.program,p,n[p])}}setCutoffUniformValues(t,n){if(!this.cutoffUniforms)return;const c=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in n)c[p].set(this.program,p,n[p])}}setLightsUniformValues(t,n){if(!this.lightsUniforms)return;const c=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in n)c[p].set(this.program,p,n[p])}}setShadowUniformValues(t,n){if(this.failedToCreate||!this.shadowUniforms)return;const c=this.shadowUniforms;t.program.set(this.program);for(const p in n)c[p].set(this.program,p,n[p])}_drawDebugWireframe(t,n,c,p,y,b,E,D,L,k){const N=t.options.wireframe;if(!1===N.terrain&&!1===N.layers2D&&!1===N.layers3D)return;const V=t.context;if(!(N.terrain&&("terrainRaster"===this.name||"globeRaster"===this.name)||!(!N.layers2D||t._terrain&&t._terrain.renderingToTexture)&&Nd.includes(this.name)||N.layers3D&&Yu.includes(this.name)))return;const j=V.gl,Y=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,y,V);if(!Y)return;const Z=[...this.fixedDefines];Z.push("DEBUG_WIREFRAME");const Q=t.getOrCreateProgram(this.name,{config:this.configuration,defines:Z});V.program.set(Q.program);const J=(ce,ge,pe)=>{if(ge[ce]&&pe[ce])for(const _e in ge[ce])pe[ce][_e]&&pe[ce][_e].set(pe.program,_e,ge[ce][_e].current)};L&&L.setUniforms(Q.program,V,Q.binderUniforms,E,{zoom:D}),J("fixedUniforms",this,Q),J("terrainUniforms",this,Q),J("globeUniforms",this,Q),J("fogUniforms",this,Q),J("lightsUniforms",this,Q),J("shadowUniforms",this,Q),Y.bind(),V.setColorMode(new li([j.ONE,j.ONE_MINUS_SRC_ALPHA,j.ZERO,j.ONE],o.aj.transparent,[!0,!0,!0,!1])),V.setDepthMode(new zt(n.func===j.LESS?j.LEQUAL:n.func,zt.ReadOnly,n.range)),V.setStencilMode(qt.disabled);const re=3*b.primitiveLength*2,he=3*b.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const ce=k||1;for(let ge=0;ge<ce;++ge)Q.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",ge),j.drawElements(j.LINES,re,j.UNSIGNED_SHORT,he)}else k&&k>1?j.drawElementsInstanced(j.LINES,re,j.UNSIGNED_SHORT,he,k):j.drawElements(j.LINES,re,j.UNSIGNED_SHORT,he);y.bind(),V.program.set(this.program),V.setDepthMode(n),V.setStencilMode(c),V.setColorMode(p)}checkUniforms(t,n,c){if(this.fixedDefines.includes(n))for(const p of Object.keys(c))if(!c[p].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${p} not set but required by ${n} being defined`)}draw(t,n,c,p,y,b,E,D,L,k,N,V,j,Y,Z,Q){const J=t.context,re=J.gl;if(this.failedToCreate)return;J.program.set(this.program),J.setDepthMode(c),J.setStencilMode(p),J.setColorMode(y),J.setCullFace(b);for(const ge of Object.keys(this.fixedUniforms))this.fixedUniforms[ge].set(this.program,ge,E[ge]);Y&&Y.setUniforms(this.program,J,this.binderUniforms,V,{zoom:j});const he={[re.POINTS]:1,[re.LINES]:2,[re.TRIANGLES]:3,[re.LINE_STRIP]:1}[n];this.checkUniforms(D,"RENDER_SHADOWS",this.shadowUniforms);const ce=Q&&Q>0?1:void 0;for(const ge of N.get()){const pe=ge.vaos||(ge.vaos={});if((pe[D]||(pe[D]=new Uu)).bind(J,this,L,Y?Y.getPaintVertexBuffers():[],k,ge.vertexOffset,Z||[],ce),this.forceManualRenderingForInstanceIDShaders){const _e=Q||1;for(let de=0;de<_e;++de)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",de),k?re.drawElements(n,ge.primitiveLength*he,re.UNSIGNED_SHORT,ge.primitiveOffset*he*2):re.drawArrays(n,ge.vertexOffset,ge.vertexLength)}else Q&&Q>1?re.drawElementsInstanced(n,ge.primitiveLength*he,re.UNSIGNED_SHORT,ge.primitiveOffset*he*2,Q):k?re.drawElements(n,ge.primitiveLength*he,re.UNSIGNED_SHORT,ge.primitiveOffset*he*2):re.drawArrays(n,ge.vertexOffset,ge.vertexLength);n===re.TRIANGLES&&k&&this._drawDebugWireframe(t,c,p,y,k,ge,V,j,Y,Q)}}}function Lc(l,t){const n=Math.pow(2,t.tileID.overscaledZ),c=t.tileSize*Math.pow(2,l.transform.tileZoom)/n,p=c*(t.tileID.canonical.x+t.tileID.wrap*n),y=c*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/o.ar(t,1,l.transform.tileZoom),u_pixel_coord_upper:[p>>16,y>>16],u_pixel_coord_lower:[65535&p,65535&y]}}const ha={terrain:0,flat:1},ua=o.ab.mat4.create(),kc=(l,t,n,c,p,y,b,E,D,L,k,N,V,j,Y,Z,Q,J)=>{const re=t.style.light,he=re.properties.get("position"),ce=[he.x,he.y,he.z],ge=o.ab.mat3.create();"viewport"===re.properties.get("anchor")&&(o.ab.mat3.fromRotation(ge,-t.transform.angle),o.ab.vec3.transformMat3(ce,ce,ge));const pe=re.properties.get("color"),_e=t.transform,de={u_matrix:l,u_lightpos:ce,u_lightintensity:re.properties.get("intensity"),u_lightcolor:[pe.r,pe.g,pe.b],u_vertical_gradient:+n,u_opacity:c,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:ua,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:ha[L],u_base_type:ha[k],u_ao:p,u_edge_radius:y,u_width_scale:b,u_flood_light_color:Y,u_vertical_scale:Z,u_flood_light_intensity:Q,u_ground_shadow_factor:J};return"globe"===_e.projection.name&&(de.u_tile_id=[E.canonical.x,E.canonical.y,1<<E.canonical.z],de.u_zoom_transition=N,de.u_inv_rot_matrix=j,de.u_merc_center=V,de.u_up_dir=_e.projection.upVector(new o.bT(0,0,0),V[0]*o.ag,V[1]*o.ag),de.u_height_lift=D),de},Zl=(l,t,n,c,p,y)=>({u_matrix:l,u_edge_radius:t,u_width_scale:n,u_vertical_scale:c,u_height_type:ha[p],u_base_type:ha[y]}),Ju=(l,t,n,c,p,y,b,E,D,L,k,N,V,j,Y,Z,Q)=>{const J=kc(l,t,n,c,p,y,b,E,L,k,N,V,j,Y,Z,Q,1,[0,0,0]),re={u_height_factor:-Math.pow(2,E.overscaledZ)/D.tileSize/8};return o.l(J,Lc(t,D),re)},io=(l,t)=>({u_matrix:l,u_emissive_strength:t}),zo=(l,t,n,c)=>o.l(io(l,t),Lc(n,c)),Oc=(l,t,n)=>({u_matrix:l,u_world:n,u_emissive_strength:t}),dr=(l,t,n,c,p)=>o.l(zo(l,t,n,c),{u_world:p}),Qu=(l,t,n,c)=>{const p=o.ag/n.tileSize;return{u_matrix:l,u_camera_to_center_distance:t.getCameraToCenterDistance(c),u_extrude_scale:[t.pixelsToGLUnits[0]/p,t.pixelsToGLUnits[1]/p]}},da=(l,t,n=1)=>({u_matrix:l,u_color:t.toRenderColor(null),u_overlay:0,u_overlay_scale:n}),pa=o.ab.mat4.create(),St=(l,t,n,c,p,y,b)=>{const E=l.transform,D="globe"===E.projection.name,L=D?o.cN(E.zoom,t.canonical)*E._pixelsPerMercatorPixel:o.ar(n,1,y),k={u_matrix:t.projMatrix,u_extrude_scale:L,u_intensity:b,u_inv_rot_matrix:pa,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(D){k.u_inv_rot_matrix=c,k.u_merc_center=p,k.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],k.u_zoom_transition=o.ae(E.zoom);const N=p[0]*o.ag,V=p[1]*o.ag;k.u_up_dir=E.projection.upVector(new o.bT(0,0,0),N,V)}return k};function Fc(l,[t,n,c,p],[y,b]){if(y===b)return[0,0,0,0];const E=255*(l-1)/(l*(b-y));return[t*E,n*E,c*E,p*E]}function Yh(l,t,[n,c]){return n===c?0:.5/l+(t-n)*(l-1)/(l*(c-n))}const no=(l,t,n,c,p,y,b,E,D,L,k,N,V,j,Y,Z,Q,J,re,he,ce)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:n,u_merc_matrix:c,u_grid_matrix:p,u_tl_parent:y,u_scale_parent:L,u_fade_t:k.mix,u_opacity:k.opacity*N.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:N.paint.get("raster-brightness-min"),u_brightness_high:N.paint.get("raster-brightness-max"),u_saturation_factor:o.cO(N.paint.get("raster-saturation")),u_contrast_factor:o.cP(N.paint.get("raster-contrast")),u_spin_weights:fa(N.paint.get("raster-hue-rotate")),u_perspective_transform:V,u_raster_elevation:j,u_zoom_transition:b,u_merc_center:E,u_cutoff_params:D,u_colorization_mix:Fc(o.cQ,Z,J),u_colorization_offset:Yh(o.cQ,Q,J),u_color_ramp:Y,u_texture_offset:[he/(re+2*he),re/(re+2*he)],u_texture_res:[re+2*he,re+2*he],u_emissive_strength:ce});function fa(l){l*=Math.PI/180;const t=Math.sin(l),n=Math.cos(l);return[(2*n+1)/3,(-Math.sqrt(3)*t-n+1)/3,(Math.sqrt(3)*t-n+1)/3]}const Ct=.05,Kh=(l,t,n,c,p,y,b,E,D,L,k,N)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:n,u_merc_matrix:c,u_grid_matrix:p,u_tl_parent:y,u_scale_parent:L,u_fade_t:k.mix,u_opacity:k.opacity,u_image0:0,u_image1:1,u_raster_elevation:N,u_zoom_transition:b,u_merc_center:E,u_cutoff_params:D}),Bc=(l,t,n,c,p,y,b,E,D,L)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_tile_offset:n,u_velocity:c,u_color_ramp:y,u_velocity_res:p,u_max_speed:b,u_uv_offset:E,u_data_scale:[255*D[0],255*D[1]],u_data_offset:L,u_particle_pos_scale:1.1,u_particle_pos_offset:[Ct,Ct]}),Vd=(l,t,n,c,p,y,b,E,D,L)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_velocity:n,u_velocity_res:c,u_max_speed:p,u_speed_factor:y,u_reset_rate:b,u_rand_seed:Math.random(),u_uv_offset:E,u_data_scale:[255*D[0],255*D[1]],u_data_offset:L,u_particle_pos_scale:1.1,u_particle_pos_offset:[Ct,Ct]}),Nc=o.ab.mat4.create(),ma=(l,t,n,c,p,y,b,E,D,L,k,N,V,j,Y,Z,Q,J,re,he,ce,ge)=>{const pe=p.transform,_e={u_is_size_zoom_constant:+("constant"===l||"source"===l),u_is_size_feature_constant:+("constant"===l||"camera"===l),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:pe.getCameraToCenterDistance(re),u_rotate_symbol:+n,u_aspect_ratio:pe.width/pe.height,u_fade_change:p.options.fadeDuration?p.symbolFadeChange:1,u_matrix:y,u_label_plane_matrix:b,u_coord_matrix:E,u_is_text:+L,u_elevation_from_sea:D?1:0,u_pitch_with_map:+c,u_texsize:k,u_texsize_icon:N,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:Nc,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:Nc,u_up_vector:[0,-1,0],u_color_adj_mat:he,u_icon_transition:ce||0,u_gamma_scale:c?p.transform.getCameraToCenterDistance(re)*Math.cos(p.terrain?0:p.transform._pitch):1,u_device_pixel_ratio:o.q.devicePixelRatio,u_is_halo:+V,u_scale_factor:ge||1};return"globe"===re.name&&(_e.u_tile_id=[j.canonical.x,j.canonical.y,1<<j.canonical.z],_e.u_zoom_transition=Y,_e.u_inv_rot_matrix=Q,_e.u_merc_center=Z,_e.u_camera_forward=pe._camera.forward(),_e.u_ecef_origin=o.cR(pe.globeMatrix,j.toUnwrapped()),_e.u_tile_matrix=Float32Array.from(pe.globeMatrix),_e.u_up_vector=J),_e},Vc=(l,t,n,c)=>({u_matrix:l,u_emissive_strength:t,u_opacity:n,u_color:c}),Jh=(l,t,n,c,p,y,b,E,D)=>o.l(function(L,k,N,V,j,Y){const{width:Z,height:Q}=V.imageManager.getPixelSize(k),J=Math.pow(2,Y.tileID.overscaledZ),re=Y.tileSize*Math.pow(2,V.transform.tileZoom)/J,he=re*(Y.tileID.canonical.x+Y.tileID.wrap*J),ce=re*Y.tileID.canonical.y;return{u_image:0,u_pattern_tl:N.tl,u_pattern_br:N.br,u_texsize:[Z,Q],u_pattern_size:N.displaySize,u_pattern_units_to_pixels:j?[V.transform.width,-1*V.transform.height]:[1/o.ar(Y,1,V.transform.tileZoom),1/o.ar(Y,1,V.transform.tileZoom)],u_pixel_coord_upper:[he>>16,ce>>16],u_pixel_coord_lower:[65535&he,65535&ce]}}(0,y,b,c,E,D),{u_matrix:l,u_emissive_strength:t,u_opacity:n}),Qh=new Float32Array(o.ab.mat4.identity([])),Xl=(l,t,n,c,p,y,b,E,D,L,k,N,V,j=[0,0,0],Y)=>{const Z=p.style.light,Q=Z.properties.get("position"),J=[-Q.x,-Q.y,Q.z],re=o.ab.mat3.create();"viewport"===Z.properties.get("anchor")&&(o.ab.mat3.fromRotation(re,-p.transform.angle),o.ab.vec3.transformMat3(J,J,re));const he="MASK"===k.alphaMode,ce=Z.properties.get("color").toRenderColor(null),ge=V.paint.get("model-ambient-occlusion-intensity"),pe=V.paint.get("model-color").constantOr(o.aj.white).toRenderColor(null),_e=V.paint.get("model-color-mix-intensity").constantOr(0);return{u_matrix:l,u_lighting_matrix:t,u_normal_matrix:n,u_node_matrix:c||Qh,u_lightpos:J,u_lightintensity:Z.properties.get("intensity"),u_lightcolor:[ce.r,ce.g,ce.b],u_camera_pos:j,u_opacity:y,u_baseTextureIsAlpha:0,u_alphaMask:+he,u_alphaCutoff:k.alphaCutoff,u_baseColorFactor:[b.r,b.g,b.b,b.a],u_emissiveFactor:[E[0],E[1],E[2],1],u_metallicFactor:D,u_roughnessFactor:L,u_baseColorTexture:Un_BaseColor,u_metallicRoughnessTexture:Un_MetallicRoughness,u_normalTexture:Un_Normal,u_occlusionTexture:Un_Occlusion,u_emissionTexture:Un_Emission,u_lutTexture:Un_LUT,u_color_mix:[pe.r,pe.g,pe.b,_e],u_aoIntensity:ge,u_emissive_strength:N,u_occlusionTextureTransform:Y||[0,0,0,0]}},Uc=(l,t=Qh,n=Qh)=>({u_matrix:l,u_instance:t,u_node_matrix:n}),Yl={fillExtrusion:l=>({u_matrix:new o.bJ(l),u_lightpos:new o.bL(l),u_lightintensity:new o.bM(l),u_lightcolor:new o.bL(l),u_vertical_gradient:new o.bM(l),u_opacity:new o.bM(l),u_edge_radius:new o.bM(l),u_width_scale:new o.bM(l),u_ao:new o.bK(l),u_height_type:new o.bN(l),u_base_type:new o.bN(l),u_tile_id:new o.bL(l),u_zoom_transition:new o.bM(l),u_inv_rot_matrix:new o.bJ(l),u_merc_center:new o.bK(l),u_up_dir:new o.bL(l),u_height_lift:new o.bM(l),u_flood_light_color:new o.bL(l),u_vertical_scale:new o.bM(l),u_flood_light_intensity:new o.bM(l),u_ground_shadow_factor:new o.bL(l)}),fillExtrusionDepth:l=>({u_matrix:new o.bJ(l),u_edge_radius:new o.bM(l),u_width_scale:new o.bM(l),u_vertical_scale:new o.bM(l),u_height_type:new o.bN(l),u_base_type:new o.bN(l)}),fillExtrusionPattern:l=>({u_matrix:new o.bJ(l),u_lightpos:new o.bL(l),u_lightintensity:new o.bM(l),u_lightcolor:new o.bL(l),u_vertical_gradient:new o.bM(l),u_height_factor:new o.bM(l),u_edge_radius:new o.bM(l),u_width_scale:new o.bM(l),u_ao:new o.bK(l),u_height_type:new o.bN(l),u_base_type:new o.bN(l),u_tile_id:new o.bL(l),u_zoom_transition:new o.bM(l),u_inv_rot_matrix:new o.bJ(l),u_merc_center:new o.bK(l),u_up_dir:new o.bL(l),u_height_lift:new o.bM(l),u_image:new o.bN(l),u_texsize:new o.bK(l),u_pixel_coord_upper:new o.bK(l),u_pixel_coord_lower:new o.bK(l),u_tile_units_to_pixels:new o.bM(l),u_opacity:new o.bM(l)}),fillExtrusionGroundEffect:l=>({u_matrix:new o.bJ(l),u_opacity:new o.bM(l),u_ao_pass:new o.bM(l),u_meter_to_tile:new o.bM(l),u_ao:new o.bK(l),u_flood_light_intensity:new o.bM(l),u_flood_light_color:new o.bL(l),u_attenuation:new o.bM(l),u_edge_radius:new o.bM(l),u_fb:new o.bN(l),u_fb_size:new o.bM(l),u_dynamic_offset:new o.bM(l)}),fill:l=>({u_matrix:new o.bJ(l),u_emissive_strength:new o.bM(l)}),fillPattern:l=>({u_matrix:new o.bJ(l),u_emissive_strength:new o.bM(l),u_image:new o.bN(l),u_texsize:new o.bK(l),u_pixel_coord_upper:new o.bK(l),u_pixel_coord_lower:new o.bK(l),u_tile_units_to_pixels:new o.bM(l)}),fillOutline:l=>({u_matrix:new o.bJ(l),u_emissive_strength:new o.bM(l),u_world:new o.bK(l)}),fillOutlinePattern:l=>({u_matrix:new o.bJ(l),u_emissive_strength:new o.bM(l),u_world:new o.bK(l),u_image:new o.bN(l),u_texsize:new o.bK(l),u_pixel_coord_upper:new o.bK(l),u_pixel_coord_lower:new o.bK(l),u_tile_units_to_pixels:new o.bM(l)}),circle:o.cS,collisionBox:l=>({u_matrix:new o.bJ(l),u_camera_to_center_distance:new o.bM(l),u_extrude_scale:new o.bK(l)}),collisionCircle:l=>({u_matrix:new o.bJ(l),u_inv_matrix:new o.bJ(l),u_camera_to_center_distance:new o.bM(l),u_viewport_size:new o.bK(l)}),debug:l=>({u_color:new o.cz(l),u_matrix:new o.bJ(l),u_overlay:new o.bN(l),u_overlay_scale:new o.bM(l)}),clippingMask:l=>({u_matrix:new o.bJ(l)}),heatmap:l=>({u_extrude_scale:new o.bM(l),u_intensity:new o.bM(l),u_matrix:new o.bJ(l),u_inv_rot_matrix:new o.bJ(l),u_merc_center:new o.bK(l),u_tile_id:new o.bL(l),u_zoom_transition:new o.bM(l),u_up_dir:new o.bL(l)}),heatmapTexture:l=>({u_image:new o.bN(l),u_color_ramp:new o.bN(l),u_opacity:new o.bM(l)}),hillshade:l=>({u_matrix:new o.bJ(l),u_image:new o.bN(l),u_latrange:new o.bK(l),u_light:new o.bK(l),u_shadow:new o.cz(l),u_highlight:new o.cz(l),u_emissive_strength:new o.bM(l),u_accent:new o.cz(l)}),hillshadePrepare:l=>({u_matrix:new o.bJ(l),u_image:new o.bN(l),u_dimension:new o.bK(l),u_zoom:new o.bM(l)}),line:o.cT,linePattern:o.cU,raster:l=>({u_matrix:new o.bJ(l),u_normalize_matrix:new o.bJ(l),u_globe_matrix:new o.bJ(l),u_merc_matrix:new o.bJ(l),u_grid_matrix:new o.cA(l),u_tl_parent:new o.bK(l),u_scale_parent:new o.bM(l),u_fade_t:new o.bM(l),u_opacity:new o.bM(l),u_image0:new o.bN(l),u_image1:new o.bN(l),u_brightness_low:new o.bM(l),u_brightness_high:new o.bM(l),u_saturation_factor:new o.bM(l),u_contrast_factor:new o.bM(l),u_spin_weights:new o.bL(l),u_perspective_transform:new o.bK(l),u_raster_elevation:new o.bM(l),u_zoom_transition:new o.bM(l),u_merc_center:new o.bK(l),u_cutoff_params:new o.ca(l),u_colorization_mix:new o.ca(l),u_colorization_offset:new o.bM(l),u_color_ramp:new o.bN(l),u_texture_offset:new o.bK(l),u_texture_res:new o.bK(l),u_emissive_strength:new o.bM(l)}),rasterParticle:l=>({u_matrix:new o.bJ(l),u_normalize_matrix:new o.bJ(l),u_globe_matrix:new o.bJ(l),u_merc_matrix:new o.bJ(l),u_grid_matrix:new o.cA(l),u_tl_parent:new o.bK(l),u_scale_parent:new o.bM(l),u_fade_t:new o.bM(l),u_opacity:new o.bM(l),u_image0:new o.bN(l),u_image1:new o.bN(l),u_raster_elevation:new o.bM(l),u_zoom_transition:new o.bM(l),u_merc_center:new o.bK(l),u_cutoff_params:new o.ca(l)}),rasterParticleTexture:l=>({u_texture:new o.bN(l),u_opacity:new o.bM(l)}),rasterParticleDraw:l=>({u_particle_texture:new o.bN(l),u_particle_texture_side_len:new o.bM(l),u_tile_offset:new o.bK(l),u_velocity:new o.bN(l),u_color_ramp:new o.bN(l),u_velocity_res:new o.bK(l),u_max_speed:new o.bM(l),u_uv_offset:new o.bK(l),u_data_scale:new o.bK(l),u_data_offset:new o.bM(l),u_particle_pos_scale:new o.bM(l),u_particle_pos_offset:new o.bK(l)}),rasterParticleUpdate:l=>({u_particle_texture:new o.bN(l),u_particle_texture_side_len:new o.bM(l),u_velocity:new o.bN(l),u_velocity_res:new o.bK(l),u_max_speed:new o.bM(l),u_speed_factor:new o.bM(l),u_reset_rate:new o.bM(l),u_rand_seed:new o.bM(l),u_uv_offset:new o.bK(l),u_data_scale:new o.bK(l),u_data_offset:new o.bM(l),u_particle_pos_scale:new o.bM(l),u_particle_pos_offset:new o.bK(l)}),symbol:l=>({u_is_size_zoom_constant:new o.bN(l),u_is_size_feature_constant:new o.bN(l),u_size_t:new o.bM(l),u_size:new o.bM(l),u_camera_to_center_distance:new o.bM(l),u_rotate_symbol:new o.bN(l),u_aspect_ratio:new o.bM(l),u_fade_change:new o.bM(l),u_matrix:new o.bJ(l),u_label_plane_matrix:new o.bJ(l),u_coord_matrix:new o.bJ(l),u_is_text:new o.bN(l),u_elevation_from_sea:new o.bN(l),u_pitch_with_map:new o.bN(l),u_texsize:new o.bK(l),u_texsize_icon:new o.bK(l),u_texture:new o.bN(l),u_texture_icon:new o.bN(l),u_gamma_scale:new o.bM(l),u_device_pixel_ratio:new o.bM(l),u_tile_id:new o.bL(l),u_zoom_transition:new o.bM(l),u_inv_rot_matrix:new o.bJ(l),u_merc_center:new o.bK(l),u_camera_forward:new o.bL(l),u_tile_matrix:new o.bJ(l),u_up_vector:new o.bL(l),u_ecef_origin:new o.bL(l),u_is_halo:new o.bN(l),u_icon_transition:new o.bM(l),u_color_adj_mat:new o.bJ(l),u_scale_factor:new o.bM(l)}),background:l=>({u_matrix:new o.bJ(l),u_emissive_strength:new o.bM(l),u_opacity:new o.bM(l),u_color:new o.cz(l)}),backgroundPattern:l=>({u_matrix:new o.bJ(l),u_emissive_strength:new o.bM(l),u_opacity:new o.bM(l),u_image:new o.bN(l),u_pattern_tl:new o.bK(l),u_pattern_br:new o.bK(l),u_texsize:new o.bK(l),u_pattern_size:new o.bK(l),u_pixel_coord_upper:new o.bK(l),u_pixel_coord_lower:new o.bK(l),u_pattern_units_to_pixels:new o.bK(l)}),terrainRaster:l=>({u_matrix:new o.bJ(l),u_image0:new o.bN(l),u_skirt_height:new o.bM(l),u_ground_shadow_factor:new o.bL(l)}),skybox:l=>({u_matrix:new o.bJ(l),u_sun_direction:new o.bL(l),u_cubemap:new o.bN(l),u_opacity:new o.bM(l),u_temporal_offset:new o.bM(l)}),skyboxGradient:l=>({u_matrix:new o.bJ(l),u_color_ramp:new o.bN(l),u_center_direction:new o.bL(l),u_radius:new o.bM(l),u_opacity:new o.bM(l),u_temporal_offset:new o.bM(l)}),skyboxCapture:l=>({u_matrix_3f:new o.cA(l),u_sun_direction:new o.bL(l),u_sun_intensity:new o.bM(l),u_color_tint_r:new o.ca(l),u_color_tint_m:new o.ca(l),u_luminance:new o.bM(l)}),globeRaster:l=>({u_proj_matrix:new o.bJ(l),u_globe_matrix:new o.bJ(l),u_normalize_matrix:new o.bJ(l),u_merc_matrix:new o.bJ(l),u_zoom_transition:new o.bM(l),u_merc_center:new o.bK(l),u_image0:new o.bN(l),u_grid_matrix:new o.cA(l),u_skirt_height:new o.bM(l),u_far_z_cutoff:new o.bM(l),u_frustum_tl:new o.bL(l),u_frustum_tr:new o.bL(l),u_frustum_br:new o.bL(l),u_frustum_bl:new o.bL(l),u_globe_pos:new o.bL(l),u_globe_radius:new o.bM(l),u_viewport:new o.bK(l)}),globeAtmosphere:l=>({u_frustum_tl:new o.bL(l),u_frustum_tr:new o.bL(l),u_frustum_br:new o.bL(l),u_frustum_bl:new o.bL(l),u_horizon:new o.bM(l),u_transition:new o.bM(l),u_fadeout_range:new o.bM(l),u_color:new o.ca(l),u_high_color:new o.ca(l),u_space_color:new o.ca(l),u_temporal_offset:new o.bM(l),u_horizon_angle:new o.bM(l)}),model:l=>({u_matrix:new o.bJ(l),u_lighting_matrix:new o.bJ(l),u_normal_matrix:new o.bJ(l),u_node_matrix:new o.bJ(l),u_lightpos:new o.bL(l),u_lightintensity:new o.bM(l),u_lightcolor:new o.bL(l),u_camera_pos:new o.bL(l),u_opacity:new o.bM(l),u_baseColorFactor:new o.ca(l),u_emissiveFactor:new o.ca(l),u_metallicFactor:new o.bM(l),u_roughnessFactor:new o.bM(l),u_baseTextureIsAlpha:new o.bN(l),u_alphaMask:new o.bN(l),u_alphaCutoff:new o.bM(l),u_baseColorTexture:new o.bN(l),u_metallicRoughnessTexture:new o.bN(l),u_normalTexture:new o.bN(l),u_occlusionTexture:new o.bN(l),u_emissionTexture:new o.bN(l),u_lutTexture:new o.bN(l),u_color_mix:new o.ca(l),u_aoIntensity:new o.bM(l),u_emissive_strength:new o.bM(l),u_occlusionTextureTransform:new o.ca(l)}),modelDepth:l=>({u_matrix:new o.bJ(l),u_instance:new o.bJ(l),u_node_matrix:new o.bJ(l)}),groundShadow:l=>({u_matrix:new o.bJ(l),u_ground_shadow_factor:new o.bL(l)}),stars:l=>({u_matrix:new o.bJ(l),u_up:new o.bL(l),u_right:new o.bL(l),u_intensity_multiplier:new o.bM(l)}),snowParticle:l=>({u_modelview:new o.bJ(l),u_projection:new o.bJ(l),u_time:new o.bM(l),u_cam_pos:new o.bL(l),u_velocityConeAperture:new o.bM(l),u_velocity:new o.bM(l),u_horizontalOscillationRadius:new o.bM(l),u_horizontalOscillationRate:new o.bM(l),u_boxSize:new o.bM(l),u_billboardSize:new o.bM(l),u_simpleShapeParameters:new o.bK(l),u_screenSize:new o.bK(l),u_thinningCenterPos:new o.bK(l),u_thinningShape:new o.bL(l),u_thinningAffectedRatio:new o.bM(l),u_thinningParticleOffset:new o.bM(l),u_particleColor:new o.ca(l),u_direction:new o.bL(l)}),rainParticle:l=>({u_modelview:new o.bJ(l),u_projection:new o.bJ(l),u_time:new o.bM(l),u_cam_pos:new o.bL(l),u_texScreen:new o.bN(l),u_velocityConeAperture:new o.bM(l),u_velocity:new o.bM(l),u_boxSize:new o.bM(l),u_rainDropletSize:new o.bK(l),u_distortionStrength:new o.bM(l),u_rainDirection:new o.bL(l),u_color:new o.ca(l),u_screenSize:new o.bK(l),u_thinningCenterPos:new o.bK(l),u_thinningShape:new o.bL(l),u_thinningAffectedRatio:new o.bM(l),u_thinningParticleOffset:new o.bM(l),u_shapeDirectionalPower:new o.bM(l),u_shapeNormalPower:new o.bM(l),u_mode:new o.bM(l)}),vignette:l=>({u_vignetteShape:new o.bL(l),u_vignetteColor:new o.ca(l)}),occlusion:l=>({u_matrix:new o.bJ(l),u_anchorPos:new o.bL(l),u_screenSizePx:new o.bK(l),u_occluderSizePx:new o.bK(l),u_color:new o.ca(l)})};let jc=(()=>{class l{constructor(n,c,p,y){this.id=l.uniqueIdxCounter,l.uniqueIdxCounter++,this.context=n;const b=n.gl;this.buffer=b.createBuffer(),this.dynamicDraw=!!p,this.context.unbindVAO(),n.bindElementBuffer.set(this.buffer),b.bufferData(b.ELEMENT_ARRAY_BUFFER,c.arrayBuffer,this.dynamicDraw?b.DYNAMIC_DRAW:b.STATIC_DRAW),this.dynamicDraw||y||c.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(n){this.id=l.uniqueIdxCounter,l.uniqueIdxCounter++;const c=this.context.gl;this.context.unbindVAO(),this.bind(),c.bufferSubData(c.ELEMENT_ARRAY_BUFFER,0,n.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}return l.uniqueIdxCounter=0,l})();const Nr={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Ro{constructor(t,n,c,p,y,b){this.length=n.length,this.attributes=c,this.itemSize=n.bytesPerElement,this.dynamicDraw=p,this.instanceCount=b,this.context=t;const E=t.gl;this.buffer=E.createBuffer(),t.bindVertexBuffer.set(this.buffer),E.bufferData(E.ARRAY_BUFFER,n.arrayBuffer,this.dynamicDraw?E.DYNAMIC_DRAW:E.STATIC_DRAW),this.dynamicDraw||y||n.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const n=this.context.gl;this.bind(),n.bufferSubData(n.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,n){for(let c=0;c<this.attributes.length;c++){const p=n.attributes[this.attributes[c].name];void 0!==p&&t.enableVertexAttribArray(p)}}setVertexAttribPointers(t,n,c){for(let p=0;p<this.attributes.length;p++){const y=this.attributes[p],b=n.attributes[y.name];void 0!==b&&t.vertexAttribPointer(b,y.components,t[Nr[y.type]],!1,this.itemSize,y.offset+this.itemSize*(c||0))}}setVertexAttribDivisor(t,n,c){for(let p=0;p<this.attributes.length;p++){const y=n.attributes[this.attributes[p].name];void 0!==y&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(y,c)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class xs{constructor(t,n,c,p,y){this.context=t,this.width=n,this.height=c;const b=this.framebuffer=t.gl.createFramebuffer();p&&(this.colorAttachment=new Hl(t,b)),y&&(this.depthAttachmentType=y,this.depthAttachment="renderbuffer"===y?new $h(t,b):new Po(t,b))}destroy(){const t=this.context.gl;if(this.colorAttachment){const n=this.colorAttachment.get();n&&t.deleteTexture(n)}if(this.depthAttachment&&this.depthAttachmentType)if("renderbuffer"===this.depthAttachmentType){const n=this.depthAttachment.get();n&&t.deleteRenderbuffer(n)}else{const n=this.depthAttachment.get();n&&t.deleteTexture(n)}t.deleteFramebuffer(this.framebuffer)}}class eu{constructor(t,n){this.gl=t,this.clearColor=new Mc(this),this.clearDepth=new Gl(this),this.clearStencil=new Nh(this),this.colorMask=new Vh(this),this.depthMask=new Ka(this),this.stencilMask=new Ec(this),this.stencilFunc=new qu(this),this.stencilOp=new ql(this),this.stencilTest=new as(this),this.depthRange=new Hu(this),this.depthTest=new Br(this),this.depthFunc=new Uh(this),this.blend=new Ac(this),this.blendFunc=new Ic(this),this.blendColor=new Cc(this),this.blendEquation=new Pc(this),this.cullFace=new Ja(this),this.cullFaceSide=new jh(this),this.frontFace=new Gh(this),this.program=new Dc(this),this.activeTexture=new qh(this),this.viewport=new Wu(this),this.bindFramebuffer=new oa(this),this.bindRenderbuffer=new Ld(this),this.bindTexture=new kd(this),this.bindVertexBuffer=new Od(this),this.bindElementBuffer=new Fd(this),this.bindVertexArrayOES=new Hh(this),this.pixelStoreUnpack=new Bd(this),this.pixelStoreUnpackPremultiplyAlpha=new zc(this),this.pixelStoreUnpackFlipY=new $u(this),this.options=n?Object.assign({},n):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=n&&!!n.forceManualRenderingForInstanceIDShaders||this.renderer&&-1!==this.renderer.indexOf("PowerVR"),this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,n,c){return new jc(this,t,n,c)}createVertexBuffer(t,n,c,p,y){return new Ro(this,t,n,c,p,y)}createRenderbuffer(t,n,c){const p=this.gl,y=p.createRenderbuffer();return this.bindRenderbuffer.set(y),p.renderbufferStorage(p.RENDERBUFFER,t,n,c),this.bindRenderbuffer.set(null),y}createFramebuffer(t,n,c,p){return new xs(this,t,n,c,p)}clear({color:t,depth:n,stencil:c,colorMask:p}){const y=this.gl;let b=0;t&&(b|=y.COLOR_BUFFER_BIT,this.clearColor.set(t),this.colorMask.set(p||[!0,!0,!0,!0])),void 0!==n&&(b|=y.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(n),this.depthMask.set(!0)),void 0!==c&&(b|=y.STENCIL_BUFFER_BIT,this.clearStencil.set(c),this.stencilMask.set(255)),y.clear(b)}setCullFace(t){!1===t.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){o.bn(t.blendFunction,li.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let il;function Gc(l,t,n,c,p,y,b){const E=l.context,D=E.gl,L=l.transform,k=l.getOrCreateProgram("collisionBox"),N=[];let V=0,j=0;for(let ce=0;ce<c.length;ce++){const ge=c[ce],pe=t.getTile(ge),_e=pe.getBucket(n);if(!_e)continue;const de=gs(ge,_e,L);let be=de;0===p[0]&&0===p[1]||(be=l.translatePosMatrix(de,pe,p,y));const Ee=b?_e.textCollisionBox:_e.iconCollisionBox,qe=_e.collisionCircleArray;if(qe.length>0){const Le=o.ab.mat4.create(),Ye=be;o.ab.mat4.mul(Le,_e.placementInvProjMatrix,L.glCoordMatrix),o.ab.mat4.mul(Le,Le,_e.placementViewportMatrix),N.push({circleArray:qe,circleOffset:j,transform:Ye,invTransform:Le,projection:_e.getProjection()}),V+=qe.length/4,j=V}Ee&&(l.terrain&&l.terrain.setupElevationDraw(pe,k),k.draw(l,D.LINES,zt.disabled,qt.disabled,l.colorModeForRenderPass(),Wt.disabled,Qu(be,L,pe,_e.getProjection()),n.id,Ee.layoutVertexBuffer,Ee.indexBuffer,Ee.segments,null,L.zoom,null,[Ee.collisionVertexBuffer,Ee.collisionVertexBufferExt]))}if(!b||!N.length)return;const Y=l.getOrCreateProgram("collisionCircle"),Z=new o.cV;Z.resize(4*V),Z._trim();let Q=0;for(const ce of N)for(let ge=0;ge<ce.circleArray.length/4;ge++){const pe=4*ge,_e=ce.circleArray[pe+0],de=ce.circleArray[pe+1],be=ce.circleArray[pe+2],Ee=ce.circleArray[pe+3];Z.emplace(Q++,_e,de,be,Ee,0),Z.emplace(Q++,_e,de,be,Ee,1),Z.emplace(Q++,_e,de,be,Ee,2),Z.emplace(Q++,_e,de,be,Ee,3)}(!il||il.length<2*V)&&(il=function(ce){const ge=2*ce,pe=new o.aU;pe.resize(ge),pe._trim();for(let _e=0;_e<ge;_e++){const de=6*_e;pe.uint16[de+0]=4*_e+0,pe.uint16[de+1]=4*_e+1,pe.uint16[de+2]=4*_e+2,pe.uint16[de+3]=4*_e+2,pe.uint16[de+4]=4*_e+3,pe.uint16[de+5]=4*_e+0}return pe}(V));const J=E.createIndexBuffer(il,!0),re=E.createVertexBuffer(Z,o.cW.members,!0);for(const ce of N){const ge={u_matrix:ce.transform,u_inv_matrix:ce.invTransform,u_camera_to_center_distance:(he=L).getCameraToCenterDistance(ce.projection),u_viewport_size:[he.width,he.height]};Y.draw(l,D.TRIANGLES,zt.disabled,qt.disabled,l.colorModeForRenderPass(),Wt.disabled,ge,n.id,re,J,o.b7.simpleSegment(0,2*ce.circleOffset,ce.circleArray.length,ce.circleArray.length/2),null,L.zoom)}var he;re.destroy(),J.destroy()}const Kl=o.ab.mat4.create();function Zr(l){const t=l._camera.getWorldToCamera(l.worldSize,1),n=o.ab.mat4.multiply([],t,l.globeMatrix);o.ab.mat4.invert(n,n);const c=[0,0,0],p=[0,1,0,0];return o.ab.vec4.transformMat4(p,p,n),c[0]=p[0],c[1]=p[1],c[2]=p[2],o.ab.vec3.normalize(c,c),c}function Zi({width:l,height:t,anchor:n,textOffset:c,textScale:p},y){const{horizontalAlign:b,verticalAlign:E}=o.bD(n),D=-(b-.5)*l,L=-(E-.5)*t,k=o.bC(n,c);return new o.P((D/p+k[0])*y,(L/p+k[1])*y)}function qc(l,t,n,c,p,y,b,E,D,L,k){const N=l.text.placedSymbolArray,V=l.text.dynamicLayoutVertexArray,j=l.icon.dynamicLayoutVertexArray,Y={},Z=l.getProjection(),Q=Ks(E,Z,y),J=y.elevation,re=Z.upVectorScale(E.canonical,y.center.lat,y.worldSize).metersToTile;V.clear();for(let he=0;he<N.length;he++){const ce=N.get(he),{tileAnchorX:ge,tileAnchorY:pe,numGlyphs:_e}=ce,de=ce.hidden||!ce.crossTileID||l.allowVerticalPlacement&&!ce.placedOrientation?null:c[ce.crossTileID];if(de){let be=0,Ee=0,qe=0;if(J){const We=J?J.getAtTileOffset(E,ge,pe):0,[ut,et,Ke]=Z.upVector(E.canonical,ge,pe);be=We*ut*re,Ee=We*et*re,qe=We*Ke*re}let[Le,Ye,Xe,Re]=lr(ce.projectedAnchorX+be,ce.projectedAnchorY+Ee,ce.projectedAnchorZ+qe,n?Q:b);const He=Il(y.getCameraToCenterDistance(Z),Re);let it=p.evaluateSizeForFeature(l.textSizeData,L,ce)*He/o.bw;n&&(it*=l.tilePixelRatio/D);const De=Zi(de,it);n?(({x:Le,y:Ye,z:Xe}=Z.projectTilePoint(ge+De.x,pe+De.y,E.canonical)),[Le,Ye,Xe]=lr(Le+be,Ye+Ee,Xe+qe,b)):(t&&De._rotate(-y.angle),Le+=De.x,Ye+=De.y,Xe=0);const Je=l.allowVerticalPlacement&&ce.placedOrientation===o.bq.vertical?Math.PI/2:0;for(let We=0;We<_e;We++)o.bt(V,Le,Ye,Xe,Je);k&&ce.associatedIconIndex>=0&&(Y[ce.associatedIconIndex]={x:Le,y:Ye,z:Xe,angle:Je})}else en(_e,V)}if(k){j.clear();const he=l.icon.placedSymbolArray;for(let ce=0;ce<he.length;ce++){const ge=he.get(ce),{numGlyphs:pe}=ge,_e=Y[ce];if(ge.hidden||!_e)en(pe,j);else{const{x:de,y:be,z:Ee,angle:qe}=_e;for(let Le=0;Le<pe;Le++)o.bt(j,de,be,Ee,qe)}}l.icon.dynamicLayoutVertexBuffer.updateData(j)}l.text.dynamicLayoutVertexBuffer.updateData(V)}function Jl(l,t,n,c,p,y,b={}){const E=n.paint.get("icon-translate"),D=n.paint.get("text-translate"),L=n.paint.get("icon-translate-anchor"),k=n.paint.get("text-translate-anchor"),N=n.layout.get("icon-rotation-alignment"),V=n.layout.get("text-rotation-alignment"),j=n.layout.get("icon-pitch-alignment"),Y=n.layout.get("text-pitch-alignment"),Z=n.layout.get("icon-keep-upright"),Q=n.layout.get("text-keep-upright"),J=n.paint.get("icon-color-saturation"),re=n.paint.get("icon-color-contrast"),he=n.paint.get("icon-color-brightness-min"),ce=n.paint.get("icon-color-brightness-max"),ge="sea"===n.layout.get("symbol-elevation-reference"),pe=l.context,_e=pe.gl,de=l.transform,be="map"===N,Ee="map"===V,qe="map"===j,Le="map"===Y,Ye=void 0!==n.layout.get("symbol-sort-key").constantOr(1);let Xe=!1;const Re=l.depthModeForSublayer(0,zt.ReadOnly),He=[o.at(de.center.lng),o.aA(de.center.lat)],it=n.layout.get("text-variable-anchor"),De="globe"===de.projection.name,Je=[],We=[0,-1,0];for(const ut of c){const et=t.getTile(ut),Ke=et.getBucket(n);if(!Ke||"mercator"===Ke.projection.name&&De||Ke.fullyClipped)continue;const rt="globe"===Ke.projection.name,ct=rt?o.ae(de.zoom):0,_t=Ks(ut,Ke.getProjection(),de),Tt=de.calculatePixelsToTileUnitsMatrix(et),jt=it&&Ke.hasTextData(),Lt=Ke.hasIconTextFit()&&jt&&Ke.hasIconData(),kt=Ke.getProjection().createInversionMatrix(de,ut.canonical),Zt=Di=>{de.depthOcclusionForSymbolsAndCircles&&(n.hasInitialOcclusionOpacityProperties||l.terrain)&&(Di.push("DEPTH_D24"),Di.push("DEPTH_OCCLUSION"))},di=()=>{const Di=be&&"point"!==n.layout.get("symbol-placement"),ki=[];Zt(ki);const un=Di||Lt,jn=n.paint.get("icon-image-cross-fade").constantOr(0);l.terrainRenderModeElevated()&&qe&&ki.push("PITCH_WITH_MAP_TERRAIN"),rt&&(ki.push("PROJECTION_GLOBE_VIEW"),un&&ki.push("PROJECTED_POS_ON_VIEWPORT")),jn>0&&ki.push("ICON_TRANSITION"),Ke.icon.zOffsetVertexBuffer&&ki.push("Z_OFFSET"),0===J&&0===re&&0===he&&1===ce||ki.push("COLOR_ADJUSTMENT"),Ke.sdfIcons&&ki.push("RENDER_SDF");const An=Ke.icon.programConfigurations.get(n.id),Mn=l.getOrCreateProgram("symbol",{config:An,defines:ki}),Qr=et.imageAtlasTexture?et.imageAtlasTexture.size:[0,0],mr=Ke.iconSizeData,dn=o.bp(mr,de.zoom),ji=qe||0!==de.pitch,vi=Kn(_t,et.tileID.canonical,qe,be,de,Ke.getProjection(),Tt),bi=bc(_t,et.tileID.canonical,qe,be,de,Ke.getProjection(),Tt),wn=l.translatePosMatrix(bi,et,E,L,!0),kn=l.translatePosMatrix(_t,et,E,L),Xi=un?Kl:vi,_r=be&&!qe&&!Di;let es=We;!De&&!de.mercatorFromTransition||be||(es=Zr(de));const Ur=rt?es:We,Tr=n.getColorAdjustmentMatrix(J,re,he,ce),hs=ma(mr.kind,dn,_r,qe,l,kn,Xi,wn,ge,!1,Qr,[0,0],!0,ut,ct,He,kt,Ur,Ke.getProjection(),Tr,jn),Dr=et.imageAtlasTexture?et.imageAtlasTexture:null,ts=1!==n.layout.get("icon-size").constantOr(0)||Ke.iconsNeedLinear,wa=Ke.sdfIcons||l.options.rotating||l.options.zooming||ts||ji?_e.LINEAR:_e.NEAREST,js=Ke.sdfIcons&&0!==n.paint.get("icon-halo-width").constantOr(1),Ta=l.terrain&&qe&&Di?o.ab.mat4.invert(o.ab.mat4.create(),vi):Kl;if(Di&&Ke.icon){const xl=de.elevation,rh=xl?xl.getAtTileOffsetFunc(ut,de.center.lat,de.worldSize,Ke.getProjection()):null,Su=sn(_t,et.tileID.canonical,qe,be,de,Ke.getProjection(),Tt);ea(Ke,_t,l,!1,Su,bi,qe,Z,rh,ut)}return{program:Mn,buffers:Ke.icon,uniformValues:hs,atlasTexture:Dr,atlasTextureIcon:null,atlasInterpolation:wa,atlasInterpolationIcon:null,isSDF:Ke.sdfIcons,hasHalo:js,tile:et,labelPlaneMatrixInv:Ta}},Ni=()=>{const Di=Ee&&"point"!==n.layout.get("symbol-placement"),ki=[],un=Di||it||Lt;l.terrainRenderModeElevated()&&Le&&ki.push("PITCH_WITH_MAP_TERRAIN"),rt&&(ki.push("PROJECTION_GLOBE_VIEW"),un&&ki.push("PROJECTED_POS_ON_VIEWPORT")),Ke.text.zOffsetVertexBuffer&&ki.push("Z_OFFSET"),Ke.iconsInText&&ki.push("RENDER_TEXT_AND_SYMBOL"),ki.push("RENDER_SDF"),Zt(ki);const jn=Ke.text.programConfigurations.get(n.id),An=l.getOrCreateProgram("symbol",{config:jn,defines:ki});let Mn,Qr=[0,0],mr=null;const dn=Ke.textSizeData;Ke.iconsInText&&(Qr=et.imageAtlasTexture?et.imageAtlasTexture.size:[0,0],mr=et.imageAtlasTexture?et.imageAtlasTexture:null,Mn=Le||0!==de.pitch||l.options.rotating||l.options.zooming||"composite"===dn.kind||"camera"===dn.kind?_e.LINEAR:_e.NEAREST);const ji=et.glyphAtlasTexture?et.glyphAtlasTexture.size:[0,0],vi=n.layout.get("text-size-scale-range"),bi=o.aw(l.scaleFactor,vi[0],vi[1]),wn=o.bp(dn,de.zoom,bi),kn=Kn(_t,et.tileID.canonical,Le,Ee,de,Ke.getProjection(),Tt),Xi=bc(_t,et.tileID.canonical,Le,Ee,de,Ke.getProjection(),Tt),_r=l.translatePosMatrix(Xi,et,D,k,!0),es=l.translatePosMatrix(_t,et,D,k),Ur=un?Kl:kn,Tr=Ee&&!Le&&!Di;let hs=We;!De&&!de.mercatorFromTransition||Ee||(hs=Zr(de));const Dr=ma(dn.kind,wn,Tr,Le,l,es,Ur,_r,ge,!0,ji,Qr,!0,ut,ct,He,kt,rt?hs:We,Ke.getProjection(),null,null,bi),ts=et.glyphAtlasTexture?et.glyphAtlasTexture:null,wa=_e.LINEAR,js=0!==n.paint.get("text-halo-width").constantOr(1),Ta=l.terrain&&Le&&Di?o.ab.mat4.invert(o.ab.mat4.create(),kn):Kl;if(Di&&Ke.text){const xl=de.elevation,rh=xl?xl.getAtTileOffsetFunc(ut,de.center.lat,de.worldSize,Ke.getProjection()):null,Su=sn(_t,et.tileID.canonical,Le,Ee,de,Ke.getProjection(),Tt);ea(Ke,_t,l,!0,Su,Xi,Le,Q,rh,ut)}return{program:An,buffers:Ke.text,uniformValues:Dr,atlasTexture:ts,atlasTextureIcon:mr,atlasInterpolation:wa,atlasInterpolationIcon:Mn,isSDF:!0,hasHalo:js,tile:et,labelPlaneMatrixInv:Ta}},hn=Ke.icon.segments.get().length,nn=Ke.text.segments.get().length,Kt=hn&&!b.onlyText?di():null,Ei=nn&&!b.onlyIcons?Ni():null,Pt=n.paint.get("icon-opacity").constantOr(1),pi=n.paint.get("text-opacity").constantOr(1);if(Ye&&Ke.canOverlap){Xe=!0;const Di=Pt&&!b.onlyText?Ke.icon.segments.get():[],ki=pi&&!b.onlyIcons?Ke.text.segments.get():[];for(const un of Di)Je.push({segments:new o.b7([un]),sortKey:un.sortKey,state:Kt});for(const un of ki)Je.push({segments:new o.b7([un]),sortKey:un.sortKey,state:Ei})}else b.onlyText||Je.push({segments:Pt?Ke.icon.segments:new o.b7([]),sortKey:0,state:Kt}),b.onlyIcons||Je.push({segments:pi?Ke.text.segments:new o.b7([]),sortKey:0,state:Ei})}Xe&&Je.sort((ut,et)=>ut.sortKey-et.sortKey);for(const ut of Je){const et=ut.state;if(et)if(l.terrain?l.terrain.setupElevationDraw(et.tile,et.program,{useDepthForOcclusion:de.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:et.labelPlaneMatrixInv}):l.setupDepthForOcclusion(de.depthOcclusionForSymbolsAndCircles,et.program),pe.activeTexture.set(_e.TEXTURE0),et.atlasTexture&&et.atlasTexture.bind(et.atlasInterpolation,_e.CLAMP_TO_EDGE,!0),et.atlasTextureIcon&&(pe.activeTexture.set(_e.TEXTURE1),et.atlasTextureIcon&&et.atlasTextureIcon.bind(et.atlasInterpolationIcon,_e.CLAMP_TO_EDGE,!0)),l.uploadCommonLightUniforms(l.context,et.program),et.hasHalo){const Ke=et.uniformValues;Ke.u_is_halo=1,Ql(et.buffers,ut.segments,n,l,et.program,Re,p,y,Ke,2),Ke.u_is_halo=0}else{if(et.isSDF){const Ke=et.uniformValues;et.hasHalo&&(Ke.u_is_halo=1,Ql(et.buffers,ut.segments,n,l,et.program,Re,p,y,Ke,1)),Ke.u_is_halo=0}Ql(et.buffers,ut.segments,n,l,et.program,Re,p,y,et.uniformValues,1)}}}function Ql(l,t,n,c,p,y,b,E,D,L){const k=[l.dynamicLayoutVertexBuffer,l.opacityVertexBuffer,l.iconTransitioningVertexBuffer,l.globeExtVertexBuffer,l.zOffsetVertexBuffer];p.draw(c,c.context.gl.TRIANGLES,y,b,E,Wt.disabled,D,n.id,l.layoutVertexBuffer,l.indexBuffer,t,n.paint,c.transform.zoom,l.programConfigurations.get(n.id),k,L)}function Hc(l,t,n,c,p,y,b){const E=l.context.gl,D=n.paint.get("fill-pattern"),L=n.is3D(),k=L?l.stencilModeFor3D():qt.disabled,N=D&&D.constantOr(1);let V,j,Y,Z,Q;b?(j=N&&!n.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",V=E.LINES):(j=N?"fillPattern":"fill",V=E.TRIANGLES);for(const J of c){const re=t.getTile(J);if(N&&!re.patternsLoaded())continue;const he=re.getBucket(n);if(!he)continue;l.prepareDrawTile();const ce=he.programConfigurations.get(n.id),ge=l.isTileAffectedByFog(J),pe=l.getOrCreateProgram(j,{config:ce,overrideFog:ge});N&&(l.context.activeTexture.set(E.TEXTURE0),re.imageAtlasTexture&&re.imageAtlasTexture.bind(E.LINEAR,E.CLAMP_TO_EDGE),ce.updatePaintBuffers());const _e=D.constantOr(null);if(_e&&re.imageAtlas){const Ee=re.imageAtlas,qe=o.A.from(_e).getPrimary().scaleSelf(o.q.devicePixelRatio).serialize(),Le=Ee.patternPositions[qe];Le&&ce.setConstantPatternPositions(Le)}const de=l.translatePosMatrix(J.projMatrix,re,n.paint.get("fill-translate"),n.paint.get("fill-translate-anchor")),be=n.paint.get("fill-emissive-strength");if(b){Z=he.indexBuffer2,Q=he.segments2;const Ee=l.terrain&&l.terrain.renderingToTexture?l.terrain.drapeBufferSize:[E.drawingBufferWidth,E.drawingBufferHeight];Y="fillOutlinePattern"===j&&N?dr(de,be,l,re,Ee):Oc(de,be,Ee)}else Z=he.indexBuffer,Q=he.segments,Y=N?zo(de,be,l,re):io(de,be);l.uploadCommonUniforms(l.context,pe,J.toUnwrapped()),pe.draw(l,V,p,L?k:l.stencilModeForClipping(J),y,Wt.disabled,Y,n.id,he.layoutVertexBuffer,Z,Q,n.paint,l.transform.zoom,ce,void 0)}}function nl(l,t,n,c,p,y,b,E){n.resetLayerRenderingStats(l);const D=l.context,L=D.gl,k=l.transform,N=n.paint.get("fill-extrusion-pattern"),V=N.constantOr(1),j=n.paint.get("fill-extrusion-opacity"),Y=l.style.enable3dLights(),Z=n.paint.get(Y&&!V?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),Q=[n.paint.get("fill-extrusion-ambient-occlusion-intensity"),Z],J=n.layout.get("fill-extrusion-edge-radius"),re=J>0&&!n.paint.get("fill-extrusion-rounded-roof"),he=re?0:J,ce="globe"===k.projection.name?o.d3():0,ge="globe"===k.projection.name,pe=ge?o.ae(k.zoom):0,_e=[o.at(k.center.lng),o.aA(k.center.lat)],de="none"===n.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),be=n.paint.get("fill-extrusion-flood-light-color").toRenderColor(de?null:n.lut).toArray01().slice(0,3),Ee=n.paint.get("fill-extrusion-flood-light-intensity"),qe=n.paint.get("fill-extrusion-vertical-scale"),Le=0!==n.paint.get("fill-extrusion-line-width").constantOr(1),Ye=n.paint.get("fill-extrusion-height-alignment"),Xe=n.paint.get("fill-extrusion-base-alignment"),Re=To(l,n.paint.get("fill-extrusion-cutoff-fade-range")),He=[];let it;ge&&He.push("PROJECTION_GLOBE_VIEW"),Q[0]>0&&He.push("FAUX_AO"),re&&He.push("ZERO_ROOF_RADIUS"),E&&He.push("HAS_CENTROID"),Ee>0&&He.push("FLOOD_LIGHT"),Re.shouldRenderCutoff&&He.push("RENDER_CUTOFF"),Le&&He.push("RENDER_WALL_MODE");const De="shadow"===l.renderPass,Je=l.shadowRenderer,We=De&&!!Je;l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0);let ut=[0,0,0];if(Je){const rt=l.style.directionalLight,ct=l.style.ambientLight;rt&&ct&&(ut=Dh(l.style,rt,ct)),De||(He.push("RENDER_SHADOWS","DEPTH_TEXTURE"),Je.useNormalOffset&&He.push("NORMAL_OFFSET")),it=He.concat(["SHADOWS_SINGLE_CASCADE"])}const et=We?"fillExtrusionDepth":V?"fillExtrusionPattern":"fillExtrusion",Ke=n.getLayerRenderingStats();for(const rt of c){const ct=t.getTile(rt),_t=ct.getBucket(n);if(!_t||_t.projection.name!==k.projection.name)continue;let Tt=!1;Je&&(Tt=0===Je.getMaxCascadeForTile(rt.toUnwrapped()));const jt=l.isTileAffectedByFog(rt),Lt=_t.programConfigurations.get(n.id),kt=l.getOrCreateProgram(et,{config:Lt,defines:Tt?it:He,overrideFog:jt});if(l.terrain&&l.terrain.setupElevationDraw(ct,kt,{useMeterToDem:!0}),!_t.centroidVertexBuffer){const Ei=kt.attributes.a_centroid_pos;void 0!==Ei&&L.vertexAttrib2f(Ei,0,0)}!De&&Je&&Je.setupShadows(ct.tileID.toUnwrapped(),kt,"vector-tile",ct.tileID.overscaledZ),V&&(l.context.activeTexture.set(L.TEXTURE0),ct.imageAtlasTexture&&ct.imageAtlasTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),Lt.updatePaintBuffers());const Zt=N.constantOr(null);if(Zt&&ct.imageAtlas){const Ei=ct.imageAtlas,Pt=o.A.from(Zt).getPrimary().scaleSelf(o.q.devicePixelRatio),pi=Ei.patternPositions[Pt.serialize()];pi&&Lt.setConstantPatternPositions(pi)}const di=n.paint.get("fill-extrusion-vertical-gradient"),Ni=1/_t.tileToMeter;let hn;if(De&&Je){if(ol(ct.tileID,_t,l))continue;const Ei=Je.calculateShadowPassMatrixFromTile(ct.tileID.toUnwrapped());hn=Zl(Ei,he,Ni,qe,Ye,Xe)}else{const Ei=l.translatePosMatrix(rt.expandedProjMatrix,ct,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),Pt=k.projection.createInversionMatrix(k,rt.canonical);hn=V?Ju(Ei,l,di,j,Q,he,Ni,rt,ct,ce,Ye,Xe,pe,_e,Pt,be,qe):kc(Ei,l,di,j,Q,he,Ni,rt,ce,Ye,Xe,pe,_e,Pt,be,qe,Ee,ut)}l.uploadCommonUniforms(D,kt,rt.toUnwrapped(),null,Re);let nn=_t.segments;if("mercator"===k.projection.name&&!De&&(nn=_t.getVisibleSegments(ct.tileID,l.terrain,l.transform.getFrustum(0)),!nn.get().length))continue;if(Ke)if(De)for(const Ei of nn.get())Ke.numRenderedVerticesInShadowPass+=Ei.primitiveLength;else for(const Ei of nn.get())Ke.numRenderedVerticesInTransparentPass+=Ei.primitiveLength;const Kt=[];(l.terrain||E)&&Kt.push(_t.centroidVertexBuffer),ge&&Kt.push(_t.layoutVertexExtBuffer),Le&&Kt.push(_t.wallVertexBuffer),kt.draw(l,D.gl.TRIANGLES,p,y,b,Wt.backCCW,hn,n.id,_t.layoutVertexBuffer,_t.indexBuffer,nn,n.paint,l.transform.zoom,Lt,Kt)}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1)}function rl(l,t,n,c,p,y,b,E,D,L,k,N,V,j,Y,Z,Q,J,re){const he=l.context,ce=he.gl,ge=l.transform,pe=l.transform.zoom,_e=[],de=To(l,n.paint.get("fill-extrusion-cutoff-fade-range"));"clear"===L?(_e.push("CLEAR_SUBPASS"),re&&(_e.push("CLEAR_FROM_TEXTURE"),he.activeTexture.set(ce.TEXTURE0),re.bind(ce.LINEAR,ce.CLAMP_TO_EDGE))):"sdf"===L&&_e.push("SDF_SUBPASS"),Q&&_e.push("HAS_CENTROID"),de.shouldRenderCutoff&&_e.push("RENDER_CUTOFF");const be=n.layout.get("fill-extrusion-edge-radius"),Ee=(qe,Le,Ye,Xe,Re)=>{const He=Le.programConfigurations.get(n.id),it=l.isTileAffectedByFog(qe),De=l.getOrCreateProgram("fillExtrusionGroundEffect",{config:He,defines:_e,overrideFog:it}),Je=((ut,et,Ke,rt,ct,_t,Tt,jt,Lt,kt,Zt)=>({u_matrix:et,u_opacity:Ke,u_ao_pass:rt?1:0,u_meter_to_tile:ct,u_ao:_t,u_flood_light_intensity:Tt,u_flood_light_color:jt,u_attenuation:Lt,u_edge_radius:kt,u_fb:0,u_fb_size:Zt,u_dynamic_offset:1}))(0,Xe,k,D,Re,[N,V*Re],j,Y,Z,pe>=17?0:be*Re,re?re.size[0]:0),We=[];Q&&We.push(Le.hiddenByLandmarkVertexBuffer),l.uploadCommonUniforms(he,De,qe.toUnwrapped(),null,de),De.draw(l,he.gl.TRIANGLES,p,y,b,E,Je,n.id,Le.vertexBuffer,Le.indexBuffer,Ye,n.paint,pe,He,We)};for(const qe of c){const Le=t.getTile(qe),Ye=Le.getBucket(n);if(!Ye||Ye.projection.name!==ge.projection.name||!Ye.groundEffect||Ye.groundEffect&&!Ye.groundEffect.hasData())continue;const Xe=Ye.groundEffect,Re=1/Ye.tileToMeter;{const He=l.translatePosMatrix(qe.projMatrix,Le,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),it=Xe.getDefaultSegment();Ee(qe,Xe,it,He,Re)}if(J)for(let He=0;He<4;He++){const it=o.d4[He](qe),De=t.getTile(it);if(!De)continue;const Je=De.getBucket(n);if(!Je||Je.projection.name!==ge.projection.name||!Je.groundEffect||Je.groundEffect&&!Je.groundEffect.hasData())continue;const We=Je.groundEffect;let ut,et;0===He?(ut=[-o.ag,0,0],et=1):1===He?(ut=[o.ag,0,0],et=0):2===He?(ut=[0,-o.ag,0],et=3):(ut=[0,o.ag,0],et=2);const Ke=We.regionSegments[et];if(!Ke)continue;const rt=new Float32Array(16);o.ab.mat4.translate(rt,qe.projMatrix,ut),Ee(qe,We,Ke,l.translatePosMatrix(rt,Le,n.paint.get("fill-extrusion-translate"),n.paint.get("fill-extrusion-translate-anchor")),Re)}}}function sl(l,t,n,c,p,y,b){0===c.centroidVertexArray.length&&c.createCentroidsBuffer();const E=y?y.findDEMTileFor(n):null;if(!(E&&E.dem||b))return;y&&E&&E.dem&&c.selfDEMTileTimestamp!==E.dem._timestamp&&(c.borderDoneWithNeighborZ=[-1,-1,-1,-1],c.selfDEMTileTimestamp=E.dem._timestamp);const D=J=>new o.P(Math.ceil((J+o.d7)*o.d8),0),L=J=>{const re=t.getSource().minzoom,he=ge=>{const pe=t.getTileByID(ge);if(pe&&pe.hasData())return pe.getBucket(p)},ce=[0,-1,1];for(const ge of ce){if(J.overscaledZ+ge<re)continue;const pe=he(J.calculateScaledKey(J.overscaledZ+ge));if(pe)return pe}},k=[0,0,0],N=(J,re)=>(k[0]=Math.min(J.min.y,re.min.y),k[1]=Math.max(J.max.y,re.max.y),k[2]=o.ag-re.min.x>J.max.x?re.min.x-o.ag:J.max.x,k),V=(J,re)=>(k[0]=Math.min(J.min.x,re.min.x),k[1]=Math.max(J.max.x,re.max.x),k[2]=o.ag-re.min.y>J.max.y?re.min.y-o.ag:J.max.y,k),j=[(J,re)=>N(J,re),(J,re)=>N(re,J),(J,re)=>V(J,re),(J,re)=>V(re,J)],Y=(J,re,he,ce,ge,pe,_e)=>{if(!y)return 0;const de=[[pe?he:J,pe?J:he,0],[pe?he:re,pe?re:he,0]],be=_e<0?o.ag+_e:_e,Ee=[pe?be:(J+re)/2,pe?(J+re)/2:be,0];return 0===he&&_e<0||0!==he&&_e>0?y.getForTilePoints(ge,[Ee],!0,ce):de.push(Ee),y.getForTilePoints(n,de,!0,E),Math.max(de[0][2],de[1][2],Ee[2])/y.exaggeration()};for(let J=0;J<4;J++){const re=c.borderFeatureIndices[J];if(0===re.length)continue;const he=o.d4[J](n),ce=L(he);if(!(ce&&ce instanceof o.d5))continue;const ge=y?y.findDEMTileFor(he):null;if(!(ge&&ge.dem||b)||(y&&ge&&ge.dem&&c.borderDEMTileTimestamp[J]!==ge.dem._timestamp&&(c.borderDoneWithNeighborZ[J]=-1,c.borderDEMTileTimestamp[J]=ge.dem._timestamp),c.borderDoneWithNeighborZ[J]===ce.canonical.z))continue;0===ce.centroidVertexArray.length&&ce.createCentroidsBuffer();const pe=(J<2?1:5)-J,_e=ce.borderDoneWithNeighborZ[pe]!==c.canonical.z,de=ce.borderFeatureIndices[pe];let be=0;if(c.canonical.z!==ce.canonical.z){for(const Ee of re)c.showCentroid(c.featuresOnBorder[Ee]);if(_e)for(const Ee of de)ce.showCentroid(ce.featuresOnBorder[Ee]);c.borderDoneWithNeighborZ[J]=ce.canonical.z,ce.borderDoneWithNeighborZ[pe]=c.canonical.z}for(const Ee of re){const qe=c.featuresOnBorder[Ee],Le=c.centroidData[qe.centroidDataIndex],Ye=qe.borders[J];let Xe;for(;be<de.length;){Xe=ce.featuresOnBorder[de[be]];const Re=Xe.borders[pe];if(Re[1]>Ye[0]+3||Re[0]>Ye[0]-3)break;ce.showCentroid(Xe),be++}if(Xe&&be<de.length){const Re=be;let He=0;for(;!(Xe.borders[pe][0]>Ye[1]-3)&&(He++,++be!==de.length);)Xe=ce.featuresOnBorder[de[be]];Xe=ce.featuresOnBorder[de[Re]];let it=!1;if(He>=1){const We=Xe.borders[pe];Math.abs(Ye[0]-We[0])<3&&Math.abs(Ye[1]-We[1])<3&&(He=1,it=!0,be=Re+1)}else if(0===He){c.showCentroid(qe);continue}const De=ce.centroidData[Xe.centroidDataIndex];b&&it&&(((Z=Le).flags|(Q=De).flags)&o.d6?(Z.flags|=o.d6,Q.flags|=o.d6):(Z.flags&=~o.d6,Q.flags&=~o.d6));const Je=qe.intersectsCount()>1||Xe.intersectsCount()>1;if(He>1)be=Re,Le.centroidXY=De.centroidXY=new o.P(0,0);else if(ge&&ge.dem&&!Je){const We=j[J](Le,De),ut=J%2?o.ag-1:0,et=Y(We[0],Math.min(o.ag-1,We[1]),ut,ge,he,J<2,We[2]);Le.centroidXY=De.centroidXY=D(et)}else Je?Le.centroidXY=De.centroidXY=new o.P(0,0):(Le.centroidXY=c.encodeBorderCentroid(qe),De.centroidXY=ce.encodeBorderCentroid(Xe));c.writeCentroidToBuffer(Le),ce.writeCentroidToBuffer(De)}else c.showCentroid(qe)}c.borderDoneWithNeighborZ[J]=ce.canonical.z,ce.borderDoneWithNeighborZ[pe]=c.canonical.z}var Z,Q;(c.needsCentroidUpdate||!c.centroidVertexBuffer&&0!==c.centroidVertexArray.length)&&c.uploadCentroid(l)}const Ls=[1,0,0],at=[0,1,0],bt=[0,0,1];function ol(l,t,n){const c=n.transform,p=n.shadowRenderer;if(!p)return!0;const y=l.toUnwrapped(),b=c.tileSize*p._cascades[n.currentShadowCascade].scale;let E=t.maxHeight;if(c.elevation){const Z=c.elevation.getMinMaxForTile(l);Z&&(E+=Z.max)}const D=[...p.shadowDirection];D[2]=-D[2];const L=p.computeSimplifiedTileShadowVolume(y,E,b,D);if(!L)return!1;const k=[Ls,at,bt,D,[D[0],0,D[2]],[0,D[1],D[2]]],N="globe"===c.projection.name,V=c.scaleZoom(b),j=o.bR.fromInvProjectionMatrix(c.invProjMatrix,c.worldSize,V,!N),Y=p.getCurrentCascadeFrustum();return 0===j.intersectsPrecise(L.vertices,L.planes,k)||0===Y.intersectsPrecise(L.vertices,L.planes,k)}function cn(l){return[l[0]*o.d9,l[1]*o.d9,l[2]*o.d9,0]}function Ne(l,t,n,c,p,y,b,E,D){const L=c.getSource(),k=n.globeSharedBuffers;if(!k)return;let N,V,j;if(t&&(N=c.getTile(t)),L instanceof o.aJ?(V=L.texture,j=o.cI(0,0,n.transform)):N&&t&&(V=N.texture,j=o.cI(t.canonical.z,t.canonical.x,n.transform)),!V||!j)return;l||(j=o.ab.mat4.scale(o.ab.mat4.create(),j,[1,-1,1]));const Y=n.context,Z=Y.gl,Q="nearest"===p.paint.get("raster-resampling")?Z.NEAREST:Z.LINEAR,J=n.colorModeForDrapableLayerRenderPass(y),re=b.defines;re.push("GLOBE_POLES");const he=new zt(Z.LEQUAL,zt.ReadWrite,n.depthRangeFor3D),ce=Float32Array.from(n.transform.expandedFarZProjMatrix),ge=Float32Array.from(o.bb(o.cH(new o.bT(0,0,0))));n.terrain&&n.terrain.prepareDrawTile(),Y.activeTexture.set(Z.TEXTURE0),V.bind(Q,Z.CLAMP_TO_EDGE),Y.activeTexture.set(Z.TEXTURE1),V.bind(Q,Z.CLAMP_TO_EDGE),V.useMipmap&&Y.extTextureFilterAnisotropic&&n.transform.pitch>20&&Z.texParameterf(Z.TEXTURE_2D,Y.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,Y.extTextureFilterAnisotropicMax);const[pe,_e,de,be]=t?k.getPoleBuffers(t.canonical.z,!1):k.getPoleBuffers(0,!0),Ee=p.paint.get("raster-elevation");let qe;l?(qe=pe,n.renderDefaultNorthPole=0!==Ee):(qe=_e,n.renderDefaultSouthPole=0!==Ee);const Le=cn(b.mix),Ye=(Re=ce,He=ge,it=j,De=o.ae(n.transform.zoom),We=p,et=Ee,rt=Le,ct=b.offset,_t=b.range,Tt=y,no(Re,He,it,new Float32Array(16),new Float32Array(9),[0,0],De,[0,0],[0,0,0,0],1,{opacity:1,mix:0},We,[0,0],et,2,rt,ct,_t,1,0,Tt)),Xe=n.getOrCreateProgram("raster",{defines:re});var Re,He,it,De,We,et,rt,ct,_t,Tt;n.uploadCommonUniforms(Y,Xe,null),Xe.draw(n,Z.TRIANGLES,he,D,J,E,Ye,p.id,qe,de,be)}function Lo(l){const t=l._nearZ,n=l.projection.farthestPixelDistance(l),c=n-t,p=.2*l.height,y=t+p;return[t,n,(y-p-t)/c,(y-t)/c]}function _a(l,t,n,c){if(l)return t instanceof zn&&l instanceof Is?t.getTextureDescriptor(l,n,!0):{texture:l.texture,mix:cn(c.mix),offset:c.offset,buffer:0,tileSize:1}}var tu=o.da([{name:"a_index",type:"Int16",components:1}]);class ed{constructor(t,n,c,p){const y={width:c[0],height:c[1],data:null},b=t.gl;this.targetColorTexture=new o.T(t,y,b.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new o.T(t,y,b.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(n,p),this.lastInvalidatedAt=0}updateParticleTexture(t,n){if(this.particleTextureDimension===n.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const c=this.context.gl,p=n.width*n.height;this.particleTexture0=new o.T(this.context,n,c.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new o.T(this.context,n,c.RGBA8,{premultiply:!1,useMipmap:!1});const y=new o.db;y.reserve(p);for(let b=0;b<p;b++)y.emplaceBack(b);this.particleIndexBuffer=this.context.createVertexBuffer(y,tu.members,!0),this.particleSegment=o.b7.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=n.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=o.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function td(l,t,n){if(!l)return null;const c=t.getTextureDescriptor(l,n,!0);if(!c)return null;let{texture:p,mix:y,offset:b,tileSize:E,buffer:D,format:L}=c;if(!p||!L)return null;let k=!1;return"uint32"===L&&(k=!0,y[3]=0,y=Fc(o.dc,y,[0,n.paint.get("raster-particle-max-speed")]),b=Yh(o.dc,b,[0,n.paint.get("raster-particle-max-speed")])),{texture:p,textureOffset:[D/(E+2*D),E/(E+2*D)],tileSize:E,scalarData:k,scale:y,offset:b,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[L]]}}function id(l){const t=l._nearZ,n=l.projection.farthestPixelDistance(l),c=n-t,p=.2*l.height,y=t+p;return[t,n,(y-p-t)/c,(y-t)/c]}const Cr=new o.aj(1,0,0,1),Ud=new o.aj(0,1,0,1),jd=new o.aj(0,0,1,1),nd=new o.aj(1,0,1,1),Wc=new o.aj(0,1,1,1);function ko(l,t,n,c,p,y,b){const E=l.context,D=l.transform,L=E.gl,k="globe"===D.projection.name,N=k?["PROJECTION_GLOBE_VIEW"]:[];let V=o.ab.mat4.clone(n.projMatrix);if(k&&o.ae(D.zoom)>0){const Le=o.ba(n.canonical,D),Ye=o.dd(Le);V=o.ab.mat4.multiply(new Float32Array(16),D.globeMatrix,Ye),o.ab.mat4.multiply(V,D.projMatrix,V)}const j=o.ab.mat4.create();j[12]+=2*p/(o.q.devicePixelRatio*D.width),j[13]+=2*y/(o.q.devicePixelRatio*D.height),o.ab.mat4.multiply(V,j,V);const Y=l.getOrCreateProgram("debug",{defines:N}),Z=t.getTileByID(n.key);l.terrain&&l.terrain.setupElevationDraw(Z,Y);const Q=zt.disabled,J=qt.disabled,re=l.colorModeForRenderPass();E.activeTexture.set(L.TEXTURE0),l.emptyTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),k?Z._makeGlobeTileDebugBuffers(l.context,D):Z._makeDebugTileBoundsBuffers(l.context,D.projection);const ce=Z._tileDebugBuffer||l.debugBuffer,ge=Z._tileDebugIndexBuffer||l.debugIndexBuffer,pe=Z._tileDebugSegments||l.debugSegments;if(Y.draw(l,L.LINE_STRIP,Q,J,re,Wt.disabled,da(V,c),"$debug",ce,ge,pe,null,null,null,[Z._globeTileDebugBorderBuffer]),b){const Le=Z.latestRawTileData,Ye=Math.floor((Le&&Le.byteLength||0)/1024);let Xe=n.canonical.toString();n.overscaledZ!==n.canonical.z&&(Xe+=` => ${n.overscaledZ}`),Xe+=` ${Z.state}`,Xe+=` ${Ye}kb`,function(Re,He){Re.initDebugOverlayCanvas();const it=Re.debugOverlayCanvas,De=Re.context.gl,Je=Re.debugOverlayCanvas.getContext("2d");Je.clearRect(0,0,it.width,it.height),Je.shadowColor="white",Je.shadowBlur=2,Je.lineWidth=1.5,Je.strokeStyle="white",Je.textBaseline="top",Je.font="bold 36px Open Sans, sans-serif",Je.fillText(He,5,5),Je.strokeText(He,5,5),Re.debugOverlayTexture.update(it),Re.debugOverlayTexture.bind(De.LINEAR,De.CLAMP_TO_EDGE)}(l,Xe)}const _e=t.getTile(n).tileSize,de=512/Math.min(_e,512)*(n.overscaledZ/D.zoom)*.5,be=Z._tileDebugTextBuffer||l.debugBuffer,Ee=Z._tileDebugTextIndexBuffer||l.quadTriangleIndexBuffer,qe=Z._tileDebugTextSegments||l.debugSegments;Y.draw(l,L.TRIANGLES,Q,J,li.alphaBlended,Wt.disabled,da(V,o.aj.transparent,de),"$debug",be,Ee,qe,null,null,null,[Z._globeTileDebugTextBuffer])}function ec(l,t,n,c){ga(l,0,t+n/2,l.transform.width,n,c)}function iu(l,t,n,c){ga(l,t-n/2,0,n,l.transform.height,c)}function ga(l,t,n,c,p,y){const b=l.context,E=b.gl;E.enable(E.SCISSOR_TEST),E.scissor(t*o.q.devicePixelRatio,n*o.q.devicePixelRatio,c*o.q.devicePixelRatio,p*o.q.devicePixelRatio),b.clear({color:y}),E.disable(E.SCISSOR_TEST)}const tc=o.da([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:ks}=tc;function vs(l,t,n,c){l.emplaceBack(t,n,c)}class nu{constructor(t){this.vertexArray=new o.de,this.indices=new o.aU,vs(this.vertexArray,-1,-1,1),vs(this.vertexArray,1,-1,1),vs(this.vertexArray,-1,1,1),vs(this.vertexArray,1,1,1),vs(this.vertexArray,-1,-1,-1),vs(this.vertexArray,1,-1,-1),vs(this.vertexArray,-1,1,-1),vs(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,ks),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=o.b7.simpleSegment(0,0,36,12)}}function Wn(l,t,n,c,p,y){const b=l.context.gl,E=t.paint.get("sky-atmosphere-color"),D=t.paint.get("sky-atmosphere-halo-color"),L=t.paint.get("sky-atmosphere-sun-intensity"),k={u_matrix_3f:o.ab.mat3.fromMat4(o.ab.mat3.create(),c),u_sun_direction:p,u_sun_intensity:L,u_color_tint_r:[(Y=E).r,Y.g,Y.b,Y.a],u_color_tint_m:[(Z=D).r,Z.g,Z.b,Z.a],u_luminance:5e-5};var Y,Z;b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_CUBE_MAP_POSITIVE_X+y,t.skyboxTexture,0),n.draw(l,b.TRIANGLES,zt.disabled,qt.disabled,li.unblended,Wt.frontCW,k,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const Gd=o.da([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class al{constructor(t){const n=new o.df;n.emplaceBack(-1,1,1,0,0),n.emplaceBack(1,1,1,1,0),n.emplaceBack(1,-1,1,1,1),n.emplaceBack(-1,-1,1,0,1);const c=new o.aU;c.emplaceBack(0,1,2),c.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(n,Gd.members),this.indexBuffer=t.createIndexBuffer(c),this.segments=o.b7.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const Ji=o.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Li{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class ru{constructor(t){this.colorModeAlphaBlendedWriteRGB=new li([1,771,1,771],o.aj.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new li([1,0,1,0],o.aj.transparent,[!1,!1,!1,!0]),this.params=new Li,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0}),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},()=>{this.updateNeeded=!0})}update(t){const n=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new al(n);const c=this.params.sizeRange,p=this.params.intensityRange,y=function(k){const N=o.di(30),V=[];for(let j=0;j<k;++j){const Y=2*Math.PI*N(),Z=Math.acos(1-2*N())-.5*Math.PI;V.push(o.ab.vec3.fromValues(Math.cos(Z)*Math.cos(Y),Math.cos(Z)*Math.sin(Y),Math.sin(Z)))}return V}(this.params.starsCount),b=o.di(300),E=new o.dg,D=new o.aU;let L=0;for(let k=0;k<y.length;++k){const N=o.ab.vec3.scale([],y[k],200),V=Math.max(0,1+.01*c*(1*b()-.5)),j=Math.max(0,1+.01*p*(1*b()-.5));E.emplaceBack(N[0],N[1],N[2],-1,-1,V,j),E.emplaceBack(N[0],N[1],N[2],1,-1,V,j),E.emplaceBack(N[0],N[1],N[2],1,1,V,j),E.emplaceBack(N[0],N[1],N[2],-1,1,V,j),D.emplaceBack(L+0,L+1,L+2),D.emplaceBack(L+0,L+2,L+3),L+=4}this.starsVx=n.createVertexBuffer(E,Ji.members),this.starsIdx=n.createIndexBuffer(D),this.starsSegments=o.b7.simpleSegment(0,0,E.length,D.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,n){const c=t.context,p=c.gl,y=t.transform,b=new zt(p.LEQUAL,zt.ReadOnly,[0,1]),E=o.ae(y.zoom),D=t.style.getLut(n.scope),L="none"===n.properties.get("color-use-theme"),k=n.properties.get("color").toRenderColor(L?null:D).toArray01(),N="none"===n.properties.get("high-color-use-theme"),V=n.properties.get("high-color").toRenderColor(N?null:D).toArray01(),j="none"===n.properties.get("space-color-use-theme"),Y=n.properties.get("space-color").toRenderColor(j?null:D).toArray01PremultipliedAlpha(),Z=5e-4,Q=o.dh(n.properties.get("horizon-blend"),0,1,Z,.25),J=o.cC(t,c,y)&&Q===Z?y.worldSize/(2*Math.PI*1.025)-1:y.globeRadius,re=t.frameCounter/1e3%1,he=o.ab.vec3.length(y.globeCenterInViewSpace),ce=Math.sqrt(Math.pow(he,2)-Math.pow(J,2)),ge=Math.acos(ce/he),pe=_e=>{const de="globe"===y.projection.name?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];_e&&de.push("ALPHA_PASS");const be=t.getOrCreateProgram("globeAtmosphere",{defines:de}),Ee=((Le,Ye,Xe,Re,He,it,De,Je,We,ut,et,Ke)=>({u_frustum_tl:Le,u_frustum_tr:Ye,u_frustum_br:Xe,u_frustum_bl:Re,u_horizon:He,u_transition:it,u_fadeout_range:De,u_color:Je,u_high_color:We,u_space_color:ut,u_temporal_offset:et,u_horizon_angle:Ke}))(y.frustumCorners.TL,y.frustumCorners.TR,y.frustumCorners.BR,y.frustumCorners.BL,y.frustumCorners.horizon,E,Q,k,V,Y,re,ge);t.uploadCommonUniforms(c,be);const qe=this.atmosphereBuffer;qe&&be.draw(t,p.TRIANGLES,b,qt.disabled,_e?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,Wt.backCW,Ee,_e?"atmosphere_glow_alpha":"atmosphere_glow",qe.vertexBuffer,qe.indexBuffer,qe.segments)};pe(!1),pe(!0)}drawStars(t,n){const c=o.aw(n.properties.get("star-intensity"),0,1);if(0===c)return;const p=t.context,y=p.gl,b=t.transform,E=t.getOrCreateProgram("stars"),D=o.ab.quat.identity([]);o.ab.quat.rotateX(D,D,-b._pitch),o.ab.quat.rotateZ(D,D,-b.angle),o.ab.quat.rotateX(D,D,o.ai(b._center.lat)),o.ab.quat.rotateY(D,D,-o.ai(b._center.lng));const L=o.ab.mat4.fromQuat(new Float32Array(16),D),k=o.ab.mat4.multiply([],b.starsProjMatrix,L),N=o.ab.mat3.fromMat4([],L),V=o.ab.mat3.invert([],N),j=[0,1,0];o.ab.vec3.transformMat3(j,j,V),o.ab.vec3.scale(j,j,this.params.sizeMultiplier);const Y=[1,0,0];o.ab.vec3.transformMat3(Y,Y,V),o.ab.vec3.scale(Y,Y,this.params.sizeMultiplier);const Z=(Q=j,J=Y,re=c,{u_matrix:Float32Array.from(k),u_up:Q,u_right:J,u_intensity_multiplier:re});var Q,J,re;t.uploadCommonUniforms(p,E),this.starsVx&&this.starsIdx&&E.draw(t,y.TRIANGLES,zt.disabled,qt.disabled,this.colorModeAlphaBlendedWriteRGB,Wt.disabled,Z,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}function Os(l,t){const n=[...l],c=t.cameraWorldSizeForFog/t.worldSize,p=o.ab.mat4.identity([]);return o.ab.mat4.scale(p,p,[c,c,1]),o.ab.mat4.multiply(n,p,n),o.ab.mat4.multiply(n,t.worldToFogMatrix,n),n}function ro(l,t,n,c,p){const y=n.material,b=c.context,{baseColorTexture:E,metallicRoughnessTexture:D}=y.pbrMetallicRoughness,{normalTexture:L,occlusionTexture:k,emissionTexture:N}=y;function V(Y,Z,Q){if(Y&&(l.push(Z),b.activeTexture.set(b.gl.TEXTURE0+Q),Y.gfxTexture)){const{minFilter:J,magFilter:re,wrapS:he,wrapT:ce}=Y.sampler;Y.gfxTexture.bindExtraParam(J,re,he,ce)}}V(E,"HAS_TEXTURE_u_baseColorTexture",Un_BaseColor),V(D,"HAS_TEXTURE_u_metallicRoughnessTexture",Un_MetallicRoughness),V(L,"HAS_TEXTURE_u_normalTexture",Un_Normal),V(k,"HAS_TEXTURE_u_occlusionTexture",Un_Occlusion),V(N,"HAS_TEXTURE_u_emissionTexture",Un_Emission),p&&(p.texture||(p.texture=new o.dk(c.context,p.image,[p.image.height,p.image.height,p.image.height],b.gl.RGBA8)),b.activeTexture.set(b.gl.TEXTURE0+Un_LUT),p.texture&&p.texture.bind(b.gl.LINEAR,b.gl.CLAMP_TO_EDGE),l.push("APPLY_LUT_ON_GPU")),n.texcoordBuffer&&(l.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(n.texcoordBuffer)),n.colorBuffer&&(l.push(12===n.colorBuffer.itemSize?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(n.colorBuffer)),n.normalBuffer&&(l.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(n.normalBuffer)),n.pbrBuffer&&(l.push("HAS_ATTRIBUTE_a_pbr"),l.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(n.pbrBuffer)),"OPAQUE"!==y.alphaMode&&"MASK"!==y.alphaMode||l.push("UNPREMULT_TEXTURE_IN_SHADER"),y.defined||l.push("DIFFUSE_SHADED");const j=c.shadowRenderer;j&&(l.push("RENDER_SHADOWS","DEPTH_TEXTURE"),j.useNormalOffset&&l.push("NORMAL_OFFSET"))}function Xr(l,t,n,c,p,y){const b=n.paint.get("model-opacity").constantOr(1),E=t.context,D=new zt(t.context.gl.LEQUAL,zt.ReadWrite,t.depthRangeFor3D),L=t.transform,k=l.mesh,N=k.material,V=N.pbrMetallicRoughness,j=t.style.fog;let Y;Y="pixels"===t.transform.projection.zAxisUnit?[...l.nodeModelMatrix]:o.ab.mat4.multiply([],c.zScaleMatrix,l.nodeModelMatrix),o.ab.mat4.multiply(Y,c.negCameraPosMatrix,Y);const Z=o.ab.mat4.invert([],Y);o.ab.mat4.transpose(Z,Z);const Q="none"===n.paint.get("model-color-use-theme").constantOr("default"),J=n.paint.get("model-emissive-strength").constantOr(0),re=Xl(new Float32Array(l.worldViewProjection),new Float32Array(Y),new Float32Array(Z),null,t,b,V.baseColorFactor.toRenderColor(null),N.emissiveFactor,V.metallicFactor,V.roughnessFactor,N,J,n),he={defines:[]},ce=[],ge=t.shadowRenderer;ge&&(ge.useNormalOffset=!1),ro(he.defines,ce,k,t,Q?null:n.lut);let pe=null;if(j){const be=Os(l.nodeModelMatrix,t.transform);if(pe=new Float32Array(be),"globe"!==L.projection.name){const Ee=k.aabb.min,qe=k.aabb.max,[Le,Ye]=j.getOpacityForBounds(be,Ee[0],Ee[1],qe[0],qe[1]);he.overrideFog=Le>=me||Ye>=me}}const _e=To(t,n.paint.get("model-cutoff-fade-range"));_e.shouldRenderCutoff&&he.defines.push("RENDER_CUTOFF");const de=t.getOrCreateProgram("model",he);t.uploadCommonUniforms(E,de,null,pe,_e),"shadow"!==t.renderPass&&ge&&ge.setupShadowsFromMatrix(l.nodeModelMatrix,de),de.draw(t,E.gl.TRIANGLES,D,p,y,k.material.doubleSided?Wt.disabled:Wt.backCCW,re,n.id,k.vertexBuffer,k.indexBuffer,k.segments,n.paint,t.transform.zoom,void 0,ce)}function $c(l,t,n,c,p,y,b){let E;E="globe"===l.projection.name?o.dl(n,l):[...n],o.ab.mat4.multiply(E,E,t.matrix);const D=o.ab.mat4.multiply([],c,E);if(t.meshes)for(const L of t.meshes){if("BLEND"!==L.material.alphaMode){b.push({mesh:L,depth:0,modelIndex:p,worldViewProjection:D,nodeModelMatrix:E});continue}const k=o.ab.vec3.transformMat4([],L.centroid,D);!l.isOrthographic&&k[2]<=0||y.push({mesh:L,depth:k[2],modelIndex:p,worldViewProjection:D,nodeModelMatrix:E})}if(t.children)for(const L of t.children)$c(l,L,n,c,p,y,b)}function ll(l,t,n,c){const p=n.shadowRenderer;if(!p)return;const y=p.getShadowPassDepthMode(),b=p.getShadowPassColorMode(),E=p.calculateShadowPassMatrixFromMatrix(t),D=Uc(E);n.getOrCreateProgram("modelDepth",{defines:n._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(n,n.context.gl.TRIANGLES,y,qt.disabled,b,Wt.backCCW,D,c.id,l.vertexBuffer,l.indexBuffer,l.segments,c.paint,n.transform.zoom,void 0,void 0)}function Fs(l,t,n){const c=t.updateZoomBasedPaintProperties(),p=function(y,b,E){let D,L,k,N=y.terrain?y.terrain.exaggeration():0;if(y.terrain&&N>0){const V=y.terrain,j=V.findDEMTileFor(E);j&&j.dem?D=o.dn.create(V,E,j):N=0}if(0===N&&(b.terrainElevationMin=0,b.terrainElevationMax=0),N===b.validForExaggeration&&(0===N||D&&D._demTile&&D._demTile.tileID===b.validForDEMTile.id&&D._dem._timestamp===b.validForDEMTile.timestamp))return!1;for(const V in b.instancesPerModel){const j=b.instancesPerModel[V];for(let Y=0;Y<j.instancedDataArray.length;++Y){const Z=(D?N*D.getElevationAt(0|j.instancedDataArray.float32[16*Y],0|j.instancedDataArray.float32[16*Y+1],!0,!0):0)+j.instancesEvaluatedElevation[Y];j.instancedDataArray.float32[16*Y+6]=Z,L=L?Math.min(b.terrainElevationMin,Z):Z,k=k?Math.max(b.terrainElevationMax,Z):Z}}return b.terrainElevationMin=L||0,b.terrainElevationMax=k||0,b.validForExaggeration=N,b.validForDEMTile=D&&D._demTile?{id:D._demTile.tileID,timestamp:D._dem._timestamp}:{id:void 0,timestamp:0},!0}(l,t,n);(c||p)&&(t.uploaded=!1,t.upload(l.context))}const pr={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new o.cd([0,0,0],[o.ag,o.ag,0])};function Zc(l,t){const n=1<<l.canonical.z,c=t.getFreeCameraOptions().position,p=t.elevation,y=l.canonical.x/n,b=(l.canonical.x+1)/n,E=l.canonical.y/n,D=(l.canonical.y+1)/n;let L=t._centerAltitude;if(p){const j=p.getMinMaxForTile(l);j&&j.max>L&&(L=j.max)}const k=o.aw(c.x,y,b)-c.x,N=o.aw(c.y,E,D)-c.y,V=o.bH(L,t.center.lat)-c.z;return t._zoomFromMercatorZ(Math.sqrt(k*k+N*N+V*V))}function ic(l,t,n,c,p,y,b){const E=l.context,D="shadow"===l.renderPass,L=l.shadowRenderer,k=D&&L?L.getShadowPassDepthMode():new zt(E.gl.LEQUAL,zt.ReadWrite,l.depthRangeFor3D),N=l.isTileAffectedByFog(y);if(n.meshes)for(const V of n.meshes){const j=["MODEL_POSITION_ON_GPU"],Y=[];let Z,Q,J;c.instancedDataArray.length>20&&j.push("INSTANCED_ARRAYS");const re=To(l,t.paint.get("model-cutoff-fade-range"));if(re.shouldRenderCutoff&&j.push("RENDER_CUTOFF"),D&&L)Z=l.getOrCreateProgram("modelDepth",{defines:j}),Q=Uc(b.shadowTileMatrix,b.shadowTileMatrix,Float32Array.from(n.matrix)),J=L.getShadowPassColorMode();else{ro(j,Y,V,l,"none"===t.paint.get("model-color-use-theme").constantOr("default")?null:t.lut),Z=l.getOrCreateProgram("model",{defines:j,overrideFog:N});const ce=V.material,ge=ce.pbrMetallicRoughness,pe=t.paint.get("model-opacity").constantOr(1),_e=t.paint.get("model-emissive-strength").constantOr(0);Q=Xl(y.expandedProjMatrix,Float32Array.from(n.matrix),new Float32Array(16),null,l,pe,ge.baseColorFactor.toRenderColor(null),ce.emissiveFactor,ge.metallicFactor,ge.roughnessFactor,ce,_e,t,p),L&&(b.shadowUniformsInitialized?Z.setShadowUniformValues(E,L.getShadowUniformValues()):(L.setupShadows(y.toUnwrapped(),Z,"model-tile",y.overscaledZ),b.shadowUniformsInitialized=!0)),J=re.shouldRenderCutoff||pe<1||"OPAQUE"!==ce.alphaMode?li.alphaBlended:li.unblended}l.uploadCommonUniforms(E,Z,y.toUnwrapped(),null,re);const he=V.material.doubleSided?Wt.disabled:Wt.backCCW;if(c.instancedDataArray.length>20)Y.push(c.instancedDataBuffer),Z.draw(l,E.gl.TRIANGLES,k,qt.disabled,J,he,Q,t.id,V.vertexBuffer,V.indexBuffer,V.segments,t.paint,l.transform.zoom,void 0,Y,c.instancedDataArray.length);else{const ce=D?"u_instance":"u_normal_matrix";for(let ge=0;ge<c.instancedDataArray.length;++ge)Q[ce]=new Float32Array(c.instancedDataArray.arrayBuffer,64*ge,16),Z.draw(l,E.gl.TRIANGLES,k,qt.disabled,J,he,Q,t.id,V.vertexBuffer,V.indexBuffer,V.segments,t.paint,l.transform.zoom,void 0,Y)}}if(n.children)for(const V of n.children)ic(l,t,V,c,p,y,b)}const Xc=[1,-1,1];function Yc(l,t,n,c){if(!n.modelManager)return!0;const p=n.modelManager;if(!n.shadowRenderer)return!0;const y=n.shadowRenderer,b=t.aabb;let E=!0,D=l.maxHeight;if(0===D){let k=0;for(const N in l.instancesPerModel){const V=p.getModel(N,c);V?k=Math.max(k,Math.max(Math.max(V.aabb.max[0],V.aabb.max[1]),V.aabb.max[2])):E=!1}D=l.maxScale*k*1.41+l.maxVerticalOffset,E&&(l.maxHeight=D)}b.max[2]=D,b.min[2]+=l.terrainElevationMin,b.max[2]+=l.terrainElevationMax,o.ab.vec3.transformMat4(b.min,b.min,t.tileMatrix),o.ab.vec3.transformMat4(b.max,b.max,t.tileMatrix);const L=b.intersects(y.getCurrentCascadeFrustum());return 0===n.currentShadowCascade&&(l.isInsideFirstShadowMapFrustum=2===L),0===L}function Oo(l,t){const n=l.uniformValues.u_cutoff_params[0],c=l.uniformValues.u_cutoff_params[1],p=l.uniformValues.u_cutoff_params[2],y=l.uniformValues.u_cutoff_params[3];return c===n||y===p?1:o.aw(((t-n)/(c-n)-p)/(y-p),0,1)}function su(l,t,n,c){if(t.pitch<20)return 1;const p=t.getWorldToCameraMatrix();o.ab.mat4.multiply(p,p,l);const y=o.ab.vec4.fromValues(n.min[0],n.min[1],n.min[2],1);let b=o.ab.vec4.transformMat4(o.ab.vec4.create(),y,p),E=b,D=b;y[1]=n.max[1],b=o.ab.vec4.transformMat4(o.ab.vec4.create(),y,p),E=b[1]<E[1]?b:E,D=b[1]>D[1]?b:D,y[0]=n.max[0],b=o.ab.vec4.transformMat4(o.ab.vec4.create(),y,p),E=b[1]<E[1]?b:E,D=b[1]>D[1]?b:D,y[1]=n.min[1],b=o.ab.vec4.transformMat4(o.ab.vec4.create(),y,p),E=b[1]<E[1]?b:E,D=b[1]>D[1]?b:D;const L=o.aw(c[0],0,1),k=100*t.pixelsPerMeter*o.aw(c[1],0,1),N=o.aw(c[2],0,1),V=o.ab.vec4.lerp(o.ab.vec4.create(),E,D,L),j=Math.tan(.5*t.fovX),Y=-V[2]*j;if(0===k)return V[1]<-Math.abs(Y)?N:1;const Z=(-Math.abs(Y)-V[1])/k,Q=(re,he,ce)=>(1-ce)*re+ce*he,J=o.aw(Q(1,N,Z),N,1);return Q(1,J,o.aw((t.pitch-20)/20,0,1))}class so{}class cl{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,n,c){{const N=this._storage.get(n.id);if(N)return N.lastUsedFrameIdx=t,N.buf}const p=c.gl,y=p.getBufferParameter(p.ELEMENT_ARRAY_BUFFER,p.BUFFER_SIZE),b=new ArrayBuffer(y),E=new Int16Array(b);p.getBufferSubData(p.ELEMENT_ARRAY_BUFFER,0,new Int16Array(b));const D=new o.dq;for(let N=0;N<y/2;N+=3){const V=E[N],j=E[N+1],Y=E[N+2];D.emplaceBack(V,j),D.emplaceBack(j,Y),D.emplaceBack(Y,V)}const L=c.bindVertexArrayOES.current,k=new so;return k.buf=new jc(c,D),k.lastUsedFrameIdx=t,this._storage.set(n.id,k),c.bindVertexArrayOES.set(L),k.buf}update(t){for(const[n,c]of this._storage)t-c.lastUsedFrameIdx>30&&(c.buf.destroy(),this._storage.delete(n))}destroy(){for(const[t,n]of this._storage)n.buf.destroy(),this._storage.delete(t)}}class nc{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const ou=o.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class au{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class Ln{constructor(t,n){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...n,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...n,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const lu=o.da([{type:"Float32",name:"a_pos_2f",components:2}]);class rc{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,n){const c=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const b=new o.dr,E=new o.aU;b.emplaceBack(-1,-1),b.emplaceBack(1,-1),b.emplaceBack(1,1),b.emplaceBack(-1,1),E.emplaceBack(0,1,2),E.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(b,lu.members),this.vignetteIdx=t.context.createIndexBuffer(E)}const p=o.b7.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,c);const b={u_vignetteShape:(y={vignetteShape:[n.start,n.range,Math.pow(10,n.fadePower)],vignetteColor:[n.color.r,n.color.g,n.color.b,n.color.a*n.strength]}).vignetteShape,u_vignetteColor:y.vignetteColor};c.draw(t,t.context.gl.TRIANGLES,zt.disabled,qt.disabled,li.alphaBlended,Wt.disabled,b,"vignette",this.vignetteVx,this.vignetteIdx,p,{})}var y}}class hl{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,n){const c=t.getFreeCameraOptions().position,p=c.toAltitude(),y=c.toLngLat(),b=o.ai(y.lng),E=o.ai(y.lat),D=t.pixelsPerMeter/n,L=b*o.ds,k=o.ds*Math.log(Math.tan(Math.PI/4+E/2));if(void 0===this._offsetXPrev)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const N=-this._offsetYPrev+k,V=-this._elevationPrev+p;this._accumulatedOffsetX+=(-this._offsetXPrev+L)*D,this._accumulatedOffsetY+=N*D,this._accumulatedElevation+=V*D,this._offsetXPrev=L,this._offsetYPrev=k,this._elevationPrev=p}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function Fo(l,t){return[-(l[0]-Math.floor(l[0]/t)*t),-(l[1]-Math.floor(l[1]/t)*t),-(l[2]-Math.floor(l[2]/t)*t)]}function Kc(l){const t=o.di(1323123451230),n=[];for(let c=0;c<l;++c){const p=2*t()-1,y=2*t()-1,b=2*t()-1;n.push(o.ab.vec3.fromValues(p,y,b))}return n}function Bs(l,t,n,c,p){const y=o.aw((p-n)/(c-n),0,1);return(1-y)*l+y*t}class oo{constructor(t){this._movement=new hl,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new rc,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,n){const c=t.transform;this._movement.update(c,this._ppmScaleFactor);const p=c.starsProjMatrix,y=o.ab.quat.identity([]);o.ab.quat.rotateX(y,y,o.ai(90)-c._pitch),o.ab.quat.rotateZ(y,y,-c.angle);const b=o.ab.mat4.fromQuat(new Float32Array(16),y),E=o.ab.mat4.fromValues(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),D=o.ab.mat4.transpose([],E),L=o.ab.mat4.multiply([],D,b),k=Date.now()/1e3;return this._accumulatedTimeFromStart+=(k-this._prevTime)*n,this._prevTime=k,{projectionMatrix:p,modelviewMatrix:L}}}class ao extends oo{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new Ln(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){const n=t.context;if(!this.particlesVx){const c=Kc(this.particlesCount),p=new o.dt,y=new o.aU;let b=0;const E=o.di(1323123451230);for(let D=0;D<c.length;++D){const L=c[D],k=[2*E()-1,E(),E(),E()];p.emplaceBack(L[0],L[1],L[2],-1,-1,...k),p.emplaceBack(L[0],L[1],L[2],1,-1,...k),p.emplaceBack(L[0],L[1],L[2],1,1,...k),p.emplaceBack(L[0],L[1],L[2],-1,1,...k),y.emplaceBack(b+0,b+1,b+2),y.emplaceBack(b+0,b+2,b+3),b+=4}this.particlesVx=n.createVertexBuffer(p,ou.members),this.particlesIdx=n.createIndexBuffer(y)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;const n=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},c=t.transform.zoom;if(n.revealStart>c)return;const p=Bs(0,1,n.revealStart,n.revealStart+n.revealRange,c);if(!this.particlesVx||!this.particlesIdx)return;const y=structuredClone(this._params);let b=[-y.direction.x,y.direction.y,-100];o.ab.vec3.normalize(b,b);const E=structuredClone(this._vignetteParams);E.strength*=p,y.overrideStyleParameters||(y.intensity=t.style.rain.state.density,y.timeFactor=t.style.rain.state.intensity,y.color=structuredClone(t.style.rain.state.color),b=structuredClone(t.style.rain.state.direction),y.screenThinning.intensity=t.style.rain.state.centerThinning,y.dropletSizeX=t.style.rain.state.dropletSize[0],y.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],y.distortionStrength=100*t.style.rain.state.distortionStrength,E.strength=1,E.color=structuredClone(t.style.rain.state.vignetteColor));const D=this.updateOnRender(t,y.timeFactor),L=t.context,k=L.gl,N=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new o.T(L,{width:t.width,height:t.height,data:null},k.RGBA8)),y.distortionStrength>0&&(L.activeTexture.set(k.TEXTURE0),this.screenTexture.bind(k.LINEAR,k.CLAMP_TO_EDGE),k.copyTexSubImage2D(k.TEXTURE_2D,0,0,0,0,0,t.width,t.height));const V=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(L,V),L.activeTexture.set(k.TEXTURE0),this.screenTexture.bind(k.LINEAR,k.CLAMP_TO_EDGE);const j=[y.color.r,y.color.g,y.color.b,y.color.a],Y=(Z,Q)=>{const J=Fo(this._movement.getPosition(),Z),re=y.dropletSizeX,he=y.dropletSizeX*y.dropletSizeYScale,ce=t.width/2,ge=t.height/2,pe=Bs(0,y.screenThinning.start,0,1,y.screenThinning.intensity),_e=Bs(.001,y.screenThinning.range,0,1,y.screenThinning.intensity),de=Bs(0,y.screenThinning.particleOffset,0,1,y.screenThinning.intensity),be=(Ee={modelview:D.modelviewMatrix,projection:D.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:J,velocityConeAperture:y.velocityConeAperture,velocity:y.velocity,boxSize:Z,rainDropletSize:[re,he],distortionStrength:y.distortionStrength,rainDirection:b,color:j,screenSize:[N.width,N.height],thinningCenterPos:[ce,ge],thinningShape:[pe,_e,Math.pow(10,y.screenThinning.fadePower)],thinningAffectedRatio:y.screenThinning.affectedRatio,thinningParticleOffset:de,shapeDirectionalPower:y.shapeDirPower,shapeNormalPower:y.shapeNormalPower,mode:Q?0:1},{u_modelview:Float32Array.from(Ee.modelview),u_projection:Float32Array.from(Ee.projection),u_time:Ee.time,u_cam_pos:Ee.camPos,u_texScreen:0,u_velocityConeAperture:Ee.velocityConeAperture,u_velocity:Ee.velocity,u_boxSize:Ee.boxSize,u_rainDropletSize:Ee.rainDropletSize,u_distortionStrength:Ee.distortionStrength,u_rainDirection:Ee.rainDirection,u_color:Ee.color,u_screenSize:Ee.screenSize,u_thinningCenterPos:Ee.thinningCenterPos,u_thinningShape:Ee.thinningShape,u_thinningAffectedRatio:Ee.thinningAffectedRatio,u_thinningParticleOffset:Ee.thinningParticleOffset,u_shapeDirectionalPower:Ee.shapeDirectionalPower,u_shapeNormalPower:Ee.shapeNormalPower,u_mode:Ee.mode});var Ee;const qe=Math.round(y.intensity*this.particlesCount),Le=o.b7.simpleSegment(0,0,4*qe,2*qe);V.draw(t,k.TRIANGLES,zt.disabled,qt.disabled,li.alphaBlended,Wt.disabled,be,"rain_particles",this.particlesVx,this.particlesIdx,Le,{})};y.distortionStrength>0&&Y(y.boxSize,!0),Y(y.boxSize,!1),this._vignette.draw(t,E)}}const cu=o.da([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class hu extends oo{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new Ln(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){const n=t.context;if(!this.particlesVx){const c=Kc(this.particlesCount),p=new o.du,y=new o.aU;let b=0;const E=o.di(1323123451230);for(let D=0;D<c.length;++D){const L=c[D],k=E(),N=E(),V=E(),j=[D/c.length,k,N,V],Y=[E(),E()];p.emplaceBack(L[0],L[1],L[2],-1,-1,...j,...Y),p.emplaceBack(L[0],L[1],L[2],1,-1,...j,...Y),p.emplaceBack(L[0],L[1],L[2],1,1,...j,...Y),p.emplaceBack(L[0],L[1],L[2],-1,1,...j,...Y),y.emplaceBack(b+0,b+1,b+2),y.emplaceBack(b+0,b+2,b+3),b+=4}this.particlesVx=n.createVertexBuffer(p,cu.members),this.particlesIdx=n.createIndexBuffer(y)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;const n=structuredClone(this._params);let c=[-n.direction.x,n.direction.y,-100];o.ab.vec3.normalize(c,c);const p=structuredClone(this._vignetteParams),y=n.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},b=t.transform.zoom;if(y.revealStart>b)return;const E=Bs(0,1,y.revealStart,y.revealStart+y.revealRange,b);p.strength*=E,n.overrideStyleParameters||(n.intensity=t.style.snow.state.density,n.timeFactor=t.style.snow.state.intensity,n.color=structuredClone(t.style.snow.state.color),c=structuredClone(t.style.snow.state.direction),n.screenThinning.intensity=t.style.snow.state.centerThinning,n.billboardSize=2.79*t.style.snow.state.flakeSize,p.strength=1,p.color=structuredClone(t.style.snow.state.vignetteColor));const D=this.updateOnRender(t,n.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const L=t.context,k=L.gl,N=t.transform,V=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(L,V),((j,Y,Z)=>{const Q=Fo(this._movement.getPosition(),j),J=N.width/2,re=N.height/2,he=Bs(0,Z.screenThinning.start,0,1,Z.screenThinning.intensity),ce=Bs(.001,Z.screenThinning.range,0,1,Z.screenThinning.intensity),ge=Bs(0,Z.screenThinning.particleOffset,0,1,Z.screenThinning.intensity),pe=(_e={modelview:D.modelviewMatrix,projection:D.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:Q,velocityConeAperture:Z.velocityConeAperture,velocity:Z.velocity,horizontalOscillationRadius:Z.horizontalOscillationRadius,horizontalOscillationRate:Z.horizontalOscillationRate,boxSize:j,billboardSize:1*Z.billboardSize,simpleShapeParameters:[Z.shapeFadeStart,Z.shapeFadePower],screenSize:[N.width,N.height],thinningCenterPos:[J,re],thinningShape:[he,ce,Math.pow(10,Z.screenThinning.fadePower)],thinningAffectedRatio:Z.screenThinning.affectedRatio,thinningParticleOffset:ge,color:[Z.color.r,Z.color.g,Z.color.b,Z.color.a],direction:c},{u_modelview:Float32Array.from(_e.modelview),u_projection:Float32Array.from(_e.projection),u_time:_e.time,u_cam_pos:_e.camPos,u_velocityConeAperture:_e.velocityConeAperture,u_velocity:_e.velocity,u_horizontalOscillationRadius:_e.horizontalOscillationRadius,u_horizontalOscillationRate:_e.horizontalOscillationRate,u_boxSize:_e.boxSize,u_billboardSize:_e.billboardSize,u_simpleShapeParameters:_e.simpleShapeParameters,u_screenSize:_e.screenSize,u_thinningCenterPos:_e.thinningCenterPos,u_thinningShape:_e.thinningShape,u_thinningAffectedRatio:_e.thinningAffectedRatio,u_thinningParticleOffset:_e.thinningParticleOffset,u_particleColor:_e.color,u_direction:_e.direction});var _e;const de=Math.round(Z.intensity*this.particlesCount),be=o.b7.simpleSegment(0,0,4*de,2*de);this.particlesVx&&this.particlesIdx&&V.draw(t,k.TRIANGLES,zt.disabled,qt.disabled,li.alphaBlended,Wt.disabled,pe,"snow_particles",this.particlesVx,this.particlesIdx,be,{})})(n.boxSize,0,n),this._vignette.draw(t,p)}}const sc={symbol:function(l,t,n,c,p){if("translucent"!==l.renderPass)return;const y=qt.disabled,b=l.colorModeForRenderPass(),E=n.layout.get("text-variable-anchor"),D=n.layout.get("text-size-scale-range"),L=o.aw(l.scaleFactor,D[0],D[1]);E&&function(V,j,Y,Z,Q,J,re,he){const ce=j.transform,ge="map"===Q,pe="map"===J;for(const _e of V){const de=Z.getTile(_e),be=de.getBucket(Y);if(!be||!be.text||!be.text.segments.get().length)continue;const Ee=o.bp(be.textSizeData,ce.zoom,he),qe=Ks(_e,be.getProjection(),ce),Le=ce.calculatePixelsToTileUnitsMatrix(de),Ye=Kn(qe,de.tileID.canonical,pe,ge,ce,be.getProjection(),Le),Xe=be.hasIconTextFit()&&be.hasIconData();if(Ee){const Re=Math.pow(2,ce.zoom-de.tileID.overscaledZ);qc(be,ge,pe,re,o.cX,ce,Ye,_e,Re,Ee,Xe)}}}(c,l,n,t,n.layout.get("text-rotation-alignment"),n.layout.get("text-pitch-alignment"),p,L);const k=0!==n.paint.get("icon-opacity").constantOr(1),N=0!==n.paint.get("text-opacity").constantOr(1);void 0!==n.layout.get("symbol-sort-key").constantOr(1)&&(k||N)?Jl(l,t,n,c,y,b):(k&&Jl(l,t,n,c,y,b,{onlyIcons:!0}),N&&Jl(l,t,n,c,y,b,{onlyText:!0})),t.map.showCollisionBoxes&&(Gc(l,t,n,c,n.paint.get("text-translate"),n.paint.get("text-translate-anchor"),!0),Gc(l,t,n,c,n.paint.get("icon-translate"),n.paint.get("icon-translate-anchor"),!1))},circle:function(l,t,n,c){if("translucent"!==l.renderPass)return;const p=n.paint.get("circle-opacity"),y=n.paint.get("circle-stroke-width"),b=n.paint.get("circle-stroke-opacity"),E=void 0!==n.layout.get("circle-sort-key").constantOr(1),D=n.paint.get("circle-emissive-strength");if(0===p.constantOr(1)&&(0===y.constantOr(1)||0===b.constantOr(1)))return;const L=l.context,k=L.gl,N=l.transform,V=l.depthModeForSublayer(0,zt.ReadOnly),j=qt.disabled,Y=l.colorModeForDrapableLayerRenderPass(D),Z="globe"===N.projection.name,Q=[o.at(N.center.lng),o.aA(N.center.lat)],J=[];for(let he=0;he<c.length;he++){const ce=c[he],ge=t.getTile(ce),pe=ge.getBucket(n);if(!pe||pe.projection.name!==N.projection.name)continue;const _e=pe.programConfigurations.get(n.id),de=o.cY(n),be=l.isTileAffectedByFog(ce);Z&&de.push("PROJECTION_GLOBE_VIEW"),de.push("DEPTH_D24"),l.terrain&&N.depthOcclusionForSymbolsAndCircles&&de.push("DEPTH_OCCLUSION");const Ee=l.getOrCreateProgram("circle",{config:_e,defines:de,overrideFog:be}),qe=pe.layoutVertexBuffer,Le=pe.globeExtVertexBuffer,Ye=pe.indexBuffer,Xe=N.projection.createInversionMatrix(N,ce.canonical),Re={programConfiguration:_e,program:Ee,layoutVertexBuffer:qe,globeExtVertexBuffer:Le,indexBuffer:Ye,uniformValues:o.cZ(l,ce,ge,Xe,Q,n),tile:ge};if(E){const He=pe.segments.get();for(const it of He)J.push({segments:new o.b7([it]),sortKey:it.sortKey,state:Re})}else J.push({segments:pe.segments,sortKey:0,state:Re})}E&&J.sort((he,ce)=>he.sortKey-ce.sortKey);const re={useDepthForOcclusion:N.depthOcclusionForSymbolsAndCircles};for(const he of J){const{programConfiguration:ce,program:ge,layoutVertexBuffer:pe,globeExtVertexBuffer:_e,indexBuffer:de,uniformValues:be,tile:Ee}=he.state,qe=he.segments;l.terrain&&l.terrain.setupElevationDraw(Ee,ge,re),l.uploadCommonUniforms(L,ge,Ee.tileID.toUnwrapped()),ge.draw(l,k.TRIANGLES,V,j,Y,Wt.disabled,be,n.id,pe,de,qe,n.paint,N.zoom,ce,[_e])}},heatmap:function(l,t,n,c){if(0!==n.paint.get("heatmap-opacity"))if("offscreen"===l.renderPass){const p=l.context,y=p.gl,b=qt.disabled,E=new li([y.ONE,y.ONE,y.ONE,y.ONE],o.aj.transparent,[!0,!0,!0,!0]);(function(j,Y,Z,Q){const J=j.gl,re=Y.width*Q,he=Y.height*Q;j.activeTexture.set(J.TEXTURE1),j.viewport.set([0,0,re,he]);let ce=Z.heatmapFbo;if(!ce||ce&&(ce.width!==re||ce.height!==he)){ce&&ce.destroy();const ge=J.createTexture();J.bindTexture(J.TEXTURE_2D,ge),J.texParameteri(J.TEXTURE_2D,J.TEXTURE_WRAP_S,J.CLAMP_TO_EDGE),J.texParameteri(J.TEXTURE_2D,J.TEXTURE_WRAP_T,J.CLAMP_TO_EDGE),J.texParameteri(J.TEXTURE_2D,J.TEXTURE_MIN_FILTER,J.LINEAR),J.texParameteri(J.TEXTURE_2D,J.TEXTURE_MAG_FILTER,J.LINEAR),ce=Z.heatmapFbo=j.createFramebuffer(re,he,!0,null),function(pe,_e,de,be,Ee,qe){const Le=pe.gl;Le.texImage2D(Le.TEXTURE_2D,0,pe.extRenderToTextureHalfFloat?Le.RGBA16F:Le.RGBA,Ee,qe,0,Le.RGBA,pe.extRenderToTextureHalfFloat?Le.HALF_FLOAT:Le.UNSIGNED_BYTE,null),be.colorAttachment.set(de)}(j,0,ge,ce,re,he)}else J.bindTexture(J.TEXTURE_2D,ce.colorAttachment.get()),j.bindFramebuffer.set(ce.framebuffer)})(p,l,n,"globe"===l.transform.projection.name?.5:.25),p.clear({color:o.aj.transparent});const D=l.transform,L="globe"===D.projection.name,k=L?["PROJECTION_GLOBE_VIEW"]:[],N=L?Wt.frontCCW:Wt.disabled,V=[o.at(D.center.lng),o.aA(D.center.lat)];for(let j=0;j<c.length;j++){const Y=c[j];if(t.hasRenderableParent(Y))continue;const Z=t.getTile(Y),Q=Z.getBucket(n);if(!Q||Q.projection.name!==D.projection.name)continue;const J=l.isTileAffectedByFog(Y),re=Q.programConfigurations.get(n.id),he=l.getOrCreateProgram("heatmap",{config:re,defines:k,overrideFog:J}),{zoom:ce}=l.transform;l.terrain&&l.terrain.setupElevationDraw(Z,he),l.uploadCommonUniforms(p,he,Y.toUnwrapped());const ge=D.projection.createInversionMatrix(D,Y.canonical);he.draw(l,y.TRIANGLES,zt.disabled,b,E,N,St(l,Y,Z,ge,V,ce,n.paint.get("heatmap-intensity")),n.id,Q.layoutVertexBuffer,Q.indexBuffer,Q.segments,n.paint,l.transform.zoom,re,L?[Q.globeExtVertexBuffer]:null)}p.viewport.set([0,0,l.width,l.height])}else"translucent"===l.renderPass&&(l.context.setColorMode(l.colorModeForRenderPass()),function(p,y){const b=p.context,E=b.gl,D=y.heatmapFbo;if(!D)return;b.activeTexture.set(E.TEXTURE0),E.bindTexture(E.TEXTURE_2D,D.colorAttachment.get()),b.activeTexture.set(E.TEXTURE1);let L=y.colorRampTexture;L||(L=y.colorRampTexture=new o.T(b,y.colorRamp,E.RGBA8)),L.bind(E.LINEAR,E.CLAMP_TO_EDGE),p.getOrCreateProgram("heatmapTexture").draw(p,E.TRIANGLES,zt.disabled,qt.disabled,p.colorModeForRenderPass(),Wt.disabled,{u_image:0,u_color_ramp:1,u_opacity:y.paint.get("heatmap-opacity")},y.id,p.viewportBuffer,p.quadTriangleIndexBuffer,p.viewportSegments,y.paint,p.transform.zoom)}(l,n))},line:function(l,t,n,c){if("translucent"!==l.renderPass)return;const p=n.paint.get("line-opacity"),y=n.paint.get("line-width");if(0===p.constantOr(1)||0===y.constantOr(1))return;const b=n.paint.get("line-emissive-strength"),E=n.paint.get("line-occlusion-opacity"),D=n.layout.get("line-elevation-reference"),L="meters"===n.layout.get("line-width-unit"),k="sea"===D,N=l.context,V=N.gl;if(n.hasElevatedBuckets&&"globe"===l.transform.projection.name)return;const j=n.layout.get("line-cross-slope"),Y=void 0!==j,Z=j<1,Q=l.colorModeForDrapableLayerRenderPass(b),J=l.terrain&&l.terrain.renderingToTexture,re=J?1:o.q.devicePixelRatio,he=n.paint.get("line-dasharray"),ce=he.constantOr(1),ge=n.layout.get("line-cap"),pe=he.constantOr(null),_e=ge.constantOr(null),de=n.paint.get("line-pattern"),be=de.constantOr(1),Ee=de.constantOr(null),qe=n.paint.get("line-opacity").constantOr(1);let Le=!be&&1!==qe||l.depthOcclusion&&E>0&&E<1;const Ye=n.paint.get("line-gradient"),Xe=be?"linePattern":"line",Re=o.c_(n);let He;if(J&&l.terrain&&l.terrain.clipOrMaskOverlapStencilType()&&(Le=!1),0!==E&&l.depthOcclusion){const De=n.paint._values["line-opacity"];De&&De.value&&"constant"===De.value.kind?He=De.value:o.w(`Occlusion opacity for layer ${n.id} is supported only when line-opacity isn't data-driven.`)}"constant"!==y.value.kind&&!1===y.value.isLineProgressConstant&&Re.push("VARIABLE_LINE_WIDTH");const it=(De,Je,We,ut,et)=>{for(const Ke of De){const rt=t.getTile(Ke);if(be&&!rt.patternsLoaded())continue;const ct=rt.getBucket(n);if(!ct||ct.hasZOffset&&!et||!ct.hasZOffset&&et)continue;l.prepareDrawTile();const _t=ct.programConfigurations.get(n.id),Tt=l.isTileAffectedByFog(Ke),jt=l.getOrCreateProgram(Xe,{config:_t,defines:Je,overrideFog:Tt,overrideRtt:!et&&void 0});if(Ee&&rt.imageAtlas){const Kt=o.A.from(Ee).getPrimary().scaleSelf(re).serialize(),Ei=rt.imageAtlas.patternPositions[Kt];Ei&&_t.setConstantPatternPositions(Ei)}if(!be&&pe&&_e&&rt.lineAtlas){const Kt=rt.lineAtlas.getDash(pe,_e);Kt&&_t.setConstantPatternPositions(Kt)}let[Lt,kt]=n.paint.get("line-trim-offset");("round"===_e||"square"===_e)&&Lt!==kt&&(0===Lt&&(Lt-=1),1===kt&&(kt+=1));const Zt=J?Ke.projMatrix:null,di=L?1/ct.tileToMeter/o.ar(rt,1,l.transform.zoom):1,Ni=L?1/ct.tileToMeter/o.ar(rt,1,Math.floor(l.transform.zoom)):1,hn=be?o.c$(l,rt,n,Zt,re,di,Ni,[Lt,kt]):o.d0(l,rt,n,Zt,ct.lineClipsArray.length,re,di,Ni,[Lt,kt]);if(Ye){const Kt=ct.gradients[n.id];let Ei=Kt.texture;if(n.gradientVersion!==Kt.version){let Pt=256;if(n.stepInterpolant){const pi=t.getSource().maxzoom,Di=Ke.canonical.z===pi?Math.ceil(1<<l.transform.maxZoom-Ke.canonical.z):1;Pt=o.aw(o.d1(ct.maxLineLength/o.ag*1024*Di),256,N.maxTextureSize)}Kt.gradient=o.d2({expression:n.gradientExpression(),evaluationKey:"lineProgress",resolution:Pt,image:Kt.gradient||void 0,clips:ct.lineClipsArray}),Kt.texture?Kt.texture.update(Kt.gradient):Kt.texture=new o.T(N,Kt.gradient,V.RGBA8),Kt.version=n.gradientVersion,Ei=Kt.texture}N.activeTexture.set(V.TEXTURE1),Ei.bind(n.stepInterpolant?V.NEAREST:V.LINEAR,V.CLAMP_TO_EDGE)}ce&&(N.activeTexture.set(V.TEXTURE0),rt.lineAtlasTexture&&rt.lineAtlasTexture.bind(V.LINEAR,V.REPEAT),_t.updatePaintBuffers()),be&&(N.activeTexture.set(V.TEXTURE0),rt.imageAtlasTexture&&rt.imageAtlasTexture.bind(V.LINEAR,V.CLAMP_TO_EDGE),_t.updatePaintBuffers()),et&&!k&&l.terrain.setupElevationDraw(rt,jt),l.uploadCommonUniforms(N,jt,Ke.toUnwrapped());const nn=Kt=>{null!=He&&(He.value=qe*E),jt.draw(l,V.TRIANGLES,We,Kt,Q,Wt.disabled,hn,n.id,ct.layoutVertexBuffer,ct.indexBuffer,ct.segments,n.paint,l.transform.zoom,_t,[ct.layoutVertexBuffer2,ct.patternVertexBuffer,ct.zOffsetVertexBuffer]),null!=He&&(He.value=qe)};if(Le&&!et){const Kt=l.stencilModeForClipping(Ke).ref;0===Kt&&J&&N.clear({stencil:0});const Ei={func:V.EQUAL,mask:255};hn.u_alpha_discard_threshold=.8,nn(new qt(Ei,Kt,255,V.KEEP,V.KEEP,V.INVERT)),hn.u_alpha_discard_threshold=0,nn(new qt(Ei,Kt,255,V.KEEP,V.KEEP,V.KEEP))}else Le&&et&&(hn.u_alpha_discard_threshold=.001),nn(et?ut:l.stencilModeForClipping(Ke))}};if(n.hasNonElevatedBuckets){const De=!J&&l.terrain;0!==E&&De?o.w(`Occlusion opacity for layer ${n.id} is supported on terrain only if the layer has line-z-offset enabled.`):De?o.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${n.id}.`):it(c,Re,l.depthModeForSublayer(0,zt.ReadOnly),qt.disabled,!1)}if(n.hasElevatedBuckets){Re.push("ELEVATED"),Y&&Re.push(Z?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),k&&Re.push("ELEVATION_REFERENCE_SEA");const De=Le?l.stencilModeFor3D():qt.disabled,Je=new zt(l.depthOcclusion?V.GREATER:V.LEQUAL,zt.ReadOnly,l.depthRangeFor3D);l.forceTerrainMode=!0,it(c,Re,Je,De,!0),l.forceTerrainMode=!1}Le&&(l.resetStencilClippingMasks(),J&&N.clear({stencil:0})),0===E||l.depthOcclusion||J||l.layersWithOcclusionOpacity.push(l.currentLayer)},fill:function(l,t,n,c){const p=n.paint.get("fill-color"),y=n.paint.get("fill-opacity"),b=n.is3D(),E=new zt(l.context.gl.LEQUAL,zt.ReadWrite,l.depthRangeFor3D);if(0===y.constantOr(1))return;const D=n.paint.get("fill-emissive-strength"),L=l.colorModeForDrapableLayerRenderPass(D),k=n.paint.get("fill-pattern"),N=l.opaquePassEnabledForLayer()&&!k.constantOr(1)&&1===p.constantOr(o.aj.transparent).a&&1===y.constantOr(0)?"opaque":"translucent";if(l.renderPass===N){const V=b?E:l.depthModeForSublayer(1,"opaque"===l.renderPass?zt.ReadWrite:zt.ReadOnly);Hc(l,t,n,c,V,L,!1)}if(!b&&"translucent"===l.renderPass&&n.paint.get("fill-antialias")){const V=b?E:l.depthModeForSublayer(n.getPaintProperty("fill-outline-color")?2:0,zt.ReadOnly);Hc(l,t,n,c,V,L,!0)}},"fill-extrusion":function(l,t,n,c){const p=n.paint.get("fill-extrusion-opacity"),y=l.context,b=y.gl,E=l.terrain,D=E&&E.renderingToTexture;if(0===p)return;const L=l.conflationActive&&l.style.isLayerClipped(n,t.getSource()),k=l.style.order.indexOf(n.fqid);if(L&&function(N,V,j,Y,Z){for(const Q of Y){const J=V.getTile(Q).getBucket(j);J&&(J.updateReplacement(Q,N.replacementSource,Z),J.uploadCentroid(N.context))}}(l,t,n,c,k),E||L)for(const N of c){const V=t.getTile(N).getBucket(n);V&&sl(l.context,t,N,V,n,E,L)}if("shadow"===l.renderPass&&l.shadowRenderer){const N=l.shadowRenderer;if(E&&p<.65&&n._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof o.a9)return;const V=N.getShadowPassDepthMode(),j=N.getShadowPassColorMode();nl(l,t,n,c,V,qt.disabled,j,L)}else if("translucent"===l.renderPass){const N=!n.paint.get("fill-extrusion-pattern").constantOr(1),V=n.paint.get("fill-extrusion-color").constantOr(o.aj.white);if(!D&&0!==V.a){const j=new zt(l.context.gl.LEQUAL,zt.ReadWrite,l.depthRangeFor3D);1===p&&N?nl(l,t,n,c,j,qt.disabled,li.unblended,L):(nl(l,t,n,c,j,qt.disabled,li.disabled,L),nl(l,t,n,c,j,l.stencilModeFor3D(),l.colorModeForRenderPass(),L),l.resetStencilClippingMasks())}if(l.style.enable3dLights()&&N&&(!E&&"globe"!==l.transform.projection.name||D)){const j=n.paint.get("fill-extrusion-opacity"),Y=n.paint.get("fill-extrusion-ambient-occlusion-intensity"),Z=n.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),Q=n.paint.get("fill-extrusion-flood-light-intensity"),J="none"===n.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default"),re=n.paint.get("fill-extrusion-flood-light-color").toRenderColor(J?null:n.lut).toArray01().slice(0,3),he=Y>0&&Z>0,ce=Q>0,ge=(_e,de,be)=>(1-be)*_e+be*de,pe=_e=>{const de=l.depthModeForSublayer(1,zt.ReadOnly,b.LEQUAL,!0),be=n.paint.get(_e?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Ee=ge(.1,3,be),qe=l._showOverdrawInspector;if(!qe){const Le=new qt({func:b.ALWAYS,mask:255},255,255,b.KEEP,b.KEEP,b.REPLACE),Ye=new li([b.ONE,b.ONE,b.ONE,b.ONE],o.aj.transparent,[!1,!1,!1,!0],b.MIN);rl(l,t,n,c,de,Le,Ye,Wt.disabled,_e,"sdf",j,Y,Z,Q,re,Ee,L,!1)}{const Le=qe?qt.disabled:new qt({func:b.EQUAL,mask:255},255,255,b.KEEP,b.DECR,b.DECR),Ye=qe?l.colorModeForRenderPass():new li([b.ONE_MINUS_DST_ALPHA,b.DST_ALPHA,b.ONE,b.ONE],o.aj.transparent,[!0,!0,!0,!0]);rl(l,t,n,c,de,Le,Ye,Wt.disabled,_e,"color",j,Y,Z,Q,re,Ee,L,!1)}};if(D){const _e=(de,be,Ee)=>{const qe=l.depthModeForSublayer(1,zt.ReadOnly,b.LEQUAL,!1),Le=n.paint.get(de?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Ye=ge(.1,3,Le);{const Xe=new li([b.ONE,b.ONE,b.ONE,b.ONE],o.aj.transparent,[!1,!1,!1,!0]);rl(l,t,n,c,qe,qt.disabled,Xe,Wt.disabled,de,"clear",j,Y,Z,Q,re,Ye,L,be)}{const Xe=new qt({func:b.ALWAYS,mask:255},255,255,b.KEEP,b.KEEP,b.REPLACE),Re=new li([b.ONE,b.ONE,b.ONE,b.ONE],o.aj.transparent,[!1,!1,!1,!0],b.MIN);rl(l,t,n,c,qe,Xe,Re,Wt.disabled,de,"sdf",j,Y,Z,Q,re,Ye,L,be)}{const Xe=de?b.ZERO:b.ONE_MINUS_DST_ALPHA,Re=new qt({func:b.EQUAL,mask:255},255,255,b.KEEP,b.DECR,b.DECR),He=new li([Xe,b.DST_ALPHA,b.ONE_MINUS_DST_ALPHA,b.ZERO],o.aj.transparent,[!0,!0,!0,!0]);rl(l,t,n,c,qe,Re,He,Wt.disabled,de,"color",j,Y,Z,Q,re,Ye,L,be)}{const Xe=new li([b.ONE,b.ONE,b.ONE,de?b.ZERO:b.ONE],o.aj.transparent,[!1,!1,!1,!0],de?b.FUNC_ADD:b.MAX);rl(l,t,n,c,qe,qt.disabled,Xe,Wt.disabled,de,"clear",j,Y,Z,Q,re,Ye,L,be,Ee)}};if(he||ce){let de;if(l.prepareDrawTile(),E){const be=E.drapeBufferSize[0],Ee=E.drapeBufferSize[1];de=E.framebufferCopyTexture,de&&(!de||de.size[0]===be&&de.size[1]===Ee)||(de&&de.destroy(),de=E.framebufferCopyTexture=new o.T(y,new o.r({width:be,height:Ee}),b.RGBA8)),de.bind(b.LINEAR,b.CLAMP_TO_EDGE),b.copyTexSubImage2D(b.TEXTURE_2D,0,0,0,0,0,be,Ee)}he&&_e(!0,!1,de),ce&&_e(!1,!0,de)}}else he&&pe(!0),ce&&pe(!1),(he||ce)&&l.resetStencilClippingMasks()}}},hillshade:function(l,t,n,c){if("offscreen"!==l.renderPass&&"translucent"!==l.renderPass||l.style.disableElevatedTerrain)return;const p=l.context,y=l.terrain&&l.terrain.renderingToTexture,[b,E]="translucent"!==l.renderPass||y?[{},c]:l.stencilConfigForOverlap(c);for(const D of E){const L=t.getTile(D);if(L.needsHillshadePrepare&&"offscreen"===l.renderPass)Rd(l,L,n);else if("translucent"===l.renderPass){const k=l.depthModeForSublayer(0,zt.ReadOnly),N=n.paint.get("hillshade-emissive-strength"),V=l.colorModeForDrapableLayerRenderPass(N),j=y&&l.terrain?l.terrain.stencilModeForRTTOverlap(D):b[D.overscaledZ];ju(l,D,L,n,k,j,V)}}p.viewport.set([0,0,l.width,l.height]),l.resetStencilClippingMasks()},raster:function(l,t,n,c,p,y){if("translucent"!==l.renderPass||0===n.paint.get("raster-opacity"))return;const b="globe"===l.transform.projection.name,E=0!==n.paint.get("raster-elevation"),D=E&&b;if(l.renderElevatedRasterBackface&&!D)return;const L=l.context,k=L.gl,N=t.getSource(),V=function(pe,_e,de,be){const Ee=_e.paint.get("raster-color"),qe="raster-array"===pe.type,Le=[],Ye=_e.paint.get("raster-resampling"),Xe=_e.paint.get("raster-color-mix");let Re=_e.paint.get("raster-color-range");const He=[Xe[0],Xe[1],Xe[2],0],it=Xe[3];let De="nearest"===Ye?be.NEAREST:be.LINEAR;if(qe&&(Le.push("RASTER_ARRAY"),Ee||Le.push("RASTER_COLOR"),"linear"===Ye&&Le.push("RASTER_ARRAY_LINEAR"),De=be.NEAREST,!Re&&pe.rasterLayers)){const Je=pe.rasterLayers.find(({id:We})=>We===_e.sourceLayer);Je&&Je.fields&&Je.fields.range&&(Re=Je.fields.range)}if(Re=Re||[0,1],Ee){Le.push("RASTER_COLOR"),de.activeTexture.set(be.TEXTURE2),_e.updateColorRamp(Re);let Je=_e.colorRampTexture;Je||(Je=_e.colorRampTexture=new o.T(de,_e.colorRamp,be.RGBA8)),Je.bind(be.LINEAR,be.CLAMP_TO_EDGE)}return{mix:He,range:Re,offset:it,defines:Le,resampling:De}}(N,n,L,k);if(N instanceof o.aJ&&!c.length&&!b)return;const j=n.paint.get("raster-emissive-strength"),Y=l.colorModeForDrapableLayerRenderPass(j),Z=l.terrain&&l.terrain.renderingToTexture,Q=!l.options.moving,J="nearest"===n.paint.get("raster-resampling")?k.NEAREST:k.LINEAR;if(N instanceof o.aJ&&!c.length&&(N.onNorthPole||N.onSouthPole)){const pe=E?l.stencilModeFor3D():qt.disabled;return void Ne(!!N.onNorthPole,null,l,t,n,j,V,Wt.disabled,pe)}if(!c.length)return;const[re,he]=N instanceof o.aJ||Z?[{},c]:l.stencilConfigForOverlap(c),ce=he[he.length-1].overscaledZ;D&&V.defines.push("PROJECTION_GLOBE_VIEW"),E&&V.defines.push("RENDER_CUTOFF");const ge=(pe,_e,de)=>{for(const be of pe){const Ee=be.toUnwrapped(),qe=t.getTile(be);if(Z&&(!qe||!qe.hasData()))continue;L.activeTexture.set(k.TEXTURE0);const Le=_a(qe,N,n,V);if(!Le||!Le.texture)continue;const{texture:Ye,mix:Xe,offset:Re,tileSize:He,buffer:it}=Le;let De,Je;Z?(De=zt.disabled,Je=be.projMatrix):E?(De=new zt(k.LEQUAL,zt.ReadWrite,l.depthRangeFor3D),Je=b?Float32Array.from(l.transform.expandedFarZProjMatrix):l.transform.calculateProjMatrix(Ee,Q)):(De=l.depthModeForSublayer(be.overscaledZ-ce,1===n.paint.get("raster-opacity")?zt.ReadWrite:zt.ReadOnly,k.LESS),Je=l.transform.calculateProjMatrix(Ee,Q));const We=l.terrain&&Z?l.terrain.stencilModeForRTTOverlap(be):re[be.overscaledZ],ut=y?0:n.paint.get("raster-fade-duration");qe.registerFadeDuration(ut);const et=t.findLoadedParent(be,0),Ke=tl(qe,et,t,l.transform,ut);let rt,ct;l.terrain&&l.terrain.prepareDrawTile(),L.activeTexture.set(k.TEXTURE0),Ye.bind(J,k.CLAMP_TO_EDGE),L.activeTexture.set(k.TEXTURE1),et?(et.texture&&et.texture.bind(J,k.CLAMP_TO_EDGE),rt=Math.pow(2,et.tileID.overscaledZ-qe.tileID.overscaledZ),ct=[qe.tileID.canonical.x*rt%1,qe.tileID.canonical.y*rt%1]):Ye.bind(J,k.CLAMP_TO_EDGE),Ye.useMipmap&&L.extTextureFilterAnisotropic&&l.transform.pitch>20&&k.texParameterf(k.TEXTURE_2D,L.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,L.extTextureFilterAnisotropicMax);const _t=l.transform;let Tt;const jt=E?Lo(_t):[0,0,0,0];let Lt,kt,Zt,di,Ni,hn=0;if(D&&N instanceof o.aJ&&N.coordinates.length>3)Lt=Float32Array.from(o.bb(o.cH(new o.bT(0,0,0)))),kt=Float32Array.from(_t.globeMatrix),Zt=Float32Array.from(o.cD(_t)),di=[o.at(_t.center.lng),o.aA(_t.center.lat)],Tt=N.elevatedGlobePerspectiveTransform,Ni=N.elevatedGlobeGridMatrix||new Float32Array(9);else if(D){const Pt=o.cE(be.canonical);hn=o.cF(Pt.getCenter().lat),Lt=Float32Array.from(o.bb(o.cH(be.canonical))),kt=Float32Array.from(_t.globeMatrix),Zt=Float32Array.from(o.cD(_t)),di=[o.at(_t.center.lng),o.aA(_t.center.lat)],Tt=[0,0],Ni=Float32Array.from(o.cG(be.canonical,Pt,hn,_t.worldSize/_t._pixelsPerMercatorPixel))}else Tt=N instanceof o.aJ?N.perspectiveTransform:[0,0],Lt=new Float32Array(16),kt=new Float32Array(9),Zt=new Float32Array(16),di=[0,0],Ni=new Float32Array(9);const nn=no(Je,Lt,kt,Zt,Ni,ct||[0,0],o.ae(l.transform.zoom),di,jt,rt||1,Ke,n,Tt,E?n.paint.get("raster-elevation"):0,2,Xe,Re,V.range,He,it,j),Kt=l.isTileAffectedByFog(be),Ei=l.getOrCreateProgram("raster",{defines:V.defines,overrideFog:Kt});if(l.uploadCommonUniforms(L,Ei,Ee),N instanceof o.aJ){const Pt=N.elevatedGlobeVertexBuffer,pi=N.elevatedGlobeIndexBuffer;if(Z||!b)N.boundsBuffer&&N.boundsSegments&&Ei.draw(l,k.TRIANGLES,De,qt.disabled,Y,Wt.disabled,nn,n.id,N.boundsBuffer,l.quadTriangleIndexBuffer,N.boundsSegments);else if(Pt&&pi){const Di=_t.zoom<=o.c6?N.elevatedGlobeSegments:N.getSegmentsForLongitude(_t.center.lng);Di&&Ei.draw(l,k.TRIANGLES,De,qt.disabled,Y,_e,nn,n.id,Pt,pi,Di)}}else if(D){De=new zt(k.LEQUAL,zt.ReadOnly,l.depthRangeFor3D);const Pt=l.globeSharedBuffers;if(Pt){const[pi,Di,ki]=Pt.getGridBuffers(hn,!1);Ei.draw(l,k.TRIANGLES,De,de||We,l.colorModeForRenderPass(),_e,nn,n.id,pi,Di,ki)}}else{const{tileBoundsBuffer:Pt,tileBoundsIndexBuffer:pi,tileBoundsSegments:Di}=l.getTileBoundsBuffers(qe);Ei.draw(l,k.TRIANGLES,De,We,Y,Wt.disabled,nn,n.id,Pt,pi,Di)}}if(!(N instanceof o.aJ)&&D)for(const be of pe){const Ee=be.canonical.y===(1<<be.canonical.z)-1;0===be.canonical.y&&Ne(!0,be,l,t,n,j,V,_e,de||qt.disabled),Ee&&Ne(!1,be,l,t,n,j,V,_e===Wt.frontCW?Wt.backCW:Wt.frontCW,de||qt.disabled)}};D?ge(he,l.renderElevatedRasterBackface?Wt.backCW:Wt.frontCW,l.stencilModeFor3D()):ge(he,Wt.disabled,void 0),l.resetStencilClippingMasks()},"raster-particle":function(l,t,n,c,p,y){"offscreen"===l.renderPass&&function(b,E,D,L){if(!L.length)return;const k=b.context,N=k.gl,V=E.getSource();if(!(V instanceof zn))return;const j=Math.ceil(Math.sqrt(D.paint.get("raster-particle-count")));let Y=D.particlePositionRGBAImage;if(!Y||Y.width!==j){const he=function(ce){const ge=ce*ce,pe=new Uint8Array(4*ge),_e=function(be){return be|=0,be=Math.imul(2747636419^be,2654435769),be=Math.imul(be^be>>>16,2654435769),((be=Math.imul(be^be>>>16,2654435769))>>>0)/4294967296},de=1/1.1;for(let be=0;be<ge;be++){const Ee=de*(_e(2*be+0)+Ct),qe=de*(_e(2*be+1)+Ct),Le=255*Ee%1,Ye=255*qe%1,Xe=Le,Re=qe-Ye/255,He=Ye;pe[4*be+0]=255*(Ee-Le/255),pe[4*be+1]=255*Xe,pe[4*be+2]=255*Re,pe[4*be+3]=255*He}return pe}(j);Y=D.particlePositionRGBAImage=new o.r({width:j,height:j},he)}let Z=D.particleFramebuffer;Z?Z.width!==j&&(Z.destroy(),Z=D.particleFramebuffer=k.createFramebuffer(j,j,!0,null)):Z=D.particleFramebuffer=k.createFramebuffer(j,j,!0,null);const Q=[];for(const he of L){const ce=E.getTile(he);if(!(ce instanceof Is))continue;const ge=td(ce,V,D);if(!ge)continue;const pe=[ce.tileSize,ce.tileSize];let _e=D.tileFramebuffer;_e||(_e=D.tileFramebuffer=k.createFramebuffer(pe[0],pe[1],!0,null));let de=ce.rasterParticleState;de||(de=ce.rasterParticleState=new ed(k,he,pe,Y));const be=de.update(D.lastInvalidatedAt);de.particleTextureDimension!==j&&de.updateParticleTexture(he,Y);const Ee=de.targetColorTexture;de.targetColorTexture=de.backgroundColorTexture,de.backgroundColorTexture=Ee;const qe=de.particleTexture0;de.particleTexture0=de.particleTexture1,de.particleTexture1=qe,Q.push([he,ge,de,be])}if(0===Q.length)return;const J=o.q.now(),re=D.previousDrawTimestamp?.001*(J-D.previousDrawTimestamp):.0167;if(D.previousDrawTimestamp=J,D.hasColorMap()){k.activeTexture.set(N.TEXTURE0+2);let he=D.colorRampTexture;he||(he=D.colorRampTexture=new o.T(k,D.colorRamp,N.RGBA8)),he.bind(N.LINEAR,N.CLAMP_TO_EDGE)}k.bindFramebuffer.set(D.tileFramebuffer.framebuffer),function(he,ce,ge){const pe=he.context,_e=pe.gl,de=ce.tileFramebuffer;pe.activeTexture.set(_e.TEXTURE0);const be={u_texture:0,u_opacity:1.05*(qe=ce.paint.get("raster-particle-fade-opacity-factor"))/(qe+.05)},Ee=he.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var qe;for(const Le of ge){const[,,Ye,Xe]=Le;de.colorAttachment.set(Ye.targetColorTexture.texture),pe.viewport.set([0,0,de.width,de.height]),pe.clear({color:o.aj.transparent}),Xe&&(Ye.backgroundColorTexture.bind(_e.NEAREST,_e.CLAMP_TO_EDGE),Ee.draw(he,_e.TRIANGLES,zt.disabled,qt.disabled,li.alphaBlended,Wt.disabled,be,ce.id,he.viewportBuffer,he.quadTriangleIndexBuffer,he.viewportSegments))}}(b,D,Q),function(he,ce,ge,pe){const _e=he.context,de=_e.gl,be=ge.tileFramebuffer,Ee="globe"===he.transform.projection.name,qe=ge.paint.get("raster-particle-max-speed");for(const Le of pe){const[Ye,Xe,Re]=Le;_e.activeTexture.set(de.TEXTURE0+0),Xe.texture.bind(de.LINEAR,de.CLAMP_TO_EDGE),be.colorAttachment.set(Re.targetColorTexture.texture);const He=he.getOrCreateProgram("rasterParticleDraw",{defines:Xe.defines,overrideFog:!1});_e.activeTexture.set(de.TEXTURE0+1);const it=Xe.scalarData?[]:[0,1,2,3].map(We=>o.d4[We](Ye));it.push(Ye);const De=Ye.canonical.x,Je=Ye.canonical.y;for(const We of it){const ut=ce.getTile(Ee?We.wrapped():We);if(!ut)continue;const et=ut.rasterParticleState;if(!et)continue;const Ke=We.canonical.x+(1<<We.canonical.z)*(We.wrap-Ye.wrap),rt=We.canonical.y;et.particleTexture0.bind(de.NEAREST,de.CLAMP_TO_EDGE);const ct=Bc(1,et.particleTexture0.size[0],[Ke-De,rt-Je],0,Xe.texture.size,2,qe,Xe.textureOffset,Xe.scale,Xe.offset);He.draw(he,de.POINTS,zt.disabled,qt.disabled,li.alphaBlended,Wt.disabled,ct,ge.id,et.particleIndexBuffer,void 0,et.particleSegment)}}}(b,E,D,Q),k.bindFramebuffer.set(D.particleFramebuffer.framebuffer),function(he,ce,ge,pe){const _e=he.context,de=_e.gl,be=ce.paint.get("raster-particle-max-speed"),Ee=pe*ce.paint.get("raster-particle-speed-factor")*.15,qe=(Ye=.01+1*ce.paint.get("raster-particle-reset-rate-factor"),Math.pow(Ye,6)),Le=ce.particleFramebuffer;var Ye;_e.viewport.set([0,0,Le.width,Le.height]);for(const Ye of ge){const[,Xe,Re]=Ye;_e.activeTexture.set(de.TEXTURE0+0),Xe.texture.bind(de.LINEAR,de.CLAMP_TO_EDGE),_e.activeTexture.set(de.TEXTURE0+1);const He=Re.particleTexture0;He.bind(de.NEAREST,de.CLAMP_TO_EDGE);const it=Vd(1,He.size[0],0,Xe.texture.size,be,Ee,qe,Xe.textureOffset,Xe.scale,Xe.offset);Le.colorAttachment.set(Re.particleTexture1.texture),_e.clear({color:o.aj.transparent}),he.getOrCreateProgram("rasterParticleUpdate",{defines:Xe.defines}).draw(he,de.TRIANGLES,zt.disabled,qt.disabled,li.unblended,Wt.disabled,it,ce.id,he.viewportBuffer,he.quadTriangleIndexBuffer,he.viewportSegments)}}(b,D,Q,re)}(l,t,n,c),"translucent"===l.renderPass&&(function(b,E,D,L){const N=b.context,V=N.gl,j=E.getSource().tileSize,Y=5*(1-o.ac(o.bY,o.bY+1,b.transform.zoom))*j+D.paint.get("raster-particle-elevation"),Z=!b.options.moving,Q="globe"===b.transform.projection.name;if(!L.length)return;const[J,re]=b.stencilConfigForOverlap(L),he=[];Q&&he.push("PROJECTION_GLOBE_VIEW");const ce=b.stencilModeFor3D();for(const ge of re){const pe=ge.toUnwrapped(),_e=E.getTile(ge);if(!_e.rasterParticleState)continue;const de=_e.rasterParticleState,be=100;_e.registerFadeDuration(be);const Ee=E.findLoadedParent(ge,0),qe=tl(_e,Ee,E,b.transform,be);let Le,Ye;b.terrain&&b.terrain.prepareDrawTile(),N.activeTexture.set(V.TEXTURE0),de.targetColorTexture.bind(V.LINEAR,V.CLAMP_TO_EDGE),N.activeTexture.set(V.TEXTURE1),Ee&&Ee.rasterParticleState?(Ee.rasterParticleState.targetColorTexture.bind(V.LINEAR,V.CLAMP_TO_EDGE),Le=Math.pow(2,Ee.tileID.overscaledZ-_e.tileID.overscaledZ),Ye=[_e.tileID.canonical.x*Le%1,_e.tileID.canonical.y*Le%1]):de.targetColorTexture.bind(V.LINEAR,V.CLAMP_TO_EDGE);const Xe=Q?Float32Array.from(b.transform.expandedFarZProjMatrix):b.transform.calculateProjMatrix(pe,Z),Re=b.transform,He=id(Re),it=o.cE(ge.canonical),De=o.cF(it.getCenter().lat);let Je,We,ut,et,Ke;Q?(Je=Float32Array.from(o.bb(o.cH(ge.canonical))),We=Float32Array.from(Re.globeMatrix),ut=Float32Array.from(o.cD(Re)),et=[o.at(Re.center.lng),o.aA(Re.center.lat)],Ke=Float32Array.from(o.cG(ge.canonical,it,De,Re.worldSize/Re._pixelsPerMercatorPixel))):(Je=new Float32Array(16),We=new Float32Array(9),ut=new Float32Array(16),et=[0,0],Ke=new Float32Array(9));const rt=Kh(Xe,Je,We,ut,Ke,Ye||[0,0],o.ae(b.transform.zoom),et,He,Le||1,qe,Y),ct=b.isTileAffectedByFog(ge),_t=b.getOrCreateProgram("rasterParticle",{defines:he,overrideFog:ct});if(b.uploadCommonUniforms(N,_t,pe),Q){const Tt=new zt(V.LEQUAL,zt.ReadOnly,b.depthRangeFor3D),jt=0,Lt=b.globeSharedBuffers;if(Lt){const[kt,Zt,di]=Lt.getGridBuffers(De,0!==jt);_t.draw(b,V.TRIANGLES,Tt,ce,li.alphaBlended,b.renderElevatedRasterBackface?Wt.frontCCW:Wt.backCCW,rt,D.id,kt,Zt,di)}}else{const Tt=b.depthModeForSublayer(0,zt.ReadOnly),jt=J[ge.overscaledZ],{tileBoundsBuffer:Lt,tileBoundsIndexBuffer:kt,tileBoundsSegments:Zt}=b.getTileBoundsBuffers(_e);_t.draw(b,V.TRIANGLES,Tt,jt,li.alphaBlended,Wt.disabled,rt,D.id,Lt,kt,Zt)}}b.resetStencilClippingMasks()}(l,t,n,c),l.style.map.triggerRepaint())},background:function(l,t,n,c){const p=n.paint.get("background-color"),y="none"===n.paint.get("background-color-use-theme").constantOr("default"),b=n.paint.get("background-opacity"),E=n.paint.get("background-emissive-strength"),D="viewport"===n.paint.get("background-pitch-alignment");if(0===b)return;const L=l.context,k=L.gl,N=l.transform,V=N.tileSize,j=n.paint.get("background-pattern");let Y;if(void 0!==j&&(null===j||(Y=l.imageManager.getPattern(j.toString(),n.scope,l.style.getLut(n.scope)),!Y)))return;const Z=!j&&1===p.a&&1===b&&l.opaquePassEnabledForLayer()?"opaque":"translucent";if(l.renderPass!==Z)return;const Q=qt.disabled,J=l.depthModeForSublayer(0,"opaque"===Z?zt.ReadWrite:zt.ReadOnly),re=l.colorModeForDrapableLayerRenderPass(E),he=j?"backgroundPattern":"background";let ce,ge=c;if(ge||(ce=l.getBackgroundTiles(),ge=Object.values(ce).map(pe=>pe.tileID)),j&&(L.activeTexture.set(k.TEXTURE0),l.imageManager.bind(l.context,n.scope)),D){const pe=l.getOrCreateProgram(he,{overrideFog:!1,overrideRtt:!0}),_e=new Float32Array(o.ab.mat4.identity([])),de=new o.aG(0,0,0,0,0),be=j?Jh(_e,E,b,l,0,n.scope,Y,D,{tileID:de,tileSize:V}):Vc(_e,E,b,p.toRenderColor(y?null:n.lut));pe.draw(l,k.TRIANGLES,J,Q,re,Wt.disabled,be,n.id,l.viewportBuffer,l.quadTriangleIndexBuffer,l.viewportSegments)}else for(const pe of ge){const _e=l.isTileAffectedByFog(pe),de=l.getOrCreateProgram(he,{overrideFog:_e}),be=pe.toUnwrapped(),Ee=c?pe.projMatrix:l.transform.calculateProjMatrix(be);l.prepareDrawTile();const qe=t?t.getTile(pe):ce?ce[pe.key]:new rs(pe,V,N.zoom,l),Le=j?Jh(Ee,E,b,l,0,n.scope,Y,D,{tileID:pe,tileSize:V}):Vc(Ee,E,b,p.toRenderColor(y?null:n.lut));l.uploadCommonUniforms(L,de,be);const{tileBoundsBuffer:Ye,tileBoundsIndexBuffer:Xe,tileBoundsSegments:Re}=l.getTileBoundsBuffers(qe);de.draw(l,k.TRIANGLES,J,Q,re,Wt.disabled,Le,n.id,Ye,Xe,Re)}},sky:function(l,t,n){const c=l._atmosphere?o.ae(l.transform.zoom):1,p=n.paint.get("sky-opacity")*c;if(0===p)return;const y=l.context,b=n.paint.get("sky-type"),E=new zt(y.gl.LEQUAL,zt.ReadOnly,[0,1]),D=l.frameCounter/1e3%1;"atmosphere"===b?"offscreen"===l.renderPass?n.needsSkyboxCapture(l)&&(function(L,k){const j=L.context,Y=j.gl;let Z=k.skyboxFbo;if(!Z){Z=k.skyboxFbo=j.createFramebuffer(32,32,!0,null),k.skyboxGeometry=new nu(j),k.skyboxTexture=j.gl.createTexture(),Y.bindTexture(Y.TEXTURE_CUBE_MAP,k.skyboxTexture),Y.texParameteri(Y.TEXTURE_CUBE_MAP,Y.TEXTURE_WRAP_S,Y.CLAMP_TO_EDGE),Y.texParameteri(Y.TEXTURE_CUBE_MAP,Y.TEXTURE_WRAP_T,Y.CLAMP_TO_EDGE),Y.texParameteri(Y.TEXTURE_CUBE_MAP,Y.TEXTURE_MIN_FILTER,Y.LINEAR),Y.texParameteri(Y.TEXTURE_CUBE_MAP,Y.TEXTURE_MAG_FILTER,Y.LINEAR);for(let he=0;he<6;++he)Y.texImage2D(Y.TEXTURE_CUBE_MAP_POSITIVE_X+he,0,Y.RGBA,32,32,0,Y.RGBA,Y.UNSIGNED_BYTE,null)}j.bindFramebuffer.set(Z.framebuffer),j.viewport.set([0,0,32,32]);const Q=k.getCenter(L,!0),J=L.getOrCreateProgram("skyboxCapture"),re=new Float64Array(16);o.ab.mat4.identity(re),o.ab.mat4.rotateY(re,re,.5*-Math.PI),Wn(L,k,J,re,Q,0),o.ab.mat4.identity(re),o.ab.mat4.rotateY(re,re,.5*Math.PI),Wn(L,k,J,re,Q,1),o.ab.mat4.identity(re),o.ab.mat4.rotateX(re,re,.5*-Math.PI),Wn(L,k,J,re,Q,2),o.ab.mat4.identity(re),o.ab.mat4.rotateX(re,re,.5*Math.PI),Wn(L,k,J,re,Q,3),o.ab.mat4.identity(re),Wn(L,k,J,re,Q,4),o.ab.mat4.identity(re),o.ab.mat4.rotateY(re,re,Math.PI),Wn(L,k,J,re,Q,5),j.viewport.set([0,0,L.width,L.height])}(l,n),n.markSkyboxValid(l)):"sky"===l.renderPass&&function(L,k,N,V,j){const Y=L.context,Z=Y.gl,Q=L.transform,J=L.getOrCreateProgram("skybox");Y.activeTexture.set(Z.TEXTURE0),Z.bindTexture(Z.TEXTURE_CUBE_MAP,k.skyboxTexture);const re=((he,ce,ge,pe,_e)=>({u_matrix:he,u_sun_direction:ce,u_cubemap:0,u_opacity:pe,u_temporal_offset:_e}))(Q.skyboxMatrix,k.getCenter(L,!1),0,V,j);L.uploadCommonUniforms(Y,J),J.draw(L,Z.TRIANGLES,N,qt.disabled,L.colorModeForRenderPass(),Wt.backCW,re,"skybox",k.skyboxGeometry.vertexBuffer,k.skyboxGeometry.indexBuffer,k.skyboxGeometry.segment)}(l,n,E,p,D):"gradient"===b&&"sky"===l.renderPass&&function(L,k,N,V,j){const Y=L.context,Z=Y.gl,Q=L.transform,J=L.getOrCreateProgram("skyboxGradient");k.skyboxGeometry||(k.skyboxGeometry=new nu(Y)),Y.activeTexture.set(Z.TEXTURE0);let re=k.colorRampTexture;re||(re=k.colorRampTexture=new o.T(Y,k.colorRamp,Z.RGBA8)),re.bind(Z.LINEAR,Z.CLAMP_TO_EDGE);const he=(ce=Q.skyboxMatrix,ge=k.getCenter(L,!1),pe=k.paint.get("sky-gradient-radius"),_e=V,de=j,{u_matrix:ce,u_color_ramp:0,u_center_direction:ge,u_radius:o.ai(pe),u_opacity:_e,u_temporal_offset:de});var ce,ge,pe,_e,de;L.uploadCommonUniforms(Y,J),J.draw(L,Z.TRIANGLES,N,qt.disabled,L.colorModeForRenderPass(),Wt.backCW,he,"skyboxGradient",k.skyboxGeometry.vertexBuffer,k.skyboxGeometry.indexBuffer,k.skyboxGeometry.segment)}(l,n,E,p,D)},debug:function(l,t,n,c,p,y){for(let b=0;b<n.length;b++)if(p){const L=new o.aj(.8*c.r,.8*c.g,.8*c.b,1);ko(l,t,n[b],c,-1,-1,y),ko(l,t,n[b],c,-1,1,y),ko(l,t,n[b],c,1,1,y),ko(l,t,n[b],c,1,-1,y),ko(l,t,n[b],L,0,0,y)}else ko(l,t,n[b],c,0,0,y)},custom:function(l,t,n,c){const p=l.context,y=n.implementation;if(!l.transform.projection.unsupportedLayers||!l.transform.projection.unsupportedLayers.includes("custom")||l.terrain&&(l.terrain.renderingToTexture||"offscreen"===l.renderPass)&&n.isDraped(t)){if("offscreen"===l.renderPass){const b=y.prerender;if(b){if(l.setCustomLayerDefaults(),p.setColorMode(l.colorModeForRenderPass()),"globe"===l.transform.projection.name){const E=l.transform.pointMerc;b.call(y,p.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),o.ae(l.transform.zoom),[E.x,E.y],l.transform.pixelsPerMeterRatio)}else b.call(y,p.gl,l.transform.customLayerMatrix());p.setDirty(),l.setBaseState()}}else if("translucent"===l.renderPass){if(l.terrain&&l.terrain.renderingToTexture){const E=y.renderToTile;if(E){const D=c[0].canonical,L=new o.aa(D.x+c[0].wrap*(1<<D.z),D.y,D.z);p.setDepthMode(zt.disabled),p.setStencilMode(qt.disabled),p.setColorMode(l.colorModeForRenderPass()),l.setCustomLayerDefaults(),E.call(y,p.gl,L),p.setDirty(),l.setBaseState()}return}l.setCustomLayerDefaults(),p.setColorMode(l.colorModeForRenderPass()),p.setStencilMode(qt.disabled);const b="3d"===y.renderingMode?new zt(l.context.gl.LEQUAL,zt.ReadWrite,l.depthRangeFor3D):l.depthModeForSublayer(0,zt.ReadOnly);if(p.setDepthMode(b),"globe"===l.transform.projection.name){const E=l.transform.pointMerc;y.render(p.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),o.ae(l.transform.zoom),[E.x,E.y],l.transform.pixelsPerMeterRatio)}else y.render(p.gl,l.transform.customLayerMatrix());p.setDirty(),l.setBaseState(),p.bindFramebuffer.set(null)}}else o.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(l,t,n,c){if("opaque"===l.renderPass)return;const p=n.paint.get("model-opacity").constantOr(1);if(0===p)return;const y=n.paint.get("model-cast-shadows");if("shadow"===l.renderPass&&(!y||l.terrain&&p<.65&&n._transitionablePaint._values["model-opacity"].value.expression instanceof o.a9))return;const b=l.shadowRenderer,E=n.paint.get("model-receive-shadows");b&&(b.useNormalOffset=!0,E||(b.enabled=!1));const D=()=>{b&&(b.useNormalOffset=!0,E||(b.enabled=!0))},L=t.getSource();if("light-beam"===l.renderPass&&"batched-model"!==L.type)return;if("vector"===L.type||"geojson"===L.type)return function(J,re,he,ce,ge){const pe=J.transform;if("mercator"!==pe.projection.name)return void o.w(`Drawing 3D models for ${pe.projection.name} projection is not yet implemented`);const _e=pe.getFreeCameraOptions().position;if(!J.modelManager)return;const de=J.modelManager;he.modelManager=de;const be=J.shadowRenderer;if(!he._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const Ee=he._unevaluatedLayout._values["model-id"],qe=Object.assign({},he.layout.get("model-id").parameters),Le=J.style.order.indexOf(he.fqid);for(const Ye of ce){const Xe=re.getTile(Ye).getBucket(he);if(!Xe||Xe.projection.name!==pe.projection.name)continue;const Re=Xe.getModelUris();Re&&!Xe.modelsRequested&&(de.addModelsFromBucket(Re,ge),Xe.modelsRequested=!0);const He=Zc(Ye,pe);qe.zoom=He;const it=Ee.possiblyEvaluate(qe);if(Fs(J,Xe,Ye),pr.shadowUniformsInitialized=!1,pr.useSingleShadowCascade=!!be&&0===be.getMaxCascadeForTile(Ye.toUnwrapped()),"shadow"===J.renderPass&&be){if(1===J.currentShadowCascade&&Xe.isInsideFirstShadowMapFrustum)continue;const We=pe.calculatePosMatrix(Ye.toUnwrapped(),pe.worldSize);if(pr.tileMatrix.set(We),pr.shadowTileMatrix=Float32Array.from(be.calculateShadowPassMatrixFromMatrix(We)),pr.aabb.min.fill(0),pr.aabb.max[0]=pr.aabb.max[1]=o.ag,pr.aabb.max[2]=0,Yc(Xe,pr,J,he.scope))continue}const De=1<<Ye.canonical.z,Je=[((_e.x-Ye.wrap)*De-Ye.canonical.x)*o.ag,(_e.y*De-Ye.canonical.y)*o.ag,_e.z*De*o.ag];J.conflationActive&&Object.keys(Xe.instancesPerModel).length>0&&J.style.isLayerClipped(he,re.getSource())&&Xe.updateReplacement(Ye,J.replacementSource,Le,ge)&&(Xe.uploaded=!1,Xe.upload(J.context));for(let We in Xe.instancesPerModel){const ut=Xe.instancesPerModel[We];ut.features.length>0&&(We=it.evaluate(ut.features[0].feature,{}));const et=de.getModel(We,ge);if(et&&et.uploaded)for(const Ke of et.nodes)ic(J,he,Ke,ut,Je,Ye,pr)}}}(l,t,n,c,"vector"===L.type?n.scope:""),void D();if(!L.loaded())return;if("batched-model"===L.type)return function(J,re,he,ce){he.resetLayerRenderingStats(J);const ge=J.context,pe=J.transform,_e=J.style.fog,de=J.shadowRenderer;if("mercator"!==pe.projection.name)return void o.w(`Drawing 3D landmark models for ${pe.projection.name} projection is not yet implemented`);const be=J.transform.getFreeCameraOptions().position,Ee=o.ab.vec3.scale([],[be.x,be.y,be.z],J.transform.worldSize),qe=o.ab.vec3.negate([],Ee),Le=o.ab.mat4.identity([]),Ye=o.dj(pe.center.lat,pe.zoom),Xe=o.ab.mat4.fromScaling([],[1,1,1/Ye]);o.ab.mat4.translate(Le,Le,qe);const Re=he.paint.get("model-opacity").constantOr(1),He=new zt(ge.gl.LEQUAL,zt.ReadWrite,J.depthRangeFor3D),it=new zt(ge.gl.LEQUAL,zt.ReadOnly,J.depthRangeFor3D),De=new o.cd([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Je="shadow"===J.renderPass,We=Je&&de?de.getCurrentCascadeFrustum():pe.getFrustum(pe.scaleZoom(pe.worldSize)),ut=he.paint.get("model-front-cutoff"),et=ut[2]<1,Ke=To(J,he.paint.get("model-cutoff-fade-range")),rt=he.getLayerRenderingStats();(function(ct,_t,Tt,jt){const Lt=ct.terrain?ct.terrain.exaggeration():0,kt=ct.transform.zoom;for(const Zt of jt){const di=_t.getTile(Zt).getBucket(Tt);di&&(ct.conflationActive&&di.updateReplacement(Zt,ct.replacementSource),di.evaluateScale(ct,Tt),ct.terrain&&Lt>0&&di.elevationUpdate(ct.terrain,Lt,Zt,Tt.source),di.needsReEvaluation(ct,kt,Tt)&&di.evaluate(Tt))}})(J,re,he,ce),function(){let ct,_t,Tt;et?(ct=ce.length-1,_t=-1,Tt=-1):(ct=0,_t=ce.length,Tt=1);const jt=new Float64Array(16),Lt=o.ab.vec3.create(),kt=new o.P(0,0);for(let Zt=ct;Zt!==_t;Zt+=Tt){const di=ce[Zt],Ni=re.getTile(di).getBucket(he);if(!Ni||!Ni.uploaded)continue;let hn=!1;de&&(hn=0===de.getMaxCascadeForTile(di.toUnwrapped()));const nn=pe.calculatePosMatrix(di.toUnwrapped(),pe.worldSize),Kt=Ni.modelTraits;!Je&&et&&(o.ab.mat4.invert(jt,nn),o.ab.vec3.transformMat4(Lt,Ee,jt),kt.x=Lt[0],kt.y=Lt[1]);const Ei=[];for(const Pt of Ni.getNodesInfo()){if(Pt.hiddenByReplacement||!Pt.node.meshes)continue;const pi=Pt.node;let Di=0;J.terrain&&pi.elevation&&(Di=pi.elevation*J.terrain.exaggeration());const ki=(()=>{const bi=Pt.aabb;return De.min=[...bi.min],De.max=[...bi.max],De.min[2]+=Di,De.max[2]+=Di,o.ab.vec3.transformMat4(De.min,De.min,nn),o.ab.vec3.transformMat4(De.max,De.max,nn),De})(),un=Pt.evaluatedScale;if(un[0]<=1&&un[1]<=1&&un[2]<=1&&0===ki.intersects(We))continue;if(!Je&&et){const bi=.16666666666666666;Pt.cameraCollisionOpacity=Ee[0]>ki.min[0]&&Ee[0]<ki.max[0]&&Ee[1]>ki.min[1]&&Ee[1]<ki.max[1]&&Ee[2]*Ye<ki.max[2]&&pi.footprint&&o.bA(kt,pi.footprint)?Math.max(Pt.cameraCollisionOpacity-bi,0):Math.min(1,Pt.cameraCollisionOpacity+bi)}const jn=[...nn],An=pi.anchor?pi.anchor[0]:0,Mn=pi.anchor?pi.anchor[1]:0;o.ab.mat4.translate(jn,jn,[An*(un[0]-1),Mn*(un[1]-1),Di]),o.ab.vec3.exactEquals(un,o.dm)||o.ab.mat4.scale(jn,jn,un);const Qr=o.ab.mat4.multiply([],jn,pi.matrix),mr=o.ab.mat4.multiply([],pe.expandedFarZProjMatrix,Qr),dn=o.ab.mat4.multiply([],pe.expandedFarZProjMatrix,jn),ji=o.ab.vec4.transformMat4([],[An,Mn,Di,1],mr)[2];pi.hidden=!1;let vi=Re;Je||(et&&(vi*=Pt.cameraCollisionOpacity,vi*=su(jn,pe,Pt.aabb,ut)),vi*=Oo(Ke,ji)),0!==vi?Ei.push({nodeInfo:Pt,depth:ji,opacity:vi,wvpForNode:mr,wvpForTile:dn,nodeModelMatrix:Qr,tileModelMatrix:jn}):pi.hidden=!0}Je||Ei.sort((Pt,pi)=>!et||1===Pt.opacity&&1===pi.opacity?Pt.depth<pi.depth?-1:1:1===Pt.opacity?-1:1===pi.opacity?1:Pt.depth>pi.depth?-1:1);for(const Pt of Ei){const pi=Pt.nodeInfo,Di=pi.node;let ki=o.ab.mat4.multiply([],Xe,Pt.tileModelMatrix);o.ab.mat4.multiply(ki,Le,ki);const un=o.ab.mat4.invert([],ki);o.ab.mat4.transpose(un,un),o.ab.mat4.scale(un,un,Xc),ki=o.ab.mat4.multiply(ki,ki,Di.matrix);const jn="light-beam"===J.renderPass,An="none"===he.paint.get("model-color-use-theme").constantOr("default"),Mn=Kt&o.dp.HasMapboxMeshFeatures,Qr=Mn?0:pi.evaluatedRMEA[0][2];for(let mr=0;mr<Di.meshes.length;++mr){const dn=Di.meshes[mr],ji=mr===Di.lightMeshIndex;let vi=Pt.wvpForNode;if(ji){if(!jn&&!J.terrain&&J.shadowRenderer){J.currentLayer<J.firstLightBeamLayer&&(J.firstLightBeamLayer=J.currentLayer);continue}vi=Pt.wvpForTile}else if(jn)continue;const bi={defines:[]},wn=[];if(!Je&&de&&(de.useNormalOffset=!!dn.normalBuffer),ro(bi.defines,wn,dn,J,An?null:he.lut),Mn||bi.defines.push("DIFFUSE_SHADED"),hn&&bi.defines.push("SHADOWS_SINGLE_CASCADE"),rt&&(Je?rt.numRenderedVerticesInShadowPass+=dn.vertexArray.length:rt.numRenderedVerticesInTransparentPass+=dn.vertexArray.length),Je){ll(dn,Pt.nodeModelMatrix,J,he);continue}let kn=null;if(_e){const hs=Os(Pt.nodeModelMatrix,J.transform);if(kn=new Float32Array(hs),"globe"!==pe.projection.name){const Dr=dn.aabb.min,ts=dn.aabb.max,[wa,js]=_e.getOpacityForBounds(hs,Dr[0],Dr[1],ts[0],ts[1]);bi.overrideFog=wa>=me||js>=me}}const Xi=dn.material;let _r;Xi.occlusionTexture&&Xi.occlusionTexture.offsetScale&&(_r=Xi.occlusionTexture.offsetScale,bi.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const es=J.getOrCreateProgram("model",bi);!Je&&de&&de.setupShadowsFromMatrix(Pt.tileModelMatrix,es,de.useNormalOffset),J.uploadCommonUniforms(ge,es,null,kn);const Ur=Xi.pbrMetallicRoughness;Ur.metallicFactor=.9,Ur.roughnessFactor=.5;const Tr=Xl(new Float32Array(vi),new Float32Array(ki),new Float32Array(un),new Float32Array(Di.matrix),J,Pt.opacity,Ur.baseColorFactor.toRenderColor(null),Xi.emissiveFactor,Ur.metallicFactor,Ur.roughnessFactor,Xi,Qr,he,[0,0,0],_r);!ji&&(pi.hasTranslucentParts||Pt.opacity<1)&&es.draw(J,ge.gl.TRIANGLES,He,qt.disabled,li.disabled,Wt.backCCW,Tr,he.id,dn.vertexBuffer,dn.indexBuffer,dn.segments,he.paint,J.transform.zoom,void 0,wn),es.draw(J,ge.gl.TRIANGLES,ji?it:He,qt.disabled,ji||Pt.opacity<1||pi.hasTranslucentParts?li.alphaBlended:li.unblended,Wt.backCCW,Tr,he.id,dn.vertexBuffer,dn.indexBuffer,dn.segments,he.paint,J.transform.zoom,void 0,wn)}}}}()}(l,t,n,c),void D();if("model"!==L.type)return;const k=L.getModels(),N=[],V=l.transform.getFreeCameraOptions().position,j=o.ab.vec3.scale([],[V.x,V.y,V.z],l.transform.worldSize);o.ab.vec3.negate(j,j);const Y=[],Z=[];let Q=0;for(const J of k){const re=n.paint.get("model-rotation").constantOr(null),he=n.paint.get("model-scale").constantOr(null),ce=n.paint.get("model-translation").constantOr(null);J.computeModelMatrix(l,re,he,ce,!0,!0,!1);const ge=o.ab.mat4.identity([]),pe=o.dj(J.position.lat,l.transform.zoom),_e=o.ab.mat4.fromScaling([],[1,1,1/pe]);o.ab.mat4.translate(ge,ge,j),N.push({zScaleMatrix:_e,negCameraPosMatrix:ge});for(const de of J.nodes)$c(l.transform,de,J.matrix,l.transform.expandedFarZProjMatrix,Q,Y,Z);Q++}if(Y.sort((J,re)=>re.depth-J.depth),"shadow"!==l.renderPass){if(1===p)for(const J of Z)Xr(J,l,n,N[J.modelIndex],qt.disabled,l.colorModeForRenderPass());else{for(const J of Z)Xr(J,l,n,N[J.modelIndex],qt.disabled,li.disabled);for(const J of Z)Xr(J,l,n,N[J.modelIndex],l.stencilModeFor3D(),l.colorModeForRenderPass());l.resetStencilClippingMasks()}for(const J of Y)Xr(J,l,n,N[J.modelIndex],qt.disabled,l.colorModeForRenderPass());D()}else{for(const J of Z)ll(J.mesh,J.nodeModelMatrix,l,n);for(const J of Y)ll(J.mesh,J.nodeModelMatrix,l,n);D()}}},ul={line:function(l,t,n){if(l.hasElevatedBuckets=!1,l.hasNonElevatedBuckets=!1,void 0!==l._unevaluatedLayout.getValue("line-elevation-reference")||void 0!==l._unevaluatedLayout.getValue("line-z-offset")){if(t){const c=t.getVisibleCoordinates();for(const p of c){const y=t.getTile(p).getBucket(l);if(y&&(y.hasZOffset?l.hasElevatedBuckets=!0:l.hasNonElevatedBuckets=!0,l.hasElevatedBuckets&&l.hasNonElevatedBuckets))break}}}else l.hasNonElevatedBuckets=!0},model:function(l,t,n){const c=t.getSource();if(!c.loaded())return;if("vector"===c.type||"geojson"===c.type)return void(n.modelManager&&n.modelManager.upload(n,"vector"===c.type?l.scope:""));if("batched-model"===c.type||"model"!==c.type)return;const p=c.getModels();for(const y of p)y.upload(n.context)},raster:function(l,t,n){const c=t.getSource();if(!(c instanceof zn&&c.loaded()))return;const p=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!p)return;const y=l.paint.get("raster-array-band")||c.getInitialBand(p);if(null==y)return;const b=t.getIds().map(E=>t.getTileByID(E));for(const E of b)E.updateNeeded(p,y)&&c.prepareTile(E,p,y)},"raster-particle":function(l,t,n){const c=t.getSource();if(!(c instanceof zn&&c.loaded()))return;const p=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!p)return;const y=l.paint.get("raster-particle-array-band")||c.getInitialBand(p);if(null==y)return;const b=t.getIds().map(E=>t.getTileByID(E));for(const E of b)E.updateNeeded(p,y)&&c.prepareTile(E,p,y)}};class uu{constructor(t,n,c,p,y){this.context=new eu(t,n),this.transform=c,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=y,this._timeStamp=o.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const b=["fill","line","symbol","circle","heatmap","fill-extrusion","raster","raster-particle","hillshade","model","background","sky"];for(const D of b)this._debugParams.enabledLayers[D]=!0;y.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},()=>{this.style.map.triggerRepaint()}),y.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),y.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),y.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),y.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),y.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const D of b)y.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],D);this.occlusionParams=new nc(y),this.setup(),this.numSublayers=ss.maxUnderzooming+ss.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new o.dv,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new Rs(this),this._wireframeDebugCache=new cl,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const E=new o.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new o.T(this.context,E,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=p}updateTerrain(t,n){const c=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(c||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new ca(this,t));const p=this._terrain;this.transform.elevation=c?p:null,p.update(t,this.transform,n),this.transform.elevation&&!p.enabled&&(this.transform.elevation=null)}_updateFog(t){const n=t.fog;if(!n||"globe"===this.transform.projection.name||n.getOpacity(this.transform.pitch)<1||n.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[c,p]=n.getFovAdjustedRange(this.transform._fov);if(c>p)return void(this.transform.fogCullDistSq=null);const y=c+.78*(p-c);this.transform.fogCullDistSq=y*y}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new ca(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,n){if(this.width=t*o.q.devicePixelRatio,this.height=n*o.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const c of this.style.order)this.style._mergedLayers[c].resize()}setup(){const t=this.context,n=new o.b4;n.emplaceBack(0,0),n.emplaceBack(o.ag,0),n.emplaceBack(0,o.ag),n.emplaceBack(o.ag,o.ag),this.tileExtentBuffer=t.createVertexBuffer(n,o.b6.members),this.tileExtentSegments=o.b7.simpleSegment(0,0,4,2);const c=new o.b4;c.emplaceBack(0,0),c.emplaceBack(o.ag,0),c.emplaceBack(0,o.ag),c.emplaceBack(o.ag,o.ag),this.debugBuffer=t.createVertexBuffer(c,o.b6.members),this.debugSegments=o.b7.simpleSegment(0,0,4,5);const p=new o.b4;p.emplaceBack(-1,-1),p.emplaceBack(1,-1),p.emplaceBack(-1,1),p.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(p,o.b6.members),this.viewportSegments=o.b7.simpleSegment(0,0,4,2);const y=new o.aT;y.emplaceBack(0,0,0,0),y.emplaceBack(o.ag,0,o.ag,0),y.emplaceBack(0,o.ag,0,o.ag),y.emplaceBack(o.ag,o.ag,o.ag,o.ag),this.mercatorBoundsBuffer=t.createVertexBuffer(y,o.b9.members),this.mercatorBoundsSegments=o.b7.simpleSegment(0,0,4,2);const b=new o.aU;b.emplaceBack(0,1,2),b.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(b);const E=new o.b5;for(const L of[0,1,3,2,0])E.emplaceBack(L);this.debugIndexBuffer=t.createIndexBuffer(E),this.emptyTexture=new o.T(t,new o.r({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=o.ab.mat4.create();const D=this.context.gl;this.stencilClearMode=new qt({func:D.ALWAYS,mask:0},0,255,D.ZERO,D.ZERO,D.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,zt.disabled,this.stencilClearMode,li.disabled,Wt.disabled,el(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,n,c){if(!n||this.currentStencilSource===n.id||!t.isTileClipped()||!c||0===c.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let E=!1;for(const D of c)if(void 0===this._tileClippingMaskIDs[D.key]){E=!0;break}if(!E)return}this.currentStencilSource=n.id;const p=this.context,y=p.gl;this.nextStencilID+c.length>256&&this.clearStencil(),p.setColorMode(li.disabled),p.setDepthMode(zt.disabled);const b=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const E of c){const D=n.getTile(E),L=this._tileClippingMaskIDs[E.key]=this.nextStencilID++,{tileBoundsBuffer:k,tileBoundsIndexBuffer:N,tileBoundsSegments:V}=this.getTileBoundsBuffers(D);b.draw(this,y.TRIANGLES,zt.disabled,new qt({func:y.ALWAYS,mask:0},L,255,y.KEEP,y.KEEP,y.REPLACE),li.disabled,Wt.disabled,el(E.projMatrix),"$clipping",k,N,V)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,n=this.context.gl;return new qt({func:n.NOTEQUAL,mask:255},t,255,n.KEEP,n.KEEP,n.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const n=this.context.gl;return new qt({func:n.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,n.KEEP,n.KEEP,n.REPLACE)}stencilConfigForOverlap(t){const n=this.context.gl,c=t.sort((b,E)=>E.overscaledZ-b.overscaledZ),p=c[c.length-1].overscaledZ,y=c[0].overscaledZ-p+1;if(y>1){this.currentStencilSource=void 0,this.nextStencilID+y>256&&this.clearStencil();const b={};for(let E=0;E<y;E++)b[E+p]=new qt({func:n.GEQUAL,mask:255},E+this.nextStencilID,255,n.KEEP,n.KEEP,n.REPLACE);return this.nextStencilID+=y,[b,c]}return[{[p]:qt.disabled},c]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new li([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new o.aj(.125,.125,.125,0),[!0,!0,!0,!0]):"opaque"===this.renderPass?li.unblended:li.alphaBlended}colorModeForDrapableLayerRenderPass(t){const n=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&"translucent"===this.renderPass?new li([n.ONE,n.ONE_MINUS_SRC_ALPHA,n.CONSTANT_ALPHA,n.ONE_MINUS_SRC_ALPHA],new o.aj(0,0,0,void 0===t?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,n,c,p=!1){if(this.depthOcclusion)return new zt(this.context.gl.GREATER,zt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!p)return zt.disabled;const y=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new zt(c||this.context.gl.LEQUAL,n,[y,y])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const t=this.context.gl,n=Math.ceil(this.width),c=Math.ceil(this.height),p=this.context.bindFramebuffer.get(),y=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===n&&this.depthFBO.height===c||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),0!==n&&0!==c&&(this.depthFBO=new xs(this.context,n,c,!1,"texture"),this.depthTexture=new o.T(this.context,{width:n,height:c,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(p),t.bindTexture(t.TEXTURE_2D,y),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,n,c,0,0,n,c,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(0===this._dt?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce((t,n)=>t+n/this._fpsHistory.length,0))}render(t,n){const c=o.q.now();this._dt=c-this._timeStamp,this._timeStamp=c,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=n;const p=this.style._mergedLayers,y=!(!this.terrain||!this.terrain.enabled),b=()=>this.style._getOrder(y).filter(Re=>{const He=p[Re];return!(He.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[He.type]});let E=b(),D=!1,L=!1;for(const Re of E){const He=p[Re];"circle"===He.type&&(D=!0),"symbol"===He.type&&(He.hasInitialOcclusionOpacityProperties?L=!0:D=!0)}let k=E.map(Re=>p[Re]);const N=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(o.q.now()),this.imageManager.beginFrame();let V=0,j=!1;for(const Re in N){const He=N[Re];He.used&&(He.prepare(this.context),He.getSource().usedInConflation&&++V)}let Y=!1;for(const Re of k)Re.isHidden(this.transform.zoom)||("clip"===Re.type&&(Y=!0),this.prepareLayer(Re));const Z={},Q={},J={},re={},he={};for(const Re in N){const He=N[Re];Z[Re]=He.getVisibleCoordinates(),Q[Re]=Z[Re].slice().reverse(),J[Re]=He.getVisibleCoordinates(!0).reverse(),re[Re]=He.getShadowCasterCoordinates(),he[Re]=He.sortCoordinatesByDistance(Z[Re])}const ce=Re=>{const He=this.style.getLayerSourceCache(Re);return He&&He.used?He.getSource():null};if(V||Y||this._clippingActiveLastFrame){const Re=[],He=[];let it=0;for(const De of k)this.isSourceForClippingOrConflation(De,ce(De))&&(Re.push(De),He.push(it)),it++;if(Re&&(Y||Re.length>1)||this._clippingActiveLastFrame){Y=!1;const De=[];for(let Je=0;Je<Re.length;Je++){const We=Re[Je],ut=He[Je],et=this.style.getLayerSourceCache(We);if(!et||!et.used||!et.getSource().usedInConflation&&"clip"!==We.type)continue;let Ke=o.dx,rt=o.by.None;const ct=[];let _t=!0;if("clip"===We.type){Ke=ut;for(const Tt of We.layout.get("clip-layer-types"))rt|="model"===Tt?o.by.Model:"symbol"===Tt?o.by.Symbol:o.by.FillExtrusion;for(const Tt of We.layout.get("clip-layer-scope"))ct.push(Tt);We.isHidden(this.transform.zoom)?_t=!1:Y=!0}_t&&De.push({layer:We.fqid,cache:et,order:Ke,clipMask:rt,clipScope:ct})}this.replacementSource.setSources(De),j=!0}}this._clippingActiveLastFrame=Y,j||this.replacementSource.clear(),this.conflationActive=j,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let Re=0;Re<k.length;Re++){const He=k[Re],it=He.cutoffRange();if(this.longestCutoffRange=Math.max(it,this.longestCutoffRange),it>0){const De=ce(He);De&&(this.minCutoffZoom=Math.max(De.minzoom,this.minCutoffZoom)),He.minzoom&&(this.minCutoffZoom=Math.max(He.minzoom,this.minCutoffZoom))}He.is3D()&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=Re),this._lastOcclusionLayer=Re)}const ge=this.style&&this.style.fog;ge?(this._fogVisible=0!==ge.getOpacity(this.transform.pitch),this._fogVisible&&"globe"!==this.transform.projection.name&&(this._fogVisible=ge.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(J),this.opaquePassCutoff=0,E=b(),k=E.map(Re=>p[Re]));const pe=this._shadowRenderer;if(pe){pe.updateShadowParameters(this.transform,this.style.directionalLight);for(const Re in N)for(const He of Z[Re]){let it={min:0,max:0};this.terrain&&(it=this.terrain.getMinMaxForTile(He)||it),pe.addShadowReceiver(He.toUnwrapped(),it.min,it.max)}}"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new o.dw(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new ru(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const _e=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),de=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(_e&&!this._snow&&(this._snow=new hu(this)),!_e&&this._snow&&(this._snow.destroy(),delete this._snow),de&&!this._rain&&(this._rain=new ao(this)),!de&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),!ka.has(this.context.gl))return;this.renderPass="offscreen";for(const Re of k){const He=t.getLayerSourceCache(Re);if(!Re.hasOffscreenPass()||Re.isHidden(this.transform.zoom))continue;const it=He?Q[He.id]:void 0;("custom"===Re.type||"raster"===Re.type||"raster-particle"===Re.type||Re.isSky()||it&&it.length)&&this.renderLayer(this,He,Re,it)}this.depthRangeFor3D=[0,1-(k.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,re)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const be="globe"===this.transform.projection.name||this.transform.isHorizonVisible(),Ee=(()=>{if(n.showOverdrawInspector)return o.aj.black;const Re=this.style.fog;if(Re&&this.transform.projection.supportsFog){const He=this.style.getLut(Re.scope);if(!be){const it="none"===Re.properties.get("color-use-theme"),De=Re.properties.get("color").toRenderColor(it?null:He).toArray01();return new o.aj(...De)}if(be){const it="none"===Re.properties.get("space-color-use-theme"),De=Re.properties.get("space-color").toRenderColor(it?null:He).toArray01();return new o.aj(...De)}}return o.aj.transparent})();if(this.context.clear({color:Ee,depth:1}),this.clearStencil(),this._showOverdrawInspector=n.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&be&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=E.length-1;this.currentLayer>=0;this.currentLayer--){const Re=k[this.currentLayer],He=t.getLayerSourceCache(Re);if(Re.isSky())continue;const it=He?(Re.is3D()?he:Q)[He.id]:void 0;this._renderTileClippingMasks(Re,He,it),this.renderLayer(this,He,Re,it)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&be&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||o.ae(this.transform.zoom)>0)&&("globe"===this.transform.projection.name||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<E.length;this.currentLayer++){const Re=k[this.currentLayer],He=t.getLayerSourceCache(Re);Re.isSky()&&this.renderLayer(this,He,Re,He?Q[He.id]:void 0)}function qe(Re,He){let it;return He&&(it=("symbol"===Re.type?J:Re.is3D()?he:Q)[He.id]),it}if(this.renderPass="translucent","globe"===this.transform.projection.name){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<E.length;){const Re=k[this.currentLayer];if("raster"===Re.type||"raster-particle"===Re.type){const He=t.getLayerSourceCache(Re);this.renderLayer(this,He,Re,qe(Re,He))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let Le=0;pe&&(Le=pe.getShadowCastingLayerCount());let Ye=!1,Xe=-1;for(let Re=0;Re<E.length;++Re){const He=k[Re];He.isHidden(this.transform.zoom)||He.is3D()&&(Xe=Re)}for(L&&-1===Xe&&(D=!0);this.currentLayer<E.length;){const Re=k[this.currentLayer],He=t.getLayerSourceCache(Re);if(Re.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(Re)){if(Re.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(D&&!Ye&&this.terrain&&!this.transform.isOrthographic&&(Ye=!0,this.blitDepth()),L&&-1!==Xe&&this.currentLayer===Xe+1&&!this.transform.isOrthographic&&this.blitDepth(),Re.is3D()||this.terrain||this._renderTileClippingMasks(Re,He,He?Z[He.id]:void 0),this.renderLayer(this,He,Re,qe(Re,He)),!this.terrain&&pe&&Le>0&&Re.hasShadowPass()&&0==--Le&&(pe.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer)){const it=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=it;this.currentLayer++){const De=k[this.currentLayer];if(!De.hasLightBeamPass())continue;const Je=t.getLayerSourceCache(De);this.renderLayer(this,Je,De,Je?Q[Je.id]:void 0)}this.currentLayer=it,this.renderPass="translucent"}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const it=this.currentLayer;this.depthOcclusion=!0;for(const De of this.layersWithOcclusionOpacity){this.currentLayer=De;const Je=k[this.currentLayer],We=t.getLayerSourceCache(Je),ut=We?Q[We.id]:void 0;Je.is3D()||this.terrain||this._renderTileClippingMasks(Je,We,We?Z[We.id]:void 0),this.renderLayer(this,We,Je,ut)}this.depthOcclusion=!1,this.currentLayer=it,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let Re=null;k.forEach(He=>{const it=t.getLayerSourceCache(He);it&&!He.isHidden(this.transform.zoom)&&it.getVisibleCoordinates().length&&(!Re||Re.getSource().maxzoom<it.getSource().maxzoom)&&(Re=it)}),Re&&this.options.showTileBoundaries&&sc.debug(this,Re,Re.getVisibleCoordinates(),o.aj.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&sc.debug(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new o.aj(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&function(Re){const He=Re.transform.padding;ec(Re,Re.transform.height-(He.top||0),3,Cr),ec(Re,He.bottom||0,3,Ud),iu(Re,He.left||0,3,jd),iu(Re,Re.transform.width-(He.right||0),3,nd);const it=Re.transform.centerPoint;var De,Je,We,ut;ga(De=Re,(Je=it.x)-1,(We=Re.transform.height-it.y)-10,2,20,ut=Wc),ga(De,Je-10,We-1,20,2,ut)}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),j||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);const{unsupportedLayers:n}=this.transform.projection,c=!n||!n.includes(t.type);if(ul[t.type]&&(c||this.terrain&&"custom"===t.type)){const p=this.style.getLayerSourceCache(t);ul[t.type](t,p,this)}this.gpuTimingEnd()}renderLayer(t,n,c,p){c.isHidden(this.transform.zoom)||("background"===c.type||"sky"===c.type||"custom"===c.type||"model"===c.type||"raster"===c.type||"raster-particle"===c.type||p&&p.length)&&(this.id=c.id,this.gpuTimingStart(c),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(c.type)&&(!t.terrain||"custom"!==c.type)||"clip"===c.type||sc[c.type](t,n,c,p,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const n=this.context.extTimerQuery,c=this.context.gl;let p=this.gpuTimers[t.id];p||(p=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:c.createQuery()}),p.calls++,c.beginQuery(n.TIME_ELAPSED_EXT,p.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,n=this.context.gl,c=n.createQuery();this.deferredRenderGpuTimeQueries.push(c),n.beginQuery(t.TIME_ELAPSED_EXT,c)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const n={};for(const c in t){const p=t[c],y=this.context.extTimerQuery,b=y.getQueryParameter(p.query,this.context.gl.QUERY_RESULT)/1e6;y.deleteQueryEXT(p.query),n[c]=b}return n}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const n=this.context.gl;let c=0;for(const p of t)c+=n.getQueryParameter(p,n.QUERY_RESULT)/1e6,n.deleteQuery(p);return c}translatePosMatrix(t,n,c,p,y){if(!c[0]&&!c[1])return t;const b=y?"map"===p?this.transform.angle:0:"viewport"===p?-this.transform.angle:0;if(b){const L=Math.sin(b),k=Math.cos(b);c=[c[0]*k-c[1]*L,c[0]*L+c[1]*k]}const E=[y?c[0]:o.ar(n,c[0],this.transform.zoom),y?c[1]:o.ar(n,c[1],this.transform.zoom),0],D=new Float32Array(16);return o.ab.mat4.translate(D,t,E),D}saveTileTexture(t){const n=t.size[0],c=this._tileTextures[n];c?c.push(t):this._tileTextures[n]=[t]}getTileTexture(t){const n=this._tileTextures[t];return n&&n.length>0?n.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return null!=this.context.extTextureFloatLinear}currentGlobalDefines(t,n,c){const p=void 0===c?this.terrain&&this.terrain.renderingToTexture:c,y=[];return this.style&&this.style.enable3dLights()&&("globeRaster"===t||"terrainRaster"===t?(y.push("LIGHTING_3D_MODE"),y.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):p||y.push("LIGHTING_3D_MODE")),"shadow"===this.renderPass&&(this._shadowMapDebug||y.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(y.push("TERRAIN"),this.linearFloatFilteringSupported()&&y.push("TERRAIN_DEM_FLOAT_FORMAT")),"globe"===this.transform.projection.name&&y.push("GLOBE"),!this._fogVisible||p||void 0!==n&&!n||y.push("FOG","FOG_DITHERING"),p&&y.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&y.push("OVERDRAW_INSPECTOR"),y}getOrCreateProgram(t,n){this.cache=this.cache||{};const c=n&&n.defines||[],p=n&&n.config,y=this.currentGlobalDefines(t,n&&n.overrideFog,n&&n.overrideRtt).concat(c),b=Ku.cacheKey(Ya[t],t,y,p);return this.cache[b]||(this.cache[b]=new Ku(this.context,t,Ya[t],p,Yl[t],y)),this.cache[b]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new o.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,n){if(this.style.enable3dLights()){const c=this.style.directionalLight,p=this.style.ambientLight;if(c&&p){const y=((b,E,D)=>{const L=b.properties.get("direction"),k="none"===b.properties.get("color-use-theme"),N=b.properties.get("color").toRenderColor(k?null:D.getLut(b.scope)).toArray01(),V=b.properties.get("intensity"),j="none"===E.properties.get("color-use-theme"),Y=E.properties.get("color").toRenderColor(j?null:D.getLut(E.scope)).toArray01(),Z=E.properties.get("intensity"),Q=[L.x,L.y,L.z],J=o.cM(Y,Z),re=o.cM(N,V);return{u_lighting_ambient_color:J,u_lighting_directional_dir:Q,u_lighting_directional_color:re,u_ground_radiance:$l(Q,re,J)}})(c,p,this.style);n.setLightsUniformValues(t,y)}}}uploadCommonUniforms(t,n,c,p,y){if(this.uploadCommonLightUniforms(t,n),this.terrain&&this.terrain.renderingToTexture)return;const b=this.style.fog;if(b){const E=b.getOpacity(this.transform.pitch),D=((L,k,N,V,j,Y,Z,Q,J,re,he,ce)=>{const ge=L.transform,pe="none"===k.properties.get("color-use-theme"),_e=k.properties.get("color").toRenderColor(pe?null:L.style.getLut(k.scope)).toArray01();_e[3]=V;const de=L.frameCounter/1e3%1,[be,Ee]=k.properties.get("vertical-range");return{u_fog_matrix:N?ge.calculateFogTileMatrix(N):ce||L.identityMat,u_fog_range:k.getFovAdjustedRange(ge._fov),u_fog_color:_e,u_fog_horizon_blend:k.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(be,Ee),Ee],u_fog_temporal_offset:de,u_frustum_tl:j,u_frustum_tr:Y,u_frustum_br:Z,u_frustum_bl:Q,u_globe_pos:J,u_globe_radius:re,u_viewport:he,u_globe_transition:o.ae(ge.zoom),u_is_globe:+("globe"===ge.projection.name)}})(this,b,c,E,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*o.q.devicePixelRatio,this.transform.height*o.q.devicePixelRatio],p);n.setFogUniformValues(t,D)}y&&n.setCutoffUniformValues(t,y.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,n=t.createTexture();return t.bindTexture(t.TEXTURE_2D,n),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),n}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&0!==t.getOpacity(this.transform.pitch)}getBackgroundTiles(){const t=this._backgroundTiles,n=this._backgroundTiles={},c=this.transform.coveringTiles({tileSize:512});for(const p of c)n[p.key]=t[p.key]||new rs(p,512,this.transform.tileZoom,this);return n}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,n){return!(!t.is3D()||"clip"!==t.type&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||"building"!==t.sourceLayer)&&(!n||"batched-model"!==n.type)))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if("globe"===this.transform.projection.name)return!0;let n=this._cachedTileFogOpacities[t.key];return n||(this._cachedTileFogOpacities[t.key]=n=this.style.fog.getOpacityForTile(t)),n[0]>=me||n[1]>=me}setupDepthForOcclusion(t,n,c){const p=this.context,y=p.gl,b=!!c;var E;c||(c={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),p.activeTexture.set(y.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(y.NEAREST,y.CLAMP_TO_EDGE),c.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],c.u_depth_range_unpack=[2/((E=this.depthRangeFor3D)[1]-E[0]),-1-2*E[0]/(E[1]-E[0])],c.u_occluder_half_size=.5*this.occlusionParams.occluderSize,c.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(y.NEAREST,y.CLAMP_TO_EDGE),p.activeTexture.set(y.TEXTURE0),b||n.setTerrainUniformValues(p,c)}}function Jc(l,t){let n=!1,c=null;const p=()=>{c=null,n&&(l(),c=setTimeout(p,t),n=!1)};return()=>(n=!0,c||p(),c)}class du{constructor(t){this._hashName=t&&encodeURIComponent(t),o.aP(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Jc(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const n=pu(t);if(this._hashName){const c=this._hashName;let p=!1;const y=location.hash.slice(1).split("&").map(b=>{const E=b.split("=")[0];return E===c?(p=!0,`${E}=${n}`):b}).filter(b=>b);return p||y.push(`${c}=${n}`),`#${y.join("&")}`}return`#${n}`}_getCurrentHash(){const t=location.hash.replace("#","");if(this._hashName){let n;return t.split("&").map(c=>c.split("=")).forEach(c=>{c[0]===this._hashName&&(n=c)}),(n&&n[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const n=this._getCurrentHash();if(n.length>=3&&!n.some(c=>isNaN(c))){const c=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(n[3]||0):t.getBearing();return t.jumpTo({center:[+n[2],+n[1]],zoom:+n[0],bearing:c,pitch:+(n[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function pu(l,t){const n=l.getCenter(),c=Math.round(100*l.getZoom())/100,p=Math.ceil((c*Math.LN2+Math.log(512/360/.5))/Math.LN10),y=Math.pow(10,p),b=Math.round(n.lng*y)/y,E=Math.round(n.lat*y)/y,D=l.getBearing(),L=l.getPitch();let k=t?`/${b}/${E}/${c}`:`${c}/${E}/${b}`;return(D||L)&&(k+="/"+Math.round(10*D)/10),L&&(k+=`/${Math.round(L)}`),k}const oc={linearity:.3,easing:o.dy(0,0,.3,1)},Qc=o.l({deceleration:2500,maxSpeed:1400},oc),rd=o.l({deceleration:20,maxSpeed:1400},oc),sd=o.l({deceleration:1e3,maxSpeed:360},oc),od=o.l({deceleration:1e3,maxSpeed:90},oc);class ad{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:o.q.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,n=o.q.now();for(;t.length>0&&n-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const n={zoom:0,bearing:0,pitch:0,pan:new o.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:y}of this._inertiaBuffer)n.zoom+=y.zoomDelta||0,n.bearing+=y.bearingDelta||0,n.pitch+=y.pitchDelta||0,y.panDelta&&n.pan._add(y.panDelta),y.around&&(n.around=y.around),y.pinchAround&&(n.pinchAround=y.pinchAround);const c=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,p={};if(n.pan.mag()){const y=Bo(n.pan.mag(),c,o.l({},Qc,t||{}));p.offset=n.pan.mult(y.amount/n.pan.mag()),p.center=this._map.transform.center,ac(p,y)}if(n.zoom){const y=Bo(n.zoom,c,rd);p.zoom=this._map.transform.zoom+y.amount,ac(p,y)}if(n.bearing){const y=Bo(n.bearing,c,sd);p.bearing=this._map.transform.bearing+o.aw(y.amount,-179,179),ac(p,y)}if(n.pitch){const y=Bo(n.pitch,c,od);p.pitch=this._map.transform.pitch+y.amount,ac(p,y)}if(p.zoom||p.bearing){const y=void 0===n.pinchAround?n.around:n.pinchAround;p.around=y?this._map.unproject(y):this._map.getCenter()}return this.clear(),p.noMoveStart=!0,p}}function ac(l,t){(!l.duration||l.duration<t.duration)&&(l.duration=t.duration,l.easing=t.easing)}function Bo(l,t,n){const{maxSpeed:c,linearity:p,deceleration:y}=n,b=o.aw(l*p/(t/1e3),-c,c),E=Math.abs(b)/(y*p);return{easing:n.easing,duration:1e3*E,amount:b*(E/2)}}class Pr extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c,p={}){const y=Ms(n.getCanvasContainer(),c),b=n.unproject(y);super(t,o.l({point:y,lngLat:b,originalEvent:c},p)),this._defaultPrevented=!1,this.target=n}}class lc extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n,c){const p="touchend"===t?c.changedTouches:c.touches,y=Gs(n.getCanvasContainer(),p),b=y.map(D=>n.unproject(D)),E=y.reduce((D,L,k,N)=>D.add(L.div(N.length)),new o.P(0,0));super(t,{points:y,point:E,lngLats:b,lngLat:n.unproject(E),originalEvent:c}),this._defaultPrevented=!1}}class fu extends o.z{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,n){super("wheel",{originalEvent:n}),this._defaultPrevented=!1}}class No{constructor(t,n){this._map=t,this._clickTolerance=n.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new fu(this._map,t))}mousedown(t,n){return this._mousedownPos=n,this._firePreventable(new Pr(t.type,this._map,t))}mouseup(t){this._map.fire(new Pr(t.type,this._map,t))}preclick(t){const n=o.l({},t);n.type="preclick",this._map.fire(new Pr(n.type,this._map,n))}click(t,n){this._mousedownPos&&this._mousedownPos.dist(n)>=this._clickTolerance||(this.preclick(t),this._map.fire(new Pr(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new Pr(t.type,this._map,t))}mouseover(t){this._map.fire(new Pr(t.type,this._map,t))}mouseout(t){this._map.fire(new Pr(t.type,this._map,t))}touchstart(t){return this._firePreventable(new lc(t.type,this._map,t))}touchmove(t){this._map.fire(new lc(t.type,this._map,t))}touchend(t){this._map.fire(new lc(t.type,this._map,t))}touchcancel(t){this._map.fire(new lc(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class qd{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new Pr(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Pr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new Pr(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class vn{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=n.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,n){this.isEnabled()&&t.shiftKey&&0===t.button&&(gi(),this._startPos=this._lastPos=n,this._active=!0)}mousemoveWindow(t,n){if(!this._active)return;const c=n,p=this._startPos,y=this._lastPos;if(!p||!y||y.equals(c)||!this._box&&c.dist(p)<this._clickTolerance)return;this._lastPos=c,this._box||(this._box=qi("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const b=Math.min(p.x,c.x),E=Math.max(p.x,c.x),D=Math.min(p.y,c.y),L=Math.max(p.y,c.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${b}px,${D}px)`,this._box.style.width=E-b+"px",this._box.style.height=L-D+"px")})}mouseupWindow(t,n){if(!this._active)return;const c=this._startPos,p=n;if(c&&0===t.button){if(this.reset(),Xt(),c.x!==p.x||c.y!==p.y)return this._map.fire(new o.z("boxzoomend",{originalEvent:t})),{cameraAnimation:y=>y.fitScreenCoordinates(c,p,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&27===t.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),$o(),delete this._startPos,delete this._lastPos}_fireEvent(t,n){return this._map.fire(new o.z(t,{originalEvent:n}))}}function eh(l,t){const n={};for(let c=0;c<l.length;c++)n[l[c].identifier]=t[c];return n}class mu{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,n,c){(this.centroid||c.length>this.numTouches)&&(this.aborted=!0),this.aborted||(0===this.startTime&&(this.startTime=t.timeStamp),c.length===this.numTouches&&(this.centroid=function(p){const y=new o.P(0,0);for(const b of p)y._add(b);return y.div(p.length)}(n),this.touches=eh(c,n)))}touchmove(t,n,c){if(this.aborted||!this.centroid)return;const p=eh(c,n);for(const y in this.touches){const b=p[y];(!b||b.dist(this.touches[y])>30)&&(this.aborted=!0)}}touchend(t,n,c){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),0===c.length){const p=!this.aborted&&this.centroid;if(this.reset(),p)return p}}}class _u{constructor(t){this.singleTap=new mu(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,n,c){this.singleTap.touchstart(t,n,c)}touchmove(t,n,c){this.singleTap.touchmove(t,n,c)}touchend(t,n,c){const p=this.singleTap.touchend(t,n,c);if(p){const y=t.timeStamp-this.lastTime<500,b=!this.lastTap||this.lastTap.dist(p)<30;if(y&&b||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=p,this.count===this.numTaps)return this.reset(),p}}}class cc{constructor(){this._zoomIn=new _u({numTouches:1,numTaps:2}),this._zoomOut=new _u({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,n,c){this._zoomIn.touchstart(t,n,c),this._zoomOut.touchstart(t,n,c)}touchmove(t,n,c){this._zoomIn.touchmove(t,n,c),this._zoomOut.touchmove(t,n,c)}touchend(t,n,c){const p=this._zoomIn.touchend(t,n,c),y=this._zoomOut.touchend(t,n,c);return p?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:b=>b.easeTo({duration:300,zoom:b.getZoom()+1,around:b.unproject(p)},{originalEvent:t})}):y?(this._active=!0,t.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:b=>b.easeTo({duration:300,zoom:b.getZoom()-1,around:b.unproject(y)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const th={0:1,2:2};class hc{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,n){return!1}_move(t,n){return{}}mousedown(t,n){if(this._lastPoint)return;const c=Yt(t);this._correctButton(t,c)&&(this._lastPoint=n,this._eventButton=c)}mousemoveWindow(t,n){const c=this._lastPoint;if(c)if(t.preventDefault(),null!=this._eventButton&&function(p,y){const b=th[y];return void 0===p.buttons||(p.buttons&b)!==b}(t,this._eventButton))this.reset();else if(this._moved||!(n.dist(c)<this._clickTolerance))return this._moved=!0,this._lastPoint=n,this._move(c,n)}mouseupWindow(t){this._lastPoint&&Yt(t)===this._eventButton&&(this._moved&&Xt(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ih extends hc{mousedown(t,n){super.mousedown(t,n),this._lastPoint&&(this._active=!0)}_correctButton(t,n){return 0===n&&!t.ctrlKey}_move(t,n){return{around:n,panDelta:n.sub(t)}}}class ls extends hc{_correctButton(t,n){return 0===n&&t.ctrlKey||2===n}_move(t,n){const c=.8*(n.x-t.x);if(c)return this._active=!0,{bearingDelta:c}}contextmenu(t){t.preventDefault()}}class dl extends hc{_correctButton(t,n){return 0===n&&t.ctrlKey||2===n}_move(t,n){const c=-.5*(n.y-t.y);if(c)return this._active=!0,{pitchDelta:c}}contextmenu(t){t.preventDefault()}}class bn{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=n.clickTolerance||1,this.reset(),o.aP(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new o.P(0,0)}touchstart(t,n,c){return this._calculateTransform(t,n,c)}touchmove(t,n,c){if(this._active&&!(c.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===c.length&&!o.dz())return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,n,c)}}touchend(t,n,c){this._calculateTransform(t,n,c),this._active&&c.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,n,c){c.length>0&&(this._active=!0);const p=eh(c,n),y=new o.P(0,0),b=new o.P(0,0);let E=0;for(const L in p){const k=p[L],N=this._touches[L];N&&(y._add(k),b._add(k.sub(N)),E++,p[L]=k)}if(this._touches=p,E<this._minTouches||!b.mag())return;const D=b.div(E);return this._sum._add(D),this._sum.mag()<this._clickTolerance?void 0:{around:y.div(E),panDelta:D}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=qi("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")},500)}}class Yr{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,n,c){return{}}touchstart(t,n,c){this._firstTwoTouches||c.length<2||(this._firstTwoTouches=[c[0].identifier,c[1].identifier],this._start([n[0],n[1]]))}touchmove(t,n,c){const p=this._firstTwoTouches;if(!p)return;t.preventDefault();const[y,b]=p,E=pl(c,n,y),D=pl(c,n,b);if(!E||!D)return;const L=this._aroundCenter?null:E.add(D).div(2);return this._move([E,D],L,t)}touchend(t,n,c){if(!this._firstTwoTouches)return;const[p,y]=this._firstTwoTouches,b=pl(c,n,p),E=pl(c,n,y);b&&E||(this._active&&Xt(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&"center"===t.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function pl(l,t,n){for(let c=0;c<l.length;c++)if(l[c].identifier===n)return t[c]}function uc(l,t){return Math.log(l/t)/Math.LN2}class ld extends Yr{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,n){const c=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(uc(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:uc(this._distance,c),pinchAround:n}}}function cd(l,t){return 180*l.angleWith(t)/Math.PI}class fl extends Yr{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,n){const c=this._vector;if(this._vector=t[0].sub(t[1]),c&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:cd(this._vector,c),pinchAround:n}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const n=25/(Math.PI*this._minDiameter)*360,c=this._startVector;if(!c)return!1;const p=cd(t,c);return Math.abs(p)<n}}function gu(l){return Math.abs(l.y)>Math.abs(l.x)}class Hd extends Yr{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,gu(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,n,c){const p=this._lastPoints;if(!p)return;const y=t[0].sub(p[0]),b=t[1].sub(p[1]);return this._map._cooperativeGestures&&!o.dz()&&c.touches.length<3||(this._valid=this.gestureBeginsVertically(y,b,c.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(y.y+b.y)/2*-.5})}gestureBeginsVertically(t,n,c){if(void 0!==this._valid)return this._valid;const p=t.mag()>=2,y=n.mag()>=2;if(!p&&!y)return;if(!p||!y)return null==this._firstMove&&(this._firstMove=c),c-this._firstMove<100&&void 0;const b=t.y>0==n.y>0;return gu(t)&&gu(n)&&b}}const yu={panStep:100,bearingStep:15,pitchStep:10};class xu{constructor(){const t=yu;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let n=0,c=0,p=0,y=0,b=0;switch(t.keyCode){case 61:case 107:case 171:case 187:n=1;break;case 189:case 109:case 173:n=-1;break;case 37:t.shiftKey?c=-1:(t.preventDefault(),y=-1);break;case 39:t.shiftKey?c=1:(t.preventDefault(),y=1);break;case 38:t.shiftKey?p=1:(t.preventDefault(),b=-1);break;case 40:t.shiftKey?p=-1:(t.preventDefault(),b=1);break;default:return}return this._rotationDisabled&&(c=0,p=0),{cameraAnimation:E=>{const D=E.getZoom();E.easeTo({duration:300,easeId:"keyboardHandler",easing:ya,zoom:n?Math.round(D)+n*(t.shiftKey?2:1):D,bearing:E.getBearing()+c*this._bearingStep,pitch:E.getPitch()+p*this._pitchStep,offset:[-y*this._panStep,-b*this._panStep],center:E.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function ya(l){return l*(2-l)}const Vo=4.000244140625,Ns=1/450;class bs{constructor(t,n){this._map=t,this._el=t.getCanvasContainer(),this._handler=n,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=Ns,o.aP(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&"center"===t.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||o.dz()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let n=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const c=o.q.now(),p=c-(this._lastWheelEventTime||0);this._lastWheelEventTime=c,0!==n&&n%Vo==0?this._type="wheel":0!==n&&Math.abs(n)<4?this._type="trackpad":p>400?(this._type=null,this._lastValue=n,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(p*n)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,n+=this._lastValue)),t.shiftKey&&n&&(n/=4),this._type&&(this._lastWheelEvent=t,this._delta-=n,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const n=Ms(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:n,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;"wheel"===this._type&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const n=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(0!==this._delta){const L="wheel"===this._type&&Math.abs(this._delta)>Vo?this._wheelZoomRate:this._defaultZoomRate;let k=2/(1+Math.exp(-Math.abs(this._delta*L)));this._delta<0&&0!==k&&(k=1/k);const N=n(),V=Math.pow(2,N),j="number"==typeof this._targetZoom?t.zoomScale(this._targetZoom):V;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(j*k))),"wheel"===this._type&&(this._startZoom=N,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const c="number"==typeof this._targetZoom?this._targetZoom:n(),p=this._startZoom,y=this._easing;let b,E=!1;if("wheel"===this._type&&p&&y){const L=Math.min((o.q.now()-this._lastWheelEventTime)/200,1),k=y(L);b=o.af(p,c,k),L<1?this._frameId||(this._frameId=!0):E=!0}else b=c,E=!0;this._active=!0,E&&(this._active=!1,this._finishTimeout=window.setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout},200));let D=b-n();return D*this._lastDelta<0&&(D=0),{noInertia:!0,needsRenderFrame:!E,zoomDelta:D,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let n=o.dA;if(this._prevEase){const c=this._prevEase,p=(o.q.now()-c.start)/c.duration,y=c.easing(p+.01)-c.easing(p),b=.27/Math.sqrt(y*y+1e-4)*.01,E=Math.sqrt(.0729-b*b);n=o.dy(b,E,.25,1)}return this._prevEase={start:o.q.now(),duration:t,easing:n},n}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=qi("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")},200)}}class Uo{constructor(t,n){this._clickZoom=t,this._tapZoom=n}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class xa{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,n){return t.preventDefault(),{cameraAnimation:c=>{c.easeTo({duration:300,zoom:c.getZoom()+(t.shiftKey?-1:1),around:c.unproject(n)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Vs{constructor(){this._tap=new _u({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,n,c){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?c.length>0&&(this._swipePoint=n[0],this._swipeTouch=c[0].identifier):this._tap.touchstart(t,n,c))}touchmove(t,n,c){if(this._tapTime){if(this._swipePoint){if(c[0].identifier!==this._swipeTouch)return;const p=n[0],y=p.y-this._swipePoint.y;return this._swipePoint=p,t.preventDefault(),this._active=!0,{zoomDelta:y/128}}}else this._tap.touchmove(t,n,c)}touchend(t,n,c){this._tapTime?this._swipePoint&&0===c.length&&this.reset():this._tap.touchend(t,n,c)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Wd{constructor(t,n,c){this._el=t,this._mousePan=n,this._touchPan=c}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class vu{constructor(t,n,c){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=n,this._mousePitch=c}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class hd{constructor(t,n,c,p){this._el=t,this._touchZoom=n,this._touchRotate=c,this._tapDragZoom=p,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const dc=l=>l.zoom||l.drag||l.pitch||l.rotate;class bu extends o.z{}class wr{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,n){const c=o.ab.vec3.sub([],n,t);this.radius=o.ab.vec3.length(c[2]<0?o.ab.vec3.div([],c,this.constants):[c[0],c[1],0])}projectRay(t){o.ab.vec3.div(t,t,this.constants),o.ab.vec3.normalize(t,t),o.ab.vec3.mul(t,t,this.constants);const n=o.ab.vec3.scale([],t,this.radius);if(n[2]>0){const c=o.ab.vec3.scale([],[0,0,1],o.ab.vec3.dot(n,[0,0,1])),p=o.ab.vec3.scale([],o.ab.vec3.normalize([],[n[0],n[1],0]),this.radius),y=o.ab.vec3.add([],n,o.ab.vec3.scale([],o.ab.vec3.sub([],o.ab.vec3.add([],p,c),n),2));n[0]=y[0],n[1]=y[1]}return n}}function ml(l){return l.panDelta&&l.panDelta.mag()||l.zoomDelta||l.bearingDelta||l.pitchDelta}class ud{constructor(t,n){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new ad(t),this._bearingSnap=n.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new wr,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(n),o.aP(["handleEvent","handleWindowEvent"],this);const c=this._el;this._listeners=[[c,"touchstart",{passive:!0}],[c,"touchmove",{passive:!1}],[c,"touchend",void 0],[c,"touchcancel",void 0],[c,"mousedown",void 0],[c,"mousemove",void 0],[c,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[c,"mouseover",void 0],[c,"mouseout",void 0],[c,"dblclick",void 0],[c,"click",void 0],[c,"keydown",{capture:!1}],[c,"keyup",void 0],[c,"wheel",{passive:!1}],[c,"contextmenu",void 0],[window,"blur",void 0]];for(const[p,y,b]of this._listeners){const E=p===document?this.handleWindowEvent:this.handleEvent;p.addEventListener(y,E,b)}}destroy(){for(const[t,n,c]of this._listeners){const p=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(n,p,c)}}_addDefaultHandlers(t){const n=this._map,c=n.getCanvasContainer();this._add("mapEvent",new No(n,t));const p=n.boxZoom=new vn(n,t);this._add("boxZoom",p);const y=new cc,b=new xa;n.doubleClickZoom=new Uo(b,y),this._add("tapZoom",y),this._add("clickZoom",b);const E=new Vs;this._add("tapDragZoom",E);const D=n.touchPitch=new Hd(n);this._add("touchPitch",D);const L=new ls(t),k=new dl(t);n.dragRotate=new vu(t,L,k),this._add("mouseRotate",L,["mousePitch"]),this._add("mousePitch",k,["mouseRotate"]);const N=new ih(t),V=new bn(n,t);n.dragPan=new Wd(c,N,V),this._add("mousePan",N),this._add("touchPan",V,["touchZoom","touchRotate"]);const j=new fl,Y=new ld;n.touchZoomRotate=new hd(c,Y,j,E),this._add("touchRotate",j,["touchPan","touchZoom"]),this._add("touchZoom",Y,["touchPan","touchRotate"]),this._add("blockableMapEvent",new qd(n));const Z=n.scrollZoom=new bs(n,this);this._add("scrollZoom",Z,["mousePan"]);const Q=n.keyboard=new xu;this._add("keyboard",Q);for(const J of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[J]&&n[J].enable(t[J])}_add(t,n,c){this._handlers.push({handlerName:t,handler:n,allowed:c}),this._handlersById[t]=n}stop(t){if(!this._updatingCamera){for(const{handler:n}of this._handlers)n.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!dc(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,n,c){for(const p in t)if(p!==c&&(!n||n.indexOf(p)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const n=[];for(const c of t)this._el.contains(c.target)&&n.push(c);return n}handleEvent(t,n){this._updatingCamera=!0;const c="renderFrame"===t.type,p=c?void 0:t,y={needsRenderFrame:!1},b={},E={},D=t.touches?this._getMapTouches(t.touches):void 0,L=D?Gs(this._el,D):c?void 0:Ms(this._el,t);for(const{handlerName:V,handler:j,allowed:Y}of this._handlers){if(!j.isEnabled())continue;let Z;this._blockedByActive(E,Y,V)?j.reset():j[n||t.type]&&(Z=j[n||t.type](t,L,D),this.mergeHandlerResult(y,b,Z,V,p),Z&&Z.needsRenderFrame&&this._triggerRenderFrame()),(Z||j.isActive())&&(E[V]=j)}const k={};for(const V in this._previousActiveHandlers)E[V]||(k[V]=p);this._previousActiveHandlers=E,(Object.keys(k).length||ml(y))&&(this._changes.push([y,b,k]),this._triggerRenderFrame()),(Object.keys(E).length||ml(y))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:N}=y;N&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],N(this._map))}mergeHandlerResult(t,n,c,p,y){if(!c)return;o.l(t,c);const b={handlerName:p,originalEvent:c.originalEvent||y};void 0!==c.zoomDelta&&(n.zoom=b),void 0!==c.panDelta&&(n.drag=b),void 0!==c.pitchDelta&&(n.pitch=b),void 0!==c.bearingDelta&&(n.rotate=b)}_applyChanges(){const t={},n={},c={};for(const[p,y,b]of this._changes)p.panDelta&&(t.panDelta=(t.panDelta||new o.P(0,0))._add(p.panDelta)),p.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+p.zoomDelta),p.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+p.bearingDelta),p.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+p.pitchDelta),void 0!==p.around&&(t.around=p.around),void 0!==p.aroundCoord&&(t.aroundCoord=p.aroundCoord),void 0!==p.pinchAround&&(t.pinchAround=p.pinchAround),p.noInertia&&(t.noInertia=p.noInertia),o.l(n,y),o.l(c,b);this._updateMapTransform(t,n,c),this._changes=[]}_updateMapTransform(t,n,c){const p=this._map,y=p.transform,b=re=>[re.x,re.y,re.z];if((()=>{const he=this._eventsInProgress.drag;return he&&!this._handlersById[he.handlerName].isActive()})()&&!ml(t)){const re=y.zoom;y.cameraElevationReference="sea",null!=this._originalZoom&&y._orthographicProjectionAtLowPitch&&"globe"!==y.projection.name&&0===y.pitch?(y.cameraElevationReference="ground",y.zoom=this._originalZoom):(y.recenterOnTerrain(),y.cameraElevationReference="ground"),re!==y.zoom&&this._map._update(!0)}if(y._isCameraConstrained&&p._stop(!0),!ml(t))return void this._fireEvents(n,c,!0);let{panDelta:E,zoomDelta:D,bearingDelta:L,pitchDelta:k,around:N,aroundCoord:V,pinchAround:j}=t;y._isCameraConstrained&&(D>0&&(D=0),y._isCameraConstrained=!1),void 0!==j&&(N=j),(D||(()=>n.drag&&!this._eventsInProgress.drag)())&&N&&(this._dragOrigin=b(y.pointCoordinate3D(N)),this._originalZoom=y.zoom,this._trackingEllipsoid.setup(y._camera.position,this._dragOrigin)),y.cameraElevationReference="sea",p._stop(!0),N=N||p.transform.centerPoint,L&&(y.bearing+=L),k&&(y.pitch+=k),y._updateCameraState();const Y=[0,0,0];if(E)if("mercator"===y.projection.name){const re=this._trackingEllipsoid.projectRay(y.screenPointToMercatorRay(N).dir),he=this._trackingEllipsoid.projectRay(y.screenPointToMercatorRay(N.sub(E)).dir);Y[0]=he[0]-re[0],Y[1]=he[1]-re[1]}else{const re=y.pointCoordinate(N);if("globe"===y.projection.name){E=E.rotate(-y.angle);const he=y._pixelsPerMercatorPixel/y.worldSize;Y[0]=-E.x*o.dB(o.aS(re.y))*he,Y[1]=-E.y*o.dB(y.center.lat)*he}else{const he=y.pointCoordinate(N.sub(E));re&&he&&(Y[0]=he.x-re.x,Y[1]=he.y-re.y)}}const Z=y.zoom,Q=[0,0,0];if(D){const re=b(V||y.pointCoordinate3D(N)),he={dir:o.ab.vec3.normalize([],o.ab.vec3.sub([],re,y._camera.position))};if(he.dir[2]<0){const ce=y.zoomDeltaToMovement(re,D);o.ab.vec3.scale(Q,he.dir,ce)}}const J=o.ab.vec3.add(Y,Y,Q);y._translateCameraConstrained(J),D&&Math.abs(y.zoom-Z)>1e-4&&y.recenterOnTerrain(),y.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(n,c,!0)}_fireEvents(t,n,c){const p=dc(this._eventsInProgress),y=dc(t),b={};for(const k in t){const{originalEvent:N}=t[k];this._eventsInProgress[k]||(b[`${k}start`]=N),this._eventsInProgress[k]=t[k]}!p&&y&&this._fireEvent("movestart",y.originalEvent);for(const k in b)this._fireEvent(k,b[k]);y&&this._fireEvent("move",y.originalEvent);for(const k in t){const{originalEvent:N}=t[k];this._fireEvent(k,N)}const E={};let D;for(const k in this._eventsInProgress){const{handlerName:N,originalEvent:V}=this._eventsInProgress[k];this._handlersById[N].isActive()||(delete this._eventsInProgress[k],D=n[N]||V,E[`${k}end`]=D)}for(const k in E)this._fireEvent(k,E[k]);const L=dc(this._eventsInProgress);if(c&&(p||y)&&!L){this._updatingCamera=!0;const k=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),N=V=>0!==V&&-this._bearingSnap<V&&V<this._bearingSnap;k?(N(k.bearing||this._map.getBearing())&&(k.bearing=0),this._map.easeTo(k,{originalEvent:D})):(this._map.fire(new o.z("moveend",{originalEvent:D})),N(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,n){this._map.fire(new o.z(t,n?{originalEvent:n}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(t=>{this._frameId=void 0,this.handleEvent(new bu("renderFrame",{timeStamp:t})),this._applyChanges()})}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}const dd="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class _l extends o.E{constructor(t,n){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=n.bearingSnap,this._respectPrefersReducedMotion=!1!==n.respectPrefersReducedMotion,o.aP(["_renderFrameCallback"],this)}getCenter(){return new o.bO(this.transform.center.lng,this.transform.center.lat)}setCenter(t,n){return this.jumpTo({center:t},n)}panBy(t,n,c){return t=o.P.convert(t).mult(-1),this.panTo(this.transform.center,o.l({offset:t},n),c)}panTo(t,n,c){return this.easeTo(o.l({center:t},n),c)}getZoom(){return this.transform.zoom}setZoom(t,n){return this.jumpTo({zoom:t},n),this}zoomTo(t,n,c){return this.easeTo(o.l({zoom:t},n),c)}zoomIn(t,n){return this.zoomTo(this.getZoom()+1,t,n),this}zoomOut(t,n){return this.zoomTo(this.getZoom()-1,t,n),this}getBearing(){return this.transform.bearing}setBearing(t,n){return this.jumpTo({bearing:t},n),this}getPadding(){return this.transform.padding}setPadding(t,n){return this.jumpTo({padding:t},n),this}rotateTo(t,n,c){return this.easeTo(o.l({bearing:t},n),c)}resetNorth(t,n){return this.rotateTo(0,o.l({duration:1e3},t),n),this}resetNorthPitch(t,n){return this.easeTo(o.l({bearing:0,pitch:0,duration:1e3},t),n),this}snapToNorth(t,n){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,n):this}getPitch(){return this.transform.pitch}setPitch(t,n){return this.jumpTo({pitch:t},n),this}cameraForBounds(t,n){t=o.az.convert(t);const c=n&&n.bearing||0,p=n&&n.pitch||0,y=t.getNorthWest(),b=t.getSouthEast();return this._cameraForBounds(this.transform,y,b,c,p,n)}_extendPadding(t){const n={top:0,right:0,bottom:0,left:0};return null==t?o.l({},n,this.transform.padding):"number"==typeof t?{top:t,bottom:t,right:t,left:t}:o.l({},n,t)}_extendCameraOptions(t){return(t=o.l({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,n){const c=n.max[0]-n.min[0],p=n.max[1]-n.min[1];return c/p>t.aspect?c/(2*Math.tan(.5*t.fovX)*t.aspect):p/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,n,c,p,y,b){const E=t.clone(),D=this._extendCameraOptions(b);E.bearing=p,E.pitch=y;const L=o.bO.convert(n),k=o.bO.convert(c),N=.5*(L.lat+k.lat),V=.5*(L.lng+k.lng),j=o.dC(N,V),Y=o.ab.vec3.normalize([],j),Z=o.ab.vec3.normalize([],o.ab.vec3.cross([],Y,[0,1,0])),Q=o.ab.vec3.cross([],Z,Y),J=[Z[0],Z[1],Z[2],0,Q[0],Q[1],Q[2],0,Y[0],Y[1],Y[2],0,0,0,0,1],re=[j,o.dC(L.lat,L.lng),o.dC(k.lat,L.lng),o.dC(k.lat,k.lng),o.dC(L.lat,k.lng),o.dC(N,L.lng),o.dC(N,k.lng),o.dC(L.lat,V),o.dC(k.lat,V)];let he=o.cd.fromPoints(re.map(We=>[o.ab.vec3.dot(Z,We),o.ab.vec3.dot(Q,We),o.ab.vec3.dot(Y,We)]));const ce=o.ab.vec3.transformMat4([],he.center,J);0===o.ab.vec3.squaredLength(ce)&&o.ab.vec3.set(ce,0,0,1),o.ab.vec3.normalize(ce,ce),o.ab.vec3.scale(ce,ce,o.ax),E.center=o.dD(ce);const ge=E.getWorldToCameraMatrix(),pe=o.ab.mat4.invert(new Float64Array(16),ge);he=o.cd.applyTransform(he,o.ab.mat4.multiply([],ge,J));const _e=this._extendAABB(he,E,D,p);if(!_e)return void o.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");he=_e,o.ab.vec3.transformMat4(ce,ce,ge);const de=.5*(he.max[2]-he.min[2]),be=this._minimumAABBFrustumDistance(E,he),Ee=o.ab.vec3.scale([],[0,0,1],de),qe=o.ab.vec3.add(Ee,ce,Ee),Le=be+(0===E.pitch?0:o.ab.vec3.distance(ce,qe)),Ye=E.globeCenterInViewSpace,Xe=o.ab.vec3.sub([],ce,[Ye[0],Ye[1],Ye[2]]);o.ab.vec3.normalize(Xe,Xe),o.ab.vec3.scale(Xe,Xe,Le);const Re=o.ab.vec3.add([],ce,Xe);o.ab.vec3.transformMat4(Re,Re,pe);const He=o.ds/o.ax,it=o.ab.vec3.length(Re),De=o.bH(Math.max(it*He-o.ds,Number.EPSILON),0),Je=Math.min(E.zoomFromMercatorZAdjusted(De),D.maxZoom);return Je>.5*(o.c6+o.bY)?(E.setProjection({name:"mercator"}),E.zoom=Je,this._cameraForBounds(E,n,c,p,y,b)):{center:E.center,zoom:Je,bearing:p,pitch:y}}_extendAABB(t,n,c,p){const y=.5*((c.padding.left||0)+(c.padding.right||0)),b=.5*((c.padding.top||0)+(c.padding.bottom||0)),E=b,D=y,L=y,k=b,N=n.width-(D+L),V=n.height-(E+k),j=o.ab.vec3.sub([],t.max,t.min),Y=Math.min(N/j[0],V/j[1]),Z=Math.min(n.scaleZoom(n.scale*Y),c.maxZoom);if(isNaN(Z))return null;const Q=n.scale/n.zoomScale(Z),J=new o.cd([t.min[0]-D*Q,t.min[1]-k*Q,t.min[2]],[t.max[0]+L*Q,t.max[1]+E*Q,t.max[2]]),re=("number"==typeof c.offset.x&&"number"==typeof c.offset.y?new o.P(c.offset.x,c.offset.y):o.P.convert(c.offset)).rotate(-o.ai(p));return J.center[0]-=re.x*Q,J.center[1]+=re.y*Q,J}queryTerrainElevation(t,n){const c=this.transform.elevation;return c?(n=o.l({},{exaggerated:!0},n),c.getAtPoint(o.aa.fromLngLat(t),null,n.exaggerated)):null}_cameraForBounds(t,n,c,p,y,b){if("globe"===t.projection.name)return this._cameraForBoundsOnGlobe(t,n,c,p,y,b);const E=t.clone(),D=this._extendCameraOptions(b);E.bearing=p,E.pitch=y;const L=o.bO.convert(n),k=o.bO.convert(c),N=new o.bO(L.lng,k.lat),V=new o.bO(k.lng,L.lat),j=E.project(L),Y=E.project(k),Z=this.queryTerrainElevation(L),Q=this.queryTerrainElevation(k),J=this.queryTerrainElevation(N),re=this.queryTerrainElevation(V),he=[[j.x,j.y,Math.min(Z||0,Q||0,J||0,re||0)],[Y.x,Y.y,Math.max(Z||0,Q||0,J||0,re||0)]];let ce=o.cd.fromPoints(he);const ge=E.getWorldToCameraMatrix(),pe=o.ab.mat4.invert(new Float64Array(16),ge);ce=o.cd.applyTransform(ce,ge);const _e=this._extendAABB(ce,E,D,p);if(!_e)return void o.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");ce=_e;const de=.5*o.ab.vec3.sub([],ce.max,ce.min)[2],be=this._minimumAABBFrustumDistance(E,ce),Ee=[0,0,1,0];o.ab.vec4.transformMat4(Ee,Ee,ge),o.ab.vec4.normalize(Ee,Ee);const qe=o.ab.vec3.scale([],Ee,be+de),Le=o.ab.vec3.add([],ce.center,qe);o.ab.vec3.transformMat4(ce.center,ce.center,pe),o.ab.vec3.transformMat4(Le,Le,pe);const Ye=E.unproject(new o.P(ce.center[0],ce.center[1])),Xe=o.dE(E.projection,Ye),Re=Math.pow(2,Xe),He=Math.min(E._zoomFromMercatorZ(Le[2]*E.pixelsPerMeter*Re/E.worldSize),D.maxZoom);return E.mercatorFromTransition&&He<.5*(o.c6+o.bY)?(E.setProjection({name:"globe"}),E.zoom=He,this._cameraForBounds(E,n,c,p,y,b)):{center:Ye,zoom:He,bearing:p,pitch:y}}fitBounds(t,n,c){const p=this.cameraForBounds(t,n);return this._fitInternal(p,n,c)}fitScreenCoordinates(t,n,c,p,y){const b=o.P.convert(t),E=o.P.convert(n),D=new o.P(Math.min(b.x,E.x),Math.min(b.y,E.y)),L=new o.P(Math.max(b.x,E.x),Math.max(b.y,E.y));if("mercator"===this.transform.projection.name&&this.transform.anyCornerOffEdge(b,E))return this;const k=this.transform.pointLocation3D(D),N=this.transform.pointLocation3D(L),V=this.transform.pointLocation3D(new o.P(D.x,L.y)),j=this.transform.pointLocation3D(new o.P(L.x,D.y)),Y=[Math.min(k.lng,N.lng,V.lng,j.lng),Math.min(k.lat,N.lat,V.lat,j.lat)],Z=[Math.max(k.lng,N.lng,V.lng,j.lng),Math.max(k.lat,N.lat,V.lat,j.lat)],Q=p&&p.pitch?p.pitch:this.getPitch(),J=this._cameraForBounds(this.transform,Y,Z,c,Q,p);return this._fitInternal(J,p,y)}_fitInternal(t,n,c){return t?(n=o.l(t,n)).linear?this.easeTo(n,c):this.flyTo(n,c):this}jumpTo(t,n){this.stop();const c=t.preloadOnly?this.transform.clone():this.transform;let p=!1,y=!1,b=!1;"zoom"in t&&c.zoom!==+t.zoom&&(p=!0,c.zoom=+t.zoom),void 0!==t.center&&(c.center=o.bO.convert(t.center)),"bearing"in t&&c.bearing!==+t.bearing&&(y=!0,c.bearing=+t.bearing),"pitch"in t&&c.pitch!==+t.pitch&&(b=!0,c.pitch=+t.pitch);const E="number"==typeof t.padding?this._extendPadding(t.padding):t.padding;if(null!=t.padding&&!c.isPaddingEqual(E))if(!1===t.retainPadding){const D=c.clone();D.padding=E,c.setLocationAtPoint(c.center,D.centerPoint)}else c.padding=E;return t.preloadOnly?(this._preloadTiles(c),this):(this.fire(new o.z("movestart",n)).fire(new o.z("move",n)),p&&this.fire(new o.z("zoomstart",n)).fire(new o.z("zoom",n)).fire(new o.z("zoomend",n)),y&&this.fire(new o.z("rotatestart",n)).fire(new o.z("rotate",n)).fire(new o.z("rotateend",n)),b&&this.fire(new o.z("pitchstart",n)).fire(new o.z("pitch",n)).fire(new o.z("pitchend",n)),this.fire(new o.z("moveend",n)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||o.w(dd),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,n){const c=this.transform;if(!c.projection.supportsFreeCamera)return o.w(dd),this;this.stop();const p=c.zoom,y=c.pitch,b=c.bearing;c.setFreeCameraOptions(t);const E=p!==c.zoom,D=y!==c.pitch,L=b!==c.bearing;return this.fire(new o.z("movestart",n)).fire(new o.z("move",n)),E&&this.fire(new o.z("zoomstart",n)).fire(new o.z("zoom",n)).fire(new o.z("zoomend",n)),L&&this.fire(new o.z("rotatestart",n)).fire(new o.z("rotate",n)).fire(new o.z("rotateend",n)),D&&this.fire(new o.z("pitchstart",n)).fire(new o.z("pitch",n)).fire(new o.z("pitchend",n)),this.fire(new o.z("moveend",n)),this}easeTo(t,n){this._stop(!1,t.easeId),(!1===(t=o.l({offset:[0,0],duration:500,easing:o.dA},t)).animate||this._prefersReducedMotion(t))&&(t.duration=0);const c=this.transform,p=this.getZoom(),y=this.getBearing(),b=this.getPitch(),E=this.getPadding(),D="zoom"in t?+t.zoom:p,L="bearing"in t?this._normalizeBearing(t.bearing,y):y,k="pitch"in t?+t.pitch:b,N=this._extendPadding(t.padding),V=o.P.convert(t.offset);let j,Y,Z;if("globe"===c.projection.name){const Ee=o.aa.fromLngLat(c.center),qe=V.rotate(-c.angle);Ee.x+=qe.x/c.worldSize,Ee.y+=qe.y/c.worldSize;const Le=Ee.toLngLat(),Ye=o.bO.convert(t.center||Le);this._normalizeCenter(Ye),j=c.centerPoint.add(qe),Y=new o.P(Ee.x,Ee.y).mult(c.worldSize),Z=new o.P(o.at(Ye.lng),o.aA(Ye.lat)).mult(c.worldSize).sub(Y)}else{j=c.centerPoint.add(V);const Ee=c.pointLocation(j),qe=o.bO.convert(t.center||Ee);this._normalizeCenter(qe),Y=c.project(Ee),Z=c.project(qe).sub(Y)}const Q=c.zoomScale(D-p);let J,re;t.around&&(J=o.bO.convert(t.around),re=c.locationPoint(J));const he=this._zooming||D!==p,ce=this._rotating||y!==L,ge=this._pitching||k!==b,pe=!c.isPaddingEqual(N),_e=!1===t.retainPadding?c.clone():c,de=Ee=>qe=>{if(he&&(Ee.zoom=o.af(p,D,qe)),ce&&(Ee.bearing=o.af(y,L,qe)),ge&&(Ee.pitch=o.af(b,k,qe)),pe&&(_e.interpolatePadding(E,N,qe),j=_e.centerPoint.add(V)),J)Ee.setLocationAtPoint(J,re);else{const Le=Ee.zoomScale(Ee.zoom-p),Ye=D>p?Math.min(2,Q):Math.max(.5,Q),Xe=Math.pow(Ye,1-qe),Re=Ee.unproject(Y.add(Z.mult(qe*Xe)).mult(Le));Ee.setLocationAtPoint(Ee.renderWorldCopies?Re.wrap():Re,j)}return t.preloadOnly||this._fireMoveEvents(n),Ee};if(t.preloadOnly){const Ee=this._emulate(de,t.duration,c);return this._preloadTiles(Ee),this}const be={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=he,this._rotating=ce,this._pitching=ge,this._padding=pe,this._easeId=t.easeId,this._prepareEase(n,t.noMoveStart,be),this._ease(de(c),Ee=>{"sea"===c.cameraElevationReference&&c.recenterOnTerrain(),this._afterEase(n,Ee)},t),this}_prepareEase(t,n,c={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&0===this.transform.pitch&&"globe"!==this.transform.projection.name&&(this.transform.cameraElevationReference="ground"),n||c.moving||this.fire(new o.z("movestart",t)),this._zooming&&!c.zooming&&this.fire(new o.z("zoomstart",t)),this._rotating&&!c.rotating&&this.fire(new o.z("rotatestart",t)),this._pitching&&!c.pitching&&this.fire(new o.z("pitchstart",t))}_fireMoveEvents(t){this.fire(new o.z("move",t)),this._zooming&&this.fire(new o.z("zoom",t)),this._rotating&&this.fire(new o.z("rotate",t)),this._pitching&&this.fire(new o.z("pitch",t))}_afterEase(t,n){if(this._easeId&&n&&this._easeId===n)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const c=this._zooming,p=this._rotating,y=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,c&&this.fire(new o.z("zoomend",t)),p&&this.fire(new o.z("rotateend",t)),y&&this.fire(new o.z("pitchend",t)),this.fire(new o.z("moveend",t))}flyTo(t,n){if(this._prefersReducedMotion(t)){const We=o.ay(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(We,n)}this.stop(),t=o.l({offset:[0,0],speed:1.2,curve:1.42,easing:o.dA},t);const c=this.transform,p=this.getZoom(),y=this.getBearing(),b=this.getPitch(),E=this.getPadding(),D="zoom"in t?o.aw(+t.zoom,c.minZoom,c.maxZoom):p,L="bearing"in t?this._normalizeBearing(t.bearing,y):y,k="pitch"in t?+t.pitch:b,N=this._extendPadding(t.padding),V=c.zoomScale(D-p),j=o.P.convert(t.offset);let Y=c.centerPoint.add(j);const Z=c.pointLocation(Y),Q=o.bO.convert(t.center||Z);this._normalizeCenter(Q);const J=c.project(Z),re=c.project(Q).sub(J);let he=t.curve;const ce=Math.max(c.width,c.height),ge=ce/V,pe=re.mag();if("minZoom"in t){const We=o.aw(Math.min(t.minZoom,p,D),c.minZoom,c.maxZoom),ut=ce/c.zoomScale(We-p);he=Math.sqrt(ut/pe*2)}const _e=he*he;function de(We){const ut=(ge*ge-ce*ce+(We?-1:1)*_e*_e*pe*pe)/(2*(We?ge:ce)*_e*pe);return Math.log(Math.sqrt(ut*ut+1)-ut)}function be(We){return(Math.exp(We)-Math.exp(-We))/2}function Ee(We){return(Math.exp(We)+Math.exp(-We))/2}const qe=de(0);let Le=function(We){return Ee(qe)/Ee(qe+he*We)},Ye=function(We){return ce*((Ee(qe)*(be(ut=qe+he*We)/Ee(ut))-be(qe))/_e)/pe;var ut},Xe=(de(1)-qe)/he;if(Math.abs(pe)<1e-6||!isFinite(Xe)){if(Math.abs(ce-ge)<1e-6)return this.easeTo(t,n);const We=ge<ce?-1:1;Xe=Math.abs(Math.log(ge/ce))/he,Ye=function(){return 0},Le=function(ut){return Math.exp(We*he*ut)}}t.duration="duration"in t?+t.duration:1e3*Xe/("screenSpeed"in t?+t.screenSpeed/he:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const Re=y!==L,He=k!==b,it=!c.isPaddingEqual(N),De=!1===t.retainPadding?c.clone():c,Je=We=>ut=>{const et=ut*Xe,Ke=1/Le(et);We.zoom=1===ut?D:p+We.scaleZoom(Ke),Re&&(We.bearing=o.af(y,L,ut)),He&&(We.pitch=o.af(b,k,ut)),it&&(De.interpolatePadding(E,N,ut),Y=De.centerPoint.add(j));const rt=1===ut?Q:We.unproject(J.add(re.mult(Ye(et))).mult(Ke));return We.setLocationAtPoint(We.renderWorldCopies?rt.wrap():rt,Y),We._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(n),We};if(t.preloadOnly){const We=this._emulate(Je,t.duration,c);return this._preloadTiles(We),this}return this._zooming=!0,this._rotating=Re,this._pitching=He,this._padding=it,this._prepareEase(n,!1),this._ease(Je(c),()=>this._afterEase(n),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,n){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const c=this._onEaseEnd;this._onEaseEnd=void 0,c.call(this,n)}if(!t){const c=this.handlers;c&&c.stop(!1)}return this}_ease(t,n,c){!1===c.animate||0===c.duration?(t(1),n()):(this._easeStart=o.q.now(),this._easeOptions=c,this._onEaseFrame=t,this._onEaseEnd=n,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((o.q.now()-this._easeStart)/this._easeOptions.duration,1),n=this._onEaseFrame;n&&n(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,n){t=o.bF(t,-180,180);const c=Math.abs(t-n);return Math.abs(t-360-n)<c&&(t-=360),Math.abs(t+360-n)<c&&(t+=360),t}_normalizeCenter(t){const n=this.transform;if(n.maxBounds||"globe"!==n.projection.name&&!n.renderWorldCopies)return;const c=t.lng-n.center.lng;t.lng+=c>180?-360:c<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&o.q.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,n,c){const p=Math.ceil(15*n/1e3),y=[],b=t(c.clone());for(let E=0;E<=p;E++){const D=b(E/p);y.push(D.clone())}return y}_preloadTiles(t,n){}}class nh{constructor(t={}){this.options=t,o.aP(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const n=this.options&&this.options.compact,c=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=qi("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=qi("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",c);const p=qi("span","mapboxgl-ctrl-icon",this._compactButton);return p.setAttribute("aria-hidden","true"),p.setAttribute("title",c),this._innerContainer=qi("div","mapboxgl-ctrl-attrib-inner",this._container),n&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===n&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const n=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||o.e.ACCESS_TOKEN}];if(t){const c=n.reduce((p,y,b)=>(y.value&&(p+=`${y.key}=${y.value}${b<n.length-1?"&":""}`),p),"?");t.href=`${o.e.FEEDBACK_URL}/${c}#${pu(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||"metadata"!==t.sourceDataType&&"visibility"!==t.sourceDataType&&"style"!==t.dataType||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const p=this._map.style.stylesheet;this.styleOwner=p.owner,this.styleId=p.id}const n=this._map.style._mergedSourceCaches;for(const p in n){const y=n[p];if(y.used){const b=y.getSource();b.attribution&&t.indexOf(b.attribution)<0&&t.push(b.attribution)}}t.sort((p,y)=>p.length-y.length),t=t.filter((p,y)=>{for(let b=y+1;b<t.length;b++)if(t[b].indexOf(p)>=0)return!1;return!0}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const c=t.join(" | ");c!==this._attribHTML&&(this._attribHTML=c,t.length?(this._innerContainer.innerHTML=c,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class Kr{constructor(){o.aP(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=qi("div","mapboxgl-ctrl");const n=qi("a","mapboxgl-ctrl-logo");return n.target="_blank",n.rel="noopener nofollow",n.href="https://www.mapbox.com/",n.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),n.setAttribute("rel","noopener nofollow"),this._container.appendChild(n),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&"metadata"!==t.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(0===Object.entries(t).length)return!0;for(const n in t){const c=t[n].getSource();if(c.hasOwnProperty("mapbox_logo")&&!c.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const n=t[0];this._map.getCanvasContainer().offsetWidth<250?n.classList.add("mapboxgl-compact"):n.classList.remove("mapboxgl-compact")}}}class Jr{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const n=++this._id;return this._queue.push({callback:t,id:n,cancelled:!1}),n}remove(t){const n=this._currentlyRunning,c=n?this._queue.concat(n):this._queue;for(const p of c)if(p.id===t)return void(p.cancelled=!0)}run(t=0){const n=this._currentlyRunning=this._queue;this._queue=[];for(const c of n)if(!c.cancelled&&(c.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class gl{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const n=o.cB((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-n)+this._end*n}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,n,c){this._start=this.getValue(n),this._end=t,this._startTime=n,this._endTime=n+c}}const va={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use \u2318 + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class jo extends o.z{constructor(t,n,c,p){const{point:y,lngLat:b,originalEvent:E,target:D}=t;super(t.type,{point:y,lngLat:b,originalEvent:E,target:D}),this.preventDefault=()=>{t.preventDefault()},this.id=n,this.interaction=c,this.feature=p}}class wu{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,n){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);const c=n.filter;let p=n.type;c&&this.filters.set(t,o.aZ(c)),"mouseover"===p&&(p="mouseenter"),"mouseout"===p&&(p="mouseleave");const y=this.interactionsByType.get(p)||new Map;"mouseenter"===p||"mouseleave"===p?(0===this.delegatedInteractions.size&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,n)):0===y.size&&this.map.on(p,this.handleType),0===y.size&&this.interactionsByType.set(p,y),y.set(t,n),this.typeById.set(t,p)}get(t){const n=this.typeById.get(t);if(!n)return;const c=this.interactionsByType.get(n);return c?c.get(t):void 0}remove(t){const n=this.typeById.get(t);if(!n)return;this.typeById.delete(t),this.filters.delete(t);const c=this.interactionsByType.get(n);c&&(c.delete(t),"mouseenter"===n||"mouseleave"===n?(this.delegatedInteractions.delete(t),0===this.delegatedInteractions.size&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):0===c.size&&this.map.off(n,this.handleType))}queryTargets(t,n){const c=[];for(const[p,y]of n)y.target&&c.push({targetId:p,target:y.target,filter:this.filters.get(p)});return this.map.style.queryRenderedTargets(t,c,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const n=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());n.length&&(t.type="mouseenter",this.handleType(t,n));const c=new Map;for(const[p,{feature:y}]of this.prevHoveredFeatures)this.hoveredFeatures.has(p)||c.set(y.id,y);c.size&&(t.type="mouseleave",this.handleType(t,Array.from(c.values())))}handleOut(t){const n=Array.from(this.hoveredFeatures.values()).map(({feature:c})=>c);n.length&&(t.type="mouseleave",this.handleType(t,n)),this.hoveredFeatures.clear()}handleType(t,n){const c=Array.from(this.interactionsByType.get(t.type)).reverse(),p=!!n;n=n||this.queryTargets(t.point,c);const y="mouseenter"===t.type;let b=!1;const E=new Set;for(const D of n){for(const[L,k]of c){if(!k.target)continue;const N=D.variants?D.variants[L]:null;if(N){for(const V of N){if(As(V,D,E,L))continue;const j=new o.cw(D,V),Y=Ml(V,D,L);p&&(j.state=this.map.getFeatureState(j));const Z=y?this.prevHoveredFeatures.get(Y):null,Q=new jo(t,L,k,j),J=Z?Z.stop:k.handler(Q);if(y&&this.hoveredFeatures.set(Y,{feature:D,stop:J}),!1!==J){b=!0;break}}if(b)break}}if(b)break}if(!b)for(const[D,L]of c){const{handler:k,target:N}=L;if(!N&&!1!==k(new jo(t,D,L,null)))break}}}function Ci(l,t){if(Array.isArray(l)&&Array.isArray(t)){const n=new Set(l),c=new Set(t);return n.size===c.size&&l.every(p=>c.has(p))}return o.bn(l,t)}const Go={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},$d={showCompass:!0,showZoom:!0,visualizePitch:!1};class Zd{constructor(t,n,c=!1){this._clickTolerance=10,this.element=n,this.mouseRotate=new ls({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,c&&(this.mousePitch=new dl({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),o.aP(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),n.addEventListener("mousedown",this.mousedown),n.addEventListener("touchstart",this.touchstart,{passive:!1}),n.addEventListener("touchmove",this.touchmove),n.addEventListener("touchend",this.touchend),n.addEventListener("touchcancel",this.reset)}down(t,n){this.mouseRotate.mousedown(t,n),this.mousePitch&&this.mousePitch.mousedown(t,n),gi()}move(t,n){const c=this.map,p=this.mouseRotate.mousemoveWindow(t,n),y=p&&p.bearingDelta;if(y&&c.setBearing(c.getBearing()+y),this.mousePitch){const b=this.mousePitch.mousemoveWindow(t,n),E=b&&b.pitchDelta;E&&c.setPitch(c.getPitch()+E)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart,{passive:!1}),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){$o(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(o.l({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),Ms(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,Ms(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){1!==t.targetTouches.length?this.reset():(this._startPos=this._lastPos=Gs(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){1!==t.targetTouches.length?this.reset():(this._lastPos=Gs(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){0===t.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function yl(l,t,n){if(l=new o.bO(l.lng,l.lat),t){const c=new o.bO(l.lng-360,l.lat),p=new o.bO(l.lng+360,l.lat),y=360*Math.ceil(Math.abs(l.lng-n.center.lng)/360),b=n.locationPoint(l).distSqr(t),E=t.x<0||t.y<0||t.x>n.width||t.y>n.height;n.locationPoint(c).distSqr(t)<b&&(E||Math.abs(c.lng-n.center.lng)<y)?l=c:n.locationPoint(p).distSqr(t)<b&&(E||Math.abs(p.lng-n.center.lng)<y)&&(l=p)}for(;Math.abs(l.lng-n.center.lng)>180;){const c=n.locationPoint(l);if(c.x>=0&&c.y>=0&&c.x<=n.width&&c.y<=n.height)break;l.lng>n.center.lng?l.lng-=360:l.lng+=360}return l}const Us={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class cs extends o.E{constructor(t,n){if(super(),(t instanceof HTMLElement||n)&&(t=o.l({element:t},n)),o.aP(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=t&&t.anchor||"center",this._color=t&&t.color||"#3FB1CE",this._scale=t&&t.scale||1,this._draggable=t&&t.draggable||!1,this._clickTolerance=t&&t.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=t&&t.rotation||0,this._rotationAlignment=t&&t.rotationAlignment||"auto",this._pitchAlignment=t&&t.pitchAlignment&&t.pitchAlignment||"auto",this._updateMoving=()=>this._update(!0),this._occludedOpacity=t&&t.occludedOpacity||.2,t&&t.element)this._element=t.element,this._offset=o.P.convert(t&&t.offset||[0,0]);else{this._defaultMarker=!0,this._element=qi("div");const y=41,b=27,E=Yn("svg",{display:"block",height:y*this._scale+"px",width:b*this._scale+"px",viewBox:`0 0 ${b} ${y}`},this._element),D=Yn("radialGradient",{id:"shadowGradient"},Yn("defs",{},E));Yn("stop",{offset:"10%","stop-opacity":.4},D),Yn("stop",{offset:"100%","stop-opacity":.05},D),Yn("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},E),Yn("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},E),Yn("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},E),Yn("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},E),this._offset=o.P.convert(t&&t.offset||[0,-14])}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",y=>{y.preventDefault()}),this._element.addEventListener("mousedown",y=>{y.preventDefault()});const c=this._element.classList;for(const y in Us)c.remove(`mapboxgl-marker-anchor-${y}`);c.add(`mapboxgl-marker-anchor-${this._anchor}`);const p=t&&t.className?t.className.trim().split(/\s+/):[];c.add(...p),this._popup=null}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=o.bO.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const p=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[p,-1*(24.6+p)],"bottom-right":[-p,-1*(24.6+p)],left:[13.5,-24.6],right:[-13.5,-24.6]}:this._offset}this._popup=t,t._marker=this,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const n=t.code,c=t.charCode||t.keyCode;"Space"!==n&&"Enter"!==n&&32!==c&&13!==c||this.togglePopup()}_onMapClick(t){const n=t.originalEvent.target,c=this._element;this._popup&&(n===c||c.contains(n))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,n=this._pos;if(!t||!n)return!1;const c=t.unproject(n),p=t.getFreeCameraOptions();if(!p.position)return!1;const y=p.position.toLngLat();return y.distanceTo(c)<.9*y.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const n=this._pos;if(!n||n.x<0||n.x>t.transform.width||n.y<0||n.y>t.transform.height)return void this._clearFadeTimer();const c=t.unproject(n);let p;t._showingGlobe()&&o.dH(t.transform,this._lngLat)?p=0:(p=1-t._queryFogOpacity(c),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(p*=this._occludedOpacity)),this._element.style.opacity=`${p}`,this._element.style.pointerEvents=p>0?"auto":"none",this._popup&&this._popup._setOpacity(p),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const n=this._offset.mult(this._scale);this._element.style.transform=`\n            translate(${t.x}px,${t.y}px)\n            ${Us[this._anchor]}\n            ${this._calculateXYTransform()} ${this._calculateZTransform()}\n            translate(${n.x}px,${n.y}px)\n        `}_calculateXYTransform(){const t=this._pos,n=this._map,c=this.getPitchAlignment();if(!n||!t||"map"!==c)return"";if(!n._showingGlobe()){const D=n.getPitch();return D?`rotateX(${D}deg)`:""}const p=o.c4(o.dI(n.transform,this._lngLat)),y=t.sub(o.dJ(n.transform)),b=Math.abs(y.x)+Math.abs(y.y);if(0===b)return"";const E=p/b;return`rotateX(${-y.y*E}deg) rotateY(${y.x*E}deg)`}_calculateZTransform(){const t=this._pos,n=this._map;if(!n||!t)return"";let c=0;const p=this.getRotationAlignment();if("map"===p)if(n._showingGlobe()){const y=n.project(new o.bO(this._lngLat.lng,this._lngLat.lat+.001)),b=n.project(new o.bO(this._lngLat.lng,this._lngLat.lat-.001)).sub(y);c=o.c4(Math.atan2(b.y,b.x))-90}else c=-n.getBearing();else if("horizon"===p){const y=o.ac(4,6,n.getZoom()),b=o.dJ(n.transform);b.y+=y*n.transform.height;const E=t.sub(b),D=o.c4(Math.atan2(E.y,E.x));c=(D>90?D-270:D+90)*(1-y)}return c+=this._rotation,c?`rotateZ(${c}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);const n=this._map;n&&(n.transform.renderWorldCopies&&(this._lngLat=yl(this._lngLat,this._pos,n.transform)),this._pos=n.project(this._lngLat),!0===t?this._updateFrameId=requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())}):this._pos=this._pos.round(),n._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(n._showingGlobe()||n.getTerrain()||n.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))}))}getOffset(){return this._offset}setOffset(t){return this._offset=o.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const n=this._map;if(!n)return;const c=this._pointerdownPos,p=this._positionDelta;if(c&&p){if(!this._isDragging){const y=this._clickTolerance||n._clickTolerance;if(t.point.dist(c)<y)return;this._isDragging=!0}this._pos=t.point.sub(p),this._lngLat=n.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new o.z("dragstart"))),this.fire(new o.z("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),"active"===this._state&&this.fire(new o.z("dragend")),this._state="inactive"}_addDragHandler(t){const n=this._map,c=this._pos;n&&c&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(c),this._pointerdownPos=t.point,this._state="pending",n.on("mousemove",this._onMove),n.on("touchmove",this._onMove),n.once("mouseup",this._onUp),n.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const n=this._map;return n&&(t?(n.on("mousedown",this._addDragHandler),n.on("touchstart",this._addDragHandler)):(n.off("mousedown",this._addDragHandler),n.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||"auto",this._update(),this}getRotationAlignment(){return"auto"===this._rotationAlignment||"horizon"===this._rotationAlignment&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||"auto",this._update(),this}getPitchAlignment(){return"auto"===this._pitchAlignment?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||.2,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const fr={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Vr={maxWidth:100,unit:"metric"},$n={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},pd={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},_n=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Tu(l=new o.P(0,0),t="bottom"){if("number"==typeof l){const n=Math.round(Math.sqrt(.5*Math.pow(l,2)));switch(t){case"top":return new o.P(0,l);case"top-left":return new o.P(n,n);case"top-right":return new o.P(-n,n);case"bottom":return new o.P(0,-l);case"bottom-left":return new o.P(n,-n);case"bottom-right":return new o.P(-n,-n);case"left":return new o.P(l,0);case"right":return new o.P(-l,0)}return new o.P(0,0)}return l instanceof o.P||Array.isArray(l)?o.P.convert(l):o.P.convert(l[t]||[0,0])}return{version:er,supported:Oi.supported,setRTLTextPlugin:o.dK,getRTLTextPluginStatus:o.dL,Map:class extends _l{constructor(l){Qi.mark(jr.create);const t=l;if(null!=(l=o.l({},Go,l)).minZoom&&null!=l.maxZoom&&l.minZoom>l.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=l.minPitch&&null!=l.maxPitch&&l.minPitch>l.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=l.minPitch&&l.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=l.maxPitch&&l.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(l.antialias&&o.dF(window)&&(l.antialias=!1,o.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new ys(l.minZoom,l.maxZoom,l.minPitch,l.maxPitch,l.renderWorldCopies),l),this._repaint=!!l.repaint,this._interactive=l.interactive,this._minTileCacheSize=l.minTileCacheSize,this._maxTileCacheSize=l.maxTileCacheSize,this._failIfMajorPerformanceCaveat=l.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=l.preserveDrawingBuffer,this._antialias=l.antialias,this._trackResize=l.trackResize,this._bearingSnap=l.bearingSnap,this._refreshExpiredTiles=l.refreshExpiredTiles,this._fadeDuration=l.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=l.crossSourceCollisions,this._collectResourceTiming=l.collectResourceTiming,this._language=this._parseLanguage(l.language),this._worldview=l.worldview,this._renderTaskQueue=new Jr,this._domRenderTaskQueue=new Jr,this._controls=[],this._markers=[],this._popups=[],this._mapId=o.aV(),this._locale=o.l({},va,l.locale),this._clickTolerance=l.clickTolerance,this._cooperativeGestures=l.cooperativeGestures,this._performanceMetricsCollection=l.performanceMetricsCollection,this._tessellationStep=l.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=l.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new gl(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=l.scaleFactor,this._requestManager=new _c(l.transformRequest,l.accessToken,l.testMode),this._silenceAuthErrors=!!l.testMode,this._contextCreateOptions=l.contextCreateOptions?Object.assign({},l.contextCreateOptions):{},"string"==typeof l.container){const n=document.getElementById(l.container);if(!n)throw new Error(`Container '${l.container.toString()}' not found.`);this._container=n}else{if(!(l.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=l.container}if(this._container.childNodes.length>0&&o.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),l.maxBounds&&this.setMaxBounds(l.maxBounds),this._spriteFormat=l.spriteFormat,o.aP(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new au),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},()=>{this._update()}),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},()=>{this.setScaleFactor(this._scaleFactor)}),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");if(this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new ud(this,l),this._localFontFamily=l.localFontFamily,this._localIdeographFontFamily=l.localIdeographFontFamily,(l.style||!l.testMode)&&this.setStyle(l.style||o.e.DEFAULT_STYLE,{config:l.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),l.projection&&this.setProjection(l.projection),this.indoor=new Rh(this),l.hash&&(this._hash=new du("string"==typeof l.hash&&l.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){null==t.center&&null==t.zoom||(this.transform._unmodified=!1),this.jumpTo({center:l.center,zoom:l.zoom,bearing:l.bearing,pitch:l.pitch});const n=l.bounds;n&&(this.resize(),this.fitBounds(n,o.l({},l.fitBoundsOptions,{duration:0})))}this.resize(),l.attributionControl&&this.addControl(new nh({customAttribution:l.customAttribution})),this._logoControl=new Kr,this.addControl(this._logoControl,l.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()}),this.on("data",n=>{this._update("style"===n.dataType),this.fire(new o.z(`${n.dataType}data`,n))}),this.on("dataloading",n=>{this.fire(new o.z(`${n.dataType}dataloading`,n))}),this._interactions=new wu(this)}_getMapId(){return this._mapId}addControl(l,t){if(void 0===t&&(t=l.getDefaultPosition?l.getDefaultPosition():"top-right"),!l||!l.onAdd)return this.fire(new o.y(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const n=l.onAdd(this);this._controls.push(l);const c=this._controlPositions[t];return-1!==t.indexOf("bottom")?c.insertBefore(n,c.firstChild):c.appendChild(n),this}removeControl(l){if(!l||!l.onRemove)return this.fire(new o.y(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(l);return t>-1&&this._controls.splice(t,1),l.onRemove(this),this}hasControl(l){return this._controls.indexOf(l)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(l){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new o.z("movestart",l)).fire(new o.z("move",l)),this.fire(new o.z("resize",l)),t&&this.fire(new o.z("moveend",l)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(l){return this.transform.setMaxBounds(o.az.convert(l)),this._update()}setMinZoom(l){if((l=l??-2)>=-2&&l<=this.transform.maxZoom)return this.transform.minZoom=l,this._update(),this.getZoom()<l?this.setZoom(l):this.fire(new o.z("zoomstart")).fire(new o.z("zoom")).fire(new o.z("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(l){if((l=l??22)>=this.transform.minZoom)return this.transform.maxZoom=l,this._update(),this.getZoom()>l?this.setZoom(l):this.fire(new o.z("zoomstart")).fire(new o.z("zoom")).fire(new o.z("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(l){if((l=l??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(l>=0&&l<=this.transform.maxPitch)return this.transform.minPitch=l,this._update(),this.getPitch()<l?this.setPitch(l):this.fire(new o.z("pitchstart")).fire(new o.z("pitch")).fire(new o.z("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(l){if((l=l??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(l>=this.transform.minPitch)return this.transform.maxPitch=l,this._update(),this.getPitch()>l?this.setPitch(l):this.fire(new o.z("pitchstart")).fire(new o.z("pitch")).fire(new o.z("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(l){return this._scaleFactor=l,this.painter.scaleFactor=l,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers(t=>"symbol"===t.type),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(l){return this.transform.renderWorldCopies=l,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(l){return"auto"===l?navigator.language:Array.isArray(l)?0===l.length?void 0:l.map(t=>"auto"===t?navigator.language:t):l}setLanguage(l){const t=this._parseLanguage(l);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const n of this._controls)n._setLanguage&&n._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(l){return this.style&&l!==this._worldview?(this._worldview=l,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return"globe"===this.transform.projection.name}setProjection(l){return this._lazyInitEmptyStyle(),l?"string"==typeof l&&(l={name:l}):l=null,this._useExplicitProjection=!!l,this._prioritizeAndUpdateProjection(l,this.style.projection)}_updateProjectionTransition(){if("globe"!==this.getProjection().name)return;const l=this.transform,t=l.projection.name;let n;"globe"===t&&l.zoom>=o.bY?(l.setMercatorFromTransition(),n=!0):"mercator"===t&&l.zoom<o.bY&&(l.setProjection({name:"globe"}),n=!0),n&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate())}_prioritizeAndUpdateProjection(l,t){return this._updateProjection(l||t||{name:"mercator"})}_updateProjection(l){let t;return t="globe"===l.name&&this.transform.zoom>=o.bY?this.transform.setMercatorFromTransition():this.transform.setProjection(l),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(l){return this.transform.locationPoint3D(o.bO.convert(l))}unproject(l){return this.transform.pointLocation3D(o.P.convert(l))}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(l,t,n){const c=p=>{let y=[];if(Array.isArray(t)){const b=t.filter(E=>this.getLayer(E));y=b.length?this.queryRenderedFeatures(p,{layers:b}):[]}else y=this.queryRenderedFeatures(p,{target:t});return y};if("mouseenter"===l||"mouseover"===l){let p=!1;return{listener:n,targets:t,delegates:{mousemove:b=>{const E=c(b.point);E.length?p||(p=!0,n.call(this,new Pr(l,this,b.originalEvent,{features:E}))):p=!1},mouseout:()=>{p=!1}}}}if("mouseleave"===l||"mouseout"===l){let p=!1;return{listener:n,targets:t,delegates:{mousemove:E=>{c(E.point).length?p=!0:p&&(p=!1,n.call(this,new Pr(l,this,E.originalEvent)))},mouseout:E=>{p&&(p=!1,n.call(this,new Pr(l,this,E.originalEvent)))}}}}{const p=y=>{const b=c(y.point);b.length&&(y.features=b,n.call(this,y),delete y.features)};return{listener:n,targets:t,delegates:{[l]:p}}}}on(l,t,n){if("function"==typeof t||void 0===n)return super.on(l,t);if("string"==typeof t&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(l,t,n);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[l]=this._delegatedListeners[l]||[],this._delegatedListeners[l].push(c);for(const p in c.delegates)this.on(p,c.delegates[p]);return this}once(l,t,n){if("function"==typeof t||void 0===n)return super.once(l,t);if("string"==typeof t&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(l,t,n);for(const p in c.delegates)this.once(p,c.delegates[p]);return this}off(l,t,n){if("function"==typeof t||void 0===n)return super.off(l,t);if("string"==typeof t&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._delegatedListeners?this._delegatedListeners[l]:void 0;return c&&(p=>{for(let y=0;y<p.length;y++){const b=p[y];if(b.listener===n&&Ci(b.targets,t)){for(const E in b.delegates)this.off(E,b.delegates[E]);return p.splice(y,1),this}}})(c),this}queryRenderedFeatures(l,t){if(!this.style)return[];if(void 0===l||l instanceof o.P||Array.isArray(l)||void 0!==t||(t=l,l=void 0),l=l||[[0,0],[this.transform.width,this.transform.height]],!t){const y=this.style.queryRenderedFeatures(l,void 0,this.transform),b=this.style.queryRenderedFeatureset(l,void 0,this.transform);return y.concat(b)}let n=!0;if(t.target&&(n=this._isTargetValid(t.target),n&&!t.layers))return this.style.queryRenderedFeatureset(l,t,this.transform);let c=!0;if(t.layers&&Array.isArray(t.layers)){for(const y of t.layers)if(!this._isValidId(y)){c=!1;break}if(c&&!t.target)return this.style.queryRenderedFeatures(l,t,this.transform)}let p=[];return c&&(p=p.concat(this.style.queryRenderedFeatures(l,t,this.transform))),n&&(p=p.concat(this.style.queryRenderedFeatureset(l,t,this.transform))),p}querySourceFeatures(l,t){return!l||"string"==typeof l&&!this._isValidId(l)?[]:this.style.querySourceFeatures(l,t)}isPointOnSurface(l){const{name:t}=this.transform.projection;return"globe"!==t&&"mercator"!==t&&o.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(o.P.convert(l))}addInteraction(l,t){return this._interactions.add(l,t),this}removeInteraction(l){return this._interactions.remove(l),this}setStyle(l,t){return t=o.l({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&l&&!1!==t.diff&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(l,(n,c)=>{n?(o.w(`Unable to perform style diff: ${String(n.message||n.error||n)}. Rebuilding the style from scratch.`),this._updateStyle(l,t)):c&&this._update(!0)},()=>{this._postStyleLoadEvent()}),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(l,t))}_getUIString(l){const t=this._locale[l];if(null==t)throw new Error(`Missing UI string '${l}'`);return t}_updateStyle(l,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),l){const n=o.l({},t);t&&t.config&&(n.initialConfig=t.config,delete n.config),this.style=new os(this,n).load(l),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new os(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(o.w("There is no style added to the map."),!1)}_isValidId(l){return null==l?(this.fire(new o.y(new Error("IDs can't be empty."))),!1):!o.cr(l)||(this.fire(new o.y(new Error(`IDs can't contain special symbols: "${l}".`))),!1)}_isTargetValid(l){return"featuresetId"in l?this._isValidId("importId"in l?l.importId:l.featuresetId):"layerId"in l&&this._isValidId(l.layerId)}_areTargetsValid(l){if(Array.isArray(l)){for(const t of l)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(l)}addSource(l,t){return this._isValidId(l)?(this._lazyInitEmptyStyle(),this.style.addSource(l,t),this._update(!0)):this}isSourceLoaded(l){return!!this._isValidId(l)&&!!this.style&&this.style._isSourceCacheLoaded(l)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(l,t,n){this._lazyInitEmptyStyle(),this.style.addSourceType(l,t,n)}removeSource(l){return this._isValidId(l)?(this.style.removeSource(l),this._updateTerrain(),this._update(!0)):this}getSource(l){return this._isValidId(l)?this.style.getOwnSource(l):null}addImage(l,t,{pixelRatio:n=1,sdf:c=!1,stretchX:p,stretchY:y,content:b}={}){if(this._lazyInitEmptyStyle(),t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){const{width:E,height:D,data:L}=o.q.getImageData(t);this.style.addImage(l,{data:new o.r({width:E,height:D},L),pixelRatio:n,stretchX:p,stretchY:y,content:b,sdf:c,version:0,usvg:!1})}else if(void 0===t.width||void 0===t.height)this.fire(new o.y(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:E,height:D}=t,L=t;this.style.addImage(l,{data:new o.r({width:E,height:D},new Uint8Array(L.data)),pixelRatio:n,stretchX:p,stretchY:y,content:b,sdf:c,usvg:!1,version:0,userImage:L}),L.onAdd&&L.onAdd(this,l)}}updateImage(l,t){this._lazyInitEmptyStyle();const n=this.style.getImage(l);if(!n)return void this.fire(new o.y(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const c=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?o.q.getImageData(t):t,{width:p,height:y,data:b}=c;if(void 0===p||void 0===y)return void this.fire(new o.y(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(p!==(n.usvg?n.icon.usvg_tree.width:n.data.width)||y!==(n.usvg?n.icon.usvg_tree.height:n.data.height))return void this.fire(new o.y(new Error(`The width and height of the updated image (${p}, ${y})\n                must be that same as the previous version of the image\n                (${n.data.width}, ${n.data.height})`)));const E=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap);let D=!1;n.usvg?(n.data=new o.r({width:p,height:y},new Uint8Array(b)),n.usvg=!1,n.icon=void 0,D=!0):n.data.replace(b,E),this.style.updateImage(l,n,D)}hasImage(l){return l?!!this.style&&!!this.style.getImage(l):(this.fire(new o.y(new Error("Missing required image id"))),!1)}removeImage(l){this.style.removeImage(l)}loadImage(l,t){o.o(this._requestManager.transformRequest(l,o.R.Image),(n,c)=>{t(n,c instanceof HTMLImageElement?o.q.getImageData(c):c)})}listImages(){return this.style.listImages()}addModel(l,t){this._lazyInitEmptyStyle(),this.style.addModel(l,t)}hasModel(l){return l?this.style.hasModel(l):(this.fire(new o.y(new Error("Missing required model id"))),!1)}removeModel(l){this.style.removeModel(l)}listModels(){return this.style.listModels()}addLayer(l,t){return this._isValidId(l.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(l,t),this._update(!0)):this}getSlot(l){const t=this.getLayer(l);return t&&t.slot||null}setSlot(l,t){return this.style.setSlot(l,t),this.style.mergeLayers(),this._update(!0)}addImport(l,t){return this.style.addImport(l,t),this}updateImport(l,t){return"string"!=typeof t&&t.id!==l?(this.removeImport(l),this.addImport(t)):(this.style.updateImport(l,t),this._update(!0))}removeImport(l){return this.style.removeImport(l),this}moveImport(l,t){return this.style.moveImport(l,t),this._update(!0)}moveLayer(l,t){return this._isValidId(l)?(this.style.moveLayer(l,t),this._update(!0)):this}removeLayer(l){return this._isValidId(l)?(this.style.removeLayer(l),this._update(!0)):this}getLayer(l){if(!this._isValidId(l))return null;const t=this.style.getOwnLayer(l);return t?"custom"===t.type?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(l,t,n){return this._isValidId(l)?(this.style.setLayerZoomRange(l,t,n),this._update(!0)):this}setFilter(l,t,n={}){return this._isValidId(l)?(this.style.setFilter(l,t,n),this._update(!0)):this}getFilter(l){return this._isValidId(l)?this.style.getFilter(l):null}setPaintProperty(l,t,n,c={}){return this._isValidId(l)?(this.style.setPaintProperty(l,t,n,c),this._update(!0)):this}getPaintProperty(l,t){return this._isValidId(l)?this.style.getPaintProperty(l,t):null}setLayoutProperty(l,t,n,c={}){return this._isValidId(l)?(this.style.setLayoutProperty(l,t,n,c),this._update(!0)):this}getLayoutProperty(l,t){return this._isValidId(l)?this.style.getLayoutProperty(l,t):null}getSchema(l){return this.style.getSchema(l)}setSchema(l,t){return this.style.setSchema(l,t),this._update(!0)}getConfig(l){return this.style.getConfig(l)}setConfig(l,t){return this.style.setConfig(l,t),this._update(!0)}getConfigProperty(l,t){return this.style.getConfigProperty(l,t)}setConfigProperty(l,t,n){return this.style.setConfigProperty(l,t,n),this._update(!0)}getFeaturesetDescriptors(l){return this.style.getFeaturesetDescriptors(l)}setLights(l){if(this._lazyInitEmptyStyle(),l&&1===l.length&&"flat"===l[0].type){const t=l[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(l),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const l=this.style.getLights()||[];return 0===l.length&&l.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),l}setLight(l,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:l}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(l){return this._lazyInitEmptyStyle(),!l&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(l),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(l){return this._lazyInitEmptyStyle(),this.style.setFog(l),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(l){return this._lazyInitEmptyStyle(),this.style.setSnow(l),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(l){return this._lazyInitEmptyStyle(),this.style.setRain(l),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(l){return this._lazyInitEmptyStyle(),this.style.setColorTheme(l),this._update(!0)}setImportColorTheme(l,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(l,t),this._update(!0)}setCamera(l){return this.style.setCamera(l),this._triggerCameraUpdate(l)}_triggerCameraUpdate(l){return this._update(this.transform.setOrthographicProjectionAtLowPitch("orthographic"===l["camera-projection"]))}getCamera(){return this.style.camera}_queryFogOpacity(l){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(o.bO.convert(l),this.transform):0}setFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.setFeatureState(l,t),this._update())}removeFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.removeFeatureState(l,t),this._update())}getFeatureState(l){return l.source&&!this._isValidId(l.source)?null:this.style.getFeatureState(l)}_updateContainerDimensions(){if(!this._container)return;const l=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let n,c,p,y=this._container;for(;y&&(!c||!p);){const b=window.getComputedStyle(y).transform;b&&"none"!==b&&(n=b.match(/matrix.*\((.+)\)/)[1].split(", "),n[0]&&"0"!==n[0]&&"1"!==n[0]&&(c=n[0]),n[3]&&"0"!==n[3]&&"1"!==n[3]&&(p=n[3])),y=y.parentElement}this._containerWidth=c?Math.abs(l/c):l,this._containerHeight=p?Math.abs(t/p):t}_detectMissingCSS(){"rgb(250, 128, 114)"!==window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&o.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const l=this._container;l.classList.add("mapboxgl-map"),(this._missingCSSCanary=qi("div","mapboxgl-canary",l)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=qi("div","mapboxgl-canvas-container",l);this._canvas=qi("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const n=this._controlContainer=qi("div","mapboxgl-control-container",l),c=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach(p=>{c[p]=qi("div",`mapboxgl-ctrl-${p}`,n)}),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(l,t){const n=o.q.devicePixelRatio||1;this._canvas.width=n*Math.ceil(l),this._canvas.height=n*Math.ceil(t),this._canvas.style.width=`${l}px`,this._canvas.style.height=`${t}px`}_addMarker(l){this._markers.push(l)}_removeMarker(l){const t=this._markers.indexOf(l);-1!==t&&this._markers.splice(t,1)}_addPopup(l){this._popups.push(l)}_removePopup(l){const t=this._popups.indexOf(l);-1!==t&&this._popups.splice(t,1)}_setupPainter(){const l=o.l({},Oi.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",l);t?(Oa(t,!0),this.painter=new uu(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp),this.on("data",n=>{"source"===n.dataType&&this.painter.setTileLoadedFlag(!0)}),o.m.testSupport(t)):this.fire(new o.y(new Error("Failed to initialize WebGL")))}_contextLost(l){l.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new o.z("webglcontextlost",{originalEvent:l}))}_contextRestored(l){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style.reloadModels(),this.style.clearSources(),this._update(),this.fire(new o.z("webglcontextrestored",{originalEvent:l}))}_onMapScroll(l){if(l.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(l){return this.style?(this._styleDirty=this._styleDirty||l,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(l){return this._update(),this._renderTaskQueue.add(l)}_cancelRenderFrame(l){this._renderTaskQueue.remove(l)}_requestDomTask(l){!this.loaded()||this.loaded()&&!this.isMoving()?l():this._domRenderTaskQueue.add(l)}_render(l){let t;this.fire(new o.z("renderstart")),++this._frameId;const n=this.painter.context.extTimerQuery,c=o.q.now(),p=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=p.createQuery(),p.beginQuery(n.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(l),this._domRenderTaskQueue.run(l),this._removed)return;this._updateProjectionTransition();const y=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const L=this.transform.zoom,k=this.transform.pitch,N=o.q.now(),V=new o.a8(L,{now:N,fadeDuration:y,pitch:k,transition:this.style.transition});this.style.update(V)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let b=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),b=this._updateAverageElevation(c),this.style.updateSources(this.transform),this._forceMarkerAndPopupUpdate()):b=this._updateAverageElevation(c);const E=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,y,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),E&&(this._placementDirty=E.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:y,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new o.z("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,Qi.mark(jr.load),this.fire(new o.z("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const L=o.q.now()-c;p.endQuery(n.TIME_ELAPSED_EXT),setTimeout(()=>{const k=p.getQueryParameter(t,p.QUERY_RESULT)/1e6;p.deleteQuery(t),this.fire(new o.z("gpu-timing-frame",{cpuTime:L,gpuTime:k}))},50)}if(this.listens("gpu-timing-layer")){const L=this.painter.collectGpuTimers();setTimeout(()=>{const k=this.painter.queryGpuTimers(L);this.fire(new o.z("gpu-timing-layer",{layerTimes:k}))},50)}if(this.listens("gpu-timing-deferred-render")){const L=this.painter.collectDeferredRenderGpuQueries();setTimeout(()=>{const k=this.painter.queryGpuTimeDeferredRender(L);this.fire(new o.z("gpu-timing-deferred-render",{gpuTime:k}))},50)}const D=this._sourcesDirty||this._styleDirty||this._placementDirty||b;if(D||this._repaint)this.triggerRepaint();else{const L=this.idle();if(L&&(b=this._updateAverageElevation(c,!0)),b)this.triggerRepaint();else if(this._triggerFrame(!1),L&&(this.fire(new o.z("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const k=this._calculateSpeedIndex();this.fire(new o.z("speedindexcompleted",{speedIndex:k})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||D||(this._fullyLoaded=!0,Qi.mark(jr.fullLoad),this._performanceMetricsCollection&&Es(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(l){for(const t of this._markers)l&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!l||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(l,t=!1){const n=p=>(this.transform.averageElevation=p,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&n(0);const c=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(c||(t||l-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(l)){const p=this.transform.averageElevation;let y=this.transform.sampleAverageElevation();null!=this.transform.elevation&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(y)?y=0:this._averageElevationLastSampledAt=l;const b=Math.abs(p-y);if(b>1){if(this._isInitialLoad||c)return this._averageElevation.jumpTo(y),n(y);this._averageElevation.easeTo(y,l,300)}else if(b>1e-4)return this._averageElevation.jumpTo(y),n(y)}return!!this._averageElevation.isEasing(l)&&n(this._averageElevation.getValue(l))}_authenticate(){Ie(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,l=>{if(l&&(l.message===Zo||401===l.status)){const t=this.painter.context.gl;Oa(t,!1),this._logoControl instanceof Kr&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new o.y(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}}),mh(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{})}_postStyleLoadEvent(){this.style.globalId&&Xo(this._requestManager._customAccessToken,{map:this,skuToken:this._requestManager._skuToken,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const l=this._isDragging();this.painter.updateTerrain(this.style,l)}_calculateSpeedIndex(){const l=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const n=this.painter.context.gl,c=n.createFramebuffer();function p(y){n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,y,0);const b=new Uint8Array(n.drawingBufferWidth*n.drawingBufferHeight*4);return n.readPixels(0,0,n.drawingBufferWidth,n.drawingBufferHeight,n.RGBA,n.UNSIGNED_BYTE,b),b}return n.bindFramebuffer(n.FRAMEBUFFER,c),this._canvasPixelComparison(p(l),t.canvasCopies.map(p),t.timeStamps)}_canvasPixelComparison(l,t,n){let c=n[1]-n[0];const p=l.length/4;for(let y=0;y<t.length;y++){const b=t[y];let E=0;for(let D=0;D<b.length;D+=4)b[D]===l[D]&&b[D+1]===l[D+1]&&b[D+2]===l[D+2]&&b[D+3]===l[D+3]&&(E+=1);c+=(n[y+2]-n[y+1])*(1-E/p)}return c}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const l=this.painter.context.gl.getExtension("WEBGL_lose_context");l&&l.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),ka.delete(this.painter.context.gl),Ws.remove(),ti.remove(),this._removed=!0,this.fire(new o.z("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(l){this._renderNextFrame=this._renderNextFrame||l,this.style&&!this._frame&&(this._frame=o.q.frame(t=>{const n=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,n&&this._render(t)}))}_preloadTiles(l){const t=this.style?this.style.getSourceCaches():[];return o.bl(t,(n,c)=>n._preloadTiles(l,c),()=>{this.triggerRepaint()}),this}_onWindowOnline(){this._update()}_onWindowResize(l){this._trackResize&&this.resize({originalEvent:l})._update()}_onVisibilityChange(){"hidden"===document.visibilityState&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(l){this._showTileBoundaries!==l&&(this._showTileBoundaries=l,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(l){this._showParseStatus!==l&&(this._showParseStatus=l,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(l){this._showTerrainWireframe!==l&&(this._showTerrainWireframe=l,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(l){this._showLayers2DWireframe!==l&&(this._showLayers2DWireframe=l,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(l){this._showLayers3DWireframe!==l&&(this._showLayers3DWireframe=l,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(l){this._speedIndexTiming!==l&&(this._speedIndexTiming=l,this._update())}get showPadding(){return!!this._showPadding}set showPadding(l){this._showPadding!==l&&(this._showPadding=l,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(l){this._showCollisionBoxes!==l&&(this._showCollisionBoxes=l,this._tp.refreshUI(),l?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(l){this._showOverdrawInspector!==l&&(this._showOverdrawInspector=l,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(l){this._repaint!==l&&(this._repaint=l,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(l){this._vertices=l,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(l){this._showTileAABBs!==l&&(this._showTileAABBs=l,this._tp.refreshUI(),l&&this._update())}_setCacheLimits(l,t){o.dG(l,t)}get version(){return er}},NavigationControl:class{constructor(l={}){this.options=o.l({},$d,l),this._container=qi("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",t=>t.preventDefault()),this.options.showZoom&&(o.aP(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",t=>{this._map&&this._map.zoomIn({},{originalEvent:t})}),qi("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",t=>{this._map&&this._map.zoomOut({},{originalEvent:t})}),qi("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(o.aP(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",t=>{const n=this._map;n&&(this.options.visualizePitch?n.resetNorthPitch({},{originalEvent:t}):n.resetNorth({},{originalEvent:t}))}),this._compassIcon=qi("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const l=this._map;if(!l)return;const t=l.getZoom(),n=t===l.getMaxZoom(),c=t===l.getMinZoom();this._zoomInButton.disabled=n,this._zoomOutButton.disabled=c,this._zoomInButton.setAttribute("aria-disabled",n.toString()),this._zoomOutButton.setAttribute("aria-disabled",c.toString())}_rotateCompassArrow(){const l=this._map;if(!l)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(l.transform.pitch*(Math.PI/180)),.5)}) rotateX(${l.transform.pitch}deg) rotateZ(${l.transform.angle*(180/Math.PI)}deg)`:`rotate(${l.transform.angle*(180/Math.PI)}deg)`;l._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=t)})}onAdd(l){return this._map=l,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),l.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&l.on("pitch",this._rotateCompassArrow),l.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Zd(l,this._compass,this.options.visualizePitch)),this._container}onRemove(){const l=this._map;l&&(this._container.remove(),this.options.showZoom&&l.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&l.off("pitch",this._rotateCompassArrow),l.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(l,t){const n=qi("button",l,this._container);return n.type="button",n.addEventListener("click",t),n}_setButtonTitle(l,t){if(!this._map)return;const n=this._map._getUIString(`NavigationControl.${t}`);l.setAttribute("aria-label",n),l.firstElementChild&&l.firstElementChild.setAttribute("title",n)}},GeolocateControl:class extends o.E{constructor(l={}){super();const t=navigator.geolocation;this.options=o.l({geolocation:t},fr,l),o.aP(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=Jc(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(l){return this._map=l,this._container=qi("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){void 0!==this._geolocationWatchID&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(l){const t=(n=!!this.options.geolocation)=>{this._supportsGeolocation=n,l(n)};void 0!==this._supportsGeolocation?l(this._supportsGeolocation):void 0!==navigator.permissions?navigator.permissions.query({name:"geolocation"}).then(n=>t("denied"!==n.state)).catch(()=>t()):t()}_isOutOfMapMaxBounds(l){const t=this._map.getMaxBounds(),n=l.coords;return!!t&&(n.longitude<t.getWest()||n.longitude>t.getEast()||n.latitude<t.getSouth()||n.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(l){if(this._map){if(this._isOutOfMapMaxBounds(l))return this._setErrorState(),this.fire(new o.z("outofmaxbounds",l)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=l,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(l),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(l),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new o.z("geolocate",l)),this._finish()}}_updateCamera(l){const t=new o.bO(l.coords.longitude,l.coords.latitude),n=l.coords.accuracy,c=this._map.getBearing(),p=o.l({bearing:c},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(n),p,{geolocateSource:!0})}_updateMarker(l){if(l){const t=new o.bO(l.coords.longitude,l.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=l.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const l=this._map.transform,t=o.bH(1,l._center.lat)*l.worldSize,n=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${n}px`,this._circleElement.style.height=`${n}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(l){if(this._map){if(this.options.trackUserLocation)if(1===l.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===l.code&&this._noTimeout)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new o.z("error",l)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(l){if(void 0!==this._map){if(this._container.addEventListener("contextmenu",t=>t.preventDefault()),this._geolocateButton=qi("button","mapboxgl-ctrl-geolocate",this._container),qi("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",!1===l){o.w("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=qi("div","mapboxgl-user-location"),this._dotElement.appendChild(qi("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(qi("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new cs({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=qi("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new cs({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||"ACTIVE_LOCK"!==this._watchState||t.originalEvent&&"resize"===t.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new o.z("trackuserlocationend")))})}}_onDeviceOrientation(l){this._userLocationDotMarker&&(l.webkitCompassHeading?this._heading=l.webkitCompassHeading:!0===l.absolute&&(this._heading=-1*l.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return o.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new o.z("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new o.z("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new o.z("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let l;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(l={maximumAge:6e5,timeout:0},this._noTimeout=!0):(l=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,l),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const l=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(t=>{"granted"===t&&l()}).catch(console.error):l()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:nh,ScaleControl:class{constructor(l={}){this.options=o.l({},Vr,l),this._isNumberFormatSupported=function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}}(),o.aP(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const l=this.options.maxWidth||100,t=this._map,n=t._containerHeight/2,c=t._containerWidth/2-l/2,p=t.unproject([c,n]),y=t.unproject([c+l,n]),b=p.distanceTo(y);if("imperial"===this.options.unit){const E=3.2808*b;E>5280?this._setScale(l,E/5280,"mile"):this._setScale(l,E,"foot")}else"nautical"===this.options.unit?this._setScale(l,b/1852,"nautical-mile"):b>=1e3?this._setScale(l,b/1e3,"kilometer"):this._setScale(l,b,"meter")}_setScale(l,t,n){this._map._requestDomTask(()=>{const c=function(y){const b=Math.pow(10,`${Math.floor(y)}`.length-1);let E=y/b;return E=E>=10?10:E>=5?5:E>=3?3:E>=2?2:E>=1?1:function(D){const L=Math.pow(10,Math.ceil(-Math.log(D)/Math.LN10));return Math.round(D*L)/L}(E),b*E}(t),p=c/t;this._container.innerHTML=this._isNumberFormatSupported&&"nautical-mile"!==n?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:n}).format(c):`${c}&nbsp;${$n[n]}`,this._container.style.width=l*p+"px"})}onAdd(l){return this._map=l,this._language=l.getLanguage(),this._container=qi("div","mapboxgl-ctrl mapboxgl-ctrl-scale",l.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(l){this._language=l,this._update()}setUnit(l){this.options.unit=l,this._update()}},FullscreenControl:class{constructor(l={}){this._fullscreen=!1,l&&l.container&&(l.container instanceof HTMLElement?this._container=l.container:o.w("Full screen control 'container' must be a DOM element.")),o.aP(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(l){return this._map=l,this._container||(this._container=this._map.getContainer()),this._controlContainer=qi("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",o.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const l=this._fullscreenButton=qi("button","mapboxgl-ctrl-fullscreen",this._controlContainer);qi("span","mapboxgl-ctrl-icon",l).setAttribute("aria-hidden","true"),l.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const l=this._getTitle();this._fullscreenButton.setAttribute("aria-label",l),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",l)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},Popup:class extends o.E{constructor(l){super(),this.options=o.l(Object.create(pd),l),o.aP(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(l&&l.className?l.className.trim().split(/\s+/):[])}addTo(l){return this._map&&this.remove(),this._map=l,this.options.closeOnClick&&l.on("preclick",this._onClose),this.options.closeOnMove&&l.on("move",this._onClose),l.on("remove",this.remove),this._update(),l._addPopup(this),this._focusFirstElement(),this._trackPointer?(l.on("mousemove",this._onMouseEvent),l.on("mouseup",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")):l.on("move",this._update),this.fire(new o.z("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const l=this._map;return l&&(l.off("move",this._update),l.off("move",this._onClose),l.off("preclick",this._onClose),l.off("click",this._onClose),l.off("remove",this.remove),l.off("mousemove",this._onMouseEvent),l.off("mouseup",this._onMouseEvent),l.off("drag",this._onMouseEvent),l._canvasContainer&&l._canvasContainer.classList.remove("mapboxgl-track-pointer"),l._removePopup(this),this._map=void 0),this.fire(new o.z("close")),this}getLngLat(){return this._lngLat}setLngLat(l){this._lngLat=o.bO.convert(l),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const l=this._map;return l&&(l.off("move",this._update),l.on("mousemove",this._onMouseEvent),l.on("drag",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(l){return this.setDOMContent(document.createTextNode(l))}setHTML(l){const t=document.createDocumentFragment(),n=document.createElement("body");let c;for(n.innerHTML=l;c=n.firstChild,c;)t.appendChild(c);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(l){return this.options.maxWidth=l,this._update(),this}setDOMContent(l){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=qi("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(l),this.options.closeButton){const n=this._closeButton=qi("button","mapboxgl-popup-close-button",t);n.type="button",n.setAttribute("aria-label","Close popup"),n.innerHTML='<span aria-hidden="true">&#215;</span>',n.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(l){return this._classList.add(l),this._updateClassList(),this}removeClassName(l){return this._classList.delete(l),this._updateClassList(),this}setOffset(l){return this.options.offset=l,this._update(),this}toggleClassName(l){let t;return this._classList.delete(l)?t=!1:(this._classList.add(l),t=!0),this._updateClassList(),t}_onMouseEvent(l){this._update(l.point)}_getAnchor(l){if(this.options.anchor)return this.options.anchor;const t=this._map,n=this._container,c=this._pos;if(!t||!n||!c)return"bottom";const p=n.offsetWidth,y=n.offsetHeight,b=c.x<p/2,E=c.x>t.transform.width-p/2;if(c.y+l<y)return b?"top-left":E?"top-right":"top";if(c.y>t.transform.height-y){if(b)return"bottom-left";if(E)return"bottom-right"}return b?"left":E?"right":"bottom"}_updateClassList(){const l=this._container;if(!l)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),l.className=t.join(" ")}_update(l){const t=this._map,n=this._content;if(!t||!this._lngLat&&!this._trackPointer||!n)return;let c=this._container;if(c||(c=this._container=qi("div","mapboxgl-popup",t.getContainer()),this._tip=qi("div","mapboxgl-popup-tip",c),c.appendChild(n)),this.options.maxWidth&&c.style.maxWidth!==this.options.maxWidth&&(c.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=yl(this._lngLat,this._pos,t.transform)),!this._trackPointer||l){const p=this._pos=this._trackPointer&&l instanceof o.P?l:t.project(this._lngLat),y=Tu(this.options.offset),b=this._anchor=this._getAnchor(y.y),E=Tu(this.options.offset,b),D=p.add(E).round();t._requestDomTask(()=>{this._container&&b&&(this._container.style.transform=`${Us[b]} translate(${D.x}px,${D.y}px)`)})}if(!this._marker&&t._showingGlobe()){const p=o.dH(t.transform,this._lngLat)?0:1;this._setOpacity(p)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const l=this._container.querySelector(_n);l&&l.focus()}_onClose(){this.remove()}_setOpacity(l){this._container&&(this._container.style.opacity=`${l}`),this._content&&(this._content.style.pointerEvents=l?"auto":"none")}},Marker:cs,Style:os,LngLat:o.bO,LngLatBounds:o.az,Point:o.P,MercatorCoordinate:o.aa,FreeCameraOptions:Ha,Evented:o.E,config:o.e,prewarm:o.dM,clearPrewarmedResources:o.dN,get accessToken(){return o.e.ACCESS_TOKEN},set accessToken(l){o.e.ACCESS_TOKEN=l},get baseApiUrl(){return o.e.API_URL},set baseApiUrl(l){o.e.API_URL=l},get workerCount(){return o.dO.workerCount},set workerCount(l){o.dO.workerCount=l},get maxParallelImageRequests(){return o.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(l){o.e.MAX_PARALLEL_IMAGE_REQUESTS=l},clearStorage(l){o.dP(l)},get workerUrl(){return o.dQ.workerUrl},set workerUrl(l){o.dQ.workerUrl=l},get workerClass(){return o.dQ.workerClass},set workerClass(l){o.dQ.workerClass=l},get workerParams(){return o.dQ.workerParams},set workerParams(l){o.dQ.workerParams=l},get dracoUrl(){return o.dR()},set dracoUrl(l){o.dS(l)},get meshoptUrl(){return o.dT()},set meshoptUrl(l){o.dU(l)},setNow:o.q.setNow,restoreNow:o.q.restoreNow}}),Cd}()},6789:(Im,mc,us)=>{"use strict";us.r(mc),us.d(mc,{MapContainerComponent:()=>Pp});var Cd=us(9885),vt=us(4020),Mp=us(177),o=us(1099),er=us(1626);let jr=(()=>{class m{API_URL="https://planitgoeco-backend.onrender.com/api/itineraries";http=(0,vt.WQX)(er.Qq);getEmissions(d,_,v){return this.http.get(`${this.API_URL}/${d.toLowerCase()}/${_}/emissions/${v}`)}static \u0275fac=function(_){return new(_||m)};static \u0275prov=vt.jDH({token:m,factory:m.\u0275fac,providedIn:"root"})}return m})();var Qi=us(1247);function Xn(m){return m+.5|0}const yr=(m,f,d)=>Math.max(Math.min(m,d),f);function Oi(m){return yr(Xn(2.55*m),0,255)}function Yn(m){return yr(Xn(255*m),0,255)}function Si(m){return yr(Xn(m/2.55)/100,0,1)}function uo(m){return yr(Xn(100*m),0,100)}const xr={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,A:10,B:11,C:12,D:13,E:14,F:15,a:10,b:11,c:12,d:13,e:14,f:15},gi=[..."0123456789ABCDEF"],$o=m=>gi[15&m],Da=m=>gi[(240&m)>>4]+gi[15&m],Xt=m=>(240&m)>>4==(15&m);const za=/^(hsla?|hwb|hsv)\(\s*([-+.e\d]+)(?:deg)?[\s,]+([-+.e\d]+)%[\s,]+([-+.e\d]+)%(?:[\s,]+([-+.e\d]+)(%)?)?\s*\)$/;function Zo(m,f,d){const _=f*Math.min(d,1-d),v=(I,z=(I+m/30)%12)=>d-_*Math.max(Math.min(z-3,9-z,1),-1);return[v(0),v(8),v(4)]}function _c(m,f,d){const _=(v,I=(v+m/60)%6)=>d-d*f*Math.max(Math.min(I,4-I,1),0);return[_(5),_(3),_(1)]}function oi(m,f,d){const _=Zo(m,1,.5);let v;for(f+d>1&&(v=1/(f+d),f*=v,d*=v),v=0;v<3;v++)_[v]*=1-f-d,_[v]+=f;return _}function ds(m){const d=m.r/255,_=m.g/255,v=m.b/255,I=Math.max(d,_,v),z=Math.min(d,_,v),R=(I+z)/2;let F,H,K;return I!==z&&(K=I-z,H=R>.5?K/(2-I-z):K/(I+z),F=function Mr(m,f,d,_,v){return m===v?(f-d)/_+(f<d?6:0):f===v?(d-m)/_+2:(m-f)/_+4}(d,_,v,K,I),F=60*F+.5),[0|F,H||0,R]}function po(m,f,d,_){return(Array.isArray(f)?m(f[0],f[1],f[2]):m(f,d,_)).map(Yn)}function ci(m,f,d){return po(Zo,m,f,d)}function Hs(m){return(m%360+360)%360}const Xo={x:"dark",Z:"light",Y:"re",X:"blu",W:"gr",V:"medium",U:"slate",A:"ee",T:"ol",S:"or",B:"ra",C:"lateg",D:"ights",R:"in",Q:"turquois",E:"hi",P:"ro",O:"al",N:"le",M:"de",L:"yello",F:"en",K:"ch",G:"arks",H:"ea",I:"ightg",J:"wh"},Yo={OiceXe:"f0f8ff",antiquewEte:"faebd7",aqua:"ffff",aquamarRe:"7fffd4",azuY:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"0",blanKedOmond:"ffebcd",Xe:"ff",XeviTet:"8a2be2",bPwn:"a52a2a",burlywood:"deb887",caMtXe:"5f9ea0",KartYuse:"7fff00",KocTate:"d2691e",cSO:"ff7f50",cSnflowerXe:"6495ed",cSnsilk:"fff8dc",crimson:"dc143c",cyan:"ffff",xXe:"8b",xcyan:"8b8b",xgTMnPd:"b8860b",xWay:"a9a9a9",xgYF:"6400",xgYy:"a9a9a9",xkhaki:"bdb76b",xmagFta:"8b008b",xTivegYF:"556b2f",xSange:"ff8c00",xScEd:"9932cc",xYd:"8b0000",xsOmon:"e9967a",xsHgYF:"8fbc8f",xUXe:"483d8b",xUWay:"2f4f4f",xUgYy:"2f4f4f",xQe:"ced1",xviTet:"9400d3",dAppRk:"ff1493",dApskyXe:"bfff",dimWay:"696969",dimgYy:"696969",dodgerXe:"1e90ff",fiYbrick:"b22222",flSOwEte:"fffaf0",foYstWAn:"228b22",fuKsia:"ff00ff",gaRsbSo:"dcdcdc",ghostwEte:"f8f8ff",gTd:"ffd700",gTMnPd:"daa520",Way:"808080",gYF:"8000",gYFLw:"adff2f",gYy:"808080",honeyMw:"f0fff0",hotpRk:"ff69b4",RdianYd:"cd5c5c",Rdigo:"4b0082",ivSy:"fffff0",khaki:"f0e68c",lavFMr:"e6e6fa",lavFMrXsh:"fff0f5",lawngYF:"7cfc00",NmoncEffon:"fffacd",ZXe:"add8e6",ZcSO:"f08080",Zcyan:"e0ffff",ZgTMnPdLw:"fafad2",ZWay:"d3d3d3",ZgYF:"90ee90",ZgYy:"d3d3d3",ZpRk:"ffb6c1",ZsOmon:"ffa07a",ZsHgYF:"20b2aa",ZskyXe:"87cefa",ZUWay:"778899",ZUgYy:"778899",ZstAlXe:"b0c4de",ZLw:"ffffe0",lime:"ff00",limegYF:"32cd32",lRF:"faf0e6",magFta:"ff00ff",maPon:"800000",VaquamarRe:"66cdaa",VXe:"cd",VScEd:"ba55d3",VpurpN:"9370db",VsHgYF:"3cb371",VUXe:"7b68ee",VsprRggYF:"fa9a",VQe:"48d1cc",VviTetYd:"c71585",midnightXe:"191970",mRtcYam:"f5fffa",mistyPse:"ffe4e1",moccasR:"ffe4b5",navajowEte:"ffdead",navy:"80",Tdlace:"fdf5e6",Tive:"808000",TivedBb:"6b8e23",Sange:"ffa500",SangeYd:"ff4500",ScEd:"da70d6",pOegTMnPd:"eee8aa",pOegYF:"98fb98",pOeQe:"afeeee",pOeviTetYd:"db7093",papayawEp:"ffefd5",pHKpuff:"ffdab9",peru:"cd853f",pRk:"ffc0cb",plum:"dda0dd",powMrXe:"b0e0e6",purpN:"800080",YbeccapurpN:"663399",Yd:"ff0000",Psybrown:"bc8f8f",PyOXe:"4169e1",saddNbPwn:"8b4513",sOmon:"fa8072",sandybPwn:"f4a460",sHgYF:"2e8b57",sHshell:"fff5ee",siFna:"a0522d",silver:"c0c0c0",skyXe:"87ceeb",UXe:"6a5acd",UWay:"708090",UgYy:"708090",snow:"fffafa",sprRggYF:"ff7f",stAlXe:"4682b4",tan:"d2b48c",teO:"8080",tEstN:"d8bfd8",tomato:"ff6347",Qe:"40e0d0",viTet:"ee82ee",JHt:"f5deb3",wEte:"ffffff",wEtesmoke:"f5f5f5",Lw:"ffff00",LwgYF:"9acd32"};let Ws;const ka=/^rgba?\(\s*([-+.\d]+)(%)?[\s,]+([-+.e\d]+)(%)?[\s,]+([-+.e\d]+)(%)?(?:[\s,/]+([-+.e\d]+)(%)?)?\s*\)$/,pt=m=>m<=.0031308?12.92*m:1.055*Math.pow(m,1/2.4)-.055,Fn=m=>m<=.04045?m/12.92:Math.pow((m+.055)/1.055,2.4);function $s(m,f,d){if(m){let _=ds(m);_[f]=Math.max(0,Math.min(_[f]+_[f]*d,0===f?360:1)),_=ci(_),m.r=_[0],m.g=_[1],m.b=_[2]}}function yi(m,f){return m&&Object.assign(f||{},m)}function Hn(m){var f={r:0,g:0,b:0,a:255};return Array.isArray(m)?m.length>=3&&(f={r:m[0],g:m[1],b:m[2],a:255},m.length>3&&(f.a=Yn(m[3]))):(f=yi(m,{r:0,g:0,b:0,a:1})).a=Yn(f.a),f}function is(m){return"r"===m.charAt(0)?function Oa(m){const f=ka.exec(m);let _,v,I,d=255;if(f){if(f[7]!==_){const z=+f[7];d=f[8]?Oi(z):yr(255*z,0,255)}return _=+f[1],v=+f[3],I=+f[5],_=255&(f[2]?Oi(_):yr(_,0,255)),v=255&(f[4]?Oi(v):yr(v,0,255)),I=255&(f[6]?Oi(I):yr(I,0,255)),{r:_,g:v,b:I,a:d}}}(m):function ti(m){const f=za.exec(m);let _,d=255;if(!f)return;f[5]!==_&&(d=f[6]?Oi(+f[5]):Yn(+f[5]));const v=Hs(+f[2]),I=+f[3]/100,z=+f[4]/100;return _="hwb"===f[1]?function qs(m,f,d){return po(oi,m,f,d)}(v,I,z):"hsv"===f[1]?function Ra(m,f,d){return po(_c,m,f,d)}(v,I,z):ci(v,I,z),{r:_[0],g:_[1],b:_[2],a:d}}(m)}class Gr{constructor(f){if(f instanceof Gr)return f;const d=typeof f;let _;"object"===d?_=Hn(f):"string"===d&&(_=function Gs(m){var d,f=m.length;return"#"===m[0]&&(4===f||5===f?d={r:255&17*xr[m[1]],g:255&17*xr[m[2]],b:255&17*xr[m[3]],a:5===f?17*xr[m[4]]:255}:(7===f||9===f)&&(d={r:xr[m[1]]<<4|xr[m[2]],g:xr[m[3]]<<4|xr[m[4]],b:xr[m[5]]<<4|xr[m[6]],a:9===f?xr[m[7]]<<4|xr[m[8]]:255})),d}(f)||function Ie(m){Ws||(Ws=function Es(){const m={},f=Object.keys(Yo),d=Object.keys(Xo);let _,v,I,z,R;for(_=0;_<f.length;_++){for(z=R=f[_],v=0;v<d.length;v++)I=d[v],R=R.replace(I,Xo[I]);I=parseInt(Yo[z],16),m[R]=[I>>16&255,I>>8&255,255&I]}return m}(),Ws.transparent=[0,0,0,0]);const f=Ws[m.toLowerCase()];return f&&{r:f[0],g:f[1],b:f[2],a:4===f.length?f[3]:255}}(f)||is(f)),this._rgb=_,this._valid=!!_}get valid(){return this._valid}get rgb(){var f=yi(this._rgb);return f&&(f.a=Si(f.a)),f}set rgb(f){this._rgb=Hn(f)}rgbString(){return this._valid?function Ko(m){return m&&(m.a<255?`rgba(${m.r}, ${m.g}, ${m.b}, ${Si(m.a)})`:`rgb(${m.r}, ${m.g}, ${m.b})`)}(this._rgb):void 0}hexString(){return this._valid?function Qt(m){var f=(m=>Xt(m.r)&&Xt(m.g)&&Xt(m.b)&&Xt(m.a))(m)?$o:Da;return m?"#"+f(m.r)+f(m.g)+f(m.b)+((m,f)=>m<255?f(m):"")(m.a,f):void 0}(this._rgb):void 0}hslString(){return this._valid?function La(m){if(!m)return;const f=ds(m),d=f[0],_=uo(f[1]),v=uo(f[2]);return m.a<255?`hsla(${d}, ${_}%, ${v}%, ${Si(m.a)})`:`hsl(${d}, ${_}%, ${v}%)`}(this._rgb):void 0}mix(f,d){if(f){const _=this.rgb,v=f.rgb;let I;const z=d===I?.5:d,R=2*z-1,F=_.a-v.a,H=((R*F==-1?R:(R+F)/(1+R*F))+1)/2;I=1-H,_.r=255&H*_.r+I*v.r+.5,_.g=255&H*_.g+I*v.g+.5,_.b=255&H*_.b+I*v.b+.5,_.a=z*_.a+(1-z)*v.a,this.rgb=_}return this}interpolate(f,d){return f&&(this._rgb=function Er(m,f,d){const _=Fn(Si(m.r)),v=Fn(Si(m.g)),I=Fn(Si(m.b));return{r:Yn(pt(_+d*(Fn(Si(f.r))-_))),g:Yn(pt(v+d*(Fn(Si(f.g))-v))),b:Yn(pt(I+d*(Fn(Si(f.b))-I))),a:m.a+d*(f.a-m.a)}}(this._rgb,f._rgb,d)),this}clone(){return new Gr(this.rgb)}alpha(f){return this._rgb.a=Yn(f),this}clearer(f){return this._rgb.a*=1-f,this}greyscale(){const f=this._rgb,d=Xn(.3*f.r+.59*f.g+.11*f.b);return f.r=f.g=f.b=d,this}opaquer(f){return this._rgb.a*=1+f,this}negate(){const f=this._rgb;return f.r=255-f.r,f.g=255-f.g,f.b=255-f.b,this}lighten(f){return $s(this._rgb,2,f),this}darken(f){return $s(this._rgb,2,-f),this}saturate(f){return $s(this._rgb,1,f),this}desaturate(f){return $s(this._rgb,1,-f),this}rotate(f){return function mh(m,f){var d=ds(m);d[0]=Hs(d[0]+f),d=ci(d),m.r=d[0],m.g=d[1],m.b=d[2]}(this._rgb,f),this}}function Ar(){}const ai=(()=>{let m=0;return()=>m++})();function Ai(m){return null==m}function Yi(m){if(Array.isArray&&Array.isArray(m))return!0;const f=Object.prototype.toString.call(m);return"[object"===f.slice(0,7)&&"Array]"===f.slice(-6)}function zi(m){return null!==m&&"[object Object]"===Object.prototype.toString.call(m)}function Hi(m){return("number"==typeof m||m instanceof Number)&&isFinite(+m)}function Bn(m,f){return Hi(m)?m:f}function Ti(m,f){return typeof m>"u"?f:m}const Jo=(m,f)=>"string"==typeof m&&m.endsWith("%")?parseFloat(m)/100*f:+m;function Bi(m,f,d){if(m&&"function"==typeof m.call)return m.apply(d,f)}function Ki(m,f,d,_){let v,I,z;if(Yi(m))if(I=m.length,_)for(v=I-1;v>=0;v--)f.call(d,m[v],v);else for(v=0;v<I;v++)f.call(d,m[v],v);else if(zi(m))for(z=Object.keys(m),I=z.length,v=0;v<I;v++)f.call(d,m[z[v]],z[v])}function Zs(m,f){let d,_,v,I;if(!m||!f||m.length!==f.length)return!1;for(d=0,_=m.length;d<_;++d)if(v=m[d],I=f[d],v.datasetIndex!==I.datasetIndex||v.index!==I.index)return!1;return!0}function vr(m){if(Yi(m))return m.map(vr);if(zi(m)){const f=Object.create(null),d=Object.keys(m),_=d.length;let v=0;for(;v<_;++v)f[d[v]]=vr(m[d[v]]);return f}return m}function fo(m){return-1===["__proto__","prototype","constructor"].indexOf(m)}function ii(m,f,d,_){if(!fo(m))return;const v=f[m],I=d[m];zi(v)&&zi(I)?kr(v,I,_):f[m]=vr(I)}function kr(m,f,d){const _=Yi(f)?f:[f],v=_.length;if(!zi(m))return m;const I=(d=d||{}).merger||ii;let z;for(let R=0;R<v;++R){if(z=_[R],!zi(z))continue;const F=Object.keys(z);for(let H=0,K=F.length;H<K;++H)I(F[H],m,z,d)}return m}function mo(m,f){return kr(m,f,{merger:Or})}function Or(m,f,d){if(!fo(m))return;const _=f[m],v=d[m];zi(_)&&zi(v)?mo(_,v):Object.prototype.hasOwnProperty.call(f,m)||(f[m]=vr(v))}const Qo={"":m=>m,x:m=>m.x,y:m=>m.y};function ps(m,f){return(Qo[f]||(Qo[f]=function Va(m){const f=function Na(m){const f=m.split("."),d=[];let _="";for(const v of f)_+=v,_.endsWith("\\")?_=_.slice(0,-1)+".":(d.push(_),_="");return d}(m);return d=>{for(const _ of f){if(""===_)break;d=d&&d[_]}return d}}(f)))(m)}function go(m){return m.charAt(0).toUpperCase()+m.slice(1)}const yo=m=>typeof m<"u",fs=m=>"function"==typeof m,En=(m,f)=>{if(m.size!==f.size)return!1;for(const d of m)if(!f.has(d))return!1;return!0},pn=Math.PI,ln=2*pn,tr=ln+pn,qr=Number.POSITIVE_INFINITY,Ge=pn/180,$=pn/2,te=pn/4,ne=2*pn/3,fe=Math.log10,me=Math.sign;function Te(m,f,d){return Math.abs(m-f)<d}function ze(m){const f=Math.round(m);m=Te(m,f,m/1e3)?f:m;const d=Math.pow(10,Math.floor(fe(m))),_=m/d;return(_<=1?1:_<=2?2:_<=5?5:10)*d}function Fe(m){return!function Ve(m){return"symbol"==typeof m||"object"==typeof m&&null!==m&&!(Symbol.toPrimitive in m||"toString"in m||"valueOf"in m)}(m)&&!isNaN(parseFloat(m))&&isFinite(m)}function Qe(m,f,d){let _,v,I;for(_=0,v=m.length;_<v;_++)I=m[_][d],isNaN(I)||(f.min=Math.min(f.min,I),f.max=Math.max(f.max,I))}function ot(m){return m*(pn/180)}function dt(m){return m*(180/pn)}function Rt(m){if(!Hi(m))return;let f=1,d=0;for(;Math.round(m*f)/f!==m;)f*=10,d++;return d}function Nt(m,f){const d=f.x-m.x,_=f.y-m.y,v=Math.sqrt(d*d+_*_);let I=Math.atan2(_,d);return I<-.5*pn&&(I+=ln),{angle:I,distance:v}}function Vt(m,f){return Math.sqrt(Math.pow(f.x-m.x,2)+Math.pow(f.y-m.y,2))}function Ft(m,f){return(m-f+tr)%ln-pn}function ei(m){return(m%ln+ln)%ln}function mi(m,f,d,_){const v=ei(m),I=ei(f),z=ei(d),R=ei(I-v),F=ei(z-v),H=ei(v-I),K=ei(v-z);return v===I||v===z||_&&I===z||R>F&&H<K}function Gt(m,f,d){return Math.max(f,Math.min(d,m))}function ui(m,f,d,_=1e-6){return m>=Math.min(f,d)-_&&m<=Math.max(f,d)+_}function yn(m,f,d){d=d||(z=>m[z]<f);let I,_=m.length-1,v=0;for(;_-v>1;)I=v+_>>1,d(I)?v=I:_=I;return{lo:v,hi:_}}const ir=(m,f,d,_)=>yn(m,d,_?v=>{const I=m[v][f];return I<d||I===d&&m[v+1][f]===d}:v=>m[v][f]<d),zn=(m,f,d)=>yn(m,d,_=>m[_][f]>=d),ar=["push","pop","shift","splice","unshift"];function As(m,f){const d=m._chartjs;if(!d)return;const _=d.listeners,v=_.indexOf(f);-1!==v&&_.splice(v,1),!(_.length>0)&&(ar.forEach(I=>{delete m[I]}),delete m._chartjs)}function Ua(m){const f=new Set(m);return f.size===m.length?m:Array.from(f)}const _h=typeof window>"u"?function(m){return m()}:window.requestAnimationFrame;function gc(m,f){let d=[],_=!1;return function(...v){d=v,_||(_=!0,_h.call(window,()=>{_=!1,m.apply(f,d)}))}}const nr=m=>"start"===m?"left":"end"===m?"right":"center",xn=(m,f,d)=>"start"===m?f:"end"===m?d:(f+d)/2;function ms(m,f,d){const _=f.length;let v=0,I=_;if(m._sorted){const{iScale:z,vScale:R,_parsed:F}=m,H=m.dataset&&m.dataset.options?m.dataset.options.spanGaps:null,K=z.axis,{min:ie,max:ue,minDefined:xe,maxDefined:Oe}=z.getUserBounds();if(xe){if(v=Math.min(ir(F,K,ie).lo,d?_:ir(f,K,z.getPixelForValue(ie)).lo),H){const Be=F.slice(0,v+1).reverse().findIndex(je=>!Ai(je[R.axis]));v-=Math.max(0,Be)}v=Gt(v,0,_-1)}if(Oe){let Be=Math.max(ir(F,z.axis,ue,!0).hi+1,d?0:ir(f,K,z.getPixelForValue(ue),!0).hi+1);if(H){const je=F.slice(Be-1).findIndex(ht=>!Ai(ht[R.axis]));Be+=Math.max(0,je)}I=Gt(Be,v,_)-v}else I=_-v}return{start:v,count:I}}function ns(m){const{xScale:f,yScale:d,_scaleRanges:_}=m,v={xmin:f.min,xmax:f.max,ymin:d.min,ymax:d.max};if(!_)return m._scaleRanges=v,!0;const I=_.xmin!==f.min||_.xmax!==f.max||_.ymin!==d.min||_.ymax!==d.max;return Object.assign(_,v),I}const Hr=m=>0===m||1===m,El=(m,f,d)=>-Math.pow(2,10*(m-=1))*Math.sin((m-f)*ln/d),yc=(m,f,d)=>Math.pow(2,-10*m)*Math.sin((m-f)*ln/d)+1,rs={linear:m=>m,easeInQuad:m=>m*m,easeOutQuad:m=>-m*(m-2),easeInOutQuad:m=>(m/=.5)<1?.5*m*m:-.5*(--m*(m-2)-1),easeInCubic:m=>m*m*m,easeOutCubic:m=>(m-=1)*m*m+1,easeInOutCubic:m=>(m/=.5)<1?.5*m*m*m:.5*((m-=2)*m*m+2),easeInQuart:m=>m*m*m*m,easeOutQuart:m=>-((m-=1)*m*m*m-1),easeInOutQuart:m=>(m/=.5)<1?.5*m*m*m*m:-.5*((m-=2)*m*m*m-2),easeInQuint:m=>m*m*m*m*m,easeOutQuint:m=>(m-=1)*m*m*m*m+1,easeInOutQuint:m=>(m/=.5)<1?.5*m*m*m*m*m:.5*((m-=2)*m*m*m*m+2),easeInSine:m=>1-Math.cos(m*$),easeOutSine:m=>Math.sin(m*$),easeInOutSine:m=>-.5*(Math.cos(pn*m)-1),easeInExpo:m=>0===m?0:Math.pow(2,10*(m-1)),easeOutExpo:m=>1===m?1:1-Math.pow(2,-10*m),easeInOutExpo:m=>Hr(m)?m:m<.5?.5*Math.pow(2,10*(2*m-1)):.5*(2-Math.pow(2,-10*(2*m-1))),easeInCirc:m=>m>=1?m:-(Math.sqrt(1-m*m)-1),easeOutCirc:m=>Math.sqrt(1-(m-=1)*m),easeInOutCirc:m=>(m/=.5)<1?-.5*(Math.sqrt(1-m*m)-1):.5*(Math.sqrt(1-(m-=2)*m)+1),easeInElastic:m=>Hr(m)?m:El(m,.075,.3),easeOutElastic:m=>Hr(m)?m:yc(m,.075,.3),easeInOutElastic:m=>Hr(m)?m:m<.5?.5*El(2*m,.1125,.45):.5+.5*yc(2*m-1,.1125,.45),easeInBack:m=>m*m*(2.70158*m-1.70158),easeOutBack:m=>(m-=1)*m*(2.70158*m+1.70158)+1,easeInOutBack(m){let f=1.70158;return(m/=.5)<1?m*m*((1+(f*=1.525))*m-f)*.5:.5*((m-=2)*m*((1+(f*=1.525))*m+f)+2)},easeInBounce:m=>1-rs.easeOutBounce(1-m),easeOutBounce:m=>m<1/2.75?7.5625*m*m:m<2/2.75?7.5625*(m-=1.5/2.75)*m+.75:m<2.5/2.75?7.5625*(m-=2.25/2.75)*m+.9375:7.5625*(m-=2.625/2.75)*m+.984375,easeInOutBounce:m=>m<.5?.5*rs.easeInBounce(2*m):.5*rs.easeOutBounce(2*m-1)+.5};function Is(m){if(m&&"object"==typeof m){const f=m.toString();return"[object CanvasPattern]"===f||"[object CanvasGradient]"===f}return!1}function yh(m){return Is(m)?m:new Gr(m)}function Al(m){return Is(m)?m:new Gr(m).saturate(.5).darken(.1).hexString()}const ss=["x","y","borderWidth","radius","tension"],Ri=["color","borderColor","backgroundColor"],vh=new Map;function xo(m,f,d){return function xc(m,f){f=f||{};const d=m+JSON.stringify(f);let _=vh.get(d);return _||(_=new Intl.NumberFormat(m,f),vh.set(d,_)),_}(f,d).format(m)}const hi={values:m=>Yi(m)?m:""+m,numeric(m,f,d){if(0===m)return"0";const _=this.chart.options.locale;let v,I=m;if(d.length>1){const H=Math.max(Math.abs(d[0].value),Math.abs(d[d.length-1].value));(H<1e-4||H>1e15)&&(v="scientific"),I=function vc(m,f){let d=f.length>3?f[2].value-f[1].value:f[1].value-f[0].value;return Math.abs(d)>=1&&m!==Math.floor(m)&&(d=m-Math.floor(m)),d}(m,d)}const z=fe(Math.abs(I)),R=isNaN(z)?1:Math.max(Math.min(-1*Math.floor(z),20),0),F={notation:v,minimumFractionDigits:R,maximumFractionDigits:R};return Object.assign(F,this.options.ticks.format),xo(m,_,F)},logarithmic(m,f,d){if(0===m)return"0";const _=d[f].significand||m/Math.pow(10,Math.floor(fe(m)));return[1,2,3,5,10,15].includes(_)||f>.8*d.length?hi.numeric.call(this,m,f,d):""}};var Cs={formatters:hi};const Mi=Object.create(null),wi=Object.create(null);function Vn(m,f){if(!f)return m;const d=f.split(".");for(let _=0,v=d.length;_<v;++_){const I=d[_];m=m[I]||(m[I]=Object.create(null))}return m}function _s(m,f,d){return"string"==typeof f?kr(Vn(m,f),d):kr(Vn(m,""),f)}class Pi{constructor(f,d){this.animation=void 0,this.backgroundColor="rgba(0,0,0,0.1)",this.borderColor="rgba(0,0,0,0.1)",this.color="#666",this.datasets={},this.devicePixelRatio=_=>_.chart.platform.getDevicePixelRatio(),this.elements={},this.events=["mousemove","mouseout","click","touchstart","touchmove"],this.font={family:"'Helvetica Neue', 'Helvetica', 'Arial', sans-serif",size:12,style:"normal",lineHeight:1.2,weight:null},this.hover={},this.hoverBackgroundColor=(_,v)=>Al(v.backgroundColor),this.hoverBorderColor=(_,v)=>Al(v.borderColor),this.hoverColor=(_,v)=>Al(v.color),this.indexAxis="x",this.interaction={mode:"nearest",intersect:!0,includeInvisible:!1},this.maintainAspectRatio=!0,this.onHover=null,this.onClick=null,this.parsing=!0,this.plugins={},this.responsive=!0,this.scale=void 0,this.scales={},this.showLine=!0,this.drawActiveElementsOnTop=!0,this.describe(f),this.apply(d)}set(f,d){return _s(this,f,d)}get(f){return Vn(this,f)}describe(f,d){return _s(wi,f,d)}override(f,d){return _s(Mi,f,d)}route(f,d,_,v){const I=Vn(this,f),z=Vn(this,_),R="_"+d;Object.defineProperties(I,{[R]:{value:I[d],writable:!0},[d]:{enumerable:!0,get(){const F=this[R],H=z[v];return zi(F)?Object.assign({},H,F):Ti(F,H)},set(F){this[R]=F}}})}apply(f){f.forEach(d=>d(this))}}var fn=new Pi({_scriptable:m=>!m.startsWith("on"),_indexable:m=>"events"!==m,hover:{_fallback:"interaction"},interaction:{_scriptable:!1,_indexable:!1}},[function xh(m){m.set("animation",{delay:void 0,duration:1e3,easing:"easeOutQuart",fn:void 0,from:void 0,loop:void 0,to:void 0,type:void 0}),m.describe("animation",{_fallback:!1,_indexable:!1,_scriptable:f=>"onProgress"!==f&&"onComplete"!==f&&"fn"!==f}),m.set("animations",{colors:{type:"color",properties:Ri},numbers:{type:"number",properties:ss}}),m.describe("animations",{_fallback:"animation"}),m.set("transitions",{active:{animation:{duration:400}},resize:{animation:{duration:0}},show:{animations:{colors:{from:"transparent"},visible:{type:"boolean",duration:0}}},hide:{animations:{colors:{to:"transparent"},visible:{type:"boolean",easing:"linear",fn:f=>0|f}}}})},function Ut(m){m.set("layout",{autoPadding:!0,padding:{top:0,right:0,bottom:0,left:0}})},function Mt(m){m.set("scale",{display:!0,offset:!1,reverse:!1,beginAtZero:!1,bounds:"ticks",clip:!0,grace:0,grid:{display:!0,lineWidth:1,drawOnChartArea:!0,drawTicks:!0,tickLength:8,tickWidth:(f,d)=>d.lineWidth,tickColor:(f,d)=>d.color,offset:!1},border:{display:!0,dash:[],dashOffset:0,width:1},title:{display:!1,text:"",padding:{top:4,bottom:4}},ticks:{minRotation:0,maxRotation:50,mirror:!1,textStrokeWidth:0,textStrokeColor:"",padding:3,display:!0,autoSkip:!0,autoSkipPadding:3,labelOffset:0,callback:Cs.formatters.values,minor:{},major:{},align:"center",crossAlign:"near",showLabelBackdrop:!1,backdropColor:"rgba(255, 255, 255, 0.75)",backdropPadding:2}}),m.route("scale.ticks","color","","color"),m.route("scale.grid","color","","borderColor"),m.route("scale.border","color","","borderColor"),m.route("scale.title","color","","color"),m.describe("scale",{_fallback:!1,_scriptable:f=>!f.startsWith("before")&&!f.startsWith("after")&&"callback"!==f&&"parser"!==f,_indexable:f=>"borderDash"!==f&&"tickBorderDash"!==f&&"dash"!==f}),m.describe("scales",{_fallback:"scale"}),m.describe("scale.ticks",{_scriptable:f=>"backdropPadding"!==f&&"callback"!==f,_indexable:f=>"backdropPadding"!==f})}]);function vo(m,f,d,_,v){let I=f[v];return I||(I=f[v]=m.measureText(v).width,d.push(v)),I>_&&(_=I),_}function Kn(m,f,d,_){let v=(_=_||{}).data=_.data||{},I=_.garbageCollect=_.garbageCollect||[];_.font!==f&&(v=_.data={},I=_.garbageCollect=[],_.font=f),m.save(),m.font=f;let z=0;const R=d.length;let F,H,K,ie,ue;for(F=0;F<R;F++)if(ie=d[F],null==ie||Yi(ie)){if(Yi(ie))for(H=0,K=ie.length;H<K;H++)ue=ie[H],null!=ue&&!Yi(ue)&&(z=vo(m,v,I,z,ue))}else z=vo(m,v,I,z,ie);m.restore();const xe=I.length/2;if(xe>d.length){for(F=0;F<xe;F++)delete v[I[F]];I.splice(0,xe)}return z}function sn(m,f,d){const _=m.currentDevicePixelRatio,v=0!==d?Math.max(d/2,.5):0;return Math.round((f-v)*_)/_+v}function bc(m,f){!f&&!m||((f=f||m.getContext("2d")).save(),f.resetTransform(),f.clearRect(0,0,m.width,m.height),f.restore())}function lr(m,f,d,_){Il(m,f,d,_,null)}function Il(m,f,d,_,v){let I,z,R,F,H,K,ie,ue;const xe=f.pointStyle,Oe=f.rotation,Be=f.radius;let je=(Oe||0)*Ge;if(xe&&"object"==typeof xe&&(I=xe.toString(),"[object HTMLImageElement]"===I||"[object HTMLCanvasElement]"===I))return m.save(),m.translate(d,_),m.rotate(je),m.drawImage(xe,-xe.width/2,-xe.height/2,xe.width,xe.height),void m.restore();if(!(isNaN(Be)||Be<=0)){switch(m.beginPath(),xe){default:v?m.ellipse(d,_,v/2,Be,0,0,ln):m.arc(d,_,Be,0,ln),m.closePath();break;case"triangle":K=v?v/2:Be,m.moveTo(d+Math.sin(je)*K,_-Math.cos(je)*Be),je+=ne,m.lineTo(d+Math.sin(je)*K,_-Math.cos(je)*Be),je+=ne,m.lineTo(d+Math.sin(je)*K,_-Math.cos(je)*Be),m.closePath();break;case"rectRounded":H=.516*Be,F=Be-H,z=Math.cos(je+te)*F,ie=Math.cos(je+te)*(v?v/2-H:F),R=Math.sin(je+te)*F,ue=Math.sin(je+te)*(v?v/2-H:F),m.arc(d-ie,_-R,H,je-pn,je-$),m.arc(d+ue,_-z,H,je-$,je),m.arc(d+ie,_+R,H,je,je+$),m.arc(d-ue,_+z,H,je+$,je+pn),m.closePath();break;case"rect":if(!Oe){F=Math.SQRT1_2*Be,K=v?v/2:F,m.rect(d-K,_-F,2*K,2*F);break}je+=te;case"rectRot":ie=Math.cos(je)*(v?v/2:Be),z=Math.cos(je)*Be,R=Math.sin(je)*Be,ue=Math.sin(je)*(v?v/2:Be),m.moveTo(d-ie,_-R),m.lineTo(d+ue,_-z),m.lineTo(d+ie,_+R),m.lineTo(d-ue,_+z),m.closePath();break;case"crossRot":je+=te;case"cross":ie=Math.cos(je)*(v?v/2:Be),z=Math.cos(je)*Be,R=Math.sin(je)*Be,ue=Math.sin(je)*(v?v/2:Be),m.moveTo(d-ie,_-R),m.lineTo(d+ie,_+R),m.moveTo(d+ue,_-z),m.lineTo(d-ue,_+z);break;case"star":ie=Math.cos(je)*(v?v/2:Be),z=Math.cos(je)*Be,R=Math.sin(je)*Be,ue=Math.sin(je)*(v?v/2:Be),m.moveTo(d-ie,_-R),m.lineTo(d+ie,_+R),m.moveTo(d+ue,_-z),m.lineTo(d-ue,_+z),je+=te,ie=Math.cos(je)*(v?v/2:Be),z=Math.cos(je)*Be,R=Math.sin(je)*Be,ue=Math.sin(je)*(v?v/2:Be),m.moveTo(d-ie,_-R),m.lineTo(d+ie,_+R),m.moveTo(d+ue,_-z),m.lineTo(d-ue,_+z);break;case"line":z=v?v/2:Math.cos(je)*Be,R=Math.sin(je)*Be,m.moveTo(d-z,_-R),m.lineTo(d+z,_+R);break;case"dash":m.moveTo(d,_),m.lineTo(d+Math.cos(je)*(v?v/2:Be),_+Math.sin(je)*Be);break;case!1:m.closePath()}m.fill(),f.borderWidth>0&&m.stroke()}}function Wr(m,f,d){return d=d||.5,!f||m&&m.x>f.left-d&&m.x<f.right+d&&m.y>f.top-d&&m.y<f.bottom+d}function ea(m,f){m.save(),m.beginPath(),m.rect(f.left,f.top,f.right-f.left,f.bottom-f.top),m.clip()}function bo(m){m.restore()}function cr(m,f,d,_,v){if(!f)return m.lineTo(d.x,d.y);if("middle"===v){const I=(f.x+d.x)/2;m.lineTo(I,f.y),m.lineTo(I,d.y)}else"after"===v!=!!_?m.lineTo(f.x,d.y):m.lineTo(d.x,f.y);m.lineTo(d.x,d.y)}function Ds(m,f,d,_){if(!f)return m.lineTo(d.x,d.y);m.bezierCurveTo(_?f.cp1x:f.cp2x,_?f.cp1y:f.cp2y,_?d.cp2x:d.cp1x,_?d.cp2y:d.cp1y,d.x,d.y)}function bh(m,f,d,_,v){if(v.strikethrough||v.underline){const I=m.measureText(_),z=f-I.actualBoundingBoxLeft,R=f+I.actualBoundingBoxRight,H=d+I.actualBoundingBoxDescent,K=v.strikethrough?(d-I.actualBoundingBoxAscent+H)/2:H;m.strokeStyle=m.fillStyle,m.beginPath(),m.lineWidth=v.decorationWidth||2,m.moveTo(z,K),m.lineTo(R,K),m.stroke()}}function Ys(m,f){const d=m.fillStyle;m.fillStyle=f.color,m.fillRect(f.left,f.top,f.width,f.height),m.fillStyle=d}function en(m,f,d,_,v,I={}){const z=Yi(f)?f:[f],R=I.strokeWidth>0&&""!==I.strokeColor;let F,H;for(m.save(),m.font=v.string,function rr(m,f){f.translation&&m.translate(f.translation[0],f.translation[1]),Ai(f.rotation)||m.rotate(f.rotation),f.color&&(m.fillStyle=f.color),f.textAlign&&(m.textAlign=f.textAlign),f.textBaseline&&(m.textBaseline=f.textBaseline)}(m,I),F=0;F<z.length;++F)H=z[F],I.backdrop&&Ys(m,I.backdrop),R&&(I.strokeColor&&(m.strokeStyle=I.strokeColor),Ai(I.strokeWidth)||(m.lineWidth=I.strokeWidth),m.strokeText(H,d,_,I.maxWidth)),m.fillText(H,d,_,I.maxWidth),bh(m,d,_,H,I),_+=Number(v.lineHeight);m.restore()}function br(m,f){const{x:d,y:_,w:v,h:I,radius:z}=f;m.arc(d+z.topLeft,_+z.topLeft,z.topLeft,1.5*pn,pn,!0),m.lineTo(d,_+I-z.bottomLeft),m.arc(d+z.bottomLeft,_+I-z.bottomLeft,z.bottomLeft,pn,$,!0),m.lineTo(d+v-z.bottomRight,_+I),m.arc(d+v-z.bottomRight,_+I-z.bottomRight,z.bottomRight,$,0,!0),m.lineTo(d+v,_+z.topRight),m.arc(d+v-z.topRight,_+z.topRight,z.topRight,0,-$,!0),m.lineTo(d+z.topLeft,_)}const Jn=/^(normal|(\d+(?:\.\d+)?)(px|em|%)?)$/,Sn=/^(normal|italic|initial|inherit|unset|(oblique( -?[0-9]?[0-9]deg)?))$/;function Cl(m,f){const d=(""+m).match(Jn);if(!d||"normal"===d[1])return 1.2*f;switch(m=+d[2],d[3]){case"px":return m;case"%":m/=100}return f*m}const gs=m=>+m||0;function Ks(m,f){const d={},_=zi(f),v=_?Object.keys(f):f,I=zi(m)?_?z=>Ti(m[z],m[f[z]]):z=>m[z]:()=>m;for(const z of v)d[z]=gs(I(z));return d}function ja(m){return Ks(m,{top:"y",right:"x",bottom:"y",left:"x"})}function hr(m){return Ks(m,["topLeft","topRight","bottomLeft","bottomRight"])}function sr(m){const f=ja(m);return f.width=f.left+f.right,f.height=f.top+f.bottom,f}function mn(m,f){let d=Ti((m=m||{}).size,(f=f||fn.font).size);"string"==typeof d&&(d=parseInt(d,10));let _=Ti(m.style,f.style);_&&!(""+_).match(Sn)&&(console.warn('Invalid font style specified: "'+_+'"'),_=void 0);const v={family:Ti(m.family,f.family),lineHeight:Cl(Ti(m.lineHeight,f.lineHeight),d),size:d,style:_,weight:Ti(m.weight,f.weight),string:""};return v.string=function Ps(m){return!m||Ai(m.size)||Ai(m.family)?null:(m.style?m.style+" ":"")+(m.weight?m.weight+" ":"")+m.size+"px "+m.family}(v),v}function Pl(m,f,d,_){let I,z,R,v=!0;for(I=0,z=m.length;I<z;++I)if(R=m[I],void 0!==R&&(void 0!==f&&"function"==typeof R&&(R=R(f),v=!1),void 0!==d&&Yi(R)&&(R=R[d%R.length],v=!1),void 0!==R))return _&&!v&&(_.cacheable=!1),R}function Rn(m,f){return Object.assign(Object.create(m),f)}function Dl(m,f=[""],d,_,v=()=>m[0]){const I=d||m;typeof _>"u"&&(_=Eh("_fallback",m));const z={[Symbol.toStringTag]:"Object",_cacheable:!0,_scopes:m,_rootScopes:I,_fallback:_,_getTarget:v,override:R=>Dl([R,...m],f,I,_)};return new Proxy(z,{deleteProperty:(R,F)=>(delete R[F],delete R._keys,delete m[0][F],!0),get:(R,F)=>ku(R,F,()=>function Dd(m,f,d,_){let v;for(const I of f)if(v=Eh(zl(I,m),d),typeof v<"u")return Th(m,v)?zs(d,_,m,v):v}(F,f,m,R)),getOwnPropertyDescriptor:(R,F)=>Reflect.getOwnPropertyDescriptor(R._scopes[0],F),getPrototypeOf:()=>Reflect.getPrototypeOf(m[0]),has:(R,F)=>Fu(R).includes(F),ownKeys:R=>Fu(R),set(R,F,H){const K=R._storage||(R._storage=v());return R[F]=K[F]=H,delete R._keys,!0}})}function Js(m,f,d,_){const v={_cacheable:!1,_proxy:m,_context:f,_subProxy:d,_stack:new Set,_descriptors:Ga(m,_),setContext:I=>Js(m,I,d,_),override:I=>Js(m.override(I),f,d,_)};return new Proxy(v,{deleteProperty:(I,z)=>(delete I[z],delete m[z],!0),get:(I,z,R)=>ku(I,z,()=>function Rl(m,f,d){const{_proxy:_,_context:v,_subProxy:I,_descriptors:z}=m;let R=_[f];return fs(R)&&z.isScriptable(f)&&(R=function Ll(m,f,d,_){const{_proxy:v,_context:I,_subProxy:z,_stack:R}=d;if(R.has(m))throw new Error("Recursion detected: "+Array.from(R).join("->")+"->"+m);R.add(m);let F=f(I,z||_);return R.delete(m),Th(m,F)&&(F=zs(v._scopes,v,m,F)),F}(f,R,m,d)),Yi(R)&&R.length&&(R=function Pd(m,f,d,_){const{_proxy:v,_context:I,_subProxy:z,_descriptors:R}=d;if(typeof I.index<"u"&&_(m))return f[I.index%f.length];if(zi(f[0])){const F=f,H=v._scopes.filter(K=>K!==F);f=[];for(const K of F){const ie=zs(H,v,m,K);f.push(Js(ie,I,z&&z[m],R))}}return f}(f,R,m,z.isIndexable)),Th(f,R)&&(R=Js(R,v,I&&I[f],z)),R}(I,z,R)),getOwnPropertyDescriptor:(I,z)=>I._descriptors.allKeys?Reflect.has(m,z)?{enumerable:!0,configurable:!0}:void 0:Reflect.getOwnPropertyDescriptor(m,z),getPrototypeOf:()=>Reflect.getPrototypeOf(m),has:(I,z)=>Reflect.has(m,z),ownKeys:()=>Reflect.ownKeys(m),set:(I,z,R)=>(m[z]=R,delete I[z],!0)})}function Ga(m,f={scriptable:!0,indexable:!0}){const{_scriptable:d=f.scriptable,_indexable:_=f.indexable,_allKeys:v=f.allKeys}=m;return{allKeys:v,scriptable:d,indexable:_,isScriptable:fs(d)?d:()=>d,isIndexable:fs(_)?_:()=>_}}const zl=(m,f)=>m?m+go(f):f,Th=(m,f)=>zi(f)&&"adapters"!==m&&(null===Object.getPrototypeOf(f)||f.constructor===Object);function ku(m,f,d){if(Object.prototype.hasOwnProperty.call(m,f)||"constructor"===f)return m[f];const _=d();return m[f]=_,_}function ta(m,f,d){return fs(m)?m(f,d):m}const Sh=(m,f)=>!0===m?f:"string"==typeof m?ps(f,m):void 0;function Qs(m,f,d,_,v){for(const I of f){const z=Sh(d,I);if(z){m.add(z);const R=ta(z._fallback,d,v);if(typeof R<"u"&&R!==d&&R!==_)return R}else if(!1===z&&typeof _<"u"&&d!==_)return null}return!1}function zs(m,f,d,_){const v=f._rootScopes,I=ta(f._fallback,d,_),z=[...m,...v],R=new Set;R.add(_);let F=Ou(R,z,d,I||d,_);return!(null===F||typeof I<"u"&&I!==d&&(F=Ou(R,z,I,F,_),null===F))&&Dl(Array.from(R),[""],v,I,()=>function Mh(m,f,d){const _=m._getTarget();f in _||(_[f]={});const v=_[f];return Yi(v)&&zi(d)?d:v||{}}(f,d,_))}function Ou(m,f,d,_,v){for(;d;)d=Qs(m,f,d,_,v);return d}function Eh(m,f){for(const d of f){if(!d)continue;const _=d[m];if(typeof _<"u")return _}}function Fu(m){let f=m._keys;return f||(f=m._keys=function Ah(m){const f=new Set;for(const d of m)for(const _ of Object.keys(d).filter(v=>!v.startsWith("_")))f.add(_);return Array.from(f)}(m._scopes)),f}function wo(m,f,d,_){const{iScale:v}=m,{key:I="r"}=this._parsing,z=new Array(_);let R,F,H,K;for(R=0,F=_;R<F;++R)H=R+d,K=f[H],z[R]={r:v.parse(ps(K,I),H)};return z}const li=Number.EPSILON||1e-14,zt=(m,f)=>f<m.length&&!m[f].skip&&m[f],kl=m=>"x"===m?"y":"x";function qt(m,f,d,_){const v=m.skip?f:m,I=f,z=d.skip?f:d,R=Vt(I,v),F=Vt(z,I);let H=R/(R+F),K=F/(R+F);H=isNaN(H)?0:H,K=isNaN(K)?0:K;const ie=_*H,ue=_*K;return{previous:{x:I.x-ie*(z.x-v.x),y:I.y-ie*(z.y-v.y)},next:{x:I.x+ue*(z.x-v.x),y:I.y+ue*(z.y-v.y)}}}function eo(m,f,d){return Math.max(Math.min(m,d),f)}function Ih(m,f,d,_,v){let I,z,R,F;if(f.spanGaps&&(m=m.filter(H=>!H.skip)),"monotone"===f.cubicInterpolationMode)!function Wt(m,f="x"){const d=kl(f),_=m.length,v=Array(_).fill(0),I=Array(_);let z,R,F,H=zt(m,0);for(z=0;z<_;++z)if(R=F,F=H,H=zt(m,z+1),F){if(H){const K=H[f]-F[f];v[z]=0!==K?(H[d]-F[d])/K:0}I[z]=R?H?me(v[z-1])!==me(v[z])?0:(v[z-1]+v[z])/2:v[z-1]:v[z]}(function qa(m,f,d){const _=m.length;let v,I,z,R,F,H=zt(m,0);for(let K=0;K<_-1;++K)if(F=H,H=zt(m,K+1),F&&H){if(Te(f[K],0,li)){d[K]=d[K+1]=0;continue}v=d[K]/f[K],I=d[K+1]/f[K],R=Math.pow(v,2)+Math.pow(I,2),!(R<=9)&&(z=3/Math.sqrt(R),d[K]=v*z*f[K],d[K+1]=I*z*f[K])}})(m,v,I),function wc(m,f,d="x"){const _=kl(d),v=m.length;let I,z,R,F=zt(m,0);for(let H=0;H<v;++H){if(z=R,R=F,F=zt(m,H+1),!R)continue;const K=R[d],ie=R[_];z&&(I=(K-z[d])/3,R[`cp1${d}`]=K-I,R[`cp1${_}`]=ie-I*f[H]),F&&(I=(F[d]-K)/3,R[`cp2${d}`]=K+I,R[`cp2${_}`]=ie+I*f[H])}}(m,I,f)}(m,v);else{let H=_?m[m.length-1]:m[0];for(I=0,z=m.length;I<z;++I)R=m[I],F=qt(H,R,m[Math.min(I+1,z-(_?0:1))%z],f.tension),R.cp1x=F.previous.x,R.cp1y=F.previous.y,R.cp2x=F.next.x,R.cp2y=F.next.y,H=R}f.capBezierPoints&&function ia(m,f){let d,_,v,I,z,R=Wr(m[0],f);for(d=0,_=m.length;d<_;++d)z=I,I=R,R=d<_-1&&Wr(m[d+1],f),I&&(v=m[d],z&&(v.cp1x=eo(v.cp1x,f.left,f.right),v.cp1y=eo(v.cp1y,f.top,f.bottom)),R&&(v.cp2x=eo(v.cp2x,f.left,f.right),v.cp2y=eo(v.cp2y,f.top,f.bottom)))}(m,d)}function Ha(){return typeof window<"u"&&typeof document<"u"}function ur(m){let f=m.parentNode;return f&&"[object ShadowRoot]"===f.toString()&&(f=f.host),f}function Un(m,f,d){let _;return"string"==typeof m?(_=parseInt(m,10),-1!==m.indexOf("%")&&(_=_/100*f.parentNode[d])):_=m,_}const ft=m=>m.ownerDocument.defaultView.getComputedStyle(m,null),Tc=["top","right","bottom","left"];function ys(m,f,d){const _={};d=d?"-"+d:"";for(let v=0;v<4;v++){const I=Tc[v];_[I]=parseFloat(m[f+"-"+I+d])||0}return _.width=_.left+_.right,_.height=_.top+_.bottom,_}function Ir(m,f){if("native"in m)return m;const{canvas:d,currentDevicePixelRatio:_}=f,v=ft(d),I="border-box"===v.boxSizing,z=ys(v,"padding"),R=ys(v,"border","width"),{x:F,y:H,box:K}=function Qn(m,f){const d=m.touches,_=d&&d.length?d[0]:m,{offsetX:v,offsetY:I}=_;let R,F,z=!1;if(((m,f,d)=>(m>0||f>0)&&(!d||!d.shadowRoot))(v,I,m.target))R=v,F=I;else{const H=f.getBoundingClientRect();R=_.clientX-H.left,F=_.clientY-H.top,z=!0}return{x:R,y:F,box:z}}(m,d),ie=z.left+(K&&R.left),ue=z.top+(K&&R.top);let{width:xe,height:Oe}=f;return I&&(xe-=z.width+R.width,Oe-=z.height+R.height),{x:Math.round((F-ie)/xe*d.width/_),y:Math.round((H-ue)/Oe*d.height/_)}}const Rs=m=>Math.round(10*m)/10;function So(m,f,d){const _=f||1,v=Math.floor(m.height*_),I=Math.floor(m.width*_);m.height=Math.floor(m.height),m.width=Math.floor(m.width);const z=m.canvas;return z.style&&(d||!z.style.height&&!z.style.width)&&(z.style.height=`${m.height}px`,z.style.width=`${m.width}px`),(m.currentDevicePixelRatio!==_||z.height!==v||z.width!==I)&&(m.currentDevicePixelRatio=_,z.height=v,z.width=I,m.ctx.setTransform(_,0,0,_,0,0),!0)}const Dh=function(){let m=!1;try{const f={get passive(){return m=!0,!1}};Ha()&&(window.addEventListener("test",null,f),window.removeEventListener("test",null,f))}catch{}return m}();function Bu(m,f){const d=function Ch(m,f){return ft(m).getPropertyValue(f)}(m,f),_=d&&d.match(/^(\d+)(\.\d+)?px$/);return _?+_[1]:void 0}function to(m,f,d,_){return{x:m.x+d*(f.x-m.x),y:m.y+d*(f.y-m.y)}}function zd(m,f,d,_){return{x:m.x+d*(f.x-m.x),y:"middle"===_?d<.5?m.y:f.y:"after"===_?d<1?m.y:f.y:d>0?f.y:m.y}}function Nu(m,f,d,_){const v={x:m.cp2x,y:m.cp2y},I={x:f.cp1x,y:f.cp1y},z=to(m,v,d),R=to(v,I,d),F=to(I,f,d),H=to(z,R,d),K=to(R,F,d);return to(H,K,d)}function Wa(m,f,d){return m?function(m,f){return{x:d=>m+m+f-d,setWidth(d){f=d},textAlign:d=>"center"===d?d:"right"===d?"left":"right",xPlus:(d,_)=>d-_,leftForLtr:(d,_)=>d-_}}(f,d):{x:m=>m,setWidth(m){},textAlign:m=>m,xPlus:(m,f)=>m+f,leftForLtr:(m,f)=>m}}function Lh(m,f){let d,_;("ltr"===f||"rtl"===f)&&(d=m.canvas.style,_=[d.getPropertyValue("direction"),d.getPropertyPriority("direction")],d.setProperty("direction",f,"important"),m.prevTextDirection=_)}function Mo(m,f){void 0!==f&&(delete m.prevTextDirection,m.canvas.style.setProperty("direction",f[0],f[1]))}function Vu(m){return"angle"===m?{between:mi,compare:Ft,normalize:ei}:{between:ui,compare:(f,d)=>f-d,normalize:f=>f}}function kh({start:m,end:f,count:d,loop:_,style:v}){return{start:m%d,end:f%d,loop:_&&(f-m+1)%d==0,style:v}}function $a(m,f,d){if(!d)return[m];const{property:_,start:v,end:I}=d,z=f.length,{compare:R,between:F,normalize:H}=Vu(_),{start:K,end:ie,loop:ue,style:xe}=function Oh(m,f,d){const{property:_,start:v,end:I}=d,{between:z,normalize:R}=Vu(_),F=f.length;let ue,xe,{start:H,end:K,loop:ie}=m;if(ie){for(H+=F,K+=F,ue=0,xe=F;ue<xe&&z(R(f[H%F][_]),v,I);++ue)H--,K--;H%=F,K%=F}return K<H&&(K+=F),{start:H,end:K,loop:ie,style:m.style}}(m,f,d),Oe=[];let ht,lt,Et,Be=!1,je=null;for(let Ot=K,Bt=K;Ot<=ie;++Ot)lt=f[Ot%z],!lt.skip&&(ht=H(lt[_]),ht!==Et&&(Be=F(ht,v,I),null===je&&(Be||F(v,Et,ht)&&0!==R(v,Et))&&(je=0===R(ht,v)?Ot:Bt),null!==je&&(!Be||0===R(I,ht)||F(I,Et,ht))&&(Oe.push(kh({start:je,end:Ot,loop:ue,count:z,style:xe})),je=null),Bt=Ot,Et=ht));return null!==je&&Oe.push(kh({start:je,end:ie,loop:ue,count:z,style:xe})),Oe}function Fh(m,f){const d=[],_=m.segments;for(let v=0;v<_.length;v++){const I=$a(_[v],m.points,f);I.length&&d.push(...I)}return d}function Bl(m){return{backgroundColor:m.backgroundColor,borderCapStyle:m.borderCapStyle,borderDash:m.borderDash,borderDashOffset:m.borderDashOffset,borderJoinStyle:m.borderJoinStyle,borderWidth:m.borderWidth,borderColor:m.borderColor}}function Bh(m,f){if(!f)return!1;const d=[],_=function(v,I){return Is(I)?(d.includes(I)||d.push(I),d.indexOf(I)):I};return JSON.stringify(m,_)!==JSON.stringify(f,_)}class ra{constructor(){this._request=null,this._charts=new Map,this._running=!1,this._lastDate=void 0}_notify(f,d,_,v){const z=d.duration;d.listeners[v].forEach(R=>R({chart:f,initial:d.initial,numSteps:z,currentStep:Math.min(_-d.start,z)}))}_refresh(){this._request||(this._running=!0,this._request=_h.call(window,()=>{this._update(),this._request=null,this._running&&this._refresh()}))}_update(f=Date.now()){let d=0;this._charts.forEach((_,v)=>{if(!_.running||!_.items.length)return;const I=_.items;let F,z=I.length-1,R=!1;for(;z>=0;--z)F=I[z],F._active?(F._total>_.duration&&(_.duration=F._total),F.tick(f),R=!0):(I[z]=I[I.length-1],I.pop());R&&(v.draw(),this._notify(v,_,f,"progress")),I.length||(_.running=!1,this._notify(v,_,f,"complete"),_.initial=!1),d+=I.length}),this._lastDate=f,0===d&&(this._running=!1)}_getAnims(f){const d=this._charts;let _=d.get(f);return _||(_={running:!1,initial:!0,items:[],listeners:{complete:[],progress:[]}},d.set(f,_)),_}listen(f,d,_){this._getAnims(f).listeners[d].push(_)}add(f,d){!d||!d.length||this._getAnims(f).items.push(...d)}has(f){return this._getAnims(f).items.length>0}start(f){const d=this._charts.get(f);d&&(d.running=!0,d.start=Date.now(),d.duration=d.items.reduce((_,v)=>Math.max(_,v._duration),0),this._refresh())}running(f){if(!this._running)return!1;const d=this._charts.get(f);return!(!d||!d.running||!d.items.length)}stop(f){const d=this._charts.get(f);if(!d||!d.items.length)return;const _=d.items;let v=_.length-1;for(;v>=0;--v)_[v].cancel();d.items=[],this._notify(f,d,Date.now(),"complete")}remove(f){return this._charts.delete(f)}}var Fr=new ra;const Za="transparent",Nl={boolean:(m,f,d)=>d>.5?f:m,color(m,f,d){const _=yh(m||Za),v=_.valid&&yh(f||Za);return v&&v.valid?v.mix(_,d).hexString():f},number:(m,f,d)=>m+(f-m)*d};class sa{constructor(f,d,_,v){const I=d[_];v=Pl([f.to,v,I,f.from]);const z=Pl([f.from,I,v]);this._active=!0,this._fn=f.fn||Nl[f.type||typeof z],this._easing=rs[f.easing]||rs.linear,this._start=Math.floor(Date.now()+(f.delay||0)),this._duration=this._total=Math.floor(f.duration),this._loop=!!f.loop,this._target=d,this._prop=_,this._from=z,this._to=v,this._promises=void 0}active(){return this._active}update(f,d,_){if(this._active){this._notify(!1);const v=this._target[this._prop],I=_-this._start,z=this._duration-I;this._start=_,this._duration=Math.floor(Math.max(z,f.duration)),this._total+=I,this._loop=!!f.loop,this._to=Pl([f.to,d,v,f.from]),this._from=Pl([f.from,v,d])}}cancel(){this._active&&(this.tick(Date.now()),this._active=!1,this._notify(!1))}tick(f){const d=f-this._start,_=this._duration,v=this._prop,I=this._from,z=this._loop,R=this._to;let F;if(this._active=I!==R&&(z||d<_),!this._active)return this._target[v]=R,void this._notify(!0);d<0?this._target[v]=I:(F=d/_%2,F=z&&F>1?2-F:F,F=this._easing(Math.min(1,Math.max(0,F))),this._target[v]=this._fn(I,R,F))}wait(){const f=this._promises||(this._promises=[]);return new Promise((d,_)=>{f.push({res:d,rej:_})})}_notify(f){const d=f?"res":"rej",_=this._promises||[];for(let v=0;v<_.length;v++)_[v][d]()}}class Ao{constructor(f,d){this._chart=f,this._properties=new Map,this.configure(d)}configure(f){if(!zi(f))return;const d=Object.keys(fn.animation),_=this._properties;Object.getOwnPropertyNames(f).forEach(v=>{const I=f[v];if(!zi(I))return;const z={};for(const R of d)z[R]=I[R];(Yi(I.properties)&&I.properties||[v]).forEach(R=>{(R===v||!_.has(R))&&_.set(R,z)})})}_animateOptions(f,d){const _=d.options,v=function Vl(m,f){if(!f)return;let d=m.options;if(d)return d.$shared&&(m.options=d=Object.assign({},d,{$shared:!1,$animations:{}})),d;m.options=f}(f,_);if(!v)return[];const I=this._createAnimations(v,_);return _.$shared&&function Xa(m,f){const d=[],_=Object.keys(f);for(let v=0;v<_.length;v++){const I=m[_[v]];I&&I.active()&&d.push(I.wait())}return Promise.all(d)}(f.options.$animations,_).then(()=>{f.options=_},()=>{}),I}_createAnimations(f,d){const _=this._properties,v=[],I=f.$animations||(f.$animations={}),z=Object.keys(d),R=Date.now();let F;for(F=z.length-1;F>=0;--F){const H=z[F];if("$"===H.charAt(0))continue;if("options"===H){v.push(...this._animateOptions(f,d));continue}const K=d[H];let ie=I[H];const ue=_.get(H);if(ie){if(ue&&ie.active()){ie.update(ue,K,R);continue}ie.cancel()}ue&&ue.duration?(I[H]=ie=new sa(ue,f,H,K),v.push(ie)):f[H]=K}return v}update(f,d){if(0===this._properties.size)return void Object.assign(f,d);const _=this._createAnimations(f,d);return _.length?(Fr.add(this._chart,_),!0):void 0}}function Ul(m,f){const d=m&&m.options||{},_=d.reverse,v=void 0===d.min?f:0,I=void 0===d.max?f:0;return{start:_?I:v,end:_?v:I}}function Io(m,f){const d=[],_=m._getSortedDatasetMetas(f);let v,I;for(v=0,I=_.length;v<I;++v)d.push(_[v].index);return d}function xi(m,f,d,_={}){const v=m.keys,I="single"===_.mode;let z,R,F,H;if(null===f)return;let K=!1;for(z=0,R=v.length;z<R;++z){if(F=+v[z],F===d){if(K=!0,_.all)continue;break}H=m.values[F],Hi(H)&&(I||0===f||me(f)===me(H))&&(f+=H)}return K||_.all?f:0}function Co(m,f){const d=m&&m.options.stacked;return d||void 0===d&&void 0!==f.stack}function Rd(m,f,d){const _=m[f]||(m[f]={});return _[d]||(_[d]={})}function tn(m,f,d,_){for(const v of f.getMatchingVisibleMetas(_).reverse()){const I=m[v.index];if(d&&I>0||!d&&I<0)return v.index}return null}function Mc(m,f){const{chart:d,_cachedMeta:_}=m,v=d._stacks||(d._stacks={}),{iScale:I,vScale:z,index:R}=_,F=I.axis,H=z.axis,K=function ju(m,f,d){return`${m.id}.${f.id}.${d.stack||d.type}`}(I,z,_),ie=f.length;let ue;for(let xe=0;xe<ie;++xe){const Oe=f[xe],{[F]:Be,[H]:je}=Oe;ue=(Oe._stacks||(Oe._stacks={}))[H]=Rd(v,K,Be),ue[R]=je,ue._top=tn(ue,z,!0,_.type),ue._bottom=tn(ue,z,!1,_.type),(ue._visualValues||(ue._visualValues={}))[R]=je}}function Gl(m,f){const d=m.scales;return Object.keys(d).filter(_=>d[_].axis===f).shift()}function Ka(m,f){const d=m.controller.index,_=m.vScale&&m.vScale.axis;if(_){f=f||m._parsed;for(const v of f){const I=v._stacks;if(!I||void 0===I[_]||void 0===I[_][d])return;delete I[_][d],void 0!==I[_]._visualValues&&void 0!==I[_]._visualValues[d]&&delete I[_]._visualValues[d]}}}const Ec=m=>"reset"===m||"none"===m,qu=(m,f)=>f?m:Object.assign({},m);let as=(()=>class m{static defaults={};static datasetElementType=null;static dataElementType=null;constructor(d,_){this.chart=d,this._ctx=d.ctx,this.index=_,this._cachedDataOpts={},this._cachedMeta=this.getMeta(),this._type=this._cachedMeta.type,this.options=void 0,this._parsing=!1,this._data=void 0,this._objectData=void 0,this._sharedOptions=void 0,this._drawStart=void 0,this._drawCount=void 0,this.enableOptionSharing=!1,this.supportsDecimation=!1,this.$context=void 0,this._syncList=[],this.datasetElementType=new.target.datasetElementType,this.dataElementType=new.target.dataElementType,this.initialize()}initialize(){const d=this._cachedMeta;this.configure(),this.linkScales(),d._stacked=Co(d.vScale,d),this.addElements(),this.options.fill&&!this.chart.isPluginEnabled("filler")&&console.warn("Tried to use the 'fill' option without the 'Filler' plugin enabled. Please import and register the 'Filler' plugin and make sure it is not disabled in the options")}updateIndex(d){this.index!==d&&Ka(this._cachedMeta),this.index=d}linkScales(){const d=this.chart,_=this._cachedMeta,v=this.getDataset(),I=(ue,xe,Oe,Be)=>"x"===ue?xe:"r"===ue?Be:Oe,z=_.xAxisID=Ti(v.xAxisID,Gl(d,"x")),R=_.yAxisID=Ti(v.yAxisID,Gl(d,"y")),F=_.rAxisID=Ti(v.rAxisID,Gl(d,"r")),H=_.indexAxis,K=_.iAxisID=I(H,z,R,F),ie=_.vAxisID=I(H,R,z,F);_.xScale=this.getScaleForId(z),_.yScale=this.getScaleForId(R),_.rScale=this.getScaleForId(F),_.iScale=this.getScaleForId(K),_.vScale=this.getScaleForId(ie)}getDataset(){return this.chart.data.datasets[this.index]}getMeta(){return this.chart.getDatasetMeta(this.index)}getScaleForId(d){return this.chart.scales[d]}_getOtherScale(d){const _=this._cachedMeta;return d===_.iScale?_.vScale:_.iScale}reset(){this._update("reset")}_destroy(){const d=this._cachedMeta;this._data&&As(this._data,this),d._stacked&&Ka(d)}_dataCheck(){const d=this.getDataset(),_=d.data||(d.data=[]),v=this._data;if(zi(_))this._data=function Uu(m,f){const{iScale:d,vScale:_}=f,v="x"===d.axis?"x":"y",I="x"===_.axis?"x":"y",z=Object.keys(m),R=new Array(z.length);let F,H,K;for(F=0,H=z.length;F<H;++F)K=z[F],R[F]={[v]:K,[I]:m[K]};return R}(_,this._cachedMeta);else if(v!==_){if(v){As(v,this);const I=this._cachedMeta;Ka(I),I._parsed=[]}_&&Object.isExtensible(_)&&function Ml(m,f){m._chartjs?m._chartjs.listeners.push(f):(Object.defineProperty(m,"_chartjs",{configurable:!0,enumerable:!1,value:{listeners:[f]}}),ar.forEach(d=>{const _="_onData"+go(d),v=m[d];Object.defineProperty(m,d,{configurable:!0,enumerable:!1,value(...I){const z=v.apply(this,I);return m._chartjs.listeners.forEach(R=>{"function"==typeof R[_]&&R[_](...I)}),z}})}))}(_,this),this._syncList=[],this._data=_}}addElements(){const d=this._cachedMeta;this._dataCheck(),this.datasetElementType&&(d.dataset=new this.datasetElementType)}buildOrUpdateElements(d){const _=this._cachedMeta,v=this.getDataset();let I=!1;this._dataCheck();const z=_._stacked;_._stacked=Co(_.vScale,_),_.stack!==v.stack&&(I=!0,Ka(_),_.stack=v.stack),this._resyncElements(d),(I||z!==_._stacked)&&(Mc(this,_._parsed),_._stacked=Co(_.vScale,_))}configure(){const d=this.chart.config,_=d.datasetScopeKeys(this._type),v=d.getOptionScopes(this.getDataset(),_,!0);this.options=d.createResolver(v,this.getContext()),this._parsing=this.options.parsing,this._cachedDataOpts={}}parse(d,_){const{_cachedMeta:v,_data:I}=this,{iScale:z,_stacked:R}=v,F=z.axis;let ie,ue,xe,H=0===d&&_===I.length||v._sorted,K=d>0&&v._parsed[d-1];if(!1===this._parsing)v._parsed=I,v._sorted=!0,xe=I;else{xe=Yi(I[d])?this.parseArrayData(v,I,d,_):zi(I[d])?this.parseObjectData(v,I,d,_):this.parsePrimitiveData(v,I,d,_);const Oe=()=>null===ue[F]||K&&ue[F]<K[F];for(ie=0;ie<_;++ie)v._parsed[ie+d]=ue=xe[ie],H&&(Oe()&&(H=!1),K=ue);v._sorted=H}R&&Mc(this,xe)}parsePrimitiveData(d,_,v,I){const{iScale:z,vScale:R}=d,F=z.axis,H=R.axis,K=z.getLabels(),ie=z===R,ue=new Array(I);let xe,Oe,Be;for(xe=0,Oe=I;xe<Oe;++xe)Be=xe+v,ue[xe]={[F]:ie||z.parse(K[Be],Be),[H]:R.parse(_[Be],Be)};return ue}parseArrayData(d,_,v,I){const{xScale:z,yScale:R}=d,F=new Array(I);let H,K,ie,ue;for(H=0,K=I;H<K;++H)ie=H+v,ue=_[ie],F[H]={x:z.parse(ue[0],ie),y:R.parse(ue[1],ie)};return F}parseObjectData(d,_,v,I){const{xScale:z,yScale:R}=d,{xAxisKey:F="x",yAxisKey:H="y"}=this._parsing,K=new Array(I);let ie,ue,xe,Oe;for(ie=0,ue=I;ie<ue;++ie)xe=ie+v,Oe=_[xe],K[ie]={x:z.parse(ps(Oe,F),xe),y:R.parse(ps(Oe,H),xe)};return K}getParsed(d){return this._cachedMeta._parsed[d]}getDataElement(d){return this._cachedMeta.data[d]}applyStack(d,_,v){const z=this._cachedMeta,R=_[d.axis];return xi({keys:Io(this.chart,!0),values:_._stacks[d.axis]._visualValues},R,z.index,{mode:v})}updateRangeFromParsed(d,_,v,I){const z=v[_.axis];let R=null===z?NaN:z;const F=I&&v._stacks[_.axis];I&&F&&(I.values=F,R=xi(I,z,this._cachedMeta.index)),d.min=Math.min(d.min,R),d.max=Math.max(d.max,R)}getMinMax(d,_){const v=this._cachedMeta,I=v._parsed,z=v._sorted&&d===v.iScale,R=I.length,F=this._getOtherScale(d),H=((m,f)=>m&&!f.hidden&&f._stacked&&{keys:Io(this.chart,!0),values:null})(_,v),K={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY},{min:ie,max:ue}=function Gu(m){const{min:f,max:d,minDefined:_,maxDefined:v}=m.getUserBounds();return{min:_?f:Number.NEGATIVE_INFINITY,max:v?d:Number.POSITIVE_INFINITY}}(F);let xe,Oe;function Be(){Oe=I[xe];const je=Oe[F.axis];return!Hi(Oe[d.axis])||ie>je||ue<je}for(xe=0;xe<R&&(Be()||(this.updateRangeFromParsed(K,d,Oe,H),!z));++xe);if(z)for(xe=R-1;xe>=0;--xe)if(!Be()){this.updateRangeFromParsed(K,d,Oe,H);break}return K}getAllParsedValues(d){const _=this._cachedMeta._parsed,v=[];let I,z,R;for(I=0,z=_.length;I<z;++I)R=_[I][d.axis],Hi(R)&&v.push(R);return v}getMaxOverflow(){return!1}getLabelAndValue(d){const _=this._cachedMeta,v=_.iScale,I=_.vScale,z=this.getParsed(d);return{label:v?""+v.getLabelForValue(z[v.axis]):"",value:I?""+I.getLabelForValue(z[I.axis]):""}}_update(d){const _=this._cachedMeta;this.update(d||"default"),_._clip=function Ya(m){let f,d,_,v;return zi(m)?(f=m.top,d=m.right,_=m.bottom,v=m.left):f=d=_=v=m,{top:f,right:d,bottom:_,left:v,disabled:!1===m}}(Ti(this.options.clip,function jl(m,f,d){if(!1===d)return!1;const _=Ul(m,d),v=Ul(f,d);return{top:v.end,right:_.end,bottom:v.start,left:_.start}}(_.xScale,_.yScale,this.getMaxOverflow())))}update(d){}draw(){const d=this._ctx,v=this._cachedMeta,I=v.data||[],z=this.chart.chartArea,R=[],F=this._drawStart||0,H=this._drawCount||I.length-F,K=this.options.drawActiveElementsOnTop;let ie;for(v.dataset&&v.dataset.draw(d,z,F,H),ie=F;ie<F+H;++ie){const ue=I[ie];ue.hidden||(ue.active&&K?R.push(ue):ue.draw(d,z))}for(ie=0;ie<R.length;++ie)R[ie].draw(d,z)}getStyle(d,_){const v=_?"active":"default";return void 0===d&&this._cachedMeta.dataset?this.resolveDatasetElementOptions(v):this.resolveDataElementOptions(d||0,v)}getContext(d,_,v){const I=this.getDataset();let z;if(d>=0&&d<this._cachedMeta.data.length){const R=this._cachedMeta.data[d];z=R.$context||(R.$context=function Vh(m,f,d){return Rn(m,{active:!1,dataIndex:f,parsed:void 0,raw:void 0,element:d,index:f,mode:"default",type:"data"})}(this.getContext(),d,R)),z.parsed=this.getParsed(d),z.raw=I.data[d],z.index=z.dataIndex=d}else z=this.$context||(this.$context=function Nh(m,f){return Rn(m,{active:!1,dataset:void 0,datasetIndex:f,index:f,mode:"default",type:"dataset"})}(this.chart.getContext(),this.index)),z.dataset=I,z.index=z.datasetIndex=this.index;return z.active=!!_,z.mode=v,z}resolveDatasetElementOptions(d){return this._resolveElementOptions(this.datasetElementType.id,d)}resolveDataElementOptions(d,_){return this._resolveElementOptions(this.dataElementType.id,_,d)}_resolveElementOptions(d,_="default",v){const I="active"===_,z=this._cachedDataOpts,R=d+"-"+_,F=z[R],H=this.enableOptionSharing&&yo(v);if(F)return qu(F,H);const K=this.chart.config,ie=K.datasetElementScopeKeys(this._type,d),ue=I?[`${d}Hover`,"hover",d,""]:[d,""],xe=K.getOptionScopes(this.getDataset(),ie),Oe=Object.keys(fn.elements[d]),je=K.resolveNamedOptions(xe,Oe,()=>this.getContext(v,I,_),ue);return je.$shared&&(je.$shared=H,z[R]=Object.freeze(qu(je,H))),je}_resolveAnimations(d,_,v){const I=this.chart,z=this._cachedDataOpts,R=`animation-${_}`,F=z[R];if(F)return F;let H;if(!1!==I.options.animation){const ie=this.chart.config,ue=ie.datasetAnimationScopeKeys(this._type,_),xe=ie.getOptionScopes(this.getDataset(),ue);H=ie.createResolver(xe,this.getContext(d,v,_))}const K=new Ao(I,H&&H.animations);return H&&H._cacheable&&(z[R]=Object.freeze(K)),K}getSharedOptions(d){if(d.$shared)return this._sharedOptions||(this._sharedOptions=Object.assign({},d))}includeOptions(d,_){return!_||Ec(d)||this.chart._animationsDisabled}_getSharedOptions(d,_){const v=this.resolveDataElementOptions(d,_),I=this._sharedOptions,z=this.getSharedOptions(v),R=this.includeOptions(_,z)||z!==I;return this.updateSharedOptions(z,_,v),{sharedOptions:z,includeOptions:R}}updateElement(d,_,v,I){Ec(I)?Object.assign(d,v):this._resolveAnimations(_,I).update(d,v)}updateSharedOptions(d,_,v){d&&!Ec(_)&&this._resolveAnimations(void 0,_).update(d,v)}_setStyle(d,_,v,I){d.active=I;const z=this.getStyle(_,I);this._resolveAnimations(_,v,I).update(d,{options:!I&&this.getSharedOptions(z)||z})}removeHoverStyle(d,_,v){this._setStyle(d,v,"active",!1)}setHoverStyle(d,_,v){this._setStyle(d,v,"active",!0)}_removeDatasetHoverStyle(){const d=this._cachedMeta.dataset;d&&this._setStyle(d,void 0,"active",!1)}_setDatasetHoverStyle(){const d=this._cachedMeta.dataset;d&&this._setStyle(d,void 0,"active",!0)}_resyncElements(d){const _=this._data,v=this._cachedMeta.data;for(const[F,H,K]of this._syncList)this[F](H,K);this._syncList=[];const I=v.length,z=_.length,R=Math.min(z,I);R&&this.parse(0,R),z>I?this._insertElements(I,z-I,d):z<I&&this._removeElements(z,I-z)}_insertElements(d,_,v=!0){const I=this._cachedMeta,z=I.data,R=d+_;let F;const H=K=>{for(K.length+=_,F=K.length-1;F>=R;F--)K[F]=K[F-_]};for(H(z),F=d;F<R;++F)z[F]=new this.dataElementType;this._parsing&&H(I._parsed),this.parse(d,_),v&&this.updateElements(z,d,_,"reset")}updateElements(d,_,v,I){}_removeElements(d,_){const v=this._cachedMeta;if(this._parsing){const I=v._parsed.splice(d,_);v._stacked&&Ka(v,I)}v.data.splice(d,_)}_sync(d){if(this._parsing)this._syncList.push(d);else{const[_,v,I]=d;this[_](v,I)}this.chart._dataChanges.push([this.index,...d])}_onDataPush(){const d=arguments.length;this._sync(["_insertElements",this.getDataset().data.length-d,d])}_onDataPop(){this._sync(["_removeElements",this._cachedMeta.data.length-1,1])}_onDataShift(){this._sync(["_removeElements",0,1])}_onDataSplice(d,_){_&&this._sync(["_removeElements",d,_]);const v=arguments.length-2;v&&this._sync(["_insertElements",d,v])}_onDataUnshift(){this._sync(["_insertElements",0,arguments.length])}})();function Br(m){const f=m.iScale,d=function Hu(m,f){if(!m._cache.$bar){const d=m.getMatchingVisibleMetas(f);let _=[];for(let v=0,I=d.length;v<I;v++)_=_.concat(d[v].controller.getAllParsedValues(m));m._cache.$bar=Ua(_.sort((v,I)=>v-I))}return m._cache.$bar}(f,m.type);let v,I,z,R,_=f._length;const F=()=>{32767===z||-32768===z||(yo(R)&&(_=Math.min(_,Math.abs(z-R)||_)),R=z)};for(v=0,I=d.length;v<I;++v)z=f.getPixelForValue(d[v]),F();for(R=void 0,v=0,I=f.ticks.length;v<I;++v)z=f.getPixelForTick(v),F();return _}function Cc(m,f,d,_){return Yi(m)?function Ic(m,f,d,_){const v=d.parse(m[0],_),I=d.parse(m[1],_),z=Math.min(v,I),R=Math.max(v,I);let F=z,H=R;Math.abs(z)>Math.abs(R)&&(F=R,H=z),f[d.axis]=H,f._custom={barStart:F,barEnd:H,start:v,end:I,min:z,max:R}}(m,f,d,_):f[d.axis]=d.parse(m,_),f}function Pc(m,f,d,_){const v=m.iScale,I=m.vScale,z=v.getLabels(),R=v===I,F=[];let H,K,ie,ue;for(H=d,K=d+_;H<K;++H)ue=f[H],ie={},ie[v.axis]=R||v.parse(z[H],H),F.push(Cc(ue,ie,I,H));return F}function Ja(m){return m&&void 0!==m.barStart&&void 0!==m.barEnd}function Dc(m,f,d,_){let v=f.borderSkipped;const I={};if(!v)return void(m.borderSkipped=I);if(!0===v)return void(m.borderSkipped={top:!0,right:!0,bottom:!0,left:!0});const{start:z,end:R,reverse:F,top:H,bottom:K}=function Gh(m){let f,d,_,v,I;return m.horizontal?(f=m.base>m.x,d="left",_="right"):(f=m.base<m.y,d="bottom",_="top"),f?(v="end",I="start"):(v="start",I="end"),{start:d,end:_,reverse:f,top:v,bottom:I}}(m);"middle"===v&&d&&(m.enableBorderRadius=!0,(d._top||0)===_?v=H:(d._bottom||0)===_?v=K:(I[qh(K,z,R,F)]=!0,v=H)),I[qh(v,z,R,F)]=!0,m.borderSkipped=I}function qh(m,f,d,_){return _?(m=function Wu(m,f,d){return m===f?d:m===d?f:m}(m,f,d),m=oa(m,d,f)):m=oa(m,f,d),m}function oa(m,f,d){return"start"===m?f:"end"===m?d:m}function Ld(m,{inflateAmount:f},d){m.inflateAmount="auto"===f?1===d?.33:0:f}let kd=(()=>class m extends as{static id="bar";static defaults={datasetElementType:!1,dataElementType:"bar",categoryPercentage:.8,barPercentage:.9,grouped:!0,animations:{numbers:{type:"number",properties:["x","y","base","width","height"]}}};static overrides={scales:{_index_:{type:"category",offset:!0,grid:{offset:!0}},_value_:{type:"linear",beginAtZero:!0}}};parsePrimitiveData(d,_,v,I){return Pc(d,_,v,I)}parseArrayData(d,_,v,I){return Pc(d,_,v,I)}parseObjectData(d,_,v,I){const{iScale:z,vScale:R}=d,{xAxisKey:F="x",yAxisKey:H="y"}=this._parsing,K="x"===z.axis?F:H,ie="x"===R.axis?F:H,ue=[];let xe,Oe,Be,je;for(xe=v,Oe=v+I;xe<Oe;++xe)je=_[xe],Be={},Be[z.axis]=z.parse(ps(je,K),xe),ue.push(Cc(ps(je,ie),Be,R,xe));return ue}updateRangeFromParsed(d,_,v,I){super.updateRangeFromParsed(d,_,v,I);const z=v._custom;z&&_===this._cachedMeta.vScale&&(d.min=Math.min(d.min,z.min),d.max=Math.max(d.max,z.max))}getMaxOverflow(){return 0}getLabelAndValue(d){const _=this._cachedMeta,{iScale:v,vScale:I}=_,z=this.getParsed(d),R=z._custom,F=Ja(R)?"["+R.start+", "+R.end+"]":""+I.getLabelForValue(z[I.axis]);return{label:""+v.getLabelForValue(z[v.axis]),value:F}}initialize(){this.enableOptionSharing=!0,super.initialize(),this._cachedMeta.stack=this.getDataset().stack}update(d){const _=this._cachedMeta;this.updateElements(_.data,0,_.data.length,d)}updateElements(d,_,v,I){const z="reset"===I,{index:R,_cachedMeta:{vScale:F}}=this,H=F.getBasePixel(),K=F.isHorizontal(),ie=this._getRuler(),{sharedOptions:ue,includeOptions:xe}=this._getSharedOptions(_,I);for(let Oe=_;Oe<_+v;Oe++){const Be=this.getParsed(Oe),je=z||Ai(Be[F.axis])?{base:H,head:H}:this._calculateBarValuePixels(Oe),ht=this._calculateBarIndexPixels(Oe,ie),lt=(Be._stacks||{})[F.axis],Et={horizontal:K,base:je.base,enableBorderRadius:!lt||Ja(Be._custom)||R===lt._top||R===lt._bottom,x:K?je.head:ht.center,y:K?ht.center:je.head,height:K?ht.size:Math.abs(je.size),width:K?Math.abs(je.size):ht.size};xe&&(Et.options=ue||this.resolveDataElementOptions(Oe,d[Oe].active?"active":I));const Dt=Et.options||d[Oe].options;Dc(Et,Dt,lt,R),Ld(Et,Dt,ie.ratio),this.updateElement(d[Oe],Oe,Et,I)}}_getStacks(d,_){const{iScale:v}=this._cachedMeta,I=v.getMatchingVisibleMetas(this._type).filter(ie=>ie.controller.options.grouped),z=v.options.stacked,R=[],F=this._cachedMeta.controller.getParsed(_),H=F&&F[v.axis],K=ie=>{const ue=ie._parsed.find(Oe=>Oe[v.axis]===H),xe=ue&&ue[ie.vScale.axis];if(Ai(xe)||isNaN(xe))return!0};for(const ie of I)if((void 0===_||!K(ie))&&((!1===z||-1===R.indexOf(ie.stack)||void 0===z&&void 0===ie.stack)&&R.push(ie.stack),ie.index===d))break;return R.length||R.push(void 0),R}_getStackCount(d){return this._getStacks(void 0,d).length}_getStackIndex(d,_,v){const I=this._getStacks(d,v),z=void 0!==_?I.indexOf(_):-1;return-1===z?I.length-1:z}_getRuler(){const d=this.options,_=this._cachedMeta,v=_.iScale,I=[];let z,R;for(z=0,R=_.data.length;z<R;++z)I.push(v.getPixelForValue(this.getParsed(z)[v.axis],z));const F=d.barThickness;return{min:F||Br(_),pixels:I,start:v._startPixel,end:v._endPixel,stackCount:this._getStackCount(),scale:v,grouped:d.grouped,ratio:F?1:d.categoryPercentage*d.barPercentage}}_calculateBarValuePixels(d){const{_cachedMeta:{vScale:_,_stacked:v,index:I},options:{base:z,minBarLength:R}}=this,F=z||0,H=this.getParsed(d),K=H._custom,ie=Ja(K);let Be,je,ue=H[_.axis],xe=0,Oe=v?this.applyStack(_,H,v):ue;Oe!==ue&&(xe=Oe-ue,Oe=ue),ie&&(ue=K.barStart,Oe=K.barEnd-K.barStart,0!==ue&&me(ue)!==me(K.barEnd)&&(xe=0),xe+=ue);const ht=Ai(z)||ie?xe:z;let lt=_.getPixelForValue(ht);if(Be=this.chart.getDataVisibility(d)?_.getPixelForValue(xe+Oe):lt,je=Be-lt,Math.abs(je)<R){je=function jh(m,f,d){return 0!==m?me(m):(f.isHorizontal()?1:-1)*(f.min>=d?1:-1)}(je,_,F)*R,ue===F&&(lt-=je/2);const Et=_.getPixelForDecimal(0),Dt=_.getPixelForDecimal(1),xt=Math.min(Et,Dt),At=Math.max(Et,Dt);lt=Math.max(Math.min(lt,At),xt),Be=lt+je,v&&!ie&&(H._stacks[_.axis]._visualValues[I]=_.getValueForPixel(Be)-_.getValueForPixel(lt))}if(lt===_.getPixelForValue(F)){const Et=me(je)*_.getLineWidthForValue(F)/2;lt+=Et,je-=Et}return{size:je,base:lt,head:Be,center:Be+je/2}}_calculateBarIndexPixels(d,_){const v=_.scale,I=this.options,z=I.skipNull,R=Ti(I.maxBarThickness,1/0);let F,H;if(_.grouped){const K=z?this._getStackCount(d):_.stackCount,ie="flex"===I.barThickness?function Ac(m,f,d,_){const v=f.pixels,I=v[m];let z=m>0?v[m-1]:null,R=m<v.length-1?v[m+1]:null;const F=d.categoryPercentage;null===z&&(z=I-(null===R?f.end-f.start:R-I)),null===R&&(R=I+I-z);const H=I-(I-Math.min(z,R))/2*F;return{chunk:Math.abs(R-z)/2*F/_,ratio:d.barPercentage,start:H}}(d,_,I,K):function Uh(m,f,d,_){const v=d.barThickness;let I,z;return Ai(v)?(I=f.min*d.categoryPercentage,z=d.barPercentage):(I=v*_,z=1),{chunk:I/_,ratio:z,start:f.pixels[m]-I/2}}(d,_,I,K),ue=this._getStackIndex(this.index,this._cachedMeta.stack,z?d:void 0);F=ie.start+ie.chunk*ue+ie.chunk/2,H=Math.min(R,ie.chunk*ie.ratio)}else F=v.getPixelForValue(this.getParsed(d)[v.axis],d),H=Math.min(R,_.min*_.ratio);return{base:F-H/2,head:F+H/2,center:F,size:H}}draw(){const d=this._cachedMeta,_=d.vScale,v=d.data,I=v.length;let z=0;for(;z<I;++z)null!==this.getParsed(z)[_.axis]&&!v[z].hidden&&v[z].draw(this._ctx)}})(),Od=(()=>class m extends as{static id="bubble";static defaults={datasetElementType:!1,dataElementType:"point",animations:{numbers:{type:"number",properties:["x","y","borderWidth","radius"]}}};static overrides={scales:{x:{type:"linear"},y:{type:"linear"}}};initialize(){this.enableOptionSharing=!0,super.initialize()}parsePrimitiveData(d,_,v,I){const z=super.parsePrimitiveData(d,_,v,I);for(let R=0;R<z.length;R++)z[R]._custom=this.resolveDataElementOptions(R+v).radius;return z}parseArrayData(d,_,v,I){const z=super.parseArrayData(d,_,v,I);for(let R=0;R<z.length;R++)z[R]._custom=Ti(_[v+R][2],this.resolveDataElementOptions(R+v).radius);return z}parseObjectData(d,_,v,I){const z=super.parseObjectData(d,_,v,I);for(let R=0;R<z.length;R++){const F=_[v+R];z[R]._custom=Ti(F&&F.r&&+F.r,this.resolveDataElementOptions(R+v).radius)}return z}getMaxOverflow(){const d=this._cachedMeta.data;let _=0;for(let v=d.length-1;v>=0;--v)_=Math.max(_,d[v].size(this.resolveDataElementOptions(v))/2);return _>0&&_}getLabelAndValue(d){const _=this._cachedMeta,v=this.chart.data.labels||[],{xScale:I,yScale:z}=_,R=this.getParsed(d),F=I.getLabelForValue(R.x),H=z.getLabelForValue(R.y),K=R._custom;return{label:v[d]||"",value:"("+F+", "+H+(K?", "+K:"")+")"}}update(d){const _=this._cachedMeta.data;this.updateElements(_,0,_.length,d)}updateElements(d,_,v,I){const z="reset"===I,{iScale:R,vScale:F}=this._cachedMeta,{sharedOptions:H,includeOptions:K}=this._getSharedOptions(_,I),ie=R.axis,ue=F.axis;for(let xe=_;xe<_+v;xe++){const Oe=d[xe],Be=!z&&this.getParsed(xe),je={},ht=je[ie]=z?R.getPixelForDecimal(.5):R.getPixelForValue(Be[ie]),lt=je[ue]=z?F.getBasePixel():F.getPixelForValue(Be[ue]);je.skip=isNaN(ht)||isNaN(lt),K&&(je.options=H||this.resolveDataElementOptions(xe,Oe.active?"active":I),z&&(je.options.radius=0)),this.updateElement(Oe,xe,je,I)}}resolveDataElementOptions(d,_){const v=this.getParsed(d);let I=super.resolveDataElementOptions(d,_);I.$shared&&(I=Object.assign({},I,{$shared:!1}));const z=I.radius;return"active"!==_&&(I.radius=0),I.radius+=Ti(v&&v._custom,z),I}})(),Hh=(()=>class m extends as{static id="doughnut";static defaults={datasetElementType:!1,dataElementType:"arc",animation:{animateRotate:!0,animateScale:!1},animations:{numbers:{type:"number",properties:["circumference","endAngle","innerRadius","outerRadius","startAngle","x","y","offset","borderWidth","spacing"]}},cutout:"50%",rotation:0,circumference:360,radius:"100%",spacing:0,indexAxis:"r"};static descriptors={_scriptable:d=>"spacing"!==d,_indexable:d=>"spacing"!==d&&!d.startsWith("borderDash")&&!d.startsWith("hoverBorderDash")};static overrides={aspectRatio:1,plugins:{legend:{labels:{generateLabels(d){const _=d.data;if(_.labels.length&&_.datasets.length){const{labels:{pointStyle:v,color:I}}=d.legend.options;return _.labels.map((z,R)=>{const H=d.getDatasetMeta(0).controller.getStyle(R);return{text:z,fillStyle:H.backgroundColor,strokeStyle:H.borderColor,fontColor:I,lineWidth:H.borderWidth,pointStyle:v,hidden:!d.getDataVisibility(R),index:R}})}return[]}},onClick(d,_,v){v.chart.toggleDataVisibility(_.index),v.chart.update()}}}};constructor(d,_){super(d,_),this.enableOptionSharing=!0,this.innerRadius=void 0,this.outerRadius=void 0,this.offsetX=void 0,this.offsetY=void 0}linkScales(){}parse(d,_){const v=this.getDataset().data,I=this._cachedMeta;if(!1===this._parsing)I._parsed=v;else{let R,F,z=H=>+v[H];if(zi(v[d])){const{key:H="value"}=this._parsing;z=K=>+ps(v[K],H)}for(R=d,F=d+_;R<F;++R)I._parsed[R]=z(R)}}_getRotation(){return ot(this.options.rotation-90)}_getCircumference(){return ot(this.options.circumference)}_getRotationExtents(){let d=ln,_=-ln;for(let v=0;v<this.chart.data.datasets.length;++v)if(this.chart.isDatasetVisible(v)&&this.chart.getDatasetMeta(v).type===this._type){const I=this.chart.getDatasetMeta(v).controller,z=I._getRotation(),R=I._getCircumference();d=Math.min(d,z),_=Math.max(_,z+R)}return{rotation:d,circumference:_-d}}update(d){const _=this.chart,{chartArea:v}=_,I=this._cachedMeta,z=I.data,R=this.getMaxBorderWidth()+this.getMaxOffset(z)+this.options.spacing,F=Math.max((Math.min(v.width,v.height)-R)/2,0),H=Math.min(((m,f)=>"string"==typeof m&&m.endsWith("%")?parseFloat(m)/100:+m/f)(this.options.cutout,F),1),K=this._getRingWeight(this.index),{circumference:ie,rotation:ue}=this._getRotationExtents(),{ratioX:xe,ratioY:Oe,offsetX:Be,offsetY:je}=function Fd(m,f,d){let _=1,v=1,I=0,z=0;if(f<ln){const R=m,F=R+f,H=Math.cos(R),K=Math.sin(R),ie=Math.cos(F),ue=Math.sin(F),xe=(Et,Dt,xt)=>mi(Et,R,F,!0)?1:Math.max(Dt,Dt*d,xt,xt*d),Oe=(Et,Dt,xt)=>mi(Et,R,F,!0)?-1:Math.min(Dt,Dt*d,xt,xt*d),Be=xe(0,H,ie),je=xe($,K,ue),ht=Oe(pn,H,ie),lt=Oe(pn+$,K,ue);_=(Be-ht)/2,v=(je-lt)/2,I=-(Be+ht)/2,z=-(je+lt)/2}return{ratioX:_,ratioY:v,offsetX:I,offsetY:z}}(ue,ie,H),Et=Math.max(Math.min((v.width-R)/xe,(v.height-R)/Oe)/2,0),Dt=Jo(this.options.radius,Et),At=(Dt-Math.max(Dt*H,0))/this._getVisibleDatasetWeightTotal();this.offsetX=Be*Dt,this.offsetY=je*Dt,I.total=this.calculateTotal(),this.outerRadius=Dt-At*this._getRingWeightOffset(this.index),this.innerRadius=Math.max(this.outerRadius-At*K,0),this.updateElements(z,0,z.length,d)}_circumference(d,_){const v=this.options,I=this._cachedMeta,z=this._getCircumference();return _&&v.animation.animateRotate||!this.chart.getDataVisibility(d)||null===I._parsed[d]||I.data[d].hidden?0:this.calculateCircumference(I._parsed[d]*z/ln)}updateElements(d,_,v,I){const z="reset"===I,R=this.chart,F=R.chartArea,ie=(F.left+F.right)/2,ue=(F.top+F.bottom)/2,xe=z&&R.options.animation.animateScale,Oe=xe?0:this.innerRadius,Be=xe?0:this.outerRadius,{sharedOptions:je,includeOptions:ht}=this._getSharedOptions(_,I);let Et,lt=this._getRotation();for(Et=0;Et<_;++Et)lt+=this._circumference(Et,z);for(Et=_;Et<_+v;++Et){const Dt=this._circumference(Et,z),xt=d[Et],At={x:ie+this.offsetX,y:ue+this.offsetY,startAngle:lt,endAngle:lt+Dt,circumference:Dt,outerRadius:Be,innerRadius:Oe};ht&&(At.options=je||this.resolveDataElementOptions(Et,xt.active?"active":I)),lt+=Dt,this.updateElement(xt,Et,At,I)}}calculateTotal(){const d=this._cachedMeta,_=d.data;let I,v=0;for(I=0;I<_.length;I++){const z=d._parsed[I];null!==z&&!isNaN(z)&&this.chart.getDataVisibility(I)&&!_[I].hidden&&(v+=Math.abs(z))}return v}calculateCircumference(d){const _=this._cachedMeta.total;return _>0&&!isNaN(d)?ln*(Math.abs(d)/_):0}getLabelAndValue(d){const v=this.chart,I=v.data.labels||[],z=xo(this._cachedMeta._parsed[d],v.options.locale);return{label:I[d]||"",value:z}}getMaxBorderWidth(d){let _=0;const v=this.chart;let I,z,R,F,H;if(!d)for(I=0,z=v.data.datasets.length;I<z;++I)if(v.isDatasetVisible(I)){R=v.getDatasetMeta(I),d=R.data,F=R.controller;break}if(!d)return 0;for(I=0,z=d.length;I<z;++I)H=F.resolveDataElementOptions(I),"inner"!==H.borderAlign&&(_=Math.max(_,H.borderWidth||0,H.hoverBorderWidth||0));return _}getMaxOffset(d){let _=0;for(let v=0,I=d.length;v<I;++v){const z=this.resolveDataElementOptions(v);_=Math.max(_,z.offset||0,z.hoverOffset||0)}return _}_getRingWeightOffset(d){let _=0;for(let v=0;v<d;++v)this.chart.isDatasetVisible(v)&&(_+=this._getRingWeight(v));return _}_getRingWeight(d){return Math.max(Ti(this.chart.data.datasets[d].weight,1),0)}_getVisibleDatasetWeightTotal(){return this._getRingWeightOffset(this.chart.data.datasets.length)||1}})(),Bd=(()=>class m extends as{static id="line";static defaults={datasetElementType:"line",dataElementType:"point",showLine:!0,spanGaps:!1};static overrides={scales:{_index_:{type:"category"},_value_:{type:"linear"}}};initialize(){this.enableOptionSharing=!0,this.supportsDecimation=!0,super.initialize()}update(d){const _=this._cachedMeta,{dataset:v,data:I=[],_dataset:z}=_,R=this.chart._animationsDisabled;let{start:F,count:H}=ms(_,I,R);this._drawStart=F,this._drawCount=H,ns(_)&&(F=0,H=I.length),v._chart=this.chart,v._datasetIndex=this.index,v._decimated=!!z._decimated,v.points=I;const K=this.resolveDatasetElementOptions(d);this.options.showLine||(K.borderWidth=0),K.segment=this.options.segment,this.updateElement(v,void 0,{animated:!R,options:K},d),this.updateElements(I,F,H,d)}updateElements(d,_,v,I){const z="reset"===I,{iScale:R,vScale:F,_stacked:H,_dataset:K}=this._cachedMeta,{sharedOptions:ie,includeOptions:ue}=this._getSharedOptions(_,I),xe=R.axis,Oe=F.axis,{spanGaps:Be,segment:je}=this.options,ht=Fe(Be)?Be:Number.POSITIVE_INFINITY,lt=this.chart._animationsDisabled||z||"none"===I,Et=_+v,Dt=d.length;let xt=_>0&&this.getParsed(_-1);for(let At=0;At<Dt;++At){const Ht=d[At],Ot=lt?Ht:{};if(At<_||At>=Et){Ot.skip=!0;continue}const Bt=this.getParsed(At),Fi=Ai(Bt[Oe]),Vi=Ot[xe]=R.getPixelForValue(Bt[xe],At),Wi=Ot[Oe]=z||Fi?F.getBasePixel():F.getPixelForValue(H?this.applyStack(F,Bt,H):Bt[Oe],At);Ot.skip=isNaN(Vi)||isNaN(Wi)||Fi,Ot.stop=At>0&&Math.abs(Bt[xe]-xt[xe])>ht,je&&(Ot.parsed=Bt,Ot.raw=K.data[At]),ue&&(Ot.options=ie||this.resolveDataElementOptions(At,Ht.active?"active":I)),lt||this.updateElement(Ht,At,Ot,I),xt=Bt}}getMaxOverflow(){const d=this._cachedMeta,_=d.dataset,v=_.options&&_.options.borderWidth||0,I=d.data||[];if(!I.length)return v;const z=I[0].size(this.resolveDataElementOptions(0)),R=I[I.length-1].size(this.resolveDataElementOptions(I.length-1));return Math.max(v,z,R)/2}draw(){const d=this._cachedMeta;d.dataset.updateControlPoints(this.chart.chartArea,d.iScale.axis),super.draw()}})(),zc=(()=>class m extends as{static id="polarArea";static defaults={dataElementType:"arc",animation:{animateRotate:!0,animateScale:!0},animations:{numbers:{type:"number",properties:["x","y","startAngle","endAngle","innerRadius","outerRadius"]}},indexAxis:"r",startAngle:0};static overrides={aspectRatio:1,plugins:{legend:{labels:{generateLabels(d){const _=d.data;if(_.labels.length&&_.datasets.length){const{labels:{pointStyle:v,color:I}}=d.legend.options;return _.labels.map((z,R)=>{const H=d.getDatasetMeta(0).controller.getStyle(R);return{text:z,fillStyle:H.backgroundColor,strokeStyle:H.borderColor,fontColor:I,lineWidth:H.borderWidth,pointStyle:v,hidden:!d.getDataVisibility(R),index:R}})}return[]}},onClick(d,_,v){v.chart.toggleDataVisibility(_.index),v.chart.update()}}},scales:{r:{type:"radialLinear",angleLines:{display:!1},beginAtZero:!0,grid:{circular:!0},pointLabels:{display:!1},startAngle:0}}};constructor(d,_){super(d,_),this.innerRadius=void 0,this.outerRadius=void 0}getLabelAndValue(d){const v=this.chart,I=v.data.labels||[],z=xo(this._cachedMeta._parsed[d].r,v.options.locale);return{label:I[d]||"",value:z}}parseObjectData(d,_,v,I){return wo.bind(this)(d,_,v,I)}update(d){const _=this._cachedMeta.data;this._updateRadius(),this.updateElements(_,0,_.length,d)}getMinMax(){const _={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};return this._cachedMeta.data.forEach((v,I)=>{const z=this.getParsed(I).r;!isNaN(z)&&this.chart.getDataVisibility(I)&&(z<_.min&&(_.min=z),z>_.max&&(_.max=z))}),_}_updateRadius(){const d=this.chart,_=d.chartArea,v=d.options,I=Math.min(_.right-_.left,_.bottom-_.top),z=Math.max(I/2,0),F=(z-Math.max(v.cutoutPercentage?z/100*v.cutoutPercentage:1,0))/d.getVisibleDatasetCount();this.outerRadius=z-F*this.index,this.innerRadius=this.outerRadius-F}updateElements(d,_,v,I){const z="reset"===I,R=this.chart,H=R.options.animation,K=this._cachedMeta.rScale,ie=K.xCenter,ue=K.yCenter,xe=K.getIndexAngle(0)-.5*pn;let Be,Oe=xe;const je=360/this.countVisibleElements();for(Be=0;Be<_;++Be)Oe+=this._computeAngle(Be,I,je);for(Be=_;Be<_+v;Be++){const ht=d[Be];let lt=Oe,Et=Oe+this._computeAngle(Be,I,je),Dt=R.getDataVisibility(Be)?K.getDistanceFromCenterForValue(this.getParsed(Be).r):0;Oe=Et,z&&(H.animateScale&&(Dt=0),H.animateRotate&&(lt=Et=xe));const xt={x:ie,y:ue,innerRadius:0,outerRadius:Dt,startAngle:lt,endAngle:Et,options:this.resolveDataElementOptions(Be,ht.active?"active":I)};this.updateElement(ht,Be,xt,I)}}countVisibleElements(){let _=0;return this._cachedMeta.data.forEach((v,I)=>{!isNaN(this.getParsed(I).r)&&this.chart.getDataVisibility(I)&&_++}),_}_computeAngle(d,_,v){return this.chart.getDataVisibility(d)?ot(this.resolveDataElementOptions(d,_).angle||v):0}})();var $h=Object.freeze({__proto__:null,BarController:kd,BubbleController:Od,DoughnutController:Hh,LineController:Bd,PieController:(()=>class m extends Hh{static id="pie";static defaults={cutout:0,rotation:0,circumference:360,radius:"100%"}})(),PolarAreaController:zc,RadarController:(()=>class m extends as{static id="radar";static defaults={datasetElementType:"line",dataElementType:"point",indexAxis:"r",showLine:!0,elements:{line:{fill:"start"}}};static overrides={aspectRatio:1,scales:{r:{type:"radialLinear"}}};getLabelAndValue(d){const _=this._cachedMeta.vScale,v=this.getParsed(d);return{label:_.getLabels()[d],value:""+_.getLabelForValue(v[_.axis])}}parseObjectData(d,_,v,I){return wo.bind(this)(d,_,v,I)}update(d){const _=this._cachedMeta,v=_.dataset,I=_.data||[],z=_.iScale.getLabels();if(v.points=I,"resize"!==d){const R=this.resolveDatasetElementOptions(d);this.options.showLine||(R.borderWidth=0),this.updateElement(v,void 0,{_loop:!0,_fullLoop:z.length===I.length,options:R},d)}this.updateElements(I,0,I.length,d)}updateElements(d,_,v,I){const z=this._cachedMeta.rScale,R="reset"===I;for(let F=_;F<_+v;F++){const H=d[F],K=this.resolveDataElementOptions(F,H.active?"active":I),ie=z.getPointPositionForValue(F,this.getParsed(F).r),ue=R?z.xCenter:ie.x,xe=R?z.yCenter:ie.y,Oe={x:ue,y:xe,angle:ie.angle,skip:isNaN(ue)||isNaN(xe),options:K};this.updateElement(H,F,Oe,I)}}})(),ScatterController:(()=>class m extends as{static id="scatter";static defaults={datasetElementType:!1,dataElementType:"point",showLine:!1,fill:!1};static overrides={interaction:{mode:"point"},scales:{x:{type:"linear"},y:{type:"linear"}}};getLabelAndValue(d){const _=this._cachedMeta,v=this.chart.data.labels||[],{xScale:I,yScale:z}=_,R=this.getParsed(d),F=I.getLabelForValue(R.x),H=z.getLabelForValue(R.y);return{label:v[d]||"",value:"("+F+", "+H+")"}}update(d){const _=this._cachedMeta,{data:v=[]}=_,I=this.chart._animationsDisabled;let{start:z,count:R}=ms(_,v,I);if(this._drawStart=z,this._drawCount=R,ns(_)&&(z=0,R=v.length),this.options.showLine){this.datasetElementType||this.addElements();const{dataset:F,_dataset:H}=_;F._chart=this.chart,F._datasetIndex=this.index,F._decimated=!!H._decimated,F.points=v;const K=this.resolveDatasetElementOptions(d);K.segment=this.options.segment,this.updateElement(F,void 0,{animated:!I,options:K},d)}else this.datasetElementType&&(delete _.dataset,this.datasetElementType=!1);this.updateElements(v,z,R,d)}addElements(){const{showLine:d}=this.options;!this.datasetElementType&&d&&(this.datasetElementType=this.chart.registry.getElement("line")),super.addElements()}updateElements(d,_,v,I){const z="reset"===I,{iScale:R,vScale:F,_stacked:H,_dataset:K}=this._cachedMeta,ie=this.resolveDataElementOptions(_,I),ue=this.getSharedOptions(ie),xe=this.includeOptions(I,ue),Oe=R.axis,Be=F.axis,{spanGaps:je,segment:ht}=this.options,lt=Fe(je)?je:Number.POSITIVE_INFINITY,Et=this.chart._animationsDisabled||z||"none"===I;let Dt=_>0&&this.getParsed(_-1);for(let xt=_;xt<_+v;++xt){const At=d[xt],Ht=this.getParsed(xt),Ot=Et?At:{},Bt=Ai(Ht[Be]),Fi=Ot[Oe]=R.getPixelForValue(Ht[Oe],xt),Vi=Ot[Be]=z||Bt?F.getBasePixel():F.getPixelForValue(H?this.applyStack(F,Ht,H):Ht[Be],xt);Ot.skip=isNaN(Fi)||isNaN(Vi)||Bt,Ot.stop=xt>0&&Math.abs(Ht[Oe]-Dt[Oe])>lt,ht&&(Ot.parsed=Ht,Ot.raw=K.data[xt]),xe&&(Ot.options=ue||this.resolveDataElementOptions(xt,At.active?"active":I)),Et||this.updateElement(At,xt,Ot,I),Dt=Ht}this.updateSharedOptions(ue,I,ie)}getMaxOverflow(){const d=this._cachedMeta,_=d.data||[];if(!this.options.showLine){let F=0;for(let H=_.length-1;H>=0;--H)F=Math.max(F,_[H].size(this.resolveDataElementOptions(H))/2);return F>0&&F}const v=d.dataset,I=v.options&&v.options.borderWidth||0;if(!_.length)return I;const z=_[0].size(this.resolveDataElementOptions(0)),R=_[_.length-1].size(this.resolveDataElementOptions(_.length-1));return Math.max(I,z,R)/2}})()});function Po(){throw new Error("This method is not implemented: Check that a complete date adapter is provided.")}class Rc{static override(f){Object.assign(Rc.prototype,f)}options;constructor(f){this.options=f||{}}init(){}formats(){return Po()}parse(){return Po()}format(){return Po()}add(){return Po()}diff(){return Po()}startOf(){return Po()}endOf(){return Po()}}var Zh__date=Rc;function Do(m,f,d,_){const{controller:v,data:I,_sorted:z}=m,R=v._cachedMeta.iScale,F=m.dataset&&m.dataset.options?m.dataset.options.spanGaps:null;if(R&&f===R.axis&&"r"!==f&&z&&I.length){const H=R._reversePixels?zn:ir;if(!_){const K=H(I,f,d);if(F){const{vScale:ie}=v._cachedMeta,{_parsed:ue}=m,xe=ue.slice(0,K.lo+1).reverse().findIndex(Be=>!Ai(Be[ie.axis]));K.lo-=Math.max(0,xe);const Oe=ue.slice(K.hi).findIndex(Be=>!Ai(Be[ie.axis]));K.hi+=Math.max(0,Oe)}return K}if(v._sharedOptions){const K=I[0],ie="function"==typeof K.getRange&&K.getRange(f);if(ie){const ue=H(I,f,d-ie),xe=H(I,f,d+ie);return{lo:ue.lo,hi:xe.hi}}}}return{lo:0,hi:I.length-1}}function aa(m,f,d,_,v){const I=m.getSortedVisibleDatasetMetas(),z=d[f];for(let R=0,F=I.length;R<F;++R){const{index:H,data:K}=I[R],{lo:ie,hi:ue}=Do(I[R],f,z,v);for(let xe=ie;xe<=ue;++xe){const Oe=K[xe];Oe.skip||_(Oe,H,xe)}}}function Qa(m,f,d,_,v){const I=[];return!v&&!m.isPointInArea(f)||aa(m,d,f,function(R,F,H){!v&&!Wr(R,m.chartArea,0)||R.inRange(f.x,f.y,_)&&I.push({element:R,datasetIndex:F,index:H})},!0),I}function el(m,f,d,_,v,I){return I||m.isPointInArea(f)?"r"!==d||_?function Zu(m,f,d,_,v,I){let z=[];const R=function $r(m){const f=-1!==m.indexOf("x"),d=-1!==m.indexOf("y");return function(_,v){const I=f?Math.abs(_.x-v.x):0,z=d?Math.abs(_.y-v.y):0;return Math.sqrt(Math.pow(I,2)+Math.pow(z,2))}}(d);let F=Number.POSITIVE_INFINITY;return aa(m,d,f,function H(K,ie,ue){const xe=K.inRange(f.x,f.y,v);if(_&&!xe)return;const Oe=K.getCenterPoint(v);if(!I&&!m.isPointInArea(Oe)&&!xe)return;const je=R(f,Oe);je<F?(z=[{element:K,datasetIndex:ie,index:ue}],F=je):je===F&&z.push({element:K,datasetIndex:ie,index:ue})}),z}(m,f,d,_,v,I):function Wl(m,f,d,_){let v=[];return aa(m,d,f,function I(z,R,F){const{startAngle:H,endAngle:K}=z.getProps(["startAngle","endAngle"],_),{angle:ie}=Nt(z,{x:f.x,y:f.y});mi(ie,H,K)&&v.push({element:z,datasetIndex:R,index:F})}),v}(m,f,d,v):[]}function tl(m,f,d,_,v){const I=[],z="x"===d?"inXRange":"inYRange";let R=!1;return aa(m,d,f,(F,H,K)=>{F[z]&&F[z](f[d],v)&&(I.push({element:F,datasetIndex:H,index:K}),R=R||F.inRange(f.x,f.y,v))}),_&&!R?[]:I}var Xh={evaluateInteractionItems:aa,modes:{index(m,f,d,_){const v=Ir(f,m),I=d.axis||"x",z=d.includeInvisible||!1,R=d.intersect?Qa(m,v,I,_,z):el(m,v,I,!1,_,z),F=[];return R.length?(m.getSortedVisibleDatasetMetas().forEach(H=>{const K=R[0].index,ie=H.data[K];ie&&!ie.skip&&F.push({element:ie,datasetIndex:H.index,index:K})}),F):[]},dataset(m,f,d,_){const v=Ir(f,m),I=d.axis||"xy",z=d.includeInvisible||!1;let R=d.intersect?Qa(m,v,I,_,z):el(m,v,I,!1,_,z);if(R.length>0){const F=R[0].datasetIndex,H=m.getDatasetMeta(F).data;R=[];for(let K=0;K<H.length;++K)R.push({element:H[K],datasetIndex:F,index:K})}return R},point:(m,f,d,_)=>Qa(m,Ir(f,m),d.axis||"xy",_,d.includeInvisible||!1),nearest:(m,f,d,_)=>el(m,Ir(f,m),d.axis||"xy",d.intersect,_,d.includeInvisible||!1),x:(m,f,d,_)=>tl(m,Ir(f,m),"x",d.intersect,_),y:(m,f,d,_)=>tl(m,Ir(f,m),"y",d.intersect,_)}};const Xu=["left","top","right","bottom"];function la(m,f){return m.filter(d=>d.pos===f)}function ca(m,f){return m.filter(d=>-1===Xu.indexOf(d.pos)&&d.box.axis===f)}function $l(m,f){return m.sort((d,_)=>{const v=f?_:d,I=f?d:_;return v.weight===I.weight?v.index-I.index:v.weight-I.weight})}function ha(m,f,d,_){return Math.max(m[d],f[d])+Math.max(m[_],f[_])}function ua(m,f){m.top=Math.max(m.top,f.top),m.left=Math.max(m.left,f.left),m.bottom=Math.max(m.bottom,f.bottom),m.right=Math.max(m.right,f.right)}function kc(m,f,d,_){const{pos:v,box:I}=d,z=m.maxPadding;if(!zi(v)){d.size&&(m[v]-=d.size);const ie=_[d.stack]||{size:0,count:1};ie.size=Math.max(ie.size,d.horizontal?I.height:I.width),d.size=ie.size/ie.count,m[v]+=d.size}I.getPadding&&ua(z,I.getPadding());const R=Math.max(0,f.outerWidth-ha(z,m,"left","right")),F=Math.max(0,f.outerHeight-ha(z,m,"top","bottom")),H=R!==m.w,K=F!==m.h;return m.w=R,m.h=F,d.horizontal?{same:H,other:K}:{same:K,other:H}}function Ju(m,f){const d=f.maxPadding;return function _(v){const I={left:0,top:0,right:0,bottom:0};return v.forEach(z=>{I[z]=Math.max(f[z],d[z])}),I}(m?["left","right"]:["top","bottom"])}function io(m,f,d,_){const v=[];let I,z,R,F,H,K;for(I=0,z=m.length,H=0;I<z;++I){R=m[I],F=R.box,F.update(R.width||f.w,R.height||f.h,Ju(R.horizontal,f));const{same:ie,other:ue}=kc(f,d,R,_);H|=ie&&v.length,K=K||ue,F.fullSize||v.push(R)}return H&&io(v,f,d,_)||K}function zo(m,f,d,_,v){m.top=d,m.left=f,m.right=f+_,m.bottom=d+v,m.width=_,m.height=v}function Oc(m,f,d,_){const v=d.padding;let{x:I,y:z}=f;for(const R of m){const F=R.box,H=_[R.stack]||{count:1,placed:0,weight:1},K=R.stackWeight/H.weight||1;if(R.horizontal){const ie=f.w*K,ue=H.size||F.height;yo(H.start)&&(z=H.start),F.fullSize?zo(F,v.left,z,d.outerWidth-v.right-v.left,ue):zo(F,f.left+H.placed,z,ie,ue),H.start=z,H.placed+=ie,z=F.bottom}else{const ie=f.h*K,ue=H.size||F.width;yo(H.start)&&(I=H.start),F.fullSize?zo(F,I,v.top,ue,d.outerHeight-v.bottom-v.top):zo(F,I,f.top+H.placed,ue,ie),H.start=I,H.placed+=ie,I=F.right}}f.x=I,f.y=z}var dr={addBox(m,f){m.boxes||(m.boxes=[]),f.fullSize=f.fullSize||!1,f.position=f.position||"top",f.weight=f.weight||0,f._layers=f._layers||function(){return[{z:0,draw(d){f.draw(d)}}]},m.boxes.push(f)},removeBox(m,f){const d=m.boxes?m.boxes.indexOf(f):-1;-1!==d&&m.boxes.splice(d,1)},configure(m,f,d){f.fullSize=d.fullSize,f.position=d.position,f.weight=d.weight},update(m,f,d,_){if(!m)return;const v=sr(m.options.layout.padding),I=Math.max(f-v.width,0),z=Math.max(d-v.height,0),R=function Lc(m){const f=function Nd(m){const f=[];let d,_,v,I,z,R;for(d=0,_=(m||[]).length;d<_;++d)v=m[d],({position:I,options:{stack:z,stackWeight:R=1}}=v),f.push({index:d,box:v,pos:I,horizontal:v.isHorizontal(),weight:v.weight,stack:z&&I+z,stackWeight:R});return f}(m),d=$l(f.filter(H=>H.box.fullSize),!0),_=$l(la(f,"left"),!0),v=$l(la(f,"right")),I=$l(la(f,"top"),!0),z=$l(la(f,"bottom")),R=ca(f,"x"),F=ca(f,"y");return{fullSize:d,leftAndTop:_.concat(I),rightAndBottom:v.concat(F).concat(z).concat(R),chartArea:la(f,"chartArea"),vertical:_.concat(v).concat(F),horizontal:I.concat(z).concat(R)}}(m.boxes),F=R.vertical,H=R.horizontal;Ki(m.boxes,Be=>{"function"==typeof Be.beforeLayout&&Be.beforeLayout()});const K=F.reduce((Be,je)=>je.box.options&&!1===je.box.options.display?Be:Be+1,0)||1,ie=Object.freeze({outerWidth:f,outerHeight:d,padding:v,availableWidth:I,availableHeight:z,vBoxMaxWidth:I/2/K,hBoxMaxHeight:z/2}),ue=Object.assign({},v);ua(ue,sr(_));const xe=Object.assign({maxPadding:ue,w:I,h:z,x:v.left,y:v.top},v),Oe=function Ku(m,f){const d=function Yu(m){const f={};for(const d of m){const{stack:_,pos:v,stackWeight:I}=d;if(!_||!Xu.includes(v))continue;const z=f[_]||(f[_]={count:0,placed:0,weight:0,size:0});z.count++,z.weight+=I}return f}(m),{vBoxMaxWidth:_,hBoxMaxHeight:v}=f;let I,z,R;for(I=0,z=m.length;I<z;++I){R=m[I];const{fullSize:F}=R.box,H=d[R.stack],K=H&&R.stackWeight/H.weight;R.horizontal?(R.width=K?K*_:F&&f.availableWidth,R.height=v):(R.width=_,R.height=K?K*v:F&&f.availableHeight)}return d}(F.concat(H),ie);io(R.fullSize,xe,ie,Oe),io(F,xe,ie,Oe),io(H,xe,ie,Oe)&&io(F,xe,ie,Oe),function Zl(m){const f=m.maxPadding;function d(_){const v=Math.max(f[_]-m[_],0);return m[_]+=v,v}m.y+=d("top"),m.x+=d("left"),d("right"),d("bottom")}(xe),Oc(R.leftAndTop,xe,ie,Oe),xe.x+=xe.w,xe.y+=xe.h,Oc(R.rightAndBottom,xe,ie,Oe),m.chartArea={left:xe.left,top:xe.top,right:xe.left+xe.w,bottom:xe.top+xe.h,height:xe.h,width:xe.w},Ki(R.chartArea,Be=>{const je=Be.box;Object.assign(je,m.chartArea),je.update(xe.w,xe.h,{left:0,top:0,right:0,bottom:0})})}};class Qu{acquireContext(f,d){}releaseContext(f){return!1}addEventListener(f,d,_){}removeEventListener(f,d,_){}getDevicePixelRatio(){return 1}getMaximumSize(f,d,_,v){return d=Math.max(0,d||f.width),_=_||f.height,{width:d,height:Math.max(0,v?Math.floor(d/v):_)}}isAttached(f){return!0}updateConfig(f){}}class da extends Qu{acquireContext(f){return f&&f.getContext&&f.getContext("2d")||null}updateConfig(f){f.options.animation=!1}}const pa="$chartjs",St={touchstart:"mousedown",touchmove:"mousemove",touchend:"mouseup",pointerenter:"mouseenter",pointerdown:"mousedown",pointermove:"mousemove",pointerup:"mouseup",pointerleave:"mouseout",pointerout:"mouseout"},Fc=m=>null===m||""===m,no=!!Dh&&{passive:!0};function Ct(m,f,d){m&&m.canvas&&m.canvas.removeEventListener(f,d,no)}function Bc(m,f){for(const d of m)if(d===f||d.contains(f))return!0}function Vd(m,f,d){const _=m.canvas,v=new MutationObserver(I=>{let z=!1;for(const R of I)z=z||Bc(R.addedNodes,_),z=z&&!Bc(R.removedNodes,_);z&&d()});return v.observe(document,{childList:!0,subtree:!0}),v}function Nc(m,f,d){const _=m.canvas,v=new MutationObserver(I=>{let z=!1;for(const R of I)z=z||Bc(R.removedNodes,_),z=z&&!Bc(R.addedNodes,_);z&&d()});return v.observe(document,{childList:!0,subtree:!0}),v}const ma=new Map;let Vc=0;function Jh(){const m=window.devicePixelRatio;m!==Vc&&(Vc=m,ma.forEach((f,d)=>{d.currentDevicePixelRatio!==m&&f()}))}function Uc(m,f,d){const _=m.canvas,v=_&&ur(_);if(!v)return;const I=gc((R,F)=>{const H=v.clientWidth;d(R,F),H<v.clientWidth&&d()},window),z=new ResizeObserver(R=>{const F=R[0],H=F.contentRect.width,K=F.contentRect.height;0===H&&0===K||I(H,K)});return z.observe(v),function Qh(m,f){ma.size||window.addEventListener("resize",Jh),ma.set(m,f)}(m,I),z}function Yl(m,f,d){d&&d.disconnect(),"resize"===f&&function Xl(m){ma.delete(m),ma.size||window.removeEventListener("resize",Jh)}(m)}function jc(m,f,d){const _=m.canvas,v=gc(I=>{null!==m.ctx&&d(function Kh(m,f){const d=St[m.type]||m.type,{x:_,y:v}=Ir(m,f);return{type:d,chart:f,native:m,x:void 0!==_?_:null,y:void 0!==v?v:null}}(I,m))},m);return function fa(m,f,d){m&&m.addEventListener(f,d,no)}(_,f,v),v}class Nr extends Qu{acquireContext(f,d){const _=f&&f.getContext&&f.getContext("2d");return _&&_.canvas===f?(function Yh(m,f){const d=m.style,_=m.getAttribute("height"),v=m.getAttribute("width");if(m[pa]={initial:{height:_,width:v,style:{display:d.display,height:d.height,width:d.width}}},d.display=d.display||"block",d.boxSizing=d.boxSizing||"border-box",Fc(v)){const I=Bu(m,"width");void 0!==I&&(m.width=I)}if(Fc(_))if(""===m.style.height)m.height=m.width/(f||2);else{const I=Bu(m,"height");void 0!==I&&(m.height=I)}}(f,d),_):null}releaseContext(f){const d=f.canvas;if(!d[pa])return!1;const _=d[pa].initial;["height","width"].forEach(I=>{const z=_[I];Ai(z)?d.removeAttribute(I):d.setAttribute(I,z)});const v=_.style||{};return Object.keys(v).forEach(I=>{d.style[I]=v[I]}),d.width=d.width,delete d[pa],!0}addEventListener(f,d,_){this.removeEventListener(f,d),(f.$proxies||(f.$proxies={}))[d]=({attach:Vd,detach:Nc,resize:Uc}[d]||jc)(f,d,_)}removeEventListener(f,d){const _=f.$proxies||(f.$proxies={}),v=_[d];v&&(({attach:Yl,detach:Yl,resize:Yl}[d]||Ct)(f,d,v),_[d]=void 0)}getDevicePixelRatio(){return window.devicePixelRatio}getMaximumSize(f,d,_,v){return function na(m,f,d,_){const v=ft(m),I=ys(v,"margin"),z=Un(v.maxWidth,m,"clientWidth")||qr,R=Un(v.maxHeight,m,"clientHeight")||qr,F=function Ph(m,f,d){let _,v;if(void 0===f||void 0===d){const I=m&&ur(m);if(I){const z=I.getBoundingClientRect(),R=ft(I),F=ys(R,"border","width"),H=ys(R,"padding");f=z.width-H.width-F.width,d=z.height-H.height-F.height,_=Un(R.maxWidth,I,"clientWidth"),v=Un(R.maxHeight,I,"clientHeight")}else f=m.clientWidth,d=m.clientHeight}return{width:f,height:d,maxWidth:_||qr,maxHeight:v||qr}}(m,f,d);let{width:H,height:K}=F;if("content-box"===v.boxSizing){const ue=ys(v,"border","width"),xe=ys(v,"padding");H-=xe.width+ue.width,K-=xe.height+ue.height}return H=Math.max(0,H-I.width),K=Math.max(0,_?H/_:K-I.height),H=Rs(Math.min(H,z,F.maxWidth)),K=Rs(Math.min(K,R,F.maxHeight)),H&&!K&&(K=Rs(H/2)),(void 0!==f||void 0!==d)&&_&&F.height&&K>F.height&&(K=F.height,H=Rs(Math.floor(K*_))),{width:H,height:K}}(f,d,_,v)}isAttached(f){const d=f&&ur(f);return!(!d||!d.isConnected)}}class xs{static defaults={};static defaultRoutes=void 0;x;y;active=!1;options;$animations;tooltipPosition(f){const{x:d,y:_}=this.getProps(["x","y"],f);return{x:d,y:_}}hasValue(){return Fe(this.x)&&Fe(this.y)}getProps(f,d){const _=this.$animations;if(!d||!_)return this;const v={};return f.forEach(I=>{v[I]=_[I]&&_[I].active()?_[I]._to:this[I]}),v}}function Zi(m,f,d,_,v){const I=Ti(_,0),z=Math.min(Ti(v,m.length),m.length);let F,H,K,R=0;for(d=Math.ceil(d),v&&(F=v-_,d=F/Math.floor(F/d)),K=I;K<0;)R++,K=Math.round(I+R*d);for(H=Math.max(I,0);H<z;H++)H===K&&(f.push(m[H]),R++,K=Math.round(I+R*d))}const Ql=(m,f,d)=>"top"===f||"left"===f?m[f]+d:m[f]-d,Hc=(m,f)=>Math.min(f||m,m);function nl(m,f){const d=[],_=m.length/f,v=m.length;let I=0;for(;I<v;I+=_)d.push(m[Math.floor(I)]);return d}function rl(m,f,d){const _=m.ticks.length,v=Math.min(f,_-1),I=m._startPixel,z=m._endPixel,R=1e-6;let H,F=m.getPixelForTick(v);if(!(d&&(H=1===_?Math.max(F-I,z-F):0===f?(m.getPixelForTick(1)-F)/2:(F-m.getPixelForTick(v-1))/2,F+=v<f?H:-H,F<I-R||F>z+R)))return F}function Ls(m){return m.drawTicks?m.tickLength:0}function at(m,f){if(!m.display)return 0;const d=mn(m.font,f),_=sr(m.padding);return(Yi(m.text)?m.text.length:1)*d.lineHeight+_.height}function cn(m,f,d){let _=nr(m);return(d&&"right"!==f||!d&&"right"===f)&&(_=(m=>"left"===m?"right":"right"===m?"left":m)(_)),_}class Lo extends xs{constructor(f){super(),this.id=f.id,this.type=f.type,this.options=void 0,this.ctx=f.ctx,this.chart=f.chart,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.width=void 0,this.height=void 0,this._margins={left:0,right:0,top:0,bottom:0},this.maxWidth=void 0,this.maxHeight=void 0,this.paddingTop=void 0,this.paddingBottom=void 0,this.paddingLeft=void 0,this.paddingRight=void 0,this.axis=void 0,this.labelRotation=void 0,this.min=void 0,this.max=void 0,this._range=void 0,this.ticks=[],this._gridLineItems=null,this._labelItems=null,this._labelSizes=null,this._length=0,this._maxLength=0,this._longestTextCache={},this._startPixel=void 0,this._endPixel=void 0,this._reversePixels=!1,this._userMax=void 0,this._userMin=void 0,this._suggestedMax=void 0,this._suggestedMin=void 0,this._ticksLength=0,this._borderValue=0,this._cache={},this._dataLimitsCached=!1,this.$context=void 0}init(f){this.options=f.setContext(this.getContext()),this.axis=f.axis,this._userMin=this.parse(f.min),this._userMax=this.parse(f.max),this._suggestedMin=this.parse(f.suggestedMin),this._suggestedMax=this.parse(f.suggestedMax)}parse(f,d){return f}getUserBounds(){let{_userMin:f,_userMax:d,_suggestedMin:_,_suggestedMax:v}=this;return f=Bn(f,Number.POSITIVE_INFINITY),d=Bn(d,Number.NEGATIVE_INFINITY),_=Bn(_,Number.POSITIVE_INFINITY),v=Bn(v,Number.NEGATIVE_INFINITY),{min:Bn(f,_),max:Bn(d,v),minDefined:Hi(f),maxDefined:Hi(d)}}getMinMax(f){let z,{min:d,max:_,minDefined:v,maxDefined:I}=this.getUserBounds();if(v&&I)return{min:d,max:_};const R=this.getMatchingVisibleMetas();for(let F=0,H=R.length;F<H;++F)z=R[F].controller.getMinMax(this,f),v||(d=Math.min(d,z.min)),I||(_=Math.max(_,z.max));return d=I&&d>_?_:d,_=v&&d>_?d:_,{min:Bn(d,Bn(_,d)),max:Bn(_,Bn(d,_))}}getPadding(){return{left:this.paddingLeft||0,top:this.paddingTop||0,right:this.paddingRight||0,bottom:this.paddingBottom||0}}getTicks(){return this.ticks}getLabels(){const f=this.chart.data;return this.options.labels||(this.isHorizontal()?f.xLabels:f.yLabels)||f.labels||[]}getLabelItems(f=this.chart.chartArea){return this._labelItems||(this._labelItems=this._computeLabelItems(f))}beforeLayout(){this._cache={},this._dataLimitsCached=!1}beforeUpdate(){Bi(this.options.beforeUpdate,[this])}update(f,d,_){const{beginAtZero:v,grace:I,ticks:z}=this.options,R=z.sampleSize;this.beforeUpdate(),this.maxWidth=f,this.maxHeight=d,this._margins=_=Object.assign({left:0,right:0,top:0,bottom:0},_),this.ticks=null,this._labelSizes=null,this._gridLineItems=null,this._labelItems=null,this.beforeSetDimensions(),this.setDimensions(),this.afterSetDimensions(),this._maxLength=this.isHorizontal()?this.width+_.left+_.right:this.height+_.top+_.bottom,this._dataLimitsCached||(this.beforeDataLimits(),this.determineDataLimits(),this.afterDataLimits(),this._range=function wh(m,f,d){const{min:_,max:v}=m,I=Jo(f,(v-_)/2),z=(R,F)=>d&&0===R?0:R+F;return{min:z(_,-Math.abs(I)),max:z(v,I)}}(this,I,v),this._dataLimitsCached=!0),this.beforeBuildTicks(),this.ticks=this.buildTicks()||[],this.afterBuildTicks();const F=R<this.ticks.length;this._convertTicksToLabels(F?nl(this.ticks,R):this.ticks),this.configure(),this.beforeCalculateLabelRotation(),this.calculateLabelRotation(),this.afterCalculateLabelRotation(),z.display&&(z.autoSkip||"auto"===z.source)&&(this.ticks=function eu(m,f){const d=m.options.ticks,_=function il(m){const f=m.options.offset,d=m._tickSize();return Math.floor(Math.min(m._length/d+(f?0:1),m._maxLength/d))}(m),v=Math.min(d.maxTicksLimit||_,_),I=d.major.enabled?function Kl(m){const f=[];let d,_;for(d=0,_=m.length;d<_;d++)m[d].major&&f.push(d);return f}(f):[],z=I.length,R=I[0],F=I[z-1],H=[];if(z>v)return function Zr(m,f,d,_){let z,v=0,I=d[0];for(_=Math.ceil(_),z=0;z<m.length;z++)z===I&&(f.push(m[z]),v++,I=d[v*_])}(f,H,I,z/v),H;const K=function Gc(m,f,d){const _=function qc(m){const f=m.length;let d,_;if(f<2)return!1;for(_=m[0],d=1;d<f;++d)if(m[d]-m[d-1]!==_)return!1;return _}(m),v=f.length/d;if(!_)return Math.max(v,1);const I=function Me(m){const f=[],d=Math.sqrt(m);let _;for(_=1;_<d;_++)m%_==0&&(f.push(_),f.push(m/_));return d===(0|d)&&f.push(d),f.sort((v,I)=>v-I).pop(),f}(_);for(let z=0,R=I.length-1;z<R;z++){const F=I[z];if(F>v)return F}return Math.max(v,1)}(I,f,v);if(z>0){let ie,ue;const xe=z>1?Math.round((F-R)/(z-1)):null;for(Zi(f,H,K,Ai(xe)?0:R-xe,R),ie=0,ue=z-1;ie<ue;ie++)Zi(f,H,K,I[ie],I[ie+1]);return Zi(f,H,K,F,Ai(xe)?f.length:F+xe),H}return Zi(f,H,K),H}(this,this.ticks),this._labelSizes=null,this.afterAutoSkip()),F&&this._convertTicksToLabels(this.ticks),this.beforeFit(),this.fit(),this.afterFit(),this.afterUpdate()}configure(){let d,_,f=this.options.reverse;this.isHorizontal()?(d=this.left,_=this.right):(d=this.top,_=this.bottom,f=!f),this._startPixel=d,this._endPixel=_,this._reversePixels=f,this._length=_-d,this._alignToPixels=this.options.alignToPixels}afterUpdate(){Bi(this.options.afterUpdate,[this])}beforeSetDimensions(){Bi(this.options.beforeSetDimensions,[this])}setDimensions(){this.isHorizontal()?(this.width=this.maxWidth,this.left=0,this.right=this.width):(this.height=this.maxHeight,this.top=0,this.bottom=this.height),this.paddingLeft=0,this.paddingTop=0,this.paddingRight=0,this.paddingBottom=0}afterSetDimensions(){Bi(this.options.afterSetDimensions,[this])}_callHooks(f){this.chart.notifyPlugins(f,this.getContext()),Bi(this.options[f],[this])}beforeDataLimits(){this._callHooks("beforeDataLimits")}determineDataLimits(){}afterDataLimits(){this._callHooks("afterDataLimits")}beforeBuildTicks(){this._callHooks("beforeBuildTicks")}buildTicks(){return[]}afterBuildTicks(){this._callHooks("afterBuildTicks")}beforeTickToLabelConversion(){Bi(this.options.beforeTickToLabelConversion,[this])}generateTickLabels(f){const d=this.options.ticks;let _,v,I;for(_=0,v=f.length;_<v;_++)I=f[_],I.label=Bi(d.callback,[I.value,_,f],this)}afterTickToLabelConversion(){Bi(this.options.afterTickToLabelConversion,[this])}beforeCalculateLabelRotation(){Bi(this.options.beforeCalculateLabelRotation,[this])}calculateLabelRotation(){const f=this.options,d=f.ticks,_=Hc(this.ticks.length,f.ticks.maxTicksLimit),v=d.minRotation||0,I=d.maxRotation;let R,F,H,z=v;if(!this._isVisible()||!d.display||v>=I||_<=1||!this.isHorizontal())return void(this.labelRotation=v);const K=this._getLabelSizes(),ie=K.widest.width,ue=K.highest.height,xe=Gt(this.chart.width-ie,0,this.maxWidth);R=f.offset?this.maxWidth/_:xe/(_-1),ie+6>R&&(R=xe/(_-(f.offset?.5:1)),F=this.maxHeight-Ls(f.grid)-d.padding-at(f.title,this.chart.options.font),H=Math.sqrt(ie*ie+ue*ue),z=dt(Math.min(Math.asin(Gt((K.highest.height+6)/R,-1,1)),Math.asin(Gt(F/H,-1,1))-Math.asin(Gt(ue/H,-1,1)))),z=Math.max(v,Math.min(I,z))),this.labelRotation=z}afterCalculateLabelRotation(){Bi(this.options.afterCalculateLabelRotation,[this])}afterAutoSkip(){}beforeFit(){Bi(this.options.beforeFit,[this])}fit(){const f={width:0,height:0},{chart:d,options:{ticks:_,title:v,grid:I}}=this,z=this._isVisible(),R=this.isHorizontal();if(z){const F=at(v,d.options.font);if(R?(f.width=this.maxWidth,f.height=Ls(I)+F):(f.height=this.maxHeight,f.width=Ls(I)+F),_.display&&this.ticks.length){const{first:H,last:K,widest:ie,highest:ue}=this._getLabelSizes(),xe=2*_.padding,Oe=ot(this.labelRotation),Be=Math.cos(Oe),je=Math.sin(Oe);R?f.height=Math.min(this.maxHeight,f.height+(_.mirror?0:je*ie.width+Be*ue.height)+xe):f.width=Math.min(this.maxWidth,f.width+(_.mirror?0:Be*ie.width+je*ue.height)+xe),this._calculatePadding(H,K,je,Be)}}this._handleMargins(),R?(this.width=this._length=d.width-this._margins.left-this._margins.right,this.height=f.height):(this.width=f.width,this.height=this._length=d.height-this._margins.top-this._margins.bottom)}_calculatePadding(f,d,_,v){const{ticks:{align:I,padding:z},position:R}=this.options,F=0!==this.labelRotation,H="top"!==R&&"x"===this.axis;if(this.isHorizontal()){const K=this.getPixelForTick(0)-this.left,ie=this.right-this.getPixelForTick(this.ticks.length-1);let ue=0,xe=0;F?H?(ue=v*f.width,xe=_*d.height):(ue=_*f.height,xe=v*d.width):"start"===I?xe=d.width:"end"===I?ue=f.width:"inner"!==I&&(ue=f.width/2,xe=d.width/2),this.paddingLeft=Math.max((ue-K+z)*this.width/(this.width-K),0),this.paddingRight=Math.max((xe-ie+z)*this.width/(this.width-ie),0)}else{let K=d.height/2,ie=f.height/2;"start"===I?(K=0,ie=f.height):"end"===I&&(K=d.height,ie=0),this.paddingTop=K+z,this.paddingBottom=ie+z}}_handleMargins(){this._margins&&(this._margins.left=Math.max(this.paddingLeft,this._margins.left),this._margins.top=Math.max(this.paddingTop,this._margins.top),this._margins.right=Math.max(this.paddingRight,this._margins.right),this._margins.bottom=Math.max(this.paddingBottom,this._margins.bottom))}afterFit(){Bi(this.options.afterFit,[this])}isHorizontal(){const{axis:f,position:d}=this.options;return"top"===d||"bottom"===d||"x"===f}isFullSize(){return this.options.fullSize}_convertTicksToLabels(f){let d,_;for(this.beforeTickToLabelConversion(),this.generateTickLabels(f),d=0,_=f.length;d<_;d++)Ai(f[d].label)&&(f.splice(d,1),_--,d--);this.afterTickToLabelConversion()}_getLabelSizes(){let f=this._labelSizes;if(!f){const d=this.options.ticks.sampleSize;let _=this.ticks;d<_.length&&(_=nl(_,d)),this._labelSizes=f=this._computeLabelSizes(_,_.length,this.options.ticks.maxTicksLimit)}return f}_computeLabelSizes(f,d,_){const{ctx:v,_longestTextCache:I}=this,z=[],R=[],F=Math.floor(d/Hc(d,_));let ie,ue,xe,Oe,Be,je,ht,lt,Et,Dt,xt,H=0,K=0;for(ie=0;ie<d;ie+=F){if(Oe=f[ie].label,Be=this._resolveTickFontOptions(ie),v.font=je=Be.string,ht=I[je]=I[je]||{data:{},gc:[]},lt=Be.lineHeight,Et=Dt=0,Ai(Oe)||Yi(Oe)){if(Yi(Oe))for(ue=0,xe=Oe.length;ue<xe;++ue)xt=Oe[ue],!Ai(xt)&&!Yi(xt)&&(Et=vo(v,ht.data,ht.gc,Et,xt),Dt+=lt)}else Et=vo(v,ht.data,ht.gc,Et,Oe),Dt=lt;z.push(Et),R.push(Dt),H=Math.max(Et,H),K=Math.max(Dt,K)}!function sl(m,f){Ki(m,d=>{const _=d.gc,v=_.length/2;let I;if(v>f){for(I=0;I<v;++I)delete d.data[_[I]];_.splice(0,v)}})}(I,d);const At=z.indexOf(H),Ht=R.indexOf(K),Ot=Bt=>({width:z[Bt]||0,height:R[Bt]||0});return{first:Ot(0),last:Ot(d-1),widest:Ot(At),highest:Ot(Ht),widths:z,heights:R}}getLabelForValue(f){return f}getPixelForValue(f,d){return NaN}getValueForPixel(f){}getPixelForTick(f){const d=this.ticks;return f<0||f>d.length-1?null:this.getPixelForValue(d[f].value)}getPixelForDecimal(f){this._reversePixels&&(f=1-f);const d=this._startPixel+f*this._length;return function Ii(m){return Gt(m,-32768,32767)}(this._alignToPixels?sn(this.chart,d,0):d)}getDecimalForPixel(f){const d=(f-this._startPixel)/this._length;return this._reversePixels?1-d:d}getBasePixel(){return this.getPixelForValue(this.getBaseValue())}getBaseValue(){const{min:f,max:d}=this;return f<0&&d<0?d:f>0&&d>0?f:0}getContext(f){const d=this.ticks||[];if(f>=0&&f<d.length){const _=d[f];return _.$context||(_.$context=function ol(m,f,d){return Rn(m,{tick:d,index:f,type:"tick"})}(this.getContext(),f,_))}return this.$context||(this.$context=function bt(m,f){return Rn(m,{scale:f,type:"scale"})}(this.chart.getContext(),this))}_tickSize(){const f=this.options.ticks,d=ot(this.labelRotation),_=Math.abs(Math.cos(d)),v=Math.abs(Math.sin(d)),I=this._getLabelSizes(),z=f.autoSkipPadding||0,R=I?I.widest.width+z:0,F=I?I.highest.height+z:0;return this.isHorizontal()?F*_>R*v?R/_:F/v:F*v<R*_?F/_:R/v}_isVisible(){const f=this.options.display;return"auto"!==f?!!f:this.getMatchingVisibleMetas().length>0}_computeGridLineItems(f){const d=this.axis,_=this.chart,v=this.options,{grid:I,position:z,border:R}=v,F=I.offset,H=this.isHorizontal(),ie=this.ticks.length+(F?1:0),ue=Ls(I),xe=[],Oe=R.setContext(this.getContext()),Be=Oe.display?Oe.width:0,je=Be/2,ht=function(In){return sn(_,In,Be)};let lt,Et,Dt,xt,At,Ht,Ot,Bt,Fi,Vi,Wi,or;if("top"===z)lt=ht(this.bottom),Ht=this.bottom-ue,Bt=lt-je,Vi=ht(f.top)+je,or=f.bottom;else if("bottom"===z)lt=ht(this.top),Vi=f.top,or=ht(f.bottom)-je,Ht=lt+je,Bt=this.top+ue;else if("left"===z)lt=ht(this.right),At=this.right-ue,Ot=lt-je,Fi=ht(f.left)+je,Wi=f.right;else if("right"===z)lt=ht(this.left),Fi=f.left,Wi=ht(f.right)-je,At=lt+je,Ot=this.left+ue;else if("x"===d){if("center"===z)lt=ht((f.top+f.bottom)/2+.5);else if(zi(z)){const In=Object.keys(z)[0];lt=ht(this.chart.scales[In].getPixelForValue(z[In]))}Vi=f.top,or=f.bottom,Ht=lt+je,Bt=Ht+ue}else if("y"===d){if("center"===z)lt=ht((f.left+f.right)/2);else if(zi(z)){const In=Object.keys(z)[0];lt=ht(this.chart.scales[In].getPixelForValue(z[In]))}At=lt-je,Ot=At-ue,Fi=f.left,Wi=f.right}const zr=Ti(v.ticks.maxTicksLimit,ie),gn=Math.max(1,Math.ceil(ie/zr));for(Et=0;Et<ie;Et+=gn){const In=this.getContext(Et),Cn=I.setContext(In),ws=R.setContext(In),gr=Cn.lineWidth,sh=Cn.color,Mu=ws.dash||[],vl=ws.dashOffset,pc=Cn.tickWidth,Sa=Cn.tickColor,oh=Cn.tickBorderDash||[],bl=Cn.tickBorderDashOffset;Dt=rl(this,Et,F),void 0!==Dt&&(xt=sn(_,Dt,gr),H?At=Ot=Fi=Wi=xt:Ht=Bt=Vi=or=xt,xe.push({tx1:At,ty1:Ht,tx2:Ot,ty2:Bt,x1:Fi,y1:Vi,x2:Wi,y2:or,width:gr,color:sh,borderDash:Mu,borderDashOffset:vl,tickWidth:pc,tickColor:Sa,tickBorderDash:oh,tickBorderDashOffset:bl}))}return this._ticksLength=ie,this._borderValue=lt,xe}_computeLabelItems(f){const d=this.axis,_=this.options,{position:v,ticks:I}=_,z=this.isHorizontal(),R=this.ticks,{align:F,crossAlign:H,padding:K,mirror:ie}=I,ue=Ls(_.grid),xe=ue+K,Oe=ie?-K:xe,Be=-ot(this.labelRotation),je=[];let ht,lt,Et,Dt,xt,At,Ht,Ot,Bt,Fi,Vi,Wi,or="middle";if("top"===v)At=this.bottom-Oe,Ht=this._getXAxisLabelAlignment();else if("bottom"===v)At=this.top+Oe,Ht=this._getXAxisLabelAlignment();else if("left"===v){const gn=this._getYAxisLabelAlignment(ue);Ht=gn.textAlign,xt=gn.x}else if("right"===v){const gn=this._getYAxisLabelAlignment(ue);Ht=gn.textAlign,xt=gn.x}else if("x"===d){if("center"===v)At=(f.top+f.bottom)/2+xe;else if(zi(v)){const gn=Object.keys(v)[0];At=this.chart.scales[gn].getPixelForValue(v[gn])+xe}Ht=this._getXAxisLabelAlignment()}else if("y"===d){if("center"===v)xt=(f.left+f.right)/2-xe;else if(zi(v)){const gn=Object.keys(v)[0];xt=this.chart.scales[gn].getPixelForValue(v[gn])}Ht=this._getYAxisLabelAlignment(ue).textAlign}"y"===d&&("start"===F?or="top":"end"===F&&(or="bottom"));const zr=this._getLabelSizes();for(ht=0,lt=R.length;ht<lt;++ht){Et=R[ht],Dt=Et.label;const gn=I.setContext(this.getContext(ht));Ot=this.getPixelForTick(ht)+I.labelOffset,Bt=this._resolveTickFontOptions(ht),Fi=Bt.lineHeight,Vi=Yi(Dt)?Dt.length:1;const In=Vi/2,Cn=gn.color,ws=gn.textStrokeColor,gr=gn.textStrokeWidth;let Mu,sh=Ht;if(z?(xt=Ot,"inner"===Ht&&(sh=ht===lt-1?this.options.reverse?"left":"right":0===ht?this.options.reverse?"right":"left":"center"),Wi="top"===v?"near"===H||0!==Be?-Vi*Fi+Fi/2:"center"===H?-zr.highest.height/2-In*Fi+Fi:Fi/2-zr.highest.height:"near"===H||0!==Be?Fi/2:"center"===H?zr.highest.height/2-In*Fi:zr.highest.height-Vi*Fi,ie&&(Wi*=-1),0!==Be&&!gn.showLabelBackdrop&&(xt+=Fi/2*Math.sin(Be))):(At=Ot,Wi=(1-Vi)*Fi/2),gn.showLabelBackdrop){const vl=sr(gn.backdropPadding),pc=zr.heights[ht],Sa=zr.widths[ht];let oh=Wi-vl.top,bl=0-vl.left;switch(or){case"middle":oh-=pc/2;break;case"bottom":oh-=pc}switch(Ht){case"center":bl-=Sa/2;break;case"right":bl-=Sa;break;case"inner":ht===lt-1?bl-=Sa:ht>0&&(bl-=Sa/2)}Mu={left:bl,top:oh,width:Sa+vl.width,height:pc+vl.height,color:gn.backdropColor}}je.push({label:Dt,font:Bt,textOffset:Wi,options:{rotation:Be,color:Cn,strokeColor:ws,strokeWidth:gr,textAlign:sh,textBaseline:or,translation:[xt,At],backdrop:Mu}})}return je}_getXAxisLabelAlignment(){const{position:f,ticks:d}=this.options;if(-ot(this.labelRotation))return"top"===f?"left":"right";let v="center";return"start"===d.align?v="left":"end"===d.align?v="right":"inner"===d.align&&(v="inner"),v}_getYAxisLabelAlignment(f){const{position:d,ticks:{crossAlign:_,mirror:v,padding:I}}=this.options,R=f+I,F=this._getLabelSizes().widest.width;let H,K;return"left"===d?v?(K=this.right+I,"near"===_?H="left":"center"===_?(H="center",K+=F/2):(H="right",K+=F)):(K=this.right-R,"near"===_?H="right":"center"===_?(H="center",K-=F/2):(H="left",K=this.left)):"right"===d?v?(K=this.left+I,"near"===_?H="right":"center"===_?(H="center",K-=F/2):(H="left",K-=F)):(K=this.left+R,"near"===_?H="left":"center"===_?(H="center",K+=F/2):(H="right",K=this.right)):H="right",{textAlign:H,x:K}}_computeLabelArea(){if(this.options.ticks.mirror)return;const f=this.chart,d=this.options.position;return"left"===d||"right"===d?{top:0,left:this.left,bottom:f.height,right:this.right}:"top"===d||"bottom"===d?{top:this.top,left:0,bottom:this.bottom,right:f.width}:void 0}drawBackground(){const{ctx:f,options:{backgroundColor:d},left:_,top:v,width:I,height:z}=this;d&&(f.save(),f.fillStyle=d,f.fillRect(_,v,I,z),f.restore())}getLineWidthForValue(f){const d=this.options.grid;if(!this._isVisible()||!d.display)return 0;const v=this.ticks.findIndex(I=>I.value===f);return v>=0?d.setContext(this.getContext(v)).lineWidth:0}drawGrid(f){const d=this.options.grid,_=this.ctx,v=this._gridLineItems||(this._gridLineItems=this._computeGridLineItems(f));let I,z;const R=(F,H,K)=>{!K.width||!K.color||(_.save(),_.lineWidth=K.width,_.strokeStyle=K.color,_.setLineDash(K.borderDash||[]),_.lineDashOffset=K.borderDashOffset,_.beginPath(),_.moveTo(F.x,F.y),_.lineTo(H.x,H.y),_.stroke(),_.restore())};if(d.display)for(I=0,z=v.length;I<z;++I){const F=v[I];d.drawOnChartArea&&R({x:F.x1,y:F.y1},{x:F.x2,y:F.y2},F),d.drawTicks&&R({x:F.tx1,y:F.ty1},{x:F.tx2,y:F.ty2},{color:F.tickColor,width:F.tickWidth,borderDash:F.tickBorderDash,borderDashOffset:F.tickBorderDashOffset})}}drawBorder(){const{chart:f,ctx:d,options:{border:_,grid:v}}=this,I=_.setContext(this.getContext()),z=_.display?I.width:0;if(!z)return;const R=v.setContext(this.getContext(0)).lineWidth,F=this._borderValue;let H,K,ie,ue;this.isHorizontal()?(H=sn(f,this.left,z)-z/2,K=sn(f,this.right,R)+R/2,ie=ue=F):(ie=sn(f,this.top,z)-z/2,ue=sn(f,this.bottom,R)+R/2,H=K=F),d.save(),d.lineWidth=I.width,d.strokeStyle=I.color,d.beginPath(),d.moveTo(H,ie),d.lineTo(K,ue),d.stroke(),d.restore()}drawLabels(f){if(!this.options.ticks.display)return;const _=this.ctx,v=this._computeLabelArea();v&&ea(_,v);const I=this.getLabelItems(f);for(const z of I)en(_,z.label,0,z.textOffset,z.font,z.options);v&&bo(_)}drawTitle(){const{ctx:f,options:{position:d,title:_,reverse:v}}=this;if(!_.display)return;const I=mn(_.font),z=sr(_.padding),R=_.align;let F=I.lineHeight/2;"bottom"===d||"center"===d||zi(d)?(F+=z.bottom,Yi(_.text)&&(F+=I.lineHeight*(_.text.length-1))):F+=z.top;const{titleX:H,titleY:K,maxWidth:ie,rotation:ue}=function Ne(m,f,d,_){const{top:v,left:I,bottom:z,right:R,chart:F}=m,{chartArea:H,scales:K}=F;let ue,xe,Oe,ie=0;const Be=z-v,je=R-I;if(m.isHorizontal()){if(xe=xn(_,I,R),zi(d)){const ht=Object.keys(d)[0];Oe=K[ht].getPixelForValue(d[ht])+Be-f}else Oe="center"===d?(H.bottom+H.top)/2+Be-f:Ql(m,d,f);ue=R-I}else{if(zi(d)){const ht=Object.keys(d)[0];xe=K[ht].getPixelForValue(d[ht])-je+f}else xe="center"===d?(H.left+H.right)/2-je+f:Ql(m,d,f);Oe=xn(_,z,v),ie="left"===d?-$:$}return{titleX:xe,titleY:Oe,maxWidth:ue,rotation:ie}}(this,F,d,R);en(f,_.text,0,0,I,{color:_.color,maxWidth:ie,rotation:ue,textAlign:cn(R,d,v),textBaseline:"middle",translation:[H,K]})}draw(f){this._isVisible()&&(this.drawBackground(),this.drawGrid(f),this.drawBorder(),this.drawTitle(),this.drawLabels(f))}_layers(){const f=this.options,d=f.ticks&&f.ticks.z||0,_=Ti(f.grid&&f.grid.z,-1),v=Ti(f.border&&f.border.z,0);return this._isVisible()&&this.draw===Lo.prototype.draw?[{z:_,draw:I=>{this.drawBackground(),this.drawGrid(I),this.drawTitle()}},{z:v,draw:()=>{this.drawBorder()}},{z:d,draw:I=>{this.drawLabels(I)}}]:[{z:d,draw:I=>{this.draw(I)}}]}getMatchingVisibleMetas(f){const d=this.chart.getSortedVisibleDatasetMetas(),_=this.axis+"AxisID",v=[];let I,z;for(I=0,z=d.length;I<z;++I){const R=d[I];R[_]===this.id&&(!f||R.type===f)&&v.push(R)}return v}_resolveTickFontOptions(f){return mn(this.options.ticks.setContext(this.getContext(f)).font)}_maxDigits(){const f=this._resolveTickFontOptions(0).lineHeight;return(this.isHorizontal()?this.width:this.height)/f}}class _a{constructor(f,d,_){this.type=f,this.scope=d,this.override=_,this.items=Object.create(null)}isForType(f){return Object.prototype.isPrototypeOf.call(this.type.prototype,f.prototype)}register(f){const d=Object.getPrototypeOf(f);let _;(function td(m){return"id"in m&&"defaults"in m})(d)&&(_=this.register(d));const v=this.items,I=f.id,z=this.scope+"."+I;if(!I)throw new Error("class does not have id: "+f);return I in v||(v[I]=f,function tu(m,f,d){const _=kr(Object.create(null),[d?fn.get(d):{},fn.get(f),m.defaults]);fn.set(f,_),m.defaultRoutes&&function ed(m,f){Object.keys(f).forEach(d=>{const _=d.split("."),v=_.pop(),I=[m].concat(_).join("."),z=f[d].split("."),R=z.pop(),F=z.join(".");fn.route(I,v,F,R)})}(f,m.defaultRoutes),m.descriptors&&fn.describe(f,m.descriptors)}(f,z,_),this.override&&fn.override(f.id,f.overrides)),z}get(f){return this.items[f]}unregister(f){const d=this.items,_=f.id,v=this.scope;_ in d&&delete d[_],v&&_ in fn[v]&&(delete fn[v][_],this.override&&delete Mi[_])}}class id{constructor(){this.controllers=new _a(as,"datasets",!0),this.elements=new _a(xs,"elements"),this.plugins=new _a(Object,"plugins"),this.scales=new _a(Lo,"scales"),this._typedRegistries=[this.controllers,this.scales,this.elements]}add(...f){this._each("register",f)}remove(...f){this._each("unregister",f)}addControllers(...f){this._each("register",f,this.controllers)}addElements(...f){this._each("register",f,this.elements)}addPlugins(...f){this._each("register",f,this.plugins)}addScales(...f){this._each("register",f,this.scales)}getController(f){return this._get(f,this.controllers,"controller")}getElement(f){return this._get(f,this.elements,"element")}getPlugin(f){return this._get(f,this.plugins,"plugin")}getScale(f){return this._get(f,this.scales,"scale")}removeControllers(...f){this._each("unregister",f,this.controllers)}removeElements(...f){this._each("unregister",f,this.elements)}removePlugins(...f){this._each("unregister",f,this.plugins)}removeScales(...f){this._each("unregister",f,this.scales)}_each(f,d,_){[...d].forEach(v=>{const I=_||this._getRegistryForType(v);_||I.isForType(v)||I===this.plugins&&v.id?this._exec(f,I,v):Ki(v,z=>{const R=_||this._getRegistryForType(z);this._exec(f,R,z)})})}_exec(f,d,_){const v=go(f);Bi(_["before"+v],[],_),d[f](_),Bi(_["after"+v],[],_)}_getRegistryForType(f){for(let d=0;d<this._typedRegistries.length;d++){const _=this._typedRegistries[d];if(_.isForType(f))return _}return this.plugins}_get(f,d,_){const v=d.get(f);if(void 0===v)throw new Error('"'+f+'" is not a registered '+_+".");return v}}var Cr=new id;class Ud{constructor(){this._init=[]}notify(f,d,_,v){"beforeInit"===d&&(this._init=this._createDescriptors(f,!0),this._notify(this._init,f,"install"));const I=v?this._descriptors(f).filter(v):this._descriptors(f),z=this._notify(I,f,d,_);return"afterDestroy"===d&&(this._notify(I,f,"stop"),this._notify(this._init,f,"uninstall")),z}_notify(f,d,_,v){v=v||{};for(const I of f){const z=I.plugin;if(!1===Bi(z[_],[d,v,I.options],z)&&v.cancelable)return!1}return!0}invalidate(){Ai(this._cache)||(this._oldCache=this._cache,this._cache=void 0)}_descriptors(f){if(this._cache)return this._cache;const d=this._cache=this._createDescriptors(f);return this._notifyStateChanges(f),d}_createDescriptors(f,d){const _=f&&f.config,v=Ti(_.options&&_.options.plugins,{}),I=function jd(m){const f={},d=[],_=Object.keys(Cr.plugins.items);for(let I=0;I<_.length;I++)d.push(Cr.getPlugin(_[I]));const v=m.plugins||[];for(let I=0;I<v.length;I++){const z=v[I];-1===d.indexOf(z)&&(d.push(z),f[z.id]=!0)}return{plugins:d,localIds:f}}(_);return!1!==v||d?function Wc(m,{plugins:f,localIds:d},_,v){const I=[],z=m.getContext();for(const R of f){const F=R.id,H=nd(_[F],v);null!==H&&I.push({plugin:R,options:ko(m.config,{plugin:R,local:d[F]},H,z)})}return I}(f,I,v,d):[]}_notifyStateChanges(f){const d=this._oldCache||[],_=this._cache,v=(I,z)=>I.filter(R=>!z.some(F=>R.plugin.id===F.plugin.id));this._notify(v(d,_),f,"stop"),this._notify(v(_,d),f,"start")}}function nd(m,f){return f||!1!==m?!0===m?{}:m:null}function ko(m,{plugin:f,local:d},_,v){const I=m.pluginScopeKeys(f),z=m.getOptionScopes(_,I);return d&&f.defaults&&z.push(f.defaults),m.createResolver(z,v,[""],{scriptable:!1,indexable:!1,allKeys:!0})}function ec(m,f){return((f.datasets||{})[m]||{}).indexAxis||f.indexAxis||(fn.datasets[m]||{}).indexAxis||"x"}function tc(m){if("x"===m||"y"===m||"r"===m)return m}function ks(m){return"top"===m||"bottom"===m?"x":"left"===m||"right"===m?"y":void 0}function vs(m,...f){if(tc(m))return m;for(const d of f){const _=d.axis||ks(d.position)||m.length>1&&tc(m[0].toLowerCase());if(_)return _}throw new Error(`Cannot determine type of '${m}' axis. Please provide 'axis' or 'position' option.`)}function nu(m,f,d){if(d[f+"AxisID"]===m)return{axis:f}}function al(m){const f=m.options||(m.options={});f.plugins=Ti(f.plugins,{}),f.scales=function Gd(m,f){const d=Mi[m.type]||{scales:{}},_=f.scales||{},v=ec(m.type,f),I=Object.create(null);return Object.keys(_).forEach(z=>{const R=_[z];if(!zi(R))return console.error(`Invalid scale configuration for scale: ${z}`);if(R._proxy)return console.warn(`Ignoring resolver passed as options for scale: ${z}`);const F=vs(z,R,function Wn(m,f){if(f.data&&f.data.datasets){const d=f.data.datasets.filter(_=>_.xAxisID===m||_.yAxisID===m);if(d.length)return nu(m,"x",d[0])||nu(m,"y",d[0])}return{}}(z,m),fn.scales[R.type]),H=function ga(m,f){return m===f?"_index_":"_value_"}(F,v),K=d.scales||{};I[z]=mo(Object.create(null),[{axis:F},R,K[F],K[H]])}),m.data.datasets.forEach(z=>{const R=z.type||m.type,F=z.indexAxis||ec(R,f),K=(Mi[R]||{}).scales||{};Object.keys(K).forEach(ie=>{const ue=function iu(m,f){let d=m;return"_index_"===m?d=f:"_value_"===m&&(d="x"===f?"y":"x"),d}(ie,F),xe=z[ue+"AxisID"]||ue;I[xe]=I[xe]||Object.create(null),mo(I[xe],[{axis:ue},_[xe],K[ie]])})}),Object.keys(I).forEach(z=>{const R=I[z];mo(R,[fn.scales[R.type],fn.scale])}),I}(m,f)}function Ji(m){return(m=m||{}).datasets=m.datasets||[],m.labels=m.labels||[],m}const ru=new Map,Os=new Set;function ro(m,f){let d=ru.get(m);return d||(d=f(),ru.set(m,d),Os.add(d)),d}const Xr=(m,f,d)=>{const _=ps(f,d);void 0!==_&&m.add(_)};class $c{constructor(f){this._config=function Li(m){return(m=m||{}).data=Ji(m.data),al(m),m}(f),this._scopeCache=new Map,this._resolverCache=new Map}get platform(){return this._config.platform}get type(){return this._config.type}set type(f){this._config.type=f}get data(){return this._config.data}set data(f){this._config.data=Ji(f)}get options(){return this._config.options}set options(f){this._config.options=f}get plugins(){return this._config.plugins}update(){const f=this._config;this.clearCache(),al(f)}clearCache(){this._scopeCache.clear(),this._resolverCache.clear()}datasetScopeKeys(f){return ro(f,()=>[[`datasets.${f}`,""]])}datasetAnimationScopeKeys(f,d){return ro(`${f}.transition.${d}`,()=>[[`datasets.${f}.transitions.${d}`,`transitions.${d}`],[`datasets.${f}`,""]])}datasetElementScopeKeys(f,d){return ro(`${f}-${d}`,()=>[[`datasets.${f}.elements.${d}`,`datasets.${f}`,`elements.${d}`,""]])}pluginScopeKeys(f){const d=f.id;return ro(`${this.type}-plugin-${d}`,()=>[[`plugins.${d}`,...f.additionalOptionScopes||[]]])}_cachedScopes(f,d){const _=this._scopeCache;let v=_.get(f);return(!v||d)&&(v=new Map,_.set(f,v)),v}getOptionScopes(f,d,_){const{options:v,type:I}=this,z=this._cachedScopes(f,_),R=z.get(d);if(R)return R;const F=new Set;d.forEach(K=>{f&&(F.add(f),K.forEach(ie=>Xr(F,f,ie))),K.forEach(ie=>Xr(F,v,ie)),K.forEach(ie=>Xr(F,Mi[I]||{},ie)),K.forEach(ie=>Xr(F,fn,ie)),K.forEach(ie=>Xr(F,wi,ie))});const H=Array.from(F);return 0===H.length&&H.push(Object.create(null)),Os.has(d)&&z.set(d,H),H}chartOptionScopes(){const{options:f,type:d}=this;return[f,Mi[d]||{},fn.datasets[d]||{},{type:d},fn,wi]}resolveNamedOptions(f,d,_,v=[""]){const I={$shared:!0},{resolver:z,subPrefixes:R}=ll(this._resolverCache,f,v);let F=z;(function pr(m,f){const{isScriptable:d,isIndexable:_}=Ga(m);for(const v of f){const I=d(v),z=_(v),R=(z||I)&&m[v];if(I&&(fs(R)||Fs(R))||z&&Yi(R))return!0}return!1})(z,d)&&(I.$shared=!1,F=Js(z,_=fs(_)?_():_,this.createResolver(f,_,R)));for(const H of d)I[H]=F[H];return I}createResolver(f,d,_=[""],v){const{resolver:I}=ll(this._resolverCache,f,_);return zi(d)?Js(I,d,void 0,v):I}}function ll(m,f,d){let _=m.get(f);_||(_=new Map,m.set(f,_));const v=d.join();let I=_.get(v);return I||(I={resolver:Dl(f,d),subPrefixes:d.filter(R=>!R.toLowerCase().includes("hover"))},_.set(v,I)),I}const Fs=m=>zi(m)&&Object.getOwnPropertyNames(m).some(f=>fs(m[f])),ic=["top","bottom","left","right","chartArea"];function Xc(m,f){return"top"===m||"bottom"===m||-1===ic.indexOf(m)&&"x"===f}function Yc(m,f){return function(d,_){return d[m]===_[m]?d[f]-_[f]:d[m]-_[m]}}function Oo(m){const f=m.chart,d=f.options.animation;f.notifyPlugins("afterRender"),Bi(d&&d.onComplete,[m],f)}function su(m){const f=m.chart,d=f.options.animation;Bi(d&&d.onProgress,[m],f)}function so(m){return Ha()&&"string"==typeof m?m=document.getElementById(m):m&&m.length&&(m=m[0]),m&&m.canvas&&(m=m.canvas),m}const cl={},nc=m=>{const f=so(m);return Object.values(cl).filter(d=>d.canvas===f).pop()};function ou(m,f,d){const _=Object.keys(m);for(const v of _){const I=+v;if(I>=f){const z=m[v];delete m[v],(d>0||I>f)&&(m[I+d]=z)}}}function Ln(m,f,d){return m.options.clip?m[d]:f[d]}let rc=(()=>class m{static defaults=fn;static instances=cl;static overrides=Mi;static registry=Cr;static version="4.4.8";static getChart=nc;static register(...d){Cr.add(...d),hl()}static unregister(...d){Cr.remove(...d),hl()}constructor(d,_){const v=this.config=new $c(_),I=so(d),z=nc(I);if(z)throw new Error("Canvas is already in use. Chart with ID '"+z.id+"' must be destroyed before the canvas with ID '"+z.canvas.id+"' can be reused.");const R=v.createResolver(v.chartOptionScopes(),this.getContext());this.platform=new(v.platform||function Ro(m){return!Ha()||typeof OffscreenCanvas<"u"&&m instanceof OffscreenCanvas?da:Nr}(I)),this.platform.updateConfig(v);const F=this.platform.acquireContext(I,R.aspectRatio),H=F&&F.canvas,K=H&&H.height,ie=H&&H.width;this.id=ai(),this.ctx=F,this.canvas=H,this.width=ie,this.height=K,this._options=R,this._aspectRatio=this.aspectRatio,this._layers=[],this._metasets=[],this._stacks=void 0,this.boxes=[],this.currentDevicePixelRatio=void 0,this.chartArea=void 0,this._active=[],this._lastEvent=void 0,this._listeners={},this._responsiveListeners=void 0,this._sortedMetasets=[],this.scales={},this._plugins=new Ud,this.$proxies={},this._hiddenIndices={},this.attached=!1,this._animationsDisabled=void 0,this.$context=void 0,this._doResize=function gh(m,f){let d;return function(..._){return f?(clearTimeout(d),d=setTimeout(m,f,_)):m.apply(this,_),f}}(ue=>this.update(ue),R.resizeDelay||0),this._dataChanges=[],cl[this.id]=this,F&&H?(Fr.listen(this,"complete",Oo),Fr.listen(this,"progress",su),this._initialize(),this.attached&&this.update()):console.error("Failed to create chart: can't acquire context from the given item")}get aspectRatio(){const{options:{aspectRatio:d,maintainAspectRatio:_},width:v,height:I,_aspectRatio:z}=this;return Ai(d)?_&&z?z:I?v/I:null:d}get data(){return this.config.data}set data(d){this.config.data=d}get options(){return this._options}set options(d){this.config.options=d}get registry(){return Cr}_initialize(){return this.notifyPlugins("beforeInit"),this.options.responsive?this.resize():So(this,this.options.devicePixelRatio),this.bindEvents(),this.notifyPlugins("afterInit"),this}clear(){return bc(this.canvas,this.ctx),this}stop(){return Fr.stop(this),this}resize(d,_){Fr.running(this)?this._resizeBeforeDraw={width:d,height:_}:this._resize(d,_)}_resize(d,_){const v=this.options,R=this.platform.getMaximumSize(this.canvas,d,_,v.maintainAspectRatio&&this.aspectRatio),F=v.devicePixelRatio||this.platform.getDevicePixelRatio(),H=this.width?"resize":"attach";this.width=R.width,this.height=R.height,this._aspectRatio=this.aspectRatio,So(this,F,!0)&&(this.notifyPlugins("resize",{size:R}),Bi(v.onResize,[this,R],this),this.attached&&this._doResize(H)&&this.render())}ensureScalesHaveIDs(){Ki(this.options.scales||{},(v,I)=>{v.id=I})}buildOrUpdateScales(){const d=this.options,_=d.scales,v=this.scales,I=Object.keys(v).reduce((R,F)=>(R[F]=!1,R),{});let z=[];_&&(z=z.concat(Object.keys(_).map(R=>{const F=_[R],H=vs(R,F),K="r"===H,ie="x"===H;return{options:F,dposition:K?"chartArea":ie?"bottom":"left",dtype:K?"radialLinear":ie?"category":"linear"}}))),Ki(z,R=>{const F=R.options,H=F.id,K=vs(H,F),ie=Ti(F.type,R.dtype);(void 0===F.position||Xc(F.position,K)!==Xc(R.dposition))&&(F.position=R.dposition),I[H]=!0;let ue=null;H in v&&v[H].type===ie?ue=v[H]:(ue=new(Cr.getScale(ie))({id:H,type:ie,ctx:this.ctx,chart:this}),v[ue.id]=ue),ue.init(F,d)}),Ki(I,(R,F)=>{R||delete v[F]}),Ki(v,R=>{dr.configure(this,R,R.options),dr.addBox(this,R)})}_updateMetasets(){const d=this._metasets,_=this.data.datasets.length,v=d.length;if(d.sort((I,z)=>I.index-z.index),v>_){for(let I=_;I<v;++I)this._destroyDatasetMeta(I);d.splice(_,v-_)}this._sortedMetasets=d.slice(0).sort(Yc("order","index"))}_removeUnreferencedMetasets(){const{_metasets:d,data:{datasets:_}}=this;d.length>_.length&&delete this._stacks,d.forEach((v,I)=>{0===_.filter(z=>z===v._dataset).length&&this._destroyDatasetMeta(I)})}buildOrUpdateControllers(){const d=[],_=this.data.datasets;let v,I;for(this._removeUnreferencedMetasets(),v=0,I=_.length;v<I;v++){const z=_[v];let R=this.getDatasetMeta(v);const F=z.type||this.config.type;if(R.type&&R.type!==F&&(this._destroyDatasetMeta(v),R=this.getDatasetMeta(v)),R.type=F,R.indexAxis=z.indexAxis||ec(F,this.options),R.order=z.order||0,R.index=v,R.label=""+z.label,R.visible=this.isDatasetVisible(v),R.controller)R.controller.updateIndex(v),R.controller.linkScales();else{const H=Cr.getController(F),{datasetElementType:K,dataElementType:ie}=fn.datasets[F];Object.assign(H,{dataElementType:Cr.getElement(ie),datasetElementType:K&&Cr.getElement(K)}),R.controller=new H(this,v),d.push(R.controller)}}return this._updateMetasets(),d}_resetElements(){Ki(this.data.datasets,(d,_)=>{this.getDatasetMeta(_).controller.reset()},this)}reset(){this._resetElements(),this.notifyPlugins("reset")}update(d){const _=this.config;_.update();const v=this._options=_.createResolver(_.chartOptionScopes(),this.getContext()),I=this._animationsDisabled=!v.animation;if(this._updateScales(),this._checkEventBindings(),this._updateHiddenIndices(),this._plugins.invalidate(),!1===this.notifyPlugins("beforeUpdate",{mode:d,cancelable:!0}))return;const z=this.buildOrUpdateControllers();this.notifyPlugins("beforeElementsUpdate");let R=0;for(let K=0,ie=this.data.datasets.length;K<ie;K++){const{controller:ue}=this.getDatasetMeta(K),xe=!I&&-1===z.indexOf(ue);ue.buildOrUpdateElements(xe),R=Math.max(+ue.getMaxOverflow(),R)}R=this._minPadding=v.layout.autoPadding?R:0,this._updateLayout(R),I||Ki(z,K=>{K.reset()}),this._updateDatasets(d),this.notifyPlugins("afterUpdate",{mode:d}),this._layers.sort(Yc("z","_idx"));const{_active:F,_lastEvent:H}=this;H?this._eventHandler(H,!0):F.length&&this._updateHoverStyles(F,F,!0),this.render()}_updateScales(){Ki(this.scales,d=>{dr.removeBox(this,d)}),this.ensureScalesHaveIDs(),this.buildOrUpdateScales()}_checkEventBindings(){const d=this.options,_=new Set(Object.keys(this._listeners)),v=new Set(d.events);(!En(_,v)||!!this._responsiveListeners!==d.responsive)&&(this.unbindEvents(),this.bindEvents())}_updateHiddenIndices(){const{_hiddenIndices:d}=this,_=this._getUniformDataChanges()||[];for(const{method:v,start:I,count:z}of _)ou(d,I,"_removeElements"===v?-z:z)}_getUniformDataChanges(){const d=this._dataChanges;if(!d||!d.length)return;this._dataChanges=[];const _=this.data.datasets.length,v=z=>new Set(d.filter(R=>R[0]===z).map((R,F)=>F+","+R.splice(1).join(","))),I=v(0);for(let z=1;z<_;z++)if(!En(I,v(z)))return;return Array.from(I).map(z=>z.split(",")).map(z=>({method:z[1],start:+z[2],count:+z[3]}))}_updateLayout(d){if(!1===this.notifyPlugins("beforeLayout",{cancelable:!0}))return;dr.update(this,this.width,this.height,d);const _=this.chartArea,v=_.width<=0||_.height<=0;this._layers=[],Ki(this.boxes,I=>{v&&"chartArea"===I.position||(I.configure&&I.configure(),this._layers.push(...I._layers()))},this),this._layers.forEach((I,z)=>{I._idx=z}),this.notifyPlugins("afterLayout")}_updateDatasets(d){if(!1!==this.notifyPlugins("beforeDatasetsUpdate",{mode:d,cancelable:!0})){for(let _=0,v=this.data.datasets.length;_<v;++_)this.getDatasetMeta(_).controller.configure();for(let _=0,v=this.data.datasets.length;_<v;++_)this._updateDataset(_,fs(d)?d({datasetIndex:_}):d);this.notifyPlugins("afterDatasetsUpdate",{mode:d})}}_updateDataset(d,_){const v=this.getDatasetMeta(d),I={meta:v,index:d,mode:_,cancelable:!0};!1!==this.notifyPlugins("beforeDatasetUpdate",I)&&(v.controller._update(_),I.cancelable=!1,this.notifyPlugins("afterDatasetUpdate",I))}render(){!1!==this.notifyPlugins("beforeRender",{cancelable:!0})&&(Fr.has(this)?this.attached&&!Fr.running(this)&&Fr.start(this):(this.draw(),Oo({chart:this})))}draw(){let d;if(this._resizeBeforeDraw){const{width:v,height:I}=this._resizeBeforeDraw;this._resizeBeforeDraw=null,this._resize(v,I)}if(this.clear(),this.width<=0||this.height<=0||!1===this.notifyPlugins("beforeDraw",{cancelable:!0}))return;const _=this._layers;for(d=0;d<_.length&&_[d].z<=0;++d)_[d].draw(this.chartArea);for(this._drawDatasets();d<_.length;++d)_[d].draw(this.chartArea);this.notifyPlugins("afterDraw")}_getSortedDatasetMetas(d){const _=this._sortedMetasets,v=[];let I,z;for(I=0,z=_.length;I<z;++I){const R=_[I];(!d||R.visible)&&v.push(R)}return v}getSortedVisibleDatasetMetas(){return this._getSortedDatasetMetas(!0)}_drawDatasets(){if(!1===this.notifyPlugins("beforeDatasetsDraw",{cancelable:!0}))return;const d=this.getSortedVisibleDatasetMetas();for(let _=d.length-1;_>=0;--_)this._drawDataset(d[_]);this.notifyPlugins("afterDatasetsDraw")}_drawDataset(d){const _=this.ctx,v=d._clip,I=!v.disabled,z=function lu(m,f){const{xScale:d,yScale:_}=m;return d&&_?{left:Ln(d,f,"left"),right:Ln(d,f,"right"),top:Ln(_,f,"top"),bottom:Ln(_,f,"bottom")}:f}(d,this.chartArea),R={meta:d,index:d.index,cancelable:!0};!1!==this.notifyPlugins("beforeDatasetDraw",R)&&(I&&ea(_,{left:!1===v.left?0:z.left-v.left,right:!1===v.right?this.width:z.right+v.right,top:!1===v.top?0:z.top-v.top,bottom:!1===v.bottom?this.height:z.bottom+v.bottom}),d.controller.draw(),I&&bo(_),R.cancelable=!1,this.notifyPlugins("afterDatasetDraw",R))}isPointInArea(d){return Wr(d,this.chartArea,this._minPadding)}getElementsAtEventForMode(d,_,v,I){const z=Xh.modes[_];return"function"==typeof z?z(this,d,v,I):[]}getDatasetMeta(d){const _=this.data.datasets[d],v=this._metasets;let I=v.filter(z=>z&&z._dataset===_).pop();return I||(I={type:null,data:[],dataset:null,controller:null,hidden:null,xAxisID:null,yAxisID:null,order:_&&_.order||0,index:d,_dataset:_,_parsed:[],_sorted:!1},v.push(I)),I}getContext(){return this.$context||(this.$context=Rn(null,{chart:this,type:"chart"}))}getVisibleDatasetCount(){return this.getSortedVisibleDatasetMetas().length}isDatasetVisible(d){const _=this.data.datasets[d];if(!_)return!1;const v=this.getDatasetMeta(d);return"boolean"==typeof v.hidden?!v.hidden:!_.hidden}setDatasetVisibility(d,_){this.getDatasetMeta(d).hidden=!_}toggleDataVisibility(d){this._hiddenIndices[d]=!this._hiddenIndices[d]}getDataVisibility(d){return!this._hiddenIndices[d]}_updateVisibility(d,_,v){const I=v?"show":"hide",z=this.getDatasetMeta(d),R=z.controller._resolveAnimations(void 0,I);yo(_)?(z.data[_].hidden=!v,this.update()):(this.setDatasetVisibility(d,v),R.update(z,{visible:v}),this.update(F=>F.datasetIndex===d?I:void 0))}hide(d,_){this._updateVisibility(d,_,!1)}show(d,_){this._updateVisibility(d,_,!0)}_destroyDatasetMeta(d){const _=this._metasets[d];_&&_.controller&&_.controller._destroy(),delete this._metasets[d]}_stop(){let d,_;for(this.stop(),Fr.remove(this),d=0,_=this.data.datasets.length;d<_;++d)this._destroyDatasetMeta(d)}destroy(){this.notifyPlugins("beforeDestroy");const{canvas:d,ctx:_}=this;this._stop(),this.config.clearCache(),d&&(this.unbindEvents(),bc(d,_),this.platform.releaseContext(_),this.canvas=null,this.ctx=null),delete cl[this.id],this.notifyPlugins("afterDestroy")}toBase64Image(...d){return this.canvas.toDataURL(...d)}bindEvents(){this.bindUserEvents(),this.options.responsive?this.bindResponsiveEvents():this.attached=!0}bindUserEvents(){const d=this._listeners,_=this.platform,v=(z,R)=>{_.addEventListener(this,z,R),d[z]=R},I=(z,R,F)=>{z.offsetX=R,z.offsetY=F,this._eventHandler(z)};Ki(this.options.events,z=>v(z,I))}bindResponsiveEvents(){this._responsiveListeners||(this._responsiveListeners={});const d=this._responsiveListeners,_=this.platform,v=(H,K)=>{_.addEventListener(this,H,K),d[H]=K},I=(H,K)=>{d[H]&&(_.removeEventListener(this,H,K),delete d[H])},z=(H,K)=>{this.canvas&&this.resize(H,K)};let R;const F=()=>{I("attach",F),this.attached=!0,this.resize(),v("resize",z),v("detach",R)};R=()=>{this.attached=!1,I("resize",z),this._stop(),this._resize(0,0),v("attach",F)},_.isAttached(this.canvas)?F():R()}unbindEvents(){Ki(this._listeners,(d,_)=>{this.platform.removeEventListener(this,_,d)}),this._listeners={},Ki(this._responsiveListeners,(d,_)=>{this.platform.removeEventListener(this,_,d)}),this._responsiveListeners=void 0}updateHoverStyle(d,_,v){const I=v?"set":"remove";let z,R,F,H;for("dataset"===_&&(z=this.getDatasetMeta(d[0].datasetIndex),z.controller["_"+I+"DatasetHoverStyle"]()),F=0,H=d.length;F<H;++F){R=d[F];const K=R&&this.getDatasetMeta(R.datasetIndex).controller;K&&K[I+"HoverStyle"](R.element,R.datasetIndex,R.index)}}getActiveElements(){return this._active||[]}setActiveElements(d){const _=this._active||[],v=d.map(({datasetIndex:z,index:R})=>{const F=this.getDatasetMeta(z);if(!F)throw new Error("No dataset found at index "+z);return{datasetIndex:z,element:F.data[R],index:R}});!Zs(v,_)&&(this._active=v,this._lastEvent=null,this._updateHoverStyles(v,_))}notifyPlugins(d,_,v){return this._plugins.notify(this,d,_,v)}isPluginEnabled(d){return 1===this._plugins._cache.filter(_=>_.plugin.id===d).length}_updateHoverStyles(d,_,v){const I=this.options.hover,z=(H,K)=>H.filter(ie=>!K.some(ue=>ie.datasetIndex===ue.datasetIndex&&ie.index===ue.index)),R=z(_,d),F=v?d:z(d,_);R.length&&this.updateHoverStyle(R,I.mode,!1),F.length&&I.mode&&this.updateHoverStyle(F,I.mode,!0)}_eventHandler(d,_){const v={event:d,replay:_,cancelable:!0,inChartArea:this.isPointInArea(d)},I=R=>(R.options.events||this.options.events).includes(d.native.type);if(!1===this.notifyPlugins("beforeEvent",v,I))return;const z=this._handleEvent(d,_,v.inChartArea);return v.cancelable=!1,this.notifyPlugins("afterEvent",v,I),(z||v.changed)&&this.render(),this}_handleEvent(d,_,v){const{_active:I=[],options:z}=this,F=this._getActiveElements(d,I,v,_),H=function Sl(m){return"mouseup"===m.type||"click"===m.type||"contextmenu"===m.type}(d),K=function au(m,f,d,_){return d&&"mouseout"!==m.type?_?f:m:null}(d,this._lastEvent,v,H);v&&(this._lastEvent=null,Bi(z.onHover,[d,F,this],this),H&&Bi(z.onClick,[d,F,this],this));const ie=!Zs(F,I);return(ie||_)&&(this._active=F,this._updateHoverStyles(F,I,_)),this._lastEvent=K,ie}_getActiveElements(d,_,v,I){if("mouseout"===d.type)return[];if(!v)return _;const z=this.options.hover;return this.getElementsAtEventForMode(d,z.mode,z,I)}})();function hl(){return Ki(rc.instances,m=>m._plugins.invalidate())}function oo(m,f,d,_){return{x:d+m*Math.cos(f),y:_+m*Math.sin(f)}}function ao(m,f,d,_,v,I){const{x:z,y:R,startAngle:F,pixelMargin:H,innerRadius:K}=f,ie=Math.max(f.outerRadius+_+d-H,0),ue=K>0?K+_+d+H:0;let xe=0;const Oe=v-F;if(_){const Cn=((K>0?K-_:0)+(ie>0?ie-_:0))/2;xe=(Oe-(0!==Cn?Oe*Cn/(Cn+_):Oe))/2}const je=(Oe-Math.max(.001,Oe*ie-d/pn)/ie)/2,ht=F+je+xe,lt=v-je-xe,{outerStart:Et,outerEnd:Dt,innerStart:xt,innerEnd:At}=function Bs(m,f,d,_){const v=function Kc(m){return Ks(m,["outerStart","outerEnd","innerStart","innerEnd"])}(m.options.borderRadius),I=(d-f)/2,z=Math.min(I,_*f/2),R=F=>{const H=(d-Math.min(I,F))*_/2;return Gt(F,0,Math.min(I,H))};return{outerStart:R(v.outerStart),outerEnd:R(v.outerEnd),innerStart:Gt(v.innerStart,0,z),innerEnd:Gt(v.innerEnd,0,z)}}(f,ue,ie,lt-ht),Ht=ie-Et,Ot=ie-Dt,Bt=ht+Et/Ht,Fi=lt-Dt/Ot,Vi=ue+xt,Wi=ue+At,or=ht+xt/Vi,zr=lt-At/Wi;if(m.beginPath(),I){const gn=(Bt+Fi)/2;if(m.arc(z,R,ie,Bt,gn),m.arc(z,R,ie,gn,Fi),Dt>0){const gr=oo(Ot,Fi,z,R);m.arc(gr.x,gr.y,Dt,Fi,lt+$)}const In=oo(Wi,lt,z,R);if(m.lineTo(In.x,In.y),At>0){const gr=oo(Wi,zr,z,R);m.arc(gr.x,gr.y,At,lt+$,zr+Math.PI)}const Cn=(lt-At/ue+(ht+xt/ue))/2;if(m.arc(z,R,ue,lt-At/ue,Cn,!0),m.arc(z,R,ue,Cn,ht+xt/ue,!0),xt>0){const gr=oo(Vi,or,z,R);m.arc(gr.x,gr.y,xt,or+Math.PI,ht-$)}const ws=oo(Ht,ht,z,R);if(m.lineTo(ws.x,ws.y),Et>0){const gr=oo(Ht,Bt,z,R);m.arc(gr.x,gr.y,Et,ht-$,Bt)}}else{m.moveTo(z,R);const gn=Math.cos(Bt)*ie+z,In=Math.sin(Bt)*ie+R;m.lineTo(gn,In);const Cn=Math.cos(Fi)*ie+z,ws=Math.sin(Fi)*ie+R;m.lineTo(Cn,ws)}m.closePath()}function ul(m,f,d=f){m.lineCap=Ti(d.borderCapStyle,f.borderCapStyle),m.setLineDash(Ti(d.borderDash,f.borderDash)),m.lineDashOffset=Ti(d.borderDashOffset,f.borderDashOffset),m.lineJoin=Ti(d.borderJoinStyle,f.borderJoinStyle),m.lineWidth=Ti(d.borderWidth,f.borderWidth),m.strokeStyle=Ti(d.borderColor,f.borderColor)}function uu(m,f,d){m.lineTo(d.x,d.y)}function du(m,f,d={}){const _=m.length,{start:v=0,end:I=_-1}=d,{start:z,end:R}=f,F=Math.max(v,z),H=Math.min(I,R);return{count:_,start:F,loop:f.loop,ilen:H<F&&!(v<z&&I<z||v>R&&I>R)?_+H-F:H-F}}function pu(m,f,d,_){const{points:v,options:I}=f,{count:z,start:R,loop:F,ilen:H}=du(v,d,_),K=function Jc(m){return m.stepped?cr:m.tension||"monotone"===m.cubicInterpolationMode?Ds:uu}(I);let xe,Oe,Be,{move:ie=!0,reverse:ue}=_||{};for(xe=0;xe<=H;++xe)Oe=v[(R+(ue?H-xe:xe))%z],!Oe.skip&&(ie?(m.moveTo(Oe.x,Oe.y),ie=!1):K(m,Be,Oe,ue,I.stepped),Be=Oe);return F&&(Oe=v[(R+(ue?H:0))%z],K(m,Be,Oe,ue,I.stepped)),!!F}function oc(m,f,d,_){const v=f.points,{count:I,start:z,ilen:R}=du(v,d,_),{move:F=!0,reverse:H}=_||{};let ue,xe,Oe,Be,je,ht,K=0,ie=0;const lt=Dt=>(z+(H?R-Dt:Dt))%I,Et=()=>{Be!==je&&(m.lineTo(K,je),m.lineTo(K,Be),m.lineTo(K,ht))};for(F&&(xe=v[lt(0)],m.moveTo(xe.x,xe.y)),ue=0;ue<=R;++ue){if(xe=v[lt(ue)],xe.skip)continue;const Dt=xe.x,xt=xe.y,At=0|Dt;At===Oe?(xt<Be?Be=xt:xt>je&&(je=xt),K=(ie*K+Dt)/++ie):(Et(),m.lineTo(Dt,xt),Oe=At,ie=0,Be=je=xt),ht=xt}Et()}function Qc(m){const f=m.options;return m._decimated||m._loop||f.tension||"monotone"===f.cubicInterpolationMode||f.stepped||f.borderDash&&f.borderDash.length?pu:oc}const ad="function"==typeof Path2D;let Bo=(()=>class m extends xs{static id="line";static defaults={borderCapStyle:"butt",borderDash:[],borderDashOffset:0,borderJoinStyle:"miter",borderWidth:3,capBezierPoints:!0,cubicInterpolationMode:"default",fill:!1,spanGaps:!1,stepped:!1,tension:0};static defaultRoutes={backgroundColor:"backgroundColor",borderColor:"borderColor"};static descriptors={_scriptable:!0,_indexable:d=>"borderDash"!==d&&"fill"!==d};constructor(d){super(),this.animated=!0,this.options=void 0,this._chart=void 0,this._loop=void 0,this._fullLoop=void 0,this._path=void 0,this._points=void 0,this._segments=void 0,this._decimated=!1,this._pointsUpdated=!1,this._datasetIndex=void 0,d&&Object.assign(this,d)}updateControlPoints(d,_){const v=this.options;!v.tension&&"monotone"!==v.cubicInterpolationMode||v.stepped||this._pointsUpdated||(Ih(this._points,v,d,v.spanGaps?this._loop:this._fullLoop,_),this._pointsUpdated=!0)}set points(d){this._points=d,delete this._segments,delete this._path,this._pointsUpdated=!1}get points(){return this._points}get segments(){return this._segments||(this._segments=function Ol(m,f){const d=m.points,_=m.options.spanGaps,v=d.length;if(!v)return[];const I=!!m._loop,{start:z,end:R}=function os(m,f,d,_){let v=0,I=f-1;if(d&&!_)for(;v<f&&!m[v].skip;)v++;for(;v<f&&m[v].skip;)v++;for(v%=f,d&&(I+=v);I>v&&m[I%f].skip;)I--;return I%=f,{start:v,end:I}}(d,v,I,_);return function Fl(m,f,d,_){return _&&_.setContext&&d?function Eo(m,f,d,_){const v=m._chart.getContext(),I=Bl(m.options),{_datasetIndex:z,options:{spanGaps:R}}=m,F=d.length,H=[];let K=I,ie=f[0].start,ue=ie;function xe(Oe,Be,je,ht){const lt=R?-1:1;if(Oe!==Be){for(Oe+=F;d[Oe%F].skip;)Oe-=lt;for(;d[Be%F].skip;)Be+=lt;Oe%F!=Be%F&&(H.push({start:Oe%F,end:Be%F,loop:je,style:ht}),K=ht,ie=Be%F)}}for(const Oe of f){ie=R?ie:Oe.start;let je,Be=d[ie%F];for(ue=ie+1;ue<=Oe.end;ue++){const ht=d[ue%F];je=Bl(_.setContext(Rn(v,{type:"segment",p0:Be,p1:ht,p0DataIndex:(ue-1)%F,p1DataIndex:ue%F,datasetIndex:z}))),Bh(je,K)&&xe(ie,ue-1,Oe.loop,K),Be=ht,K=je}ie<ue-1&&xe(ie,ue-1,Oe.loop,K)}return H}(m,f,d,_):f}(m,!0===_?[{start:z,end:R,loop:I}]:function Sc(m,f,d,_){const v=m.length,I=[];let F,z=f,R=m[f];for(F=f+1;F<=d;++F){const H=m[F%v];H.skip||H.stop?R.skip||(I.push({start:f%v,end:(F-1)%v,loop:_=!1}),f=z=H.stop?F:null):(z=F,R.skip&&(f=F)),R=H}return null!==z&&I.push({start:f%v,end:z%v,loop:_}),I}(d,z,R<z?R+v:R,!!m._fullLoop&&0===z&&R===v-1),d,f)}(this,this.options.segment))}first(){const d=this.segments;return d.length&&this.points[d[0].start]}last(){const d=this.segments,v=d.length;return v&&this.points[d[v-1].end]}interpolate(d,_){const v=this.options,I=d[_],z=this.points,R=Fh(this,{property:_,start:I,end:I});if(!R.length)return;const F=[],H=function rd(m){return m.stepped?zd:m.tension||"monotone"===m.cubicInterpolationMode?Nu:to}(v);let K,ie;for(K=0,ie=R.length;K<ie;++K){const{start:ue,end:xe}=R[K],Oe=z[ue],Be=z[xe];if(Oe===Be){F.push(Oe);continue}const ht=H(Oe,Be,Math.abs((I-Oe[_])/(Be[_]-Oe[_])),v.stepped);ht[_]=d[_],F.push(ht)}return 1===F.length?F[0]:F}pathSegment(d,_,v){return Qc(this)(d,this,_,v)}path(d,_,v){const I=this.segments,z=Qc(this);let R=this._loop;_=_||0,v=v||this.points.length-_;for(const F of I)R&=z(d,this,F,{start:_,end:_+v-1});return!!R}draw(d,_,v,I){(this.points||[]).length&&(this.options||{}).borderWidth&&(d.save(),function ac(m,f,d,_){ad&&!f.options.segment?function sd(m,f,d,_){let v=f._path;v||(v=f._path=new Path2D,f.path(v,d,_)&&v.closePath()),ul(m,f.options),m.stroke(v)}(m,f,d,_):function od(m,f,d,_){const{segments:v,options:I}=f,z=Qc(f);for(const R of v)ul(m,I,R.style),m.beginPath(),z(m,f,R,{start:d,end:d+_-1})&&m.closePath(),m.stroke()}(m,f,d,_)}(d,this,v,I),d.restore()),this.animated&&(this._pointsUpdated=!1,this._path=void 0)}})();function Pr(m,f,d,_){const v=m.options,{[d]:I}=m.getProps([d],_);return Math.abs(f-I)<v.radius+v.hitRadius}let lc=(()=>class m extends xs{static id="point";parsed;skip;stop;static defaults={borderWidth:1,hitRadius:1,hoverBorderWidth:1,hoverRadius:4,pointStyle:"circle",radius:3,rotation:0};static defaultRoutes={backgroundColor:"backgroundColor",borderColor:"borderColor"};constructor(d){super(),this.options=void 0,this.parsed=void 0,this.skip=void 0,this.stop=void 0,d&&Object.assign(this,d)}inRange(d,_,v){const I=this.options,{x:z,y:R}=this.getProps(["x","y"],v);return Math.pow(d-z,2)+Math.pow(_-R,2)<Math.pow(I.hitRadius+I.radius,2)}inXRange(d,_){return Pr(this,d,"x",_)}inYRange(d,_){return Pr(this,d,"y",_)}getCenterPoint(d){const{x:_,y:v}=this.getProps(["x","y"],d);return{x:_,y:v}}size(d){let _=(d=d||this.options||{}).radius||0;return _=Math.max(_,_&&d.hoverRadius||0),2*(_+(_&&d.borderWidth||0))}draw(d,_){const v=this.options;this.skip||v.radius<.1||!Wr(this,_,this.size(v)/2)||(d.strokeStyle=v.borderColor,d.lineWidth=v.borderWidth,d.fillStyle=v.backgroundColor,lr(d,v,this.x,this.y))}getRange(){const d=this.options||{};return d.radius+d.hitRadius}})();function fu(m,f){const{x:d,y:_,base:v,width:I,height:z}=m.getProps(["x","y","base","width","height"],f);let R,F,H,K,ie;return m.horizontal?(ie=z/2,R=Math.min(d,v),F=Math.max(d,v),H=_-ie,K=_+ie):(ie=I/2,R=d-ie,F=d+ie,H=Math.min(_,v),K=Math.max(_,v)),{left:R,top:H,right:F,bottom:K}}function No(m,f,d,_){return m?0:Gt(f,d,_)}function mu(m,f,d,_){const v=null===f,I=null===d,R=m&&!(v&&I)&&fu(m,_);return R&&(v||ui(f,R.left,R.right))&&(I||ui(d,R.top,R.bottom))}function cc(m,f){m.rect(f.x,f.y,f.w,f.h)}function th(m,f,d={}){const _=m.x!==d.x?-f:0,v=m.y!==d.y?-f:0;return{x:m.x+_,y:m.y+v,w:m.w+((m.x+m.w!==d.x+d.w?f:0)-_),h:m.h+((m.y+m.h!==d.y+d.h?f:0)-v),radius:m.radius}}var ih=Object.freeze({__proto__:null,ArcElement:class sc extends xs{static id="arc";static defaults={borderAlign:"center",borderColor:"#fff",borderDash:[],borderDashOffset:0,borderJoinStyle:void 0,borderRadius:0,borderWidth:2,offset:0,spacing:0,angle:void 0,circular:!0};static defaultRoutes={backgroundColor:"backgroundColor"};static descriptors={_scriptable:!0,_indexable:f=>"borderDash"!==f};circumference;endAngle;fullCircles;innerRadius;outerRadius;pixelMargin;startAngle;constructor(f){super(),this.options=void 0,this.circumference=void 0,this.startAngle=void 0,this.endAngle=void 0,this.innerRadius=void 0,this.outerRadius=void 0,this.pixelMargin=0,this.fullCircles=0,f&&Object.assign(this,f)}inRange(f,d,_){const v=this.getProps(["x","y"],_),{angle:I,distance:z}=Nt(v,{x:f,y:d}),{startAngle:R,endAngle:F,innerRadius:H,outerRadius:K,circumference:ie}=this.getProps(["startAngle","endAngle","innerRadius","outerRadius","circumference"],_),ue=(this.options.spacing+this.options.borderWidth)/2,xe=Ti(ie,F-R),Oe=mi(I,R,F)&&R!==F,Be=xe>=ln||Oe,je=ui(z,H+ue,K+ue);return Be&&je}getCenterPoint(f){const{x:d,y:_,startAngle:v,endAngle:I,innerRadius:z,outerRadius:R}=this.getProps(["x","y","startAngle","endAngle","innerRadius","outerRadius"],f),{offset:F,spacing:H}=this.options,K=(v+I)/2,ie=(z+R+H+F)/2;return{x:d+Math.cos(K)*ie,y:_+Math.sin(K)*ie}}tooltipPosition(f){return this.getCenterPoint(f)}draw(f){const{options:d,circumference:_}=this,v=(d.offset||0)/4,I=(d.spacing||0)/2,z=d.circular;if(this.pixelMargin="inner"===d.borderAlign?.33:0,this.fullCircles=_>ln?Math.floor(_/ln):0,0===_||this.innerRadius<0||this.outerRadius<0)return;f.save();const R=(this.startAngle+this.endAngle)/2;f.translate(Math.cos(R)*v,Math.sin(R)*v);const H=v*(1-Math.sin(Math.min(pn,_||0)));f.fillStyle=d.backgroundColor,f.strokeStyle=d.borderColor,function cu(m,f,d,_,v){const{fullCircles:I,startAngle:z,circumference:R}=f;let F=f.endAngle;if(I){ao(m,f,d,_,F,v);for(let H=0;H<I;++H)m.fill();isNaN(R)||(F=z+(R%ln||ln))}ao(m,f,d,_,F,v),m.fill()}(f,this,H,I,z),function hu(m,f,d,_,v){const{fullCircles:I,startAngle:z,circumference:R,options:F}=f,{borderWidth:H,borderJoinStyle:K,borderDash:ie,borderDashOffset:ue}=F,xe="inner"===F.borderAlign;if(!H)return;m.setLineDash(ie||[]),m.lineDashOffset=ue,xe?(m.lineWidth=2*H,m.lineJoin=K||"round"):(m.lineWidth=H,m.lineJoin=K||"bevel");let Oe=f.endAngle;if(I){ao(m,f,d,_,Oe,v);for(let Be=0;Be<I;++Be)m.stroke();isNaN(R)||(Oe=z+(R%ln||ln))}xe&&function Fo(m,f,d){const{startAngle:_,pixelMargin:v,x:I,y:z,outerRadius:R,innerRadius:F}=f;let H=v/R;m.beginPath(),m.arc(I,z,R,_-H,d+H),F>v?(H=v/F,m.arc(I,z,F,d+H,_-H,!0)):m.arc(I,z,v,d+$,_-$),m.closePath(),m.clip()}(m,f,Oe),I||(ao(m,f,d,_,Oe,v),m.stroke())}(f,this,H,I,z),f.restore()}},BarElement:class hc extends xs{static id="bar";static defaults={borderSkipped:"start",borderWidth:0,borderRadius:0,inflateAmount:"auto",pointStyle:void 0};static defaultRoutes={backgroundColor:"backgroundColor",borderColor:"borderColor"};constructor(f){super(),this.options=void 0,this.horizontal=void 0,this.base=void 0,this.width=void 0,this.height=void 0,this.inflateAmount=void 0,f&&Object.assign(this,f)}draw(f){const{inflateAmount:d,options:{borderColor:_,backgroundColor:v}}=this,{inner:I,outer:z}=function eh(m){const f=fu(m),d=f.right-f.left,_=f.bottom-f.top,v=function qd(m,f,d){const v=m.borderSkipped,I=ja(m.options.borderWidth);return{t:No(v.top,I.top,0,d),r:No(v.right,I.right,0,f),b:No(v.bottom,I.bottom,0,d),l:No(v.left,I.left,0,f)}}(m,d/2,_/2),I=function vn(m,f,d){const{enableBorderRadius:_}=m.getProps(["enableBorderRadius"]),v=m.options.borderRadius,I=hr(v),z=Math.min(f,d),R=m.borderSkipped,F=_||zi(v);return{topLeft:No(!F||R.top||R.left,I.topLeft,0,z),topRight:No(!F||R.top||R.right,I.topRight,0,z),bottomLeft:No(!F||R.bottom||R.left,I.bottomLeft,0,z),bottomRight:No(!F||R.bottom||R.right,I.bottomRight,0,z)}}(m,d/2,_/2);return{outer:{x:f.left,y:f.top,w:d,h:_,radius:I},inner:{x:f.left+v.l,y:f.top+v.t,w:d-v.l-v.r,h:_-v.t-v.b,radius:{topLeft:Math.max(0,I.topLeft-Math.max(v.t,v.l)),topRight:Math.max(0,I.topRight-Math.max(v.t,v.r)),bottomLeft:Math.max(0,I.bottomLeft-Math.max(v.b,v.l)),bottomRight:Math.max(0,I.bottomRight-Math.max(v.b,v.r))}}}}(this),R=function _u(m){return m.topLeft||m.topRight||m.bottomLeft||m.bottomRight}(z.radius)?br:cc;f.save(),(z.w!==I.w||z.h!==I.h)&&(f.beginPath(),R(f,th(z,d,I)),f.clip(),R(f,th(I,-d,z)),f.fillStyle=_,f.fill("evenodd")),f.beginPath(),R(f,th(I,d)),f.fillStyle=v,f.fill(),f.restore()}inRange(f,d,_){return mu(this,f,d,_)}inXRange(f,d){return mu(this,f,null,d)}inYRange(f,d){return mu(this,null,f,d)}getCenterPoint(f){const{x:d,y:_,base:v,horizontal:I}=this.getProps(["x","y","base","horizontal"],f);return{x:I?(d+v)/2:d,y:I?_:(_+v)/2}}getRange(f){return"x"===f?this.width/2:this.height/2}},LineElement:Bo,PointElement:lc});const ls=["rgb(54, 162, 235)","rgb(255, 99, 132)","rgb(255, 159, 64)","rgb(255, 205, 86)","rgb(75, 192, 192)","rgb(153, 102, 255)","rgb(201, 203, 207)"],dl=ls.map(m=>m.replace("rgb(","rgba(").replace(")",", 0.5)"));function bn(m){return ls[m%ls.length]}function Yr(m){return dl[m%dl.length]}function fl(m){let f;for(f in m)if(m[f].borderColor||m[f].backgroundColor)return!0;return!1}var yu={id:"colors",defaults:{enabled:!0,forceOverride:!1},beforeLayout(m,f,d){if(!d.enabled)return;const{data:{datasets:_},options:v}=m.config,{elements:I}=v,z=fl(_)||function gu(m){return m&&(m.borderColor||m.backgroundColor)}(v)||I&&fl(I)||function Hd(){return"rgba(0,0,0,0.1)"!==fn.borderColor||"rgba(0,0,0,0.1)"!==fn.backgroundColor}();if(!d.forceOverride&&z)return;const R=function cd(m){let f=0;return(d,_)=>{const v=m.getDatasetMeta(_).controller;v instanceof Hh?f=function uc(m,f){return m.backgroundColor=m.data.map(()=>bn(f++)),f}(d,f):v instanceof zc?f=function ld(m,f){return m.backgroundColor=m.data.map(()=>Yr(f++)),f}(d,f):v&&(f=function pl(m,f){return m.borderColor=bn(f),m.backgroundColor=Yr(f),++f}(d,f))}}(m);_.forEach(R)}};function Vo(m){if(m._decimated){const f=m._data;delete m._decimated,delete m._data,Object.defineProperty(m,"data",{configurable:!0,enumerable:!0,writable:!0,value:f})}}function Ns(m){m.data.datasets.forEach(f=>{Vo(f)})}var Uo={id:"decimation",defaults:{algorithm:"min-max",enabled:!1},beforeElementsUpdate:(m,f,d)=>{if(!d.enabled)return void Ns(m);const _=m.width;m.data.datasets.forEach((v,I)=>{const{_data:z,indexAxis:R}=v,F=m.getDatasetMeta(I),H=z||v.data;if("y"===Pl([R,m.options.indexAxis])||!F.controller.supportsDecimation)return;const K=m.scales[F.xAxisID];if("linear"!==K.type&&"time"!==K.type||m.options.parsing)return;let Oe,{start:ie,count:ue}=function bs(m,f){const d=f.length;let v,_=0;const{iScale:I}=m,{min:z,max:R,minDefined:F,maxDefined:H}=I.getUserBounds();return F&&(_=Gt(ir(f,I.axis,z).lo,0,d-1)),v=H?Gt(ir(f,I.axis,R).hi+1,_,d)-_:d-_,{start:_,count:v}}(F,H);if(ue<=(d.threshold||4*_))Vo(v);else{switch(Ai(z)&&(v._data=H,delete v.data,Object.defineProperty(v,"data",{configurable:!0,enumerable:!0,get:function(){return this._decimated},set:function(Be){this._data=Be}})),d.algorithm){case"lttb":Oe=function xu(m,f,d,_,v){const I=v.samples||_;if(I>=d)return m.slice(f,f+d);const z=[],R=(d-2)/(I-2);let F=0;const H=f+d-1;let ie,ue,xe,Oe,Be,K=f;for(z[F++]=m[K],ie=0;ie<I-2;ie++){let lt,je=0,ht=0;const Et=Math.floor((ie+1)*R)+1+f,Dt=Math.min(Math.floor((ie+2)*R)+1,d)+f,xt=Dt-Et;for(lt=Et;lt<Dt;lt++)je+=m[lt].x,ht+=m[lt].y;je/=xt,ht/=xt;const At=Math.floor(ie*R)+1+f,Ht=Math.min(Math.floor((ie+1)*R)+1,d)+f,{x:Ot,y:Bt}=m[K];for(xe=Oe=-1,lt=At;lt<Ht;lt++)Oe=.5*Math.abs((Ot-je)*(m[lt].y-Bt)-(Ot-m[lt].x)*(ht-Bt)),Oe>xe&&(xe=Oe,ue=m[lt],Be=lt);z[F++]=ue,K=Be}return z[F++]=m[H],z}(H,ie,ue,_,d);break;case"min-max":Oe=function ya(m,f,d,_){let z,R,F,H,K,ie,ue,xe,Oe,Be,v=0,I=0;const je=[],lt=m[f].x,Dt=m[f+d-1].x-lt;for(z=f;z<f+d;++z){R=m[z],F=(R.x-lt)/Dt*_,H=R.y;const xt=0|F;if(xt===K)H<Oe?(Oe=H,ie=z):H>Be&&(Be=H,ue=z),v=(I*v+R.x)/++I;else{const At=z-1;if(!Ai(ie)&&!Ai(ue)){const Ht=Math.min(ie,ue),Ot=Math.max(ie,ue);Ht!==xe&&Ht!==At&&je.push({...m[Ht],x:v}),Ot!==xe&&Ot!==At&&je.push({...m[Ot],x:v})}z>0&&At!==xe&&je.push(m[At]),je.push(R),K=xt,I=0,Oe=Be=H,ie=ue=xe=z}}return je}(H,ie,ue,_);break;default:throw new Error(`Unsupported decimation algorithm '${d.algorithm}'`)}v._decimated=Oe}})},destroy(m){Ns(m)}};function Vs(m,f,d,_){if(_)return;let v=f[m],I=d[m];return"angle"===m&&(v=ei(v),I=ei(I)),{property:m,start:v,end:I}}function vu(m,f,d){for(;f>m;f--){const _=d[f];if(!isNaN(_.x)&&!isNaN(_.y))break}return f}function hd(m,f,d,_){return m&&f?_(m[d],f[d]):m?m[d]:f?f[d]:0}function dc(m,f){let d=[],_=!1;return Yi(m)?(_=!0,d=m):d=function Wd(m,f){const{x:d=null,y:_=null}=m||{},v=f.points,I=[];return f.segments.forEach(({start:z,end:R})=>{R=vu(z,R,v);const F=v[z],H=v[R];null!==_?(I.push({x:F.x,y:_}),I.push({x:H.x,y:_})):null!==d&&(I.push({x:d,y:F.y}),I.push({x:d,y:H.y}))}),I}(m,f),d.length?new Bo({points:d,options:{tension:0},_loop:_,_fullLoop:_}):null}function bu(m){return m&&!1!==m.fill}function wr(m,f,d){let v=m[f].fill;const I=[f];let z;if(!d)return v;for(;!1!==v&&-1===I.indexOf(v);){if(!Hi(v))return v;if(z=m[v],!z)return!1;if(z.visible)return v;I.push(v),v=z.fill}return!1}function ml(m,f,d){const _=function nh(m){const f=m.options,d=f.fill;let _=Ti(d&&d.target,d);return void 0===_&&(_=!!f.backgroundColor),!1!==_&&null!==_&&(!0===_?"origin":_)}(m);if(zi(_))return!isNaN(_.value)&&_;let v=parseFloat(_);return Hi(v)&&Math.floor(v)===v?function ud(m,f,d,_){return("-"===m||"+"===m)&&(d=f+d),!(d===f||d<0||d>=_)&&d}(_[0],f,v,d):["origin","start","end","stack","shape"].indexOf(_)>=0&&_}function gl(m,f,d){const _=[];for(let v=0;v<d.length;v++){const I=d[v],{first:z,last:R,point:F}=va(I,f,"x");if(!(!F||z&&R))if(z)_.unshift(F);else if(m.push(F),!R)break}m.push(..._)}function va(m,f,d){const _=m.interpolate(f,d);if(!_)return{};const v=_[d],I=m.segments,z=m.points;let R=!1,F=!1;for(let H=0;H<I.length;H++){const K=I[H],ie=z[K.start][d],ue=z[K.end][d];if(ui(v,ie,ue)){R=v===ie,F=v===ue;break}}return{first:R,last:F,point:_}}class jo{constructor(f){this.x=f.x,this.y=f.y,this.radius=f.radius}pathSegment(f,d,_){const{x:v,y:I,radius:z}=this;return f.arc(v,I,z,(d=d||{start:0,end:ln}).end,d.start,!0),!_.bounds}interpolate(f){const{x:d,y:_,radius:v}=this,I=f.angle;return{x:d+Math.cos(I)*v,y:_+Math.sin(I)*v,angle:I}}}function yl(m,f,d){const _=function wu(m){const{chart:f,fill:d,line:_}=m;if(Hi(d))return function Ci(m,f){const d=m.getDatasetMeta(f);return d&&m.isDatasetVisible(f)?d.dataset:null}(f,d);if("stack"===d)return function Kr(m){const{scale:f,index:d,line:_}=m,v=[],I=_.segments,z=_.points,R=function Jr(m,f){const d=[],_=m.getMatchingVisibleMetas("line");for(let v=0;v<_.length;v++){const I=_[v];if(I.index===f)break;I.hidden||d.unshift(I.dataset)}return d}(f,d);R.push(dc({x:null,y:f.bottom},_));for(let F=0;F<I.length;F++){const H=I[F];for(let K=H.start;K<=H.end;K++)gl(v,z[K],R)}return new Bo({points:v,options:{}})}(m);if("shape"===d)return!0;const v=function Go(m){return(m.scale||{}).getPointPositionForValue?function Zd(m){const{scale:f,fill:d}=m,_=f.options,v=f.getLabels().length,I=_.reverse?f.max:f.min,z=function _l(m,f,d){let _;return _="start"===m?d:"end"===m?f.options.reverse?f.min:f.max:zi(m)?m.value:f.getBaseValue(),_}(d,f,I),R=[];if(_.grid.circular){const F=f.getPointPositionForValue(0,I);return new jo({x:F.x,y:F.y,radius:f.getDistanceFromCenterForValue(z)})}for(let F=0;F<v;++F)R.push(f.getPointPositionForValue(F,z));return R}(m):function $d(m){const{scale:f={},fill:d}=m,_=function dd(m,f){let d=null;return"start"===m?d=f.bottom:"end"===m?d=f.top:zi(m)?d=f.getPixelForValue(m.value):f.getBasePixel&&(d=f.getBasePixel()),d}(d,f);if(Hi(_)){const v=f.isHorizontal();return{x:v?_:null,y:v?null:_}}return null}(m)}(m);return v instanceof jo?v:dc(v,_)}(f),{line:v,scale:I,axis:z}=f,R=v.options,F=R.fill,H=R.backgroundColor,{above:K=H,below:ie=H}=F||{};_&&v.points.length&&(ea(m,d),function Us(m,f){const{line:d,target:_,above:v,below:I,area:z,scale:R}=f,F=d._loop?"angle":f.axis;m.save(),"x"===F&&I!==v&&(cs(m,_,z.top),fr(m,{line:d,target:_,color:v,scale:R,property:F}),m.restore(),m.save(),cs(m,_,z.bottom)),fr(m,{line:d,target:_,color:I,scale:R,property:F}),m.restore()}(m,{line:v,target:_,above:K,below:ie,area:d,scale:I,axis:z}),bo(m))}function cs(m,f,d){const{segments:_,points:v}=f;let I=!0,z=!1;m.beginPath();for(const R of _){const{start:F,end:H}=R,K=v[F],ie=v[vu(F,H,v)];I?(m.moveTo(K.x,K.y),I=!1):(m.lineTo(K.x,d),m.lineTo(K.x,K.y)),z=!!f.pathSegment(m,R,{move:z}),z?m.closePath():m.lineTo(ie.x,d)}m.lineTo(f.first().x,d),m.closePath(),m.clip()}function fr(m,f){const{line:d,target:_,property:v,color:I,scale:z}=f,R=function xa(m,f,d){const _=m.segments,v=m.points,I=f.points,z=[];for(const R of _){let{start:F,end:H}=R;H=vu(F,H,v);const K=Vs(d,v[F],v[H],R.loop);if(!f.segments){z.push({source:R,target:K,start:v[F],end:v[H]});continue}const ie=Fh(f,K);for(const ue of ie){const xe=Vs(d,I[ue.start],I[ue.end],ue.loop),Oe=$a(R,v,xe);for(const Be of Oe)z.push({source:Be,target:ue,start:{[d]:hd(K,xe,"start",Math.max)},end:{[d]:hd(K,xe,"end",Math.min)}})}}return z}(d,_,v);for(const{source:F,target:H,start:K,end:ie}of R){const{style:{backgroundColor:ue=I}={}}=F,xe=!0!==_;m.save(),m.fillStyle=ue,Vr(m,z,xe&&Vs(v,K,ie)),m.beginPath();const Oe=!!d.pathSegment(m,F);let Be;if(xe){Oe?m.closePath():$n(m,_,ie,v);const je=!!_.pathSegment(m,H,{move:Oe,reverse:!0});Be=Oe&&je,Be||$n(m,_,K,v)}m.closePath(),m.fill(Be?"evenodd":"nonzero"),m.restore()}}function Vr(m,f,d){const{top:_,bottom:v}=f.chart.chartArea,{property:I,start:z,end:R}=d||{};"x"===I&&(m.beginPath(),m.rect(z,_,R-z,v-_),m.clip())}function $n(m,f,d,_){const v=f.interpolate(d,_);v&&m.lineTo(v.x,v.y)}var pd={id:"filler",afterDatasetsUpdate(m,f,d){const _=(m.data.datasets||[]).length,v=[];let I,z,R,F;for(z=0;z<_;++z)I=m.getDatasetMeta(z),R=I.dataset,F=null,R&&R.options&&R instanceof Bo&&(F={visible:m.isDatasetVisible(z),index:z,fill:ml(R,z,_),chart:m,axis:I.controller.options.indexAxis,scale:I.vScale,line:R}),I.$filler=F,v.push(F);for(z=0;z<_;++z)F=v[z],F&&!1!==F.fill&&(F.fill=wr(v,z,d.propagate))},beforeDraw(m,f,d){const _="beforeDraw"===d.drawTime,v=m.getSortedVisibleDatasetMetas(),I=m.chartArea;for(let z=v.length-1;z>=0;--z){const R=v[z].$filler;R&&(R.line.updateControlPoints(I,R.axis),_&&R.fill&&yl(m.ctx,R,I))}},beforeDatasetsDraw(m,f,d){if("beforeDatasetsDraw"!==d.drawTime)return;const _=m.getSortedVisibleDatasetMetas();for(let v=_.length-1;v>=0;--v){const I=_[v].$filler;bu(I)&&yl(m.ctx,I,m.chartArea)}},beforeDatasetDraw(m,f,d){const _=f.meta.$filler;!bu(_)||"beforeDatasetDraw"!==d.drawTime||yl(m.ctx,_,m.chartArea)},defaults:{propagate:!0,drawTime:"beforeDatasetDraw"}};const _n=(m,f)=>{let{boxHeight:d=f,boxWidth:_=f}=m;return m.usePointStyle&&(d=Math.min(d,f),_=m.pointStyleWidth||Math.min(_,f)),{boxWidth:_,boxHeight:d,itemHeight:Math.max(f,d)}};class ba extends xs{constructor(f){super(),this._added=!1,this.legendHitBoxes=[],this._hoveredItem=null,this.doughnutMode=!1,this.chart=f.chart,this.options=f.options,this.ctx=f.ctx,this.legendItems=void 0,this.columnSizes=void 0,this.lineWidths=void 0,this.maxHeight=void 0,this.maxWidth=void 0,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.height=void 0,this.width=void 0,this._margins=void 0,this.position=void 0,this.weight=void 0,this.fullSize=void 0}update(f,d,_){this.maxWidth=f,this.maxHeight=d,this._margins=_,this.setDimensions(),this.buildLabels(),this.fit()}setDimensions(){this.isHorizontal()?(this.width=this.maxWidth,this.left=this._margins.left,this.right=this.width):(this.height=this.maxHeight,this.top=this._margins.top,this.bottom=this.height)}buildLabels(){const f=this.options.labels||{};let d=Bi(f.generateLabels,[this.chart],this)||[];f.filter&&(d=d.filter(_=>f.filter(_,this.chart.data))),f.sort&&(d=d.sort((_,v)=>f.sort(_,v,this.chart.data))),this.options.reverse&&d.reverse(),this.legendItems=d}fit(){const{options:f,ctx:d}=this;if(!f.display)return void(this.width=this.height=0);const _=f.labels,v=mn(_.font),I=v.size,z=this._computeTitleHeight(),{boxWidth:R,itemHeight:F}=_n(_,I);let H,K;d.font=v.string,this.isHorizontal()?(H=this.maxWidth,K=this._fitRows(z,I,R,F)+10):(K=this.maxHeight,H=this._fitCols(z,v,R,F)+10),this.width=Math.min(H,f.maxWidth||this.maxWidth),this.height=Math.min(K,f.maxHeight||this.maxHeight)}_fitRows(f,d,_,v){const{ctx:I,maxWidth:z,options:{labels:{padding:R}}}=this,F=this.legendHitBoxes=[],H=this.lineWidths=[0],K=v+R;let ie=f;I.textAlign="left",I.textBaseline="middle";let ue=-1,xe=-K;return this.legendItems.forEach((Oe,Be)=>{const je=_+d/2+I.measureText(Oe.text).width;(0===Be||H[H.length-1]+je+2*R>z)&&(ie+=K,H[H.length-(Be>0?0:1)]=0,xe+=K,ue++),F[Be]={left:0,top:xe,row:ue,width:je,height:v},H[H.length-1]+=je+R}),ie}_fitCols(f,d,_,v){const{ctx:I,maxHeight:z,options:{labels:{padding:R}}}=this,F=this.legendHitBoxes=[],H=this.columnSizes=[],K=z-f;let ie=R,ue=0,xe=0,Oe=0,Be=0;return this.legendItems.forEach((je,ht)=>{const{itemWidth:lt,itemHeight:Et}=function l(m,f,d,_,v){const I=function t(m,f,d,_){let v=m.text;return v&&"string"!=typeof v&&(v=v.reduce((I,z)=>I.length>z.length?I:z)),f+d.size/2+_.measureText(v).width}(_,m,f,d),z=function n(m,f,d){let _=m;return"string"!=typeof f.text&&(_=c(f,d)),_}(v,_,f.lineHeight);return{itemWidth:I,itemHeight:z}}(_,d,I,je,v);ht>0&&xe+Et+2*R>K&&(ie+=ue+R,H.push({width:ue,height:xe}),Oe+=ue+R,Be++,ue=xe=0),F[ht]={left:Oe,top:xe,col:Be,width:lt,height:Et},ue=Math.max(ue,lt),xe+=Et+R}),ie+=ue,H.push({width:ue,height:xe}),ie}adjustHitBoxes(){if(!this.options.display)return;const f=this._computeTitleHeight(),{legendHitBoxes:d,options:{align:_,labels:{padding:v},rtl:I}}=this,z=Wa(I,this.left,this.width);if(this.isHorizontal()){let R=0,F=xn(_,this.left+v,this.right-this.lineWidths[R]);for(const H of d)R!==H.row&&(R=H.row,F=xn(_,this.left+v,this.right-this.lineWidths[R])),H.top+=this.top+f+v,H.left=z.leftForLtr(z.x(F),H.width),F+=H.width+v}else{let R=0,F=xn(_,this.top+f+v,this.bottom-this.columnSizes[R].height);for(const H of d)H.col!==R&&(R=H.col,F=xn(_,this.top+f+v,this.bottom-this.columnSizes[R].height)),H.top=F,H.left+=this.left+v,H.left=z.leftForLtr(z.x(H.left),H.width),F+=H.height+v}}isHorizontal(){return"top"===this.options.position||"bottom"===this.options.position}draw(){if(this.options.display){const f=this.ctx;ea(f,this),this._draw(),bo(f)}}_draw(){const{options:f,columnSizes:d,lineWidths:_,ctx:v}=this,{align:I,labels:z}=f,R=fn.color,F=Wa(f.rtl,this.left,this.width),H=mn(z.font),{padding:K}=z,ie=H.size,ue=ie/2;let xe;this.drawTitle(),v.textAlign=F.textAlign("left"),v.textBaseline="middle",v.lineWidth=.5,v.font=H.string;const{boxWidth:Oe,boxHeight:Be,itemHeight:je}=_n(z,ie),Et=this.isHorizontal(),Dt=this._computeTitleHeight();xe=Et?{x:xn(I,this.left+K,this.right-_[0]),y:this.top+K+Dt,line:0}:{x:this.left+K,y:xn(I,this.top+Dt+K,this.bottom-d[0].height),line:0},Lh(this.ctx,f.textDirection);const xt=je+K;this.legendItems.forEach((At,Ht)=>{v.strokeStyle=At.fontColor,v.fillStyle=At.fontColor;const Ot=v.measureText(At.text).width,Bt=F.textAlign(At.textAlign||(At.textAlign=z.textAlign)),Fi=Oe+ue+Ot;let Vi=xe.x,Wi=xe.y;F.setWidth(this.width),Et?Ht>0&&Vi+Fi+K>this.right&&(Wi=xe.y+=xt,xe.line++,Vi=xe.x=xn(I,this.left+K,this.right-_[xe.line])):Ht>0&&Wi+xt>this.bottom&&(Vi=xe.x=Vi+d[xe.line].width+K,xe.line++,Wi=xe.y=xn(I,this.top+Dt+K,this.bottom-d[xe.line].height)),function(At,Ht,Ot){if(isNaN(Oe)||Oe<=0||isNaN(Be)||Be<0)return;v.save();const Bt=Ti(Ot.lineWidth,1);if(v.fillStyle=Ti(Ot.fillStyle,R),v.lineCap=Ti(Ot.lineCap,"butt"),v.lineDashOffset=Ti(Ot.lineDashOffset,0),v.lineJoin=Ti(Ot.lineJoin,"miter"),v.lineWidth=Bt,v.strokeStyle=Ti(Ot.strokeStyle,R),v.setLineDash(Ti(Ot.lineDash,[])),z.usePointStyle){const Fi={radius:Be*Math.SQRT2/2,pointStyle:Ot.pointStyle,rotation:Ot.rotation,borderWidth:Bt},Vi=F.xPlus(At,Oe/2);Il(v,Fi,Vi,Ht+ue,z.pointStyleWidth&&Oe)}else{const Fi=Ht+Math.max((ie-Be)/2,0),Vi=F.leftForLtr(At,Oe),Wi=hr(Ot.borderRadius);v.beginPath(),Object.values(Wi).some(or=>0!==or)?br(v,{x:Vi,y:Fi,w:Oe,h:Be,radius:Wi}):v.rect(Vi,Fi,Oe,Be),v.fill(),0!==Bt&&v.stroke()}v.restore()}(F.x(Vi),Wi,At),Vi=((m,f,d,_)=>m===(_?"left":"right")?d:"center"===m?(f+d)/2:f)(Bt,Vi+Oe+ue,Et?Vi+Fi:this.right,f.rtl),function(At,Ht,Ot){en(v,Ot.text,At,Ht+je/2,H,{strikethrough:Ot.hidden,textAlign:F.textAlign(Ot.textAlign)})}(F.x(Vi),Wi,At),Et?xe.x+=Fi+K:xe.y+="string"!=typeof At.text?c(At,H.lineHeight)+K:xt}),Mo(this.ctx,f.textDirection)}drawTitle(){const f=this.options,d=f.title,_=mn(d.font),v=sr(d.padding);if(!d.display)return;const I=Wa(f.rtl,this.left,this.width),z=this.ctx,R=d.position,H=v.top+_.size/2;let K,ie=this.left,ue=this.width;if(this.isHorizontal())ue=Math.max(...this.lineWidths),K=this.top+H,ie=xn(f.align,ie,this.right-ue);else{const Oe=this.columnSizes.reduce((Be,je)=>Math.max(Be,je.height),0);K=H+xn(f.align,this.top,this.bottom-Oe-f.labels.padding-this._computeTitleHeight())}const xe=xn(R,ie,ie+ue);z.textAlign=I.textAlign(nr(R)),z.textBaseline="middle",z.strokeStyle=d.color,z.fillStyle=d.color,z.font=_.string,en(z,d.text,xe,K,_)}_computeTitleHeight(){const f=this.options.title,d=mn(f.font),_=sr(f.padding);return f.display?d.lineHeight+_.height:0}_getLegendItemAt(f,d){let _,v,I;if(ui(f,this.left,this.right)&&ui(d,this.top,this.bottom))for(I=this.legendHitBoxes,_=0;_<I.length;++_)if(v=I[_],ui(f,v.left,v.left+v.width)&&ui(d,v.top,v.top+v.height))return this.legendItems[_];return null}handleEvent(f){const d=this.options;if(!function p(m,f){return!(("mousemove"!==m&&"mouseout"!==m||!f.onHover&&!f.onLeave)&&(!f.onClick||"click"!==m&&"mouseup"!==m))}(f.type,d))return;const _=this._getLegendItemAt(f.x,f.y);if("mousemove"===f.type||"mouseout"===f.type){const v=this._hoveredItem,I=((m,f)=>null!==m&&null!==f&&m.datasetIndex===f.datasetIndex&&m.index===f.index)(v,_);v&&!I&&Bi(d.onLeave,[f,v,this],this),this._hoveredItem=_,_&&!I&&Bi(d.onHover,[f,_,this],this)}else _&&Bi(d.onClick,[f,_,this],this)}}function c(m,f){return f*(m.text?m.text.length:0)}var y={id:"legend",_element:ba,start(m,f,d){const _=m.legend=new ba({ctx:m.ctx,options:d,chart:m});dr.configure(m,_,d),dr.addBox(m,_)},stop(m){dr.removeBox(m,m.legend),delete m.legend},beforeUpdate(m,f,d){const _=m.legend;dr.configure(m,_,d),_.options=d},afterUpdate(m){const f=m.legend;f.buildLabels(),f.adjustHitBoxes()},afterEvent(m,f){f.replay||m.legend.handleEvent(f.event)},defaults:{display:!0,position:"top",align:"center",fullSize:!0,reverse:!1,weight:1e3,onClick(m,f,d){const _=f.datasetIndex,v=d.chart;v.isDatasetVisible(_)?(v.hide(_),f.hidden=!0):(v.show(_),f.hidden=!1)},onHover:null,onLeave:null,labels:{color:m=>m.chart.options.color,boxWidth:40,padding:10,generateLabels(m){const f=m.data.datasets,{labels:{usePointStyle:d,pointStyle:_,textAlign:v,color:I,useBorderRadius:z,borderRadius:R}}=m.legend.options;return m._getSortedDatasetMetas().map(F=>{const H=F.controller.getStyle(d?0:void 0),K=sr(H.borderWidth);return{text:f[F.index].label,fillStyle:H.backgroundColor,fontColor:I,hidden:!F.visible,lineCap:H.borderCapStyle,lineDash:H.borderDash,lineDashOffset:H.borderDashOffset,lineJoin:H.borderJoinStyle,lineWidth:(K.width+K.height)/4,strokeStyle:H.borderColor,pointStyle:_||H.pointStyle,rotation:H.rotation,textAlign:v||H.textAlign,borderRadius:z&&(R||H.borderRadius),datasetIndex:F.index}},this)}},title:{color:m=>m.chart.options.color,display:!1,position:"center",text:""}},descriptors:{_scriptable:m=>!m.startsWith("on"),labels:{_scriptable:m=>!["generateLabels","filter","sort"].includes(m)}}};class b extends xs{constructor(f){super(),this.chart=f.chart,this.options=f.options,this.ctx=f.ctx,this._padding=void 0,this.top=void 0,this.bottom=void 0,this.left=void 0,this.right=void 0,this.width=void 0,this.height=void 0,this.position=void 0,this.weight=void 0,this.fullSize=void 0}update(f,d){const _=this.options;if(this.left=0,this.top=0,!_.display)return void(this.width=this.height=this.right=this.bottom=0);this.width=this.right=f,this.height=this.bottom=d;const v=Yi(_.text)?_.text.length:1;this._padding=sr(_.padding);const I=v*mn(_.font).lineHeight+this._padding.height;this.isHorizontal()?this.height=I:this.width=I}isHorizontal(){const f=this.options.position;return"top"===f||"bottom"===f}_drawArgs(f){const{top:d,left:_,bottom:v,right:I,options:z}=this,R=z.align;let H,K,ie,F=0;return this.isHorizontal()?(K=xn(R,_,I),ie=d+f,H=I-_):("left"===z.position?(K=_+f,ie=xn(R,v,d),F=-.5*pn):(K=I-f,ie=xn(R,d,v),F=.5*pn),H=v-d),{titleX:K,titleY:ie,maxWidth:H,rotation:F}}draw(){const f=this.ctx,d=this.options;if(!d.display)return;const _=mn(d.font),I=_.lineHeight/2+this._padding.top,{titleX:z,titleY:R,maxWidth:F,rotation:H}=this._drawArgs(I);en(f,d.text,0,0,_,{color:d.color,maxWidth:F,rotation:H,textAlign:nr(d.align),textBaseline:"middle",translation:[z,R]})}}var D={id:"title",_element:b,start(m,f,d){!function E(m,f){const d=new b({ctx:m.ctx,options:f,chart:m});dr.configure(m,d,f),dr.addBox(m,d),m.titleBlock=d}(m,d)},stop(m){dr.removeBox(m,m.titleBlock),delete m.titleBlock},beforeUpdate(m,f,d){const _=m.titleBlock;dr.configure(m,_,d),_.options=d},defaults:{align:"center",display:!1,font:{weight:"bold"},fullSize:!0,padding:10,position:"top",text:"",weight:2e3},defaultRoutes:{color:"color"},descriptors:{_scriptable:!0,_indexable:!1}};const L=new WeakMap;var k={id:"subtitle",start(m,f,d){const _=new b({ctx:m.ctx,options:d,chart:m});dr.configure(m,_,d),dr.addBox(m,_),L.set(m,_)},stop(m){dr.removeBox(m,L.get(m)),L.delete(m)},beforeUpdate(m,f,d){const _=L.get(m);dr.configure(m,_,d),_.options=d},defaults:{align:"center",display:!1,font:{weight:"normal"},fullSize:!0,padding:0,position:"top",text:"",weight:1500},defaultRoutes:{color:"color"},descriptors:{_scriptable:!0,_indexable:!1}};const N={average(m){if(!m.length)return!1;let f,d,_=new Set,v=0,I=0;for(f=0,d=m.length;f<d;++f){const R=m[f].element;if(R&&R.hasValue()){const F=R.tooltipPosition();_.add(F.x),v+=F.y,++I}}return 0!==I&&0!==_.size&&{x:[..._].reduce((R,F)=>R+F)/_.size,y:v/I}},nearest(m,f){if(!m.length)return!1;let I,z,R,d=f.x,_=f.y,v=Number.POSITIVE_INFINITY;for(I=0,z=m.length;I<z;++I){const F=m[I].element;if(F&&F.hasValue()){const K=Vt(f,F.getCenterPoint());K<v&&(v=K,R=F)}}if(R){const F=R.tooltipPosition();d=F.x,_=F.y}return{x:d,y:_}}};function V(m,f){return f&&(Yi(f)?Array.prototype.push.apply(m,f):m.push(f)),m}function j(m){return("string"==typeof m||m instanceof String)&&m.indexOf("\n")>-1?m.split("\n"):m}function Y(m,f){const{element:d,datasetIndex:_,index:v}=f,I=m.getDatasetMeta(_).controller,{label:z,value:R}=I.getLabelAndValue(v);return{chart:m,label:z,parsed:I.getParsed(v),raw:m.data.datasets[_].data[v],formattedValue:R,dataset:I.getDataset(),dataIndex:v,datasetIndex:_,element:d}}function Z(m,f){const d=m.chart.ctx,{body:_,footer:v,title:I}=m,{boxWidth:z,boxHeight:R}=f,F=mn(f.bodyFont),H=mn(f.titleFont),K=mn(f.footerFont),ie=I.length,ue=v.length,xe=_.length,Oe=sr(f.padding);let Be=Oe.height,je=0,ht=_.reduce((Dt,xt)=>Dt+xt.before.length+xt.lines.length+xt.after.length,0);ht+=m.beforeBody.length+m.afterBody.length,ie&&(Be+=ie*H.lineHeight+(ie-1)*f.titleSpacing+f.titleMarginBottom),ht&&(Be+=xe*(f.displayColors?Math.max(R,F.lineHeight):F.lineHeight)+(ht-xe)*F.lineHeight+(ht-1)*f.bodySpacing),ue&&(Be+=f.footerMarginTop+ue*K.lineHeight+(ue-1)*f.footerSpacing);let lt=0;const Et=function(Dt){je=Math.max(je,d.measureText(Dt).width+lt)};return d.save(),d.font=H.string,Ki(m.title,Et),d.font=F.string,Ki(m.beforeBody.concat(m.afterBody),Et),lt=f.displayColors?z+2+f.boxPadding:0,Ki(_,Dt=>{Ki(Dt.before,Et),Ki(Dt.lines,Et),Ki(Dt.after,Et)}),lt=0,d.font=K.string,Ki(m.footer,Et),d.restore(),je+=Oe.width,{width:je,height:Be}}function re(m,f,d,_){const{x:v,width:I}=d,{width:z,chartArea:{left:R,right:F}}=m;let H="center";return"center"===_?H=v<=(R+F)/2?"left":"right":v<=I/2?H="left":v>=z-I/2&&(H="right"),function J(m,f,d,_){const{x:v,width:I}=_,z=d.caretSize+d.caretPadding;if("left"===m&&v+I+z>f.width||"right"===m&&v-I-z<0)return!0}(H,m,f,d)&&(H="center"),H}function he(m,f,d){const _=d.yAlign||f.yAlign||function Q(m,f){const{y:d,height:_}=f;return d<_/2?"top":d>m.height-_/2?"bottom":"center"}(m,d);return{xAlign:d.xAlign||f.xAlign||re(m,f,d,_),yAlign:_}}function pe(m,f,d,_){const{caretSize:v,caretPadding:I,cornerRadius:z}=m,{xAlign:R,yAlign:F}=d,H=v+I,{topLeft:K,topRight:ie,bottomLeft:ue,bottomRight:xe}=hr(z);let Oe=function ce(m,f){let{x:d,width:_}=m;return"right"===f?d-=_:"center"===f&&(d-=_/2),d}(f,R);const Be=function ge(m,f,d){let{y:_,height:v}=m;return"top"===f?_+=d:_-="bottom"===f?v+d:v/2,_}(f,F,H);return"center"===F?"left"===R?Oe+=H:"right"===R&&(Oe-=H):"left"===R?Oe-=Math.max(K,ue)+v:"right"===R&&(Oe+=Math.max(ie,xe)+v),{x:Gt(Oe,0,_.width-f.width),y:Gt(Be,0,_.height-f.height)}}function _e(m,f,d){const _=sr(d.padding);return"center"===f?m.x+m.width/2:"right"===f?m.x+m.width-_.right:m.x+_.left}function de(m){return V([],j(m))}function Ee(m,f){const d=f&&f.dataset&&f.dataset.tooltip&&f.dataset.tooltip.callbacks;return d?m.override(d):m}const qe={beforeTitle:Ar,title(m){if(m.length>0){const f=m[0],d=f.chart.data.labels,_=d?d.length:0;if(this&&this.options&&"dataset"===this.options.mode)return f.dataset.label||"";if(f.label)return f.label;if(_>0&&f.dataIndex<_)return d[f.dataIndex]}return""},afterTitle:Ar,beforeBody:Ar,beforeLabel:Ar,label(m){if(this&&this.options&&"dataset"===this.options.mode)return m.label+": "+m.formattedValue||m.formattedValue;let f=m.dataset.label||"";f&&(f+=": ");const d=m.formattedValue;return Ai(d)||(f+=d),f},labelColor(m){const d=m.chart.getDatasetMeta(m.datasetIndex).controller.getStyle(m.dataIndex);return{borderColor:d.borderColor,backgroundColor:d.backgroundColor,borderWidth:d.borderWidth,borderDash:d.borderDash,borderDashOffset:d.borderDashOffset,borderRadius:0}},labelTextColor(){return this.options.bodyColor},labelPointStyle(m){const d=m.chart.getDatasetMeta(m.datasetIndex).controller.getStyle(m.dataIndex);return{pointStyle:d.pointStyle,rotation:d.rotation}},afterLabel:Ar,afterBody:Ar,beforeFooter:Ar,footer:Ar,afterFooter:Ar};function Le(m,f,d,_){const v=m[f].call(d,_);return typeof v>"u"?qe[f].call(d,_):v}let Ye=(()=>class m extends xs{static positioners=N;constructor(d){super(),this.opacity=0,this._active=[],this._eventPosition=void 0,this._size=void 0,this._cachedAnimations=void 0,this._tooltipItems=[],this.$animations=void 0,this.$context=void 0,this.chart=d.chart,this.options=d.options,this.dataPoints=void 0,this.title=void 0,this.beforeBody=void 0,this.body=void 0,this.afterBody=void 0,this.footer=void 0,this.xAlign=void 0,this.yAlign=void 0,this.x=void 0,this.y=void 0,this.height=void 0,this.width=void 0,this.caretX=void 0,this.caretY=void 0,this.labelColors=void 0,this.labelPointStyles=void 0,this.labelTextColors=void 0}initialize(d){this.options=d,this._cachedAnimations=void 0,this.$context=void 0}_resolveAnimations(){const d=this._cachedAnimations;if(d)return d;const _=this.chart,v=this.options.setContext(this.getContext()),I=v.enabled&&_.options.animation&&v.animations,z=new Ao(this.chart,I);return I._cacheable&&(this._cachedAnimations=Object.freeze(z)),z}getContext(){return this.$context||(this.$context=function be(m,f,d){return Rn(m,{tooltip:f,tooltipItems:d,type:"tooltip"})}(this.chart.getContext(),this,this._tooltipItems))}getTitle(d,_){const{callbacks:v}=_,I=Le(v,"beforeTitle",this,d),z=Le(v,"title",this,d),R=Le(v,"afterTitle",this,d);let F=[];return F=V(F,j(I)),F=V(F,j(z)),F=V(F,j(R)),F}getBeforeBody(d,_){return de(Le(_.callbacks,"beforeBody",this,d))}getBody(d,_){const{callbacks:v}=_,I=[];return Ki(d,z=>{const R={before:[],lines:[],after:[]},F=Ee(v,z);V(R.before,j(Le(F,"beforeLabel",this,z))),V(R.lines,Le(F,"label",this,z)),V(R.after,j(Le(F,"afterLabel",this,z))),I.push(R)}),I}getAfterBody(d,_){return de(Le(_.callbacks,"afterBody",this,d))}getFooter(d,_){const{callbacks:v}=_,I=Le(v,"beforeFooter",this,d),z=Le(v,"footer",this,d),R=Le(v,"afterFooter",this,d);let F=[];return F=V(F,j(I)),F=V(F,j(z)),F=V(F,j(R)),F}_createItems(d){const _=this._active,v=this.chart.data,I=[],z=[],R=[];let H,K,F=[];for(H=0,K=_.length;H<K;++H)F.push(Y(this.chart,_[H]));return d.filter&&(F=F.filter((ie,ue,xe)=>d.filter(ie,ue,xe,v))),d.itemSort&&(F=F.sort((ie,ue)=>d.itemSort(ie,ue,v))),Ki(F,ie=>{const ue=Ee(d.callbacks,ie);I.push(Le(ue,"labelColor",this,ie)),z.push(Le(ue,"labelPointStyle",this,ie)),R.push(Le(ue,"labelTextColor",this,ie))}),this.labelColors=I,this.labelPointStyles=z,this.labelTextColors=R,this.dataPoints=F,F}update(d,_){const v=this.options.setContext(this.getContext()),I=this._active;let z,R=[];if(I.length){const F=N[v.position].call(this,I,this._eventPosition);R=this._createItems(v),this.title=this.getTitle(R,v),this.beforeBody=this.getBeforeBody(R,v),this.body=this.getBody(R,v),this.afterBody=this.getAfterBody(R,v),this.footer=this.getFooter(R,v);const H=this._size=Z(this,v),K=Object.assign({},F,H),ie=he(this.chart,v,K),ue=pe(v,K,ie,this.chart);this.xAlign=ie.xAlign,this.yAlign=ie.yAlign,z={opacity:1,x:ue.x,y:ue.y,width:H.width,height:H.height,caretX:F.x,caretY:F.y}}else 0!==this.opacity&&(z={opacity:0});this._tooltipItems=R,this.$context=void 0,z&&this._resolveAnimations().update(this,z),d&&v.external&&v.external.call(this,{chart:this.chart,tooltip:this,replay:_})}drawCaret(d,_,v,I){const z=this.getCaretPosition(d,v,I);_.lineTo(z.x1,z.y1),_.lineTo(z.x2,z.y2),_.lineTo(z.x3,z.y3)}getCaretPosition(d,_,v){const{xAlign:I,yAlign:z}=this,{caretSize:R,cornerRadius:F}=v,{topLeft:H,topRight:K,bottomLeft:ie,bottomRight:ue}=hr(F),{x:xe,y:Oe}=d,{width:Be,height:je}=_;let ht,lt,Et,Dt,xt,At;return"center"===z?(xt=Oe+je/2,"left"===I?(ht=xe,lt=ht-R,Dt=xt+R,At=xt-R):(ht=xe+Be,lt=ht+R,Dt=xt-R,At=xt+R),Et=ht):(lt="left"===I?xe+Math.max(H,ie)+R:"right"===I?xe+Be-Math.max(K,ue)-R:this.caretX,"top"===z?(Dt=Oe,xt=Dt-R,ht=lt-R,Et=lt+R):(Dt=Oe+je,xt=Dt+R,ht=lt+R,Et=lt-R),At=Dt),{x1:ht,x2:lt,x3:Et,y1:Dt,y2:xt,y3:At}}drawTitle(d,_,v){const I=this.title,z=I.length;let R,F,H;if(z){const K=Wa(v.rtl,this.x,this.width);for(d.x=_e(this,v.titleAlign,v),_.textAlign=K.textAlign(v.titleAlign),_.textBaseline="middle",R=mn(v.titleFont),F=v.titleSpacing,_.fillStyle=v.titleColor,_.font=R.string,H=0;H<z;++H)_.fillText(I[H],K.x(d.x),d.y+R.lineHeight/2),d.y+=R.lineHeight+F,H+1===z&&(d.y+=v.titleMarginBottom-F)}}_drawColorBox(d,_,v,I,z){const R=this.labelColors[v],F=this.labelPointStyles[v],{boxHeight:H,boxWidth:K}=z,ie=mn(z.bodyFont),ue=_e(this,"left",z),xe=I.x(ue),Be=_.y+(H<ie.lineHeight?(ie.lineHeight-H)/2:0);if(z.usePointStyle){const je={radius:Math.min(K,H)/2,pointStyle:F.pointStyle,rotation:F.rotation,borderWidth:1},ht=I.leftForLtr(xe,K)+K/2,lt=Be+H/2;d.strokeStyle=z.multiKeyBackground,d.fillStyle=z.multiKeyBackground,lr(d,je,ht,lt),d.strokeStyle=R.borderColor,d.fillStyle=R.backgroundColor,lr(d,je,ht,lt)}else{d.lineWidth=zi(R.borderWidth)?Math.max(...Object.values(R.borderWidth)):R.borderWidth||1,d.strokeStyle=R.borderColor,d.setLineDash(R.borderDash||[]),d.lineDashOffset=R.borderDashOffset||0;const je=I.leftForLtr(xe,K),ht=I.leftForLtr(I.xPlus(xe,1),K-2),lt=hr(R.borderRadius);Object.values(lt).some(Et=>0!==Et)?(d.beginPath(),d.fillStyle=z.multiKeyBackground,br(d,{x:je,y:Be,w:K,h:H,radius:lt}),d.fill(),d.stroke(),d.fillStyle=R.backgroundColor,d.beginPath(),br(d,{x:ht,y:Be+1,w:K-2,h:H-2,radius:lt}),d.fill()):(d.fillStyle=z.multiKeyBackground,d.fillRect(je,Be,K,H),d.strokeRect(je,Be,K,H),d.fillStyle=R.backgroundColor,d.fillRect(ht,Be+1,K-2,H-2))}d.fillStyle=this.labelTextColors[v]}drawBody(d,_,v){const{body:I}=this,{bodySpacing:z,bodyAlign:R,displayColors:F,boxHeight:H,boxWidth:K,boxPadding:ie}=v,ue=mn(v.bodyFont);let xe=ue.lineHeight,Oe=0;const Be=Wa(v.rtl,this.x,this.width),je=function(Bt){_.fillText(Bt,Be.x(d.x+Oe),d.y+xe/2),d.y+=xe+z},ht=Be.textAlign(R);let lt,Et,Dt,xt,At,Ht,Ot;for(_.textAlign=R,_.textBaseline="middle",_.font=ue.string,d.x=_e(this,ht,v),_.fillStyle=v.bodyColor,Ki(this.beforeBody,je),Oe=F&&"right"!==ht?"center"===R?K/2+ie:K+2+ie:0,xt=0,Ht=I.length;xt<Ht;++xt){for(lt=I[xt],Et=this.labelTextColors[xt],_.fillStyle=Et,Ki(lt.before,je),Dt=lt.lines,F&&Dt.length&&(this._drawColorBox(_,d,xt,Be,v),xe=Math.max(ue.lineHeight,H)),At=0,Ot=Dt.length;At<Ot;++At)je(Dt[At]),xe=ue.lineHeight;Ki(lt.after,je)}Oe=0,xe=ue.lineHeight,Ki(this.afterBody,je),d.y-=z}drawFooter(d,_,v){const I=this.footer,z=I.length;let R,F;if(z){const H=Wa(v.rtl,this.x,this.width);for(d.x=_e(this,v.footerAlign,v),d.y+=v.footerMarginTop,_.textAlign=H.textAlign(v.footerAlign),_.textBaseline="middle",R=mn(v.footerFont),_.fillStyle=v.footerColor,_.font=R.string,F=0;F<z;++F)_.fillText(I[F],H.x(d.x),d.y+R.lineHeight/2),d.y+=R.lineHeight+v.footerSpacing}}drawBackground(d,_,v,I){const{xAlign:z,yAlign:R}=this,{x:F,y:H}=d,{width:K,height:ie}=v,{topLeft:ue,topRight:xe,bottomLeft:Oe,bottomRight:Be}=hr(I.cornerRadius);_.fillStyle=I.backgroundColor,_.strokeStyle=I.borderColor,_.lineWidth=I.borderWidth,_.beginPath(),_.moveTo(F+ue,H),"top"===R&&this.drawCaret(d,_,v,I),_.lineTo(F+K-xe,H),_.quadraticCurveTo(F+K,H,F+K,H+xe),"center"===R&&"right"===z&&this.drawCaret(d,_,v,I),_.lineTo(F+K,H+ie-Be),_.quadraticCurveTo(F+K,H+ie,F+K-Be,H+ie),"bottom"===R&&this.drawCaret(d,_,v,I),_.lineTo(F+Oe,H+ie),_.quadraticCurveTo(F,H+ie,F,H+ie-Oe),"center"===R&&"left"===z&&this.drawCaret(d,_,v,I),_.lineTo(F,H+ue),_.quadraticCurveTo(F,H,F+ue,H),_.closePath(),_.fill(),I.borderWidth>0&&_.stroke()}_updateAnimationTarget(d){const _=this.chart,v=this.$animations,I=v&&v.x,z=v&&v.y;if(I||z){const R=N[d.position].call(this,this._active,this._eventPosition);if(!R)return;const F=this._size=Z(this,d),H=Object.assign({},R,this._size),K=he(_,d,H),ie=pe(d,H,K,_);(I._to!==ie.x||z._to!==ie.y)&&(this.xAlign=K.xAlign,this.yAlign=K.yAlign,this.width=F.width,this.height=F.height,this.caretX=R.x,this.caretY=R.y,this._resolveAnimations().update(this,ie))}}_willRender(){return!!this.opacity}draw(d){const _=this.options.setContext(this.getContext());let v=this.opacity;if(!v)return;this._updateAnimationTarget(_);const I={width:this.width,height:this.height},z={x:this.x,y:this.y};v=Math.abs(v)<.001?0:v;const R=sr(_.padding);_.enabled&&(this.title.length||this.beforeBody.length||this.body.length||this.afterBody.length||this.footer.length)&&(d.save(),d.globalAlpha=v,this.drawBackground(z,d,I,_),Lh(d,_.textDirection),z.y+=R.top,this.drawTitle(z,d,_),this.drawBody(z,d,_),this.drawFooter(z,d,_),Mo(d,_.textDirection),d.restore())}getActiveElements(){return this._active||[]}setActiveElements(d,_){const v=this._active,I=d.map(({datasetIndex:F,index:H})=>{const K=this.chart.getDatasetMeta(F);if(!K)throw new Error("Cannot find a dataset at index "+F);return{datasetIndex:F,element:K.data[H],index:H}}),z=!Zs(v,I),R=this._positionChanged(I,_);(z||R)&&(this._active=I,this._eventPosition=_,this._ignoreReplayEvents=!0,this.update(!0))}handleEvent(d,_,v=!0){if(_&&this._ignoreReplayEvents)return!1;this._ignoreReplayEvents=!1;const I=this.options,z=this._active||[],R=this._getActiveElements(d,z,_,v),F=this._positionChanged(R,d),H=_||!Zs(R,z)||F;return H&&(this._active=R,(I.enabled||I.external)&&(this._eventPosition={x:d.x,y:d.y},this.update(!0,_))),H}_getActiveElements(d,_,v,I){const z=this.options;if("mouseout"===d.type)return[];if(!I)return _.filter(F=>this.chart.data.datasets[F.datasetIndex]&&void 0!==this.chart.getDatasetMeta(F.datasetIndex).controller.getParsed(F.index));const R=this.chart.getElementsAtEventForMode(d,z.mode,z,v);return z.reverse&&R.reverse(),R}_positionChanged(d,_){const{caretX:v,caretY:I,options:z}=this,R=N[z.position].call(this,d,_);return!1!==R&&(v!==R.x||I!==R.y)}})();var Re=Object.freeze({__proto__:null,Colors:yu,Decimation:Uo,Filler:pd,Legend:y,SubTitle:k,Title:D,Tooltip:{id:"tooltip",_element:Ye,positioners:N,afterInit(m,f,d){d&&(m.tooltip=new Ye({chart:m,options:d}))},beforeUpdate(m,f,d){m.tooltip&&m.tooltip.initialize(d)},reset(m,f,d){m.tooltip&&m.tooltip.initialize(d)},afterDraw(m){const f=m.tooltip;if(f&&f._willRender()){const d={tooltip:f};if(!1===m.notifyPlugins("beforeTooltipDraw",{...d,cancelable:!0}))return;f.draw(m.ctx),m.notifyPlugins("afterTooltipDraw",d)}},afterEvent(m,f){m.tooltip&&m.tooltip.handleEvent(f.event,f.replay,f.inChartArea)&&(f.changed=!0)},defaults:{enabled:!0,external:null,position:"average",backgroundColor:"rgba(0,0,0,0.8)",titleColor:"#fff",titleFont:{weight:"bold"},titleSpacing:2,titleMarginBottom:6,titleAlign:"left",bodyColor:"#fff",bodySpacing:2,bodyFont:{},bodyAlign:"left",footerColor:"#fff",footerSpacing:2,footerMarginTop:6,footerFont:{weight:"bold"},footerAlign:"left",padding:6,caretPadding:2,caretSize:5,cornerRadius:6,boxHeight:(m,f)=>f.bodyFont.size,boxWidth:(m,f)=>f.bodyFont.size,multiKeyBackground:"#fff",displayColors:!0,boxPadding:0,borderColor:"rgba(0,0,0,0)",borderWidth:0,animation:{duration:400,easing:"easeOutQuart"},animations:{numbers:{type:"number",properties:["x","y","width","height","caretX","caretY"]},opacity:{easing:"linear",duration:200}},callbacks:qe},defaultRoutes:{bodyFont:"font",footerFont:"font",titleFont:"font"},descriptors:{_scriptable:m=>"filter"!==m&&"itemSort"!==m&&"external"!==m,_indexable:!1,callbacks:{_scriptable:!1,_indexable:!1},animation:{_fallback:!1},animations:{_fallback:"animation"}},additionalOptionScopes:["interaction"]}});function Je(m){const f=this.getLabels();return m>=0&&m<f.length?f[m]:m}let We=(()=>class m extends Lo{static id="category";static defaults={ticks:{callback:Je}};constructor(d){super(d),this._startValue=void 0,this._valueRange=0,this._addedLabels=[]}init(d){const _=this._addedLabels;if(_.length){const v=this.getLabels();for(const{index:I,label:z}of _)v[I]===z&&v.splice(I,1);this._addedLabels=[]}super.init(d)}parse(d,_){if(Ai(d))return null;const v=this.getLabels();return((m,f)=>null===m?null:Gt(Math.round(m),0,f))(_=isFinite(_)&&v[_]===d?_:function it(m,f,d,_){const v=m.indexOf(f);return-1===v?((m,f,d,_)=>("string"==typeof f?(d=m.push(f)-1,_.unshift({index:d,label:f})):isNaN(f)&&(d=null),d))(m,f,d,_):v!==m.lastIndexOf(f)?d:v}(v,d,Ti(_,d),this._addedLabels),v.length-1)}determineDataLimits(){const{minDefined:d,maxDefined:_}=this.getUserBounds();let{min:v,max:I}=this.getMinMax(!0);"ticks"===this.options.bounds&&(d||(v=0),_||(I=this.getLabels().length-1)),this.min=v,this.max=I}buildTicks(){const d=this.min,_=this.max,v=this.options.offset,I=[];let z=this.getLabels();z=0===d&&_===z.length-1?z:z.slice(d,_+1),this._valueRange=Math.max(z.length-(v?0:1),1),this._startValue=this.min-(v?.5:0);for(let R=d;R<=_;R++)I.push({value:R});return I}getLabelForValue(d){return Je.call(this,d)}configure(){super.configure(),this.isHorizontal()||(this._reversePixels=!this._reversePixels)}getPixelForValue(d){return"number"!=typeof d&&(d=this.parse(d)),null===d?NaN:this.getPixelForDecimal((d-this._startValue)/this._valueRange)}getPixelForTick(d){const _=this.ticks;return d<0||d>_.length-1?null:this.getPixelForValue(_[d].value)}getValueForPixel(d){return Math.round(this._startValue+this.getDecimalForPixel(d)*this._valueRange)}getBasePixel(){return this.bottom}})();function et(m,f,{horizontal:d,minRotation:_}){const v=ot(_),I=(d?Math.sin(v):Math.cos(v))||.001;return Math.min(f/I,.75*f*(""+m).length)}class Ke extends Lo{constructor(f){super(f),this.start=void 0,this.end=void 0,this._startValue=void 0,this._endValue=void 0,this._valueRange=0}parse(f,d){return Ai(f)||("number"==typeof f||f instanceof Number)&&!isFinite(+f)?null:+f}handleTickRangeOptions(){const{beginAtZero:f}=this.options,{minDefined:d,maxDefined:_}=this.getUserBounds();let{min:v,max:I}=this;const z=F=>v=d?v:F,R=F=>I=_?I:F;if(f){const F=me(v),H=me(I);F<0&&H<0?R(0):F>0&&H>0&&z(0)}if(v===I){let F=0===I?1:Math.abs(.05*I);R(I+F),f||z(v-F)}this.min=v,this.max=I}getTickLimit(){const f=this.options.ticks;let v,{maxTicksLimit:d,stepSize:_}=f;return _?(v=Math.ceil(this.max/_)-Math.floor(this.min/_)+1,v>1e3&&(console.warn(`scales.${this.id}.ticks.stepSize: ${_} would result generating up to ${v} ticks. Limiting to 1000.`),v=1e3)):(v=this.computeTickLimit(),d=d||11),d&&(v=Math.min(d,v)),v}computeTickLimit(){return Number.POSITIVE_INFINITY}buildTicks(){const f=this.options,d=f.ticks;let _=this.getTickLimit();_=Math.max(2,_);const z=function ut(m,f){const d=[],{bounds:v,step:I,min:z,max:R,precision:F,count:H,maxTicks:K,maxDigits:ie,includeBounds:ue}=m,xe=I||1,Oe=K-1,{min:Be,max:je}=f,ht=!Ai(z),lt=!Ai(R),Et=!Ai(H),Dt=(je-Be)/(ie+1);let At,Ht,Ot,Bt,xt=ze((je-Be)/Oe/xe)*xe;if(xt<1e-14&&!ht&&!lt)return[{value:Be},{value:je}];Bt=Math.ceil(je/xt)-Math.floor(Be/xt),Bt>Oe&&(xt=ze(Bt*xt/Oe/xe)*xe),Ai(F)||(At=Math.pow(10,F),xt=Math.ceil(xt*At)/At),"ticks"===v?(Ht=Math.floor(Be/xt)*xt,Ot=Math.ceil(je/xt)*xt):(Ht=Be,Ot=je),ht&&lt&&I&&function Ue(m,f){const d=Math.round(m);return d-f<=m&&d+f>=m}((R-z)/I,xt/1e3)?(Bt=Math.round(Math.min((R-z)/xt,K)),xt=(R-z)/Bt,Ht=z,Ot=R):Et?(Ht=ht?z:Ht,Ot=lt?R:Ot,Bt=H-1,xt=(Ot-Ht)/Bt):(Bt=(Ot-Ht)/xt,Bt=Te(Bt,Math.round(Bt),xt/1e3)?Math.round(Bt):Math.ceil(Bt));const Fi=Math.max(Rt(xt),Rt(Ht));At=Math.pow(10,Ai(F)?Fi:F),Ht=Math.round(Ht*At)/At,Ot=Math.round(Ot*At)/At;let Vi=0;for(ht&&(ue&&Ht!==z?(d.push({value:z}),Ht<z&&Vi++,Te(Math.round((Ht+Vi*xt)*At)/At,z,et(z,Dt,m))&&Vi++):Ht<z&&Vi++);Vi<Bt;++Vi){const Wi=Math.round((Ht+Vi*xt)*At)/At;if(lt&&Wi>R)break;d.push({value:Wi})}return lt&&ue&&Ot!==R?d.length&&Te(d[d.length-1].value,R,et(R,Dt,m))?d[d.length-1].value=R:d.push({value:R}):(!lt||Ot===R)&&d.push({value:Ot}),d}({maxTicks:_,bounds:f.bounds,min:f.min,max:f.max,precision:d.precision,step:d.stepSize,count:d.count,maxDigits:this._maxDigits(),horizontal:this.isHorizontal(),minRotation:d.minRotation||0,includeBounds:!1!==d.includeBounds},this._range||this);return"ticks"===f.bounds&&Qe(z,this,"value"),f.reverse?(z.reverse(),this.start=this.max,this.end=this.min):(this.start=this.min,this.end=this.max),z}configure(){const f=this.ticks;let d=this.min,_=this.max;if(super.configure(),this.options.offset&&f.length){const v=(_-d)/Math.max(f.length-1,1)/2;d-=v,_+=v}this._startValue=d,this._endValue=_,this._valueRange=_-d}getLabelForValue(f){return xo(f,this.chart.options.locale,this.options.ticks.format)}}const ct=m=>Math.floor(fe(m)),_t=(m,f)=>Math.pow(10,ct(m)+f);function Tt(m){return m/Math.pow(10,ct(m))==1}function jt(m,f,d){const _=Math.pow(10,d),v=Math.floor(m/_);return Math.ceil(f/_)-v}function di(m){const f=m.ticks;if(f.display&&m.display){const d=sr(f.backdropPadding);return Ti(f.font&&f.font.size,fn.font.size)+d.height}return 0}function Ni(m,f,d){return d=Yi(d)?d:[d],{w:Kn(m,f.string,d),h:d.length*f.lineHeight}}function hn(m,f,d,_,v){return m===_||m===v?{start:f-d/2,end:f+d/2}:m<_||m>v?{start:f-d,end:f}:{start:f,end:f+d}}function Kt(m,f,d,_,v){const I=Math.abs(Math.sin(d)),z=Math.abs(Math.cos(d));let R=0,F=0;_.start<f.l?(R=(f.l-_.start)/I,m.l=Math.min(m.l,f.l-R)):_.end>f.r&&(R=(_.end-f.r)/I,m.r=Math.max(m.r,f.r+R)),v.start<f.t?(F=(f.t-v.start)/z,m.t=Math.min(m.t,f.t-F)):v.end>f.b&&(F=(v.end-f.b)/z,m.b=Math.max(m.b,f.b+F))}function Ei(m,f,d){const _=m.drawingArea,{extra:v,additionalAngle:I,padding:z,size:R}=d,F=m.getPointPosition(f,_+v+z,I),H=Math.round(dt(ei(F.angle+$))),K=function un(m,f,d){return 90===d||270===d?m-=f/2:(d>270||d<90)&&(m-=f),m}(F.y,R.h,H),ie=function Di(m){return 0===m||180===m?"center":m<180?"left":"right"}(H),ue=function ki(m,f,d){return"right"===d?m-=f:"center"===d&&(m-=f/2),m}(F.x,R.w,ie);return{visible:!0,x:F.x,y:K,textAlign:ie,left:ue,top:K,right:ue+R.w,bottom:K+R.h}}function Pt(m,f){if(!f)return!0;const{left:d,top:_,right:v,bottom:I}=m;return!(Wr({x:d,y:_},f)||Wr({x:d,y:I},f)||Wr({x:v,y:_},f)||Wr({x:v,y:I},f))}function jn(m,f,d){const{left:_,top:v,right:I,bottom:z}=d,{backdropColor:R}=f;if(!Ai(R)){const F=hr(f.borderRadius),H=sr(f.backdropPadding);m.fillStyle=R;const K=_-H.left,ie=v-H.top,ue=I-_+H.width,xe=z-v+H.height;Object.values(F).some(Oe=>0!==Oe)?(m.beginPath(),br(m,{x:K,y:ie,w:ue,h:xe,radius:F}),m.fill()):m.fillRect(K,ie,ue,xe)}}function Mn(m,f,d,_){const{ctx:v}=m;if(d)v.arc(m.xCenter,m.yCenter,f,0,ln);else{let I=m.getPointPosition(0,f);v.moveTo(I.x,I.y);for(let z=1;z<_;z++)I=m.getPointPosition(z,f),v.lineTo(I.x,I.y)}}const ji={millisecond:{common:!0,size:1,steps:1e3},second:{common:!0,size:1e3,steps:60},minute:{common:!0,size:6e4,steps:60},hour:{common:!0,size:36e5,steps:24},day:{common:!0,size:864e5,steps:30},week:{common:!1,size:6048e5,steps:4},month:{common:!0,size:2628e6,steps:12},quarter:{common:!1,size:7884e6,steps:4},year:{common:!0,size:3154e7}},vi=Object.keys(ji);function bi(m,f){return m-f}function wn(m,f){if(Ai(f))return null;const d=m._adapter,{parser:_,round:v,isoWeekday:I}=m._parseOpts;let z=f;return"function"==typeof _&&(z=_(z)),Hi(z)||(z="string"==typeof _?d.parse(z,_):d.parse(z)),null===z?null:(v&&(z="week"!==v||!Fe(I)&&!0!==I?d.startOf(z,v):d.startOf(z,"isoWeek",I)),+z)}function kn(m,f,d,_){const v=vi.length;for(let I=vi.indexOf(m);I<v-1;++I){const z=ji[vi[I]];if(z.common&&Math.ceil((d-f)/((z.steps?z.steps:Number.MAX_SAFE_INTEGER)*z.size))<=_)return vi[I]}return vi[v-1]}function es(m,f,d){if(d){if(d.length){const{lo:_,hi:v}=yn(d,f);m[d[_]>=f?d[_]:d[v]]=!0}}else m[f]=!0}function Tr(m,f,d){const _=[],v={},I=f.length;let z,R;for(z=0;z<I;++z)R=f[z],v[R]=z,_.push({value:R,major:!1});return 0!==I&&d?function Ur(m,f,d,_){const v=m._adapter,I=+v.startOf(f[0].value,_),z=f[f.length-1].value;let R,F;for(R=I;R<=z;R=+v.add(R,1,_))F=d[R],F>=0&&(f[F].major=!0);return f}(m,_,v,d):_}let hs=(()=>class m extends Lo{static id="time";static defaults={bounds:"data",adapters:{},time:{parser:!1,unit:!1,round:!1,isoWeekday:!1,minUnit:"millisecond",displayFormats:{}},ticks:{source:"auto",callback:!1,major:{enabled:!1}}};constructor(d){super(d),this._cache={data:[],labels:[],all:[]},this._unit="day",this._majorUnit=void 0,this._offsets={},this._normalized=!1,this._parseOpts=void 0}init(d,_={}){const v=d.time||(d.time={}),I=this._adapter=new Zh__date(d.adapters.date);I.init(_),mo(v.displayFormats,I.formats()),this._parseOpts={parser:v.parser,round:v.round,isoWeekday:v.isoWeekday},super.init(d),this._normalized=_.normalized}parse(d,_){return void 0===d?null:wn(this,d)}beforeLayout(){super.beforeLayout(),this._cache={data:[],labels:[],all:[]}}determineDataLimits(){const d=this.options,_=this._adapter,v=d.time.unit||"day";let{min:I,max:z,minDefined:R,maxDefined:F}=this.getUserBounds();function H(K){!R&&!isNaN(K.min)&&(I=Math.min(I,K.min)),!F&&!isNaN(K.max)&&(z=Math.max(z,K.max))}(!R||!F)&&(H(this._getLabelBounds()),("ticks"!==d.bounds||"labels"!==d.ticks.source)&&H(this.getMinMax(!1))),I=Hi(I)&&!isNaN(I)?I:+_.startOf(Date.now(),v),z=Hi(z)&&!isNaN(z)?z:+_.endOf(Date.now(),v)+1,this.min=Math.min(I,z-1),this.max=Math.max(I+1,z)}_getLabelBounds(){const d=this.getLabelTimestamps();let _=Number.POSITIVE_INFINITY,v=Number.NEGATIVE_INFINITY;return d.length&&(_=d[0],v=d[d.length-1]),{min:_,max:v}}buildTicks(){const d=this.options,_=d.time,v=d.ticks,I="labels"===v.source?this.getLabelTimestamps():this._generate();"ticks"===d.bounds&&I.length&&(this.min=this._userMin||I[0],this.max=this._userMax||I[I.length-1]);const z=this.min,F=function Nn(m,f,d){let _=0,v=m.length;for(;_<v&&m[_]<f;)_++;for(;v>_&&m[v-1]>d;)v--;return _>0||v<m.length?m.slice(_,v):m}(I,z,this.max);return this._unit=_.unit||(v.autoSkip?kn(_.minUnit,this.min,this.max,this._getLabelCapacity(z)):function Xi(m,f,d,_,v){for(let I=vi.length-1;I>=vi.indexOf(d);I--){const z=vi[I];if(ji[z].common&&m._adapter.diff(v,_,z)>=f-1)return z}return vi[d?vi.indexOf(d):0]}(this,F.length,_.minUnit,this.min,this.max)),this._majorUnit=v.major.enabled&&"year"!==this._unit?function _r(m){for(let f=vi.indexOf(m)+1,d=vi.length;f<d;++f)if(ji[vi[f]].common)return vi[f]}(this._unit):void 0,this.initOffsets(I),d.reverse&&F.reverse(),Tr(this,F,this._majorUnit)}afterAutoSkip(){this.options.offsetAfterAutoskip&&this.initOffsets(this.ticks.map(d=>+d.value))}initOffsets(d=[]){let I,z,_=0,v=0;this.options.offset&&d.length&&(I=this.getDecimalForValue(d[0]),_=1===d.length?1-I:(this.getDecimalForValue(d[1])-I)/2,z=this.getDecimalForValue(d[d.length-1]),v=1===d.length?z:(z-this.getDecimalForValue(d[d.length-2]))/2);const R=d.length<3?.5:.25;_=Gt(_,0,R),v=Gt(v,0,R),this._offsets={start:_,end:v,factor:1/(_+1+v)}}_generate(){const d=this._adapter,_=this.min,v=this.max,I=this.options,z=I.time,R=z.unit||kn(z.minUnit,_,v,this._getLabelCapacity(_)),F=Ti(I.ticks.stepSize,1),H="week"===R&&z.isoWeekday,K=Fe(H)||!0===H,ie={};let xe,Oe,ue=_;if(K&&(ue=+d.startOf(ue,"isoWeek",H)),ue=+d.startOf(ue,K?"day":R),d.diff(v,_,R)>1e5*F)throw new Error(_+" and "+v+" are too far apart with stepSize of "+F+" "+R);const Be="data"===I.ticks.source&&this.getDataTimestamps();for(xe=ue,Oe=0;xe<v;xe=+d.add(xe,F,R),Oe++)es(ie,xe,Be);return(xe===v||"ticks"===I.bounds||1===Oe)&&es(ie,xe,Be),Object.keys(ie).sort(bi).map(je=>+je)}getLabelForValue(d){const v=this.options.time;return this._adapter.format(d,v.tooltipFormat?v.tooltipFormat:v.displayFormats.datetime)}format(d,_){return this._adapter.format(d,_||this.options.time.displayFormats[this._unit])}_tickFormatFunction(d,_,v,I){const z=this.options,R=z.ticks.callback;if(R)return Bi(R,[d,_,v],this);const F=z.time.displayFormats,H=this._unit,K=this._majorUnit,ue=K&&F[K],xe=v[_];return this._adapter.format(d,I||(K&&ue&&xe&&xe.major?ue:H&&F[H]))}generateTickLabels(d){let _,v,I;for(_=0,v=d.length;_<v;++_)I=d[_],I.label=this._tickFormatFunction(I.value,_,d)}getDecimalForValue(d){return null===d?NaN:(d-this.min)/(this.max-this.min)}getPixelForValue(d){const _=this._offsets,v=this.getDecimalForValue(d);return this.getPixelForDecimal((_.start+v)*_.factor)}getValueForPixel(d){const _=this._offsets,v=this.getDecimalForPixel(d)/_.factor-_.end;return this.min+v*(this.max-this.min)}_getLabelSize(d){const _=this.options.ticks,v=this.ctx.measureText(d).width,I=ot(this.isHorizontal()?_.maxRotation:_.minRotation),z=Math.cos(I),R=Math.sin(I),F=this._resolveTickFontOptions(0).size;return{w:v*z+F*R,h:v*R+F*z}}_getLabelCapacity(d){const _=this.options.time,v=_.displayFormats,I=v[_.unit]||v.millisecond,z=this._tickFormatFunction(d,0,Tr(this,[d],this._majorUnit),I),R=this._getLabelSize(z),F=Math.floor(this.isHorizontal()?this.width/R.w:this.height/R.h)-1;return F>0?F:1}getDataTimestamps(){let _,v,d=this._cache.data||[];if(d.length)return d;const I=this.getMatchingVisibleMetas();if(this._normalized&&I.length)return this._cache.data=I[0].controller.getAllParsedValues(this);for(_=0,v=I.length;_<v;++_)d=d.concat(I[_].controller.getAllParsedValues(this));return this._cache.data=this.normalize(d)}getLabelTimestamps(){const d=this._cache.labels||[];let _,v;if(d.length)return d;const I=this.getLabels();for(_=0,v=I.length;_<v;++_)d.push(wn(this,I[_]));return this._cache.labels=this._normalized?d:this.normalize(d)}normalize(d){return Ua(d.sort(bi))}})();function Dr(m,f,d){let I,z,R,F,_=0,v=m.length-1;d?(f>=m[_].pos&&f<=m[v].pos&&({lo:_,hi:v}=ir(m,"pos",f)),({pos:I,time:R}=m[_]),({pos:z,time:F}=m[v])):(f>=m[_].time&&f<=m[v].time&&({lo:_,hi:v}=ir(m,"time",f)),({time:I,pos:R}=m[_]),({time:z,pos:F}=m[v]));const H=z-I;return H?R+(F-R)*(f-I)/H:R}const Ta=["chartCanvas"];rc.register($h,ih,Re,Object.freeze({__proto__:null,CategoryScale:We,LinearScale:class rt extends Ke{static id="linear";static defaults={ticks:{callback:Cs.formatters.numeric}};determineDataLimits(){const{min:f,max:d}=this.getMinMax(!0);this.min=Hi(f)?f:0,this.max=Hi(d)?d:1,this.handleTickRangeOptions()}computeTickLimit(){const f=this.isHorizontal(),d=f?this.width:this.height,_=ot(this.options.ticks.minRotation),v=(f?Math.sin(_):Math.cos(_))||.001,I=this._resolveTickFontOptions(0);return Math.ceil(d/Math.min(40,I.lineHeight/v))}getPixelForValue(f){return null===f?NaN:this.getPixelForDecimal((f-this._startValue)/this._valueRange)}getValueForPixel(f){return this._startValue+this.getDecimalForPixel(f)*this._valueRange}},LogarithmicScale:class Zt extends Lo{static id="logarithmic";static defaults={ticks:{callback:Cs.formatters.logarithmic,major:{enabled:!0}}};constructor(f){super(f),this.start=void 0,this.end=void 0,this._startValue=void 0,this._valueRange=0}parse(f,d){const _=Ke.prototype.parse.apply(this,[f,d]);if(0!==_)return Hi(_)&&_>0?_:null;this._zero=!0}determineDataLimits(){const{min:f,max:d}=this.getMinMax(!0);this.min=Hi(f)?Math.max(0,f):null,this.max=Hi(d)?Math.max(0,d):null,this.options.beginAtZero&&(this._zero=!0),this._zero&&this.min!==this._suggestedMin&&!Hi(this._userMin)&&(this.min=f===_t(this.min,0)?_t(this.min,-1):_t(this.min,0)),this.handleTickRangeOptions()}handleTickRangeOptions(){const{minDefined:f,maxDefined:d}=this.getUserBounds();let _=this.min,v=this.max;const I=R=>_=f?_:R,z=R=>v=d?v:R;_===v&&(_<=0?(I(1),z(10)):(I(_t(_,-1)),z(_t(v,1)))),_<=0&&I(_t(v,-1)),v<=0&&z(_t(_,1)),this.min=_,this.max=v}buildTicks(){const f=this.options,_=function kt(m,{min:f,max:d}){f=Bn(m.min,f);const _=[],v=ct(f);let I=function Lt(m,f){let _=ct(f-m);for(;jt(m,f,_)>10;)_++;for(;jt(m,f,_)<10;)_--;return Math.min(_,ct(m))}(f,d),z=I<0?Math.pow(10,Math.abs(I)):1;const R=Math.pow(10,I),F=v>I?Math.pow(10,v):0,H=Math.round((f-F)*z)/z,K=Math.floor((f-F)/R/10)*R*10;let ie=Math.floor((H-K)/Math.pow(10,I)),ue=Bn(m.min,Math.round((F+K+ie*Math.pow(10,I))*z)/z);for(;ue<d;)_.push({value:ue,major:Tt(ue),significand:ie}),ie>=10?ie=ie<15?15:20:ie++,ie>=20&&(I++,ie=2,z=I>=0?1:z),ue=Math.round((F+K+ie*Math.pow(10,I))*z)/z;const xe=Bn(m.max,ue);return _.push({value:xe,major:Tt(xe),significand:ie}),_}({min:this._userMin,max:this._userMax},this);return"ticks"===f.bounds&&Qe(_,this,"value"),f.reverse?(_.reverse(),this.start=this.max,this.end=this.min):(this.start=this.min,this.end=this.max),_}getLabelForValue(f){return void 0===f?"0":xo(f,this.chart.options.locale,this.options.ticks.format)}configure(){const f=this.min;super.configure(),this._startValue=fe(f),this._valueRange=fe(this.max)-fe(f)}getPixelForValue(f){return(void 0===f||0===f)&&(f=this.min),null===f||isNaN(f)?NaN:this.getPixelForDecimal(f===this.min?0:(fe(f)-this._startValue)/this._valueRange)}getValueForPixel(f){const d=this.getDecimalForPixel(f);return Math.pow(10,this._startValue+d*this._valueRange)}},RadialLinearScale:class dn extends Ke{static id="radialLinear";static defaults={display:!0,animate:!0,position:"chartArea",angleLines:{display:!0,lineWidth:1,borderDash:[],borderDashOffset:0},grid:{circular:!1},startAngle:0,ticks:{showLabelBackdrop:!0,callback:Cs.formatters.numeric},pointLabels:{backdropColor:void 0,backdropPadding:2,display:!0,font:{size:10},callback:f=>f,padding:5,centerPointLabels:!1}};static defaultRoutes={"angleLines.color":"borderColor","pointLabels.color":"color","ticks.color":"color"};static descriptors={angleLines:{_fallback:"grid"}};constructor(f){super(f),this.xCenter=void 0,this.yCenter=void 0,this.drawingArea=void 0,this._pointLabels=[],this._pointLabelItems=[]}setDimensions(){const f=this._padding=sr(di(this.options)/2),d=this.width=this.maxWidth-f.width,_=this.height=this.maxHeight-f.height;this.xCenter=Math.floor(this.left+d/2+f.left),this.yCenter=Math.floor(this.top+_/2+f.top),this.drawingArea=Math.floor(Math.min(d,_)/2)}determineDataLimits(){const{min:f,max:d}=this.getMinMax(!1);this.min=Hi(f)&&!isNaN(f)?f:0,this.max=Hi(d)&&!isNaN(d)?d:0,this.handleTickRangeOptions()}computeTickLimit(){return Math.ceil(this.drawingArea/di(this.options))}generateTickLabels(f){Ke.prototype.generateTickLabels.call(this,f),this._pointLabels=this.getLabels().map((d,_)=>{const v=Bi(this.options.pointLabels.callback,[d,_],this);return v||0===v?v:""}).filter((d,_)=>this.chart.getDataVisibility(_))}fit(){const f=this.options;f.display&&f.pointLabels.display?function nn(m){const f={l:m.left+m._padding.left,r:m.right-m._padding.right,t:m.top+m._padding.top,b:m.bottom-m._padding.bottom},d=Object.assign({},f),_=[],v=[],I=m._pointLabels.length,z=m.options.pointLabels,R=z.centerPointLabels?pn/I:0;for(let F=0;F<I;F++){const H=z.setContext(m.getPointLabelContext(F));v[F]=H.padding;const K=m.getPointPosition(F,m.drawingArea+v[F],R),ie=mn(H.font),ue=Ni(m.ctx,ie,m._pointLabels[F]);_[F]=ue;const xe=ei(m.getIndexAngle(F)+R),Oe=Math.round(dt(xe));Kt(d,f,xe,hn(Oe,K.x,ue.w,0,180),hn(Oe,K.y,ue.h,90,270))}m.setCenterPoint(f.l-d.l,d.r-f.r,f.t-d.t,d.b-f.b),m._pointLabelItems=function pi(m,f,d){const _=[],v=m._pointLabels.length,I=m.options,{centerPointLabels:z,display:R}=I.pointLabels,F={extra:di(I)/2,additionalAngle:z?pn/v:0};let H;for(let K=0;K<v;K++){F.padding=d[K],F.size=f[K];const ie=Ei(m,K,F);_.push(ie),"auto"===R&&(ie.visible=Pt(ie,H),ie.visible&&(H=ie))}return _}(m,_,v)}(this):this.setCenterPoint(0,0,0,0)}setCenterPoint(f,d,_,v){this.xCenter+=Math.floor((f-d)/2),this.yCenter+=Math.floor((_-v)/2),this.drawingArea-=Math.min(this.drawingArea/2,Math.max(f,d,_,v))}getIndexAngle(f){return ei(f*(ln/(this._pointLabels.length||1))+ot(this.options.startAngle||0))}getDistanceFromCenterForValue(f){if(Ai(f))return NaN;const d=this.drawingArea/(this.max-this.min);return this.options.reverse?(this.max-f)*d:(f-this.min)*d}getValueForDistanceFromCenter(f){if(Ai(f))return NaN;const d=f/(this.drawingArea/(this.max-this.min));return this.options.reverse?this.max-d:this.min+d}getPointLabelContext(f){const d=this._pointLabels||[];if(f>=0&&f<d.length){const _=d[f];return function mr(m,f,d){return Rn(m,{label:d,index:f,type:"pointLabel"})}(this.getContext(),f,_)}}getPointPosition(f,d,_=0){const v=this.getIndexAngle(f)-$+_;return{x:Math.cos(v)*d+this.xCenter,y:Math.sin(v)*d+this.yCenter,angle:v}}getPointPositionForValue(f,d){return this.getPointPosition(f,this.getDistanceFromCenterForValue(d))}getBasePosition(f){return this.getPointPositionForValue(f||0,this.getBaseValue())}getPointLabelPosition(f){const{left:d,top:_,right:v,bottom:I}=this._pointLabelItems[f];return{left:d,top:_,right:v,bottom:I}}drawBackground(){const{backgroundColor:f,grid:{circular:d}}=this.options;if(f){const _=this.ctx;_.save(),_.beginPath(),Mn(this,this.getDistanceFromCenterForValue(this._endValue),d,this._pointLabels.length),_.closePath(),_.fillStyle=f,_.fill(),_.restore()}}drawGrid(){const f=this.ctx,d=this.options,{angleLines:_,grid:v,border:I}=d,z=this._pointLabels.length;let R,F,H;if(d.pointLabels.display&&function An(m,f){const{ctx:d,options:{pointLabels:_}}=m;for(let v=f-1;v>=0;v--){const I=m._pointLabelItems[v];if(!I.visible)continue;const z=_.setContext(m.getPointLabelContext(v));jn(d,z,I);const R=mn(z.font),{x:F,y:H,textAlign:K}=I;en(d,m._pointLabels[v],F,H+R.lineHeight/2,R,{color:z.color,textAlign:K,textBaseline:"middle"})}}(this,z),v.display&&this.ticks.forEach((K,ie)=>{if(0!==ie||0===ie&&this.min<0){F=this.getDistanceFromCenterForValue(K.value);const ue=this.getContext(ie),xe=v.setContext(ue),Oe=I.setContext(ue);!function Qr(m,f,d,_,v){const I=m.ctx,z=f.circular,{color:R,lineWidth:F}=f;!z&&!_||!R||!F||d<0||(I.save(),I.strokeStyle=R,I.lineWidth=F,I.setLineDash(v.dash||[]),I.lineDashOffset=v.dashOffset,I.beginPath(),Mn(m,d,z,_),I.closePath(),I.stroke(),I.restore())}(this,xe,F,z,Oe)}}),_.display){for(f.save(),R=z-1;R>=0;R--){const K=_.setContext(this.getPointLabelContext(R)),{color:ie,lineWidth:ue}=K;!ue||!ie||(f.lineWidth=ue,f.strokeStyle=ie,f.setLineDash(K.borderDash),f.lineDashOffset=K.borderDashOffset,F=this.getDistanceFromCenterForValue(d.reverse?this.min:this.max),H=this.getPointPosition(R,F),f.beginPath(),f.moveTo(this.xCenter,this.yCenter),f.lineTo(H.x,H.y),f.stroke())}f.restore()}}drawBorder(){}drawLabels(){const f=this.ctx,d=this.options,_=d.ticks;if(!_.display)return;const v=this.getIndexAngle(0);let I,z;f.save(),f.translate(this.xCenter,this.yCenter),f.rotate(v),f.textAlign="center",f.textBaseline="middle",this.ticks.forEach((R,F)=>{if(0===F&&this.min>=0&&!d.reverse)return;const H=_.setContext(this.getContext(F)),K=mn(H.font);if(I=this.getDistanceFromCenterForValue(this.ticks[F].value),H.showLabelBackdrop){f.font=K.string,z=f.measureText(R.label).width,f.fillStyle=H.backdropColor;const ie=sr(H.backdropPadding);f.fillRect(-z/2-ie.left,-I-K.size/2-ie.top,z+ie.width,K.size+ie.height)}en(f,R.label,0,-I,K,{color:H.color,strokeColor:H.textStrokeColor,strokeWidth:H.textStrokeWidth})}),f.restore()}drawTitle(){}},TimeScale:hs,TimeSeriesScale:class ts extends hs{static id="timeseries";static defaults=hs.defaults;constructor(f){super(f),this._table=[],this._minPos=void 0,this._tableRange=void 0}initOffsets(){const f=this._getTimestampsForTable(),d=this._table=this.buildLookupTable(f);this._minPos=Dr(d,this.min),this._tableRange=Dr(d,this.max)-this._minPos,super.initOffsets(f)}buildLookupTable(f){const{min:d,max:_}=this,v=[],I=[];let z,R,F,H,K;for(z=0,R=f.length;z<R;++z)H=f[z],H>=d&&H<=_&&v.push(H);if(v.length<2)return[{time:d,pos:0},{time:_,pos:1}];for(z=0,R=v.length;z<R;++z)K=v[z+1],F=v[z-1],H=v[z],Math.round((K+F)/2)!==H&&I.push({time:H,pos:z/(R-1)});return I}_generate(){const f=this.min,d=this.max;let _=super.getDataTimestamps();return(!_.includes(f)||!_.length)&&_.splice(0,0,f),(!_.includes(d)||1===_.length)&&_.push(d),_.sort((v,I)=>v-I)}_getTimestampsForTable(){let f=this._cache.all||[];if(f.length)return f;const d=this.getDataTimestamps(),_=this.getLabelTimestamps();return f=d.length&&_.length?this.normalize(d.concat(_)):d.length?d:_,f=this._cache.all=f,f}getDecimalForValue(f){return(Dr(this._table,f)-this._minPos)/this._tableRange}getValueForPixel(f){const d=this._offsets,_=this.getDecimalForPixel(f)/d.factor-d.end;return Dr(this._table,_*this._tableRange+this._minPos,!0)}}}));let xl=(()=>{class m{chart;carbonEmissions={};selectedTransport="";chartCanvas;ngAfterViewInit(){this.initializeChart()}ngOnChanges(d){d.carbonEmissions&&this.carbonEmissions&&this.updateChart()}getTransportColors(){return{car:"#FF6384",bike:"#36A2EB",walking:"#4BC0C0",train:"#FFCE56",bus:"#9966FF"}}getTransportEmojis(){return{car:"\u{1f697}",bike:"\u{1f6b4}",walking:"\u{1f6b6}",train:"\u{1f686}",bus:"\u{1f68c}"}}initializeChart(){if(!this.chartCanvas?.nativeElement)return;const _=["walking","bike","bus","train","car"].filter(R=>this.carbonEmissions.hasOwnProperty(R)),v=_.map(R=>this.carbonEmissions[R]||0),I=this.getTransportColors(),z=this.getTransportEmojis();this.chart=new rc(this.chartCanvas.nativeElement,{type:"bar",data:{labels:_.map(R=>`${z[R]||""} ${R.toUpperCase()}`),datasets:[{label:"Carbon Emissions (g CO\u2082)",data:v,backgroundColor:_.map(R=>I[R]||"#000000"),borderColor:"#000000",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,min:0,max:1200,ticks:{stepSize:200}}}}})}updateChart(){if(!this.chart)return;const _=["walking","bike","bus","train","car"].filter(R=>this.carbonEmissions.hasOwnProperty(R)),v=_.map(R=>this.carbonEmissions[R]||0),I=this.getTransportColors(),z=this.getTransportEmojis();this.chart.data.labels=_.map(R=>`${z[R]||""} ${R.toUpperCase()}`),this.chart.data.datasets[0].data=v,this.chart.data.datasets[0].backgroundColor=_.map(R=>I[R]||"#000000"),this.chart.update()}static \u0275fac=function(_){return new(_||m)};static \u0275cmp=vt.VBU({type:m,selectors:[["app-carbon-footprint"]],viewQuery:function(_,v){if(1&_&&vt.GBs(Ta,5),2&_){let I;vt.mGM(I=vt.lsd())&&(v.chartCanvas=I.first)}},inputs:{carbonEmissions:"carbonEmissions",selectedTransport:"selectedTransport"},features:[vt.OA$],decls:3,vars:0,consts:[["chartCanvas",""],[1,"chart-container","bg-white","p-4","rounded-lg"]],template:function(_,v){1&_&&(vt.j41(0,"div",1),vt.nrm(1,"canvas",null,0),vt.k0s())},styles:[".chart-container[_ngcontent-%COMP%]{width:100%;max-width:500px;height:350px;margin:auto}"]})}return m})();const rh=["mapContainer"],Su=()=>[1,2,3,4,5];function Ep(m,f){if(1&m){const d=vt.RV6();vt.j41(0,"button",13),vt.bIt("click",function(){const v=vt.eBV(d).$implicit,I=vt.XpG();return vt.Njj(I.dayChange.emit(v))}),vt.EFF(1),vt.k0s()}if(2&m){const d=f.$implicit;vt.R7$(),vt.SpI(" Day ",d," ")}}function gf(m,f){if(1&m){const d=vt.RV6();vt.j41(0,"label",12)(1,"input",14),vt.bIt("change",function(){const v=vt.eBV(d).$implicit,I=vt.XpG();return vt.Njj(I.toggleCategory(v))}),vt.k0s(),vt.j41(2,"span",15),vt.EFF(3),vt.k0s()()}if(2&m){const d=f.$implicit,_=vt.XpG();vt.R7$(),vt.Y8G("checked",_.selectedCategories.includes(d)),vt.R7$(2),vt.JRh(d)}}let yf=(()=>{class m{markers=[];route=null;selectedDay=1;selectedTransport="car";carbonEmissions={};selectedCategories=[];transportChange=new vt.bkB;dayChange=new vt.bkB;categoryFilterChange=new vt.bkB;mapContainer;map;currentMarkers=[];availableCategories=["park","restaurant","museum","landmark","viewpoint","market","shop"];ngAfterViewInit(){this.initializeMap()}ngOnChanges(d){this.map&&(d.markers||d.route)&&this.updateMap()}initializeMap(){this.map=new Qi.Map({container:this.mapContainer.nativeElement,style:"mapbox://styles/mapbox/streets-v12",center:[2.1734,41.3851],zoom:12,accessToken:"pk.eyJ1Ijoic2lsdml0dWk4IiwiYSI6ImNtN2IydzZtMzBkOTcyaXM4eW54ejkxdmgifQ.47utSyqhFdsuM3fPhhB--Q"}),this.map.on("load",()=>{this.updateMap()})}updateMap(){this.currentMarkers.forEach(_=>_.remove()),this.currentMarkers=[],this.markers.forEach(_=>{const v=new Qi.Marker({color:_.color}).setLngLat(_.coordinates).setPopup((new Qi.Popup).setHTML(`<h3>${_.label}</h3>`)).addTo(this.map);this.currentMarkers.push(v)});const d=this.markers.map(_=>_.coordinates);if(d.length>=2){this.map.getSource("route")&&(this.map.removeLayer("route"),this.map.removeSource("route")),this.map.addSource("route",{type:"geojson",data:{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:d}}}),this.map.addLayer({id:"route",type:"line",source:"route",layout:{"line-join":"round","line-cap":"round"},paint:{"line-color":"#1DB954","line-width":4}});const _=new Qi.LngLatBounds;d.forEach(v=>_.extend(v)),this.map.fitBounds(_,{padding:50,maxZoom:15})}else this.map.getSource("route")&&(this.map.removeLayer("route"),this.map.removeSource("route"))}toggleCategory(d){this.categoryFilterChange.emit(this.selectedCategories.includes(d)?this.selectedCategories.filter(_=>_!==d):[...this.selectedCategories,d])}static \u0275fac=function(_){return new(_||m)};static \u0275cmp=vt.VBU({type:m,selectors:[["app-map-view"]],viewQuery:function(_,v){if(1&_&&vt.GBs(rh,5),2&_){let I;vt.mGM(I=vt.lsd())&&(v.mapContainer=I.first)}},inputs:{markers:"markers",route:"route",selectedDay:"selectedDay",selectedTransport:"selectedTransport",carbonEmissions:"carbonEmissions",selectedCategories:"selectedCategories"},outputs:{transportChange:"transportChange",dayChange:"dayChange",categoryFilterChange:"categoryFilterChange"},features:[vt.OA$],decls:18,vars:3,consts:[["mapContainer",""],[1,"flex","flex-col","justify-center","items-center","w-full","p-4","sm:p-6","gap-6"],[1,"flex","justify-center","gap-2"],[1,"btn","btn-white","btn-sm","px-3","text-sm","font-semibold","rounded-md","shadow-sm"],[1,"flex","flex-col","lg:flex-row","w-full","lg:w-[80%]","gap-6"],[1,"relative","w-full","lg:w-1/2","h-[300px]","sm:h-[350px]","md:h-[450px]","lg:h-[500px]","border-8","border-blue-600","rounded-lg","shadow-xl"],["id","map",1,"w-full","h-full","rounded-lg"],[1,"flex","flex-col","justify-center","w-full","lg:w-1/2","h-auto","bg-white","bg-opacity-60","rounded-lg","p-6"],[1,"text-2xl","font-bold","text-center","mb-4","text-gray-800"],[3,"carbonEmissions","selectedTransport"],[1,"bg-white","bg-opacity-70","shadow-md","rounded-lg","p-5","w-full","lg:w-[80%]"],[1,"grid","grid-cols-2","sm:grid-cols-3","lg:grid-cols-4","gap-4","justify-center","text-lg"],[1,"flex","items-center","space-x-3"],[1,"btn","btn-white","btn-sm","px-3","text-sm","font-semibold","rounded-md","shadow-sm",3,"click"],["type","checkbox",1,"checkbox","checkbox-lg",3,"change","checked"],[1,"text-gray-700","font-semibold"]],template:function(_,v){1&_&&(vt.j41(0,"div",1)(1,"div",2),vt.Z7z(2,Ep,2,1,"button",3,vt.fX1),vt.k0s(),vt.j41(4,"div",4)(5,"div",5),vt.nrm(6,"div",6,0),vt.k0s(),vt.j41(8,"div",7)(9,"h2",8),vt.EFF(10,"Your Carbon Footprint"),vt.k0s(),vt.nrm(11,"app-carbon-footprint",9),vt.k0s()(),vt.j41(12,"div",10)(13,"h2",8),vt.EFF(14,"Filter Places"),vt.k0s(),vt.j41(15,"div",11),vt.Z7z(16,gf,4,2,"label",12,vt.fX1),vt.k0s()()()),2&_&&(vt.R7$(2),vt.Dyx(vt.lJ4(2,Su)),vt.R7$(9),vt.Y8G("carbonEmissions",v.carbonEmissions)("selectedTransport",v.selectedTransport),vt.R7$(5),vt.Dyx(v.availableCategories))},dependencies:[Mp.MD,xl],styles:[".body[_ngcontent-%COMP%]{background-color:#213c77}"]})}return m})();var Ap=us(5085);function Ip(m,f){if(1&m){const d=vt.RV6();vt.j41(0,"div",0)(1,"p",2),vt.EFF(2," \u{1f5fa} No trips found! \u{1f641} "),vt.nrm(3,"br"),vt.EFF(4," Start your journey by adding a trip. "),vt.k0s(),vt.j41(5,"button",3),vt.bIt("click",function(){vt.eBV(d);const v=vt.XpG();return vt.Njj(v.redirectToCalendar())}),vt.EFF(6," Go to calendar to add a trip! "),vt.k0s()()}}function Cp(m,f){if(1&m){const d=vt.RV6();vt.j41(0,"app-map-view",4),vt.bIt("transportChange",function(v){vt.eBV(d);const I=vt.XpG();return vt.Njj(I.selectTransport(v))})("dayChange",function(v){vt.eBV(d);const I=vt.XpG();return vt.Njj(I.changeDay(v))})("categoryFilterChange",function(v){vt.eBV(d);const I=vt.XpG();return vt.Njj(I.updateSelectedCategories(v))}),vt.k0s()}if(2&m){const d=vt.XpG();vt.Y8G("markers",d.markers())("route",d.route())("selectedDay",d.selectedDay())("selectedTransport",d.selectedTransport())("carbonEmissions",d.carbonEmissions())("selectedCategories",d.selectedCategories())}}let Pp=(()=>{class m{itineraryService=(0,vt.WQX)(o.F);router=(0,vt.WQX)(Ap.Ix);userService=(0,vt.WQX)(Cd.D);carbonFootprintService=(0,vt.WQX)(jr);itinerary=(0,vt.vPA)(null);markers=(0,vt.vPA)([]);route=(0,vt.vPA)(null);carbonEmissions=(0,vt.vPA)({});selectedDay=(0,vt.vPA)(1);selectedTransport=(0,vt.vPA)("car");selectedCategories=(0,vt.vPA)([]);redirectToCalendar(){this.router.navigate(["/calendar"])}ngOnInit(){this.loadItinerary()}loadItinerary(){this.userService.getUserSavedTrips().subscribe(d=>{d.length>0?(this.itinerary.set(d[0]),this.computeMapData()):this.itinerary.set(null)},d=>console.error("Error getting user saved trips:",d))}computeMapData(){if(!this.itinerary())return;const d=this.itinerary()?.days.find(v=>v.day===this.selectedDay());if(!d)return;let _=[...d.activities].filter(Boolean);this.selectedCategories().length>0&&(_=_.filter(v=>this.selectedCategories().includes(v.category))),this.markers.set(_.map(v=>({coordinates:[v.coordinates.lng,v.coordinates.lat],label:v.name,color:"green"}))),this.route.set(_.length>=2?{coordinates:_.map(v=>[v.coordinates.lng,v.coordinates.lat])}:null),this.loadCarbonEmissions()}loadCarbonEmissions(){if(!this.itinerary())return;const d=this.itinerary()?.city??"",_=this.selectedDay(),v=["car","train","bus","bike","walking"],I={};let z=0;v.forEach(R=>{this.carbonFootprintService.getEmissions(d,_,R).subscribe({next:F=>{I[R]=F.carbonEmission,z++,z===v.length&&this.carbonEmissions.set(I)},error:F=>{console.error(`Error al obtener emisiones para ${R}:`,F),z++,z===v.length&&this.carbonEmissions.set(I)}})})}selectTransport(d){this.selectedTransport.set(d),this.loadCarbonEmissions()}changeDay(d){this.selectedDay.set(d),this.computeMapData()}updateSelectedCategories(d){this.selectedCategories.set(d),this.computeMapData()}static \u0275fac=function(_){return new(_||m)};static \u0275cmp=vt.VBU({type:m,selectors:[["app-map-container"]],decls:2,vars:1,consts:[[1,"flex","flex-col","items-center","justify-center","text-center","px-4","py-6","bg-white","bg-opacity-60","rounded-lg","w-full"],[3,"markers","route","selectedDay","selectedTransport","carbonEmissions","selectedCategories"],[1,"text-2xl","sm:text-3xl","font-bold","text-yellow-700","mb-4"],[1,"btn","btn-accent","text-base","sm:text-lg","px-5","sm:px-6","py-3",3,"click"],[3,"transportChange","dayChange","categoryFilterChange","markers","route","selectedDay","selectedTransport","carbonEmissions","selectedCategories"]],template:function(_,v){1&_&&vt.DNE(0,Ip,7,0,"div",0)(1,Cp,1,6,"app-map-view",1),2&_&&vt.vxM(v.itinerary()?1:0)},dependencies:[yf,Mp.MD],encapsulation:2})}return m})()}}]);